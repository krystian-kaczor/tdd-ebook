<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /></head><body><div class="calibre" id="calibre_link-2">
  <h1 class="calibre1">Dedications</h1>

  <p class="calibre2"><i class="calibre3">Ad Deum qui laetificat iuventutem meam.</i></p>

  <p class="calibre2"><i class="calibre3">To my beloved wife Monika.</i></p>
</div>


<div class="calibre" id="calibre_link-5">
  <h1 class="calibre1">Part 1: Just&nbsp;the basics</h1>

  <p class="calibre2">This is a&nbsp;part where I&nbsp;introduce the basic TDD philosophy and practices (as well as some advanced ones) without going much into object orientation and how to do TDD for systems where multiple objects collaborate together (which is a&nbsp;topic of Part 2).</p>

  <p class="calibre2">So, for the most chapters of this part, I&nbsp;will be giving you examples where single object (plus some small ones like strings etc.) is exercised to slowly introduce some concepts in an easy to grasp manner.</p>

  <p class="calibre2">After reading part 1, you will be able to quite effectively develop classes that have no dependencies on other classes (and on operating system resources).</p>
</div>


<div class="calibre4" id="calibre_link-10">
  <h1 class="calibre1">Motivation - the first step to learning TDD</h1>

  <p class="calibre2">So, you want to learn TDD, huh? First off, let me ask a&nbsp;question ‘why?’.</p>

  <p class="calibre2">I want to tell you a&nbsp;story - few years ago, I&nbsp;had an apprentice, who wanted to learn TDD as well. We started working on a&nbsp;small project together for him to grasp the necessary skills through practice, with me sitting next to him, providing guidance. He showed up three, four times, then he resigned, having ‘more urgent things’ and ‘no time’. Since then, he did not progress in TDD at all. Did he really want to learn?</p>

  <p class="calibre2">See, sometimes people don’t really want to learn something or don’t want so much as to dedicate the necessary time and resources to this. Sometimes they just think they need to do it for whatever reasons - getting promotion at work, gaining a&nbsp;certificate, add something to CV or just ‘stay up to date’ with recent hypes, one of them being Test-Driven Development.</p>

  <p class="calibre2">Others want to learn TDD for reasons they themselves made up. Knowing that TDD is valued and praised by others, they draw conclusions that it has to be good. Why is that so? Err… maybe… “the code will be more tested”? Or… ekhem… “the network of tests will be tighter”? And why do Test-First? Well… hmm… “to ensure tests are written for everything”? While these statements might be partially true, they don’t even touch the essence of the “why” of TDD, and quickly turn into something like: “I don’t really need TDD, because I&nbsp;need tests that give me confidence on broader scope” or: “Why do I&nbsp;need unit tests when I&nbsp;already have integration tests, smoke tests, sanity tests, exploration tests…?”. Then TDD gets abandoned, before actually ever being achieved in the first place.</p>

  <p class="calibre2">You need to be highly motivated on this one. If you are not, hey, I&nbsp;heard the new series of Game Of Thrones is on TV, why don’t you check it out instead? Ok, I’m just teasing, however, as some say, TDD is “easy to learn, hard to master” (don’t actually know who said it first, I&nbsp;searched the web and found it in few places where none of the writers gave credit to anyone else for it, so I&nbsp;decided just to mention that I’m not the one that coined this description)&nbsp;, so without some guts to move on, it will be hard.</p>

  <h2 id="calibre_link-20" class="calibre5">How TDD feels like</h2>

  <p class="calibre2">Me and my brother liked to play video games in our childhood - one of the most memorable being Tekken 3 - a&nbsp;japanese tournament beat’em up for Sony Playstation. To finish the game with all warriors, unlock all hidden characters, mini-games etc. took about a&nbsp;day. Some could say the game had nothing to offer since then. Why then did we spend over a&nbsp;year on it?<br class="calibre6" /></p>

  <p class="calibre2"><img alt="Tekken3" src="images/000002.png" class="calibre7" /><br class="calibre6" /></p>

  <p class="calibre2">It is because each fighter in the game had a&nbsp;lot of combos, kicks and punches that could be mixed in a&nbsp;variety of ways. Some were only usable in some situations, others were something you could throw at your opponent almost anytime without a&nbsp;big risk of being exposed to counterattacks. You could side-step to evade enemy’s attacks and, most of all, you could kick another fighter up in the air where they could not block your attacks and you were able to land some nice attacks on them before they fell down. These in-the-air techniques were called “juggles”. There were magazines that published a&nbsp;list of new possible juggles each month and the hype stayed in the gaming community for well over a&nbsp;year.</p>

  <p class="calibre2">Yes, Tekken was easy to learn - you could put one hour into training the core moves of a&nbsp;character and then be able to “use them”, but what made you a&nbsp;great fighter was the experience and knowledge on which techniques were risky or not, which ones could be used in which situations, which ones, if used one after another, gave the opponent little chance to counterattack etc. No wonder that soon, many tournaments sprang, where players could clash for glory, fame and rewards. Even today, you can watch some of the matches on youtube.</p>

  <p class="calibre2">TDD is like Tekken. You have probably heard the mantra “red-green-refactor” or the general advice “write your test first, then the code”, maybe you even did some experiments on your own where you were trying to implement a&nbsp;bubble-sort algorithm or other simple stuff by starting with a&nbsp;test. But that is all like practicing Tekken by trying out each move on its own on dummy opponent, without the context of real-world issues that make the fight really challenging. And while I&nbsp;think such exercises are (somewhat) useful, you need to understand the bigger picture.</p>

  <p class="calibre2">Some people I&nbsp;talk with about TDD sum up what I&nbsp;say to them as: “That is really demotivating - there are so many things I&nbsp;have to watch out for that it makes me never want to start!”. Easy, don’t panic - remember the first time you tried to ride a&nbsp;bike - you must have been really far back then from knowing traffic regulations and following road signs, but that did not really keep you away, did it? I&nbsp;myself found TDD very exciting. Some guys my age already think they know all about coding, are bored with it and cannot wait until they move to management or requirements or business analysis, but hey! I&nbsp;have a&nbsp;new technique that makes my coding career challenging again! And it’s not something I&nbsp;can use only when I&nbsp;pay to Microsoft or Oracle or anybody else - it’s quite portable, making me a&nbsp;better developer overall!</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Student</h3>

    <p class="calibre8">You have started travelling the way of masters with conviction, determination and pride.</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-9">
  <h1 class="calibre1">The three most essential tools</h1>

  <p class="calibre2">Ever watched Karate Kid, either the old version or the new one? The thing they have in common is that when the kid starts learning Karate (or Kung-Fu) from his master, he is given a&nbsp;basic, repetitive task (like taking off a&nbsp;jacket, and putting it on again), not knowing yet where it would lead him. Or look at the first Rocky film (yeah, the one starring Sylvester Stallone), where Rocky was chasing a&nbsp;chicken in order to train agility.</p>

  <p class="calibre2">When I&nbsp;first tried to learn how to play guitar, I&nbsp;found two advices on the web: the first was to start by mastering a&nbsp;single, difficult song. The second was to play with a&nbsp;single string, learn how to make it sound in different ways and try to play some melodies by ear just with this one string. Do I&nbsp;have to tell you that the second advice worked better?</p>

  <p class="calibre2">Honestly, I&nbsp;could dive right into the core techniques of TDD, but this would be like putting you on a&nbsp;ring with a&nbsp;demanding opponent - you would most probably be discouraged before gaining the necessary skills. So, instead of explaining how to win a&nbsp;race, in this chapter we will take a&nbsp;look at what shiny cars we will be driving.</p>

  <p class="calibre2">In other words, I&nbsp;will give you a&nbsp;brief tour of the three most essential tools we will be using throughout this book.</p>

  <h2 id="calibre_link-21" class="calibre5">Our shiny tools</h2>

  <p class="calibre2">A disclaimer - in this chapter, I&nbsp;will oversimplify some things just to get you up and running without getting into the philosophy of TDD yet (think: physics lessons in primary school). Do not worry about it :-), we will fix that in the coming chapters!</p>

  <h3 class="sigilnotintoc">xUnit framework</h3>

  <p class="calibre2">The first and most essential tool we are going to use is an xUnit framework.</p>

  <p class="calibre2">Let us assume that our application looks like this:<br class="calibre6" /></p>

  <div class="calibre9"></div>
  <pre class="calibre10">public static void Main(string[] args) 
{
  try
  {
    int firstNumber = Int32.Parse(args[0]);
    int secondNumber = Int32.Parse(args[1]);

    var result = 
      new Multiplication(firstNumber, secondNumber).Perform();

    Console.WriteLine("Result is: " + result);
  }
  catch(Exception e)
  {
    Console.WriteLine("Addition failed because of: " + e);
  } 
}
</pre>

  <p class="calibre2">Now, let us assume we want to check whether is produces correct results. The most obvious way would be to invoke the application from command line with some exemplary arguments, check the output to the console and compare it with what we expect to see. Such session could look like this:</p>
  <pre class="calibre10">C:\MultiplicationApp\MultiplicationApp.exe 3 7
21
C:\MultiplicationApp\
</pre>

  <p class="calibre2">As you can see, the application produced a&nbsp;result of 21 for multiplication of 7 by 3. This is correct, so we assume the test is passed. But what if we produced an application that additionally does addition, subtraction, division, calculus etc.? How many times would we have to invoke the application to make sure every operation works correct?</p>

  <p class="calibre2">But wait, we are programmers, right? So we can write programs that can do this for us! In order to do this, we will create a&nbsp;second application that will also use the Multiplication class, but in a&nbsp;little different way:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  var multiplication = new Multiplication(3,7);
  
  var result = multiplication.Perform();
  
  if(result != 21)
  {
    throw new Exception("Failed! Expected: 21 but was: " + result);
  }
}
</pre>

  <p class="calibre2">Sounds easy, right? Let us take another step and extract the result check into something more reusable - after all, we will be adding division in a&nbsp;second, remember? So here goes:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  var multiplication = new Multiplication(3,7);
  
  var result = multiplication.Perform();
  
  AssertTwoIntegersAreEqual(expected: 21, actual: result);
}

public static void AssertTwoIntegersAreEqual(
  int expected, int actual)
{
  if(actual != expected)
  {
    throw new Exception(
      "Failed! Expected: " + expected + " but was: " + actual);
  }
}
</pre>

  <p class="calibre2">Note that I&nbsp;started the name of the method with “Assert” - we will get back to the naming soon, for now just assume that this is just a&nbsp;good name for the method. Let us take one last round and put the test into its own method:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers();
}

public void 
Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()
{
  //Assuming…
  var multiplication = new Multiplication(3,7);
  
  //when this happens:
  var result = multiplication.Perform();
  
  //then the result should be…
  AssertTwoIntegersAreEqual(expected: 21, actual: result);
}

public static void AssertTwoIntegersAreEqual(
  int expected, int actual)
{
  if(actual != expected)
  {
    throw new Exception(
      "Failed! Expected: " + expected + " but was: " + actual);
  }
}
</pre>

  <p class="calibre2">And we are finished. Now if we need another test, e.g. for division, we can just add a&nbsp;new method call to the <code class="calibre11">Main()</code> method and implement it. When implementing it, we can reuse the <code class="calibre11">AssertTwoIntegersAreEqual()</code> method, since the check for division would be analogous.</p>

  <p class="calibre2">As you can see, we can easily write automated checks like this, but this way has some disadvantages:</p>

  <ol class="calibre12">
    <li class="calibre13">Every time we add new test, we have to maintain the <code class="calibre11">Main()</code> method, adding a&nbsp;call to the new test. If you forget to add such a&nbsp;call, the test will never be run. At first it isn’t a&nbsp;big deal, but as soon as we have dozens of tests, it will get really hard to notice.</li>

    <li class="calibre13">Imagine your system consists of more than one application - you would have some problems trying to gather summary results for all of the applications that your system consists of.</li>

    <li class="calibre13">A need will very quickly arise to write a&nbsp;lot of other checks like the existing <code class="calibre11">AssertTwoIntegersAreEqual()</code> - this one compares two integers for equality, but what if you wanted to checka different condition, e.g. that one integer is greater than another? What if you wanted to check equality not for integers, but for characters, strings, floats etc.? What if you wanted to check some conditions on collections, e.g. that a&nbsp;collection is sorted or that all items in the collection are unique?</li>

    <li class="calibre13">Given that a&nbsp;test fails, it would be hard to navigate from the commandline output to the line in your IDE. Would it not be easier if you could click on the call stack to take you immediately to the code where the failure took place?</li>
  </ol>

  <p class="calibre2">For these and other reasons, automated testing tools were born. Those testing tools are generally referenced to as <strong class="calibre14">xUnit family</strong>, because many of them have names that end with the word “Unit”, e.g. CppUnit (for C++), JUnit (for Java), NUnit (for .NET) etc.</p>

  <p class="calibre2">To be honest, I&nbsp;cannot wait to show you how the test we wrote just a&nbsp;minute ago looks like when xUnit framework is used, however, before I&nbsp;do this, I&nbsp;would like to recap quickly what we have in our brute-force naive approach to writing automated tests:</p>

  <ol class="calibre12">
    <li class="calibre13">The <code class="calibre11">Main()</code> method serves as a&nbsp;<strong class="calibre14">Test List</strong></li>

    <li class="calibre13">The <code class="calibre11">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()</code> method is a&nbsp;<strong class="calibre14">Test Method</strong></li>

    <li class="calibre13">The <code class="calibre11">AssertTwoIntegersAreEqual()</code> method is <strong class="calibre14">an Assertion</strong></li>
  </ol>

  <p class="calibre2">Quite to our joy, those three elements are present in xUnit frameworks as well. To illustrate it, here is (finally!) the same test we wrote, but with an xUnit framework (this one is called XUnit.Net):</p>
  <pre class="calibre10">[Fact] public void 
Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()
{
  //Assuming…
  var multiplication = new Multiplication(3,7);
  
  //when this happens:
  var result = multiplication.Perform();
  
  //then the result should be…
  Assert.Equal(21, result);
}
</pre>

  <p class="calibre2">As you can see, it looks like two methods that we previously had are gone now and the test is the only thing that is left. Well, to tell you the truth, they are not gone - it is just that the framework handles these for us. Let us reiterate through the three elements of the previous version of the test that I&nbsp;promised would be there after the transition to xUnit framework:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Test List</strong> is now created automatically by the framework from all methods marked with a&nbsp;[Fact] attribute, so no need to maintain one or more central lists. Thus, the <code class="calibre11">Main()</code> method is gone.</li>

    <li class="calibre13">The <strong class="calibre14">Test Method is here and looks almost the same as the last time.</strong></li>

    <li class="calibre13">The <strong class="calibre14">Assertion</strong> took the form of a&nbsp;call to static <code class="calibre11">Assert.Equal()</code> method - the xUnit.NET framework is bundled with a&nbsp;wide range of pre-made assertions for your convenience. Of course, no one stops you from writing your own custom one if you do not find what you are looking for in a&nbsp;default set.</li>
  </ol>

  <p class="calibre2">Phew, I&nbsp;hope I&nbsp;made the transition quite painless for you. Now the last thing to add - as there is not <code class="calibre11">Main()</code> method anymore in the last example, you surely must wonder how we run those tests, right? Ok, the last big secret unveiled - we use an external application for this (we will refer to it using a&nbsp;term <strong class="calibre14">Test Runner</strong>) - we tell it which assemblies to run and it loads them, runs them, reports results etc. It can take various forms, e.g. it can be a&nbsp;console application, a&nbsp;GUI application or a&nbsp;plugin to our IDEs. Here is an example of a&nbsp;stand-alone runner for xUnit.NET framework:</p>

  <p class="calibre15"><img alt="XUnit.NET.Window" src="images/000001.png" class="calibre7" /></p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Sprinter</h3>

    <p class="calibre8">You sure know how to run your tests. Automatically!</p>
  </div>

  <h3 class="sigilnotintoc">Mocking framework</h3>

  <p class="calibre2">Mocking frameworks are libraries that automate runtime creation of objects (called “mocks”) that adhere to specified interface. Aside from the creation itself, the frameworks provide an API to configure our mocks on how they behave when certain methods are called on them and to let us inspect which calls they received.</p>

  <p class="calibre2">Mocking frameworks are not as old as xUnit frameworks and were not present in TDD since the very beginning. As you might be wondering why on earth do we need something like this, I&nbsp;will let you in on a&nbsp;secret: they were born with a&nbsp;goal of aiding a&nbsp;specific approach to object oriented design in mind. This kind of design is what TDD supports as you will soon experience.</p>

  <p class="calibre2">For now, however, let us try to keep things easy. I&nbsp;will defer explaining the actual rationale for mocking frameworks until later and instead give you a&nbsp;quick example where you can see them in action. Ready? Let us go!</p>

  <p class="calibre2">Let us pretend that we have the following code for adding new set of orders for products to a&nbsp;database and handling exceptions (by writing a&nbsp;message to a&nbsp;log) when it fails:</p>
  <pre class="calibre10">public class OrderProcessing
{
  //other code…

  public void Place(Order order)
  {
    try
    {
      this.orderDatabase.Insert(order);
    }
    catch(Exception e)
    {
      this.log.Write("Could not insert an order. Reason: " + e);
    }
  }

  //other code…
}
</pre>

  <p class="calibre2">Now, imagine we need to test it - how do we do it? I&nbsp;can already see you shaking your head and saying: “Let us just create this database, invoke this method and see if the record is added properly”. In such case, the first test would look like this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new MySqlOrderDatabase();
  orderDatabase.Connect();
  orderDatabase.Clean();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  var allOrders = orderDatabase.SelectAllOrders();
  Assert.Contains(order, allOrders);
}
</pre>

  <p class="calibre2">As you see, at the beginning of the test, we are opening a&nbsp;connection and cleaning all existing orders (more on that shortly!), then creating an order object, inserting it into a&nbsp;database and then querying the database to give us all of the held instances. At the end, we make an assertion that the order we tried to insert must be inside all orders in a&nbsp;database.</p>

  <p class="calibre2">Why do we clean up the database? Remember a&nbsp;database is a&nbsp;persistent storage, so if we did not clean it up and run this test again, the database may have already contained the item (maybe another test already added it?) and would probably not allow us to add the same item again. Thus, the test would fail. Ouch! It hurts so bad, because we wanted our tests to prove something works, but looks like it can fail even when the logic is coded correctly. What use is such a&nbsp;test if it cannot reliably provide the information we demand from it (whether the implemented logic is correct or not)? Thus, we clean up before each run to make sure the state of the persistent storage is the same every time we run this test.</p>

  <p class="calibre2">So, got what you want? Well, I&nbsp;did not. Personally, I&nbsp;would not go this way. There are several reasons:</p>

  <ol class="calibre12">
    <li class="calibre13">The test is going to be slow. It is not uncommon to have more than thousand tests in a&nbsp;suite and I&nbsp;do not want to wait half an hour for results every time I&nbsp;run them. Do you?</li>

    <li class="calibre13">Everyone running this test will have to set up a&nbsp;local database on their machine. What if their setup is slightly different than yours? What if the schema gets outdated - will everyone manage to notice it and update schema of their local databases accordingly? Will you re-run your database creation script only to ensure you have got the latest schema available to run your tests against?</li>

    <li class="calibre13">There may not be an implementation of the database engine for the operating system running on your development machine if your target is an exotic or mobile platform.</li>

    <li class="calibre13">Note that this test you wrote is only one out of two. You will have to write another one for the scenario where inserting an order ends with exception. How do you setup your database in a&nbsp;state where it throws an exception? It is possible, but requires significant effort (e.g. deleting a&nbsp;table and recreating it after the test for other tests that might need the table to run correctly), which may lead you to a&nbsp;conclusion that it is not worth to write such tests at all.</li>
  </ol>

  <p class="calibre2">Now, let us try something else. Let us assume that our database works OK (or will be tested by black-box tests) and the only thing we want to test is our implementation. In this situation, we can create fake object, which is an instance of another custom class that implements the same interface as MySqlOrderDatabase, but does not write to a&nbsp;database at all - it only stores the inserted records in a&nbsp;list:</p>
  <pre class="calibre10">public class FakeOrderDatabase : OrderDatabase
{
  public Order _receivedArgument;

  public void Insert(Order order)
  {
    _receivedArgument = order;
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
    return new List&lt;Order&gt;() { _receivedOrder; };
  }
}
</pre>

  <p class="calibre2">Now, we can substitute the real implementation of order database with the fake instance:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new FakeOrderDatabase();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  var allOrders = orderDatabase.SelectAllOrders();
  Assert.Contains(order, allOrders);
}
</pre>

  <p class="calibre2">Note that we do not clean the fake database object, since we create it as fresh each time the test is run. Also, the test is going to be much quicker now. But, that is not the end! We can easily write a&nbsp;test for an exception situation. How do we do it? Just make another fake object implemented like this:</p>
  <pre class="calibre10">public class ExplodingOrderDatabase : OrderDatabase
{
  public void Insert(Order order)
  {
    throw new Exception();
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
  }
}
</pre>

  <p class="calibre2">Ok, so far so good, but the bad is that now we have got two classes of fake objects to maintain (and chances are we will need even more). Any method or argument added will need to be propagated to all these objects. We can spare some coding by making our mocks a&nbsp;little more generic so their behavior can be configured using lambda expressions:</p>
  <pre class="calibre10">public class ConfigurableOrderDatabase : OrderDatabase
{
  public Action&lt;Order&gt; doWhenInsertCalled;
  public Func&lt;List&lt;Order&gt;&gt; doWhenSelectAllOrdersCalled;

  public void Insert(Order order)
  {
    doWhenInsertCalled(order);
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
    return doWhenSelectAllOrdersCalled();
  }
}
</pre>

  <p class="calibre2">Now, we do not have to create additional classes for new scenarios, but our syntax gets awkward. See for yourself how we configure the fake order database to remember and yield the inserted order:</p>
  <pre class="calibre10">var db = new ConfigurableOrderDatabase();
Order gotOrder = null;
db.doWhenInsertCalled = o =&gt; {gotOrder = o;};
db.doWhenSelectAllOrdersCalled = () =&gt; new List&lt;Order&gt;() { gotOrder };
</pre>

  <p class="calibre2">And if we want it to throw an exception when anything is inserted:</p>
  <pre class="calibre10">var db = new ConfigurableOrderDatabase();
db.doWhenInsertCalled = o =&gt; {throw new Exception();};
  </pre>

  <p class="calibre2">Thankfully, some smart programmers created frameworks that provide further automation in such scenarios. One of them is called <strong class="calibre14">NSubstitute</strong> and provides an API in a&nbsp;form of extension methods (that is why it might seem a&nbsp;bit magical at first. Do not worry, you will get used to it).</p>

  <p class="calibre2">Using NSubstitute, out first test can be rewritten as such:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}
</pre>

  <p class="calibre2">Note that we do not need the <code class="calibre11">SelectAllOrders()</code> method. If no one except this test needs it, we can delete it and spare some more maintainability trouble. The last line of this test is actually a&nbsp;camouflaged assertion that checks whether Insert method was called once with order object as parameter.</p>

  <p class="calibre2">I will get back to mocks, since, as I&nbsp;said, there is a&nbsp;huge philosophy behind them and we have only scratched the surface here.</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Pretender</h3>

    <p class="calibre8">You have managed to use a&nbsp;mock instead of a&nbsp;real object in unit test!</p>
  </div>

  <h3 class="sigilnotintoc">Anonymous values generator</h3>

  <p class="calibre2">Look at the test in the previous section. Does it not trouble you that we fill the order object with so many values that are totally irrelevant to the test logic itself? They actually hinder readability of the test. Also, they make us believe that the tested object really cares what these values are, although it does not (the database does, but we already got rid of it from the test). Let us move it to a&nbsp;method with descriptive name:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = AnonymousOrder();

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}

public Order AnonymousOrder()
{
  return new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);
}
</pre>

  <p class="calibre2">Now that is better. Not only did we make the test shorter, we also provided a&nbsp;hint to the test reader that the actual values used to create an order do not matter from the perspective of tested order processing logic, hence the name <code class="calibre11">AnonymousOrder()</code>.</p>

  <p class="calibre2">By the way, would it not be nice if we did not have to provide the anonymous objects ourselves, but rely on another library to generate them for us? Susprise, surprise, there is one! It is called <strong class="calibre14">Autofixture</strong>. It is an example of an anonymous values generator (although its creator likes to say that it is an implementation of Test Data Builder pattern, but let us skip this discussion here). After refactoring our test to use AutoFixture, we arrive at the following:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = any.Create&lt;Order&gt;();

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}

private Fixture any = new Fixture();
</pre>

  <p class="calibre2">Nice, huh? AutoFixture has a&nbsp;lot of advanced features, but personally I&nbsp;am conservative and wrap it behind a&nbsp;static class called <code class="calibre11">Any</code>:</p>
  <pre class="calibre10">public static class Any
{
  private static any = new Fixture();
  
  public static T ValueOf&lt;T&gt;()
  {
    return any.Create&lt;T&gt;();
  }
}
</pre>

  <p class="calibre2">In the next chapters, you will see me using a&nbsp;lot of different methods from the <code class="calibre11">Any</code> type. The more you use this class, the more it grows with other methods for creating customized objects. For now, however, let us stop here.</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Anonymous</h3>

    <p class="calibre8">The values you use in your unit tests move like a&nbsp;shadow, unnoticed by anyone and until it is really necessary.</p>
  </div>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">In this chapter, I&nbsp;tried to show you the three essential tools which we will be using in this book and which, when mastered, will make your test-driven development smoother. If this chapter leaves you with insufficient justification for their use, do not worry - we will dive into the philosophy behind them in the coming chapters. For now, I&nbsp;just want you to get familiar with the tools themselves and their syntax. Go on, download these tools, launch them, try to write something simple with them. You do not need to understand their full purpose yet, just go out and play :-).</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Equipped</h3>

    <p class="calibre8">You are now able to understand most of the code examples throughout this book!</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-15">
  <h1 class="calibre1">It is not a&nbsp;test</h1>

  <p class="calibre2">Up to now, I&nbsp;was cheating on you. I&nbsp;told you that the little executable snippets of code are ‘tests’ and that they’re here to ‘check’ or ‘verify’ something. Now it is time to reveal the truth.</p>

  <h2 id="calibre_link-22" class="calibre5">When a&nbsp;test becomes something else</h2>

  <p class="calibre2">I studied in Łódź, a&nbsp;large city in the center of Poland. As probably all other students in all other countries, we have had lectures, exercises and exams. The exams were pretty hard, especially considered that my computer science group was on the faculty of electronic and electric engineering, so we had to grasp a&nbsp;lot of classes that did not have anything to do with programming, for instance electrotechnics, solid-state physics or electronic and electrical metrology.</p>

  <p class="calibre2">Knowing that the exams were difficult and that it was hard to learn everything during preparation, the lecturers would give us exemplary exams from previous years. The questions were different than during actual exams, but the structure and types of questions asked (practice vs. theory etc.) was similar. We would usually get these exemplary questions before we started learning really hard (which was usually at the end of semester). Guess what happened then? As you might suspect, we did not use the tests we received just to ‘verify’ or ‘check’ our knowledge after we finished learning. Those tests were actually the first thing we went to before even starting to learn. Why was that so? What use were the tests when we knew we would not know most of the answers?</p>

  <p class="calibre2">I guess my lecturers would disagree with me, but I&nbsp;find it quite amusing that what we were really doing back then was ‘Lean’. Lean is an approach where, among others, there is a&nbsp;rigorous emphasis on eliminating waste. Every feature or product that is produced while not being needed by anyone is considered waste. That is because if something is not needed, there is no reason to assume it will ever be needed. In such case the entire feature or product is a&nbsp;waste - it has no value. Even if it WILL be ever needed, it will require some rework anyway to fit the real customer needs. In this case, the initial amount of work that went into the parts of solution that had to be replaced by another parts anyway is a&nbsp;waste - it never brought any money (I am not talking about such things as customer demos, but finished, polished features or products).</p>

  <p class="calibre2">So, in order to eliminate waste, there is huge pressure nowadays to “pull features from demand” instead of “pushing them” into the product. In other words, every feature is there to satisfy concrete need. If not, the effort is considered wasted and the money drown.</p>

  <p class="calibre2">Going back to the exams, why the approach of first looking through the exemplary tests can be considered ‘lean’? That is because, when we treat passing an exam as our goal, then everything that does not put us closer to this goal is considered a&nbsp;waste. Let us suppose the exam is theory only - why then practice the exercises? It would probably pay off a&nbsp;lot more to study theoretical side of the topics. Such knowledge could be obtained from those exemplary tests. So, the tests were a&nbsp;kind of specification of what was needed to pass the exam, letting us pull the value (i.e. our knowledge) from demand (information obtained from a&nbsp;realistic tests) rather that pushing it from implementation (i.e. learning everything in a&nbsp;course book chapter after chapter).</p>

  <p class="calibre2">So the tests became something else. They proved very valuable before the ‘implementation’ (i.e. learning for the exam) because:</p>

  <ol class="calibre12">
    <li class="calibre13">they helped us focus on what was needed to reach our goal</li>

    <li class="calibre13">they brought our attention away from what was <strong class="calibre14">not</strong> needed to reach our goal</li>
  </ol>

  <p class="calibre2">That was the value of a&nbsp;test before learning. Note that the tests we would usually receive were not exactly what we would encounter at the time of exam, so we still had to guess. Still, the role of a&nbsp;<strong class="calibre14">test as specification of a&nbsp;need</strong> was already visible.</p>

  <h2 id="calibre_link-23" class="calibre5">Taking It To The Software Development Land</h2>

  <p class="calibre2">I chose this lengthy metaphor to show you that ‘test’ is really another way of specifying a&nbsp;requirement or a&nbsp;need and that it is not something that is counter-intuitive - it occurs in our everyday lives. This is also true in software development. Let us take the following ‘test’ and see what kind of needs it specifies:</p>
  <pre class="calibre10">var reporting = new ReportingFeature();
var anyPowerUser = Any.Of(Users.Admin, Users.Auditor);
Assert.True(reporting.CanBePerformedBy(anyPowerUser));
</pre>

  <p class="calibre2">(In this example, we used <code class="calibre11">Any.Of()</code> method that returns any enumeration value from the specified list. Here, we say “give me a&nbsp;value that is either <code class="calibre11">Users.Admin</code> or <code class="calibre11">Users.Auditor</code>“.)</p>

  <p class="calibre2">Let us look at those (only!) three lines of code, imagining that the production code that makes this ‘test’ pass does not exist yet. What can we learn from these three lines about what the code needs to supply? Count with me:</p>

  <ol class="calibre12">
    <li class="calibre13">We need a&nbsp;reporting feature</li>

    <li class="calibre13">We need to support a&nbsp;notion of users and privileges</li>

    <li class="calibre13">We need to support a&nbsp;domain concept of power user, who is either an administrator or an auditor</li>

    <li class="calibre13">Power users will need to be privileged to use the reporting feature (note that it does not specify which other users should or should not be able to use this feature - we would need a&nbsp;separate ‘test’ for that).</li>
  </ol>

  <p class="calibre2">Also, are already after the phase of designing an API that will fulfill the need. Don’t you think it is pretty much information about the application from just three lines of code?</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Lean &amp; Mean</h3>

    <p class="calibre8">You now see some connotations between Test-Driven Development and Lean movement. There are more if you are interested, so be sure to pick up a&nbsp;good read bout lean software development!</p>
  </div>

  <h2 id="calibre_link-24" class="calibre5">A Specification Instead of a&nbsp;Test Suite</h2>

  <p class="calibre2">I hope that you can see now that what we called ‘a test’ is really a&nbsp;kind of specification. The discovery is very recent, so there isn’t a&nbsp;clear terminology on it yet. Some like to call the process of using tests as specifications: Specification By Example, to say that the tests are really examples that help specify and clarify the behavior of developed part of functionality. The terminology is still not rock-solid, so you might encounter different naming for different things. For example, a&nbsp;‘test’ is often referred to as ‘spec’, or an ‘example’, or a&nbsp;‘behavior description’, or a&nbsp;‘specification statement’ or a&nbsp;‘fact about the developed system’ (the xUnit.NET framework marks each ‘test’ with a&nbsp;<code class="calibre11">[Fact]</code> attribute, suggesting that by writing it, we are stating a&nbsp;single fact about developed code. By the way, xUnit.NET also allows us to state ‘theories’ about our code, but let us leave it for now).</p>

  <p class="calibre2">The time has come to make a&nbsp;deal: I&nbsp;will establish some naming conventions for this book to be consistent, but leave you with the freedom to follow your own if you so desire. Let us agree that for the sake of this book:</p>

  <dl class="calibre2">
    <dt class="calibre16"><strong class="calibre14">Specification Statement</strong> (or simply <strong class="calibre14">Statement</strong>, starting with capital letter)</dt>

    <dd class="calibre17">will be used instead of ‘test’ or ‘test method’</dd>

    <dt class="calibre16"><strong class="calibre14">Specification</strong> (or simply <strong class="calibre14">Spec</strong>), also starting with capital letter</dt>

    <dd class="calibre17">will be used instead of ‘test suite’ or ‘test list’</dd>

    <dt class="calibre16"><strong class="calibre14">Unfulfilled Statement</strong></dt>

    <dd class="calibre17">will be used instead of ‘failing test’</dd>

    <dt class="calibre16"><strong class="calibre14">Fulfilled Statement</strong></dt>

    <dd class="calibre17">will be used instead of ‘passing test’</dd>
  </dl>

  <p class="calibre2">From time to time, I&nbsp;will refer back to the ‘traditional’ terminology, because it is better established and you’ve probably heard some terms already and may wonder how it should be understood in context of thinking of tests as specification.</p>

  <p class="calibre2">From your experience, you may know paper or word specifications, written in plain English or other spoken language. Our specification is different than these specifications in at least few ways:</p>

  <ol class="calibre12">
    <li class="calibre13">it is not written fully up-front (more on this in the next chapters).</li>

    <li class="calibre13">it is executable - you can run it to see whether the code adheres to the specification or not.</li>

    <li class="calibre13">it is written in source code rather than in spoken language - which is both good (less room for misunderstanding - source code is the most formal and structured way of writing specifications) and bad (great care must be taken to keep the specification readable).</li>
  </ol>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Enlightened</h3>

    <p class="calibre8">You are starting to see Test-Driven Development in a&nbsp;new light - not as a&nbsp;testing technique, but as a&nbsp;mean to specify the behaviors of the code under development.</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-18">
  <h1 class="calibre1">Statement-First programming</h1>

  <h2 id="calibre_link-25" class="calibre5">What is The Point of Writing Specification After The Fact?</h2>

  <p class="calibre2">In the last chapter, I&nbsp;said that in TDD a&nbsp;‘test’ takes another role - one of a&nbsp;statement being a&nbsp;part of a&nbsp;specification. If we put things this way, then the whole controversial concept of “writing a&nbsp;test before the code” does not pose a&nbsp;problem at all. Quite the contrary - it only seems natural to specify what we are going to write before we attempt to write it. Does the other way round even make sense? A&nbsp;specification written after completing the implementation is nothing more than an attempt at documenting the existing solution. Sure, such attempts can provide some value when done as a&nbsp;kind of reverse-engineering (i.e. writing specification for something that was implemented long ago and we do not really know the exact business rules or policies, which we discover as we document the existing solution) - it has an excitement of discovery in it, but doing it just after we, ourselves, made all the decisions seems like a&nbsp;waste of time, not to mention that it is dead boring (Do not believe me? Try implementing a&nbsp;simple calculator app and the write specification for it just after it is implemented and working). Anyway, specifying how something should work after the fact can hardly be considered creative.</p>

  <p class="calibre2">Oh, and did I&nbsp;tell you that without a&nbsp;specification of any kind we do not really know whether we are done implementing our changes or not (because in order to know it, we need to compare the implemented functionality to ‘something’, even if this ‘something’ is only in the customer’s head).</p>

  <p class="calibre2">Another thing I&nbsp;mentioned in the previous chapter was that one of the differences between a&nbsp;textual specification and our Specification consisting of executable Statements is that, although the code follows the Specification, we do not write our Specification fully up-front. The usual sequence is to specify a&nbsp;bit first and then code a&nbsp;bit, then repeat one Statement at a&nbsp;time. When doing TDD, we are traversing repeatedly through few phases that make up a&nbsp;cycle. We like these cycles to be short, so that we can get a&nbsp;quick feedback. Being able to get this quick feedback is essential, because it allows us to move forward with confidence that what we already have works as we intended. Also, it allows us to use the knowledge we gained in the previous cycle to make the next cycle more efficient (if you do not believe me that quick feedback is good, ask yourself a&nbsp;question: “how many times a&nbsp;day do I&nbsp;compile the code I&nbsp;work on?”).</p>

  <p class="calibre2">Reading so much about cycles, it is probably no surprise to you that the traditional illustration of the TDD process is modeled visually as a&nbsp;circle-like flow:</p>

  <p class="calibre2"><img alt="Traditional_TDD_cycle" src="images/000004.png" class="calibre7" /></p>

  <p class="calibre2">Note that the above form uses the traditional terminology of TDD, so before I&nbsp;explain the steps, I&nbsp;will translate it to use our terms of Specification and Statements:</p>

  <p class="calibre2"><img alt="Modern_TDD_cycle" src="images/000005.png" class="calibre7" /></p>

  <p class="calibre2">The second version seems more like common sense than the first one - specifying how something should behave before putting that behavior in place is way more intuitive than testing something that does not exist.</p>

  <p class="calibre2">Anyway, these three steps demand some explanation. In the coming chapters, I&nbsp;will give you some examples of how this process works in practice and introduce an expanded version, but in the meantime, its sufficient to say that:</p>

  <dl class="calibre2">
    <dt class="calibre16">Write an unfulfilled Statement</dt>

    <dd class="calibre17">means that the Statement evaluates to false (it shows on the test list as unfulfilled - in most xUnit frameworks, it will be marked with red color)</dd>

    <dt class="calibre16">Fulfill it</dt>

    <dd class="calibre17">means that we write just enough code to fulfill the Statement (in most xUnit frameworks, the fulfilled Statement will be marked with green color). Later in the course of the book, you will see how small can be “just enough”</dd>

    <dt class="calibre16">Refactor</dt>

    <dd class="calibre17">is a&nbsp;step that I&nbsp;have silently discarded so far (and will do so for at least few next chapters. Do not worry, we will get back to it eventually). Basically, it boils down to using the safety net of executable specification we already have in place to safely enhance the quality of the covered code while all mistakes we make in the process are quickly discovered by the running Specification.</dd>
  </dl>

  <p class="calibre2">By the way, this process is sometimes referred to as “Red-Green-Refactor”. I&nbsp;am just mentioning it here for the record - I&nbsp;am not planning to use this term further in the book.</p>

  <h2 id="calibre_link-26" class="calibre5">The Benefit of Failure</h2>

  <p class="calibre2">Look again at the drawing with TDD process - can you spot a&nbsp;single word I&nbsp;underlined? Yes, it is <strong class="calibre14">unfulfilled</strong>. It means that when you write a&nbsp;Statement, you have to evaluate it (i.e. run it) and watch it fail its assertions before providing implementation that makes this Statement true. Why is that so important? Is it not just enough to write the Statement first? Why run it and watch it fail?</p>

  <p class="calibre2">There are multiple reasons and I&nbsp;will try to outline few of them briefly.</p>

  <h3 class="sigilnotintoc">You do not know whether the Statement can ever be false until you see it evaluate to false</h3>

  <p class="calibre2">Every accurate Statement (do I&nbsp;have to tell you that such Statements are what we are interested in?) fails when it isn’t fulfilled and passes when it is. That is one of the main reasons we write it - to receive this feedback. Also, after being fulfilled, the Statement becomes a&nbsp;part of the executable specification and starts failing as soon as the code stops fulfilling it (e.g. as a&nbsp;result of mistake made during code rework). When your run a&nbsp;Statement after it is implemented and it is evaluated as true, how do you know whether it really describes a&nbsp;need accurately? You did not ever watch it fail, so how do you know it ever will?</p>

  <p class="calibre2">The first time I&nbsp;encountered this argument (it was before I&nbsp;started thinking of unit tests as executable specification), it quickly raised my self-defense mechanism: “seriously?” - I&nbsp;thought - “I am a&nbsp;wise person, I&nbsp;know what I&nbsp;am writing. If I&nbsp;make my unit tests small enough, it is self-evident that I&nbsp;am describing the correct behavior. This is paranoid”. However, life quickly verified my claims and I&nbsp;was forced to withdraw my arguments. Let me describe, from my experience, three ways (there are more, I&nbsp;just forgot the rest :-D) one can really put in a&nbsp;Statement that is always evaluated as true, regardless of the code being correct or not (i.e. a&nbsp;Statement that cheats you into thinking it is fulfilled even when it is not):</p>

  <h4 class="sigilnotintoc1">1. Accidental omission of adding a&nbsp;Statement to Specification.</h4>

  <p class="calibre2">However funny this may sound, it happened to me few times. The example I&nbsp;am going to give is from C#, but almost every xUnit framework in almost every language has some kind of mechanism of marking methods as Statements, whether by attributes (C#, e.g. xUnit.Net’s <code class="calibre11">Fact</code> attribute) or annotations (Java) or with macros (C and C++) or by inheriting from common class, or just a&nbsp;naming convention.</p>

  <p class="calibre2">Let us take xUnit.Net as an example. As I&nbsp;stated previously, In xUnit.Net, to turn a&nbsp;method into a&nbsp;Statement, you mark it with <code class="calibre11">[Fact]</code> attribute the following way:</p>
  <pre class="calibre10">public class CalculatorSpecification
{
  [Fact]
  public void ShouldDisplayAdditionResultAsSumOfArguments() 
  {
    //... 
  }
}
</pre>

  <p class="calibre2">Now, imagine that you are writing this Statement post-factum as a&nbsp;unit test in an environment that has, let us say, more than thirty Statements - you have written the code, now you are just creating a&nbsp;test after test “to ensure” (as you see, this is not my favorite reason for writing unit tests) the code works. Code, test - pass, test - pass, test - pass. You almost always evaluate your code against the whole Specification, since it is usually easier than selectig what to evaluate each time, plus, you get more confidence this way that you did not break by mistake something that is already working. So, this is really: Code, Test - all pass, test - all pass, test - all pass… Hopefully, you use some kind of snippets mechanism for creating new Statements, but if not (and many do not actually do this), once in a&nbsp;while, you do something like this:</p>
  <pre class="calibre10">
public class CalculatorSpecification
{
  //... some Statements here

  //oops… forgot to copy-paste the attribute!
  public void ShouldDisplayZeroWhenResetIsPerformed()
  {
    //... 
  }
}
</pre>

  <p class="calibre2">And you do not even notice that this will not be evaluated with the rest of the Specification, because it already consists of so many Statements that it is almost irrational to search for your added Statement in the list and make sure it is there each time. Also, note that the fact that you omitted the addition, does not disturb your work flow: test - all pass, test - all pass, test - all pass… In other words, your process does not give you any feedback on your mistake. So, what you end up is a&nbsp;Statement that not only will never be false - <strong class="calibre14">it will never be evaluated</strong>.</p>

  <p class="calibre2">How does treating tests as Statements and evaluating them before making them true help here? <strong class="calibre14">Because then, a&nbsp;Statement that starts off being evaluated as true is what DOES disturb your work flow.</strong> In TDD, the work flow is: Statement - unfulfilled - fulfilled (ok, and refactor, but for the sake of THIS discussion, it does not matter so much), Statement - unfulfilled - fulfilled, Statement - unfulfilled - fulfilled… So every time you fail to see the “unfulfilled” stage, you get feedback from your process that something suspicious is happening. This lets you investigate and, if necessary, fix the situation at hand.</p>

  <h4 class="sigilnotintoc1">2. Misplacing mock setup</h4>

  <p class="calibre2">Ok, this may sound even funnier (well, honestly, most mistakes sound funny), but it also happened to me a&nbsp;couple of times, so it makes sense to mention it. The example I&nbsp;am going to show uses manual mocks, but this can happen with dynamic mocks as well, especially if you are in a&nbsp;hurry.</p>

  <p class="calibre2">Let us take a&nbsp;look at the following Statement saying that setting a&nbsp;value higher than allowed to a&nbsp;field of a&nbsp;frame should produce error result:</p>
  <pre class="calibre10">[Fact]
public void ShouldRecognizeTimeSlotAboveMaximumAllowedAsInvalid()
{
  //GIVEN
  var frame = new FrameMock(); //manual mock
  var validation = new Validation();
  var timeSlotAboveMaximumAllowed = TimeSlot.MaxAllowed + 1;

  //WHEN
  var result = validation.PerformForTimeSlotIn(frame);
  frame.GetTimeSlot_Returns 
    = timeSlotAboveMaximumAllowed;

  //THEN
  Assert.False(result.Passed);
  Assert.Equal(
    ValidationFailureReasons.AboveAcceptableLimit, 
    result.Reason);
}
</pre>

  <p class="calibre2">Note how the method <code class="calibre11">PerformForTimeSlotIn()</code>, which triggers the specified behavior is accidentally called BEFORE the mock is actually set up and the set up return value is never taken into account. By some strange coincidence, this error did not alter the expected end result so we did not even notice. It sometimes turns out like this, most often in case of various boundary values (nulls etc.).</p>

  <h4 class="sigilnotintoc1">3. Using static data inside production code</h4>

  <p class="calibre2">Once in a&nbsp;while, you have to jump in and add some new Statements to some class Specification and some logic to the class itself. Let us assume that the class and its existing specification was written by someone else. Imagine this code is a&nbsp;wrapper around your product XML configuration file. You decide to write your Statements AFTER applying the changes (“well”, you can say, “I am all protected by the Specification that is already in place, so I&nbsp;can make my change without risking regression, then just test my changes and it is all good…”).</p>

  <p class="calibre2">So, you start writing the new Statement. The Specification class already contains a&nbsp;field member like this:</p>
  <pre class="calibre10">public class XmlConfigurationSpecification
{
  XmlConfiguration config = new XmlConfiguration(xmlFixtureString);
  
  //...
  //...

</pre>

  <p class="calibre2">What it does is to set up an object used by every Statement. So, each Statement uses a&nbsp;<code class="calibre11">config</code> object initialized with the same <code class="calibre11">xmlConfiguration</code> string value. The string is already pretty huge and messy, since it was made to contain what is required by all existing Statements. You need to write tests for is a&nbsp;little corner case that does not need all this crap that is inside this string. So, you decide to start fresh and create a&nbsp;separate object of <code class="calibre11">XmlConfiguration</code> class with your own, minimal string. Your Statement begins like this:</p>
  <pre class="calibre10">string customFixture = CreateMyOwnFixtureForThisTestOnly();
var configuration = new XmlConfiguration(customFixture);
...
</pre>

  <p class="calibre2">And it passes - cool… not. Ok, what is wrong with this? Nothing big, unless you read the source code of XmlConfiguration class carefully. Inside, you can see, how the xml string is stored:</p>
  <pre class="calibre10">private static string xmlText; //note the static keyword!
</pre>

  <p class="calibre2">What the…? Well, well, here is what happened: the author of this class coded in a&nbsp;small little optimization. He thought: “In this app, the configuration is only modified by members of the support staff and to do it, they have to shut down the system, so, there is no need to read the XML file every time an XmlConfiguration object is created. I&nbsp;can save some CPU cycles and I/O operations by reading it only once when the first object is created. Another created object will just use the same XML!”. Good for him, not so good for you. Why? Because (unless your Statement is evaluated prior to being fulfilled), your custom xml string will never actually be used!</p>

  <h3 class="sigilnotintoc">“Test-After” ends up as “Test-Never”</h3>

  <p class="calibre2">I will ask this question again: ever had to write a&nbsp;requirement or design document for something that you already implemented? Was it fun? Was it valuable? Was it creative? No, I&nbsp;do not think so. The same is with our executable specification. After we write the code, we have little motivation to specify what is already written - some of the pieces of code “we can just see are correct”, other pieces “we already saw working” when we copied our code over to our deployment machine and ran few sanity checks… The design is ready… Specification? Maybe next time…</p>

  <p class="calibre2">Another reason might be time pressure. Let us be honest - we are all in a&nbsp;hurry, we are all under pressure and when this pressure is too high, it triggers heroic behaviors in us, especially when there is a&nbsp;risk of not making it with the sprint commitment. Such heroic behavior usually goes by the following rules: drop all the “baggage”, stop learning and experimenting, revert to all of the old “safe” behaviors and “save what we can!”. If Specification is written at the end, it is often sacrificed on the altar of making it with the commitment, since the code is already written, “and it will be tested anyway by real tests” (box tests, smoke tests, sanity tests etc.). It is quite the contrary when starting with a&nbsp;Statement, where the Statement evaluating to false is <strong class="calibre14">a reason</strong> to write any code. Thus, if we want to write code, Specification become irremovable part of your development. By the way, I&nbsp;bet in big corporations no one sane ever thinks they can abandon checking in the code to source control, at the same time treating Specification as “an optional addition”.</p>

  <h3 class="sigilnotintoc">Not starting from specification leads to waste of time on making objects testable</h3>

  <p class="calibre2">It so happens, that I&nbsp;like watching and reading Uncle Bob. One day, I&nbsp;was listening to <a href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years" target="_blank">his keynote at Ruby Midwest 2011, called Architecture The Lost Years</a>. At the end, Robert made some digressions, one of them being about TDD. He said that writing unit tests after the code is not TDD. It is a&nbsp;waste of time.</p>

  <p class="calibre2">My initial thought was that the comment was only about missing all the benefits that starting with false Statement brings you: the ability to see the Statement fail, the ability to do a&nbsp;clean-sheet analysis etc., however, now I&nbsp;am of opinion that there is more to it. It is something I&nbsp;got from Amir Kolsky and Scott Bain - in order to be able to write maintainable Specification for a&nbsp;piece of code, the code has to have a&nbsp;high level of a&nbsp;quality called <strong class="calibre14">testability</strong> (we will talk about testability later on, do not worry - for now let us assume that the easier it is to write a&nbsp;Statement for a&nbsp;behavior of a&nbsp;class, the higher testability it has). That does not tell us much about where is the waste I&nbsp;mentioned, does it? To see it, let us see how dealing with testability looks like in Statement-first workflow (let us assume that we are creating new code, not adding stuff to dirty, ugly legacy code):</p>

  <ol class="calibre12">
    <li class="calibre13">Write false Statement (this step ensures that code has high testability)</li>

    <li class="calibre13">Write code to make the Statement true</li>
  </ol>

  <p class="calibre2">Now, how does it usually look like when we write the code first (extra steps marked with <strong class="calibre14">strong text</strong>):</p>

  <ol class="calibre12">
    <li class="calibre13">Write some production code (probably spans few classes until we are satisfied)</li>

    <li class="calibre13"><strong class="calibre14">Start writing unit tests</strong></li>

    <li class="calibre13"><strong class="calibre14">Notice that unit testing the whole set of classes is cumbersome and unsustainable and contains high redundancy.</strong></li>

    <li class="calibre13"><strong class="calibre14">Restructure the code to be able to isolate objects and use mocks (this step ensures that code has high testability)</strong></li>

    <li class="calibre13">Write unit tests</li>
  </ol>

  <p class="calibre2">What is the equivalent of the marked steps in Statement-First approach? Nothing! Doing these things is a&nbsp;waste of time! Sadly, this is a&nbsp;waste I&nbsp;see done over and over again.</p>
</div>


<div class="calibre4" id="calibre_link-4">
  <h1 class="calibre1">Practicing what we already learned</h1>

  <blockquote class="calibre18">
    <p class="calibre2">And now, a&nbsp;taste of things to come!</p>

    <p class="calibre2">- Shang Tsung, Mortal Kombat The Movie</p>
  </blockquote>

  <p class="calibre2">The above quote took place just before a&nbsp;fighting scene in which a&nbsp;nameless warrior jumped at Sub-Zero only to be frozen and broken into multiple pieces upon hitting the wall. The scene was not spectacular in terms of fighting technique or length. Also, the nameless guy did not even try hard - the only thing he did was to jump only to be hit by a&nbsp;freezing ball, which, by the way, he actually saw coming. It looked a&nbsp;lot like the fight was set up only to showcase Sub-Zero’s freezing ability. Guess what? In this chapter, we are gonna do roughly the same thing - set up a&nbsp;fake, easy scenario just to showcase some of the basic TDD elements!</p>

  <p class="calibre2">The previous chapter was filled with a&nbsp;lot of theory and philosophy, don’t you think? I&nbsp;really hope you did not fall asleep while reading it. To tell you the truth, we need to grasp much more theory until we are really able to write real-world applications using TDD. To compensate for this somehow, I&nbsp;propose we make a&nbsp;side trip from the trail and try what we already learned on a&nbsp;quick and easy example. As we go through the example, you might wonder how on earth could you possibly write real applications the way we will write our simple program. Do not worry, I&nbsp;will not show you all the tricks yet, so treat it as a&nbsp;“taste of things to come”. In other words, the example will be as close to real world problems as the fight between Sub-Zero and nameless ninja was to real martial arts fight, but will show you some of the elements of TDD process.</p>

  <h2 id="calibre_link-27" class="calibre5">Let me tell you a&nbsp;story</h2>

  <p class="calibre2">Meet Johnny and Benjamin, two developers from Buthig Company. Johnny is quite fluent in programming and Test-Driven Development, while Benjamin is an intern under Johnny’s mentorship and is eager to learn TDD. They are on their way to their customer, Jane, who requested their presence as she wants them to do write a&nbsp;small program for her. Together with them, we will see how they interact with the customer and how Benjamin tries to understand the basics of TDD. Just as you, Benjamin is a&nbsp;novice so his questions may reflect yours. However, if you find anything explained in not enough details, do not worry - in the next chapters, we will be expanding on this material.</p>

  <h2 id="calibre_link-28" class="calibre5">Act 1: The Car</h2>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> How do you feel on your first assignment?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;am pretty excited! I&nbsp;hope I&nbsp;can learn some of the TDD stuff you promised to teach me.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Not only TDD, but we are also gonna use some of the practices associated with a&nbsp;process called Acceptance Test Driven Development, albeit in a&nbsp;simplified form.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Acceptance Test-Driven Development? What is that?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> While TDD is usually referred to as a&nbsp;development technique, ATDD is something more of a&nbsp;collaboration method. Both ATDD and TDD have a&nbsp;bit of analysis in them and work very well together as both use the same underlying principles, just on different levels. We will need only a&nbsp;small subset of what ATDD has to offer, so do not get over-excited.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure.</p>

  <h2 id="calibre_link-29" class="calibre5">Act 2: The Customer</h2>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hi, Jane, how are you?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Thanks, I&nbsp;am fine, how about you?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Same here, thanks. So, can you tell us a&nbsp;bit about the software you need us to write?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure. Recently, I&nbsp;bought a&nbsp;new smartphone as a&nbsp;replacement for my old one. The thing is, I&nbsp;am really used to the calculator application that was running on the previous phone and I&nbsp;cannot find it for my current device.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Cannot you just use another calculator app? There are plenty of them available to download from the web.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That is right. I&nbsp;checked them all and none has exactly the same behavior as the one I&nbsp;was using for my tax calculations. You know, the program was like right hand to me and it had some really nice shortcuts that made my life easier.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> So you want us to reproduce the application to run on your new device?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Yes.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Are you aware that apart from the fancy features that you were using we will have to allocate some effort to implement the basics that all the calculators have?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure, I&nbsp;am OK with that. I&nbsp;am so used to my calculator application so much that if I&nbsp;use something else for more than few months, I&nbsp;will have to pay psychotherapist instead of you guys. Apart from that, writing a&nbsp;calculator app seems like a&nbsp;simple task in my mind, so the cost isn’t going to be overwhelming, right?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I&nbsp;think I&nbsp;get it. Let us get it going then. We will be implementing the functionality incrementally, starting with the most essential ones. Which feature of the calculator would you consider the most essential?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That would be addition of numbers, I&nbsp;guess.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok, that will be our target for the first iteration. After the iteration, we will deliver this part of functionality for you to try out and give us some feedback. However, before we can even implement addition, we will have to implement displaying digits on the screen as you enter them. Is that correct?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> yes, I&nbsp;want the display stuff to work as well - it is the most basic feature, so…</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok then, this is a&nbsp;simple functionality, so let me suggest some user stories as I&nbsp;understand what you already said and you will correct me where I&nbsp;am wrong. Here we go:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">In order to</strong> know that the calculator is turned on, <strong class="calibre14">As a</strong> tax payer <strong class="calibre14">I want</strong> to see “0” on the screen as soon as I&nbsp;turn it on.</li>

    <li class="calibre13"><strong class="calibre14">In order to</strong> see what numbers I&nbsp;am currently operating on, <strong class="calibre14">As a</strong> tax payer, <strong class="calibre14">I want</strong> the calculator to display the values I&nbsp;enter</li>

    <li class="calibre13"><strong class="calibre14">In order to</strong> calculate sum of my different incomes, <strong class="calibre14">As a</strong> tax payer <strong class="calibre14">I want</strong> the calculator to enable addition of multiple numbers</li>
  </ol>

  <p class="calibre2">What do you think?</p>

  <p class="calibre2"><strong class="calibre14">Jane</strong>: The stories pretty much reflect what I&nbsp;want for the first iteration. I&nbsp;do not think I&nbsp;have any corrections to make.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now we will take each story and collect some examples of how it should work.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Johnny, don’t you think it is obvious enough to proceed with implementation straight away?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Trust me, Benjamin, if there is one word I&nbsp;fear most in communication, it is “obvious”. Miscommunication happens most often around things that people consider obvious, simply because other people do not.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Ok, I&nbsp;am in. What do I&nbsp;do?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us go through stories one by one and see if we can find some key examples of how the features work. The first story is…</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> know that the calculator is turned on, <strong class="calibre19">As a</strong> tax payer <strong class="calibre19">I want</strong> to see “0” on the screen as soon as I&nbsp;turn it on.</h3>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> I&nbsp;do not think there is much to talk about. If you display “0”, I&nbsp;will be happy. That is all.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us write down this example:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> That makes me wonder… what should happen when I&nbsp;press “0” again at this stage?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good catch, that is what these examples are for - they make our thinking concrete. As Ken Pugh says: “Often the complete understanding of a&nbsp;concept does not occur until someone tries to use the concept”. We would normally put it on a&nbsp;TODO list, because it is part of a&nbsp;different story, but we are actually done with this one, so let us move straight to the story about displaying entered digits. How about it, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Agree.</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> see what numbers I&nbsp;am currently operating on, <strong class="calibre19">As a</strong> tax payer, <strong class="calibre19">I want</strong> the calculator to display the values I&nbsp;enter</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us begin with the case raised by Benjamin. What should happen when I&nbsp;input “0” multiple times after I&nbsp;have only “0” on the display?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Just one “0” should be displayed</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Do you mean this?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">0,0,0</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Zero is a&nbsp;special case &ndash; it is displayed only once</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That is right. Other than this, the digits should just show on the screen, like this:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> How about this:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7,1,2,3,4,5,6</td>

      <td class="calibre23">1234567123456?</td>

      <td class="calibre23">Entered digits are displayed?</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Actually, no. My old calculator app has a&nbsp;limit of six digits that I&nbsp;can enter, so it should be:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7,1,2,3,4,5,6</td>

      <td class="calibre23">123456</td>

      <td class="calibre23">Display limited to six digits</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> another good catch, Benjamin!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;think I&nbsp;am beginning to understand why you like working with examples!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good. Is there anything else, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> No, that is pretty much it. Let us take another story.</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> calculate sum of my different incomes, <strong class="calibre19">As a</strong> tax payer <strong class="calibre19">I want</strong> the calculator to enable addition of multiple numbers</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Is the following all we have to support?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3,+,4,=</td>

      <td class="calibre23">9</td>

      <td class="calibre23">Simple addition of numbers</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> This scenario is correct, however, there is also a&nbsp;case when I&nbsp;start with “+” without inputting any number before. This should be treated as adding to zero:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">+,1,=</td>

      <td class="calibre23">1</td>

      <td class="calibre23">Addition shortcut &ndash; treated as 0+1</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> How about when the output is a&nbsp;number longer than six digits limit? Is it OK that we truncate it like this?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>

      <td class="calibre23">199999</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure, I&nbsp;do not mind. I&nbsp;do not add such big numbers anyway.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> There is still one question we missed. Let us say that I&nbsp;input a&nbsp;number, then press “+” and then another number without asking for result with “=”. What should I&nbsp;see?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Every time you press “+”, the calculator should consider entering current number finished and overwrite it as soon as you press any other digit:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3</td>

      <td class="calibre23">3</td>

      <td class="calibre23">Digits entered after + operator are treated as digits of a&nbsp;new number, the previous one is stored</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Oh, and just asking for result after the calculator is turned on should result in “0”.</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">=</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Result key in itself does nothing</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us sum up our discoveries:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">0,0,0</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Zero is a&nbsp;special case &ndash; it is displayed only once</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7</td>

      <td class="calibre23">123456</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3</td>

      <td class="calibre23">3</td>

      <td class="calibre23">Digits entered after + operator are treated as digits of a&nbsp;new number, the previous one is stored</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">=</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Result key in itself does nothing</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">+,1,=</td>

      <td class="calibre23">1</td>

      <td class="calibre23">Addition shortcut &ndash; treated as 0+1</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3,+,4,=</td>

      <td class="calibre23">9</td>

      <td class="calibre23">Simple addition of numbers</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>

      <td class="calibre23">199999</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> The limiting of digits displayed looks like a&nbsp;whole new feature, so I&nbsp;suggest we add it to the backlog and do it in another sprint. In this sprint, we will not handle such situation at all. How about that, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Fine with me. Looks like a&nbsp;lot of work. Nice that we discovered it up-front. For me, the limiting capability seemed so obvious that I&nbsp;did not even think it would be worth mentioning.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> See? That is why I&nbsp;do not like the word “obvious”. Jane, we will get back to you if any more questions arise. For now, II think we know enough to implement these three stories for you.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> good luck!</p>

  <h2 id="calibre_link-30" class="calibre5">Act 3: Test-Driven Development</h2>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, that was cool. Was that Acceptance Test-Driven Development?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> In a&nbsp;greatly simplified version, yes. The reason I&nbsp;took you with me was to show you the similarities between working with customer the way we did and working with the code using TDD process. They are both applying the same set of principles, just on different levels.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;am dying to see it with my own eyes. Shall we start?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure. If we followed the ATDD process, we would start writing what we call acceptance-level specification. In our case, however, a&nbsp;unit-level specification will be enough. Let us take the first example:</p>

  <h3 class="sigilnotintoc">Statement 1: Calculator should display 0 on creation</h3>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, try to write the first Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Boy, I&nbsp;do not know how to start.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> start by writing the statement in a&nbsp;plain English. What should the calculator do?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It should display “0” when I&nbsp;turn the application on.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> In our case, “turning on” is creating a&nbsp;calculator. Let us write it down as a&nbsp;method name:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{

}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Why is the name of the class <code class="calibre11">CalculatorSpecification</code> and the name of the method <code class="calibre11">ShouldDisplay0WhenCreated</code>?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> It is a&nbsp;naming convention. There are many others, but this is the one that I&nbsp;like. The rule is that when you take the name of the class without the <code class="calibre11">Specification</code> part followed by the name of the method, it should form a&nbsp;legit sentence. For instance, if I&nbsp;apply it to what we wrote, it would make a&nbsp;sentence: “Calculator should display 0 when created”.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ah, I&nbsp;see now. So it is a&nbsp;statement of behavior, isn’t it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> That is right. Now, the second trick I&nbsp;can sell to you is that if you do not know what code to start with, start with the expected result. In our case, we are expecting that the behavior will end up as displaying “0”, right? So let us just write it in form of an assertion.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You mean something like this?</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 Assert.Equal("0", displayedResult);
}

}</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Precisely.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> But that does not even compile. What use is it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> the code not compiling is the feedback that you needed to proceed. While previously you did not know where to start, now you have a&nbsp;clear goal - make this code compile. Firstly, whre do you get the displayed value?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> From the calculator display, of course!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Then write it down how you get the value form the display.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> like how?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> like this:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 var displayedResult = calculator.Display();

 Assert.Equal("0", displayedResult);
}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;see. Now the calculator is not created anywhere. I&nbsp;need to create it somewhere now or it will not compile and this is my next step. Is this how it works?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes, you are catching on quickly.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ok then, here goes:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 var calculator = new Calculator();

 var displayedResult = calculator.Display();

 Assert.Equal("0", displayedResult);
}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Bravo!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Now the code still does not compile, because I&nbsp;do not have the <code class="calibre11">Calculator</code> class at all…</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> sounds like a&nbsp;good reason to create it.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> OK.</p>
  <pre class="calibre10">public class Calculator
{
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks like the <code class="calibre11">Display()</code> method is missing too. I&nbsp;will add it.</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "0";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hey hey, not so fast!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> What?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> You already provided an implementation that will make our current Statement true. Remember its name? <code class="calibre11">ShouldDisplay0WhenCreated</code> - and that is exactly what the code you wrote does. Before we arrive at this point, let us make sure this Statement can ever be evaluates as false. So for now, let us change it to this:</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "Once upon a&nbsp;time in Africa…";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Look, now we can run the Specification and watch that Statement evaluate to false, because it expects “0”, but gets “Once upon a&nbsp;time in Africa…”.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Running… Ok, it is false. By the way, do you always use such silly values to make Statements false?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hahaha, no, I&nbsp;just did it to emphasize the point. Normally, I&nbsp;would write <code class="calibre11">return "";</code> or something similarly simple. Now we can evaluate the Statement and see it evaluate to false. Now we are sure that we have not yet implemented what is required for the Statement to be true.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;think I&nbsp;get it. For now, the Statement shows that we do not have something we need and gives us a&nbsp;reason to add this “thing”. When we do so, this Statement will show that we do have what we need. So what do we do now?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Write the simplest thing that makes this Statement true.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> like this?</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "0";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> But that is not a&nbsp;real implementation. What is the value behind putting in a&nbsp;hardcoded string? The final implementation is not going to be like this for sure!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> You’re right. The final implementation is most probably going to be different. What we did, however, is still valuable because:</p>

  <ol class="calibre12">
    <li class="calibre13">You’re one step closer to implementing the final solution</li>

    <li class="calibre13">This feeling that this is not the final implementation points you towards writing more Statements. When there is enough Statements to make your implementation complete, it usually means that you have a&nbsp;complete Specification of class behaviors as well.</li>

    <li class="calibre13">If you treat making every Statement true as an achievement, this practice allows you to evolve your code without losing what you already achieved. If by accident you break any of the behaviors you’ve already implemented, the Specification is going to tell you because one of the existing Statements that were previously true will then evaluate to false. You can then either fix it or undo your changes using version control and start over from the point where all existing Statements were true.</li>
  </ol>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> looks like quite a&nbsp;few benefits. Still, I&nbsp;will have to get used to this kind of working.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> do not worry, it is central to TDD, so you will grasp it in no time. Now, before we proceed to the next Statement, let us look at what we already achieved. First, we wrote a&nbsp;Statement that turned out false. Then, we wrote just enough code to make the Statement true. Time for a&nbsp;step called Refactoring. In this step, we will take a&nbsp;look at the Statement and the code and remove duplication. Can you see what is duplicated between the Statement and the code?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> both of them contain the literal “0”. The Statement has it here:</p>
  <pre class="calibre10">Assert.Equal("0", displayedResult);</pre>

  <p class="calibre2">and the implementation here:</p>
  <pre class="calibre10">return "0";</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, let us eliminate this duplication by introducing a&nbsp;constant called <code class="calibre11">InitialValue</code>. The Statement will now look like this:</p>
  <pre class="calibre10">[Fact] public void
ShouldDisplayInitialValueWhenCreated()
{
 var calculator = new Calculator();

 var displayedResult = calculator.Display();

 Assert.Equal(Calculator.InitialValue, displayedResult);
}
</pre>

  <p class="calibre2">and the implementation:</p>
  <pre class="calibre10">public class Calculator
{
  public const string InitialValue = "0";
  public string Display()
  {
    return InitialValue;
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> The code looks better and having the constant in one place will make it more maintainable, but I&nbsp;think the Statement in its current form is weaker than before. We could change the <code class="calibre11">InitialValue</code> to anything and the Statement would still be true, since it does not force this constant to be “0”.</p>

  <p class="calibre2">That is right. We need to add it to our TODO list to handle this case. Can you write it down?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure. I&nbsp;will write it as “TODO: 0 should be used as an initial value.”</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok. We should handle it now, especially that it is part of the story we are currently implementing, but I&nbsp;will leave it for later just to show you the power of TODO list in TDD - whatever is on the list, we can forget and get back to when we have nothing better to do. Our next item from the list is this:</p>

  <h3 class="sigilnotintoc">Statement 2: Calculator should display entered digits</h3>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, can you come up with a&nbsp;Statement for this behavior?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I&nbsp;will try. Here goes:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayEnteredDigits()
{
  var calculator = new Calculator();
  
  calculator.Enter(1);
  calculator.Enter(2);
  calculator.Enter(3);
  var displayedValue = calculator.Display();

  Assert.Equal("123", displayedValue);
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I&nbsp;am glad that you got the part about naming and writing a&nbsp;Statement. One thing we will have to work on here though.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> what is it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> When we talked to Jane, we used examples with real values. These real values were extremely helpful in pinning down the corner cases and uncovering missing scenarios. They were easier to imagine as well, so they were a&nbsp;perfect suit for conversation. If we were automating these examples on acceptance level, we would use those real values as well. When we write unit-level Statements, however, we use a&nbsp;different technique to get this kind of specification more abstract. First of all, let me enumerate the weaknesses of the approach you just used:</p>

  <ol class="calibre12">
    <li class="calibre13">Making a&nbsp;method <code class="calibre11">Enter()</code> accept an integer value suggests that one can enter more than one digit at once, e.g. <code class="calibre11">calculator.Enter(123)</code>, which is not what we want. We could detect such cases and throw exceptions if the value is outside the 0-9 range, but there are better ways when we know we will only be supporting ten digits (0,1,2,3,4,5,6,7,8,9).</li>

    <li class="calibre13">The Statement does not clearly show the relationship between input and output. Of course, in this simple case it is pretty self-evident that the sum is a&nbsp;concatenation of entered digits, we do not want anyone who will be reading this Specification in the future to have to guess.</li>

    <li class="calibre13">The Statement suggests that what you wrote is sufficient for any value, which isn’t true, since the behavior for “0” is different (no matter how many times we enter “0”, the result is just “0”)</li>
  </ol>

  <p class="calibre2">Hence, I&nbsp;propose the following:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.Equal(
  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  ),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Johnny, I&nbsp;am lost! Can you explain what is going on here?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure, what do you want to know?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> For instance, what is this <code class="calibre11">DigitKeys</code> type doing here?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> It is supposed to be an enumeration (note that it does not exist yet, we just assume that we have it) to hold all the possible digits user can enter, which are 0-9. This is to ensure that user will not write <code class="calibre11">calculator.Enter(123)</code>. Instead of allowing to enter any number and then detecting errors, we are giving our users a&nbsp;choice from among only the valid values.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Now I&nbsp;get it. So how about the <code class="calibre11">Any.Besides()</code> and <code class="calibre11">Any.Of()</code>? What do they do?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> They are methods from a&nbsp;small utility library I&nbsp;am using when writing unit-level Specifications. <code class="calibre11">Any.Besides()</code> returns any value from enumeration besides the one supplied as an argument. Hence, the call <code class="calibre11">Any.Besides(DigitKeys.Zero)</code> means “any of the values contained in DigitKeys enumeration, but not DigitKeys.Zero”.</p>

  <p class="calibre2">The <code class="calibre11">Any.Of()</code> is simpler - it just returns any value in an enumeration. Note that when I&nbsp;create the values this way, I&nbsp;state explicitly that this behavior occurs when first digit is non-zero. This technique of using generated values instead of literals has its own principles, but let us leave it for later. I&nbsp;promise to give you a&nbsp;detailed lecture on it. Agree?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You better do, because for now, I&nbsp;feel a&nbsp;bit uneasy with generating the values - it seems like the Statement we are writing is getting less deterministic this way. The last question - what about those weird comments you put in the code? Given? When? Then?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes, this is a&nbsp;convention that I&nbsp;use, not only in writing, but in thinking as well. I&nbsp;like to think about every behavior in terms of three elements: assumptions (given), trigger (when) and expected result (then). Using the words, we can summarize the Statement we are writing in the following way: “<strong class="calibre14">Given</strong> a&nbsp;calculator, <strong class="calibre14">when</strong> I&nbsp;enter some digits first one being other than zero, <strong class="calibre14">then</strong> they should all be displayed in order they were entered”. This is also something that I&nbsp;will tell you more about later.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure, for now I&nbsp;need just enough detail to understand what is going on - we can talk about the principles, pros and cons later. By the way, the following sequence of casts looks a&nbsp;little bit ugly:</p>
  <pre class="calibre10">  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  )
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> We will get back to it and make it more “smarter” in a&nbsp;second after we make this statement true. For now, we need something obvious. Something we know works. Let us evaluate this Statement. What is the result?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Failed, expected “331”, but was “0”.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, now let us write some code to make this Statement true. First, let us introduce an enumeration of digits:</p>
  <pre class="calibre10">public enum DigitKeys
{
 Zero = 0,
 TODO1, //TODO
 TODO2, //TODO
 TODO3, //TODO
 TODO4, //TODO
}</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> What is with all those bogus values? Should we not just enter all the digits we support?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Nope, not yet. We still do not have a&nbsp;Statement which would say what digits are supported and thus make us add them, right?.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You say you need a&nbsp;Statement for an element to be in an enum??</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> This is a&nbsp;specification we are writing, remember? It should say somewhere which digits we support, should it not?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It is difficult to agree with, especially that I&nbsp;am used to write unit tests, not Statements and in unit tests, I&nbsp;wanted to verify what I&nbsp;was unsure of.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I&nbsp;will try to give you more arguments later. For now, just bear with me and note that adding such Statement will be almost effortless.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> OK.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now for the implementation. Just to remind you - up to now, it looked like this:</p>
  <pre class="calibre10">public class Calculator
{
  public const string InitialValue = "0";
  public string Display()
  {
    return InitialValue;
  } 
}
</pre>

  <p class="calibre2">This is not enough to support displaying multiple digits (as we saw, because the Statement saying they should be supported was evaluated to false). So let us evolve the code to handle this case:</p>
  <pre class="calibre10">public class Calculator
{
 private int _result = 0;
      
 public void Enter(DigitKeys digit)
 {
  _result *= 10;
  _result += (int)digit; 
 }

 public string Display()
 {
  return _result.ToString();
 }
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now the Statement is true so we can go back to it and make it a&nbsp;little bit prettier. Let us take a&nbsp;second look at it:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.Equal(
  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  ),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Remember you said that you do not like the part where <code class="calibre11">string.Format()</code> is used?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Yeah, it seems a&nbsp;bit unreadable.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us extract this part into a&nbsp;utility method and make it more general - we will need a&nbsp;way of constructing expected displayed output in many of our future Statements. Here is my go at this helper method:</p>
  <pre class="calibre10">string StringConsistingOf(params DigitKeys[] digits)
{
 var result = string.Empty;
      
 foreach(var digit in digits) 
 {
  result += (int)digit;
 }
 return result;
}</pre>

  <p class="calibre2">Note that this is more general as it supports any number of parameters. And the Statement after this extraction looks like this:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.AreEqual(
  StringConsistingOf(nonZeroDigit, anyDigit1, anyDigit2),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks better to me. The Statement is still evaluated as true, which means we got it right, did we not?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Not exactly. With such moves such as this one, I&nbsp;like to be extra careful. Let us comment out the body of the <code class="calibre11">Enter()</code> method and see if this Statement can still be made false by the implementation:</p>
  <pre class="calibre10">public void Enter(DigitKeys digit)
 {
  //_result *= 10;
  //_result += (int)digit; 
 }
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Running… Ok, it is false now. Expected “243”, got “0”.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> good, now we are pretty sure that it works OK. Let us uncomment the lines we just commented out and move forward.</p>

  <h3 class="sigilnotintoc">Statement 3: Calculator should display only one zero digit if it is the only entered digit even if it is entered multiple times</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, this should be easy for you, so go ahead and try it. It is really a&nbsp;variation of previous Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Let me try… ok, here it is:</p>
  <pre class="calibre10">[Fact] public void 
ShouldDisplayOnlyOneZeroDigitWhenItIsTheOnlyEnteredDigitEvenIfItIsEnteredMultipleTimes()
{
 var zero = DigitKeys.Zero;
 var calculator = new Calculator();
      
 calculator.Enter(zero);
 calculator.Enter(zero);      
 calculator.Enter(zero);
      
 Assert.Equal(
  StringConsistingOf(DigitKeys.Zero), 
  calculator.Display()
 );
}</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, you are learning fast! Let us evaluate this Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It seems that our current code already fulfills the Statement. Should I&nbsp;try to comment some code to make sure this Statement can fail just like you did in the previous Statement?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> That would be wise thing to do. When a&nbsp;Statement is true without requiring you to change any production code, it is always suspicious. Just like you said, we have to modify production code for a&nbsp;second to force this Statement to be false, then undo this modification to make it true again. This isn’t as obvious as previously, so let me do it. I&nbsp;will mark all the added lines with <code class="calibre11">//+</code> comment so that you can see them easily:</p>
  <pre class="calibre10">public class Calculator
{
 int _result = 0;
 string fakeResult = "0"; //+
      
 public void Enter(DigitKeys digit)
 {
  _result *= 10;
  _result += (int)digit; 
  if(digit == DigitKeys.Zero) //+
  {  //+
    fakeResult += "0";  //+
  } //+
 }

 public string Display()
 {
  if(_result == 0)  //+
  {  //+
   return fakeResult;  //+
  }  //+
  return _result.ToString();
 }
}</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, looks like a&nbsp;lot of code just to make the Statement false! Is it worth the hassle? We will undo this whole modification in a&nbsp;second anyway</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Depends on how confident you want to feel. I&nbsp;would say that it is usually worth it - at least you know that you got everything right. It might seem like a&nbsp;lot of work, but it actually took me about a&nbsp;minute to add this code and imagine you got it wrong and had to debug it on a&nbsp;production environment. _That_ would be a&nbsp;waste of time.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ok, I&nbsp;think I&nbsp;get it. Since we saw this Statement turn false, I&nbsp;will undo this modification to make it true again.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure.</p>

  <div class="calibre24"></div><h2 id="calibre_link-31" class="calibre5">Epilogue</h2>

  <p class="calibre2">Time to leave Johnny and Benjamin, at least for now. I&nbsp;actually planned to make this chapter longer, and cover all the other operations, but I&nbsp;fear I&nbsp;would make this too long and get you bored. You should have a&nbsp;feel of how the TDD cycle looks like, especially that Johnny and Benjamin had a&nbsp;lot of conversations on many other topics in the meantime. I&nbsp;will be revisiting these topics later in the book. For now, so if you felt lost or unconvinced on any of the topics mentioned by Johnny, do not worry - I&nbsp;do not expect you to be proficient with any of the techniques shown in this chapter just yet. Time will come for that.</p>
</div>


<div class="calibre4" id="calibre_link-6">
  <h1 class="calibre1">Sorting Out The Bits</h1>

  <p class="calibre2">In the previous chapter, there has been a&nbsp;lively conversation between Johnny and Benjamin. Even in such a&nbsp;short session, Benjamin, as a&nbsp;TDD novice, had a&nbsp;lot of questions and a&nbsp;lot of things he needed sorted out. We will pick up all those questions and explain them one by one. Here they are:</p>

  <ul class="calibre25">
    <li class="calibre13">How to name a&nbsp;Statement?</li>

    <li class="calibre13">How to start writing a&nbsp;Statement?</li>

    <li class="calibre13">How is TDD about analysis and what does this “GIVEN-WHEN-THEN” mean?</li>

    <li class="calibre13">What exactly is the scope of a&nbsp;Statement? A class, a&nbsp;method, or something else?</li>

    <li class="calibre13">What is the role of TODO list in TDD?</li>

    <li class="calibre13">Why use anonymous generated values instead of literals as input of a&nbsp;specified behavior?</li>

    <li class="calibre13">Why and how to use the Any class?</li>

    <li class="calibre13">What code to extract from a&nbsp;Statement to shared utility method?</li>

    <li class="calibre13">Why such a&nbsp;strange approach to create enumerated constants?</li>
  </ul>

  <p class="calibre2">A lot of questions, isn’t it? It is unfortunate that TDD has this high entry barrier, at least for someone used to the traditional way of writing code. Anyway, that is what this tutorial is for - to answer such questions and lower this barrier. Thus, we will try to answer those questions one by one.</p>
</div>


<div class="calibre4" id="calibre_link-19">
  <h1 class="calibre1">How to start?</h1>

  <p class="calibre2">Whenever I&nbsp;sat down with a&nbsp;person that was about to write their first code in a&nbsp;Statement-first manner, the person would first stare at the screen, then at me, then would say: “what now?”. It is easy to say: “You know how to write code, you know how to write a&nbsp;unit test for it, just this time start with the latter rather than the first”, but for many people, this is something that blocks them completely. If you are one of them, do not worry - you are not alone. I&nbsp;decided to dedicate this chapter solely to techniques for kicking off a&nbsp;Statement when there is no code.</p>

  <h2 id="calibre_link-32" class="calibre5">Start with a&nbsp;good name</h2>

  <p class="calibre2">It may sound obvious, but some people are having serious trouble describing the behavior they expect from their code. If you can name such behavior, it is a&nbsp;great starting point.</p>

  <p class="calibre2">I know not everybody pays attention to naming their Statements, mainly because the Statements are considered as tests and second-level citizens - as long as they run and “prove the code does not contain defects”, they are considered sufficient. We will take a&nbsp;look at some examples of bad names and then I&nbsp;will introduce to you some rules of good naming.</p>

  <h3 class="sigilnotintoc">Consequences of bad naming</h3>

  <p class="calibre2">As I&nbsp;said, many people do not really care how their Statements are named. This is a&nbsp;symptom of treating the Specification as garbage or leftovers - such situation is dangerous, because as soon as this kind of thinking is established, it leads to bad, unmaintainable Specification that looks more like lumps of accidental code put together in a&nbsp;haste than a&nbsp;living documentation. Imagine that your Specification consists of names like this:</p>

  <ul class="calibre25">
    <li class="calibre13"><code class="calibre11">TrySendPacket()</code></li>

    <li class="calibre13"><code class="calibre11">TrySendPacket2()</code></li>

    <li class="calibre13"><code class="calibre11">testSendingManyPackets()</code></li>

    <li class="calibre13"><code class="calibre11">testWrongPacketOrder1()</code></li>

    <li class="calibre13"><code class="calibre11">testWrongPacketOrder2()</code></li>
  </ul>

  <p class="calibre2">and try for yourself how difficult it is to answer the following questions:</p>

  <ol class="calibre12">
    <li class="calibre13">How do you know what situation each Statement describes?</li>

    <li class="calibre13">How do you know whether the Statement describes a&nbsp;single situation, or few of them at the same time?</li>

    <li class="calibre13">How do you know whether the assertions inside those Statements are really the right ones assuming each Statement was written by someone else or a&nbsp;long time ago?</li>

    <li class="calibre13">How do you know whether the Statement should stay or be removed when you modify the functionality it specifies?</li>

    <li class="calibre13">If your changes in production code make a&nbsp;Statement evaluate to false, how do you know whether the Statement is no longer correct or the production code is wrong?</li>

    <li class="calibre13">How do you know whether you will not introduce a&nbsp;duplicate Statement for a&nbsp;behavior that is already specified by another Statement when adding to Specification originally created by another team member?</li>

    <li class="calibre13">How do you estimate, by looking at the runner tool report, whether the fix for failing Statement will be easy or not?</li>

    <li class="calibre13">How do you answer a&nbsp;new developer in your team when they ask you “what is this Statement for?”</li>

    <li class="calibre13">How can you keep track of the Statements already made about the specified class vs those that still need to be made?</li>
  </ol>

  <h3 class="sigilnotintoc">What does a&nbsp;good name contain?</h3>

  <p class="calibre2">For the name of the Statement to be of any use, it has to describe the expected behavior. At minimum, it should describe what happens under what circumstances. Let us take a&nbsp;look at one of the names Steve freeman and Nat Pryce came up in their great book Growing Object Oriented Software Guided By Tests:</p>
  <pre class="calibre10">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort()</pre>

  <p class="calibre2">Note few things about the name of the Statement:</p>

  <ol class="calibre12">
    <li class="calibre13">It describes a&nbsp;behavior of an instance of a&nbsp;specified class. Note that it does not contain method name that triggers the behavior, because what is specified is not a&nbsp;method, but the behavior itself. The name simply tells that what an instance does (“notifies listeners that server is unavailable”) under certain circumstances (“when cannot connect to its monitoring port”). It is important because such description is what you can derive from thinking about responsibilities of a&nbsp;class, so you do not need to know any of its method signature or the code that is inside of the class. Hence, this is something you can come up with before implementing - you just need to know why you created this class and build on this knowledge.</li>

    <li class="calibre13">
      <p class="calibre2">The name is relatively long. Really, really, <strong class="calibre14">really</strong> do not worry about it. As long as you are describing a&nbsp;single behavior, it is alright. I&nbsp;know usually people are hesitant to give long names to the Statements, because they try to apply the same rules to those names as to method names in production code (and in production code too long method name can be a&nbsp;sign of it having too many responsibilities). Let me make it clear - these two cases are different. In case of Statements, methods are not invoked by anyone besides the automatic runner applications, so they will not obfuscate any code that would need to call them with their long names. Sure, we could put all the information in the comment instead of Statement name and leave the name short, like this:</p>
      <pre class="calibre10">[Fact]
//Notifies listeners that server 
//is unavailable when cannot connect
//to its monitoring port
public void Statement_002()
{
 //...
}
</pre>

      <p class="calibre2">There are two downsides to this solution: one is that we now have to put extra information (<code class="calibre11">Statement_002</code>) which is required only by compiler, because every method needs to have a&nbsp;name - there is usually no value a&nbsp;human could derive from such a&nbsp;name. The second downside is that when the Statement is evaluated to false, the automated runner shows you the following line: <code class="calibre11">Statement_002: FAILED</code> - note that all the information included in the comment isn’t present in the failure report. It is really better to receive a&nbsp;report such as:</p>

      <p class="calibre2"><code class="calibre11">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort: FAILED</code></p>

      <p class="calibre2">because then a&nbsp;lot of information about the Statement that fails is available from the runner window.</p>
    </li>

    <li class="calibre13">Using a&nbsp;name that describes a&nbsp;(single) behavior allows you to track quickly why the Statement is false when it is. Suppose a&nbsp;Statement is true when you start refactoring, but at one point it starts being evaluated as false and the report in the runner looks like this: <code class="calibre11">TrySendingHttpRequest: FAILED</code> - it does not really tell you anything more than that an attempt is made to send a&nbsp;HTTP request, but, for instance, does not tell you whether your specified object is the sender (that should try to send this request under some circumstances) or the receiver (that should handle such request properly). To actually know what went wrong, you have to go Statement body and scan its source code. Now compare it to the following name: <code class="calibre11">ShouldRespondWithAnAckWheneverItReceivesAHttpRequest</code>. Now when it evaluates to false, you can tell what is broken - the object no longer responds with an ACK to HTTP request. Sometimes this is enough to identify which part of the code is in fault of this evaluation failure.</li>
  </ol>

  <h3 class="sigilnotintoc">My favourite convention</h3>

  <p class="calibre2">There are many conventions for naming Statements appropriately. My favorite is the one developed by Dan North, which makes each Statement name begin with the word <code class="calibre11">Should</code>. So for example, I&nbsp;would name a&nbsp;Statement:</p>

  <p class="calibre2"><code class="calibre11">ShouldReportAllErrorsSortedAlphabeticallyWhenItEncountersErrorsDuringSearch()</code></p>

  <p class="calibre2">The name of the Specification (i.e. class name) answers the question “who should do it?”, i.e. when I&nbsp;have a&nbsp;class named <code class="calibre11">SortingOperation</code> and want to say that it “should sort all items in ascending order when performed”, I&nbsp;say it like this:</p>
  <pre class="calibre10">public class SortingOperationSpecification
{
 [Fact] public void
 ShouldSortAllItemsInAscendingOrderWhenPerformed()
 {
 }
}
</pre>

  <p class="calibre2">The “should” word was introduced by Dan to weaken the statement following it and thus, to allow questioning what you are stating and ask yourself the question: “should it really?”. If this causes uncertainty, then it is high time to talk to a&nbsp;domain expert and make sure you understand well what you need to accomplish. If you are not a&nbsp;native English speaker, the “should” prefix will probably have a&nbsp;weaker influence on you - that is why I&nbsp;do not insist on you using it. I&nbsp;like it though.</p>

  <p class="calibre2">When inventing a&nbsp;name, It is important to put the main focus on what result or action is expected from an object. If you do not, you quickly find it troublesome. As an example, one of my colleagues was specifying a&nbsp;class <code class="calibre11">UserId</code> and wrote the following name for the Statement about comparison of two identifiers:</p>

  <p class="calibre2"><code class="calibre11">EqualOperationShouldPassForTwoInstancesWithTheSameUserName()</code>.</p>

  <p class="calibre2">Note that this is not from the perspective of a&nbsp;single object, but rather from the perspective of an operation that is executed on it, which means that we stopped thinking in terms of object responsibilities and started thinking in terms of operation correctness, which is farther away from our assumption that we are writing a&nbsp;Specification consisting o Statements. This name should be something more like:</p>

  <p class="calibre2"><code class="calibre11">ShouldReportThatItIsEqualToAnotherIdThatHasTheSameUserName()</code>.</p>

  <h2 id="calibre_link-33" class="calibre5">Start By Filling The GIVEN-WHEN-THEN Structure With The Obvious<br class="calibre26" /></h2>

  <p class="calibre2">This is a&nbsp;technique that is applicable when you come up with a&nbsp;GIVEN-WHEN-THEN structure for the Statement or a&nbsp;good name for it (GIVEN-WHEN-THEN structure can be easily derived from a&nbsp;good name and vice versa). Anyway, this technique is about taking the GIVEN, WHEN and THEN parts and translating them into code in almost literal, brute-force way, then add all the missing pieces that are required for the code to compile and run.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Let us take a&nbsp;simple example of comparing two users. We assume that a&nbsp;user should be equal to another when it has the same name as the other one:</p>
  <pre class="calibre27">GIVEN a&nbsp;user with any name
WHEN I&nbsp;compare it to another user with the same name
THEN it should appear equal to this other user
</pre>

  <p class="calibre2">Let us start with the translation</p>

  <p class="calibre2">The first line:</p>
  <pre class="calibre27">GIVEN a&nbsp;user with any name</pre>

  <p class="calibre2">can be translated literally to code like this:</p>
  <pre class="calibre10">var user = new User(anyName);</pre>

  <p class="calibre2">Then the second line:</p>
  <pre class="calibre27">WHEN I&nbsp;compare it to another user with the same name</pre>

  <p class="calibre2">can be written as:</p>
  <pre class="calibre10">user.Equals(anotherUserWithTheSameName);</pre>

  <p class="calibre2">Great! Now the last line:</p>
  <pre class="calibre27">THEN it should appear equal to this other user</pre>

  <p class="calibre2">and its translation into the code:</p>
  <pre class="calibre10">Assert.True(areUsersEqual);</pre>

  <p class="calibre2">Ok, so we have made the translation, now let us summarize this and see what is missing to make this code compile:</p>
  <pre class="calibre10">[Fact] public void 
ShouldAppearEqualToAnotherUserWithTheSameName()
{
  //GIVEN
  var user = new User(anyName);

  //WHEN
  user.Equals(anotherUserWithTheSameName);

  //THEN
  Assert.True(areUsersEqual);
}
</pre>

  <p class="calibre2">As we expected, this will not compile. Notably, our compiler might point us towards the following gaps:</p>

  <ol class="calibre12">
    <li class="calibre13">A declaration of <code class="calibre11">anyName</code> variable.</li>

    <li class="calibre13">A declaration of <code class="calibre11">anotherUserWithTheSameName</code> object.</li>

    <li class="calibre13">The variable <code class="calibre11">areUsersEqual</code> is both not declared and it does not hold the comparison result.</li>

    <li class="calibre13">If this is our first Statement, we might not even have the <code class="calibre11">User</code> class defined at all.</li>
  </ol>

  <p class="calibre2">The compiler created a&nbsp;kind of a&nbsp;small TODO list for us, which is nice. Note that, while we do not have full compiling code, filling the gaps boils down to making a&nbsp;few trivial declarations and assignments:</p>

  <ol class="calibre12">
    <li class="calibre13">
      <code class="calibre11">anyName</code> can be declared as

      <p class="calibre2"><code class="calibre11">var anyName = Any.String();</code></p>
    </li>

    <li class="calibre13">
      <code class="calibre11">anotherUserWithTheSameName</code> can be declared as

      <p class="calibre2"><code class="calibre11">var anotherUserWithTheSameName = new User(anyName);</code></p>
    </li>

    <li class="calibre13">
      <code class="calibre11">areUsersEqual</code> can be declared and assigned this way:

      <p class="calibre2"><code class="calibre11">var areUsersEqual = user.Equals(anotherUserWithTheSameName);</code></p>
    </li>

    <li class="calibre13">If <code class="calibre11">User</code> class does not exist, we can add it by simply stating:

      <p class="calibre2"><code class="calibre11">public class User {}</code></p>
    </li>
  </ol>

  <p class="calibre2">Putting it all together:</p>
  <pre class="calibre10">[Fact] public void 
ShouldAppearEqualToAnotherUserWithTheSameName()
{
  //GIVEN
  var anyName = Any.String();
  var user = new User(anyName);
  var anotherUserWithTheSameName = new User(anyName);

  //WHEN
  var areUsersEqual = user.Equals(anotherUserWithTheSameName);

  //THEN
  Assert.True(areUsersEqual);
}
</pre>

  <p class="calibre2">And that is it - the Statement is complete!</p>

  <h2 id="calibre_link-34" class="calibre5">Start From The End</h2>

  <p class="calibre2">This is a&nbsp;technique that I&nbsp;suggest to people that seem to have absolutely no idea how to start. I&nbsp;got it from Kent Beck’s book Test Driven Development by Example. It seems funny at start, but is quite powerful. The trick is to write the Statement ‘backwards’, i.e. starting with what the Statement asserts to be true (in terms of the GIVEN-WHEN-THEN structure, we would say that we start with our THEN).</p>

  <p class="calibre2">This works because, while we are many times quite sure of our goal (i.e. what the outcome of the behavior should be), but are unsure of how to get there.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Imagine we are writing a&nbsp;class for granting access to a&nbsp;reporting functionality based on roles. We do not have any idea what the API should look like and how to write our Statement, but we know one thing: in our domain the access can be either granted or denied. Let us take the successful case (just because it is the first one we can think of) and, starting backwards, start with the following assertion:</p>
  <pre class="calibre10">//THEN
Assert.True(accessGranted);</pre>

  <p class="calibre2">Ok, that part was easy, but did we make any progress with that? Of course we did - we now have a&nbsp;non-compiling code and the compilation error is because of the <code class="calibre11">accessGranted</code> variable. Now, in contrast to the previous approach (with translating our GIVEN-WHEN-THEN structure into a&nbsp;Statement), our goal is not to make this compile as soon as possible. The goal is to answer ourselves a&nbsp;question: how do I&nbsp;know whether the access is granted or not? The answer: it is the result of authorization of the allowed role. Ok, so let us just write it down, ignoring everything that stands in our way (I know that most of us have a&nbsp;habit to add a&nbsp;class or a&nbsp;variable as soon as we find out that we need it. If you are like that, then please turn off this habit while writing Statements - it will only throw you off the track and steal your focus from what is important. The key to doing TDD successfully is to learn to use something that does not exist yet like it existed):</p>
  <pre class="calibre10">//WHEN
var accessGranted 
 = authorization.IsAccessToReportingGrantedTo(
  roleAllowedToUseReporting);
</pre>

  <p class="calibre2">Note that we do not know what <code class="calibre11">roleAllowedToUseReporting</code> is, neither do we know what is <code class="calibre11">authorization</code>, but that did not stop us from writing this line. Also, the <code class="calibre11">IsAccessToReportingGrantedTo()</code> method is just taken from the top of our head. It is not defined anywhere, it just made sense to write it like this, because it is the most direct translation of what we had in mind.</p>

  <p class="calibre2">Anyway, this new line answers the question on where do we take the <code class="calibre11">accessGranted</code> from, but makes us ask further questions:</p>

  <ol class="calibre12">
    <li class="calibre13">Where does the <code class="calibre11">authorization</code> variable come from?</li>

    <li class="calibre13">Where does the <code class="calibre11">roleAllowedToUseReporting</code> variable come from?</li>
  </ol>

  <p class="calibre2">As for <code class="calibre11">authorization</code>, we do not have anything specific to say about it other than that it is an object of a&nbsp;class that we do not have yet. In order to proceed, let us pretend that we have such a&nbsp;class. How do we call it? The instance name is <code class="calibre11">authorization</code>, so it is quite straightforward to name the class <code class="calibre11">Authorization</code> and instantiate it in the simplest way we can think of:</p>
  <pre class="calibre10">//GIVEN
var authorization = new Authorization();
</pre>

  <p class="calibre2">Now for the <code class="calibre11">roleAllowedToUseReporting</code>. The first question that comes to mind when looking at this is: which roles are allowed to use reporting? Let us assume that in our domain, this is either an Administrator or an Auditor. Thus, we know what is going to be the value of this variable. As for the type, there are various ways we can model a&nbsp;role, but the most obvious one for a&nbsp;type that has few possible values is an enum. So:</p>
  <pre class="calibre10">//GIVEN
var roleAllowedToUseReporting = Any.Of(Roles.Admin, Roles.Auditor);
</pre>

  <p class="calibre2">And so, working our way backwards, we have arrived at the final solution (we still need to give this Statement a&nbsp;name, but, provided what we already know, this is an easy task):</p>
  <pre class="calibre10">[Fact] public void
ShouldAllowAccessToReportingWhenAskedForEitherAdministratorOrAuditor()
{
 //GIVEN
 var roleAllowedToUseReporting = Any.Of(Roles.Admin, Roles.Auditor);
 var authorization = new Authorization();

 //WHEN
 var accessGranted = authorization
  .IsAccessToReportingGrantedTo(roleAllowedToUseReporting);

 //THEN
 Assert.True(accessGranted);
}</pre>

  <h2 id="calibre_link-35" class="calibre5">Start By Invoking a&nbsp;Method When You Have One</h2>

  <p class="calibre2">Sometimes, we have to add a&nbsp;new class that implements an existing interface required by another class. The fact of implementing an interface imposes what methods should the new class support. If this point is already decided, we can start our Statement by first calling the method and then discovering what we need to supply.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Suppose we have an application holding a&nbsp;lot of data that, among other things, handles importing am existing database from another instance of the application. As importing a&nbsp;database can be a&nbsp;lengthy process, a&nbsp;message box is displayed each time when user chooses to perform the import and this message box displays the following message: “Johnny, please sit down and enjoy your coffee for a&nbsp;few minutes as we take time to import your database” (given user name is Johnny). The class that implements it looks like this:</p>
  <pre class="calibre10">public class FriendlyMessages
{
 public string 
 HoldOnASecondWhileWeImportYourDatabase(string userName)
 {
   return string.Format("{0}, "
     + "please sit down and enjoy your coffee "
     + "for a&nbsp;few minutes as we take time "
     + "to import your database",
     userName);
 }
}</pre>

  <p class="calibre2">Now, imagine that our management told us that they need to ship a&nbsp;trial version with some features disabled, including importing an existing database. Among all the things we need to do to make it happen, we also need to display a&nbsp;different string with message saying that this is a&nbsp;trial version and the feature is locked. We can do it by extracting an interface from the <code class="calibre11">FriendlyMessages</code> class and using it to put in an instance of another class implementing this interface when the application discovers that it is being run as a&nbsp;trial version. The extracted interface looks like this:</p>
  <pre class="calibre10">public interface Messages
{
  string HoldOnASecondWhileWeImportYourDatabase(string userName);
}</pre>

  <p class="calibre2">So our new implementation is forced to support the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> method. Thus, we when implementing the class, we start with the following:</p>
  <pre class="calibre10">public class TrialVersionMessages : Messages
{
 public string HoldOnASecondWhileWeImportYourDatabase(string userName)
 {
   throw new NotImplementedException();
 }
}</pre>

  <p class="calibre2">Now, we are ready to start writing a&nbsp;Statement. Assuming we do not know where to start, we just start with creating an object and invoking the method that needs to be implemented:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 
 //WHEN
 trialMessages.HoldOnASecondWhileWeImportYourDatabase();

 //THEN
 Assert.True(false); //to remember about it
}</pre>

  <p class="calibre2">As you can see, we added an assertion that always fails at the end because we do not have any assertions yet and the Statement would otherwise be already evaluated as true and we would rather have it remind ourselves that it is not finished. Other than this, the Statement does not compile anyway, because the method <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> takes a&nbsp;string argument and we passed none. This makes us ask the question what is this argument and what is its role in the behavior triggered by the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> method. Seems like it is a&nbsp;user name and we want it to be somewhere in the result of the method. Thus, we can add it to the Statement like this:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 var userName = Any.String();
 
 //WHEN
 trialMessages.
  HoldOnASecondWhileWeImportYourDatabase(userName);

 //THEN
 Assert.True(false); //to remember about it
}</pre>

  <p class="calibre2">Now, this compiles but is evaluated as false because of the guard assertion that we put at the end. Our goal is to substitute it with a&nbsp;real assertion for a&nbsp;real expected result. The return value of the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> is a&nbsp;string message, so all we need to do is to come up with the message that we expect in case of trial version:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 var userName = Any.String();
 
 //WHEN
 var message = trialMessages.
  HoldOnASecondWhileWeImportYourDatabase(userName);

 //THEN
 var expectedMessage = 
  string.Format("{0}, better get some pocket money!", userName);

 Assert.Equal(expectedMessage, message);
}
</pre>

  <p class="calibre2">and all that is left is to find a&nbsp;good name for the Statement. This isn’t an issue since we already specified the desired behavior in the code, so we can just summarize it as something like <code class="calibre11">ShouldYieldAMessageSayingThatFeatureIsLockedWhenAskedForImportDatabaseMessage</code>.</p>

  <h2 id="calibre_link-36" class="calibre5">Summary</h2>

  <p class="calibre2">These few techniques can be useful when you are stuck and do not know how to start. Note that the examples given are simplistic and assume that there is one object that takes some kind of input parameter and returns a&nbsp;well defined result. This is not how most of the object-oriented world is built. In object oriented world, we have a&nbsp;lot of objects communicating with other objects, sending messages, invoking methods on each other and often having no return values. Do not worry, all of these techniques work in this concept and we’ll be revisiting them as soon as we learn how to do TDD in fully object-oriented world (that is, after we introduce a&nbsp;concept of mock objects). For now, I’m trying to keep it simple.</p>
</div>


<div class="calibre4" id="calibre_link-1">
  <h1 class="calibre1">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</h1>

  <h2 id="calibre_link-37" class="calibre5">Is there really a&nbsp;commonality between analysis and TDD?</h2>

  <p class="calibre2">From Wikipedia:</p>

  <blockquote cite="https://en.wikipedia.org/wiki/Analysis" class="calibre18">
    Analysis is the process of breaking a&nbsp;complex topic or substance into smaller parts to gain a&nbsp;better understanding of it.
  </blockquote>

  <p class="calibre2">Thus, in order for TDD to be about analysis, it has to fulfill two conditions:</p>

  <ol class="calibre12">
    <li class="calibre13">Be a&nbsp;process of breaking a&nbsp;complex topic into smaller parts</li>

    <li class="calibre13">Allow gaining a&nbsp;better understanding of such broken topics</li>
  </ol>

  <p class="calibre2">In the story about Johnny, Benjamin and Jane, I&nbsp;included a&nbsp;part where they analyze requirements using concrete examples. Johnny explained that this is a&nbsp;part of a&nbsp;technique called Acceptance Test-Driven Development. The process followed by the three characters fulfilled both mentioned conditions for a&nbsp;process to be analytical. But what about TDD itself?</p>

  <p class="calibre2">Actually, I&nbsp;used parts of ATDD process in the story to make the analysis part more obvious, but similar things happen at pure technical levels. For example, when starting development with a&nbsp;failing application-wide Statement (we will talk about levels of granularity of Statements later. For now the only thing you need to know is that the so called “unit tests level” is not the only level of granularity we write Statements on), we may encounter a&nbsp;situation where we need to call a&nbsp;web method and assert its result. This makes us think: what should this method be called? What are the scenarios supported? What do I&nbsp;need to get out of it? How should its user be notified about errors? Many times, this leads us to either a&nbsp;conversation (if there is another stakeholder that needs to be involved in the decision) or rethinking our assumptions. This is how we gain a&nbsp;better understanding of the topic we are analyzing, which makes TDD fulfill the first of the two requirements for it to be an analysis method.</p>

  <p class="calibre2">But what about the first requirement? What about breaking a&nbsp;complex logic into smaller parts?</p>

  <p class="calibre2">If you go back to our example, you will note that both when talking to a&nbsp;customer and when writing code, Johnny and Benjamin used a&nbsp;TODO list. This list was first filled with whatever scenarios they came up with, but later, they would add a&nbsp;smaller unit of work. This is one way complex topics are decomposed into smaller items that all land on the TODO list (the other way is mocking, but we will not get into that yet). Thanks to this, we can focus on one thing at a&nbsp;time, crossing off item after item from the list after it is done. If we learn something new or encounter new issue that needs our attention, we can add it to the TODO list and get back to it later, for now continuing our work on the current point of focus.</p>

  <p class="calibre2">An example TODO list from the middle of implementation may look like this (do not read trough it, I&nbsp;put it here only to give you a&nbsp;glimpse):</p>

  <ol class="calibre28">
    <li class="calibre13">
      <del class="calibre29">Create entry point to the module (top-level abstraction)</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement main workflow of the module</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement Message interface</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement MessageFactory interface</del>
    </li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13">
      <del class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</del>
    </li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Age field</li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
  </ol>

  <p class="calibre2">Note that some items are already crossed out as done, while other remain undone and waiting to be addressed.</p>

  <p class="calibre2">Ok, that is it for the discussion. Now that we are sure that TDD is about analysis, let us focus on the tools can use to aid and inform it. You already saw both of them in this book, now we are going to have a&nbsp;closer look.</p>

  <h2 id="calibre_link-38" class="calibre5">Gherkin</h2>

  <p class="calibre2">Hungry? Too bad, because the Gkerkin I&nbsp;am gonna talk about is not edible. It is a&nbsp;notation and a&nbsp;way of thinking about behaviors of the specified piece of code. It can be applied on different levels of granularity - any behavior, whether of a&nbsp;whole system or a&nbsp;single class, may be described using it.</p>

  <p class="calibre2">We actually talked about Gherkin before in this book, just did not name it. It is the GIVEN-WHEN-THEN structure that you can see everywhere, even in code samples as comments. This time, we are stamping a&nbsp;name on it and analyzing it further.</p>

  <p class="calibre2">In Gherkin, a&nbsp;behavior description consists of three parts:</p>

  <ol class="calibre12">
    <li class="calibre13">Given - a&nbsp;context</li>

    <li class="calibre13">When - a&nbsp;cause</li>

    <li class="calibre13">Then - a&nbsp;effect</li>
  </ol>

  <p class="calibre2">In other words, the emphasis is on causality in a&nbsp;given context.</p>

  <p class="calibre2">As I&nbsp;said, there are different levels you can apply this. Here is an example for such a&nbsp;behavior description from the perspective of its end user (this is called acceptance-level Statement):</p>
  <pre class="calibre10">Given a&nbsp;bag of tea costs $20
When I&nbsp;buy two of them
Then I&nbsp;pay 30$ due to promotion</pre>

  <p class="calibre2">And here is one for unit-level (note the line starting with “And” that adds to the context):</p>
  <pre class="calibre10">Given a&nbsp;list with 2 items
When I&nbsp;add another item
And check count of items
Then the count should be 3</pre>

  <p class="calibre2">While on acceptance level we put such behavior descriptions together with code as the same artifact (If this does not ring a&nbsp;bell, look at tools like SpecFlow or Cucumber or FIT to get some examples), on the unit level the description is usually not written down literally, but in form of code only. Still, this structure is useful when thinking about behaviors required from an object or objects, as we saw when we talked about starting from Statement rather than code. I&nbsp;like to put the structure explicitly in my Statements - I&nbsp;find that it makes them more readable. So most of my unit-level Statements follow this template:</p>
  <pre class="calibre10">[Fact]
public void Should__BEHAVIOR__()
{
  //GIVEN
  ...context…

  //WHEN
  ...trigger…

  //THEN
  ...assertions etc….
}
</pre>

  <p class="calibre2">Sometimes the WHEN and THEN sections are not so easily separable - then I&nbsp;join them, like in case of the following Statement specifying that an object throws an exception when asked to store null:</p>
  <pre class="calibre10">[Fact]
public void ShouldThrowExceptionWhenAskedToStoreNull()
{
  //GIVEN
  var safeList = new SafeList();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; safeList.Store(null)
  );
}
</pre>

  <p class="calibre2">By thinking in terms of these three parts of behavior, we may arrive at different circumstances (GIVEN) at which the behavior takes place, or additional ones that are needed. The same goes for triggers (WHEN) and effects (THEN). If anything like this comes to our mind, we add it to the TODO list.</p>

  <h2 id="calibre_link-39" class="calibre5">TODO list… again!</h2>

  <p class="calibre2">As we said previously, a&nbsp;TODO list is a&nbsp;repository for anything that comes to our mind when writing or thinking about a&nbsp;Statement, but is not a&nbsp;part o the current Statement we are writing. We do not want to forget it, neither do we want it to haunt us and distract us from our current task, so we write it down as soon as possible and continue with our current task.</p>

  <p class="calibre2">Suppose you are writing a&nbsp;piece of small logic that allows user access when he is an employee of a&nbsp;zoo, but denies access if he is a&nbsp;guest of the zoo. Then, after starting writing a&nbsp;Statement it gets to you that actually any employee can be a&nbsp;guest as well - for example, he might choose to visit the zoo with his family during his vacation. Still, the two previous rules hold, so not to allow this case to distract you, you quickly add an item to the TODO list (like “TODO: what if someone is an employee, but comes to the zoo as a&nbsp;guest?”) and finish the current Statement. When you are finished, you can always come back to the list and pick item to do next.</p>

  <p class="calibre2">There are two important questions related to TODO lists: “what exactly should we add as a&nbsp;TODO list item?” and “How to efficiently manage the TODO list?”. We will take care of these two questions now.</p>

  <h3 class="sigilnotintoc">What to put on the TODO list?</h3>

  <p class="calibre2">Everything that you need addressed but is not part of the current Statement. Those items may be related to implementing unimplemented methods, to add whole functionalities (such items are usually followed my more fine-grained sub tasks as soon as you start implementing the item), there might be reminders to take a&nbsp;better look at something (e.g. “investigate what is this component’s policy for logging errors”) or questions about the domain that need to get answered. If you get carried away too much in coding that you forget to eat, you can even add a&nbsp;reminder (“TODO: get something to eat!”). The list is yours!</p>

  <h3 class="sigilnotintoc">How to pick items from TODO list?</h3>

  <p class="calibre2">Which item to choose from the TODO list when you have several? I&nbsp;have no clear rule, although I&nbsp;tend to take into account the following factors:</p>

  <ol class="calibre12">
    <li class="calibre13">Risk - if what I&nbsp;learn by implementing or discussing a&nbsp;particular item from the list can have big impact on design or behavior of the system, I&nbsp;tend to pick such items first. An example of such item is that you start implementing validation of a&nbsp;request that arrives to your application and want to return different error depending on which part of the request is wrong. Then, during the development, you discover that more than one part of the request can be wrong at a&nbsp;time and you have to answer yourself a&nbsp;question: which error code should be returned in such case? Or maybe the return codes should be accumulated for all validations and then returned as a&nbsp;list?</li>

    <li class="calibre13">Difficulty - depending on my mental condition (how tired I&nbsp;am, how much noise is currently around my desk etc.), I&nbsp;tend to pick items with difficulty that best matches this condition. For example, after finishing an item that requires a&nbsp;lot of thinking and figuring out things, I&nbsp;tend to take on some small and easy items to feel wind blowing in my sails and to rest a&nbsp;little bit.</li>

    <li class="calibre13">Completeness - in simplest words, when I&nbsp;finish test-driving an “if” case, I&nbsp;usually pick up the “else” next. For example, after I&nbsp;finish implementing a&nbsp;Statement saying that something should return true for values less than 50, then the next item to pick up is the “greater or equal to 50” case. Usually, when I&nbsp;start test-driving a&nbsp;class, I&nbsp;take items related to this class until I&nbsp;run out of them, then go on to another one.</li>
  </ol>

  <h3 class="sigilnotintoc">Where to put a&nbsp;TODO list?</h3>

  <p class="calibre2">There are two ways of maintaining a&nbsp;TODO list. The first one is on a&nbsp;sheet of paper, which is nice, but requires you to take your hands off the keyboard, grab a&nbsp;pen or pencil and then get back to coding every time you think of something. Also, the only way a&nbsp;TODO item written on a&nbsp;sheet of paper can tell you which place in code it is related to, is (obviously) by its text.</p>

  <p class="calibre2">Another alternative is to use a&nbsp;TODO list functionality built-in into an IDE. Most IDEs, such as Visual Studio (and Resharper plugin has its own enhanced version), Xamarin Studio or eclipse-based IDEs have such functionality. The rules are simple - you put special comments in the code and a&nbsp;special view in your IDE aggregates them for you, allowing you to navigate to each. Such lists are great because:</p>

  <ol class="calibre12">
    <li class="calibre13">They do not force you to take your hands off keyboard to add an item to the list.</li>

    <li class="calibre13">You can put such item in a&nbsp;certain place in the code where is makes sense and then navigate back to it with a&nbsp;click of a&nbsp;mouse. This, apart from other advantages, lets you write shorter notes than if you had to do it on paper. For example, a&nbsp;TODO item saying “TODO: what if it throws an exception?” looks out of place on the paper, but when added as a&nbsp;comment to your code in the right place, it is mighty sufficient.</li>

    <li class="calibre13">Many TODO lists automatically add items for certain things. E.g. in C#, when you are yet to implement a&nbsp;method that was automatically generated by a&nbsp;tool, its body usually consists of a&nbsp;line that throws a&nbsp;<code class="calibre11">NotImplementedException</code> exception. Guess what - <code class="calibre11">NotImplementedException</code> occurences are added to the TODO list automatically, so we do not have to manually add items to the TODO list for implementing the methods where they occur.</li>
  </ol>

  <h3 class="sigilnotintoc">Expanded TDD process with a&nbsp;TODO list</h3>

  <p class="calibre2">In one of the previous chapters, I&nbsp;introduced you to the basic TDD process that contained three steps: write unfulfilled Statement, fulfill it and refactor the code. TODO list adds new steps to this process leading to the following list of steps:</p>

  <ol class="calibre12">
    <li class="calibre13">Examine TODO list and pick an item that makes most sense to implement next</li>

    <li class="calibre13">Write unfulfilled Statement</li>

    <li class="calibre13">Make it unfulfilled for the right reason</li>

    <li class="calibre13">Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>

    <li class="calibre13">Cross out the item from TODO list</li>

    <li class="calibre13">Repeat until no item is left on the TODO list</li>
  </ol>

  <p class="calibre2">Of course, we are free to add new items to the TODO list as we make progress with the existing ones and at the beginning of each cycle the list is re-evaluated to choose the most important item to implement next taking into account what was added during the previous cycle.</p>

  <h3 class="sigilnotintoc">Potential downsides</h3>

  <p class="calibre2">There are also some downsides. The biggest is that people often add TODO items for other means than to support TDD and they never go back to such items. Some people joke that a&nbsp;TODO left in the code means “Once, I&nbsp;wanted to…”. Anyway, such items may pollute your TDD-related TODO list with so much cruft that your own items are barely findable. To work around it, I&nbsp;tend to use a&nbsp;different tag than TODO (many IDEs let you define your own tags, or support multiple tag types out of the box. E.g. with Resharper, I&nbsp;like to use “bug” tag, because this is something no one would leave in the code) and filter by it. Another options is, of course, getting rid of the leftover TODO items - if no one addressed it for a&nbsp;year, then probably no one ever will.</p>

  <p class="calibre2">Another downside is that when you work with multiple workspaces/solutions, your IDE will gather TODO items only from current solution/workspace, so you will have few TODO lists - one per workspace or solution. Fortunately, this isn’t usually a&nbsp;big deal.</p>
</div>


<div class="calibre4" id="calibre_link-7">
  <h1 class="calibre1">Developing TDD style and Constrained Non-Determinism</h1>

  <p class="calibre2">In one of the first chapters, I&nbsp;introduced to you the idea of anonymous values generator idea, which I&nbsp;have wrapped in a&nbsp;static class called <code class="calibre11">Any</code>. Throughout the next chapters, you have seen me using it quite extensively in many of the Statements I&nbsp;wrote.</p>

  <p class="calibre2">The time has come to explain a&nbsp;little bit more carefully what principles lie under this technique and tool. I&nbsp;will also use this technique as a&nbsp;case study to show you how one develops a&nbsp;style of Test-Driven Development.</p>

  <h2 id="calibre_link-40" class="calibre5">A style?</h2>

  <p class="calibre2">Yep. Why am I&nbsp;wasting your time writing about style instead of giving you the hardcore technical details? The answer is simple. Before I&nbsp;started writing this tutorial, I&nbsp;read four or five books solely on TDD and maybe two others that contain chapters on TDD. All of this sums up to about two or three thousands of paper pages, plus numerous posts on many blogs. And you know what I&nbsp;noticed? No two authors use exactly the same sets of techniques for test-driving their code! I&nbsp;mean, sometimes, when you look techniques they are suggesting, the suggestions from two authorities contradict each other. As each authority has their followers, it is not uncommon to observe and take part in discussions about whether this or that technique is better than a&nbsp;competing one or which one leads to trouble in the long run.</p>

  <p class="calibre2">I did this, too. I&nbsp;also tried to understand how come people praise techniques I&nbsp;KNEW were wrong and led to disaster. Then, Finally, I&nbsp;got it. I&nbsp;understood that it is not a&nbsp;“technique A vs. technique B” debate. There are certain sets of techniques that work together and choosing one technique leaves us with issues we have to resolve by adopting other techniques. This is how a&nbsp;style is created.</p>

  <p class="calibre2">Developing a&nbsp;style starts with underlying set of principles. These principles lead us to adopt our first technique, which makes us adopt another one and, ultimately, a&nbsp;coherent style emerges. Using Constrained Non-Determinism as an example, I&nbsp;will try to show you how part of a&nbsp;style gets derived from a&nbsp;technique that is derived from a&nbsp;principle.</p>

  <h2 id="calibre_link-41" class="calibre5">Principle: Tests As Specification</h2>

  <p class="calibre2">As I&nbsp;already stressed, I&nbsp;strongly believe that unit tests constitute an executable specification. Thus, they should not only pass input values to an object and assert on the output, they should also convey to their reader the rules according to which objects and functions work. The following oversimplified example shows a&nbsp;Statement where it is not explicitly stated what is the relationship between input and output:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo("MY_HOST_NAME");
  
  //THEN
  Assert.Equal("backup_MY_HOST_NAME.zip");
}</pre>

  <p class="calibre2">Although the relationship can be guessed quite easily, remember it is just an example. Also, seeing code like that makes me ask questions like: is the “backup_” prefix always applied? What if I&nbsp;actually pass “backup_” instead of “MY_HOST_NAME”? Will the name be “backup_backup_.zip”, or “backup_.zip”? Also, is this object responsible for any validation of passed string?</p>

  <p class="calibre2">This makes me invent a&nbsp;first technique to provide my Statements with better support for the principle I&nbsp;believe in.</p>

  <h2 id="calibre_link-42" class="calibre5">First technique: Anonymous Input</h2>

  <p class="calibre2">I can wrap the actual value “MY_HOST_NAME” with a&nbsp;method and give it a&nbsp;name that better documents the constraints imposed on it by the specified functionality. In our case, we can pass whatever string we want (the object is not responsible for input validation), so we will name our method <code class="calibre11">AnyString()</code>:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var hostName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName);
  
  //THEN
  Assert.Equal("backup_MY_HOST_NAME.zip");
}

public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">By using <strong class="calibre14">anonymous input</strong>, we provide a&nbsp;better documentation of the input value. Here, I&nbsp;wrote <code class="calibre11">AnyString()</code>, but of course, there can be a&nbsp;situation where I&nbsp;use more constrained data, e.g. <code class="calibre11">AnyAlphaNumericString()</code> when I&nbsp;need a&nbsp;string that does not contain any characters other than letters and digits. Note that this technique <strong class="calibre14">is applicable only when the particular value of the variable is not important, but rather its “trait”</strong>. Taking authorization as an example, when a&nbsp;certain behavior occurs only when the input value is <code class="calibre11">Users.Admin</code>, there is <strong class="calibre14">no sense</strong> making it anonymous. On the other hand, for a&nbsp;behavior that occurs for all values other than <code class="calibre11">Users.Admin</code>, it makes sense to use a&nbsp;method like <code class="calibre11">AnyUserOtherThan(Users.Admin)</code> or even <code class="calibre11">AnyNonAdminUser()</code>.</p>

  <p class="calibre2">Now that the Statement itself is freed from the knowledge of the concrete value of <code class="calibre11">hostName</code> variable, the concrete value of “backup_MY_HOST_NAME.zip” looks kinda weird. There is no clear indication of the kind of relationship between input and output and whether there is any at all (one may reason whether the output is always the same string or maybe it depends on the string length). It is unclear which part is added by the production code and which part depends on the input we pass to the method. This leads us to another technique.</p>

  <h2 id="calibre_link-43" class="calibre5">Second Technique: Derived Values</h2>

  <p class="calibre2">To better document the relationship between input and output, we have to simply derive the expected value we assert on from the input value. Here is the same Statement with the assertion changed:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var hostName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName);
  
  //THEN
  Assert.Equal(string.Format("backup_{0}.zip", hostName);
}
public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">This looks more like a&nbsp;part of specification, because we are documenting the format of the backup file name and show which part of the format is variable and which part is fixed. This is something you would probably find documented in a&nbsp;paper specification for the application you are writing - it would probably contain a&nbsp;sentence saying: “The format of a&nbsp;backup file should be <strong class="calibre14">backup_H.zip</strong>, where <strong class="calibre14">H</strong> is the current local host name”.</p>

  <p class="calibre2"><strong class="calibre14">Derived values</strong> are about defining expected output in terms of the input that was passed to provide a&nbsp;clear indication on what is the “transformation” of the input required of the specified production code.</p>

  <h2 id="calibre_link-44" class="calibre5">Third technique: Distinct Generated Values</h2>

  <p class="calibre2">Let us assume that some time after our initial version is shipped, we are asked to make the backup feature applied locally per user only for this user’s data. As the customer does not want to confuse files from different users, we are asked to add name of the user doing backup to the backup file name. Thus, the new format is “backup_H_U.zip”, where H is still the host name and U is the user name. Our Statement for the pattern must change as well to include this information. Of course, we are trying to use the anonymous input again as a&nbsp;proven technique and we end up with:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">Now, we can clearly see that there is something wrong with this Statement. AnyString() is used twice and each time it returns the same value, which means that evaluating the Statement does not give us any guarantee, that both values are applied and that they are applied in the correct places. For example, the Statement will be evaluated to true when user name is used instead of host name in specified production code. This means that if we still want to use the anonymous input effectively, we have to make the two values distinct, e.g. like this:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString2();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return "MY_HOST_NAME";
}

public string AnyString2()
{
  return "MY_USER_NAME";
}</pre>

  <p class="calibre2">We solved the problem (for now) by introducing another helper method. However, this, as you can see, is not a&nbsp;very scalable solution. Thus, let us try to reduce the amount of helper methods for string generation to one and make it return a&nbsp;different value each time:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return Guid.NewGuid.ToString();
}</pre>

  <p class="calibre2">This time, we are not returning an understandable string, but rather a&nbsp;guid, which gives us the fairly strong guarantee of generating distinct value each time. The string not being understandable (contrary to something like “MY_HOST_NAME”) may leave you worried that maybe we are losing something, but hey, didn’t we say <strong class="calibre14">Any</strong>String()?</p>

  <p class="calibre2"><strong class="calibre14">Distinct generated values</strong> means that each time we need a&nbsp;value of a&nbsp;particular type, we get something different (if possible) than the last time and each value is generated automatically using some kind of heuristics.</p>

  <h2 id="calibre_link-45" class="calibre5">Fourth technique: Constant Specification</h2>

  <p class="calibre2">Let us consider another modification that we are requested to make - this time, the backup file name needs to contain version number of our application as well. Remembering that we want to use Derived Values, we will not hardcode the version number into our Statement. Instead, we are going to use a&nbsp;constant that is already defined somewhere else in the application (this way we also avoid duplication of this version number across the application):</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserNameAndVersion()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}_{2}.zip", 
    hostName, userName, Version.Number);
}

public string AnyString()
{
  return Guid.NewGuid.ToString();
}</pre>

  <p class="calibre2">Note that I&nbsp;didn’t use the literal constant value, but rather, the value inside the <code class="calibre11">Version.Number</code> constant. This allows us to use derived value, but leaves us a&nbsp;little worried about whether the value of the constant is correct - after all, we are using it for creation of our expected value, but it is a&nbsp;part of production code - i.e. is something that should be specified itself!</p>

  <p class="calibre2">To keep everyone happy, we write a&nbsp;single Statement just for the constant to specify what the value should be:</p>
  <pre class="calibre10">[Fact] public void 
ShouldContainNumberEqualTo1_0()
{
  Assert.Equal("1.0", Version.Number);
}</pre>

  <p class="calibre2">By doing so, we make the value in the production code just echo what is in our executable Specification, which we can fully trust.</p>

  <h2 id="calibre_link-46" class="calibre5">Summary of the example</h2>

  <p class="calibre2">In this example, I&nbsp;tried to show you how a&nbsp;style can evolve from the principles you value when doing TDD. I&nbsp;did so for two reasons:</p>

  <ol class="calibre12">
    <li class="calibre13">To introduce to you a&nbsp;set of techniques I&nbsp;personally use and recommend and to do it in a&nbsp;fluent and logical way.</li>

    <li class="calibre13">To help you better communicate with people that are using different styles. Instead of just throwing “you are doing it wrong” at them, try to understand their principles and how their techniques of choice support those principles.</li>
  </ol>

  <p class="calibre2">Now, let us take a&nbsp;quick summary of all the techniques introduced in example:</p>

  <dl class="calibre2">
    <dt class="calibre16">Anonymous Input</dt>

    <dd class="calibre17">moving the output out of the Statement code and hide it behind a&nbsp;method that to emphasize the constrain on the data used rather than what is its value</dd>

    <dt class="calibre16">Derived Values</dt>

    <dd class="calibre17">defining expected output in terms of the input in order to document the relationship between input and output</dd>

    <dt class="calibre16">Distinct Generated Values</dt>

    <dd class="calibre17">When using Anonymous Input, generate a&nbsp;distinct value each time (in case of types that have very few values, like boolean, try at least not to generate the same value twice in a&nbsp;row) in order to make the Statement more reliable.</dd>

    <dt class="calibre16">Constant Specification</dt>

    <dd class="calibre17">Write a&nbsp;separate Statement for a&nbsp;constant and use the constant instead of its literal value in all other Statements to create a&nbsp;Derived Value.</dd>
  </dl>

  <h2 id="calibre_link-47" class="calibre5">Constrained non-determinism</h2>

  <p class="calibre2">When we combine anonymous input together with distinct generated values, we get something that is called <strong class="calibre14">Constrained Non-Determinism</strong>. This is a&nbsp;term coined by Mark Seemann and basically means three things:</p>

  <ol class="calibre12">
    <li class="calibre13">Values are anonymous i.e. we do not know the actual value we are using</li>

    <li class="calibre13">The values are generated in as distinct as possible sequence (which means that, whenever possible, no two values generated one after another hold the same value)</li>

    <li class="calibre13">The non-determinism in generation of the values is constrained, which means that the algorithms for generating values are carefully picked in order to provide values that are not special in any way (e.g. when generating integers, we do not allow generating ‘0’ as it is usually a&nbsp;special-case-value)) and that are not “evil” (e.g. for integers, we generate small positive values first and go with bigger numbers only when we run out of those small ones).</li>
  </ol>

  <p class="calibre2">There are multiple ways to implement constrained non-determinism. Mark Seemann himself invented the AutoFixture library for C# that is freely available to download by anyone (the home is at https://github.com/AutoFixture/AutoFixture). Here is a&nbsp;shortest possible snippet to generate an anonymous integer using AutoFixture:</p>
  <pre class="calibre10">Fixture fixture = new Fixture();
var anonymousInteger = fixture.Create&lt;int&gt;();</pre>

  <p class="calibre2">I, after Amir Kolsky and Scott Bain, like to use Any class as seen in the previous chapters of this book. Any takes a&nbsp;slightly different approach than AutoFixture (although it uses AutoFixture internally). My implementation of Any class is available to download as well from https://github.com/grzesiek-galezowski/tdd-toolkit.</p>

  <h2 id="calibre_link-48" class="calibre5">Summary</h2>

  <p class="calibre2">That was a&nbsp;long ride, wasn’t it? I&nbsp;hope that this chapter, gave you some understanding of how different TDD styles came into existence and why I&nbsp;use some of the techniques I&nbsp;do (and how these techniques are not just a&nbsp;series of random choices). In the next chapters, I&nbsp;will try to introduce some more techniques to help you grow a&nbsp;bag of neat tricks - a&nbsp;coherent style.</p>
</div>


<div class="calibre4" id="calibre_link-12">
  <h1 class="calibre1">What is the scope of a&nbsp;unit-level Statement in TDD?</h1>

  <p class="calibre2">Ha, now I&nbsp;have to admit that I&nbsp;deferred for a&nbsp;long time an answer to a&nbsp;pretty fundamental question: what should be the scope of a&nbsp;single Statement? If I&nbsp;put the whole system together, can I&nbsp;write a&nbsp;Statement for its behavior? Or maybe the other way round - there should be a&nbsp;Statement for each method of each class, including the private ones? Well, first thing I&nbsp;want to explain is that there are multiple levels we can write write our Statements on. This varies depending on the TDD authority, but in this book, we will cover two of such levels - unit level and acceptance level. For now, let us stick to the unit level, which is what we have done so far anyway. The time will come for the rest.</p>

  <p class="calibre2">For unit level, let us consider the kind of Statements that you already saw in this book - where we take one object, invoke a&nbsp;method on it and assert on the result. This is actually a&nbsp;special case of unit-level Statement and we will cover more in the coming chapters. This is, however, a&nbsp;good moment to stop and consider the “scope” of a&nbsp;single unit-level Statement in TDD. Is it method scope? Class scope? Feature scope?</p>

  <p class="calibre2">Let us try to answer the question by examining some TDD unit-level Statements:</p>

  <h3 class="sigilnotintoc">Is it class scope?</h3>

  <p class="calibre2">Let us see the first example and try to answer this question:</p>
  <pre class="calibre10">[Fact] public void
ShouldThrowValidationExceptionWithFatalErrorLevelWhenValidatedStringIsEmpty()
{
  //GIVEN
  var emptyString = string.Empty;
  var validation = new Validation();

  //WHEN
  var exceptionThrown = Assert.Throws&lt;CustomException&gt;(
    () =&gt; validation.Perform(emptyString) 
  );
  
  //THEN
  Assert.True(exceptionThrown.IsFatalError);
}</pre>

  <p class="calibre2">This is an example of a&nbsp;well-written unit-level Statement. Ok, so let us see… how many real classes take part in this spec? Three: a&nbsp;string, an exception and the validation. So the class scope is not the most accurate description.</p>

  <h3 class="sigilnotintoc">Or a&nbsp;method scope?</h3>

  <p class="calibre2">So, maybe the scope covers a&nbsp;single method, meaning a&nbsp;Statement always exercises one method of a&nbsp;specified object?</p>

  <p class="calibre2">Let us consider the following example:</p>
  <pre class="calibre10">[Fact] public void 
ShouldBeFulfilledWhenEventOccursThreeTimes()
{
  //GIVEN
  var rule = new FullQueueRule();
  rule.Queued();
  rule.Queued();

  //WHEN
  rule.Queued();

  //THEN
  Assert.True(rule.IsFulfilled());
}
</pre>

  <p class="calibre2">Count with me: how many methods are called? Depending on how we count, it is two (<code class="calibre11">Queued()</code> and <code class="calibre11">IsFulfilled()</code>) or four (<code class="calibre11">Queued(), Queued(), Queued(), IsFulfilled()</code>). In any case, not one. So it is not method scope either.</p>

  <h3 class="sigilnotintoc">It is the scope of class behavior!</h3>

  <p class="calibre2">The proper answer is: behavior! Each TDD Statement specifies a&nbsp;single behavior. I&nbsp;like how <a href="http://sustainabletdd.com">Amir Kolsky and Scott Bain</a>&nbsp;phrase it, by saying that each unit-level Statement should “introduce a&nbsp;behavioral distinction not existing before”.</p>

  <p class="calibre2">It may look that “behavior” scope is actually broader than method or class levels, since such Statement can span multiple classes and multiple methods. This is only partially true. That is because e.g. Statements with method scope can span multiple behaviors (which, by the way, is a&nbsp;sign of poorly written Statement). Let us take a&nbsp;look at an example:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReportItCanHandleStringWithLengthOf3ButNotOf4AndNotNullString()
{
  //GIVEN
  var bufferSizeRule = new BufferSizeRule();
  //WHEN
  var resultForLength3 
    = bufferSizeRule.CanHandle(Any.StringOfLength(3));
  //THEN
  Assert.True(resultForLength3);

  //WHEN again?
  var resultForLength4 
    = bufferSizeRule.CanHandle(Any.StringOfLength(4))
  //THEN again?
  Assert.False(resultForLength4);

  //WHEN again??
  var resultForNull = bufferSizeRule.CanHandle(null);
  //THEN again??
  Assert.False(resultForNull);
}</pre>

  <p class="calibre2">Note that it specifies three (or two - depending on how you count) behaviors: acceptance of string of allowed size, refusal of handling string above the allowed size and a&nbsp;special case of null string. As I&nbsp;said - this is an antipattern and is sometimes called a&nbsp;“check-it-all test”. The issue with this kind of Statement is that it can be evaluated to false for at least two reasons - when the allowed string size changes and when null handling is done in another way. Also, xUnit tools by default stop execution on first error, so, assuming that the first assertion fails, we will not know the outcome of the next assertion unless we fix the previous one (does that mean we have to use a&nbsp;single <code class="calibre11">Assert</code> per Statement? We will take care of this question later. For now, let the answer be: “not necessarily”).</p>

  <p class="calibre2">On the other hand, Statements with behavior scope do not necessary have to be broader than those with class scope. Let us take the following example that proves it:</p>
  <pre class="calibre10">[Fact] public void
ShouldReportItIsStartedAndItDoesNotYetTransmitVoiceWhenItStarts()
{
  //GIVEN
  var call = new DigitalCall();
  call.Start();
 
  //WHEN
  var callStarted = call.IsStarted;
  
  //THEN
  Assert.True(callStarted);

  //WHEN-THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; call.Transmit(Any.InstanceOf&lt;Frame&gt;()));
}
</pre>

  <p class="calibre2">Again, there are two behaviors here: reporting the call status after start and not being able to transmit frames after start. That is why this test should be split into two.</p>

  <p class="calibre2">How to catch that you are writing a&nbsp;Statement about two or more behaviors rather than one? First, take a&nbsp;look at the test name - if it looks strange and contains some “And” or “Or” words, it may (but does not have to) be about more than one behavior. Another way is to write the description of a&nbsp;behavior in a&nbsp;Given-When-Then way. If you have more than one item in the “When” section or the structure is not Given-When-Then, but rather a&nbsp;“Given-When-Then-When-Then” - that is also a&nbsp;signal.</p>
</div>


<div class="calibre4" id="calibre_link-14">
  <div class="disclaimer">
    <h3 class="sigilnotintoc2">A Disclaimer</h3>

    <p class="calibre2">Before I&nbsp;begin, I&nbsp;have to admit that this chapter is mostly based on the material from a&nbsp;series of posts by Scot Bain and Amir Kolsky from the blog Sustainable Test Driven Development and their upcoming book by the same title. I&nbsp;like their idea of boundaries so much that I&nbsp;just follow the guidelines they outlined. This chapter is going to be a&nbsp;rephrase of these guidelines. I&nbsp;placed it here so that you have all the important topics covered in one place, but I&nbsp;encourage you to read the original blog posts on this subject on http://www.sustainabletdd.com (and the upcoming book).</p>
  </div>

  <h1 id="calibre_link-49" class="calibre1">Specifying Boundaries and Conditions</h1>

  <h2 id="calibre_link-50" class="calibre5">Sometimes, Anonymous Value Is Not Enough</h2>

  <p class="calibre2">When we specify a&nbsp;behavior, there are times when this behavior should be the same no matter what arguments we pass to the constructor or invoked methods. An example would be an addition of two numbers - whatever numbers we would supply, the answer would always be a&nbsp;sum of those numbers:</p>
  <pre class="calibre10">[Fact] public void
ShouldCalculateTheSumOfTwoNumbers()
{
  //GIVEN
  var a&nbsp;= Any.Integer();
  var b = Any.Integer();

  //WHEN
  var result = new Sum().Of(a, b);

  //WHEN
  Assert.Equal(a + b, result);
}</pre>

  <p class="calibre2">In this case, the integer numbers can really be “any” - the described relationship between input and output is independent of the actual values we use. As indicated in one of the previous chapters, this is the canonical case where Constrained Non-Determinism applies.</p>

  <p class="calibre2">Sometimes, however, objects exhibit different behaviors based on what is passed to their constructor and to their methods (OK, we also have static methods and singletons. Longer discussion on those will be included in one of the next chapters - for now we can safely ignore them). For example, in our application we may have a&nbsp;licensing policy where a&nbsp;feature is allowed to use only if the license is valid, and denied after it has expired. Another example would be that some shops are open from 10:00 to 18:00, so if we had a&nbsp;query in our application whether the shop is currently open, we would expect it to be answered differently based on what the current time is.</p>

  <p class="calibre2">In such cases, Scott and Amir offer us other guidelines for choosing input values.</p>

  <h2 id="calibre_link-51" class="calibre5">Exceptions To The Rule</h2>

  <p class="calibre2">There are times, when a&nbsp;Statement is true for every value except one (or more) explicitly specified. For example, in Poland, high school students are graded for exams between “mediocre” and “very good”. Every grade means the exam is passed except for “mediocre” grade which means the exam is failed. If we imagine we have to specify an object that decides whether the exam is passed based on rating, we would have to write two Statements: one for the mediocre rating and other for all the others.</p>

  <p class="calibre2">Here is the Statement for mediocre grade (let us imagine that all grades are members of an enum):</p>
  <pre class="calibre10">[Fact] public void
ShouldNotPassTheExamWhenGradeIsMediocre()
{
  //GIVEN
  var decision = new PassOrNotDecision();

  //WHEN
  var examPassed = decision.MakeBasedOn(Grades.Mediocre);

  //THEN
  Assert.False(examPassed);
}</pre>

  <p class="calibre2">Note that here, we used the literal value of <code class="calibre11">Grades.Mediocre</code>. This is because no other value gives the same behavior as this one, so generating the value would not make any sense.</p>

  <p class="calibre2">The second Statement is for all the other cases. Here, we are going to use another method of the <code class="calibre11">Any</code> class for generating ay enum member other than specified:</p>
  <pre class="calibre10">[Fact] public void
ShouldPassTheExamWhenGradeIsOtherThanMediocre()
{
  //GIVEN
  var decision = new PassOrNotDecision();

  //WHEN
  var examPassed 
    = decision.MakeBasedOn(Any.Besides(Grades.Mediocre));<br class="calibre6" />
  //THEN
  Assert.True(examPassed);
}</pre>

  <p class="calibre2">Here, <code class="calibre11">Any.Besides()</code> takes care of the enum value generation, producing a&nbsp;nice, readable code as a&nbsp;side effect.</p>

  <p class="calibre2">The example shown above assumes there is only one exception to the rule (the mediocre grade). However, this concept can be scaled up to more values, as long as it is a&nbsp;finished, discrete set. If there are multiple exceptional values that produce the same behavior, a&nbsp;single Statement is sufficient to cover them all (using <code class="calibre11">Any</code> class and making the following call for exception Statement: <code class="calibre11">Any.Of(value1, value2)</code> and the following for the rest: <code class="calibre11">Any.OtherThan(value1, value2)</code>). However, when there are multiple exceptions to the rule and each one triggers a&nbsp;different behavior, each one deserves its own Statement.</p>

  <h2 id="calibre_link-52" class="calibre5">Rules Valid Within Boundaries</h2>

  <p class="calibre2">Sometimes, a&nbsp;behavior varies around a&nbsp;numerical boundary. the simplest example would be a&nbsp;set of rules on how to calculate an absolute value of a&nbsp;number:</p>

  <ol class="calibre12">
    <li class="calibre13">for any X less than 0, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>

    <li class="calibre13">for any X greater or equal to 0, the result is X (e.g. absolute value of 3 is 3).</li>
  </ol>

  <p class="calibre2">As you can see, there is a&nbsp;boundary between the two behaviors and the right edge of the boundary is 0. Why do I&nbsp;say “right edge”? That is because the boundary always has two edges and there’s a&nbsp;length between them. If we assume we are talking about the mentioned absolute value calculation and that our numerical domain is that of integer numbers, we can as well use -1 as edge value and say that:</p>

  <ol class="calibre12">
    <li class="calibre13">for any X less or equal to -1, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>

    <li class="calibre13">for any X greater than -1, the result is X (e.g. absolute value of 3 is 3).</li>
  </ol>

  <p class="calibre2">So a&nbsp;boundary is not a&nbsp;single number - it always has a&nbsp;length - the length between last value of the previous behavior and the first value of the next behavior. In case of our example, the length between -1 (left edge - last negated number) and 0 (right edge - first non-negated) is 1.</p>

  <p class="calibre2">Now, imagine that we are not talking about integer values anymore, but about floating point values. Then the right edge value would still be 0. But what about left edge? It would not be possible for it to stay -1, because the rule applies to e.g. -0.9 as well. So what is the correct right edge value and the correct length of the boundary? Would the length be 0.1? Or 0.001? Or maybe 0.00000001? This is harder to answer and depends heavily on the context, but it is something that must be answered for each particular case - this way we know what kind of precision is expected of us. In our Specification, we have to document the boundary length somehow.</p>

  <p class="calibre2">So the next topic is: how to describe the boundary length with Statements? To illustrate this, I&nbsp;want to show you two Statements assuming we’re implementing the mentioned absolute value calculation for integers. The first Statement is for values smaller than 0 and we want to use the left edge value here ilke this:</p>
  <pre class="calibre10">[Fact] public void
ShouldNegateTheNumberWhenItIsLessThan0()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var lessThan0 = 0 - 1;

  //WHEN
  var result = function.PerformFor(lessThan0);

  //THEN
  Assert.Equal(-lessThan0, result);
}</pre>

  <p class="calibre2">And the next Statement for values at least 0 and we want to use the right edge value:</p>
  <pre class="calibre10">[Fact] public void
ShouldNotNegateTheNumberWhenItIsGreaterOrEqualTo0()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var moreOrEqualTo0 = 0;

  //WHEN
  var result = function.PerformFor(moreOrEqualTo0);

  //THEN
  Assert.Equal(moreOrEqualTo0, result);
}</pre>

  <p class="calibre2">There are two things to note about these examples. The first one is that we don’t use any kind of <code class="calibre11">Any</code> methods. We explicitly take the edges, because they’re the numbers that most strictly define the boundary. This way we document the boundary length.</p>

  <p class="calibre2">It is important to understand why we are not using methods like <code class="calibre11">Any.IntegerGreaterOrEqualTo(0)</code>, even though we do use <code class="calibre11">Any</code>&nbsp;in case when we have no boundary. This is because in the latter case, no value is better than the other in any particular way. In case of boundaries, however, the edge values are better in that they more strictly define the boundary and drive the right implementation.</p>

  <p class="calibre2">The second thing to note is the usage of literal constant 0 in the above example. In one of the previous chapter, I&nbsp;showed you a&nbsp;technique called <strong class="calibre14">Constant Specification</strong>, where we write an explicit Statement about the value of the named constant and use the named constant everywhere else instead of its literal. So why did i not use this technique?</p>

  <p class="calibre2">The only reason is that this might have looked a&nbsp;little bit silly with such extremely trivial example as calculating absolute value. In reality, I&nbsp;should have used the named constant in both Statements and it would show the boundary length even more clearly. Actually, let use perform this exercise now and see what happens.</p>

  <p class="calibre2">First, let us document the named constant:</p>
  <pre class="calibre10">[Fact] public void
ShouldIncludeSmallestValueNotToNegateSetToZero()
{
  Assert.Equal(0, Constants.SmallestValueNotToNegate);
}</pre>

  <p class="calibre2">Now we have got everything we need to rewrite the two Statements we wrote earlier. The first would look like this:</p>
  <pre class="calibre10">[Fact] public void
ShouldNegateTheNumberWhenItIsLessThanSmallestValueNotToNegate()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var lastNumberToNegate 
    = Constants.SmallestValueNotToNegate - 1;

  //WHEN
  var result = function.PerformFor(lastNumberToNegate);

  //THEN
  Assert.Equal(-lastNumberToNegate, result);
}</pre>

  <p class="calibre2">And the second Statement for values at least 0:</p>
  <pre class="calibre10">[Fact] public void
ShouldNotNegateNumberWhenItIsGreaterOrEqualToSmallestValueNotToNegate()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();

  //WHEN
  var result = function.PerformFor(
    Constants.SmallestValueNotToNegate
  );

  //THEN
  Assert.Equal(
    Constants.SmallestValueNotToNegate, result);
}</pre>

  <p class="calibre2">As you can see, the first Statement contains the following expression: <code class="calibre11">Constants.SmallestValueNotToNegate - 1</code>, where 1 is the exact length of the boundary. Like I&nbsp;said, the situation is so trivial that it may look silly and funny, however, in real life scenarios, this is a&nbsp;great technique to apply anytime, anywhere.</p>

  <p class="calibre2">Boundaries may look like they apply only to integer input, but they occur at many other places. There are boundaries associated with date/time (e.g. an action is performed again when time from last action is at least 30 seconds - the decision would need to be made whether we need precision in seconds or maybe in ticks), to strings (e.g. validation of user name where it must be at least 2 characters, or password that must contain at least 2 special characters) etc.</p>

  <h2 id="calibre_link-53" class="calibre5">Combination of Boundaries - Ranges</h2>

  <p class="calibre2">So, what about a&nbsp;behavior that is valid in a&nbsp;range? Let us assume that we live in a&nbsp;country where a&nbsp;citizen can get a&nbsp;driving license only after their 17th birthday, but before 65th (the government decided that people after 65 have worse sight and it’s safer not to give them new driving licenses). Let us also assume that we try to develop a&nbsp;class that answers the question whether we can apply for driving license and the return values of this query are as follows:</p>

  <ol class="calibre12">
    <li class="calibre13">Age &lt; 17 - returns enum value <code class="calibre11">QueryResults.TooYoung</code></li>

    <li class="calibre13">17 &lt;= age &gt;= 65 - returns enum value <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age &gt; 65 - returns enum value <code class="calibre11">QueryResults.TooOld</code></li>
  </ol>

  <p class="calibre2">Now, remember I&nbsp;told you that we specify the behaviors near boundaries? This, however, when applied to the situation I&nbsp;just described, would give us the following Statements:</p>

  <ol class="calibre12">
    <li class="calibre13">Age = 17, should yield result <code class="calibre11">QueryResults.TooYoung</code></li>

    <li class="calibre13">Age = 18, should yield result <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age = 65, should yield result <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age = 66, should yield result <code class="calibre11">QueryResults.TooOld</code></li>
  </ol>

  <p class="calibre2">thus, we would describe the behavior where the query should return <code class="calibre11">AllowedToApply</code> value twice, which effectively means that we would copy-paste the Statement and change just one value. How do we deal with this? Thankfully, we have a&nbsp;solution available:</p>

  <p class="calibre2">Most xUnit frameworks provide some kind of data-driven test functionality, which we can use to write parameterized Statements. The functionality basically means that we can write the code of the Statement once, but make the xUnit framework invoke it twice with different sets of input values. Let’s see an example in XUnit.net:</p>
  <pre class="calibre10">[Theory]
[InlineData(17, QueryResults.TooYoung)]
[InlineData(18, QueryResults.AllowedToApply)]
[InlineData(65, QueryResults.AllowedToApply)]
[InlineData(66, QueryResults.TooOld)]
public void ShouldYieldResultForAge(int age, QueryResults expectedResult)
{
  //GIVEN
  var query = new DrivingLicenseQuery();

  //WHEN
  var result = query.ExecuteFor(age);

  //THEN
  Assert.Equal(expectedResult, result);
}</pre>

  <p class="calibre2">This way, there is only one Statement executed four times. The case of <code class="calibre11">AllowedToApply</code> is still evaluated twice for both edge cases (so there is more time spent on executing it, which for small cases is not an issue), but the code maintenance issue is gone - we don’t have to copy-paste the code to specify both edges of the behavior.</p>

  <p class="calibre2">Note that we’re quite lucky because the specified logic is strictly functional (i.e. returns different results based on different inputs). Thanks to this, we could parameterize input values together with expected results. This is not always the case. For example, let us imagine that we have a&nbsp;clock class where we can set alarm time. The class allows us to set hour between 0 and 24, but otherwise throws an exception.</p>

  <p class="calibre2">While some xUnit frameworks, like NUnit, allow us to handle both cases with one Statement by writing something like this:</p>
  <pre class="calibre10">//NOTE: this is an example in NUnit framework!
[TestCase(Hours.Min, Result=Hours.Min)]
[TestCase(Hours.Max, Result=Hours.Max)]
[TestCase(Hours.Min-1, ExpectedException = typeof(OutOfRangeException))]
[TestCase(Hours.Max+1, ExpectedException = typeof(OutOfRangeException))]
public int 
ShouldBeAbleToSetHourBetweenMinAndMaxButNotOutsideThatRange(
  int inputHour)
{
  //GIVEN
  var clock = new Clock();
  clock.SetAlarmHour(inputHour);

  //WHEN
  var setHour = clock.GetAlarmHour();

  //THEN
  return setHour;
}</pre>

  <p class="calibre2">Others, like XUnit.NET, don’t (not that it’s a&nbsp;defect of the framework, it’s just that the philosophy behind those two is a&nbsp;little bit different and that some features have hidden price attached to their usage which some frameworks are willing to pay, while others aren’t). Thus, we have to solve it by writing two parameterized Statements - one where a&nbsp;value is returned (for valid cases) and one where exception is thrown (for invalid cases). The first would look like this:</p>
  <pre class="calibre10">[Theory]
[InlineData(Hours.Min)]
[InlineData(Hours.Max)]
public void 
ShouldBeAbleToSetHourBetweenMinAndMax(int inputHour)
{
  //GIVEN
  var clock = new Clock();
  clock.SetAlarmHour(inputHour);

  //WHEN
  var setHour = clock.GetAlarmHour();

  //THEN
  Assert.Equal(inputHour, setHour);
}</pre>

  <p class="calibre2">and the second:</p>
  <pre class="calibre10">[Theory]
[InlineData(Hours.Min-1)]
[InlineData(Hours.Max+1)]
public void 
ShouldThrowOutOfRangeExceptionWhenTryingToSetAlarmHourOutsideValidRange(
  int inputHour)
{
  //GIVEN
  var clock = new Clock();

  //WHEN - THEN
  Assert.Throws&lt;OutOfRangeException&gt;( 
    ()=&gt; clock.SetAlarmHour(inputHour)
  );
}</pre>

  <h2 id="calibre_link-54" class="calibre5">Summary</h2>

  <p class="calibre2">In this chapter, we covered specifying numerical boundaries with a&nbsp;minimal amount of code, so that the Specification is more maintainable and runs fast. There is one more kind of situation left: when we have compound conditions (e.g. a&nbsp;password must be at least 10 characters and contain at least 2 special characters) - we’ll get back to those when we introduce mocks.</p>
</div>


<div class="calibre4" id="calibre_link-11">
  <div class="disclaimer">
    The first occurence of the term triangulation I know about is in Kent Beck’s book <a href="http://www.pearsonhighered.com/educator/product/Test-Driven-Development-By-Example/9780321146533.page">Test Driven Development: By Example</a>.
  </div>

  <h1 class="calibre1">Triangulation</h1>

  <p class="calibre2">As one of the last topics of the core TDD techniques that do not require us to delve into the object oriented world, I’d like to show you triangulation.</p>

  <p class="calibre2">Triangulation is often described as the most conservative of three approaches of test-driving implementation. These approaches are:</p>

  <ol class="calibre12">
    <li class="calibre13">Type the obvious implementation</li>

    <li class="calibre13">Fake it (‘til you make it)</li>

    <li class="calibre13">Triangulate</li>
  </ol>

  <p class="calibre2">All of these techniques are simple (triangulaion being a&nbsp;youtubelittle more complex), so I’ll show you all of them one by one, putting more emphasis on triangulation:</p>

  <h2 class="calibre5">Type The Obvious Implementation</h2>

  <p class="calibre2">The first of the three techniques is just writing an obvious implementation in response to a Statetement. If the implementation is simple, this approach makes a lot of sense. Let’s take a trivial example of adding two numbers:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var sum = new Sum();

  //WHEN
  var result = sum.Of(3,5);

  //THEN
  Assert.Equal(8, result);
}</pre>

  <p class="calibre2">You may remember I told you that usually we write the simplest production code that would make the Statement true. This rule would encourage us to just return 7 from the <code class="calibre11">Of</code> method, because it would be sufficient to make the Statement true. Instead, we can decide that the logic is so obvious, that we can just write it based on this one Statement:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a+b;
  }
}</pre>

  <p class="calibre2">and this is it.</p>

  <p class="calibre2">Note that I didn’t use Constrained Non-Determinism here, because its use enforces using “Just write obvious implementation” technique. In fact, most (if not all) Statements we wrote so far in previous chapters, uses this approach because of this fact. Let’s take a look at how the above Statement would look if we used Constrained Non-Determinism:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var a = Any.Integer();
  var b = Any.Integer();
  var sum = new Sum();

  //WHEN
  var result = sum.Of(a,b);

  //THEN
  Assert.Equal(a + b, result);
}</pre>

  <p class="calibre2">Here, we don’t have any choice. The most obvious implementation that would make this Statement true is the correct implementation. We are unable to return some constant value as we previously could (but we did not), because we just don’t know what the expected result is and it is strictly dependent on the input values which we don’t know as well.</p>

  <h2 class="calibre5">Fake It (‘Til You Make It)</h2>

  <p class="calibre2">This technique is kind of funny. I do not recall myself ever using it, but it is so interesting I want to show it to you anyway. It is so simple you will not regret these few minutes even if just for broadening your horizons.</p>

  <p class="calibre2">There are two core things that we need to pay attention when using these technique:</p>

  <ol class="calibre12">
    <li class="calibre13">Start with the simplest implementation possible (i.e. fake it), which usually is returning a literal constant. Then gradually transform the code of both Statement and implementation using variables</li>

    <li class="calibre13">When doing it, rely on your sense of duplication between Statement and (fake) implementation</li>
  </ol>

  <p class="calibre2">Let us apply Fake It to the same addition example as before (I promise, for triangulation, I will give you better one). The Statement looks the same as before:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var sum = new Sum();

  //WHEN
  var result = sum.Of(3,5);

  //THEN
  Assert.Equal(8, result);
}</pre>

  <p class="calibre2">Only this time, we are going to use the simplest implementation possible. As I wrote, this simplest implementation is almost always to return a constant:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return 8;
  }
}</pre>

  <p class="calibre2">The Statement evaluates to true (green) now, though the implementation is obviously wrong. BUT, the TDD cycle is not over yet. Remember that as soon as the Statement is true, refactoring phase kicks in. This is something we were ignoring silently for now (and here we will only slightly lick it). We can use the refactoring phase to remove duplication between the Statement and the implementing code.</p>

  <p class="calibre2">First, let us note that the number 8 is duplicated between Statement and implementation - the implementation returns it and the Statement asserts on it. To reduce this duplication, let us break the 8 in the implementation into a sum:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return 3 + 5;
  }
}</pre>

  <p class="calibre2">Note the smart trick I did. I changed duplication between implementation and expected result to duplication between implementation and input values of the Statement. After all, 3 and 5 are the exact values I used in the Statement, right? This kind of duplication is different in that it can be removed using variables (this applies not only to input variables, but basically anything we have access to prior to triggering specified behavior - constructor parameters, fields etc. in contrast to result which we normally do not know until we invoke the behavior). The duplication of number 3 can be eliminated this way:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a + 5;
  }
}</pre>

  <p class="calibre2">and we have just the number 5 duplicated, because we used variable to transfer the value of 3 from Statement method to the <code class="calibre11">Of</code> implementation, so we have it in one place now. Let us do the same with 5:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a + b;
  }
}</pre>

  <p class="calibre2">And that’s it. I used a trivial example, since I don’t want to spend too much time on this, but you can find more advanced ones in Kent Beck’s book if you like.</p>

  <h2 class="calibre5">Triangulation</h2>

  <p class="calibre2">As I wrote, triangulation is the most conservative technique, because following it involves the tiniest possible steps to arrive at the right solution. The technique is called triangulation by analogy to <a href="http://encyclopedia2.thefreedictionary.com/radar+triangulation">radar triangulation</a> where outputs from at least two radars must be used to determine the position of a unit. Also, in radar triangulation, the position is measured indirectly, by combining the following data: range (not position!) between two radars, measurement done by each radar and the positions of the radars (which we know, because we are the ones who put the radars there). From this data, we can derive a triangle, so we can use trigonometry to calculate the position of the third point of the triangle, which is the desired position of the unit (two remaining points are the positions of radars). Such measurement is indirect in nature, because we do not measure the position directly, but calculate it from other helper measurements.</p>

  <p class="calibre2">These two characteristics: indirect measurement and using at least two sources of information are at the core of TDD triangulation. Basically, it says:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Indirect measurement</strong>: derive the design from few known examples of its desired external behavior by looking at what varies in these examples and making this variability into something more general</li>

    <li class="calibre13"><strong class="calibre14">Using at least two sources of information</strong>: start with the simplest possible implementation and make it more general <strong class="calibre14">only</strong> when you have two or more different examples (i.e. Statements that describe the desired functionality for specific inputs). Then new examples can be added and generalization can be done again. This process is repeated until we reach the desired implementation. Robert C. Martin developed a&nbsp;maxim on this, saying that “As the tests get more specific, the code gets more generic.</li>
  </ol>

  <p class="calibre2">Usually, when TDD is showcased on simple examples, triangulation is the primary technique used, so many novices mistakenly believe TDD is all about triangulation. This isn’t true, although triangulation is important.</p>

  <h4 class="sigilnotintoc1">Example</h4>

  <p class="calibre2">Suppose we want to write a logic that creates an aggregate sum of the list. Let’s assume that we have no idea how to design the internals of our custom list class so that it fulfills its responsibility. Thus, we start with the simplest example of calculating a sum of 0 elements:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturn0AsASumOfNoElements()
{
  //GIVEN
  var listWithAggregateOperations 
    = new ListWithAggregateOperations();

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(0, result);
}</pre>

  <p class="calibre2">Remember we want to write just enough code to make the Statement true. We can achieve it with just returning 0 from the <code class="calibre11">SumOfElements</code> method:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  public int SumOfElements()
  {
    return 0;
  }
}</pre>

  <p class="calibre2">This is not yet the implementation we are happy with, which makes us add another Statement - this time for a single element:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturnTheSameElementAsASumOfSingleElement()
{
  //GIVEN
  var singleElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(singleElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(singleElement, result);
}</pre>

  <p class="calibre2">The naive implementation can be as follows:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int _element = 0;

  public ListWithAggregateOperations()
  {    
  }

  public ListWithAggregateOperations(int element)
  {
    _element = element;
  }

  public int SumOfElements()
  {
    return _element;
  }
}</pre>

  <p class="calibre2">We have two examples, so let us check whether we can generalize now. We could try to get rid of the two constructors now, but let us wait just a little bit longer and see if this is the right path to go (after all, I told you that we need <strong class="calibre14">at least</strong> two examples).</p>

  <p class="calibre2">Let’s add third example then. What would be the next more complex one? Note that the choice of next example is not random. Triangulation is about considering the axes of variability. If you carefully read the last example, you probably noticed that we already skipped one axis of variability - the value of the element. We used <code class="calibre11">Any.Integer()</code> where we could use a literal value and add a second example with another value to make us turn it into variable. This time, however, I decided to <strong class="calibre14">type the obvious implementation</strong>. The second axis of variability is the number of elements. The third example will move us further along this axis - so it will use two elements instead of one or zero. This is how it looks like:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturnSumOfTwoElementsAsASumWhenTwoElementsAreSupplied()
{
  //GIVEN
  var firstElement = Any.Integer();
  var secondElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(firstElement, secondElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(firstElement + secondElement, result);
}</pre>

  <p class="calibre2">And the naive implementation will look like this:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int _element1 = 0;
  int _element2 = 0;

  public ListWithAggregateOperations()
  {
  }

  public ListWithAggregateOperations(int element)
  {
    _element1 = element;
  }

  //added
  public ListWithAggregateOperations(int element1, int element2)
  {
    _element1 = element1;
    _element2 = element2;
  }

  public int SumOfElements()
  {
    return _element1 + _element2; //changed
  }
}</pre>

  <p class="calibre2">After adding and implementing the third example, the variability of elements count becomes obvious. Now that we have three examples, we see even more clearly that we have redundant constructors and redundant fields for each element in the list and if we added a fourth example for three elements, we’d have to add another constructor, another field and another element of the sum computation. Time to generalize!</p>

  <p class="calibre2">How do we encapsulate the variability of the element count so that we can get rid of this redundancy? A collection! How do we generalize the addition of multiple elements? A&nbsp;foreach loop through the collection! Thankfully, C# supports <code class="calibre11">params</code> keyword, that let us use it to remove the redundant constructor like this:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int[] _elements;  

  public ListWithAggregateOperations(params int[] elements)
  {
    _elements = elements;
  }

  public int SumOfElements()
  {
    //changed
    int sum = 0;
    foreach(var element in _elements)
    {
      sum += element;
    }
    return sum;

  }
}</pre>

  <p class="calibre2">While the first Statement (“no elements”) seems like a special case, the remaining two - for one and two elements - seem to be just two variations of the same behavior (“some elements”). Thus, it is a good idea to make a more general Statement that describes this logic to replace the two examples. After all, we don’t want more than one failure for the same reason. So as the next step, I will write a Statement to replace these examples (I leave them in though, until I get this one to evaluate to true).</p>
  <pre class="calibre10">[Fact]
public void 
ShouldReturnSumOfAllItsElementsWhenAskedForAggregateSum()
{
  //GIVEN
  var firstElement = Any.Integer();
  var secondElement = Any.Integer();
  var thirdElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(
        firstElement, 
        secondElement, 
        thirdElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(
   firstElement + 
   secondElement + 
   thirdElement, result);
}
</pre>

  <p class="calibre2">This Statement uses three values rather than zero, one or two as in the examples we had. When I need to use collections with deterministic size (and I do prefer to do it everywhere where using collection with non-deterministic size would force me to use a <code class="calibre11">for</code> loop in my Statement), I pick 3, which is the number I got from Mark Seemann and the rationale is that 3 is the smallest number that has distinct head, tail and middle element. One or two elements seem like a special case, while three sounds generic enough.</p>

  <p class="calibre2">One more thing we can do is to ensure that we didn’t write a <strong class="calibre14">false positive</strong>, i.e. a Statement that is always true due to being badly written. In other words, we need to ensure that the Statement we just wrote will ever evaluate to false if the implementation is wrong. As we wrote it after the implementation is in place, we do not have this certainty.</p>

  <p class="calibre2">What we will do is to modify the implementation slightly to make it badly implemented and see how our Statement will react (we expect it to evaluate to false):</p>
  <pre class="calibre10">public class ListWithAggregateOperations
public int SumOfElements()
{
  //changed
  int sum = 0;
  foreach(var element in _elements)
  {
    sum += element;
  }
  return sum + 1; //modified with "+1"!
}
</pre>

  <p class="calibre2">When we do this, we can see our last Statement evaluate to false with a message like “expected 21, got 22”. We can now undo this one little change and go back to correct implementation.</p>

  <p class="calibre2">The examples (“zero elements”, “one element” and “two elements”) still evaluate to true, but it’s now safe to remove the last two, leaving only the Statement about a behavior we expect when we calculate sum of no elements and the Statement about N elements we just wrote.</p>

  <p class="calibre2">And voilà! We have arrived at the final, generic solution. Note that the steps we took were tiny - so you might get the impression that the effort was not worth it. Indeed, this example was only to show the mechanics of triangulation - in real life, if we encountered such simple situation we’d know straight away what the design would be and we’d start with the general Statement straight away and just type in the obvious implementation. Triangulation shows its power in more complex problems with multiple design axes and where taking tiny steps helps avoid “analysis paralysis”.</p>

  <h2 class="calibre5">Summary</h2>

  <p class="calibre2">As I stated before, triangulation is most useful when you have no idea how the internal design of a piece of functionality will look like (e.g. even if there are work-flows, they cannot be easily derived from your knowledge of the domain) and it’s not obvious along which axes your design must provide generality, but you are able to give some examples of the observable behavior of that functionality given certain inputs. These are usually situations where you need to slow down and take tiny steps that slowly bring you closer to the right design and functionality - and that’s what triangulation is for!</p>
</div>


<div class="calibre4" id="calibre_link-17">
  <h1 class="calibre1">Part 2: Test-Driven Development in Object Oriented World</h1>

  <p class="calibre2">Most of the examples I gave you during the previous part were about a single object that did not have dependencies on other objects (with an exception of some values - strings, integers, enums etc.). This is not how a real OO systems are built. In this part, we are finally going to look at scenarios where multiple objects collaborate together as a system.</p>

  <p class="calibre2">This brings about some issues that need to be discussed. One of them is the approach to object oriented design and how it influences the tools we use to test-drive our code. You probably heard something about a tool called mock objects (at least from one of the introductory chapters of this book) or, in more broaded sense, test doubles. If you open your web browser and type "mock objects break encapsulation", you will find a lot of different opinions - some saying that mocks are great, others blaming them for everything bad in the world, and a lot of opinions inbetween those. The discussions are still heated, even though mocks were introduced more than ten years ago. My goal in this chapter is to outline the real context and forces that lead to adoption of mocks and how to use them for your benefit, not failure.</p>

  <p class="calibre2">Steve Freeman, one of the godfathers of using mock objects with TDD, <a href="https://groups.google.com/d/msg/growing-object-oriented-software/rwxCURI_3kM/2UcNAlF_Jh4J">wrote</a>: "mocks arise naturally from doing responsibility-driven OO. All these mock/not-mock arguments are completely missing the point. If you're not writing that kind of code, people, please don't give me a hard time". I am going to introduce mocks in a way that will not give Steve a hard time, I hope.</p>

  <p class="calibre2">In order to do this, I need to cover some topics of object oriented design. That is why not all chapters in this part are specifically about TDD, but some are about object oriented techniques, practices and qualities you need to know to use TDD effectively in object oriented world. First of them being objects composability.</p>

  <p class="calibre2">After reading part 2, you will understand how mocks fit into test-driving object oriented code, how to make Statements using mocks maintainable and how some of the practices I&nbsp;introduced in the chapters of part 1 apply to mocks. You will also be able to test-drive simple object oriented systems.</p>
</div>


<div class="calibre" id="calibre_link-0">
  <h4 class="sigilnotintoc1">THIS IS ALL I HAVE FOR NOW. WHAT FOLLOWS IS RAW, UNORDERED MATERIAL THAT’S NOT YET READY TO BE CONSUMED AS PART OF THIS TUTORIAL</h4>
</div>


<div class="calibre4" id="calibre_link-8">
  <h1 class="calibre1">On Objects Composability</h1>

  <p class="calibre2">In this chapter, I will try to outline why objects' composability is a goal worth achieving and how it can be achieved. I am going to start with an example of unmaintainable code and will gradually fix its flaws in the next chapters. In this chapter, we are going to fix just one of the flaws, so the code we will end up will not be perfect by any means, still, it will be better by one quality.</p>

  <h1 class="calibre1">TODO make it into a role-play!</h1>

  <h1 class="calibre1">Another task for Johnny and Benjamin</h1>

  <p class="calibre2">Remember Johnny and Benjamin? Looks like they managed their previous task and are up to something else. Let us listen to their conversation as they are working on another project...</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> So, what's this assignment about?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Actually, it's nothing exciting - we'll have to add two features to a legacy application that's not prepared for the changes.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong>What is the code for?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong>It is a class that implements company policies. As the company has just started using this automated system and it was started recently, there is only one policy implemented: yearly incentive plan. Many corporations have what they call incentive plans. These plans are used to promote good behaviors and exceeding expectations by employees of a company.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You mean, the project has just started and is already in a bad shape?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yep. The guys writing it wanted to "keep it simple", whatever that means, and now it's pretty bad.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I see...</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> By the way, do you like riddles?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Always!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> So here's one: how do you call a development phase when you ensure high code quality?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> ... ... seems I don't have a clue... So what is it called?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> It's called "now".</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Oh!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> By the way, the company's incentive plan is one of the most stupid ones I've ever seen. Wonder how this company has managed to stay on the market for three years.</p>

  <p class="calibre2">Every employee in the company has a pay grade. An employee can be promoted to a higher pay grade, but the mechanics of how it works is something we are not going to deal with.</p>

  <p class="calibre2">Normally, every year, everyone gets a raise by 10%. But to encourage behaviors that give an employee a higher pay grade, such employee cannot get raises indefinitely on a given pay grade. Each grade has its associated maximum pay. If this amount of money is reached, an employee does not get a raise anymore until they reach a higher pay grade.</p>

  <p class="calibre2">Additionally, every employee on their 5th anniversary of working for the company, gets a special, one-time bonus which is twice their current payment.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks like the source code repository just finished synchronizing. Let's take a bite at the code!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure, here you go:</p>
  <pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = new SqlRepository();
  
  public void ApplyYearlyIncentivePlan()
  {
    var employees = _repository.CurrentEmployees();

    foreach(var employee in employees)
    {
      var payGrade = employee.GetPayGrade();
      if(employee.GetSalary() &lt; payGrade.Maximum)
      {
        var newSalary 
          = employee.GetSalary() 
          + employee.GetSalary() 
          * 0.1;
        employee.SetSalary(newSalary);
      }
      
      if(employee.GetYearseOfService() == 5)
      {
        var oneTimeBonus = employee.GetSalary() * 2;
        employee.SetBonusForYear(2014, oneTimeBonus);
      }
      
      employee.Save();
    }
  }
  
  public void Dispose()
  {
    _repository.Dispose();
  }
}</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, there are a lot of literal constants and functional decomposition is barely done!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yeah. We won't be fixing all of that today. Still, we will follow the scout rule and "leave the campground cleaner than we found it".</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> What's our assignment?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> First of all, we need to provide our users a choice between an SQL database and a NoSQL one. To achieve our goal, we need to be somehow able to make the <code class="calibre11">CompanyPolicies</code> class database type-agnostic. For now, as you can see, the implementation is coupled to the specific <code class="calibre11">SqlRepository</code>, because it creates a specific instance itself:</p>
  <pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = new SqlRepository();
</pre>

  <p class="calibre2">Now, we need to evaluate the options we have to pick the best one. What options do you see, Benjamin?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Well, we could certainly extract an interface from <code class="calibre11">SqlRepository</code> and introduce an if statement to the constructor like this:</p>
  <pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly Repository _repository;

  public CompanyPolicies()
  {
    if(...)
    {
      _repository = new SqlRepository();
    }
    else
    {
      _repository = new NoSqlRepository();
    }
  }
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> True, but this option has few deficiencies. First of all, remember we're following the scout rule and by using this option we introduce more complexity to the CommonPolicies class. Also, let's say tommorow someone writes a class for reporting - they will need to make the same decision on repositories. This means we would have to make the same decision in both of these classes, effectively duplicating code. What's our next option?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Another option would be to change the SqlRepository itself to be just a wrapper around the actual database access, like this:</p>
  <pre class="calibre10">public class SqlRepository : IDisposable
{
  readonly Repository _repository;

  public CompanyPolicies()
  {
    if(...)
    {
      _repository = new RealSqlRepository();
    }
    else
    {
      _repository = new RealNoSqlRepository();
    }
  }

  IList&lt;Employee&gt; CurrentEmployees()
  {
    return _repository.CurrentEmployees();
  }
</pre>

  <h1 class="calibre1">TOOOOOOOOOOOODOOOOOOOOOO</h1>

  <p class="calibre2">There are a couple of ways of dealing with this problem, like:</p>

  <h1 class="calibre1">TOOOOOOOOOODOOOOOOOOO convert the list to separate sections</h1>

  <ol class="calibre12">
    <li class="calibre13">Creating a constructor with an if statement inside to choose the database - this is a bad idea because other classes in our system use the database as well so the if statement will need to be duplicated.</li>

    <li class="calibre13">Changing the <code class="calibre11">SqlRepository</code> class itself so that it hides the information on the database used behind its own API - this could work, but will lead to every method duplicating the choice between the databases. If we decide to make the choice just once, we don't really need this class, because most of the time it will delegate to its inner implementation.</li>

    <li class="calibre13">Extract interface and pass either of its two implementations through the constructor.</li>
  </ol>

  <p class="calibre2">The third options seems to be the most compelling, so let us put it to use. We can extract an interface from <code class="calibre11">SqlRepository</code>, called <code class="calibre11">EmployeeSource</code> (TODO why this name?) and pass an instance from outside of the class:</p>
  <pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly EmployeeSource _employeeSource;  

  public CompanyPolicies(EmployeeSource source)
  {
    _employeeSource = source;
  }
  
  //...code  
  
  public void Dispose()
  {
    _employeeSource.Dispose();
  }
}</pre>

  <p class="calibre2">The <code class="calibre11">CompanyPolicies</code> is used in the code the following way:</p>
  <pre class="calibre10">
var policies = new CompanyPolicies(new SqlRepository());

//... somewhere else in the code

policies.ApplyYearlyIncentivePlan();

//... somewhere else in the code

policies.Dispose();
</pre>

  <p class="calibre2">Note two things: 1) as the employee source instance is passed by 3rd party, <code class="calibre11">CompanyPolicies</code> instances cannot assume the instance is used only by itself. Thus, it cannot neither initialize nor dispose of the instance. These two responsibilities have to be moved outside the class as well:</p>
  <pre class="calibre10">public class CompanyPolicies
{
  readonly EmployeeSource _employeeSource;  

  public CompanyPolicies(EmployeeSource source)
  {
    _employeeSource = source;
  }
  
  public void ApplyYearlyIncentivePlan()
  {
    var employees = _repository.CurrentEmployees();

    foreach(var employee in employees)
    {
      var payGrade = employee.GetPayGrade();
      if(employee.GetSalary() &lt; payGrade.Maximum)
      {
        var newSalary 
          = employee.GetSalary() 
          + employee.GetSalary() 
          * 0.1;
        employee.SetSalary(newSalary);
      }
      
      if(employee.GetYearseOfService() == 5)
      {
        var oneTimeBonus = employee.GetSalary() * 2;
        employee.SetBonusForYear(2014, oneTimeBonus);
      }

      employee.Save();
    }
  }
}</pre>

  <p class="calibre2">Note that we got rid of IDisposable, which is always good for abstraction... Now the usage pattern looks the same, only that now the same third party that created employees object, disposes of it. This is good, because one object has complete control over the lifetime of the employees object:</p>
  <pre class="calibre10">SqlRepository repository = new SqlRepository();
var policies = new CompanyPolicies(repository);

//... somewhere else in the code

policies.ApplyYearlyIncentivePlan();

//... somewhere else in the code

repository.Dispose();
</pre>

  <p class="calibre2">What have we achieved? Well, we allowed ourselves to choose the implementation of employees' storage. We did this by making the system composable - i.e. we can achieve different behaviors of the system by changing the way objects are composed together into a system. For example, instead of creating a <code class="calibre11">policies</code> object like this:</p>
  <pre class="calibre10">SqlRepository repository = new SqlRepository();
var policies = new CompanyPolicies(repository);</pre>

  <p class="calibre2">we can create it like this:</p>
  <pre class="calibre10">NoSqlRepository repository = new NoSqlRepository();
var policies = new CompanyPolicies(repository);</pre>

  <p class="calibre2">Or even, if we later decide to make the repository configurable by a strategy (e.g. there may be different definitions of what it means to get "current" employees) and extract the connection logic even further and make error reporting more configurable, we can do it like this:</p>
  <pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingToLogFile()
);
var policies = new CompanyPolicies(repository);</pre>

  <p class="calibre2">Everything without touching the <code class="calibre11">CompanyPolicies</code> class. Now, let us take the <code class="calibre11">ErrorReportingToLogFile</code> class and assume, that it is passed where an interface is required. We can, again, exchange this to something else, e.g.:</p>
  <pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingThroughNetwork());
);</pre>

  <p class="calibre2">Or make it configurable itself, e.g. with different formats and flushing algorithms (for performance purposes):</p>
  <pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingToLogFile(
    new XmlLogFormat(),
    new FlushingDelayedUntilCachedContentIsMoreThan(
      Kilobytes.Value(5)
    )
  )
);</pre>

  <p class="calibre2">Again, these modifications are all possible without touching the <code class="calibre11">RepositoryConfigurableByPolicies</code> class!</p>

  <h1 class="calibre1">Todo write about web of objects and how we can unplug parts of the web and plug in different parts to modify the system behavior without modifying the rest of the web</h1>

  <h1 class="calibre1">Todo write about composition root!</h1>
</div>


<div class="calibre4" id="calibre_link-16">
  <p class="calibre2">dependency injection?</p>

  <p class="calibre2">What should be stable in your system?</p>

  <h2 class="calibre5">What code to extract from a Statement to shared utility method?<br class="calibre26" /></h2>

  <h2 id="calibre_link-55" class="calibre5">Why such a strange approach to create enumerated constants?</h2>

  <p class="calibre2">TODO</p>

  <h2 id="calibre_link-56" class="calibre5">Expanded TDD process</h2>

  <p class="calibre2">As a little introduction, I’ll show you an expanded version of TDD flow that we’ll be using:</p>

  <ol class="calibre12">
    <li class="calibre13">Examine TODO list and pick an item that makes most sense to implement next</li>

    <li class="calibre13">Write unfulfilled Statement</li>

    <li class="calibre13">Make it unfulfilled for the right reason</li>

    <li class="calibre13">Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>

    <li class="calibre13">Cross out the item from TODO list</li>

    <li class="calibre13">Repeat until no item is left on the TODO list</li>
  </ol>

  <p class="calibre2">Some of the steps don’t probably mean anything to yet. Don’t worry, we’ll be reiterating them several times, so don’t try to memorize them now.</p>

  <h2 id="calibre_link-57" class="calibre5">What exactly do we specify?<br class="calibre26" /></h2>

  <p class="calibre2">In this chapter, we’ll look a little bit on what it is that we actually write our specification against - what exactly do we want to describe about a class. We’re gonna jump into a quick example, because I’ve been keeping you away from practice too long now. Note that the example won’t exactly show how the real-world TDD looks like, but it will be enough to draw some conclusions and get a feel of Statement-First style of programming.</p>

  <h2 id="calibre_link-58" class="calibre5">quick example (list? calculator?)</h2>

  <p class="calibre2">TODO - todo list</p>
</div>


<div class="calibre" id="calibre_link-3">
  <p class="calibre2">&nbsp;1. combinatorial explosion</p>

  <p class="calibre2">2. too many classes specified at once</p>
</div>


<div class="calibre4" id="calibre_link-13">
  <ol class="calibre12">
    <li class="calibre13">Need driven development and the principle of least astonishment (perspective of use)</li>

    <li class="calibre13">Techniques and tools (notepad)</li>

    <li class="calibre13">Basics of xUnit frameworks</li>

    <li class="calibre13">behavior means returning value, changing system and throwing an exception</li>

    <li class="calibre13">Complex Conditions (multiple boolean results: OR and AND</li>

    <li class="calibre13">Sometimes, a behavior depends on multiple conditions being true or false……………….. TODO: 1. use NUNIt TestCase, 2. divide and conquer the problem. youtuTODO: constant refactoringvalues.</li>
  </ol>
</div>


</body></html>