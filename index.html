<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="/home/astral/Google Drive/Shared/Raporty i prezentacje/TDDEBook/manuscript/Stylesheets/Global.css" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#dedications">Dedications</a></li>
<li><a href="#thanks">Thanks!</a></li>
<li><a href="#part-1-justthe-basics"><strong>Part 1: Just the basics</strong></a></li>
<li><a href="#motivation---the-first-step-to-learning-tdd">Motivation - the first step to learning TDD</a><ul>
<li><a href="#how-tdd-feels-like">How TDD feels like</a></li>
</ul></li>
<li><a href="#the-three-most-essential-tools">The three most essential tools</a><ul>
<li><a href="#our-shiny-tools">Our shiny tools</a></li>
</ul></li>
<li><a href="#it-is-not-atest">It is not a test</a><ul>
<li><a href="#when-atest-becomes-something-else">When a test becomes something else</a></li>
<li><a href="#taking-it-to-the-software-development-land">Taking It To The Software Development Land</a></li>
<li><a href="#a-specification-instead-of-atest-suite">A Specification Instead of a Test Suite</a></li>
</ul></li>
<li><a href="#statement-first-programming">Statement-first programming</a><ul>
<li><a href="#what-is-the-point-of-writing-specification-after-the-fact">What is the point of writing specification after the fact?</a></li>
<li><a href="#the-benefit-of-failure">The Benefit of Failure</a></li>
</ul></li>
<li><a href="#practicing-what-we-already-learned">Practicing what we already learned</a><ul>
<li><a href="#let-me-tell-you-astory">Let me tell you a story</a></li>
<li><a href="#act-1-the-car">Act 1: The Car</a></li>
<li><a href="#act-2-the-customer">Act 2: The Customer</a></li>
<li><a href="#act-3-test-driven-development">Act 3: Test-Driven Development</a></li>
<li><a href="#epilogue">Epilogue</a></li>
</ul></li>
<li><a href="#sorting-out-the-bits">Sorting Out The Bits</a></li>
<li><a href="#how-to-start">How to start?</a><ul>
<li><a href="#start-with-agood-name">Start with a good name</a></li>
<li><a href="#start-by-filling-the-given-when-then-structure-with-the-obvious">Start By Filling The GIVEN-WHEN-THEN Structure With The Obvious</a></li>
<li><a href="#start-from-the-end">Start From The End</a></li>
<li><a href="#start-by-invoking-amethod-when-you-have-one">Start By Invoking a Method When You Have One</a></li>
<li><a href="#summary-1">Summary</a></li>
</ul></li>
<li><a href="#how-is-tdd-about-analysis-and-what-does-given-when-then-mean">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</a><ul>
<li><a href="#is-there-really-acommonality-between-analysis-and-tdd">Is there really a commonality between analysis and TDD?</a></li>
<li><a href="#gherkin">Gherkin</a></li>
<li><a href="#todo-list-again">TODO list… again!</a></li>
</ul></li>
<li><a href="#developing-tdd-style-and-constrained-non-determinism">Developing TDD style and Constrained Non-Determinism</a><ul>
<li><a href="#a-style">A style?</a></li>
<li><a href="#principle-tests-as-specification">Principle: Tests As Specification</a></li>
<li><a href="#first-technique-anonymous-input">First technique: Anonymous Input</a></li>
<li><a href="#second-technique-derived-values">Second technique: Derived Values</a></li>
<li><a href="#third-technique-distinct-generated-values">Third technique: Distinct Generated Values</a></li>
<li><a href="#fourth-technique-constant-specification">Fourth technique: Constant Specification</a></li>
<li><a href="#summary-of-the-example">Summary of the example</a></li>
<li><a href="#constrained-non-determinism">Constrained non-determinism</a></li>
<li><a href="#summary-2">Summary</a></li>
</ul></li>
<li><a href="#what-is-the-scope-of-aunit-level-statement-in-tdd">What is the scope of a unit-level Statement in TDD?</a></li>
<li><a href="#specifying-boundaries-and-conditions">Specifying Boundaries and Conditions</a><ul>
<li><a href="#sometimes-anonymous-value-is-not-enough">Sometimes, Anonymous Value Is Not Enough</a></li>
<li><a href="#exceptions-to-the-rule">Exceptions To The Rule</a></li>
<li><a href="#rules-valid-within-boundaries">Rules Valid Within Boundaries</a></li>
<li><a href="#combination-of-boundaries---ranges">Combination of Boundaries - Ranges</a></li>
<li><a href="#summary-3">Summary</a></li>
</ul></li>
<li><a href="#triangulation">Triangulation</a><ul>
<li><a href="#type-the-obvious-implementation">Type The Obvious Implementation</a></li>
<li><a href="#fake-it-til-you-make-it">Fake It (‘Til You Make It)</a></li>
<li><a href="#triangulation-1">Triangulation</a></li>
<li><a href="#summary-4">Summary</a></li>
</ul></li>
<li><a href="#part-2-test-driven-development-in-object-oriented-world"><strong>Part 2: Test-Driven Development in Object Oriented World</strong></a></li>
<li><a href="#on-objects-composability">On Objects Composability</a><ul>
<li><a href="#another-task-for-johnny-and-benjamin">Another task for Johnny and Benjamin</a></li>
<li><a href="#a-quick-retrospective">A Quick Retrospective</a></li>
</ul></li>
<li><a href="#telling-not-asking">Telling, not asking</a><ul>
<li><a href="#contractors">Contractors</a></li>
<li><a href="#a-quick-retrospective-1">A Quick Retrospective</a></li>
</ul></li>
<li><a href="#the-need-for-mock-objects">The need for mock objects</a><ul>
<li><a href="#composability-again">Composability… again!</a></li>
</ul></li>
<li><a href="#why-do-we-need-composability">Why do we need composability?</a><ul>
<li><a href="#pre-object-oriented-approaches">Pre-object oriented approaches</a></li>
<li><a href="#object-oriented-programming-to-the-rescue">Object oriented programming to the rescue!</a></li>
<li><a href="#the-power-of-composition">The power of composition</a></li>
<li><a href="#summary---are-you-still-with-me">Summary - are you still with me?</a></li>
</ul></li>
<li><a href="#web-messages-and-protocols">Web, messages and protocols</a><ul>
<li><a href="#so-again-what-does-it-mean-to-compose-objects">So, again, what does it mean to compose objects?</a></li>
<li><a href="#summary-5">Summary</a></li>
</ul></li>
<li><a href="#composing-a-web-of-objects">Composing a web of objects</a><ul>
<li><a href="#three-important-questions">Three important questions</a></li>
<li><a href="#how-does-sender-obtain-a-reference-to-recipient">How does sender obtain a reference to recipient?</a></li>
<li><a href="#where-are-objects-composed">Where are objects composed?</a></li>
<li><a href="#when-are-objects-composed">When are objects composed?</a></li>
<li><a href="#where-are-objects-composed-1">Where are objects composed?</a></li>
</ul></li>
<li><a href="#worse-and-better-composability">Worse and better composability</a><ul>
<li><a href="#why-did-i-leave-out-inline-creation-and-singletons-context-independence">Why did I leave out inline creation and singletons? context independence!</a></li>
</ul></li>
<li><a href="#license">License</a></li>
</ul>
</div>
<div class="figure">
<img src="./images/title_page.png" />
</div>
<h1 id="dedications"><a href="#dedications">Dedications</a></h1>
<p><em>Ad Deum qui laetificat iuventutem meam.</em></p>
<p><em>To my beloved wife Monika.</em></p>
<h1 id="thanks"><a href="#thanks">Thanks!</a></h1>
<p>I would like to thank the following people (listed alphabetically by name) for valuable feedback, suggestions, typo fixes and other contributions:</p>
<ul>
<li>Donghyun Lee</li>
<li>Daniel Żołopa</li>
<li>Michael Whelan</li>
<li>Reuven Yagel</li>
<li>Sławomir Pająk</li>
<li>Brad Appleton</li>
</ul>
<p>This book is not original at all. It presents various topics that others invented and I just picked up. Thus, I would also like to thank my mentors and authorities on test-driven development and object oriented design that I gained all my knowledge from (listed alphabetically by name):</p>
<ul>
<li>Amir Kolsky</li>
<li>Dan North</li>
<li>Ken Pugh</li>
<li>Kent Beck</li>
<li>Martin Fowler</li>
<li>Mark Seemann</li>
<li>Nat Pryce</li>
<li>Scott Bain</li>
<li>Steve Freeman</li>
<li>Robert C. Martin</li>
</ul>
<h1 id="part-1-justthe-basics"><a href="#part-1-justthe-basics"><strong>Part 1: Just the basics</strong></a></h1>
<p>This is a part where I introduce the basic TDD philosophy and practices (as well as some advanced ones) without going much into object orientation and how to do TDD for systems where multiple objects collaborate together (which is a topic of Part 2).</p>
<p>So, for the most chapters of this part, I will be giving you examples where single object (plus some small ones like strings etc.) is exercised to slowly introduce some concepts in an easy to grasp manner.</p>
<p>After reading part 1, you will be able to quite effectively develop classes that have no dependencies on other classes (and on operating system resources).</p>
<h1 id="motivation---the-first-step-to-learning-tdd"><a href="#motivation---the-first-step-to-learning-tdd">Motivation - the first step to learning TDD</a></h1>
<p>So, you want to learn TDD, huh? First off, let me ask a question ‘why?’.</p>
<p>I want to tell you a story - few years ago, I had an apprentice, who wanted to learn TDD as well. We started working on a small project together for him to grasp the necessary skills through practice, with me sitting next to him, providing guidance. He showed up three, four times, then he resigned, having ‘more urgent things’ and ‘no time’. Since then, he did not progress in TDD at all. Did he really want to learn?</p>
<p>See, sometimes people don’t really want to learn something or don’t want so much as to dedicate the necessary time and resources to this. Sometimes they just think they need to do it for whatever reasons - getting promotion at work, gaining a certificate, add something to CV or just ‘stay up to date’ with recent hypes, one of them being Test-Driven Development.</p>
<p>Others want to learn TDD for reasons they themselves made up. Knowing that TDD is valued and praised by others, they draw conclusions that it has to be good. Why is that so? Err… maybe… “the code will be more tested”? Or… ekhem… “the network of tests will be tighter”? And why do Test-First? Well… hmm… “to ensure tests are written for everything”? While these statements might be partially true, they don’t even touch the essence of the “why” of TDD, and quickly turn into something like: “I don’t really need TDD, because I need tests that give me confidence on broader scope” or: “Why do I need unit tests when I already have integration tests, smoke tests, sanity tests, exploration tests…?”. Then TDD gets abandoned, before actually ever being achieved in the first place.</p>
<p>You need to be highly motivated on this one. If you are not, hey, I heard the new series of Game Of Thrones is on TV, why don’t you check it out instead? Ok, I’m just teasing, however, as some say, TDD is “easy to learn, hard to master” (don’t actually know who said it first, I searched the web and found it in few places where none of the writers gave credit to anyone else for it, so I decided just to mention that I’m not the one that coined this description) , so without some guts to move on, it will be hard.</p>
<h2 id="how-tdd-feels-like"><a href="#how-tdd-feels-like">How TDD feels like</a></h2>
<p>Me and my brother liked to play video games in our childhood - one of the most memorable being Tekken 3 - a Japanese tournament beat’em up for Sony Playstation. To finish the game with all warriors, unlock all hidden characters, mini-games etc. took about a day. Some could say the game had nothing to offer since then. Why then did we spend over a year on it?<br /> <img src="./images/Tekken3-gray.png" alt="Tekken3" /><br /> It is because each fighter in the game had a lot of combos, kicks and punches that could be mixed in a variety of ways. Some were only usable in some situations, others were something you could throw at your opponent almost anytime without a big risk of being exposed to counterattacks. You could side-step to evade enemy’s attacks and, most of all, you could kick another fighter up in the air where they could not block your attacks and you were able to land some nice attacks on them before they fell down. These in-the-air techniques were called “juggles”. There were magazines that published a list of new possible juggles each month and the hype stayed in the gaming community for well over a year.</p>
<p>Yes, Tekken was easy to learn - you could put one hour into training the core moves of a character and then be able to “use them”, but what made you a great fighter was the experience and knowledge on which techniques were risky or not, which ones could be used in which situations, which ones, if used one after another, gave the opponent little chance to counterattack etc. No wonder that soon, many tournaments sprang, where players could clash for glory, fame and rewards. Even today, you can watch some of the matches on youtube.</p>
<p>TDD is like Tekken. You have probably heard the mantra “red-green-refactor” or the general advice “write your test first, then the code”, maybe you even did some experiments on your own where you were trying to implement a bubble-sort algorithm or other simple stuff by starting with a test. But that is all like practicing Tekken by trying out each move on its own on dummy opponent, without the context of real-world issues that make the fight really challenging. And while I think such exercises are (somewhat) useful, you need to understand the bigger picture.</p>
<p>Some people I talk with about TDD sum up what I say to them as: “That is really demotivating - there are so many things I have to watch out for that it makes me never want to start!”. Easy, don’t panic - remember the first time you tried to ride a bike - you must have been really far back then from knowing traffic regulations and following road signs, but that did not really keep you away, did it? I myself found TDD very exciting. Some guys my age already think they know all about coding, are bored with it and cannot wait until they move to management or requirements or business analysis, but hey! I have a new technique that makes my coding career challenging again! And it’s not something I can use only when I pay to Microsoft or Oracle or anybody else - it’s quite portable, making me a better developer overall!</p>
<div class="achievement">
<h3><a href="#student">Student</a></h3>
You have started travelling the way of masters with conviction, determination and pride.
</div>
<h1 id="the-three-most-essential-tools"><a href="#the-three-most-essential-tools">The three most essential tools</a></h1>
<p>Ever watched Karate Kid, either the old version or the new one? The thing they have in common is that when the kid starts learning Karate (or Kung-Fu) from his master, he is given a basic, repetitive task (like taking off a jacket, and putting it on again), not knowing yet where it would lead him. Or look at the first Rocky film (yeah, the one starring Sylvester Stallone), where Rocky was chasing a chicken in order to train agility.</p>
<p>When I first tried to learn how to play guitar, I found two advices on the web: the first was to start by mastering a single, difficult song. The second was to play with a single string, learn how to make it sound in different ways and try to play some melodies by ear just with this one string. Do I have to tell you that the second advice worked better?</p>
<p>Honestly, I could dive right into the core techniques of TDD, but this would be like putting you on a ring with a demanding opponent - you would most probably be discouraged before gaining the necessary skills. So, instead of explaining how to win a race, in this chapter we will take a look at what shiny cars we will be driving.</p>
<p>In other words, I will give you a brief tour of the three most essential tools we will be using throughout this book.</p>
<h2 id="our-shiny-tools"><a href="#our-shiny-tools">Our shiny tools</a></h2>
<div class="disclaimer">
A disclaimer - in this chapter, I will oversimplify some things just to get you up and running without getting into the philosophy of TDD yet (think: physics lessons in primary school). Do not worry about it :-), we will fix that in the coming chapters!
</div>
<h3 id="xunit-framework"><a href="#xunit-framework">xUnit framework</a></h3>
<p>The first and most essential tool we are going to use is an xUnit framework.</p>
<p>Let us assume that our application looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args) 
{
  <span class="kw">try</span>
  {
    <span class="dt">int</span> firstNumber = Int32.<span class="fu">Parse</span>(args[<span class="dv">0</span>]);
    <span class="dt">int</span> secondNumber = Int32.<span class="fu">Parse</span>(args[<span class="dv">1</span>]);

    var result = 
      <span class="kw">new</span> <span class="fu">Multiplication</span>(firstNumber, secondNumber).<span class="fu">Perform</span>();

    Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Result is: &quot;</span> + result);
  }
  <span class="kw">catch</span>(Exception e)
  {
    Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Addition failed because of: &quot;</span> + e);
  } 
}</code></pre>
<p>Now, let us assume we want to check whether it produces correct results. The most obvious way would be to invoke the application from command line with some exemplary arguments, check the output to the console and compare it with what we expect to see. Such session could look like this:</p>
<pre><code>C:\MultiplicationApp\MultiplicationApp.exe 3 7
21
C:\MultiplicationApp\</code></pre>
<p>As you can see, the application produced a result of 21 for multiplication of 7 by 3. This is correct, so we assume the test is passed. But what if we produced an application that additionally does addition, subtraction, division, calculus etc.? How many times would we have to invoke the application to make sure every operation works correct?</p>
<p>But wait, we are programmers, right? So we can write programs that can do this for us! In order to do this, we will create a second application that will also use the Multiplication class, but in a little different way:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args) 
{
  <span class="dt">var</span> multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="dt">var</span> result = multiplication.<span class="fu">Perform</span>();
  
  <span class="kw">if</span>(result != <span class="dv">21</span>)
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(<span class="st">&quot;Failed! Expected: 21 but was: &quot;</span> + result);
  }
}</code></pre>
<p>Sounds easy, right? Let us take another step and extract the result check into something more reusable - after all, we will be adding division in a second, remember? So here goes:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args) 
{
  <span class="dt">var</span> multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="dt">var</span> result = multiplication.<span class="fu">Perform</span>();
  
  <span class="fu">AssertTwoIntegersAreEqual</span>(expected: <span class="dv">21</span>, actual: result);
}

<span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">AssertTwoIntegersAreEqual</span>(
  <span class="dt">int</span> expected, <span class="dt">int</span> actual)
{
  <span class="kw">if</span>(actual != expected)
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(
      <span class="st">&quot;Failed! Expected: &quot;</span> + expected + <span class="st">&quot; but was: &quot;</span> + actual);
  }
}</code></pre>
<p>Note that I started the name of the method with “Assert” - we will get back to the naming soon, for now just assume that this is just a good name for the method. Let us take one last round and put the test into its own method:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args) 
{
  <span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>();
}

<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>()
{
  <span class="co">//Assuming...</span>
  <span class="dt">var</span> multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="co">//when this happens:</span>
  <span class="dt">var</span> result = multiplication.<span class="fu">Perform</span>();
  
  <span class="co">//then the result should be...</span>
  <span class="fu">AssertTwoIntegersAreEqual</span>(expected: <span class="dv">21</span>, actual: result);
}

<span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">AssertTwoIntegersAreEqual</span>(
  <span class="dt">int</span> expected, <span class="dt">int</span> actual)
{
  <span class="kw">if</span>(actual != expected)
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>(
      <span class="st">&quot;Failed! Expected: &quot;</span> + expected + <span class="st">&quot; but was: &quot;</span> + actual);
  }
}</code></pre>
<p>And we are finished. Now if we need another test, e.g. for division, we can just add a new method call to the <code>Main()</code> method and implement it. When implementing it, we can reuse the <code>AssertTwoIntegersAreEqual()</code> method, since the check for division would be analogous.</p>
<p>As you can see, we can easily write automated checks like this, but this way has some disadvantages:</p>
<ol style="list-style-type: decimal">
<li>Every time we add new test, we have to maintain the <code>Main()</code> method, adding a call to the new test. If you forget to add such a call, the test will never be run. At first it isn’t a big deal, but as soon as we have dozens of tests, it will get really hard to notice.</li>
<li>Imagine your system consists of more than one application - you would have some problems trying to gather summary results for all of the applications that your system consists of.</li>
<li>A need will very quickly arise to write a lot of other checks like the existing <code>AssertTwoIntegersAreEqual()</code> - this one compares two integers for equality, but what if you wanted to checka different condition, e.g. that one integer is greater than another? What if you wanted to check equality not for integers, but for characters, strings, floats etc.? What if you wanted to check some conditions on collections, e.g. that a collection is sorted or that all items in the collection are unique?</li>
<li>Given that a test fails, it would be hard to navigate from the commandline output to the line in your IDE. Would it not be easier if you could click on the call stack to take you immediately to the code where the failure took place?</li>
</ol>
<p>For these and other reasons, automated testing tools were born. Those testing tools are generally referenced to as <strong>xUnit family</strong>, because many of them have names that end with the word “Unit”, e.g. CppUnit (for C++), JUnit (for Java), NUnit (for .NET) etc.</p>
<p>To be honest, I cannot wait to show you how the test we wrote just a minute ago looks like when xUnit framework is used, however, before I do this, I would like to recap quickly what we have in our brute-force naive approach to writing automated tests:</p>
<ol style="list-style-type: decimal">
<li>The <code>Main()</code> method serves as a <strong>Test List</strong></li>
<li>The <code>Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()</code> method is a <strong>Test Method</strong></li>
<li>The <code>AssertTwoIntegersAreEqual()</code> method is <strong>an Assertion</strong></li>
</ol>
<p>Quite to our joy, those three elements are present in xUnit frameworks as well. To illustrate it, here is (finally!) the same test we wrote, but with an xUnit framework (this one is called XUnit.Net):</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>()
{
  <span class="co">//Assuming...</span>
  <span class="dt">var</span> multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="co">//when this happens:</span>
  <span class="dt">var</span> result = multiplication.<span class="fu">Perform</span>();
  
  <span class="co">//then the result should be...</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">21</span>, result);
}</code></pre>
<p>As you can see, it looks like two methods that we previously had are gone now and the test is the only thing that is left. Well, to tell you the truth, they are not gone - it is just that the framework handles these for us. Let us reiterate through the three elements of the previous version of the test that I promised would be there after the transition to xUnit framework:</p>
<ol style="list-style-type: decimal">
<li><strong>Test List</strong> is now created automatically by the framework from all methods marked with a [Fact] attribute, so no need to maintain one or more central lists. Thus, the <code>Main()</code> method is gone.</li>
<li>The <strong>Test Method is here and looks almost the same as the last time.</strong></li>
<li>The <strong>Assertion</strong> took the form of a call to static <code>Assert.Equal()</code> method - the xUnit.NET framework is bundled with a wide range of pre-made assertions for your convenience. Of course, no one stops you from writing your own custom one if you do not find what you are looking for in a default set.</li>
</ol>
<p>Phew, I hope I made the transition quite painless for you. Now the last thing to add - as there is not <code>Main()</code> method anymore in the last example, you surely must wonder how we run those tests, right? Ok, the last big secret unveiled - we use an external application for this (we will refer to it using a term <strong>Test Runner</strong>) - we tell it which assemblies to run and it loads them, runs them, reports results etc. It can take various forms, e.g. it can be a console application, a GUI application or a plugin to our IDEs. Here is an example of a stand-alone runner for xUnit.NET framework:</p>
<div class="figure">
<img src="./images/XUnit_NET_Window.png" alt="XUnit.NET window" /><p class="caption">XUnit.NET window</p>
</div>
<div class="achievement">
<h3><a href="#sprinter">Sprinter</a></h3>
You sure know how to run your tests. Automatically!
</div>
<h3 id="mocking-framework"><a href="#mocking-framework">Mocking framework</a></h3>
<p>Mocking frameworks are libraries that automate runtime creation of objects (called “mocks”) that adhere to specified interface. Aside from the creation itself, the frameworks provide an API to configure our mocks on how they behave when certain methods are called on them and to let us inspect which calls they received.</p>
<p>Mocking frameworks are not as old as xUnit frameworks and were not present in TDD at very beginning. As you might be wondering why on earth do we need something like this, I will let you in on a secret: they were born with a goal of aiding a specific approach to object oriented design in mind. This kind of design is what TDD can support quite well as you will soon experience.</p>
<p>For now, however, let us try to keep things easy. I will defer explaining the actual rationale for mocking frameworks until later and instead give you a quick example where you can see them in action. Ready? Let us go!</p>
<p>Let us pretend that we have the following code for adding new set of orders for products to a database and handling exceptions (by writing a message to a log) when it fails:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> OrderProcessing
{
  <span class="co">//other code...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Place</span>(Order order)
  {
    <span class="kw">try</span>
    {
      <span class="kw">this</span>.<span class="fu">orderDatabase</span>.<span class="fu">Insert</span>(order);
    }
    <span class="kw">catch</span>(Exception e)
    {
      <span class="kw">this</span>.<span class="fu">log</span>.<span class="fu">Write</span>(<span class="st">&quot;Could not insert an order. Reason: &quot;</span> + e);
    }
  }

  <span class="co">//other code...</span>
}</code></pre>
<p>Now, imagine we need to test it - how do we do it? I can already see you shaking your head and saying: “Let us just create this database, invoke this method and see if the record is added properly”. In such case, the first test would look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> orderDatabase = <span class="kw">new</span> <span class="fu">MySqlOrderDatabase</span>();
  orderDatabase.<span class="fu">Connect</span>();
  orderDatabase.<span class="fu">Clean</span>();
  <span class="dt">var</span> orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  <span class="dt">var</span> order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  <span class="dt">var</span> allOrders = orderDatabase.<span class="fu">SelectAllOrders</span>();
  Assert.<span class="fu">Contains</span>(order, allOrders);
}</code></pre>
<p>As you see, at the beginning of the test, we are opening a connection and cleaning all existing orders (more on that shortly!), then creating an order object, inserting it into a database and then querying the database to give us all of the held instances. At the end, we make an assertion that the order we tried to insert must be inside all orders in a database.</p>
<p>Why do we clean up the database? Remember a database is a persistent storage, so if we did not clean it up and run this test again, the database may have already contained the item (maybe another test already added it?) and would probably not allow us to add the same item again. Thus, the test would fail. Ouch! It hurts so bad, because we wanted our tests to prove something works, but looks like it can fail even when the logic is coded correctly. What use is such a test if it cannot reliably provide the information we demand from it (whether the implemented logic is correct or not)? Thus, we clean up before each run to make sure the state of the persistent storage is the same every time we run this test.</p>
<p>So, got what you want? Well, I did not. Personally, I would not go this way. There are several reasons:</p>
<ol style="list-style-type: decimal">
<li>The test is going to be slow. It is not uncommon to have more than thousand tests in a suite and I do not want to wait half an hour for results every time I run them. Do you?</li>
<li>Everyone running this test will have to set up a local database on their machine. What if their setup is slightly different than yours? What if the schema gets outdated - will everyone manage to notice it and update schema of their local databases accordingly? Will you re-run your database creation script only to ensure you have got the latest schema available to run your tests against?</li>
<li>There may not be an implementation of the database engine for the operating system running on your development machine if your target is an exotic or mobile platform.</li>
<li>Note that this test you wrote is only one out of two. You will have to write another one for the scenario where inserting an order ends with exception. How do you setup your database in a state where it throws an exception? It is possible, but requires significant effort (e.g. deleting a table and recreating it after the test for other tests that might need the table to run correctly), which may lead you to a conclusion that it is not worth to write such tests at all.</li>
</ol>
<p>Now, let us try something else. Let us assume that our database works OK (or will be tested by black-box tests) and the only thing we want to test is our implementation. In this situation, we can create fake object, which is an instance of another custom class that implements the same interface as MySqlOrderDatabase, but does not write to a database at all - it only stores the inserted records in a list:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> FakeOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> Order _receivedArgument;

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    _receivedArgument = order;
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> List&lt;Order&gt;() { _receivedOrder; };
  }
}</code></pre>
<p>Now, we can substitute the real implementation of order database with the fake instance:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> orderDatabase = <span class="kw">new</span> <span class="fu">FakeOrderDatabase</span>();
  <span class="dt">var</span> orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  <span class="dt">var</span> order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  <span class="dt">var</span> allOrders = orderDatabase.<span class="fu">SelectAllOrders</span>();
  Assert.<span class="fu">Contains</span>(order, allOrders);
}</code></pre>
<p>Note that we do not clean the fake database object, since we create it as fresh each time the test is run. Also, the test is going to be much quicker now. But, that is not the end! We can easily write a test for an exception situation. How do we do it? Just make another fake object implemented like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ExplodingOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>();
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
  }
}</code></pre>
<p>Ok, so far so good, but the bad is that now we have got two classes of fake objects to maintain (and chances are we will need even more). Any method or argument added will need to be propagated to all these objects. We can spare some coding by making our mocks a little more generic so their behavior can be configured using lambda expressions:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ConfigurableOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> Action&lt;Order&gt; doWhenInsertCalled;
  <span class="kw">public</span> Func&lt;List&lt;Order&gt;&gt; doWhenSelectAllOrdersCalled;

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    <span class="fu">doWhenInsertCalled</span>(order);
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
    <span class="kw">return</span> <span class="fu">doWhenSelectAllOrdersCalled</span>();
  }
}</code></pre>
<p>Now, we do not have to create additional classes for new scenarios, but our syntax gets awkward. See for yourself how we configure the fake order database to remember and yield the inserted order:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">ConfigurableOrderDatabase</span>();
Order gotOrder = <span class="kw">null</span>;
db.<span class="fu">doWhenInsertCalled</span> = o =&gt; {gotOrder = o;};
db.<span class="fu">doWhenSelectAllOrdersCalled</span> = () =&gt; <span class="kw">new</span> List&lt;Order&gt;() { gotOrder };</code></pre>
<p>And if we want it to throw an exception when anything is inserted:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">var</span> db = <span class="kw">new</span> <span class="fu">ConfigurableOrderDatabase</span>();
db.<span class="fu">doWhenInsertCalled</span> = o =&gt; {<span class="kw">throw</span> <span class="kw">new</span> <span class="fu">Exception</span>();};</code></pre>
<p>Thankfully, some smart programmers created frameworks that provide further automation in such scenarios. One of them is called <strong>NSubstitute</strong> and provides an API in a form of extension methods (that is why it might seem a bit magical at first. Do not worry, you will get used to it).</p>
<p>Using NSubstitute, out first test can be rewritten as such:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> orderDatabase = <span class="kw">new</span> Substitute.<span class="fu">For</span>&lt;OrderDatabase&gt;();
  <span class="dt">var</span> orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  <span class="dt">var</span> order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  orderDatabase.<span class="fu">Received</span>(<span class="dv">1</span>).<span class="fu">Insert</span>(order);
}</code></pre>
<p>Note that we do not need the <code>SelectAllOrders()</code> method. If no one except this test needs it, we can delete it and spare some more maintainability trouble. The last line of this test is actually a camouflaged assertion that checks whether Insert method was called once with order object as parameter.</p>
<p>I will get back to mocks, since, as I said, there is a huge philosophy behind them and we have only scratched the surface here.</p>
<div class="achievement">
<h3><a href="#pretender">Pretender</a></h3>
You have managed to use a mock instead of a real object in unit test!
</div>
<h3 id="anonymous-values-generator"><a href="#anonymous-values-generator">Anonymous values generator</a></h3>
<p>Look at the test in the previous section. Does it not trouble you that we fill the order object with so many values that are totally irrelevant to the test logic itself? They actually hinder readability of the test. Also, they make us believe that the tested object really cares what these values are, although it does not (the database does, but we already got rid of it from the test). Let us move it to a method with descriptive name:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> orderDatabase = <span class="kw">new</span> Substitute.<span class="fu">For</span>&lt;OrderDatabase&gt;();
  <span class="dt">var</span> orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  <span class="dt">var</span> order = <span class="fu">AnonymousOrder</span>();

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  orderDatabase.<span class="fu">Received</span>(<span class="dv">1</span>).<span class="fu">Insert</span>(order);
}

<span class="kw">public</span> Order <span class="fu">AnonymousOrder</span>()
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);
}</code></pre>
<p>Now that is better. Not only did we make the test shorter, we also provided a hint to the test reader that the actual values used to create an order do not matter from the perspective of tested order processing logic, hence the name <code>AnonymousOrder()</code>.</p>
<p>By the way, would it not be nice if we did not have to provide the anonymous objects ourselves, but rely on another library to generate them for us? Susprise, surprise, there is one! It is called <strong>Autofixture</strong>. It is an example of an anonymous values generator (although its creator likes to say that it is an implementation of Test Data Builder pattern, but let us skip this discussion here). After refactoring our test to use AutoFixture, we arrive at the following:</p>
<pre><code>[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = any.Create&lt;Order&gt;();

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}

private Fixture any = new Fixture();</code></pre>
<p>Nice, huh? AutoFixture has a lot of advanced features, but personally I am conservative and wrap it behind a static class called <code>Any</code>:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> Any
{
  <span class="kw">private</span> <span class="kw">static</span> any = <span class="kw">new</span> <span class="fu">Fixture</span>();
  
  <span class="kw">public</span> <span class="kw">static</span> T ValueOf&lt;T&gt;()
  {
    <span class="kw">return</span> any.<span class="fu">Create</span>&lt;T&gt;();
  }
}</code></pre>
<p>In the next chapters, you will see me using a lot of different methods from the <code>Any</code> type. The more you use this class, the more it grows with other methods for creating customized objects. For now, however, let us stop here.</p>
<div class="achievement">
<h3><a href="#anonymous">Anonymous</a></h3>
<p>The values you use in your unit tests move like a shadow, unnoticed by anyone and until it is really necessary.</p>
</div>
<h3 id="summary"><a href="#summary">Summary</a></h3>
<p>In this chapter, I tried to show you the three essential tools which we will be using in this book and which, when mastered, will make your test-driven development smoother. If this chapter leaves you with insufficient justification for their use, do not worry - we will dive into the philosophy behind them in the coming chapters. For now, I just want you to get familiar with the tools themselves and their syntax. Go on, download these tools, launch them, try to write something simple with them. You do not need to understand their full purpose yet, just go out and play :-).</p>
<div class="achievement">
<h3><a href="#equipped">Equipped</a></h3>
<p>You are now able to understand most of the code examples throughout this book!</p>
</div>
<h1 id="it-is-not-atest"><a href="#it-is-not-atest">It is not a test</a></h1>
<p>Up to now, I was cheating on you. I told you that the little executable snippets of code are ‘tests’ and that they’re here to ‘check’ or ‘verify’ something. Now it is time to reveal the truth.</p>
<h2 id="when-atest-becomes-something-else"><a href="#when-atest-becomes-something-else">When a test becomes something else</a></h2>
<p>I studied in Łódź, a large city in the center of Poland. As probably all other students in all other countries, we have had lectures, exercises and exams. The exams were pretty hard, especially considered that my computer science group was on the faculty of electronic and electric engineering, so we had to grasp a lot of classes that did not have anything to do with programming, for instance electrotechnics, solid-state physics or electronic and electrical metrology.</p>
<p>Knowing that the exams were difficult and that it was hard to learn everything during preparation, the lecturers would give us exemplary exams from previous years. The questions were different than during actual exams, but the structure and types of questions asked (practice vs. theory etc.) was similar. We would usually get these exemplary questions before we started learning really hard (which was usually at the end of semester). Guess what happened then? As you might suspect, we did not use the tests we received just to ‘verify’ or ‘check’ our knowledge after we finished learning. Those tests were actually the first thing we went to before even starting to learn. Why was that so? What use were the tests when we knew we would not know most of the answers?</p>
<p>I guess my lecturers would disagree with me, but I find it quite amusing that what we were really doing back then was ‘Lean’. Lean is an approach where, among others, there is a rigorous emphasis on eliminating waste. Every feature or product that is produced while not being needed by anyone is considered waste. That is because if something is not needed, there is no reason to assume it will ever be needed. In such case the entire feature or product is a waste - it has no value. Even if it WILL be ever needed, it will require some rework anyway to fit the real customer needs. In this case, the initial amount of work that went into the parts of solution that had to be replaced by another parts anyway is a waste - it never brought any money (I am not talking about such things as customer demos, but finished, polished features or products).</p>
<p>So, in order to eliminate waste, there is huge pressure nowadays to “pull features from demand” instead of “pushing them” into the product. In other words, every feature is there to satisfy concrete need. If not, the effort is considered wasted and the money drown.</p>
<p>Going back to the exams, why the approach of first looking through the exemplary tests can be considered ‘lean’? That is because, when we treat passing an exam as our goal, then everything that does not put us closer to this goal is considered a waste. Let us suppose the exam is theory only - why then practice the exercises? It would probably pay off a lot more to study theoretical side of the topics. Such knowledge could be obtained from those exemplary tests. So, the tests were a kind of specification of what was needed to pass the exam, letting us pull the value (i.e. our knowledge) from demand (information obtained from a realistic tests) rather that pushing it from implementation (i.e. learning everything in a course book chapter after chapter).</p>
<p>So the tests became something else. They proved very valuable before the ‘implementation’ (i.e. learning for the exam) because:</p>
<ol style="list-style-type: decimal">
<li>they helped us focus on what was needed to reach our goal</li>
<li>they brought our attention away from what was <strong>not</strong> needed to reach our goal</li>
</ol>
<p>That was the value of a test before learning. Note that the tests we would usually receive were not exactly what we would encounter at the time of exam, so we still had to guess. Still, the role of a <strong>test as specification of a need</strong> was already visible.</p>
<h2 id="taking-it-to-the-software-development-land"><a href="#taking-it-to-the-software-development-land">Taking It To The Software Development Land</a></h2>
<p>I chose this lengthy metaphor to show you that ‘test’ is really another way of specifying a requirement or a need and that it is not something that is counter-intuitive - it occurs in our everyday lives. This is also true in software development. Let us take the following ‘test’ and see what kind of needs it specifies:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">var</span> reporting = <span class="kw">new</span> <span class="fu">ReportingFeature</span>();
<span class="dt">var</span> anyPowerUser = Any.<span class="fu">Of</span>(Users.<span class="fu">Admin</span>, Users.<span class="fu">Auditor</span>);
Assert.<span class="fu">True</span>(reporting.<span class="fu">CanBePerformedBy</span>(anyPowerUser));</code></pre>
<p>(In this example, we used <code>Any.Of()</code> method that returns any enumeration value from the specified list. Here, we say “give me a value that is either <code>Users.Admin</code> or <code>Users.Auditor</code>“.)</p>
<p>Let us look at those (only!) three lines of code, imagining that the production code that makes this ‘test’ pass does not exist yet. What can we learn from these three lines about what the code needs to supply? Count with me:</p>
<ol style="list-style-type: decimal">
<li>We need a reporting feature</li>
<li>We need to support a notion of users and privileges</li>
<li>We need to support a domain concept of power user, who is either an administrator or an auditor</li>
<li>Power users will need to be privileged to use the reporting feature (note that it does not specify which other users should or should not be able to use this feature - we would need a separate ‘test’ for that).</li>
</ol>
<p>Also, are already after the phase of designing an API that will fulfill the need. Don’t you think it is pretty much information about the application from just three lines of code?</p>
<div class="achievement">
<h3><a href="#lean-mean">Lean &amp; Mean</a></h3>
<p>You now see some connotations between Test-Driven Development and Lean movement. There are more if you are interested, so be sure to pick up a good read about lean software development!</p>
</div>
<h2 id="a-specification-instead-of-atest-suite"><a href="#a-specification-instead-of-atest-suite">A Specification Instead of a Test Suite</a></h2>
<p>I hope that you can see now that what we called ‘a test’ is really a kind of specification. The discovery is very recent, so there isn’t a clear terminology on it yet. Some like to call the process of using tests as specifications: Specification By Example, to say that the tests are really examples that help specify and clarify the behavior of developed part of functionality. The terminology is still not rock-solid, so you might encounter different naming for different things. For example, a ‘test’ is often referred to as ‘spec’, or an ‘example’, or a ‘behavior description’, or a ‘specification statement’ or a ‘fact about the developed system’ (the xUnit.NET framework marks each ‘test’ with a <code>[Fact]</code> attribute, suggesting that by writing it, we are stating a single fact about developed code. By the way, xUnit.NET also allows us to state ‘theories’ about our code, but let us leave it for now).</p>
<p>The time has come to make a deal: I will establish some naming conventions for this book to be consistent, but leave you with the freedom to follow your own if you so desire. The terminology shift is for pedagogical reasons - I am not trying to create a movement to change established terms or to invent a new methodology or anything - my hope is that using this terminology throughout the book will let you look differently at some things. So, let us agree that for the sake of this book:</p>
<p><strong>Specification Statement</strong> (or simply <strong>Statement</strong>, starting with capital letter) : will be used instead of ‘test’ or ‘test method’ <strong>Specification</strong> (or simply <strong>Spec</strong>), also starting with capital letter : will be used instead of ‘test suite’ or ‘test list’ <strong>False Statement</strong> : will be used instead of ‘failing test’ <strong>True Statement</strong> : will be used instead of ‘passing test’</p>
<p>From time to time, I will refer back to the ‘traditional’ terminology, because it is better established and you’ve probably heard some terms already and may wonder how it should be understood in context of thinking of tests as specification.</p>
<p>From your experience, you may know paper or word specifications, written in plain English or other spoken language. Our specification is different than these specifications in at least few ways:</p>
<ol style="list-style-type: decimal">
<li>it is not written fully up-front (more on this in the next chapters).</li>
<li>it is executable - you can run it to see whether the code adheres to the specification or not.</li>
<li>it is written in source code rather than in spoken language - which is both good (less room for misunderstanding - source code is the most formal and structured way of writing specifications) and bad (great care must be taken to keep the specification readable).</li>
</ol>
<div class="achievement">
<h3><a href="#enlightened">Enlightened</a></h3>
You are starting to see Test-Driven Development in a new light - not as a testing technique, but as a mean to specify the behaviors of the code under development.
</div>
<h1 id="statement-first-programming"><a href="#statement-first-programming">Statement-first programming</a></h1>
<h2 id="what-is-the-point-of-writing-specification-after-the-fact"><a href="#what-is-the-point-of-writing-specification-after-the-fact">What is the point of writing specification after the fact?</a></h2>
<p>In the last chapter, I said that in TDD a ‘test’ takes another role - one of a statement being a part of a specification. If we put things this way, then the whole controversial concept of “writing a test before the code” does not pose a problem at all. Quite the contrary - it only seems natural to specify what we are going to write before we attempt to write it. Does the other way round even make sense? A specification written after completing the implementation is nothing more than an attempt at documenting the existing solution. Sure, such attempts can provide some value when done as a kind of reverse-engineering (i.e. writing specification for something that was implemented long ago and we do not really know the exact business rules or policies, which we discover as we document the existing solution) - it has an excitement of discovery in it, but doing it just after we, ourselves, made all the decisions seems like a waste of time, not to mention that it is dead boring (Do not believe me? Try implementing a simple calculator app and the write specification for it just after it is implemented and working). Anyway, specifying how something should work after the fact can hardly be considered creative.</p>
<p>Oh, and did I tell you that without a specification of any kind we do not really know whether we are done implementing our changes or not (because in order to know it, we need to compare the implemented functionality to ‘something’, even if this ‘something’ is only in the customer’s head).</p>
<p>Another thing I mentioned in the previous chapter was that one of the differences between a textual specification and our Specification consisting of executable Statements is that, although the code follows the Specification, we do not write our Specification fully up-front. The usual sequence is to specify a bit first and then code a bit, then repeat one Statement at a time. When doing TDD, we are traversing repeatedly through few phases that make up a cycle. We like these cycles to be short, so that we can get a quick feedback. Being able to get this quick feedback is essential, because it allows us to move forward with confidence that what we already have works as we intended. Also, it allows us to use the knowledge we gained in the previous cycle to make the next cycle more efficient (if you do not believe me that quick feedback is good, ask yourself a question: “how many times a day do I compile the code I work on?”).</p>
<p>Reading so much about cycles, it is probably no surprise to you that the traditional illustration of the TDD process is modeled visually as a circle-like flow:</p>
<div class="figure">
<img src="./images/RedGreenRefactor.png" alt="Basic TDD cycle" /><p class="caption">Basic TDD cycle</p>
</div>
<p>Note that the above form uses the traditional terminology of TDD, so before I explain the steps, I will translate it to use our terms of Specification and Statements:</p>
<div class="figure">
<img src="./images/RedGreenRefactor2.png" alt="Basic TDD cycle with changed terminology" /><p class="caption">Basic TDD cycle with changed terminology</p>
</div>
<p>The second version seems more like common sense than the first one - specifying how something should behave before putting that behavior in place is way more intuitive than testing something that does not exist.</p>
<p>Anyway, these three steps demand some explanation. In the coming chapters, I will give you some examples of how this process works in practice and introduce an expanded version, but in the meantime, its sufficient to say that:</p>
<dl>
<dt>Write a Statement you wish was true but is not</dt>
<dd>means that the Statement evaluates to false (it shows on the test list as failing - in most xUnit frameworks, it will be marked with red color)
</dd>
<dt>Add code to make it true</dt>
<dd>means that we write just enough code to make the Statement true (in most xUnit frameworks, the true Statement will be marked with green color). Later in the course of the book, you will see how small can be “just enough”
</dd>
<dt>Refactor</dt>
<dd>is a step that I have silently discarded so far (and will do so for at least few next chapters. Do not worry, we will get back to it eventually). Basically, it boils down to using the safety net of executable specification we already have in place to safely enhance the quality of the covered code while all mistakes we make in the process are quickly discovered by the running Specification.
</dd>
</dl>
<p>By the way, this process is sometimes referred to as “Red-Green-Refactor”. I am just mentioning it here for the record - I am not planning to use this term further in the book.</p>
<h2 id="the-benefit-of-failure"><a href="#the-benefit-of-failure">The Benefit of Failure</a></h2>
<p>When I showed you a drawing with a TDD process, I specifically said that you are supposed to write a Statement that you wish was true <strong>but is not</strong>. It means that when you write a Statement, you have to evaluate it (i.e. run it) and watch it fail its assertions before providing implementation that makes this Statement true. Why is that so important? Is it not just enough to write the Statement first? Why run it and watch it fail?</p>
<p>There are multiple reasons and I will try to outline few of them briefly.</p>
<h3 id="you-do-not-know-whether-the-statement-can-ever-be-false-until-you"><a href="#you-do-not-know-whether-the-statement-can-ever-be-false-until-you">You do not know whether the Statement can ever be false until you</a></h3>
<p>see it evaluate as false</p>
<p>Every accurate Statement (do I have to tell you that such Statements are what we are interested in?) fails when it isn’t fulfilled and passes when it is. That is one of the main reasons we write it - to receive this feedback. Also, after being fulfilled, the Statement becomes a part of the executable specification and starts failing as soon as the code stops fulfilling it (e.g. as a result of mistake made during code rework). When your run a Statement after it is implemented and it is evaluated as true, how do you know whether it really describes a need accurately? You did not ever watch it fail, so how do you know it ever will?</p>
<p>The first time I encountered this argument (it was before I started thinking of unit tests as executable specification), it quickly raised my self-defense mechanism: “seriously?” - I thought - “I am a wise person, I know what I am writing. If I make my unit tests small enough, it is self-evident that I am describing the correct behavior. This is paranoid”. However, life quickly verified my claims and I was forced to withdraw my arguments. Let me describe, from my experience, three ways (there are more, I just forgot the rest :-D) one can really put in a Statement that is always evaluated as true, regardless of the code being correct or not (i.e. a Statement that cheats you into thinking it is fulfilled even when it is not):</p>
<h4 id="accidental-omission-of-adding-astatement-to-specification"><a href="#accidental-omission-of-adding-astatement-to-specification">1. Accidental omission of adding a Statement to Specification</a></h4>
<p>However funny this may sound, it happened to me few times. The example I am going to give is from C#, but almost every xUnit framework in almost every language has some kind of mechanism of marking methods as Statements, whether by attributes (C#, e.g. xUnit.Net’s <code>Fact</code> attribute) or annotations (Java) or with macros (C and C++) or by inheriting from common class, or just a naming convention.</p>
<p>Let us take xUnit.Net as an example. As I stated previously, In xUnit.Net, to turn a method into a Statement, you mark it with <code>[Fact]</code> attribute the following way:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{
  [Fact]
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldDisplayAdditionResultAsSumOfArguments</span>() 
  {
    <span class="co">//... </span>
  }
}</code></pre>
<p>Now, imagine that you are writing this Statement post-factum as a unit test in an environment that has, let us say, more than thirty Statements - you have written the code, now you are just creating a test after test “to ensure” (as you see, this is not my favorite reason for writing unit tests) the code works. Code, test - pass, test - pass, test - pass. You almost always evaluate your code against the whole Specification, since it is usually easier than selecting what to evaluate each time, plus, you get more confidence this way that you did not break by mistake something that is already working. So, this is really: Code, Test - all pass, test - all pass, test - all pass… Hopefully, you use some kind of snippets mechanism for creating new Statements, but if not (and many do not actually do this), once in a while, you do something like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{
  <span class="co">//... some Statements here</span>

  <span class="co">//oops... forgot to copy-paste the attribute!</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldDisplayZeroWhenResetIsPerformed</span>()
  {
    <span class="co">//... </span>
  }
}</code></pre>
<p>And you do not even notice that this will not be evaluated with the rest of the Specification, because it already consists of so many Statements that it is almost irrational to search for your added Statement in the list and make sure it is there each time. Also, note that the fact that you omitted the addition, does not disturb your work flow: test - all pass, test - all pass, test - all pass… In other words, your process does not give you any feedback on your mistake. So, what you end up is a Statement that not only will never be false - <strong>it will never be evaluated</strong>.</p>
<p>How does treating tests as Statements and evaluating them before making them true help here? <strong>Because then, a Statement that starts off being evaluated as true is what DOES disturb your work flow.</strong> In TDD, the work flow is: Statement - unfulfilled - fulfilled (ok, and refactor, but for the sake of THIS discussion, it does not matter so much), Statement - unfulfilled - fulfilled, Statement - unfulfilled - fulfilled… So every time you fail to see the “unfulfilled” stage, you get feedback from your process that something suspicious is happening. This lets you investigate and, if necessary, fix the situation at hand.</p>
<h4 id="misplacing-mock-setup"><a href="#misplacing-mock-setup">2. Misplacing mock setup</a></h4>
<p>Ok, this may sound even funnier (well, honestly, most mistakes sound funny), but it also happened to me a couple of times, so it makes sense to mention it. The example I am going to show uses manual mocks, but this can happen with dynamic mocks as well, especially if you are in a hurry.</p>
<p>Let us take a look at the following Statement saying that setting a value higher than allowed to a field of a frame should produce error result:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldRecognizeTimeSlotAboveMaximumAllowedAsInvalid</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> frame = <span class="kw">new</span> <span class="fu">FrameMock</span>(); <span class="co">//manual mock</span>
  <span class="dt">var</span> validation = <span class="kw">new</span> <span class="fu">Validation</span>();
  <span class="dt">var</span> timeSlotAboveMaximumAllowed = TimeSlot.<span class="fu">MaxAllowed</span> + <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = validation.<span class="fu">PerformForTimeSlotIn</span>(frame);
  frame.<span class="fu">GetTimeSlot_Returns</span> 
    = timeSlotAboveMaximumAllowed;

  <span class="co">//THEN</span>
  Assert.<span class="fu">False</span>(result.<span class="fu">Passed</span>);
  Assert.<span class="fu">Equal</span>(
    ValidationFailureReasons.<span class="fu">AboveAcceptableLimit</span>, 
    result.<span class="fu">Reason</span>);
}</code></pre>
<p>Note how the method <code>PerformForTimeSlotIn()</code>, which triggers the specified behavior is accidentally called BEFORE the mock is actually set up and the set up return value is never taken into account. By some strange coincidence, this error did not alter the expected end result so we did not even notice. It sometimes turns out like this, most often in case of various boundary values (nulls etc.).</p>
<h4 id="using-static-data-inside-production-code"><a href="#using-static-data-inside-production-code">3. Using static data inside production code</a></h4>
<p>Once in a while, you have to jump in and add some new Statements to some class Specification and some logic to the class itself. Let us assume that the class and its existing specification was written by someone else. Imagine this code is a wrapper around your product XML configuration file. You decide to write your Statements AFTER applying the changes (“well”, you can say, “I am all protected by the Specification that is already in place, so I can make my change without risking regression, then just test my changes and it is all good…”).</p>
<p>So, you start writing the new Statement. The Specification class already contains a field member like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> XmlConfigurationSpecification
{
  XmlConfiguration config = <span class="kw">new</span> <span class="fu">XmlConfiguration</span>(xmlFixtureString);
  
  <span class="co">//...</span>
  <span class="co">//...</span></code></pre>
<p>What it does is to set up an object used by every Statement. So, each Statement uses a <code>config</code> object initialized with the same <code>xmlConfiguration</code> string value. The string is already pretty huge and messy, since it was made to contain what is required by all existing Statements. You need to write tests for is a little corner case that does not need all this crap that is inside this string. So, you decide to start fresh and create a separate object of <code>XmlConfiguration</code> class with your own, minimal string. Your Statement begins like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">string</span> customFixture = <span class="fu">CreateMyOwnFixtureForThisTestOnly</span>();
<span class="dt">var</span> configuration = <span class="kw">new</span> <span class="fu">XmlConfiguration</span>(customFixture);
...</code></pre>
<p>And it passes - cool… not. Ok, what is wrong with this? Nothing big, unless you read the source code of XmlConfiguration class carefully. Inside, you can see, how the xml string is stored:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> xmlText; <span class="co">//note the static keyword!</span></code></pre>
<p>What the…? Well, well, here is what happened: the author of this class coded in a small little optimization. He thought: “In this app, the configuration is only modified by members of the support staff and to do it, they have to shut down the system, so, there is no need to read the XML file every time an XmlConfiguration object is created. I can save some CPU cycles and I/O operations by reading it only once when the first object is created. Another created object will just use the same XML!”. Good for him, not so good for you. Why? Because (unless your Statement is evaluated prior to being fulfilled), your custom xml string will never actually be used!</p>
<h3 id="test-after-ends-up-as-test-never"><a href="#test-after-ends-up-as-test-never">“Test-After” ends up as “Test-Never”</a></h3>
<p>I will ask this question again: ever had to write a requirement or design document for something that you already implemented? Was it fun? Was it valuable? Was it creative? No, I do not think so. The same is with our executable specification. After we write the code, we have little motivation to specify what is already written - some of the pieces of code “we can just see are correct”, other pieces “we already saw working” when we copied our code over to our deployment machine and ran few sanity checks… The design is ready… Specification? Maybe next time…</p>
<p>Another reason might be time pressure. Let us be honest - we are all in a hurry, we are all under pressure and when this pressure is too high, it triggers heroic behaviors in us, especially when there is a risk of not making it with the sprint commitment. Such heroic behavior usually goes by the following rules: drop all the “baggage”, stop learning and experimenting, revert to all of the old “safe” behaviors and “save what we can!”. If Specification is written at the end, it is often sacrificed on the altar of making it with the commitment, since the code is already written, “and it will be tested anyway by real tests” (box tests, smoke tests, sanity tests etc.). It is quite the contrary when starting with a Statement, where the Statement evaluating to false is <strong>a reason</strong> to write any code. Thus, if we want to write code, Specification become irremovable part of your development. By the way, I bet in big corporations no one sane ever thinks they can abandon checking in the code to source control, at the same time treating Specification as “an optional addition”.</p>
<h3 id="not-starting-from-specification-leads-to-waste-of-time-on-making-objects-testable"><a href="#not-starting-from-specification-leads-to-waste-of-time-on-making-objects-testable">Not starting from specification leads to waste of time on making objects testable</a></h3>
<p>It so happens, that I like watching and reading Uncle Bob. One day, I was listening to <a href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">his keynote at Ruby Midwest 2011, called Architecture The Lost Years</a>. At the end, Robert made some digressions, one of them being about TDD. He said that writing unit tests after the code is not TDD. It is a waste of time.</p>
<p>My initial thought was that the comment was only about missing all the benefits that starting with false Statement brings you: the ability to see the Statement fail, the ability to do a clean-sheet analysis etc., however, now I am of opinion that there is more to it. It is something I got from Amir Kolsky and Scott Bain - in order to be able to write maintainable Specification for a piece of code, the code has to have a high level of a quality called <strong>testability</strong> (we will talk about testability later on, do not worry - for now let us assume that the easier it is to write a Statement for a behavior of a class, the higher testability it has). That does not tell us much about where is the waste I mentioned, does it? To see it, let us see how dealing with testability looks like in Statement-first workflow (let us assume that we are creating new code, not adding stuff to dirty, ugly legacy code):</p>
<ol style="list-style-type: decimal">
<li>Write false Statement (this step ensures that code has high testability)</li>
<li>Write code to make the Statement true</li>
</ol>
<p>Now, how does it usually look like when we write the code first (extra steps marked with <strong>strong text</strong>):</p>
<ol style="list-style-type: decimal">
<li>Write some production code (probably spans few classes until we are satisfied)</li>
<li><strong>Start writing unit tests</strong></li>
<li><strong>Notice that unit testing the whole set of classes is cumbersome and unsustainable and contains high redundancy.</strong></li>
<li><strong>Restructure the code to be able to isolate objects and use mocks (this step ensures that code has high testability)</strong></li>
<li>Write unit tests</li>
</ol>
<p>What is the equivalent of the marked steps in Statement-first approach? Nothing! Doing these things is a waste of time! Sadly, this is a waste I see done over and over again.</p>
<p>Do you like wasting your time?</p>
<h1 id="practicing-what-we-already-learned"><a href="#practicing-what-we-already-learned">Practicing what we already learned</a></h1>
<blockquote>
<p>And now, a taste of things to come!</p>
<p>– Shang Tsung, Mortal Kombat The Movie</p>
</blockquote>
<p>The above quote took place just before a fighting scene in which a nameless warrior jumped at Sub-Zero only to be frozen and broken into multiple pieces upon hitting the wall. The scene was not spectacular in terms of fighting technique or length. Also, the nameless guy did not even try hard - the only thing he did was to jump only to be hit by a freezing ball, which, by the way, he actually saw coming. It looked a lot like the fight was set up only to showcase Sub-Zero’s freezing ability. Guess what? In this chapter, we are gonna do roughly the same thing - set up a fake, easy scenario just to showcase some of the basic TDD elements!</p>
<p>The previous chapter was filled with a lot of theory and philosophy, don’t you think? I really hope you did not fall asleep while reading it. To tell you the truth, we need to grasp much more theory until we are really able to write real-world applications using TDD. To compensate for this somehow, I propose we make a side trip from the trail and try what we already learned on a quick and easy example. As we go through the example, you might wonder how on earth could you possibly write real applications the way we will write our simple program. Do not worry, I will not show you all the tricks yet, so treat it as a “taste of things to come”. In other words, the example will be as close to real world problems as the fight between Sub-Zero and nameless ninja was to real martial arts fight, but will show you some of the elements of TDD process.</p>
<h2 id="let-me-tell-you-astory"><a href="#let-me-tell-you-astory">Let me tell you a story</a></h2>
<p>Meet Johnny and Benjamin, two developers from Buthig Company. Johnny is quite fluent in programming and Test-Driven Development, while Benjamin is an intern under Johnny’s mentorship and is eager to learn TDD. They are on their way to their customer, Jane, who requested their presence as she wants them to do write a small program for her. Together with them, we will see how they interact with the customer and how Benjamin tries to understand the basics of TDD. Just as you, Benjamin is a novice so his questions may reflect yours. However, if you find anything explained in not enough details, do not worry - in the next chapters, we will be expanding on this material.</p>
<h2 id="act-1-the-car"><a href="#act-1-the-car">Act 1: The Car</a></h2>
<p><strong>Johnny:</strong> How do you feel on your first assignment?</p>
<p><strong>Benjamin:</strong> I am pretty excited! I hope I can learn some of the TDD stuff you promised to teach me.</p>
<p><strong>Johnny:</strong> Not only TDD, but we are also gonna use some of the practices associated with a process called Acceptance Test Driven Development, albeit in a simplified form.</p>
<p><strong>Benjamin:</strong> Acceptance Test-Driven Development? What is that?</p>
<p><strong>Johnny:</strong> While TDD is usually referred to as a development technique, ATDD is something more of a collaboration method. Both ATDD and TDD have a bit of analysis in them and work very well together as both use the same underlying principles, just on different levels. We will need only a small subset of what ATDD has to offer, so do not get over-excited.</p>
<p><strong>Benjamin:</strong> Sure.</p>
<h2 id="act-2-the-customer"><a href="#act-2-the-customer">Act 2: The Customer</a></h2>
<p><strong>Johnny:</strong> Hi, Jane, how are you?</p>
<p><strong>Jane:</strong> Thanks, I am fine, how about you?</p>
<p><strong>Johnny:</strong> Same here, thanks. So, can you tell us a bit about the software you need us to write?</p>
<p><strong>Jane:</strong> Sure. Recently, I bought a new smartphone as a replacement for my old one. The thing is, I am really used to the calculator application that was running on the previous phone and I cannot find it for my current device.</p>
<p><strong>Benjamin:</strong> Can’t you just use another calculator app? There are plenty of them available to download from the web.</p>
<p><strong>Jane:</strong> That is right. I checked them all and none has exactly the same behavior as the one I was using for my tax calculations. You know, the program was like right hand to me and it had some really nice shortcuts that made my life easier.</p>
<p><strong>Johnny:</strong> So you want us to reproduce the application to run on your new device?</p>
<p><strong>Jane:</strong> Yes.</p>
<p><strong>Johnny:</strong> Are you aware that apart from the fancy features that you were using we will have to allocate some effort to implement the basics that all the calculators have?</p>
<p><strong>Jane:</strong> Sure, I am OK with that. I am so used to my calculator application so much that if I use something else for more than few months, I will have to pay psychotherapist instead of you guys. Apart from that, writing a calculator app seems like a simple task in my mind, so the cost isn’t going to be overwhelming, right?</p>
<p><strong>Johnny:</strong> I think I get it. Let us get it going then. We will be implementing the functionality incrementally, starting with the most essential ones. Which feature of the calculator would you consider the most essential?</p>
<p><strong>Jane:</strong> That would be addition of numbers, I guess.</p>
<p><strong>Johnny:</strong> Ok, that will be our target for the first iteration. After the iteration, we will deliver this part of functionality for you to try out and give us some feedback. However, before we can even implement addition, we will have to implement displaying digits on the screen as you enter them. Is that correct?</p>
<p><strong>Jane:</strong> yes, I want the display stuff to work as well - it is the most basic feature, so…</p>
<p><strong>Johnny:</strong> Ok then, this is a simple functionality, so let me suggest some user stories as I understand what you already said and you will correct me where I am wrong. Here we go:</p>
<ol style="list-style-type: decimal">
<li><strong>In order to</strong> know that the calculator is turned on, <strong>As a</strong> tax payer <strong>I want</strong> to see “0” on the screen as soon as I turn it on.</li>
<li><strong>In order to</strong> see what numbers I am currently operating on, <strong>As a</strong> tax payer, <strong>I want</strong> the calculator to display the values I enter</li>
<li><strong>In order to</strong> calculate sum of my different incomes, <strong>As a</strong> tax payer <strong>I want</strong> the calculator to enable addition of multiple numbers</li>
</ol>
<p>What do you think?</p>
<p><strong>Jane</strong>: The stories pretty much reflect what I want for the first iteration. I do not think I have any corrections to make.</p>
<p><strong>Johnny:</strong> Now we will take each story and collect some examples of how it should work.</p>
<p><strong>Benjamin:</strong> Johnny, don’t you think it is obvious enough to proceed with implementation straight away?</p>
<p><strong>Johnny:</strong> Trust me, Benjamin, if there is one word I fear most in communication, it is “obvious”. Miscommunication happens most often around things that people consider obvious, simply because other people do not.</p>
<p><strong>Jane:</strong> Ok, I am in. What do I do?</p>
<p><strong>Johnny:</strong> Let us go through stories one by one and see if we can find some key examples of how the features work. The first story is…</p>
<h3 id="uf3ac031f-9b76-48b2-ac5f-609b8999b7be" class="sigil_not_in_toc"><a href="#uf3ac031f-9b76-48b2-ac5f-609b8999b7be"><strong>In order to</strong> know that the calculator is turned on, <strong>As a</strong> tax payer <strong>I want</strong> to see “0” on the screen as soon as I turn it on.</a></h3>
<p><strong>Jane:</strong> I do not think there is much to talk about. If you display “0”, I will be happy. That is all.</p>
<p><strong>Johnny:</strong> Let us write down this example:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> That makes me wonder… what should happen when I press “0” again at this stage?</p>
<p><strong>Johnny:</strong> Good catch, that is what these examples are for - they make our thinking concrete. As Ken Pugh says: “Often the complete understanding of a concept does not occur until someone tries to use the concept”. We would normally put it on a TODO list, because it is part of a different story, but we are actually done with this one, so let us move straight to the story about displaying entered digits. How about it, Jane?</p>
<p><strong>Jane:</strong> Agree.</p>
<h3 id="u75349e7f-5984-435c-be9e-6a7f4c4c7a35" class="sigil_not_in_toc"><a href="#u75349e7f-5984-435c-be9e-6a7f4c4c7a35"><strong>In order to</strong> see what numbers I am currently operating on, <strong>As a</strong> tax payer, <strong>I want</strong> the calculator to display the values I enter</a></h3>
<p><strong>Johnny:</strong> Let us begin with the case raised by Benjamin. What should happen when I input “0” multiple times after I have only “0” on the display?</p>
<p><strong>Jane:</strong> Just one “0” should be displayed</p>
<p><strong>Johnny:</strong> Do you mean this?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0,0,0</td>
<td align="left">0</td>
<td align="left">Zero is a special case – it is displayed only once</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> That is right. Other than this, the digits should just show on the screen, like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> How about this:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3,4,5,6,7,1,2,3,4,5,6</td>
<td align="left">1234567123456?</td>
<td align="left">Entered digits are displayed?</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Actually, no. My old calculator app has a limit of six digits that I can enter, so it should be:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3,4,5,6,7,1,2,3,4,5,6</td>
<td align="left">123456</td>
<td align="left">Display limited to six digits</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> another good catch, Benjamin!</p>
<p><strong>Benjamin:</strong> I think I am beginning to understand why you like working with examples!</p>
<p><strong>Johnny:</strong> Good. Is there anything else, Jane?</p>
<p><strong>Jane:</strong> No, that is pretty much it. Let us take another story.</p>
<h3 id="u068ecf28-5fd1-40f0-a438-9cedb9486a1c" class="sigil_not_in_toc"><a href="#u068ecf28-5fd1-40f0-a438-9cedb9486a1c"><strong>In order to</strong> calculate sum of my different incomes, <strong>As a</strong> tax payer <strong>I want</strong> the calculator to enable addition of multiple numbers</a></h3>
<p><strong>Johnny:</strong> Is the following all we have to support?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2,+,3,+,4,=</td>
<td align="left">9</td>
<td align="left">Simple addition of numbers</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> This scenario is correct, however, there is also a case when I start with “+” without inputting any number before. This should be treated as adding to zero:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">+,1,=</td>
<td align="left">1</td>
<td align="left">Addition shortcut – treated as 0+1</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> How about when the output is a number longer than six digits limit? Is it OK that we truncate it like this?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>
<td align="left">199999</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Sure, I do not mind. I do not add such big numbers anyway.</p>
<p><strong>Johnny:</strong> There is still one question we missed. Let us say that I input a number, then press “+” and then another number without asking for result with “=”. What should I see?</p>
<p><strong>Jane:</strong> Every time you press “+”, the calculator should consider entering current number finished and overwrite it as soon as you press any other digit:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2,+,3</td>
<td align="left">3</td>
<td align="left">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Oh, and just asking for result after the calculator is turned on should result in “0”.</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">=</td>
<td align="left">0</td>
<td align="left">Result key in itself does nothing</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Let us sum up our discoveries:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
<tr class="even">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
<tr class="odd">
<td align="left">0,0,0</td>
<td align="left">0</td>
<td align="left">Zero is a special case – it is displayed only once</td>
</tr>
<tr class="even">
<td align="left">1,2,3,4,5,6,7</td>
<td align="left">123456</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
<tr class="odd">
<td align="left">2,+,3</td>
<td align="left">3</td>
<td align="left">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
</tr>
<tr class="even">
<td align="left">=</td>
<td align="left">0</td>
<td align="left">Result key in itself does nothing</td>
</tr>
<tr class="odd">
<td align="left">+,1,=</td>
<td align="left">1</td>
<td align="left">Addition shortcut – treated as 0+1</td>
</tr>
<tr class="even">
<td align="left">2,+,3,+,4,=</td>
<td align="left">9</td>
<td align="left">Simple addition of numbers</td>
</tr>
<tr class="odd">
<td align="left">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>
<td align="left">199999</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> The limiting of digits displayed looks like a whole new feature, so I suggest we add it to the backlog and do it in another sprint. In this sprint, we will not handle such situation at all. How about that, Jane?</p>
<p><strong>Jane:</strong> Fine with me. Looks like a lot of work. Nice that we discovered it up-front. For me, the limiting capability seemed so obvious that I did not even think it would be worth mentioning.</p>
<p><strong>Johnny:</strong> See? That is why I do not like the word “obvious”. Jane, we will get back to you if any more questions arise. For now, I think we know enough to implement these three stories for you.</p>
<p><strong>Jane:</strong> good luck!</p>
<h2 id="act-3-test-driven-development"><a href="#act-3-test-driven-development">Act 3: Test-Driven Development</a></h2>
<p><strong>Benjamin:</strong> Wow, that was cool. Was that Acceptance Test-Driven Development?</p>
<p><strong>Johnny:</strong> In a greatly simplified version, yes. The reason I took you with me was to show you the similarities between working with customer the way we did and working with the code using TDD process. They are both applying the same set of principles, just on different levels.</p>
<p><strong>Benjamin:</strong> I am dying to see it with my own eyes. Shall we start?</p>
<p><strong>Johnny:</strong> Sure. If we followed the ATDD process, we would start writing what we call acceptance-level specification. In our case, however, a unit-level specification will be enough. Let us take the first example:</p>
<h3 id="u7a1820ab-f461-4f8c-9c40-47de72b1405a" class="sigil_not_in_toc"><a href="#u7a1820ab-f461-4f8c-9c40-47de72b1405a">Statement 1: Calculator should display 0 on creation</a></h3>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Benjamin, try to write the first Statement.</p>
<p><strong>Benjamin:</strong> Boy, I do not know how to start.</p>
<p><strong>Johnny:</strong> start by writing the statement in a plain English. What should the calculator do?</p>
<p><strong>Benjamin:</strong> It should display “0” when I turn the application on.</p>
<p><strong>Johnny:</strong> In our case, “turning on” is creating a calculator. Let us write it down as a method name:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{

}

}</code></pre>
<p><strong>Benjamin:</strong> Why is the name of the class <code>CalculatorSpecification</code> and the name of the method <code>ShouldDisplay0WhenCreated</code>?</p>
<p><strong>Johnny:</strong> It is a naming convention. There are many others, but this is the one that I like. The rule is that when you take the name of the class without the <code>Specification</code> part followed by the name of the method, it should form a legit sentence. For instance, if I apply it to what we wrote, it would make a sentence: “Calculator should display 0 when created”.</p>
<p><strong>Benjamin:</strong> Ah, I see now. So it is a statement of behavior, isn’t it?</p>
<p><strong>Johnny:</strong> That is right. Now, the second trick I can sell to you is that if you do not know what code to start with, start with the expected result. In our case, we are expecting that the behavior will end up as displaying “0”, right? So let us just write it in form of an assertion.</p>
<p><strong>Benjamin:</strong> You mean something like this?</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Johnny:</strong> Precisely.</p>
<p><strong>Benjamin:</strong> But that does not even compile. What use is it?</p>
<p><strong>Johnny:</strong> the code not compiling is the feedback that you needed to proceed. While previously you did not know where to start, now you have a clear goal - make this code compile. Firstly, where do you get the displayed value from?</p>
<p><strong>Benjamin:</strong> From the calculator display, of course!</p>
<p><strong>Johnny:</strong> Then write it down how you get the value form the display.</p>
<p><strong>Benjamin:</strong> like how?</p>
<p><strong>Johnny:</strong> like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 <span class="dt">var</span> displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Benjamin:</strong> I see. Now the calculator is not created anywhere. I need to create it somewhere now or it will not compile and this is my next step. Is this how it works?</p>
<p><strong>Johnny:</strong> Yes, you are catching on quickly.</p>
<p><strong>Benjamin:</strong> Ok then, here goes:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();

 <span class="dt">var</span> displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Johnny:</strong> Bravo!</p>
<p><strong>Benjamin:</strong> Now the code still does not compile, because I do not have the <code>Calculator</code> class at all…</p>
<p><strong>Johnny:</strong> sounds like a good reason to create it.</p>
<p><strong>Benjamin:</strong> OK.</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
}</code></pre>
<p><strong>Benjamin:</strong> Looks like the <code>Display()</code> method is missing too. I will add it.</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;0&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Hey hey, not so fast!</p>
<p><strong>Benjamin:</strong> What?</p>
<p><strong>Johnny:</strong> You already provided an implementation that will make our current Statement true. Remember its name? <code>ShouldDisplay0WhenCreated</code> - and that is exactly what the code you wrote does. Before we arrive at this point, let us make sure this Statement can ever be evaluates as false. So for now, let us change it to this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;Once upon a time in Africa&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Look, now we can run the Specification and watch that Statement evaluate to false, because it expects “0”, but gets “Once upon a time in Africa…”.</p>
<p><strong>Benjamin:</strong> Running… Ok, it is false. By the way, do you always use such silly values to make Statements false?</p>
<p><strong>Johnny:</strong> Hahaha, no, I just did it to emphasize the point. Normally, I would write <code>return &quot;&quot;;</code> or something similarly simple. Now we can evaluate the Statement and see it evaluate to false. Now we are sure that we have not yet implemented what is required for the Statement to be true.</p>
<p><strong>Benjamin:</strong> I think I get it. For now, the Statement shows that we do not have something we need and gives us a reason to add this “thing”. When we do so, this Statement will show that we do have what we need. So what do we do now?</p>
<p><strong>Johnny:</strong> Write the simplest thing that makes this Statement true.</p>
<p><strong>Benjamin:</strong> like this?</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;0&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Yes.</p>
<p><strong>Benjamin:</strong> But that is not a real implementation. What is the value behind putting in a hardcoded string? The final implementation is not going to be like this for sure!</p>
<p><strong>Johnny:</strong> You’re right. The final implementation is most probably going to be different. What we did, however, is still valuable because:</p>
<ol style="list-style-type: decimal">
<li>You’re one step closer to implementing the final solution</li>
<li>This feeling that this is not the final implementation points you towards writing more Statements. When there is enough Statements to make your implementation complete, it usually means that you have a complete Specification of class behaviors as well.</li>
<li>If you treat making every Statement true as an achievement, this practice allows you to evolve your code without losing what you already achieved. If by accident you break any of the behaviors you’ve already implemented, the Specification is going to tell you because one of the existing Statements that were previously true will then evaluate to false. You can then either fix it or undo your changes using version control and start over from the point where all existing Statements were true.</li>
</ol>
<p><strong>Benjamin:</strong> looks like quite a few benefits. Still, I will have to get used to this kind of working.</p>
<p><strong>Johnny:</strong> do not worry, it is central to TDD, so you will grasp it in no time. Now, before we proceed to the next Statement, let us look at what we already achieved. First, we wrote a Statement that turned out false. Then, we wrote just enough code to make the Statement true. Time for a step called Refactoring. In this step, we will take a look at the Statement and the code and remove duplication. Can you see what is duplicated between the Statement and the code?</p>
<p><strong>Benjamin:</strong> both of them contain the literal “0”. The Statement has it here:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);</code></pre>
<p>and the implementation here:</p>
<pre><code>return &quot;0&quot;;</code></pre>
<p><strong>Johnny:</strong> Good, let us eliminate this duplication by introducing a constant called <code>InitialValue</code>. The Statement will now look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplayInitialValueWhenCreated</span>()
{
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();

 <span class="dt">var</span> displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(Calculator.<span class="fu">InitialValue</span>, displayedResult);
}</code></pre>
<p>and the implementation:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> <span class="dt">const</span> <span class="dt">string</span> InitialValue = <span class="st">&quot;0&quot;</span>;
  <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
  {
    <span class="kw">return</span> InitialValue;
  } 
}</code></pre>
<p><strong>Benjamin:</strong> The code looks better and having the constant in one place will make it more maintainable, but I think the Statement in its current form is weaker than before. We could change the <code>InitialValue</code> to anything and the Statement would still be true, since it does not force this constant to be “0”.</p>
<p>That is right. We need to add it to our TODO list to handle this case. Can you write it down?</p>
<p><strong>Benjamin:</strong> Sure. I will write it as “TODO: 0 should be used as an initial value.”</p>
<p><strong>Johnny:</strong> Ok. We should handle it now, especially that it is part of the story we are currently implementing, but I will leave it for later just to show you the power of TODO list in TDD - whatever is on the list, we can forget and get back to when we have nothing better to do. Our next item from the list is this:</p>
<h3 id="u3f564a21-4fcf-42c1-8b74-b0f57676aff0" class="sigil_not_in_toc"><a href="#u3f564a21-4fcf-42c1-8b74-b0f57676aff0">Statement 2: Calculator should display entered digits</a></h3>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Benjamin, can you come up with a Statement for this behavior?</p>
<p><strong>Benjamin:</strong> I will try. Here goes:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayEnteredDigits</span>()
{
  <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
  
  calculator.<span class="fu">Enter</span>(<span class="dv">1</span>);
  calculator.<span class="fu">Enter</span>(<span class="dv">2</span>);
  calculator.<span class="fu">Enter</span>(<span class="dv">3</span>);
  <span class="dt">var</span> displayedValue = calculator.<span class="fu">Display</span>();

  Assert.<span class="fu">Equal</span>(<span class="st">&quot;123&quot;</span>, displayedValue);
}</code></pre>
<p><strong>Johnny:</strong> I am glad that you got the part about naming and writing a Statement. One thing we will have to work on here though.</p>
<p><strong>Benjamin:</strong> what is it?</p>
<p><strong>Johnny:</strong> When we talked to Jane, we used examples with real values. These real values were extremely helpful in pinning down the corner cases and uncovering missing scenarios. They were easier to imagine as well, so they were a perfect suit for conversation. If we were automating these examples on acceptance level, we would use those real values as well. When we write unit-level Statements, however, we use a different technique to get this kind of specification more abstract. First of all, let me enumerate the weaknesses of the approach you just used:</p>
<ol style="list-style-type: decimal">
<li>Making a method <code>Enter()</code> accept an integer value suggests that one can enter more than one digit at once, e.g. <code>calculator.Enter(123)</code>, which is not what we want. We could detect such cases and throw exceptions if the value is outside the 0-9 range, but there are better ways when we know we will only be supporting ten digits (0,1,2,3,4,5,6,7,8,9).</li>
<li>The Statement does not clearly show the relationship between input and output. Of course, in this simple case it is pretty self-evident that the sum is a concatenation of entered digits, we do not want anyone who will be reading this Specification in the future to have to guess.</li>
<li>The Statement suggests that what you wrote is sufficient for any value, which isn’t true, since the behavior for “0” is different (no matter how many times we enter “0”, the result is just “0”)</li>
</ol>
<p>Hence, I propose the following:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 <span class="dt">var</span> nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 <span class="dt">var</span> anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 <span class="dt">var</span> anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();

 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  <span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
   (<span class="dt">int</span>)nonZeroDigit, 
   (<span class="dt">int</span>)anyDigit1, 
   (<span class="dt">int</span>)anyDigit2
  ),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Benjamin:</strong> Johnny, I am lost! Can you explain what is going on here?</p>
<p><strong>Johnny:</strong> Sure, what do you want to know?</p>
<p><strong>Benjamin:</strong> For instance, what is this <code>DigitKeys</code> type doing here?</p>
<p><strong>Johnny:</strong> It is supposed to be an enumeration (note that it does not exist yet, we just assume that we have it) to hold all the possible digits user can enter, which are 0-9. This is to ensure that user will not write <code>calculator.Enter(123)</code>. Instead of allowing to enter any number and then detecting errors, we are giving our users a choice from among only the valid values.</p>
<p><strong>Benjamin:</strong> Now I get it. So how about the <code>Any.Besides()</code> and <code>Any.Of()</code>? What do they do?</p>
<p><strong>Johnny:</strong> They are methods from a small utility library I am using when writing unit-level Specifications. <code>Any.Besides()</code> returns any value from enumeration besides the one supplied as an argument. Hence, the call <code>Any.Besides(DigitKeys.Zero)</code> means “any of the values contained in DigitKeys enumeration, but not DigitKeys.Zero”.</p>
<p>The <code>Any.Of()</code> is simpler - it just returns any value in an enumeration. Note that when I create the values this way, I state explicitly that this behavior occurs when first digit is non-zero. This technique of using generated values instead of literals has its own principles, but let us leave it for later. I promise to give you a detailed lecture on it. Agree?</p>
<p><strong>Benjamin:</strong> You better do, because for now, I feel a bit uneasy with generating the values - it seems like the Statement we are writing is getting less deterministic this way. The last question - what about those weird comments you put in the code? Given? When? Then?</p>
<p><strong>Johnny:</strong> Yes, this is a convention that I use, not only in writing, but in thinking as well. I like to think about every behavior in terms of three elements: assumptions (given), trigger (when) and expected result (then). Using the words, we can summarize the Statement we are writing in the following way: “<strong>Given</strong> a calculator, <strong>when</strong> I enter some digits first one being other than zero, <strong>then</strong> they should all be displayed in order they were entered”. This is also something that I will tell you more about later.</p>
<p><strong>Benjamin:</strong> Sure, for now I need just enough detail to understand what is going on - we can talk about the principles, pros and cons later. By the way, the following sequence of casts looks a little bit ugly:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
 (<span class="dt">int</span>)nonZeroDigit, 
 (<span class="dt">int</span>)anyDigit1, 
 (<span class="dt">int</span>)anyDigit2
)</code></pre>
<p><strong>Johnny:</strong> We will get back to it and make it more “smarter” in a second after we make this statement true. For now, we need something obvious. Something we know works. Let us evaluate this Statement. What is the result?</p>
<p><strong>Benjamin:</strong> Failed, expected “331”, but was “0”.</p>
<p><strong>Johnny:</strong> Good, now let us write some code to make this Statement true. First, let us introduce an enumeration of digits:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">enum</span> DigitKeys
{
 Zero = <span class="dv">0</span>,
 TODO1, <span class="co">//TODO</span>
 TODO2, <span class="co">//TODO</span>
 TODO3, <span class="co">//TODO</span>
 TODO4, <span class="co">//TODO</span>
}</code></pre>
<p><strong>Benjamin:</strong> What is with all those bogus values? Should we not just enter all the digits we support?</p>
<p><strong>Johnny:</strong> Nope, not yet. We still do not have a Statement which would say what digits are supported and thus make us add them, right?.</p>
<p><strong>Benjamin:</strong> You say you need a Statement for an element to be in an enum??</p>
<p><strong>Johnny:</strong> This is a specification we are writing, remember? It should say somewhere which digits we support, should it not?</p>
<p><strong>Benjamin:</strong> It is difficult to agree with, especially that I am used to write unit tests, not Statements and in unit tests, I wanted to verify what I was unsure of.</p>
<p><strong>Johnny:</strong> I will try to give you more arguments later. For now, just bear with me and note that adding such Statement will be almost effortless.</p>
<p><strong>Benjamin:</strong> OK.</p>
<p><strong>Johnny:</strong> Now for the implementation. Just to remind you - up to now, it looked like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="kw">public</span> <span class="dt">const</span> <span class="dt">string</span> InitialValue = <span class="st">&quot;0&quot;</span>;
 <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
 {
  <span class="kw">return</span> InitialValue;
 } 
}</code></pre>
<p>This is not enough to support displaying multiple digits (as we saw, because the Statement saying they should be supported was evaluated to false). So let us evolve the code to handle this case:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="kw">private</span> <span class="dt">int</span> _result = <span class="dv">0</span>;
      
 <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  _result *= <span class="dv">10</span>;
  _result += (<span class="dt">int</span>)digit; 
 }

 <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
 {
  <span class="kw">return</span> _result.<span class="fu">ToString</span>();
 }
}</code></pre>
<p><strong>Johnny:</strong> Now the Statement is true so we can go back to it and make it a little bit prettier. Let us take a second look at it:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 <span class="dt">var</span> nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 <span class="dt">var</span> anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 <span class="dt">var</span> anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
          
 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  <span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
   (<span class="dt">int</span>)nonZeroDigit, 
   (<span class="dt">int</span>)anyDigit1, 
   (<span class="dt">int</span>)anyDigit2
  ),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Johnny:</strong> Remember you said that you do not like the part where <code>string.Format()</code> is used?</p>
<p><strong>Benjamin:</strong> Yeah, it seems a bit unreadable.</p>
<p><strong>Johnny:</strong> Let us extract this part into a utility method and make it more general - we will need a way of constructing expected displayed output in many of our future Statements. Here is my go at this helper method:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">string</span> <span class="fu">StringConsistingOf</span>(<span class="kw">params</span> DigitKeys[] digits)
{
 <span class="dt">var</span> result = <span class="dt">string</span>.<span class="fu">Empty</span>;
      
 <span class="kw">foreach</span>(var digit <span class="kw">in</span> digits) 
 {
  result += (<span class="dt">int</span>)digit;
 }
 <span class="kw">return</span> result;
}</code></pre>
<p>Note that this is more general as it supports any number of parameters. And the Statement after this extraction looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 <span class="dt">var</span> nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 <span class="dt">var</span> anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 <span class="dt">var</span> anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
          
 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  <span class="fu">StringConsistingOf</span>(nonZeroDigit, anyDigit1, anyDigit2),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Benjamin:</strong> Looks better to me. The Statement is still evaluated as true, which means we got it right, did we not?</p>
<p><strong>Johnny:</strong> Not exactly. With moves such as this one, I like to be extra careful. Let us comment out the body of the <code>Enter()</code> method and see if this Statement can still be made false by the implementation:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  <span class="co">//_result *= 10;</span>
  <span class="co">//_result += (int)digit; </span>
 }</code></pre>
<p><strong>Benjamin:</strong> Running… Ok, it is false now. Expected “243”, got “0”.</p>
<p><strong>Johnny:</strong> good, now we are pretty sure that it works OK. Let us uncomment the lines we just commented out and move forward.</p>
<h3 id="ub7968b9c-798d-41a2-94ef-86e57921a82b" class="sigil_not_in_toc"><a href="#ub7968b9c-798d-41a2-94ef-86e57921a82b">Statement 3: Calculator should display only one zero digit if it is the only entered digit even if it is entered multiple times</a></h3>
<p><strong>Johnny:</strong> Benjamin, this should be easy for you, so go ahead and try it. It is really a variation of previous Statement.</p>
<p><strong>Benjamin:</strong> Let me try… ok, here it is:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayOnlyOneZeroDigitWhenItIsTheOnlyEnteredDigitEvenIfItIsEnteredMultipleTimes</span>()
{
 <span class="dt">var</span> zero = DigitKeys.<span class="fu">Zero</span>;
 <span class="dt">var</span> calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
      
 calculator.<span class="fu">Enter</span>(zero);
 calculator.<span class="fu">Enter</span>(zero);      
 calculator.<span class="fu">Enter</span>(zero);
      
 Assert.<span class="fu">Equal</span>(
  <span class="fu">StringConsistingOf</span>(DigitKeys.<span class="fu">Zero</span>), 
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Johnny:</strong> Good, you are learning fast! Let us evaluate this Statement.</p>
<p><strong>Benjamin:</strong> It seems that our current code already fulfills the Statement. Should I try to comment some code to make sure this Statement can fail just like you did in the previous Statement?</p>
<p><strong>Johnny:</strong> That would be wise thing to do. When a Statement is true without requiring you to change any production code, it is always suspicious. Just like you said, we have to modify production code for a second to force this Statement to be false, then undo this modification to make it true again. This isn’t as obvious as previously, so let me do it. I will mark all the added lines with <code>//+</code> comment so that you can see them easily:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="dt">int</span> _result = <span class="dv">0</span>;
 <span class="dt">string</span> fakeResult = <span class="st">&quot;0&quot;</span>; <span class="co">//+</span>
      
 <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  _result *= <span class="dv">10</span>;
  _result += (<span class="dt">int</span>)digit; 
  <span class="kw">if</span>(digit == DigitKeys.<span class="fu">Zero</span>) <span class="co">//+</span>
  {  <span class="co">//+</span>
   fakeResult += <span class="st">&quot;0&quot;</span>;  <span class="co">//+</span>
  } <span class="co">//+</span>
 }

 <span class="kw">public</span> <span class="dt">string</span> <span class="fu">Display</span>()
 {
  <span class="kw">if</span>(_result == <span class="dv">0</span>)  <span class="co">//+</span>
  {  <span class="co">//+</span>
   <span class="kw">return</span> fakeResult;  <span class="co">//+</span>
  }  <span class="co">//+</span>
  <span class="kw">return</span> _result.<span class="fu">ToString</span>();
 }
}</code></pre>
<p><strong>Benjamin:</strong> Wow, looks like a lot of code just to make the Statement false! Is it worth the hassle? We will undo this whole modification in a second anyway</p>
<p><strong>Johnny:</strong> Depends on how confident you want to feel. I would say that it is usually worth it - at least you know that you got everything right. It might seem like a lot of work, but it actually took me about a minute to add this code and imagine you got it wrong and had to debug it on a production environment. _That_ would be a waste of time.</p>
<p><strong>Benjamin:</strong> Ok, I think I get it. Since we saw this Statement turn false, I will undo this modification to make it true again.</p>
<p><strong>Johnny:</strong> Sure.</p>
<h2 id="epilogue"><a href="#epilogue">Epilogue</a></h2>
<p>Time to leave Johnny and Benjamin, at least for now. I actually planned to make this chapter longer, and cover all the other operations, but I fear I would make this too long and get you bored. You should have a feel of how the TDD cycle looks like, especially that Johnny and Benjamin had a lot of conversations on many other topics in the meantime. I will be revisiting these topics later in the book. For now, so if you felt lost or unconvinced on any of the topics mentioned by Johnny, do not worry - I do not expect you to be proficient with any of the techniques shown in this chapter just yet. Time will come for that.</p>
<h1 id="sorting-out-the-bits"><a href="#sorting-out-the-bits">Sorting Out The Bits</a></h1>
<p>In the previous chapter, there has been a lively conversation between Johnny and Benjamin. Even in such a short session, Benjamin, as a TDD novice, had a lot of questions and a lot of things he needed sorted out. We will pick up all those questions and explain them one by one. Here they are:</p>
<ul>
<li>How to name a Statement?</li>
<li>How to start writing a Statement?</li>
<li>How is TDD about analysis and what does this “GIVEN-WHEN-THEN” mean?</li>
<li>What exactly is the scope of a Statement? A class, a method, or something else?</li>
<li>What is the role of TODO list in TDD?</li>
<li>Why use anonymous generated values instead of literals as input of a specified behavior?</li>
<li>Why and how to use the Any class?</li>
<li>What code to extract from a Statement to shared utility method?</li>
<li>Why such a strange approach to create enumerated constants?</li>
</ul>
<p>A lot of questions, isn’t it? It is unfortunate that TDD has this high entry barrier, at least for someone used to the traditional way of writing code. Anyway, that is what this tutorial is for - to answer such questions and lower this barrier. Thus, we will try to answer those questions one by one.</p>
<h1 id="how-to-start"><a href="#how-to-start">How to start?</a></h1>
<p>Whenever I sat down with a person that was about to write their first code in a Statement-first manner, the person would first stare at the screen, then at me, then would say: “what now?”. It is easy to say: “You know how to write code, you know how to write a unit test for it, just this time start with the latter rather than the first”, but for many people, this is something that blocks them completely. If you are one of them, do not worry - you are not alone. I decided to dedicate this chapter solely to techniques for kicking off a Statement when there is no code.</p>
<h2 id="start-with-agood-name"><a href="#start-with-agood-name">Start with a good name</a></h2>
<p>It may sound obvious, but some people are having serious trouble describing the behavior they expect from their code. If you can name such behavior, it is a great starting point.</p>
<p>I know not everybody pays attention to naming their Statements, mainly because the Statements are considered as tests and second-level citizens - as long as they run and “prove the code does not contain defects”, they are considered sufficient. We will take a look at some examples of bad names and then I will introduce to you some rules of good naming.</p>
<h3 id="ue6b820a0-8d47-4bcc-8594-e14d112faf7e" class="sigil_not_in_toc"><a href="#ue6b820a0-8d47-4bcc-8594-e14d112faf7e">Consequences of bad naming</a></h3>
<p>As I said, many people do not really care how their Statements are named. This is a symptom of treating the Specification as garbage or leftovers - such situation is dangerous, because as soon as this kind of thinking is established, it leads to bad, unmaintainable Specification that looks more like lumps of accidental code put together in a haste than a living documentation. Imagine that your Specification consists of names like this:</p>
<ul>
<li><code>TrySendPacket()</code></li>
<li><code>TrySendPacket2()</code></li>
<li><code>testSendingManyPackets()</code></li>
<li><code>testWrongPacketOrder1()</code></li>
<li><code>testWrongPacketOrder2()</code></li>
</ul>
<p>and try for yourself how difficult it is to answer the following questions:</p>
<ol style="list-style-type: decimal">
<li>How do you know what situation each Statement describes?</li>
<li>How do you know whether the Statement describes a single situation, or few of them at the same time?</li>
<li>How do you know whether the assertions inside those Statements are really the right ones assuming each Statement was written by someone else or a long time ago?</li>
<li>How do you know whether the Statement should stay or be removed when you modify the functionality it specifies?</li>
<li>If your changes in production code make a Statement evaluate to false, how do you know whether the Statement is no longer correct or the production code is wrong?</li>
<li>How do you know whether you will not introduce a duplicate Statement for a behavior that is already specified by another Statement when adding to Specification originally created by another team member?</li>
<li>How do you estimate, by looking at the runner tool report, whether the fix for failing Statement will be easy or not?</li>
<li>How do you answer a new developer in your team when they ask you “what is this Statement for?”</li>
<li>How can you keep track of the Statements already made about the specified class vs those that still need to be made?</li>
</ol>
<h3 id="what-does-agood-name-contain"><a href="#what-does-agood-name-contain">What does a good name contain?</a></h3>
<p>For the name of the Statement to be of any use, it has to describe the expected behavior. At minimum, it should describe what happens under what circumstances. Let us take a look at one of the names Steve freeman and Nat Pryce came up in their great book Growing Object Oriented Software Guided By Tests:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort</span>()</code></pre>
<p>Note few things about the name of the Statement:</p>
<ol style="list-style-type: decimal">
<li>It describes a behavior of an instance of a specified class. Note that it does not contain method name that triggers the behavior, because what is specified is not a method, but the behavior itself. The name simply tells that what an instance does (“notifies listeners that server is unavailable”) under certain circumstances (“when cannot connect to its monitoring port”). It is important because such description is what you can derive from thinking about responsibilities of a class, so you do not need to know any of its method signature or the code that is inside of the class. Hence, this is something you can come up with before implementing - you just need to know why you created this class and build on this knowledge.</li>
<li><p>The name is relatively long. Really, really, <strong>really</strong> do not worry about it. As long as you are describing a single behavior, it is alright. I know usually people are hesitant to give long names to the Statements, because they try to apply the same rules to those names as to method names in production code (and in production code too long method name can be a sign of it having too many responsibilities). Let me make it clear - these two cases are different. In case of Statements, methods are not invoked by anyone besides the automatic runner applications, so they will not obfuscate any code that would need to call them with their long names. Sure, we could put all the information in the comment instead of Statement name and leave the name short, like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="co">//Notifies listeners that server </span>
<span class="co">//is unavailable when cannot connect</span>
<span class="co">//to its monitoring port</span>
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">Statement_002</span>()
{
  <span class="co">//...</span>
}</code></pre>
<p>There are two downsides to this solution: one is that we now have to put extra information (<code>Statement_002</code>) which is required only by compiler, because every method needs to have a name - there is usually no value a human could derive from such a name. The second downside is that when the Statement is evaluated to false, the automated runner shows you the following line: <code>Statement_002: FAILED</code> - note that all the information included in the comment isn’t present in the failure report. It is really better to receive a report such as:</p>
<p><code>notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort: FAILED</code></p>
<p>because then a lot of information about the Statement that fails is available from the runner window.</p></li>
<li><p>Using a name that describes a (single) behavior allows you to track quickly why the Statement is false when it is. Suppose a Statement is true when you start refactoring, but at one point it starts being evaluated as false and the report in the runner looks like this: <code>TrySendingHttpRequest: FAILED</code> - it does not really tell you anything more than that an attempt is made to send a HTTP request, but, for instance, does not tell you whether your specified object is the sender (that should try to send this request under some circumstances) or the receiver (that should handle such request properly). To actually know what went wrong, you have to go Statement body and scan its source code. Now compare it to the following name: <code>ShouldRespondWithAnAckWheneverItReceivesAHttpRequest</code>. Now when it evaluates to false, you can tell what is broken - the object no longer responds with an ACK to HTTP request. Sometimes this is enough to identify which part of the code is in fault of this evaluation failure.</p></li>
</ol>
<h3 id="my-favourite-convention"><a href="#my-favourite-convention">My favourite convention</a></h3>
<p>There are many conventions for naming Statements appropriately. My favorite is the one developed by Dan North, which makes each Statement name begin with the word <code>Should</code>. So for example, I would name a Statement:</p>
<p><code>ShouldReportAllErrorsSortedAlphabeticallyWhenErrorsOccurDuringSearch()</code></p>
<p>The name of the Specification (i.e. class name) answers the question “who should do it?”, i.e. when I have a class named <code>SortingOperation</code> and want to say that it “should sort all items in ascending order when performed”, I say it like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> SortingOperationSpecification
{
 [Fact] <span class="kw">public</span> <span class="dt">void</span>
 <span class="fu">ShouldSortAllItemsInAscendingOrderWhenPerformed</span>()
 {
 }
}</code></pre>
<p>The “should” word was introduced by Dan to weaken the statement following it and thus, to allow questioning what you are stating and ask yourself the question: “should it really?”. If this causes uncertainty, then it is high time to talk to a domain expert and make sure you understand well what you need to accomplish. If you are not a native English speaker, the “should” prefix will probably have a weaker influence on you - that is why I do not insist on you using it. I like it though.</p>
<p>When inventing a name, It is important to put the main focus on what result or action is expected from an object. If you do not, you quickly find it troublesome. As an example, one of my colleagues was specifying a class <code>UserId</code> and wrote the following name for the Statement about comparison of two identifiers:</p>
<p><code>EqualOperationShouldPassForTwoInstancesWithTheSameUserName()</code>.</p>
<p>Note that this is not from the perspective of a single object, but rather from the perspective of an operation that is executed on it, which means that we stopped thinking in terms of object responsibilities and started thinking in terms of operation correctness, which is farther away from our assumption that we are writing a Specification consisting of Statements. This name should be something more like:</p>
<p><code>ShouldReportThatItIsEqualToAnotherIdThatHasTheSameUserName()</code>.</p>
<h2 id="start-by-filling-the-given-when-then-structure-with-the-obvious"><a href="#start-by-filling-the-given-when-then-structure-with-the-obvious">Start By Filling The GIVEN-WHEN-THEN Structure With The Obvious</a></h2>
<p>This is a technique that is applicable when you come up with a GIVEN-WHEN-THEN structure for the Statement or a good name for it (GIVEN-WHEN-THEN structure can be easily derived from a good name and vice versa). Anyway, this technique is about taking the GIVEN, WHEN and THEN parts and translating them into code in almost literal, brute-force way, then add all the missing pieces that are required for the code to compile and run.</p>
<h3 id="uebece5ad-cd6e-42a9-b43e-dfb05633af88" class="sigil_not_in_toc"><a href="#uebece5ad-cd6e-42a9-b43e-dfb05633af88">A Simple Example</a></h3>
<p>Let us take a simple example of comparing two users. We assume that a user should be equal to another when it has the same name as the other one:</p>
<p>~<sub>~</sub> {style=“padding: 1em; border: dashed thin gray;”} GIVEN a user with any name WHEN I compare it to another user with the same name THEN it should appear equal to this other user <sub>~</sub></p>
<p>Let us start with the translation</p>
<p>The first line:</p>
<pre style="padding: 1em; border: dashed thin gray;"><code>GIVEN a user with any name</code></pre>
<p>can be translated literally to code like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">var</span> user = <span class="kw">new</span> <span class="fu">User</span>(anyName);</code></pre>
<p>Then the second line:</p>
<pre style="padding: 1em; border: dashed thin gray;"><code>WHEN I compare it to another user with the same name</code></pre>
<p>can be written as:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">user.<span class="fu">Equals</span>(anotherUserWithTheSameName);</code></pre>
<p>Great! Now the last line:</p>
<pre style="padding: 1em; border: dashed thin gray;"><code>THEN it should appear equal to this other user</code></pre>
<p>and its translation into the code:</p>
<pre><code>Assert.True(areUsersEqual);</code></pre>
<p>Ok, so we have made the translation, now let us summarize this and see what is missing to make this code compile:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldAppearEqualToAnotherUserWithTheSameName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> user = <span class="kw">new</span> <span class="fu">User</span>(anyName);

  <span class="co">//WHEN</span>
  user.<span class="fu">Equals</span>(anotherUserWithTheSameName);

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(areUsersEqual);
}</code></pre>
<p>As we expected, this will not compile. Notably, our compiler might point us towards the following gaps:</p>
<ol style="list-style-type: decimal">
<li>A declaration of <code>anyName</code> variable.</li>
<li>A declaration of <code>anotherUserWithTheSameName</code> object.</li>
<li>The variable <code>areUsersEqual</code> is both not declared and it does not hold the comparison result.</li>
<li>If this is our first Statement, we might not even have the <code>User</code> class defined at all.</li>
</ol>
<p>The compiler created a kind of a small TODO list for us, which is nice. Note that, while we do not have full compiling code, filling the gaps boils down to making a few trivial declarations and assignments:</p>
<ol style="list-style-type: decimal">
<li><p><code>anyName</code> can be declared as</p>
<p><code>var anyName = Any.String();</code></p></li>
<li><p><code>anotherUserWithTheSameName</code> can be declared as</p>
<p><code>var anotherUserWithTheSameName = new User(anyName);</code></p></li>
<li><p><code>areUsersEqual</code> can be declared and assigned this way:</p>
<p><code>var areUsersEqual = user.Equals(anotherUserWithTheSameName);</code></p></li>
<li><p>If <code>User</code> class does not exist, we can add it by simply stating:</p>
<p><code>public class User {}</code></p></li>
</ol>
<p>Putting it all together:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldAppearEqualToAnotherUserWithTheSameName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> anyName = Any.<span class="fu">String</span>();
  <span class="dt">var</span> user = <span class="kw">new</span> <span class="fu">User</span>(anyName);
  <span class="dt">var</span> anotherUserWithTheSameName = <span class="kw">new</span> <span class="fu">User</span>(anyName);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> areUsersEqual = user.<span class="fu">Equals</span>(anotherUserWithTheSameName);

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(areUsersEqual);
}</code></pre>
<p>And that is it - the Statement is complete!</p>
<h2 id="start-from-the-end"><a href="#start-from-the-end">Start From The End</a></h2>
<p>This is a technique that I suggest to people that seem to have absolutely no idea how to start. I got it from Kent Beck’s book Test Driven Development by Example. It seems funny at start, but is quite powerful. The trick is to write the Statement ‘backwards’, i.e. starting with what the Statement asserts to be true (in terms of the GIVEN-WHEN-THEN structure, we would say that we start with our THEN).</p>
<p>This works because, while we are many times quite sure of our goal (i.e. what the outcome of the behavior should be), but are unsure of how to get there.</p>
<h3 id="a-simple-example"><a href="#a-simple-example">A Simple Example</a></h3>
<p>Imagine we are writing a class for granting access to a reporting functionality based on roles. We do not have any idea what the API should look like and how to write our Statement, but we know one thing: in our domain the access can be either granted or denied. Let us take the successful case (just because it is the first one we can think of) and, starting backwards, start with the following assertion:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//THEN</span>
Assert.<span class="fu">True</span>(accessGranted);</code></pre>
<p>Ok, that part was easy, but did we make any progress with that? Of course we did - we now have a non-compiling code and the compilation error is because of the <code>accessGranted</code> variable. Now, in contrast to the previous approach (with translating our GIVEN-WHEN-THEN structure into a Statement), our goal is not to make this compile as soon as possible. The goal is to answer ourselves a question: how do I know whether the access is granted or not? The answer: it is the result of authorization of the allowed role. Ok, so let us just write it down, ignoring everything that stands in our way (I know that most of us have a habit to add a class or a variable as soon as we find out that we need it. If you are like that, then please turn off this habit while writing Statements - it will only throw you off the track and steal your focus from what is important. The key to doing TDD successfully is to learn to use something that does not exist yet like it existed):</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//WHEN</span>
var accessGranted 
 = authorization.<span class="fu">IsAccessToReportingGrantedTo</span>(
  roleAllowedToUseReporting);</code></pre>
<p>Note that we do not know what <code>roleAllowedToUseReporting</code> is, neither do we know what is <code>authorization</code>, but that did not stop us from writing this line. Also, the <code>IsAccessToReportingGrantedTo()</code> method is just taken from the top of our head. It is not defined anywhere, it just made sense to write it like this, because it is the most direct translation of what we had in mind.</p>
<p>Anyway, this new line answers the question on where do we take the <code>accessGranted</code> from, but makes us ask further questions:</p>
<ol style="list-style-type: decimal">
<li>Where does the <code>authorization</code> variable come from?</li>
<li>Where does the <code>roleAllowedToUseReporting</code> variable come from?</li>
</ol>
<p>As for <code>authorization</code>, we do not have anything specific to say about it other than that it is an object of a class that we do not have yet. In order to proceed, let us pretend that we have such a class. How do we call it? The instance name is <code>authorization</code>, so it is quite straightforward to name the class <code>Authorization</code> and instantiate it in the simplest way we can think of:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//GIVEN</span>
<span class="dt">var</span> authorization = <span class="kw">new</span> <span class="fu">Authorization</span>();</code></pre>
<p>Now for the <code>roleAllowedToUseReporting</code>. The first question that comes to mind when looking at this is: which roles are allowed to use reporting? Let us assume that in our domain, this is either an Administrator or an Auditor. Thus, we know what is going to be the value of this variable. As for the type, there are various ways we can model a role, but the most obvious one for a type that has few possible values is an enum. So:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//GIVEN</span>
<span class="dt">var</span> roleAllowedToUseReporting = Any.<span class="fu">Of</span>(Roles.<span class="fu">Admin</span>, Roles.<span class="fu">Auditor</span>);</code></pre>
<p>And so, working our way backwards, we have arrived at the final solution (we still need to give this Statement a name, but, provided what we already know, this is an easy task):</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAllowAccessToReportingWhenAskedForEitherAdministratorOrAuditor</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> roleAllowedToUseReporting = Any.<span class="fu">Of</span>(Roles.<span class="fu">Admin</span>, Roles.<span class="fu">Auditor</span>);
 <span class="dt">var</span> authorization = <span class="kw">new</span> <span class="fu">Authorization</span>();

 <span class="co">//WHEN</span>
 <span class="dt">var</span> accessGranted = authorization
  .<span class="fu">IsAccessToReportingGrantedTo</span>(roleAllowedToUseReporting);

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(accessGranted);
}</code></pre>
<h2 id="start-by-invoking-amethod-when-you-have-one"><a href="#start-by-invoking-amethod-when-you-have-one">Start By Invoking a Method When You Have One</a></h2>
<p>Sometimes, we have to add a new class that implements an existing interface required by another class. The fact of implementing an interface imposes what methods should the new class support. If this point is already decided, we can start our Statement by first calling the method and then discovering what we need to supply.</p>
<h3 id="a-simple-example-1"><a href="#a-simple-example-1">A Simple Example</a></h3>
<p>Suppose we have an application holding a lot of data that, among other things, handles importing am existing database from another instance of the application. As importing a database can be a lengthy process, a message box is displayed each time when user chooses to perform the import and this message box displays the following message: “Johnny, please sit down and enjoy your coffee for a few minutes as we take time to import your database” (given user name is Johnny). The class that implements it looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> FriendlyMessages
{
  <span class="kw">public</span> <span class="dt">string</span> 
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(<span class="dt">string</span> userName)
  {
    <span class="kw">return</span> <span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;{0}, &quot;</span>
      + <span class="st">&quot;please sit down and enjoy your coffee &quot;</span>
      + <span class="st">&quot;for a few minutes as we take time &quot;</span>
      + <span class="st">&quot;to import your database&quot;</span>,
      userName);
  }
}</code></pre>
<p>Now, imagine that our management told us that they need to ship a trial version with some features disabled, including importing an existing database. Among all the things we need to do to make it happen, we also need to display a different string with message saying that this is a trial version and the feature is locked. We can do it by extracting an interface from the <code>FriendlyMessages</code> class and using it to put in an instance of another class implementing this interface when the application discovers that it is being run as a trial version. The extracted interface looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Messages
{
  <span class="dt">string</span> <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(<span class="dt">string</span> userName);
}</code></pre>
<p>So our new implementation is forced to support the <code>HoldOnASecondWhileWeImportYourDatabase</code> method. Thus, we when implementing the class, we start with the following:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> TrialVersionMessages : Messages
{
 <span class="kw">public</span> <span class="dt">string</span> <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(<span class="dt">string</span> userName)
 {
   <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();
 }
}</code></pre>
<p>Now, we are ready to start writing a Statement. Assuming we do not know where to start, we just start with creating an object and invoking the method that needs to be implemented:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 
 <span class="co">//WHEN</span>
 trialMessages.<span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>();

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(<span class="kw">false</span>); <span class="co">//to remember about it</span>
}</code></pre>
<p>As you can see, we added an assertion that always fails at the end because we do not have any assertions yet and the Statement would otherwise be already evaluated as true and we would rather have it remind ourselves that it is not finished. Other than this, the Statement does not compile anyway, because the method <code>HoldOnASecondWhileWeImportYourDatabase</code> takes a string argument and we passed none. This makes us ask the question what is this argument and what is its role in the behavior triggered by the <code>HoldOnASecondWhileWeImportYourDatabase</code> method. Seems like it is a user name and we want it to be somewhere in the result of the method. Thus, we can add it to the Statement like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 <span class="dt">var</span> userName = Any.<span class="fu">String</span>();
 
 <span class="co">//WHEN</span>
 trialMessages.
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(userName);

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(<span class="kw">false</span>); <span class="co">//to remember about it</span>
}</code></pre>
<p>Now, this compiles but is evaluated as false because of the guard assertion that we put at the end. Our goal is to substitute it with a real assertion for a real expected result. The return value of the <code>HoldOnASecondWhileWeImportYourDatabase</code> is a string message, so all we need to do is to come up with the message that we expect in case of trial version:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 <span class="dt">var</span> trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 <span class="dt">var</span> userName = Any.<span class="fu">String</span>();
 
 <span class="co">//WHEN</span>
 <span class="dt">var</span> message = trialMessages.
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(userName);

 <span class="co">//THEN</span>
 var expectedMessage = 
  <span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;{0}, better get some pocket money!&quot;</span>, userName);

 Assert.<span class="fu">Equal</span>(expectedMessage, message);
}</code></pre>
<p>and all that is left is to find a good name for the Statement. This isn’t an issue since we already specified the desired behavior in the code, so we can just summarize it as something like <code>ShouldYieldAMessageSayingThatFeatureIsLockedWhenAskedForImportDatabaseMessage</code>.</p>
<h2 id="summary-1"><a href="#summary-1">Summary</a></h2>
<p>These few techniques can be useful when you are stuck and do not know how to start. Note that the examples given are simplistic and assume that there is one object that takes some kind of input parameter and returns a well defined result. This is not how most of the object-oriented world is built. In object oriented world, we have a lot of objects communicating with other objects, sending messages, invoking methods on each other and often having no return values. Do not worry, all of these techniques work in this concept and we’ll be revisiting them as soon as we learn how to do TDD in fully object-oriented world (that is, after we introduce a concept of mock objects). For now, I’m trying to keep it simple.</p>
<h1 id="how-is-tdd-about-analysis-and-what-does-given-when-then-mean"><a href="#how-is-tdd-about-analysis-and-what-does-given-when-then-mean">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</a></h1>
<h2 id="is-there-really-acommonality-between-analysis-and-tdd"><a href="#is-there-really-acommonality-between-analysis-and-tdd">Is there really a commonality between analysis and TDD?</a></h2>
<p>From Wikipedia:</p>
<blockquote>
<p>Analysis is the process of breaking a complex topic or substance into smaller parts to gain a better understanding of it.</p>
</blockquote>
<p>Thus, in order for TDD to be about analysis, it has to fulfill two conditions:</p>
<ol style="list-style-type: decimal">
<li>Be a process of breaking a complex topic into smaller parts</li>
<li>Allow gaining a better understanding of such broken topics</li>
</ol>
<p>In the story about Johnny, Benjamin and Jane, I included a part where they analyze requirements using concrete examples. Johnny explained that this is a part of a technique called Acceptance Test-Driven Development. The process followed by the three characters fulfilled both mentioned conditions for a process to be analytical. But what about TDD itself?</p>
<p>Actually, I used parts of ATDD process in the story to make the analysis part more obvious, but similar things happen at pure technical levels. For example, when starting development with a failing application-wide Statement (we will talk about levels of granularity of Statements later. For now the only thing you need to know is that the so called “unit tests level” is not the only level of granularity we write Statements on), we may encounter a situation where we need to call a web method and assert its result. This makes us think: what should this method be called? What are the scenarios supported? What do I need to get out of it? How should its user be notified about errors? Many times, this leads us to either a conversation (if there is another stakeholder that needs to be involved in the decision) or rethinking our assumptions. This is how we gain a better understanding of the topic we are analyzing, which makes TDD fulfill the first of the two requirements for it to be an analysis method.</p>
<p>But what about the first requirement? What about breaking a complex logic into smaller parts?</p>
<p>If you go back to our example, you will note that both when talking to a customer and when writing code, Johnny and Benjamin used a TODO list. This list was first filled with whatever scenarios they came up with, but later, they would add a smaller unit of work. This is one way complex topics are decomposed into smaller items that all land on the TODO list (the other way is mocking, but we will not get into that yet). Thanks to this, we can focus on one thing at a time, crossing off item after item from the list after it is done. If we learn something new or encounter new issue that needs our attention, we can add it to the TODO list and get back to it later, for now continuing our work on the current point of focus.</p>
<p>An example TODO list from the middle of implementation may look like this (do not read through it, I put it here only to give you a glimpse):</p>
<ol style="list-style-type: decimal">
<li><del>Create entry point to the module (top-level abstraction)</del></li>
<li><del>Implement main workflow of the module</del></li>
<li><del>Implement Message interface</del></li>
<li><del>Implement MessageFactory interface</del></li>
<li>Implement ValidationRules interface</li>
<li><del>Implement behavior required from Wrap method in LocationMessageFactory class</del></li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Speed field</li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Age field</li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
</ol>
<p>Note that some items are already crossed out as done, while other remain undone and waiting to be addressed.</p>
<p>Ok, that is it for the discussion. Now that we are sure that TDD is about analysis, let us focus on the tools we can use to aid and inform it. You already saw both of them in this book, now we are going to have a closer look.</p>
<h2 id="gherkin"><a href="#gherkin">Gherkin</a></h2>
<p>Hungry? Too bad, because the Gkerkin I am gonna talk about is not edible. It is a notation and a way of thinking about behaviors of the specified piece of code. It can be applied on different levels of granularity - any behavior, whether of a whole system or a single class, may be described using it.</p>
<p>We actually talked about Gherkin before in this book, just did not name it. It is the GIVEN-WHEN-THEN structure that you can see everywhere, even in code samples as comments. This time, we are stamping a name on it and analyzing it further.</p>
<p>In Gherkin, a behavior description consists of three parts:</p>
<ol style="list-style-type: decimal">
<li>Given - a context</li>
<li>When - a cause</li>
<li>Then - a effect</li>
</ol>
<p>In other words, the emphasis is on causality in a given context.</p>
<p>As I said, there are different levels you can apply this. Here is an example for such a behavior description from the perspective of its end user (this is called acceptance-level Statement):</p>
<pre><code>Given a bag of tea costs $20
When I buy two of them
Then I should be charged 30$ due to promotion</code></pre>
<p>And here is one for unit-level (note the line starting with “And” that adds to the context):</p>
<pre><code>Given a list with 2 items
When I add another item
And check items count
Then the count should be 3</code></pre>
<p>While on acceptance level we put such behavior descriptions together with code as the same artifact (If this does not ring a bell, look at tools like SpecFlow or Cucumber or FIT to get some examples), on the unit level the description is usually not written down literally, but in form of code only. Still, this structure is useful when thinking about behaviors required from an object or objects, as we saw when we talked about starting from Statement rather than code. I like to put the structure explicitly in my Statements - I find that it makes them more readable. So most of my unit-level Statements follow this template:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">Should__BEHAVIOR__</span>()
{
  <span class="co">//GIVEN</span>
  ...<span class="fu">context</span>...

  <span class="co">//WHEN</span>
  ...<span class="fu">trigger</span>...

  <span class="co">//THEN</span>
  ...<span class="fu">assertions</span> etc....
}</code></pre>
<p>Sometimes the WHEN and THEN sections are not so easily separable - then I join them, like in case of the following Statement specifying that an object throws an exception when asked to store null:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldThrowExceptionWhenAskedToStoreNull</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> safeList = <span class="kw">new</span> <span class="fu">SafeList</span>();

  <span class="co">//WHEN - THEN</span>
  Assert.<span class="fu">Throws</span>&lt;Exception&gt;(
    () =&gt; safeList.<span class="fu">Store</span>(<span class="kw">null</span>)
  );
}</code></pre>
<p>By thinking in terms of these three parts of behavior, we may arrive at different circumstances (GIVEN) at which the behavior takes place, or additional ones that are needed. The same goes for triggers (WHEN) and effects (THEN). If anything like this comes to our mind, we add it to the TODO list.</p>
<h2 id="todo-list-again"><a href="#todo-list-again">TODO list… again!</a></h2>
<p>As we said previously, a TODO list is a repository for anything that comes to our mind when writing or thinking about a Statement, but is not a part o the current Statement we are writing. We do not want to forget it, neither do we want it to haunt us and distract us from our current task, so we write it down as soon as possible and continue with our current task.</p>
<p>Suppose you are writing a piece of small logic that allows user access when he is an employee of a zoo, but denies access if he is a guest of the zoo. Then, after starting writing a Statement it gets to you that actually any employee can be a guest as well - for example, he might choose to visit the zoo with his family during his vacation. Still, the two previous rules hold, so not to allow this case to distract you, you quickly add an item to the TODO list (like “TODO: what if someone is an employee, but comes to the zoo as a guest?”) and finish the current Statement. When you are finished, you can always come back to the list and pick item to do next.</p>
<p>There are two important questions related to TODO lists: “what exactly should we add as a TODO list item?” and “How to efficiently manage the TODO list?”. We will take care of these two questions now.</p>
<h3 id="what-to-put-on-the-todo-list"><a href="#what-to-put-on-the-todo-list">What to put on the TODO list?</a></h3>
<p>Everything that you need addressed but is not part of the current Statement. Those items may be related to implementing unimplemented methods, to add whole functionalities (such items are usually followed my more fine-grained sub tasks as soon as you start implementing the item), there might be reminders to take a better look at something (e.g. “investigate what is this component’s policy for logging errors”) or questions about the domain that need to get answered. If you get carried away too much in coding that you forget to eat, you can even add a reminder (“TODO: get something to eat!”). The list is yours!</p>
<h3 id="how-to-pick-items-from-todo-list"><a href="#how-to-pick-items-from-todo-list">How to pick items from TODO list?</a></h3>
<p>Which item to choose from the TODO list when you have several? I have no clear rule, although I tend to take into account the following factors:</p>
<ol style="list-style-type: decimal">
<li>Risk - if what I learn by implementing or discussing a particular item from the list can have big impact on design or behavior of the system, I tend to pick such items first. An example of such item is that you start implementing validation of a request that arrives to your application and want to return different error depending on which part of the request is wrong. Then, during the development, you discover that more than one part of the request can be wrong at a time and you have to answer yourself a question: which error code should be returned in such case? Or maybe the return codes should be accumulated for all validations and then returned as a list?</li>
<li>Difficulty - depending on my mental condition (how tired I am, how much noise is currently around my desk etc.), I tend to pick items with difficulty that best matches this condition. For example, after finishing an item that requires a lot of thinking and figuring out things, I tend to take on some small and easy items to feel wind blowing in my sails and to rest a little bit.</li>
<li>Completeness - in simplest words, when I finish test-driving an “if” case, I usually pick up the “else” next. For example, after I finish implementing a Statement saying that something should return true for values less than 50, then the next item to pick up is the “greater or equal to 50” case. Usually, when I start test-driving a class, I take items related to this class until I run out of them, then go on to another one.</li>
</ol>
<h3 id="where-to-put-atodo-list"><a href="#where-to-put-atodo-list">Where to put a TODO list?</a></h3>
<p>There are two ways of maintaining a TODO list. The first one is on a sheet of paper, which is nice, but requires you to take your hands off the keyboard, grab a pen or pencil and then get back to coding every time you think of something. Also, the only way a TODO item written on a sheet of paper can tell you which place in code it is related to, is (obviously) by its text.</p>
<p>Another alternative is to use a TODO list functionality built-in into an IDE. Most IDEs, such as Visual Studio (and Resharper plugin has its own enhanced version), Xamarin Studio or eclipse-based IDEs have such functionality. The rules are simple - you put special comments in the code and a special view in your IDE aggregates them for you, allowing you to navigate to each. Such lists are great because:</p>
<ol style="list-style-type: decimal">
<li>They do not force you to take your hands off keyboard to add an item to the list.</li>
<li>You can put such item in a certain place in the code where is makes sense and then navigate back to it with a click of a mouse. This, apart from other advantages, lets you write shorter notes than if you had to do it on paper. For example, a TODO item saying “TODO: what if it throws an exception?” looks out of place on the paper, but when added as a comment to your code in the right place, it is mighty sufficient.</li>
<li>Many TODO lists automatically add items for certain things. E.g. in C#, when you are yet to implement a method that was automatically generated by a tool, its body usually consists of a line that throws a <code>NotImplementedException</code> exception. Guess what - <code>NotImplementedException</code> occurences are added to the TODO list automatically, so we do not have to manually add items to the TODO list for implementing the methods where they occur.</li>
</ol>
<h3 id="expanded-tdd-process-with-atodo-list"><a href="#expanded-tdd-process-with-atodo-list">Expanded TDD process with a TODO list</a></h3>
<p>In one of the previous chapters, I introduced you to the basic TDD process that contained three steps: write unfulfilled Statement, fulfill it and refactor the code. TODO list adds new steps to this process leading to the following list of steps:</p>
<ol style="list-style-type: decimal">
<li>Examine TODO list and pick an item that makes most sense to implement next</li>
<li>Write unfulfilled Statement</li>
<li>Make it unfulfilled for the right reason</li>
<li>Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>
<li>Cross out the item from TODO list</li>
<li>Repeat until no item is left on the TODO list</li>
</ol>
<p>Of course, we are free to add new items to the TODO list as we make progress with the existing ones and at the beginning of each cycle the list is re-evaluated to choose the most important item to implement next taking into account what was added during the previous cycle.</p>
<h3 id="potential-downsides"><a href="#potential-downsides">Potential downsides</a></h3>
<p>There are also some downsides. The biggest is that people often add TODO items for other means than to support TDD and they never go back to such items. Some people joke that a TODO left in the code means “Once, I wanted to…”. Anyway, such items may pollute your TDD-related TODO list with so much cruft that your own items are barely findable. To work around it, I tend to use a different tag than TODO (many IDEs let you define your own tags, or support multiple tag types out of the box. E.g. with Resharper, I like to use “bug” tag, because this is something no one would leave in the code) and filter by it. Another options is, of course, getting rid of the leftover TODO items - if no one addressed it for a year, then probably no one ever will.</p>
<p>Another downside is that when you work with multiple workspaces/solutions, your IDE will gather TODO items only from current solution/workspace, so you will have few TODO lists - one per workspace or solution. Fortunately, this isn’t usually a big deal.</p>
<h1 id="developing-tdd-style-and-constrained-non-determinism"><a href="#developing-tdd-style-and-constrained-non-determinism">Developing TDD style and Constrained Non-Determinism</a></h1>
<p>In one of the first chapters, I introduced to you the idea of anonymous values generator idea, which I have wrapped in a static class called <code>Any</code>. Throughout the next chapters, you have seen me using it quite extensively in many of the Statements I wrote.</p>
<p>The time has come to explain a little bit more carefully what principles lie under this technique and tool. I will also use this technique as a case study to show you how one develops a style of Test-Driven Development.</p>
<h2 id="a-style"><a href="#a-style">A style?</a></h2>
<p>Yep. Why am I wasting your time writing about style instead of giving you the hardcore technical details? The answer is simple. Before I started writing this tutorial, I read four or five books solely on TDD and maybe two others that contain chapters on TDD. All of this sums up to about two or three thousands of paper pages, plus numerous posts on many blogs. And you know what I noticed? No two authors use exactly the same sets of techniques for test-driving their code! I mean, sometimes, when you look techniques they are suggesting, the suggestions from two authorities contradict each other. As each authority has their followers, it is not uncommon to observe and take part in discussions about whether this or that technique is better than a competing one or which one leads to trouble in the long run.</p>
<p>I did this, too. I also tried to understand how come people praise techniques I KNEW were wrong and led to disaster. Then, Finally, I got it. I understood that it is not a “technique A vs. technique B” debate. There are certain sets of techniques that work together and choosing one technique leaves us with issues we have to resolve by adopting other techniques. This is how a style is created.</p>
<p>Developing a style starts with underlying set of principles. These principles lead us to adopt our first technique, which makes us adopt another one and, ultimately, a coherent style emerges. Using Constrained Non-Determinism as an example, I will try to show you how part of a style gets derived from a technique that is derived from a principle.</p>
<h2 id="principle-tests-as-specification"><a href="#principle-tests-as-specification">Principle: Tests As Specification</a></h2>
<p>As I already stressed, I strongly believe that unit tests constitute an executable specification. Thus, they should not only pass input values to an object and assert on the output, they should also convey to their reader the rules according to which objects and functions work. The following oversimplified example shows a Statement where it is not explicitly stated what is the relationship between input and output:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(<span class="st">&quot;MY_HOST_NAME&quot;</span>);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;backup_MY_HOST_NAME.zip&quot;</span>, name);
}</code></pre>
<p>Although the relationship can be guessed quite easily, remember it is just an example. Also, seeing code like that makes me ask questions like: is the “backup_” prefix always applied? What if I actually pass “backup_” instead of “MY_HOST_NAME”? Will the name be “backup_backup_.zip”, or “backup_.zip”? Also, is this object responsible for any validation of passed string?</p>
<p>This makes me invent a first technique to provide my Statements with better support for the principle I believe in.</p>
<h2 id="first-technique-anonymous-input"><a href="#first-technique-anonymous-input">First technique: Anonymous Input</a></h2>
<p>I can wrap the actual value “MY_HOST_NAME” with a method and give it a name that better documents the constraints imposed on it by the specified functionality. In our case, we can pass whatever string we want (the object is not responsible for input validation), so we will name our method <code>AnyString()</code>:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;backup_MY_HOST_NAME.zip&quot;</span>, name);
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>By using <strong>anonymous input</strong>, we provide a better documentation of the input value. Here, I wrote <code>AnyString()</code>, but of course, there can be a situation where I use more constrained data, e.g. <code>AnyAlphaNumericString()</code> when I need a string that does not contain any characters other than letters and digits. Note that this technique <strong>is applicable only when the particular value of the variable is not important, but rather its “trait”</strong>. Taking authorization as an example, when a certain behavior occurs only when the input value is <code>Users.Admin</code>, there is <strong>no sense</strong> making it anonymous. On the other hand, for a behavior that occurs for all values other than <code>Users.Admin</code>, it makes sense to use a method like <code>AnyUserOtherThan(Users.Admin)</code> or even <code>AnyNonAdminUser()</code>.</p>
<p>Now that the Statement itself is freed from the knowledge of the concrete value of <code>hostName</code> variable, the concrete value of “backup_MY_HOST_NAME.zip” looks kinda weird. There is no clear indication of the kind of relationship between input and output and whether there is any at all (one may reason whether the output is always the same string or maybe it depends on the string length). It is unclear which part is added by the production code and which part depends on the input we pass to the method. This leads us to another technique.</p>
<h2 id="second-technique-derived-values"><a href="#second-technique-derived-values">Second technique: Derived Values</a></h2>
<p>To better document the relationship between input and output, we have to simply derive the expected value we assert on from the input value. Here is the same Statement with the assertion changed:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    <span class="dt">string</span>.<span class="fu">Format</span>(<span class="st">&quot;backup_{0}.zip&quot;</span>, hostName),
    name);
}
<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>This looks more like a part of specification, because we are documenting the format of the backup file name and show which part of the format is variable and which part is fixed. This is something you would probably find documented in a paper specification for the application you are writing - it would probably contain a sentence saying: “The format of a backup file should be <strong>backup_H.zip</strong>, where <strong>H</strong> is the current local host name”.</p>
<p><strong>Derived values</strong> are about defining expected output in terms of the input that was passed to provide a clear indication on what is the “transformation” of the input required of the specified production code.</p>
<h2 id="third-technique-distinct-generated-values"><a href="#third-technique-distinct-generated-values">Third technique: Distinct Generated Values</a></h2>
<p>Let us assume that some time after our initial version is shipped, we are asked to make the backup feature applied locally per user only for this user’s data. As the customer does not want to confuse files from different users, we are asked to add name of the user doing backup to the backup file name. Thus, the new format is “backup_H_U.zip”, where H is still the host name and U is the user name. Our Statement for the pattern must change as well to include this information. Of course, we are trying to use the anonymous input again as a proven technique and we end up with:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> userName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dt">string</span>.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>Now, we can clearly see that there is something wrong with this Statement. AnyString() is used twice and each time it returns the same value, which means that evaluating the Statement does not give us any guarantee, that both values are applied and that they are applied in the correct places. For example, the Statement will be evaluated to true when user name is used instead of host name in specified production code. This means that if we still want to use the anonymous input effectively, we have to make the two values distinct, e.g. like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> userName = <span class="fu">AnyString2</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dt">string</span>.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString2</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_USER_NAME&quot;</span>;
}</code></pre>
<p>We solved the problem (for now) by introducing another helper method. However, this, as you can see, is not a very scalable solution. Thus, let us try to reduce the amount of helper methods for string generation to one and make it return a different value each time:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> userName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dt">string</span>.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> Guid.<span class="fu">NewGuid</span>.<span class="fu">ToString</span>();
}</code></pre>
<p>This time, we are not returning an understandable string, but rather a guid, which gives us the fairly strong guarantee of generating distinct value each time. The string not being understandable (contrary to something like “MY_HOST_NAME”) may leave you worried that maybe we are losing something, but hey, didn’t we say <strong>Any</strong>String()?</p>
<p><strong>Distinct generated values</strong> means that each time we need a value of a particular type, we get something different (if possible) than the last time and each value is generated automatically using some kind of heuristics.</p>
<h2 id="fourth-technique-constant-specification"><a href="#fourth-technique-constant-specification">Fourth technique: Constant Specification</a></h2>
<p>Let us consider another modification that we are requested to make - this time, the backup file name needs to contain version number of our application as well. Remembering that we want to use Derived Values, we will not hardcode the version number into our Statement. Instead, we are going to use a constant that is already defined somewhere else in the application (this way we also avoid duplication of this version number across the application):</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserNameAndVersion</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> hostName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> userName = <span class="fu">AnyString</span>();
  <span class="dt">var</span> fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    <span class="dt">string</span>.<span class="fu">Format</span>(
      <span class="st">&quot;backup_{0}_{1}_{2}.zip&quot;</span>, 
      hostName, userName, Version.<span class="fu">Number</span>),
    name);
}

<span class="kw">public</span> <span class="dt">string</span> <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> Guid.<span class="fu">NewGuid</span>.<span class="fu">ToString</span>();
}</code></pre>
<p>Note that I didn’t use the literal constant value, but rather, the value inside the <code>Version.Number</code> constant. This allows us to use derived value, but leaves us a little worried about whether the value of the constant is correct - after all, we are using it for creation of our expected value, but it is a part of production code - i.e. is something that should be specified itself!</p>
<p>To keep everyone happy, we write a single Statement just for the constant to specify what the value should be:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldContainNumberEqualTo1_0</span>()
{
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;1.0&quot;</span>, Version.<span class="fu">Number</span>);
}</code></pre>
<p>By doing so, we make the value in the production code just echo what is in our executable Specification, which we can fully trust.</p>
<h2 id="summary-of-the-example"><a href="#summary-of-the-example">Summary of the example</a></h2>
<p>In this example, I tried to show you how a style can evolve from the principles you value when doing TDD. I did so for two reasons:</p>
<ol style="list-style-type: decimal">
<li>To introduce to you a set of techniques I personally use and recommend and to do it in a fluent and logical way.</li>
<li>To help you better communicate with people that are using different styles. Instead of just throwing “you are doing it wrong” at them, try to understand their principles and how their techniques of choice support those principles.</li>
</ol>
<p>Now, let us take a quick summary of all the techniques introduced in example:</p>
<dl>
<dt>Anonymous Input</dt>
<dd>moving the output out of the Statement code and hide it behind a method that to emphasize the constrain on the data used rather than what is its value
</dd>
<dt>Derived Values</dt>
<dd>defining expected output in terms of the input in order to document the relationship between input and output
</dd>
<dt>Distinct Generated Values</dt>
<dd>When using Anonymous Input, generate a distinct value each time (in case of types that have very few values, like boolean, try at least not to generate the same value twice in a row) in order to make the Statement more reliable.
</dd>
<dt>Constant Specification</dt>
<dd>Write a separate Statement for a constant and use the constant instead of its literal value in all other Statements to create a Derived Value.
</dd>
</dl>
<h2 id="constrained-non-determinism"><a href="#constrained-non-determinism">Constrained non-determinism</a></h2>
<p>When we combine anonymous input together with distinct generated values, we get something that is called <strong>Constrained Non-Determinism</strong>. This is a term coined by Mark Seemann and basically means three things:</p>
<ol style="list-style-type: decimal">
<li>Values are anonymous i.e. we do not know the actual value we are using</li>
<li>The values are generated in as distinct as possible sequence (which means that, whenever possible, no two values generated one after another hold the same value)</li>
<li>The non-determinism in generation of the values is constrained, which means that the algorithms for generating values are carefully picked in order to provide values that are not special in any way (e.g. when generating integers, we do not allow generating ‘0’ as it is usually a special-case-value)) and that are not “evil” (e.g. for integers, we generate small positive values first and go with bigger numbers only when we run out of those small ones).</li>
</ol>
<p>There are multiple ways to implement constrained non-determinism. Mark Seemann himself has invented the AutoFixture library for C# that is <a href="https://github.com/AutoFixture/AutoFixture">freely available to download</a>. Here is a shortest possible snippet to generate an anonymous integer using AutoFixture:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">Fixture fixture = <span class="kw">new</span> <span class="fu">Fixture</span>();
<span class="dt">var</span> anonymousInteger = fixture.<span class="fu">Create</span>&lt;<span class="dt">int</span>&gt;();</code></pre>
<p>I, after Amir Kolsky and Scott Bain, like to use Any class as seen in the previous chapters of this book. Any takes a slightly different approach than AutoFixture (although it uses AutoFixture internally). My implementation of Any class is <a href="https://github.com/grzesiek-galezowski/tdd-toolkit">available to download as well</a>.</p>
<h2 id="summary-2"><a href="#summary-2">Summary</a></h2>
<p>That was a long ride, wasn’t it? I hope that this chapter, gave you some understanding of how different TDD styles came into existence and why I use some of the techniques I do (and how these techniques are not just a series of random choices). In the next chapters, I will try to introduce some more techniques to help you grow a bag of neat tricks - a coherent style.</p>
<h1 id="what-is-the-scope-of-aunit-level-statement-in-tdd"><a href="#what-is-the-scope-of-aunit-level-statement-in-tdd">What is the scope of a unit-level Statement in TDD?</a></h1>
<p>Ha, now I have to admit that I deferred for a long time an answer to a pretty fundamental question: what should be the scope of a single Statement? If I put the whole system together, can I write a Statement for its behavior? Or maybe the other way round - there should be a Statement for each method of each class, including the private ones? Well, first thing I want to explain is that there are multiple levels we can write our Statements on. This varies depending on the TDD authority, but in this book, we will cover two of such levels - unit level and acceptance level. For now, let us stick to the unit level, which is what we have done so far anyway. The time will come for the rest.</p>
<p>For unit level, let us consider the kind of Statements that you already saw in this book - where we take one object, invoke a method on it and assert on the result. This is actually a special case of unit-level Statement and we will cover more in the coming chapters. This is, however, a good moment to stop and consider the “scope” of a single unit-level Statement in TDD. Is it method scope? Class scope? Feature scope?</p>
<p>Let us try to answer the question by examining some TDD unit-level Statements:</p>
<h3 id="u06f9b4ca-3b63-475d-81e5-3c2690472b97" class="sigil_not_in_toc"><a href="#u06f9b4ca-3b63-475d-81e5-3c2690472b97">Is it class scope?</a></h3>
<p>Let us see the first example and try to answer this question:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldThrowValidationExceptionWithFatalErrorLevelWhenValidatedStringIsEmpty</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> emptyString = <span class="dt">string</span>.<span class="fu">Empty</span>;
  <span class="dt">var</span> validation = <span class="kw">new</span> <span class="fu">Validation</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> exceptionThrown = Assert.<span class="fu">Throws</span>&lt;CustomException&gt;(
    () =&gt; validation.<span class="fu">Perform</span>(emptyString) 
  );
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(exceptionThrown.<span class="fu">IsFatalError</span>);
}</code></pre>
<p>This is an example of a well-written unit-level Statement. Ok, so let us see… how many real classes take part in this spec? Three: a string, an exception and the validation. So the class scope is not the most accurate description.</p>
<h3 id="ub669df36-50ac-404a-bcdd-bc0e64845b4b" class="sigil_not_in_toc"><a href="#ub669df36-50ac-404a-bcdd-bc0e64845b4b">Or a method scope?</a></h3>
<p>So, maybe the scope covers a single method, meaning a Statement always exercises one method of a specified object?</p>
<p>Let us consider the following example:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldBeFulfilledWhenEventOccursThreeTimes</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> rule = <span class="kw">new</span> <span class="fu">FullQueueRule</span>();
  rule.<span class="fu">Queued</span>();
  rule.<span class="fu">Queued</span>();

  <span class="co">//WHEN</span>
  rule.<span class="fu">Queued</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(rule.<span class="fu">IsFulfilled</span>());
}</code></pre>
<p>Count with me: how many methods are called? Depending on how we count, it is two (<code>Queued()</code> and <code>IsFulfilled()</code>) or four (<code>Queued(), Queued(), Queued(), IsFulfilled()</code>). In any case, not one. So it is not method scope either.</p>
<h3 id="it-is-the-scope-of-class-behavior"><a href="#it-is-the-scope-of-class-behavior">It is the scope of class behavior!</a></h3>
<p>The proper answer is: behavior! Each TDD Statement specifies a single behavior. I like how <a href="http://sustainabletdd.com">Amir Kolsky and Scott Bain</a> phrase it, by saying that each unit-level Statement should “introduce a behavioral distinction not existing before”.</p>
<p>It may look that “behavior” scope is actually broader than method or class levels, since such Statement can span multiple classes and multiple methods. This is only partially true. That is because e.g. Statements with method scope can span multiple behaviors (which, by the way, is a sign of poorly written Statement). Let us take a look at an example:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReportItCanHandleStringWithLengthOf3ButNotOf4AndNotNullString</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> bufferSizeRule = <span class="kw">new</span> <span class="fu">BufferSizeRule</span>();
  
  <span class="co">//WHEN</span>
  var resultForLength3 
    = bufferSizeRule.<span class="fu">CanHandle</span>(Any.<span class="fu">StringOfLength</span>(<span class="dv">3</span>));
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(resultForLength3);

  <span class="co">//WHEN again?</span>
  var resultForLength4 
    = bufferSizeRule.<span class="fu">CanHandle</span>(Any.<span class="fu">StringOfLength</span>(<span class="dv">4</span>))
  <span class="co">//THEN again?</span>
  Assert.<span class="fu">False</span>(resultForLength4);

  <span class="co">//WHEN again??</span>
  <span class="dt">var</span> resultForNull = bufferSizeRule.<span class="fu">CanHandle</span>(<span class="kw">null</span>);
  <span class="co">//THEN again??</span>
  Assert.<span class="fu">False</span>(resultForNull);
}</code></pre>
<p>Note that it specifies three (or two - depending on how you count) behaviors: acceptance of string of allowed size, refusal of handling string above the allowed size and a special case of null string. As I said - this is an antipattern and is sometimes called a “check-it-all test”. The issue with this kind of Statement is that it can be evaluated to false for at least two reasons - when the allowed string size changes and when null handling is done in another way. Also, xUnit tools by default stop execution on first error, so, assuming that the first assertion fails, we will not know the outcome of the next assertion unless we fix the previous one (does that mean we have to use a single <code>Assert</code> per Statement? We will take care of this question later. For now, let the answer be: “not necessarily”).</p>
<p>On the other hand, Statements with behavior scope do not necessary have to be broader than those with class scope. Let us take the following example that proves it:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldReportItIsStartedAndItDoesNotYetTransmitVoiceWhenItStarts</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> call = <span class="kw">new</span> <span class="fu">DigitalCall</span>();
  call.<span class="fu">Start</span>();
 
  <span class="co">//WHEN</span>
  <span class="dt">var</span> callStarted = call.<span class="fu">IsStarted</span>;
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(callStarted);

  <span class="co">//WHEN-THEN</span>
  Assert.<span class="fu">Throws</span>&lt;Exception&gt;(
    () =&gt; call.<span class="fu">Transmit</span>(Any.<span class="fu">InstanceOf</span>&lt;Frame&gt;())
  );
}</code></pre>
<p>Again, there are two behaviors here: reporting the call status after start and not being able to transmit frames after start. That is why this test should be split into two.</p>
<p>How to catch that you are writing a Statement about two or more behaviors rather than one? First, take a look at the test name - if it looks strange and contains some “And” or “Or” words, it may (but does not have to) be about more than one behavior. Another way is to write the description of a behavior in a Given-When-Then way. If you have more than one item in the “When” section or the structure is not Given-When-Then, but rather a “Given-When-Then-When-Then” - that is also a signal.</p>
<h1 id="specifying-boundaries-and-conditions"><a href="#specifying-boundaries-and-conditions">Specifying Boundaries and Conditions</a></h1>
<div class="disclaimer">
<h3><a href="#a-disclaimer">A Disclaimer</a></h3>
Before I begin, I have to admit that this chapter is mostly based on the material from a series of posts by Scot Bain and Amir Kolsky from the blog Sustainable Test Driven Development and their upcoming book by the same title. I like their idea of boundaries so much that I just follow the guidelines they outlined. This chapter is going to be a rephrase of these guidelines. I placed it here so that you have all the important topics covered in one place, but I encourage you to read the original blog posts on this subject on http://www.sustainabletdd.com (and the upcoming book).
</div>
<h2 id="sometimes-anonymous-value-is-not-enough"><a href="#sometimes-anonymous-value-is-not-enough">Sometimes, Anonymous Value Is Not Enough</a></h2>
<p>When we specify a behavior, there are times when this behavior should be the same no matter what arguments we pass to the constructor or invoked methods. An example would be an addition of two numbers - whatever numbers we would supply, the answer would always be a sum of those numbers:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldCalculateTheSumOfTwoNumbers</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> a = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> b = Any,<span class="fu">Integer</span>();
  
  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = <span class="kw">new</span> <span class="fu">Sum</span>().<span class="fu">Of</span>(a, b);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(a + b, result);
}</code></pre>
<p>In this case, the integer numbers can really be “any” - the described relationship between input and output is independent of the actual values we use. As indicated in one of the previous chapters, this is the canonical case where Constrained Non-Determinism applies.</p>
<p>Sometimes, however, objects exhibit different behaviors based on what is passed to their constructor and to their methods (OK, we also have static methods and singletons. Longer discussion on those will be included in one of the next chapters - for now we can safely ignore them). For example, in our application we may have a licensing policy where a feature is allowed to use only if the license is valid, and denied after it has expired. Another example would be that some shops are open from 10:00 to 18:00, so if we had a query in our application whether the shop is currently open, we would expect it to be answered differently based on what the current time is.</p>
<p>In such cases, Scott and Amir offer us other guidelines for choosing input values.</p>
<h2 id="exceptions-to-the-rule"><a href="#exceptions-to-the-rule">Exceptions To The Rule</a></h2>
<p>There are times, when a Statement is true for every value except one (or more) explicitly specified. For example, in Poland, high school students are graded for exams between “mediocre” and “very good”. Every grade means the exam is passed except for “mediocre” grade which means the exam is failed. If we imagine we have to specify an object that decides whether the exam is passed based on rating, we would have to write two Statements: one for the mediocre rating and other for all the others.</p>
<p>Here is the Statement for mediocre grade (let us imagine that all grades are members of an enum):</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotPassTheExamWhenGradeIsMediocre</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> decision = <span class="kw">new</span> <span class="fu">PassOrNotDecision</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> examPassed = decision.<span class="fu">MakeBasedOn</span>(Grades.<span class="fu">Mediocre</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">False</span>(examPassed);
}</code></pre>
<p>Note that here, we used the literal value of <code>Grades.Mediocre</code>. This is because no other value gives the same behavior as this one, so generating the value would not make any sense.</p>
<p>The second Statement is for all the other cases. Here, we are going to use another method of the <code>Any</code> class for generating ay enum member other than specified:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldPassTheExamWhenGradeIsOtherThanMediocre</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> decision = <span class="kw">new</span> <span class="fu">PassOrNotDecision</span>();

  <span class="co">//WHEN</span>
  var examPassed 
    = decision.<span class="fu">MakeBasedOn</span>(Any.<span class="fu">Besides</span>(Grades.<span class="fu">Mediocre</span>));
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(examPassed);
}</code></pre>
<p>Here, <code>Any.Besides()</code> takes care of the enum value generation, producing a nice, readable code as a side effect.</p>
<p>The example shown above assumes there is only one exception to the rule (the mediocre grade). However, this concept can be scaled up to more values, as long as it is a finished, discrete set. If there are multiple exceptional values that produce the same behavior, a single Statement is sufficient to cover them all (using <code>Any</code> class and making the following call for exception Statement: <code>Any.Of(value1, value2)</code> and the following for the rest: <code>Any.OtherThan(value1, value2)</code>). However, when there are multiple exceptions to the rule and each one triggers a different behavior, each one deserves its own Statement.</p>
<h2 id="rules-valid-within-boundaries"><a href="#rules-valid-within-boundaries">Rules Valid Within Boundaries</a></h2>
<p>Sometimes, a behavior varies around a numerical boundary. the simplest example would be a set of rules on how to calculate an absolute value of a number:</p>
<ol style="list-style-type: decimal">
<li>for any X less than 0, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>
<li>for any X greater or equal to 0, the result is X (e.g. absolute value of 3 is 3).</li>
</ol>
<p>As you can see, there is a boundary between the two behaviors and the right edge of the boundary is 0. Why do I say “right edge”? That is because the boundary always has two edges and there’s a length between them. If we assume we are talking about the mentioned absolute value calculation and that our numerical domain is that of integer numbers, we can as well use -1 as edge value and say that:</p>
<ol style="list-style-type: decimal">
<li>for any X less or equal to -1, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>
<li>for any X greater than -1, the result is X (e.g. absolute value of 3 is 3).</li>
</ol>
<p>So a boundary is not a single number - it always has a length - the length between last value of the previous behavior and the first value of the next behavior. In case of our example, the length between -1 (left edge - last negated number) and 0 (right edge - first non-negated) is 1.</p>
<p>Now, imagine that we are not talking about integer values anymore, but about floating point values. Then the right edge value would still be 0. But what about left edge? It would not be possible for it to stay -1, because the rule applies to e.g. -0.9 as well. So what is the correct right edge value and the correct length of the boundary? Would the length be 0.1? Or 0.001? Or maybe 0.00000001? This is harder to answer and depends heavily on the context, but it is something that must be answered for each particular case - this way we know what kind of precision is expected of us. In our Specification, we have to document the boundary length somehow.</p>
<p>So the next topic is: how to describe the boundary length with Statements? To illustrate this, I want to show you two Statements assuming we’re implementing the mentioned absolute value calculation for integers. The first Statement is for values smaller than 0 and we want to use the left edge value here ilke this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNegateTheNumberWhenItIsLessThan0</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  <span class="dt">var</span> lessThan0 = <span class="dv">0</span> - <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = function.<span class="fu">PerformFor</span>(lessThan0);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(-lessThan0, result);
}</code></pre>
<p>And the next Statement for values at least 0 and we want to use the right edge value:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotNegateTheNumberWhenItIsGreaterOrEqualTo0</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  <span class="dt">var</span> moreOrEqualTo0 = <span class="dv">0</span>;

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = function.<span class="fu">PerformFor</span>(moreOrEqualTo0);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(moreOrEqualTo0, result);
}</code></pre>
<p>There are two things to note about these examples. The first one is that we don’t use any kind of <code>Any</code> methods. We explicitly take the edges, because they’re the numbers that most strictly define the boundary. This way we document the boundary length.</p>
<p>It is important to understand why we are not using methods like <code>Any.IntegerGreaterOrEqualTo(0)</code>, even though we do use <code>Any</code> in case when we have no boundary. This is because in the latter case, no value is better than the other in any particular way. In case of boundaries, however, the edge values are better in that they more strictly define the boundary and drive the right implementation.</p>
<p>The second thing to note is the usage of literal constant 0 in the above example. In one of the previous chapter, I showed you a technique called <strong>Constant Specification</strong>, where we write an explicit Statement about the value of the named constant and use the named constant everywhere else instead of its literal. So why did i not use this technique?</p>
<p>The only reason is that this might have looked a little bit silly with such extremely trivial example as calculating absolute value. In reality, I should have used the named constant in both Statements and it would show the boundary length even more clearly. Actually, let us perform this exercise now and see what happens.</p>
<p>First, let us document the named constant:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldIncludeSmallestValueNotToNegateSetToZero</span>()
{
  Assert.<span class="fu">Equal</span>(<span class="dv">0</span>, Constants.<span class="fu">SmallestValueNotToNegate</span>);
}</code></pre>
<p>Now we have got everything we need to rewrite the two Statements we wrote earlier. The first would look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNegateTheNumberWhenItIsLessThanSmallestValueNotToNegate</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  var lastNumberToNegate 
    = Constants.<span class="fu">SmallestValueNotToNegate</span> - <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = function.<span class="fu">PerformFor</span>(lastNumberToNegate);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(-lastNumberToNegate, result);
}</code></pre>
<p>And the second Statement for values at least 0:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotNegateNumberWhenItIsGreaterOrEqualToSmallestValueNotToNegate</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = function.<span class="fu">PerformFor</span>(
    Constants.<span class="fu">SmallestValueNotToNegate</span>
  );

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    Constants.<span class="fu">SmallestValueNotToNegate</span>, result);
}</code></pre>
<p>As you can see, the first Statement contains the following expression: <code>Constants.SmallestValueNotToNegate - 1</code>, where 1 is the exact length of the boundary. Like I said, the situation is so trivial that it may look silly and funny, however, in real life scenarios, this is a great technique to apply anytime, anywhere.</p>
<p>Boundaries may look like they apply only to integer input, but they occur at many other places. There are boundaries associated with date/time (e.g. an action is performed again when time from last action is at least 30 seconds - the decision would need to be made whether we need precision in seconds or maybe in ticks), to strings (e.g. validation of user name where it must be at least 2 characters, or password that must contain at least 2 special characters) etc.</p>
<h2 id="combination-of-boundaries---ranges"><a href="#combination-of-boundaries---ranges">Combination of Boundaries - Ranges</a></h2>
<p>So, what about a behavior that is valid in a range? Let us assume that we live in a country where a citizen can get a driving license only after their 17th birthday, but before 65th (the government decided that people after 65 have worse sight and it’s safer not to give them new driving licenses). Let us also assume that we try to develop a class that answers the question whether we can apply for driving license and the return values of this query are as follows:</p>
<ol style="list-style-type: decimal">
<li>Age &lt; 17 - returns enum value <code>QueryResults.TooYoung</code></li>
<li>17 &lt;= age &gt;= 65 - returns enum value <code>QueryResults.AllowedToApply</code></li>
<li>Age &gt; 65 - returns enum value <code>QueryResults.TooOld</code></li>
</ol>
<p>Now, remember I told you that we specify the behaviors near boundaries? This, however, when applied to the situation I just described, would give us the following Statements:</p>
<ol style="list-style-type: decimal">
<li>Age = 17, should yield result <code>QueryResults.TooYoung</code></li>
<li>Age = 18, should yield result <code>QueryResults.AllowedToApply</code></li>
<li>Age = 65, should yield result <code>QueryResults.AllowedToApply</code></li>
<li>Age = 66, should yield result <code>QueryResults.TooOld</code></li>
</ol>
<p>thus, we would describe the behavior where the query should return <code>AllowedToApply</code> value twice, which effectively means that we would copy-paste the Statement and change just one value. How do we deal with this? Thankfully, we have a solution available:</p>
<p>Most xUnit frameworks provide some kind of data-driven test functionality, which we can use to write parameterized Statements. The functionality basically means that we can write the code of the Statement once, but make the xUnit framework invoke it twice with different sets of input values. Let’s see an example in XUnit.net:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Theory]
[<span class="fu">InlineData</span>(<span class="dv">17</span>, QueryResults.<span class="fu">TooYoung</span>)]
[<span class="fu">InlineData</span>(<span class="dv">18</span>, QueryResults.<span class="fu">AllowedToApply</span>)]
[<span class="fu">InlineData</span>(<span class="dv">65</span>, QueryResults.<span class="fu">AllowedToApply</span>)]
[<span class="fu">InlineData</span>(<span class="dv">66</span>, QueryResults.<span class="fu">TooOld</span>)]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldYieldResultForAge</span>(<span class="dt">int</span> age, QueryResults expectedResult)
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> query = <span class="kw">new</span> <span class="fu">DrivingLicenseQuery</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = query.<span class="fu">ExecuteFor</span>(age);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(expectedResult, result);
}</code></pre>
<p>This way, there is only one Statement executed four times. The case of <code>AllowedToApply</code> is still evaluated twice for both edge cases (so there is more time spent on executing it, which for small cases is not an issue), but the code maintenance issue is gone - we don’t have to copy-paste the code to specify both edges of the behavior.</p>
<p>Note that we’re quite lucky because the specified logic is strictly functional (i.e. returns different results based on different inputs). Thanks to this, we could parameterize input values together with expected results. This is not always the case. For example, let us imagine that we have a clock class where we can set alarm time. The class allows us to set hour between 0 and 24, but otherwise throws an exception.</p>
<p>While some xUnit frameworks, like NUnit, allow us to handle both cases with one Statement by writing something like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//NOTE: this is an example in NUnit framework!</span>
[<span class="fu">TestCase</span>(Hours.<span class="fu">Min</span>, Result=Hours.<span class="fu">Min</span>)]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Max</span>, Result=Hours.<span class="fu">Max</span>)]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Min</span><span class="dv">-1</span>, ExpectedException = <span class="kw">typeof</span>(OutOfRangeException))]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Max</span><span class="dv">+1</span>, ExpectedException = <span class="kw">typeof</span>(OutOfRangeException))]
<span class="kw">public</span> <span class="dt">int</span> 
<span class="fu">ShouldBeAbleToSetHourBetweenMinAndMaxButNotOutsideThatRange</span>(
  <span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> clock = <span class="kw">new</span> <span class="fu">Clock</span>();
  clock.<span class="fu">SetAlarmHour</span>(inputHour);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> setHour = clock.<span class="fu">GetAlarmHour</span>();

  <span class="co">//THEN</span>
  <span class="kw">return</span> setHour;
}</code></pre>
<p>Others, like XUnit.NET, don’t (not that it’s a defect of the framework, it’s just that the philosophy behind those two is a little bit different and that some features have hidden price attached to their usage which some frameworks are willing to pay, while others aren’t). Thus, we have to solve it by writing two parameterized Statements - one where a value is returned (for valid cases) and one where exception is thrown (for invalid cases). The first would look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Theory]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Min</span>)]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Max</span>)]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldBeAbleToSetHourBetweenMinAndMax</span>(<span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> clock = <span class="kw">new</span> <span class="fu">Clock</span>();
  clock.<span class="fu">SetAlarmHour</span>(inputHour);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> setHour = clock.<span class="fu">GetAlarmHour</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(inputHour, setHour);
}</code></pre>
<p>and the second:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Theory]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Min</span><span class="dv">-1</span>)]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Max</span><span class="dv">+1</span>)]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldThrowOutOfRangeExceptionWhenTryingToSetAlarmHourOutsideValidRange</span>(
  <span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> clock = <span class="kw">new</span> <span class="fu">Clock</span>();

  <span class="co">//WHEN - THEN</span>
  Assert.<span class="fu">Throws</span>&lt;OutOfRangeException&gt;( 
    ()=&gt; clock.<span class="fu">SetAlarmHour</span>(inputHour)
  );
}</code></pre>
<h2 id="summary-3"><a href="#summary-3">Summary</a></h2>
<p>In this chapter, we covered specifying numerical boundaries with a minimal amount of code, so that the Specification is more maintainable and runs fast. There is one more kind of situation left: when we have compound conditions (e.g. a password must be at least 10 characters and contain at least 2 special characters) - we’ll get back to those when we introduce mocks.</p>
<h1 id="triangulation"><a href="#triangulation">Triangulation</a></h1>
<div class="disclaimer">
(The first occurence of the term triangulation I know about is in Kent Beck’s book <a href="http://www.pearsonhighered.com/educator/product/Test-Driven-Development-By-Example/9780321146533.page">Test Driven Development: By Example</a>).
</div>
<p>As one of the last topics of the core TDD techniques that do not require us to delve into the object oriented world, I’d like to show you triangulation.</p>
<p>Triangulation is often described as the most conservative of three approaches of test-driving implementation. These approaches are:</p>
<ol style="list-style-type: decimal">
<li>Type the obvious implementation</li>
<li>Fake it (‘til you make it)</li>
<li>Triangulate</li>
</ol>
<p>All of these techniques are simple (triangulaion being a little more complex), so I’ll show you all of them one by one, putting more emphasis on triangulation:</p>
<h2 id="type-the-obvious-implementation"><a href="#type-the-obvious-implementation">Type The Obvious Implementation</a></h2>
<p>The first of the three techniques is just writing an obvious implementation in response to a Statetement. If the implementation is simple, this approach makes a lot of sense. Let’s take a trivial example of adding two numbers:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = sum.<span class="fu">Of</span>(<span class="dv">3</span>,<span class="dv">5</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">8</span>, result);
}</code></pre>
<p>You may remember I told you that usually we write the simplest production code that would make the Statement true. This rule would encourage us to just return 8 from the <code>Of</code> method, because it would be sufficient to make the Statement true. Instead, we can decide that the logic is so obvious, that we can just write it based on this one Statement:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a+b;
  }
}</code></pre>
<p>and this is it.</p>
<p>Note that I didn’t use Constrained Non-Determinism here, because its use enforces using “Just write obvious implementation” technique. In fact, most (if not all) Statements we wrote so far in previous chapters, uses this approach because of this fact. Let’s take a look at how the above Statement would look if we used Constrained Non-Determinism:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> a = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> b = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = sum.<span class="fu">Of</span>(a,b);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(a + b, result);
}</code></pre>
<p>Here, we don’t have any choice. The most obvious implementation that would make this Statement true is the correct implementation. We are unable to return some constant value as we previously could (but we did not), because we just don’t know what the expected result is and it is strictly dependent on the input values which we don’t know as well.</p>
<h2 id="fake-it-til-you-make-it"><a href="#fake-it-til-you-make-it">Fake It (‘Til You Make It)</a></h2>
<p>This technique is kind of funny. I do not recall myself ever using it, but it is so interesting I want to show it to you anyway. It is so simple you will not regret these few minutes even if just for broadening your horizons.</p>
<p>There are two core things that we need to pay attention when using these technique:</p>
<ol style="list-style-type: decimal">
<li>Start with the simplest implementation possible (i.e. fake it), which usually is returning a literal constant. Then gradually transform the code of both Statement and implementation using variables</li>
<li>When doing it, rely on your sense of duplication between Statement and (fake) implementation</li>
</ol>
<p>Let us apply Fake It to the same addition example as before (I promise, for triangulation, I will give you better one). The Statement looks the same as before:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = sum.<span class="fu">Of</span>(<span class="dv">3</span>,<span class="dv">5</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">8</span>, result);
}</code></pre>
<p>Only this time, we are going to use the simplest implementation possible. As I wrote, this simplest implementation is almost always to return a constant:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> <span class="dv">8</span>;
  }
}</code></pre>
<p>The Statement evaluates to true (green) now, though the implementation is obviously wrong. BUT, the TDD cycle is not over yet. Remember that as soon as the Statement is true, refactoring phase kicks in. This is something we were ignoring silently for now (and here we will only slightly lick it). We can use the refactoring phase to remove duplication between the Statement and the implementing code.</p>
<p>First, let us note that the number 8 is duplicated between Statement and implementation - the implementation returns it and the Statement asserts on it. To reduce this duplication, let us break the 8 in the implementation into a sum:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> <span class="dv">3</span> + <span class="dv">5</span>;
  }
}</code></pre>
<p>Note the smart trick I did. I changed duplication between implementation and expected result to duplication between implementation and input values of the Statement. After all, 3 and 5 are the exact values I used in the Statement, right? This kind of duplication is different in that it can be removed using variables (this applies not only to input variables, but basically anything we have access to prior to triggering specified behavior - constructor parameters, fields etc. in contrast to result which we normally do not know until we invoke the behavior). The duplication of number 3 can be eliminated this way:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a + <span class="dv">5</span>;
  }
}</code></pre>
<p>and we have just the number 5 duplicated, because we used variable to transfer the value of 3 from Statement method to the <code>Of</code> implementation, so we have it in one place now. Let us do the same with 5:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a + b;
  }
}</code></pre>
<p>And that’s it. I used a trivial example, since I don’t want to spend too much time on this, but you can find more advanced ones in Kent Beck’s book if you like.</p>
<h2 id="triangulation-1"><a href="#triangulation-1">Triangulation</a></h2>
<p>As I wrote, triangulation is the most conservative technique, because following it involves the tiniest possible steps to arrive at the right solution. The technique is called triangulation by analogy to <a href="http://encyclopedia2.thefreedictionary.com/radar+triangulation">radar triangulation</a> where outputs from at least two radars must be used to determine the position of a unit. Also, in radar triangulation, the position is measured indirectly, by combining the following data: range (not position!) between two radars, measurement done by each radar and the positions of the radars (which we know, because we are the ones who put the radars there). From this data, we can derive a triangle, so we can use trigonometry to calculate the position of the third point of the triangle, which is the desired position of the unit (two remaining points are the positions of radars). Such measurement is indirect in nature, because we do not measure the position directly, but calculate it from other helper measurements.</p>
<p>These two characteristics: indirect measurement and using at least two sources of information are at the core of TDD triangulation. Basically, it says:</p>
<ol style="list-style-type: decimal">
<li><strong>Indirect measurement</strong>: derive the design from few known examples of its desired external behavior by looking at what varies in these examples and making this variability into something more general</li>
<li><strong>Using at least two sources of information</strong>: start with the simplest possible implementation and make it more general <strong>only</strong> when you have two or more different examples (i.e. Statements that describe the desired functionality for specific inputs). Then new examples can be added and generalization can be done again. This process is repeated until we reach the desired implementation. Robert C. Martin developed a maxim on this, saying that “As the tests get more specific, the code gets more generic.</li>
</ol>
<p>Usually, when TDD is showcased on simple examples, triangulation is the primary technique used, so many novices mistakenly believe TDD is all about triangulation. This isn’t true, although triangulation is important.</p>
<h4 id="example"><a href="#example">Example</a></h4>
<p>Suppose we want to write a logic that creates an aggregate sum of the list. Let’s assume that we have no idea how to design the internals of our custom list class so that it fulfills its responsibility. Thus, we start with the simplest example of calculating a sum of 0 elements:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturn0AsASumOfNoElements</span>()
{
  <span class="co">//GIVEN</span>
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>();

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">0</span>, result);
}</code></pre>
<p>Remember we want to write just enough code to make the Statement true. We can achieve it with just returning 0 from the <code>SumOfElements</code> method:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> <span class="dv">0</span>;
  }
}</code></pre>
<p>This is not yet the implementation we are happy with, which makes us add another Statement - this time for a single element:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnTheSameElementAsASumOfSingleElement</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> singleElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(singleElement);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(singleElement, result);
}</code></pre>
<p>The naive implementation can be as follows:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span> _element = <span class="dv">0</span>;

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>()
  {    
  }

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element)
  {
    _element = element;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> _element;
  }
}</code></pre>
<p>We have two examples, so let us check whether we can generalize now. We could try to get rid of the two constructors now, but let us wait just a little bit longer and see if this is the right path to go (after all, I told you that we need <strong>at least</strong> two examples).</p>
<p>Let’s add third example then. What would be the next more complex one? Note that the choice of next example is not random. Triangulation is about considering the axes of variability. If you carefully read the last example, you probably noticed that we already skipped one axis of variability - the value of the element. We used <code>Any.Integer()</code> where we could use a literal value and add a second example with another value to make us turn it into variable. This time, however, I decided to <strong>type the obvious implementation</strong>. The second axis of variability is the number of elements. The third example will move us further along this axis - so it will use two elements instead of one or zero. This is how it looks like:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnSumOfTwoElementsAsASumWhenTwoElementsAreSupplied</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> firstElement = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> secondElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(firstElement, secondElement);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(firstElement + secondElement, result);
}</code></pre>
<p>And the naive implementation will look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span> _element1 = <span class="dv">0</span>;
  <span class="dt">int</span> _element2 = <span class="dv">0</span>;

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>()
  {
  }

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element)
  {
    _element1 = element;
  }

  <span class="co">//added</span>
  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element1, <span class="dt">int</span> element2)
  {
    _element1 = element1;
    _element2 = element2;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> _element1 + _element2; <span class="co">//changed</span>
  }
}</code></pre>
<p>After adding and implementing the third example, the variability of elements count becomes obvious. Now that we have three examples, we see even more clearly that we have redundant constructors and redundant fields for each element in the list and if we added a fourth example for three elements, we’d have to add another constructor, another field and another element of the sum computation. Time to generalize!</p>
<p>How do we encapsulate the variability of the element count so that we can get rid of this redundancy? A collection! How do we generalize the addition of multiple elements? A foreach loop through the collection! Thankfully, C# supports <code>params</code> keyword, that let us use it to remove the redundant constructor like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span>[] _elements;  

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="kw">params</span> <span class="dt">int</span>[] elements)
  {
    _elements = elements;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="co">//changed</span>
    <span class="dt">int</span> sum = <span class="dv">0</span>;
    <span class="kw">foreach</span>(var element <span class="kw">in</span> _elements)
    {
      sum += element;
    }
    <span class="kw">return</span> sum;
  }
}</code></pre>
<p>While the first Statement (“no elements”) seems like a special case, the remaining two - for one and two elements - seem to be just two variations of the same behavior (“some elements”). Thus, it is a good idea to make a more general Statement that describes this logic to replace the two examples. After all, we don’t want more than one failure for the same reason. So as the next step, I will write a Statement to replace these examples (I leave them in though, until I get this one to evaluate to true).</p>
<pre class="sourceCode cs"><code class="sourceCode cs">[Fact]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnSumOfAllItsElementsWhenAskedForAggregateSum</span>()
{
  <span class="co">//GIVEN</span>
  <span class="dt">var</span> firstElement = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> secondElement = Any.<span class="fu">Integer</span>();
  <span class="dt">var</span> thirdElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(
        firstElement, 
        secondElement, 
        thirdElement);

  <span class="co">//WHEN</span>
  <span class="dt">var</span> result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
   firstElement + 
   secondElement + 
   thirdElement, result);
}</code></pre>
<p>This Statement uses three values rather than zero, one or two as in the examples we had. When I need to use collections with deterministic size (and I do prefer to do it everywhere where using collection with non-deterministic size would force me to use a <code>for</code> loop in my Statement), I pick 3, which is the number I got from Mark Seemann and the rationale is that 3 is the smallest number that has distinct head, tail and middle element. One or two elements seem like a special case, while three sounds generic enough.</p>
<p>One more thing we can do is to ensure that we didn’t write a <strong>false positive</strong>, i.e. a Statement that is always true due to being badly written. In other words, we need to ensure that the Statement we just wrote will ever evaluate to false if the implementation is wrong. As we wrote it after the implementation is in place, we do not have this certainty.</p>
<p>What we will do is to modify the implementation slightly to make it badly implemented and see how our Statement will react (we expect it to evaluate to false):</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
<span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
{
  <span class="co">//changed</span>
  <span class="dt">int</span> sum = <span class="dv">0</span>;
  <span class="kw">foreach</span>(var element <span class="kw">in</span> _elements)
  {
    sum += element;
  }
  <span class="kw">return</span> sum + <span class="dv">1</span>; <span class="co">//modified with &quot;+1&quot;!</span>
}</code></pre>
<p>When we do this, we can see our last Statement evaluate to false with a message like “expected 21, got 22”. We can now undo this one little change and go back to correct implementation.</p>
<p>The examples (“zero elements”, “one element” and “two elements”) still evaluate to true, but it’s now safe to remove the last two, leaving only the Statement about a behavior we expect when we calculate sum of no elements and the Statement about N elements we just wrote.</p>
<p>And voilà! We have arrived at the final, generic solution. Note that the steps we took were tiny - so you might get the impression that the effort was not worth it. Indeed, this example was only to show the mechanics of triangulation - in real life, if we encountered such simple situation we’d know straight away what the design would be and we’d start with the general Statement straight away and just type in the obvious implementation. Triangulation shows its power in more complex problems with multiple design axes and where taking tiny steps helps avoid “analysis paralysis”.</p>
<h2 id="summary-4"><a href="#summary-4">Summary</a></h2>
<p>As I stated before, triangulation is most useful when you have no idea how the internal design of a piece of functionality will look like (e.g. even if there are work-flows, they cannot be easily derived from your knowledge of the domain) and it’s not obvious along which axes your design must provide generality, but you are able to give some examples of the observable behavior of that functionality given certain inputs. These are usually situations where you need to slow down and take tiny steps that slowly bring you closer to the right design and functionality - and that’s what triangulation is for!</p>
<h1 id="part-2-test-driven-development-in-object-oriented-world"><a href="#part-2-test-driven-development-in-object-oriented-world"><strong>Part 2: Test-Driven Development in Object Oriented World</strong></a></h1>
<p>Most of the examples I gave you during the previous part were about a single object that did not have dependencies on other objects (with an exception of some values - strings, integers, enums etc.). This is not how a real OO systems are built. In this part, we are finally going to look at scenarios where multiple objects collaborate together as a system.</p>
<p>This brings about some issues that need to be discussed. One of them is the approach to object oriented design and how it influences the tools we use to test-drive our code. You probably heard something about a tool called mock objects (at least from one of the introductory chapters of this book) or, in more broaded sense, test doubles. If you open your web browser and type “mock objects break encapsulation”, you will find a lot of different opinions - some saying that mocks are great, others blaming them for everything bad in the world, and a lot of opinions inbetween those. The discussions are still heated, even though mocks were introduced more than ten years ago. My goal in this chapter is to outline the real context and forces that lead to adoption of mocks and how to use them for your benefit, not failure.</p>
<p>Steve Freeman, one of the godfathers of using mock objects with TDD, <a href="https://groups.google.com/d/msg/growing-object-oriented-software/rwxCURI_3kM/2UcNAlF_Jh4J">wrote</a>: “mocks arise naturally from doing responsibility-driven OO. All these mock/not-mock arguments are completely missing the point. If you’re not writing that kind of code, people, please don’t give me a hard time”. I am going to introduce mocks in a way that will not give Steve a hard time, I hope.</p>
<p>In order to do this, I need to cover some topics of object oriented design. That is why not all chapters in this part are specifically about TDD, but some are about object oriented techniques, practices and qualities you need to know to use TDD effectively in object oriented world. First of them being objects composability.</p>
<p>After reading part 2, you will understand how mocks fit into test-driving object oriented code, how to make Statements using mocks maintainable and how some of the practices I introduced in the chapters of part 1 apply to mocks. You will also be able to test-drive simple object oriented systems.</p>
<h1 id="on-objects-composability"><a href="#on-objects-composability">On Objects Composability</a></h1>
<p>In this chapter, I will try to outline briefly why objects’ composability is a goal worth achieving and how it can be achieved. I am going to start with an example of unmaintainable code and will gradually fix its flaws in the next chapters. For now, we are going to fix just one of the flaws, so the code we will end up will not be perfect by any means, still, it will be better by one quality.</p>
<p>In the coming chapters, we will learn more valuable lessons resulting from changing this little piece of code.</p>
<h2 id="another-task-for-johnny-and-benjamin"><a href="#another-task-for-johnny-and-benjamin">Another task for Johnny and Benjamin</a></h2>
<p>Remember Johnny and Benjamin? Looks like they managed their previous task and are up to something else. Let us listen to their conversation as they are working on another project…</p>
<p><strong>Benjamin:</strong> So, what’s this assignment about?</p>
<p><strong>Johnny:</strong> Actually, it’s nothing exciting - we’ll have to add two features to a legacy application that’s not prepared for the changes.</p>
<p><strong>Benjamin:</strong> What is the code for?</p>
<p><strong>Johnny:</strong> It is a C# class that implements company policies. As the company has just started using this automated system and it was started recently, there is only one policy implemented: yearly incentive plan. Many corporations have what they call incentive plans. These plans are used to promote good behaviors and exceeding expectations by employees of a company.</p>
<p><strong>Benjamin:</strong> You mean, the project has just started and is already in a bad shape?</p>
<p><strong>Johnny:</strong> Yep. The guys writing it wanted to “keep it simple”, whatever that means, and now it looks pretty bad.</p>
<p><strong>Benjamin:</strong> I see…</p>
<p><strong>Johnny:</strong> By the way, do you like riddles?</p>
<p><strong>Benjamin:</strong> Always!</p>
<p><strong>Johnny:</strong> So here’s one: how do you call a development phase when you ensure high code quality?</p>
<p><strong>Benjamin:</strong> … … No clue… So what is it called?</p>
<p><strong>Johnny:</strong> It’s called “now”.</p>
<p><strong>Benjamin:</strong> Oh!</p>
<p><strong>Johnny:</strong> Getting back to the topic, here’s the company incentive plan.</p>
<p>Every employee has a pay grade. An employee can be promoted to a higher pay grade, but the mechanics of how that works is something we will not need to deal with.</p>
<p>Normally, every year, everyone gets a raise by 10%. But to encourage behaviors that give an employee a higher pay grade, such employee cannot get raises indefinitely on a given pay grade. Each grade has its associated maximum pay. If this amount of money is reached, an employee does not get a raise anymore until they reach a higher pay grade.</p>
<p>Additionally, every employee on their 5th anniversary of working for the company, gets a special, one-time bonus which is twice their current payment.</p>
<p><strong>Benjamin:</strong> Looks like the source code repository just finished synchronizing. Let’s take a bite at the code!</p>
<p><strong>Johnny:</strong> Sure, here you go:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="kw">readonly</span> SqlRepository _repository
    = <span class="kw">new</span> <span class="fu">SqlRepository</span>();
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="dt">var</span> employees = _repository.<span class="fu">CurrentEmployees</span>();

    <span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
    {
      <span class="dt">var</span> payGrade = employee.<span class="fu">GetPayGrade</span>();
      <span class="co">//evaluate raise</span>
      <span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
      {
        var newSalary 
          = employee.<span class="fu">GetSalary</span>() 
          + employee.<span class="fu">GetSalary</span>() 
          * <span class="fl">0.1</span>;
        employee.<span class="fu">SetSalary</span>(newSalary);
      }
  
      <span class="co">//evaluate one-time bonus</span>
      <span class="kw">if</span>(employee.<span class="fu">GetYearseOfService</span>() == <span class="dv">5</span>)
      {
        <span class="dt">var</span> oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
        employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
      }
  
      employee.<span class="fu">Save</span>();
    }
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Dispose</span>()
  {
    _repository.<span class="fu">Dispose</span>();
  }
}</code></pre>
<p><strong>Benjamin:</strong> Wow, there is a lot of literal constants all around and functional decomposition is barely done!</p>
<p><strong>Johnny:</strong> Yeah. We won’t be fixing all of that today. Still, we will follow the scout rule and “leave the campground cleaner than we found it”.</p>
<p><strong>Benjamin:</strong> What’s our assignment?</p>
<p><strong>Johnny:</strong> First of all, we need to provide our users a choice between an SQL database and a NoSQL one. To achieve our goal, we need to be somehow able to make the <code>CompanyPolicies</code> class database type-agnostic. For now, as you can see, the implementation is coupled to the specific <code>SqlRepository</code>, because it creates a specific instance itself:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="kw">readonly</span> SqlRepository _repository
    = <span class="kw">new</span> <span class="fu">SqlRepository</span>();</code></pre>
<p>Now, we need to evaluate the options we have to pick the best one. What options do you see, Benjamin?</p>
<p><strong>Benjamin:</strong> Well, we could certainly extract an interface from <code>SqlRepository</code> and introduce an if statement to the constructor like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="kw">readonly</span> Repository _repository;

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>()
  {
    <span class="kw">if</span>(...)
    {
      _repository = <span class="kw">new</span> <span class="fu">SqlRepository</span>();
    }
    <span class="kw">else</span>
    {
      _repository = <span class="kw">new</span> <span class="fu">NoSqlRepository</span>();
    }
  }</code></pre>
<p><strong>Johnny:</strong> True, but this option has few deficiencies. First of all, remember we’re trying to follow the scout rule and by using this option we introduce more complexity to the CommonPolicies class. Also, let’s say tommorow someone writes another class for, say, reporting and this class will also need to access the repository - they will need to make the same decision on repositories in their code as we do in ours. This effectively means duplicating code. Thus, I’d rather evaluate further options and check if we can come up with something better. What’s our next option?</p>
<p><strong>Benjamin:</strong> Another option would be to change the SqlRepository itself to be just a wrapper around the actual database access, like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> SqlRepository : IDisposable
{
  <span class="kw">readonly</span> Repository _repository;

  <span class="kw">public</span> <span class="fu">SqlRepository</span>()
  {
    <span class="kw">if</span>(...)
    {
      _repository = <span class="kw">new</span> <span class="fu">RealSqlRepository</span>();
    }
    <span class="kw">else</span>
    {
      _repository = <span class="kw">new</span> <span class="fu">RealNoSqlRepository</span>();
    }
  }

  IList&lt;Employee&gt; <span class="fu">CurrentEmployees</span>()
  {
    <span class="kw">return</span> _repository.<span class="fu">CurrentEmployees</span>();
  }</code></pre>
<p><strong>Johnny:</strong> Sure, this is an approach that could work and would be worth considering for very serious legacy code, as it does not force us to change the <code>CompanyPolicies</code> class at all. However, there are some issues with it. First of all, the <code>SqlRepository</code> name would be misleading. Second, look at the <code>CurrentEmployees()</code> method - all it does is delegating a call to the implementation chosen in the constructor. With every new method required of the repository, we’ll need to add new delegating methods. In reality, it isn’t such a big deal, but maybe we can do better than that?</p>
<p><strong>Benjamin:</strong> Let me think, let me think… I evaluated the option where <code>CompanyPolicies</code> class makes the choice between repositories. I also evaluated the option where we hack the <code>SqlRepository</code> to makes this choice. The last option I can think of is leaving this choice to another, “3rd party” code, that would choose the repository to use and pass it to the <code>CompanyPolicies</code> via constructor, like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="kw">private</span> <span class="kw">readonly</span> Repository _repository;

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }</code></pre>
<p>This way, the <code>CompanyPolicies</code> won’t know what exactly is passed to it via constructor and we can pass whatever we like - either an SQL repository or a NoSQL one!</p>
<p><strong>Johnny:</strong> Great! This is the option we’re looking for! For now, just believe me that this approach will lead us to many good things - you’ll see why later.</p>
<p><strong>Benjamin:</strong> OK, so let me just pull the <code>SqlRepository</code> instance outside the <code>CompanyPolicies</code> class and make it an implementation of <code>Repository</code> interface, then create a constructor and pass the real instance through it…</p>
<p><strong>Johnny:</strong> Sure, I’ll go get some coffee.</p>
<p>… 10 minutes later</p>
<p><strong>Benjamin:</strong> Ha ha! Look at this! I am SUPREME!</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="co">//_repository is now an interface</span>
  <span class="kw">readonly</span> Repository _repository; 

  <span class="co">// repository is passed from outside.</span>
  <span class="co">// We don&#39;t know what exact implementation it is.</span>
  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="co">//... body of the method. Unchanged.</span>
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Dispose</span>()
  {
    _repository.<span class="fu">Dispose</span>();
  }
}</code></pre>
<p><strong>Johnny:</strong> Hey, hey, hold your horses! There is one thing wrong with this code.</p>
<p><strong>Benjamin:</strong> Huh? I thought this is what we were aiming at.</p>
<p><strong>Johnny:</strong> Yes, with the exception of the <code>Dispose()</code> method. Look closely at the <code>CompanyPolicies</code> class. it is changed so that it is not responsible for creating a repository for itself, but it still disposes of it. This is wrong because <code>CompanyPolicies</code> instance does not have any right to assume it is the only object that is using the repository. If so, then it cannot determine the moment when the repository becomes unnecessary and can be safely disposed of.</p>
<p><strong>Benjamin:</strong> Ok, I get the theory, but why is this bad in practice? Can you give me an example?</p>
<p><strong>Johnny:</strong> Sure, let me sketch a quick example. As soon as you have two instances of <code>CompanyPolicies</code> class, both sharing the same instance of <code>Repository</code>, you’re cooked. This is because one instance of <code>CompanyPolicies</code> may dispose of the repository while the other one may still want to use it.</p>
<p><strong>Benjamin:</strong> So who is going to dispose of the repository?</p>
<p><strong>Johnny:</strong> The same part of the code that creates it, for example the <code>Main</code> method. Let me show you an example of how this may look like:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)
{
  <span class="kw">using</span>(<span class="dt">var</span> repo = <span class="kw">new</span> <span class="fu">SqlRepository</span>())
  {
    <span class="dt">var</span> policies = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(repo);

    <span class="co">//use above created policies </span>
    <span class="co">//for anything you like</span>
  }
}</code></pre>
<p>This way the repository is created at the start of the program and disposed of at the end. Thanks to this, the <code>CompanyPolicies</code> has no disposable fields and it itself does not have to be disposable - we can just delete the <code>Dispose()</code> method:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//not implementing IDisposable anymore:</span>
<span class="kw">public</span> <span class="kw">class</span> CompanyPolicies 
{
  <span class="co">//_repository is now an interface</span>
  <span class="kw">readonly</span> Repository _repository; 

  <span class="co">//New constructor</span>
  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="co">//... body of the method. No changes</span>
  }

  <span class="co">//no Dispose() method anymore</span>
}</code></pre>
<p><strong>Benjamin:</strong> Cool. So, what now? Seems we have the <code>CompanyPolicies</code> class depending on repository abstraction instead of an actual implementation, like SQL repository. My guess is that we will be able to make another class implementing the interface for NoSQL data access and just pass it through the constructor instead of the original one.</p>
<p><strong>Johnny:</strong> Yes. For example, look at <code>CompanyPolicies</code> component. We can compose it with a repository like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">var policies 
  = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(<span class="kw">new</span> <span class="fu">SqlRepository</span>());</code></pre>
<p>or like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">var policies 
  = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(<span class="kw">new</span> <span class="fu">NoSqlRepository</span>());</code></pre>
<p>without changing the code of <code>CompanyPolicies</code>. This means that <code>CompanyPolicies</code> does not need to know what <code>Repository</code> exactly it is composed with, as long as this <code>Repository</code> follows the required interface and meets expectations of <code>CompanyPolicies</code> (e.g. does not throw exceptions when it is not supposed to do so). An implementation of <code>Repository</code> may be itself a very complex and composed of another set of classes, for example something like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">SqlRepository</span>(
  <span class="kw">new</span> <span class="fu">ConnectionString</span>(<span class="st">&quot;...&quot;</span>), 
  <span class="kw">new</span> <span class="fu">AccessPrivileges</span>(
    <span class="kw">new</span> <span class="fu">Role</span>(<span class="st">&quot;Admin&quot;</span>), 
    <span class="kw">new</span> <span class="fu">Role</span>(<span class="st">&quot;Auditor&quot;</span>)
  ),
  <span class="kw">new</span> <span class="fu">InMemoryCache</span>()
);</code></pre>
<p>but the <code>CompanyPolicies</code> neither knows or cares about this, as long as it can use our new <code>Repository</code> implementation just like other repositories.</p>
<p><strong>Benjamin:</strong> I see… So, getting back to our task, shall we proceed with making a NoSQL implementation of the <code>Repository</code> interface?</p>
<p><strong>Johnny:</strong> First, show me the interface that you extracted while I was looking for the coffee.</p>
<p><strong>Benjamin:</strong> Here:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Repository
{
  IList&lt;Employee&gt; <span class="fu">CurrentEmployees</span>();
}</code></pre>
<p><strong>Johnny:</strong> Ok, so what we need is to create just another implementation and pass it through the constructor depending on what data source is chosen and we’re finished with this part of the task.</p>
<p><strong>Benjamin:</strong> You mean there’s more?</p>
<p><strong>Johnny:</strong> Yeah, but that’s something for tomorrow. I’m exhausted today.</p>
<h2 id="a-quick-retrospective"><a href="#a-quick-retrospective">A Quick Retrospective</a></h2>
<p>In this chapter, Benjamin learned to appreciate the composability of objects, i.e. the ability to replace object dependencies, providing different behaviors, without the need to change the code of the object class itself. Thus, an object, given replaced dependencies, starts using the new behaviors without noticing that any change occurred at all.</p>
<p>As I said, the code mentioned has some serious flaws. For now, Johnny and Benjamin did not encounter a desperate need to address those flaws, but this is going to change in the next chapter.</p>
<p>Also, after we part again with Johnny and Benjamin, we are going to reiterate the ideas they stumble upon in a more disciplined manner.</p>
<h1 id="telling-not-asking"><a href="#telling-not-asking">Telling, not asking</a></h1>
<p>In this chapter, we’ll get back to Johnny and Benjamin as they introduce another change in the code they are working on. In the process, they discover the impact that return values and getters have on composability of objects.</p>
<h2 id="contractors"><a href="#contractors">Contractors</a></h2>
<p><strong>Johnny:</strong> G’morning. Ready for another task?</p>
<p><strong>Benjamin:</strong> Of course! What’s next?</p>
<p><strong>Johnny:</strong> Remember the code we worked on yesterday? It contains a policy for regular employees of the company. But the company wants to start hiring contractors as well and needs to include a policy for them in the application.</p>
<p><strong>Benjamin:</strong> So this is what we will be doing today?</p>
<p><strong>Johnny:</strong> That’s right. The policy is going to be different for contractors. While, just as regular employees, they will be receiving raises and bonuses, the rules will be different. I made a small table to allow comparing what we have for regular employees and what we want to add for contractors:</p>
<table>
<col width="30%" />
<col width="33%" />
<col width="34%" />
<thead>
<tr class="header">
<th align="left">Employee Type</th>
<th align="left">Raise</th>
<th align="left">Bonus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><p>Regular Employee</p></td>
<td align="left"><p>+10% of current salary if not reached maximum on a given pay grade</p></td>
<td align="left"><p>+200% of current salary one time after five years</p></td>
</tr>
<tr class="even">
<td align="left"><p>Contractor</p></td>
<td align="left"><p>+5% of average salary calculated for last 3 years of service (or all previous years of service if they have worked for less than 3 years)</p></td>
<td align="left"><p>+10% of current salary when a contractor receives score more than 100 for the previous year</p></td>
</tr>
</tbody>
</table>
<p>So while the workflow is going to be the same for both a regular employee and a contractor:</p>
<ol style="list-style-type: decimal">
<li>Load from repository</li>
<li>Evaluate raise</li>
<li>Evaluate bonus</li>
<li>Save</li>
</ol>
<p>the implementation of some of the steps will be different for each type of employee.</p>
<p><strong>Benjamin:</strong> Correct me if I am wrong, but these “load” and “save” steps do not look like they belong with the remaining two - they describe something technical, while the other steps describe something strictly related to how the company operates…</p>
<p><strong>Johnny:</strong> Good catch, however, this is something we’ll deal with later. Remember the scout rule - just don’t make it worse. Still, we’re going to fix some of the design flaws today.</p>
<p><strong>Benjamin:</strong> Aww… I’d just fix all of it right away.</p>
<p><strong>Johnny:</strong> Ha ha, patience, Luke. For now, let’s look at the code we have now before we plan further steps.</p>
<p><strong>Benjamin:</strong> Let me just open my IDE… OK, here it is:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies 
{
  <span class="kw">readonly</span> Repository _repository; 

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="dt">var</span> employees = _repository.<span class="fu">CurrentEmployees</span>();

    <span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
    {
      <span class="dt">var</span> payGrade = employee.<span class="fu">GetPayGrade</span>();

      <span class="co">//evaluate raise</span>
      <span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
      {
        var newSalary 
          = employee.<span class="fu">GetSalary</span>() 
          + employee.<span class="fu">GetSalary</span>() 
          * <span class="fl">0.1</span>;
        employee.<span class="fu">SetSalary</span>(newSalary);
      }
  
      <span class="co">//evaluate one-time bonus</span>
      <span class="kw">if</span>(employee.<span class="fu">GetYearsOfService</span>() == <span class="dv">5</span>)
      {
        <span class="dt">var</span> oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
        employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
      }
  
      employee.<span class="fu">Save</span>();
    }
  }
}</code></pre>
<p><strong>Benjamin:</strong> Look, Johnny, the class in fact contains all the four steps you mentioned, but they are not named explicitly - instead, their internal implementation for regular employees is just inserted in here. How are we supposed to add the variation of the employee type?</p>
<p><strong>Johnny:</strong> Time to consider our options. We have few of them. Well?</p>
<p><strong>Benjamin:</strong> For now, I can see two. The first one would be to create another class similar to <code>CompanyPolicies</code>, called something like <code>CompanyPoliciesForContractors</code> and implement the new logic there. This would let us leave the original class as is, but we would have to change the places that use <code>CompanyPolicies</code> to use both classes and choose which one to use somehow. Also, we would have to add a separate method to repository for retrieving the contractors.</p>
<p><strong>Johnny:</strong> In addition, we would miss our chance to communicate through the code that the sequence of steps is intentionally similar in both cases. Others who read this code in the future will see that the implementation for regular employees follows the steps: load, evaluate raise, evaluate bonus, save. When they look at the implementation for contractors, they will see the same order of steps, but they will be unable to tell whether the similarity is intentional, or is it there by pure accident.</p>
<p><strong>Benjamin:</strong> So our second option is to put an <code>if</code> statement into the differing steps inside the <code>CompanyPolicies</code> class, to distinguish between regular employees and contractors. The <code>Employee</code> class would have an <code>isContractor()</code> method and depending on what it would return, we would either execute the logic for regular employees or for contractors. Assuming that the current structure of the code looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
{
  <span class="co">//evaluate raise</span>
  ...
  
  <span class="co">//evaluate one-time bonus</span>
  ...
  
  <span class="co">//save employee</span>
}</code></pre>
<p>the new structure would look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
{
  <span class="kw">if</span>(employee.<span class="fu">IsContractor</span>())
  {
    <span class="co">//evaluate raise for contractor</span>
    ...
  }
  <span class="kw">else</span>
  {
    <span class="co">//evaluate raise for regular</span>
    ...
  }

  <span class="kw">if</span>(employee.<span class="fu">IsContractor</span>())
  {
    <span class="co">//evaluate one-time bonus for contractor</span>
    ...
  }
  <span class="kw">else</span>
  {
    <span class="co">//evaluate one-time bonus for regular</span>
    ...
  }
  
  <span class="co">//save employee</span>
  ...
}</code></pre>
<p>this way we would show that the steps are the same, but the implementation is different. Also, this would mostly require us to add code and not move the existing code around.</p>
<p><strong>Johnny:</strong> The downside is that we would make the class even uglier than it was when we started. So despite initial easiness, we’ll be doing a huge disservice to future maintainers. We have at least one another option. What would that be?</p>
<p><strong>Benjamin:</strong> Let’s see… we could move all the details concerning the implementation of the steps from <code>CompanyPolicies</code> class into the <code>Employee</code> class itself, leaving only the names and the order of steps in <code>CompanyPolicies</code>:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
{
  employee.<span class="fu">EvaluateRaise</span>();
  employee.<span class="fu">EvaluateOneTimeBonus</span>();
  employee.<span class="fu">Save</span>();
}</code></pre>
<p>Then, we could change the <code>Employee</code> into an interface, so that it could be either a <code>RegularEmployee</code> or <code>ContractorEmployee</code> - both classes would have different implementations of the steps, but the <code>CompanyPolicies</code> would not notice, since it would not be coupled to the implementation of the steps anymore - just the names and the order.</p>
<p><strong>Johnny:</strong> This solution would have one downside - we would need to significantly change the current code, but you know what? I’m willing to do it, especially that I was told today that the logic is covered by some tests which we can run to see if a regression was introduced.</p>
<p><strong>Benjamin:</strong> Cool, what do we start with?</p>
<p><strong>Johnny:</strong> The first thing that is between us and our goal are these getters on the <code>Employee</code> class:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="fu">GetSalary</span>();
<span class="fu">GetGrade</span>();
<span class="fu">GetYearsOfService</span>();</code></pre>
<p>They just expose too much information specific to the regular employees. It would be impossible to use different implementations when these are around. These setters don’t help much:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="fu">SetSalary</span>(newSalary)
<span class="fu">SetBonusForYear</span>(year, amount);</code></pre>
<p>While these are not as bad, we’d better give ourselves more flexibility. Thus, let’s hide all of this behind more abstract methods that hide what actually happens, but reveal our intention.</p>
<p>First, take a look at this code:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//evaluate raise</span>
<span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
{
  var newSalary 
    = employee.<span class="fu">GetSalary</span>() 
    + employee.<span class="fu">GetSalary</span>() 
    * <span class="fl">0.1</span>;
  employee.<span class="fu">SetSalary</span>(newSalary);
}</code></pre>
<p>Each time you see a block of code separated from the rest with blank lines and starting with a comment, you see something screaming “I want to be a separate method that contains this code and has a name after the comment!”. Let’s grant this wish and make it a separate method on the <code>Employee</code> class.</p>
<p><strong>Benjamin:</strong> Ok, wait a minute… here:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">employee.<span class="fu">EvaluateRaise</span>();</code></pre>
<p><strong>Johnny:</strong> Great! Now, we’ve got another example of this species here:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//evaluate one-time bonus</span>
<span class="kw">if</span>(employee.<span class="fu">GetYearsOfService</span>() == <span class="dv">5</span>)
{
  <span class="dt">var</span> oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
  employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
}</code></pre>
<p><strong>Benjamin:</strong> This one should be even easier… Ok, take a look:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">employee.<span class="fu">EvaluateOneTimeBonus</span>();</code></pre>
<p><strong>Johnny:</strong> Almost good. I’d only leave out the information that the bonus is one-time from the name.</p>
<p><strong>Benjamin:</strong> Why? Don’t we want to include what happens in the method name?</p>
<p><strong>Johnny:</strong> Actually, no. What we want to include is our intention. The bonus being one-time is something specific to the regular employees and we want to abstract away the details about this or that kind of employee, so that we can plug in different implementations without making the method name lie. The names should reflect that we want to evaluate a bonus, whatever that means for a particular type of employee. Thus, let’s make it:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">employee.<span class="fu">EvaluateBonus</span>();</code></pre>
<p><strong>Benjamin:</strong> Ok, I get it. No problem.</p>
<p><strong>Johnny:</strong> Now let’s take a look at the full code of the <code>EvaluateIncentivePlan</code> method to see whether it is still coupled to details specific to regular employees. Here’s the code:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
{
  <span class="dt">var</span> employees = _repository.<span class="fu">CurrentEmployees</span>();

  <span class="kw">foreach</span>(var employee <span class="kw">in</span> employees)
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
    employee.<span class="fu">Save</span>();
  }
}</code></pre>
<p><strong>Benjamin:</strong> It seems that there is no coupling to the details about regular employees anymore. Thus, we can safely make the repository return a combination of regulars and contractors without this code noticing anything. Now I think I understand what you were trying to achieve. If we make interactions between objects happen on a more abstract level, then we can put in different implementations with less effort.</p>
<p><strong>Johnny:</strong> True. Can you see another thing related to the lack of return values on all of employee’s methods in the current implementation?</p>
<p><strong>Benjamin:</strong> Actually, no. Does it matter?</p>
<p><strong>Johnny:</strong> Well, if <code>Employee</code> methods had return values and this code depended on them, all subclasses of <code>Employee</code> would be forced to supply return values as well and these return values would need to match the expectations of the code that calls these methods, whatever these expectations were. This would make introducing other kinds of employees harder. But now that there are no return values, we can, for example:</p>
<ul>
<li>introduce a <code>TemporaryEmployee</code> that has no raises, by leaving its <code>EvaluateRaise()</code> method empty, and the code that uses employees will not notice.</li>
<li>introduce a <code>ProbationEmployee</code> that has no bonus policy, by leaving its <code>EvaluateBonus()</code> method empty, and the code that uses employees will not notice.</li>
<li>introduce an <code>InMemoryEmployee</code> that has empty <code>Save()</code> method, and the code that uses employees will not notice.</li>
</ul>
<p>As you see, by asking the objects less, and telling it more, we get greater flexibility to create alternative implementations and the composability, which we talked about yesterday, increases!</p>
<p><strong>Benjamin:</strong> I see… So telling objects what to do instead of asking them for their data makes the interactions between objects more abstract, and so, more stable, increasing composability of interacting objects. This is a valuable lesson - it is the first time I hear this and it seems a pretty powerful concept.</p>
<h2 id="a-quick-retrospective-1"><a href="#a-quick-retrospective-1">A Quick Retrospective</a></h2>
<p>In this chapter, Benjamin learned that the composability of objects (not to mention clarity) is reinforced when interactions between them are: abstract, logical and stable. Also, he discovered, with Johnny’s help, that it is further strengthened by following a design style where objects are told what to do instead of asked to give away information to somebody who the makes the decision on their behalf. This is because if an API of an abstraction is built around answering to specific questions, the clients of the abstraction tend to ask it a lot of questions an are coupled to both those questions and some aspects of the answers (i.e. what it in the return values). This makes creating another implementation of abstraction harder, because each new implementation of the abstraction needs to not only provide answers to all those questions, but the answers are constrained to what the client expects. When abstraction is merely told what its client wants it to achieve, the clients is decoupled from most of the details of how this happens. This makes introducing new implementations of abstraction easier - it often even lets us define implementations with all methods empty without the client noticing at all.</p>
<p>These are all important conclusions that will lead us towards TDD with mock objects.</p>
<p>Time to leave Johnny and Benjamin for now. In the next chapter, I’m going to reiterate on their discoveries and put them in a broader context.</p>
<h1 id="the-need-for-mock-objects"><a href="#the-need-for-mock-objects">The need for mock objects</a></h1>
<p>We already experienced mock objects in the chapter about tools, although at that point, I gave you an oversimplified and deceiving explanation of what a mock object is, promising that I will make up for it later. Now is the time.</p>
<p>Mock objects were made with specific goal in mind. My hope is that when you understand the real goal, you will probably understand the means to the goal far better.</p>
<p>In this chapter, we will explore the qualities of object oriented design which make mock objects a viable tool.</p>
<h2 id="composability-again"><a href="#composability-again">Composability… again!</a></h2>
<p>In the two previous chapters, we followed Johnny and Benjamin in discovering the benefits of and prerequisites for composability of objects. Actually, composability is number one quality of the design we’re after. After reading Johhny and Benjamin’s story, you might have some questions regarding composability. Hopefully, they are among the ones answered in the next few chapters. Ready?</p>
<h1 id="why-do-we-need-composability"><a href="#why-do-we-need-composability">Why do we need composability?</a></h1>
<p>It might seem stupid to ask this question here - if you have managed to stay with me this long, then you’re probably motivated enough not to need a justification? Well, anyway, it’s still worth discussing it a little. Hopefully, you’ll learn as much reading this back-to-basics chapter as I did writing it.</p>
<h2 id="pre-object-oriented-approaches"><a href="#pre-object-oriented-approaches">Pre-object oriented approaches</a></h2>
<p>Back in the days of procedural programming, when we wanted to execute a different code based on some factor, it was usually achieved using an ‘if’ statement. For example, if our application was able to use different kinds of alarms, e.g. a loud alarm (that plays a loud sound) and a silent alarm (that does not play any sound, but instead silently contacts the security), then usually, we could find a piece of code like the following to achieve that:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
{
  triggerLoudAlarm((LoudAlarm*)alarm);
}
<span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
{
  triggerSilentAlarm((SilentAlarm*)alarm);
}</code></pre>
<p>The code queries the alarm kind which is embedded in the alarm structure and makes decision based on this kind. Unfortunately, if we wanted make a second decision based on the alarm kind, we would need to query for the alarm kind again, duplicating the code, just with different set of actions to perform depending on what kind of alarm we are dealing with:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
{
  disableLoudAlarm((LoudAlarm*)alarm);
}
<span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
{
  disableSilentAlarm((SilentAlarm*)alarm);
}</code></pre>
<p>Do I have to say why this duplication is bad? Do I hear a “no”? My apologies then, but I’ll tell you anyway. The duplication means that every time a new kind of alarm is introduced, a developer has to remember to update both places that contain ‘if-else’ - the compiler will not force this. As you are probably aware, in the context of teams, where one developer picks up work that another left and where there is a notion of attrition, expecting someone to “remember” to update all the places where the logic is duplicated is asking for trouble.</p>
<p>Here’s the reason for this duplication: We have two things we do with our alarms: triggering and disabling. Each alarm has different way of doing all these things - resulting in having a set of “answers” for the same set of questions associated with each alarm kind:</p>
<ol style="list-style-type: decimal">
<li>Loud Alarm
<ol style="list-style-type: decimal">
<li>triggering: <code>triggerLoudAlarm()</code></li>
<li>disabling: <code>disableLoudAlarm()</code></li>
</ol></li>
<li>SilentAlarm
<ol style="list-style-type: decimal">
<li>triggering: <code>triggerSilentAlarm()</code></li>
<li>disabling: <code>disableSilentAlarm()</code></li>
</ol></li>
</ol>
<p>So, at least conceptually, as soon as we know the alarm kind, we already know which set of behaviors it needs. We could just decide the alarm kind once and associate the right set of behaviors with the data structure. Then, we would not have to query the alarm data again as we did, but instead, we could say: “execute triggering the alarm from the set of behaviors associated with this alarm, whatever it is”.</p>
<p>Unfortunately, procedural programming does not let us bind behaviors with data. As a matter of fact, the whole paradigm of procedural programming is about separating behaviors and data! Well, honestly, they had some answers to those concerns, but they were mostly awkward (for those of you that still remember C: I’m talking about macros and function pointers). So, as data and behaviors are separated, we need to query the data each time we want to pick a behavior based on it. That’s why we have the duplication.</p>
<h2 id="object-oriented-programming-to-the-rescue"><a href="#object-oriented-programming-to-the-rescue">Object oriented programming to the rescue!</a></h2>
<p>On the other hand, object oriented programming has for a long time made available two mechanisms that made what we didn’t have in procedural languages available:</p>
<ol style="list-style-type: decimal">
<li>Classes - allow binding behavior together with data</li>
<li>Polymorphism - allows executing behavior without knowing the exact class which holds them, but knowing only a set of behaviors that it supports. This knowledge was obtained by depending on an abstract type which all others inherited from (or implemented - in case of interfaces), and which contained the signatures of behaviors each inheriting class could provide on its own.</li>
</ol>
<p>So, in case of our alarms, we could make an interface with the following signature:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Alarm
{
  <span class="dt">void</span> <span class="fu">Trigger</span>();
  <span class="dt">void</span> <span class="fu">Disable</span>();
}</code></pre>
<p>and then make two classes: <code>LoudAlarm</code> and <code>SilentAlarm</code>, both implementing the <code>Alarm</code> interface. Example for <code>LoudAlarm</code>:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> LoudAlarm : Alarm
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
  {
    <span class="co">//play very loud sound</span>
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Disable</span>()
  {
    <span class="co">//stop playing the sound</span>
  }
}</code></pre>
<p>Now, we can make parts of code use the alarm without having to know its type, so what we previously had:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
{
  triggerLoudAlarm((LoudAlarm*)alarm);
}
<span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
{
  triggerSilentAlarm((SilentAlarm*)alarm);
}</code></pre>
<p>becomes just:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">alarm.<span class="fu">Trigger</span>();</code></pre>
<p>where <code>alarm</code> is either <code>LoudAlarm</code> or <code>SilentAlarm</code>, but seen polymorphically as <code>Alarm</code>, so there’s no need for ‘if-else’ anymore. But hey, isn’t this cheating? Even provided I can execute a the trigger behavior on the alarm without knowing the actual class of the alarm, I still have to decide which class instance to create somewhere, so it looks like I am not eliminating the ‘else-if’ after all, just moving it somewhere else! This is true, but the good news is that I eliminated the duplication by making our dream of picking the right set of behaviors to use with certain data once.</p>
<p>Thanks to this, I create the alarm once, and then I can take it and pass it to ten, a hundred or a thousand different places where I will not have to determine the alarm kind anymore to use it correctly.</p>
<p>This allows writing a lot of classes that have no knowledge whatsoever about the real class of the alarm they are dealing with, yet are able to use the alarm just fine only by knowing a common abstract type - <code>Alarm</code>. If we are able to do that, we arrive at a situation where we can add more alarms implementing <code>Alarm</code> and watch already existing objects that are using <code>Alarm</code> work with these new alarms without any change in their source code! There is one condition, however - the creation of the alarm instances must be moved out of of these objects. That’s because to create an alarm using a <code>new</code> operator, an object must know the exact type of the alarm it is creating, losing its uniformity, because it would not be able to depend solely on the <code>Alarm</code> interface.</p>
<h2 id="the-power-of-composition"><a href="#the-power-of-composition">The power of composition</a></h2>
<p>Moving creation of alarm instances away from the classes that use those alarms brings up an interesting problem - if an object does not create its own dependencies, then who does it? I have cleverly avoided answering this question so far, so let’s tackle this issue now. A solution is to make some special place in the code that assembles a system from loosely coupled objects. We saw this already as Johnny was explaining composability to Benjamin. He used the following example:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">SqlRepository</span>(
  <span class="kw">new</span> <span class="fu">ConnectionString</span>(<span class="st">&quot;...&quot;</span>), 
  <span class="kw">new</span> <span class="fu">AccessPrivileges</span>(
    <span class="kw">new</span> <span class="fu">Role</span>(<span class="st">&quot;Admin&quot;</span>), 
    <span class="kw">new</span> <span class="fu">Role</span>(<span class="st">&quot;Auditor&quot;</span>)
  ),
  <span class="kw">new</span> <span class="fu">InMemoryCache</span>()
);</code></pre>
<p>We can do the same with our alarms. Let’s say that we have a secure area that has three buildings with different alarm policies:</p>
<ul>
<li>Office building - the alarm should be silent during the day (to keep office staff from panicking) and loud in the night, when guards are on patrol.</li>
<li>Storage building - as it is quite far and the workers are few, we want to trigger loud and silent alarms at the same time</li>
<li>Guards building - as the guards are there, no need to notify them with silent alarm, but a loud alarm is desired</li>
</ul>
<p>The composition of objects fulfilling these needs could look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(), 
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(),
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
);</code></pre>
<p>The parts I would like to turn your attention to are: <code>HybridAlarm</code> and <code>DayNightSwitchedAlarm</code>. These are both classes implementing the <code>Alarm</code> interface, at the same time taking <code>Alarm</code> implementations as their constructor arguments. For example, <code>DayNightSwitchedAlarm</code> uses different alarm during the day and another during the night. Note that this allows us to change the alarm behaviors in many interesting ways using the parts we already have, but composing them together differently. For example, we might have, as in the above example:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(), 
  <span class="kw">new</span> <span class="fu">LoudAlarm</span>());</code></pre>
<p>which would mean triggering silent alarm during a day and loud one during night. However, instead of this combination, we might use:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(),
  <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
    <span class="kw">new</span> <span class="fu">SilentAlarm</span>(),
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
)</code></pre>
<p>Which would mean that we use silent alarm during the day, but a combination of silent and loud during the night.</p>
<p>Additionally, if we suddenly decided that we do not want alarm at all during the day, we could use a special class called <code>NoAlarm</code> that would implement <code>Alarm</code> interface, but have both <code>Trigger</code> and <code>Disable</code> methods do nothing. The composition code would look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">NoAlarm</span>(), <span class="co">// no alarm during day</span>
  <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
    <span class="kw">new</span> <span class="fu">SilentAlarm</span>(),
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
)</code></pre>
<p>And, last but not least, we could completely remove all alarms from the guards building using the following code:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
  <span class="kw">new</span> <span class="fu">NoAlarm</span>()
)</code></pre>
<p>Noticed something funny about the section you are reading now? So far, we have twisted the behaviors of our application in wacky ways, but all of this took place in the composition code! We did not have to modify any other existing classes! True, we had to write a new class called <code>NoAlarm</code>, but did not need to modify any other code than the composition code to put this new class into use!</p>
<p>This ability to change the behavior of our application just by changing the way objects are composed together is extremely powerful (although you will always be able to achieve it only to certain extent), especially in evolutionary, incremental design, where we want to evolve some pieces of code with as little as possible other pieces of code having to realize that the evolution takes place..</p>
<h2 id="summary---are-you-still-with-me"><a href="#summary---are-you-still-with-me">Summary - are you still with me?</a></h2>
<p>Although we started with what seemed to be a repetition from basic object oriented programming class, using a basic example. It was necessary though to make a fluent transition to the benefits of composability we eventually introduced at the end. I hope you did not get overwhelmed and can understand now why I am putting so much stress on composability.</p>
<p>In the next chapter, we will take a closer look at composing objects itself.</p>
<h4 id="this-is-all-i-have-for-now.-what-follows-is-raw-unordered-material-thats-not-yet-ready-to-be-consumed-as-part-of-this-tutorial" class="sigil_not_in_toc"><a href="#this-is-all-i-have-for-now.-what-follows-is-raw-unordered-material-thats-not-yet-ready-to-be-consumed-as-part-of-this-tutorial">THIS IS ALL I HAVE FOR NOW. WHAT FOLLOWS IS RAW, UNORDERED MATERIAL THAT’S NOT YET READY TO BE CONSUMED AS PART OF THIS TUTORIAL</a></h4>
<h1 id="web-messages-and-protocols"><a href="#web-messages-and-protocols">Web, messages and protocols</a></h1>
<p>In the last chapter, we talked a little bit about why composability is valuable, now let’s flesh a little bit of terminology to get more precise understanding.</p>
<h2 id="so-again-what-does-it-mean-to-compose-objects"><a href="#so-again-what-does-it-mean-to-compose-objects">So, again, what does it mean to compose objects?</a></h2>
<p>Basically it means that an object has obtained a reference to another object and is able to invoke methods on it. By being composed together, two objects form a small system that can be expanded with more objects as needed. Thus, a bigger object oriented system forms something similar to a web:</p>
<div class="figure">
<img src="./images/WebOfObjects.png" alt="Web of objects" /><p class="caption">Web of objects</p>
</div>
<p>where the circles are the objects and the arrows are methods invocations from one object on another.</p>
<p>If we take the web metaphor a little bit further, we can note some similarities to e.g. a TCP network:</p>
<ol style="list-style-type: decimal">
<li>An object can send <strong>messages</strong> to other objects (i.e. call methods on them - arrows on the above diagram) using <strong>interfaces</strong>. Each message has a <strong>sender</strong> and a <strong>recipient</strong>.</li>
<li>In order to send a message to a recipient, a sender has to acquire an <strong>address</strong> of the recipient, which, in object oriented world, we call a reference (actually, prior to virtual machines, references were just that - addresses in memory. With virtual machines around, this may be a little more complicated).</li>
<li>A communication between sender and recipients has to obey certain <strong>protocol</strong> (don’t worry if you do not see th analogy now - I’ll follow up with more explanation of this topic later).</li>
</ol>
<p>Let us try to apply this terminology to an example. Let’s say that we have an anti-fire alarm system in an office that, when triggered, makes all lifts go to bottom floor, opens them and then disables them. Among others, the office contains automatic lifts, that contain their own control systems and mechanical lifts, that are controlled from the outside by a special custom mechanism. Now to write some code! We will have some objects like alarm, automatic lift and mechanical lift.</p>
<p>First, we do not want the alarm to have to distinguish between automatic and mechanical lifts - this would only add complexity to alarm system. Thus, we need a special <strong>interface</strong> (let’s call it <code>Lift</code>) to communicate with both <code>AutoLift</code> and <code>MechanicalLift</code>. Through this interface, an alarm will be able to send messages to both types of lifts without having to know a difference between them.</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Lift
{
  ...
}

<span class="kw">public</span> <span class="kw">class</span> AutoLift : Lift
{
  ...
}

<span class="kw">public</span> <span class="kw">class</span> MechanicalLift : Lift
{
  ...
}</code></pre>
<p>Next, to be able to communicate with specific lifts through the <code>Lift</code> interface, an alarm object has to acquire <strong>“addresses”</strong> of the lift objects (i.e. references to them). We can pass them e.g. through a constructor:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Alarm
{
  <span class="co">//obtain &quot;addresses&quot; through here</span>
  <span class="kw">public</span> <span class="fu">Alarm</span>(IEnumerable&lt;Lift&gt; lifts)
  {
    <span class="co">//store the &quot;addresses&quot; for later use</span>
    _lifts = lifts;
  }

  <span class="kw">private</span> <span class="kw">readonly</span> IEnumerable&lt;Lift&gt; _lifts;

}</code></pre>
<p>Then, the alarm can send three kinds of <strong>messages</strong>: <code>GoToBottomFloor()</code>, <code>OpenDoor()</code>, and <code>DisablePower()</code> to any of the lifts through the <code>Lift</code> interface:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Lift
{
  <span class="dt">void</span> <span class="fu">GoToBottomFloor</span>();
  <span class="dt">void</span> <span class="fu">OpenDoor</span>();
  <span class="dt">void</span> <span class="fu">DisablePower</span>();
}</code></pre>
<p>and, as a matter of fact, it sends all these messages when triggered:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
{
  <span class="kw">foreach</span>(var lift <span class="kw">in</span> _lifts)
  {
    lift.<span class="fu">GoToBottomFloor</span>();
    lift.<span class="fu">OpenDoor</span>();
    lift.<span class="fu">DisablePower</span>();
  }
}</code></pre>
<p>By the way, note that the order in which the messages are sent <strong>does</strong> matter. For example, if we disabled the power first, asking the powerless lift to go anywhere would be impossible.</p>
<p>In this communication, <code>Alarm</code> is a <strong>sender</strong> - it knows what it is sending, it knows why, but does not know exactly what are the recipients going to do when they receive the message - its knowledge ends on the fact that it is communicating through the <code>Lift</code> interface. The rest is left to objects that implement <code>Lift</code> (namely, <code>AutoLift</code> and <code>MechanicalLift</code>). They are <strong>recipients</strong> - they do not know who they got the message from (unless they are told in the content of the message somehow - but even then they can be cheated), but they know how to react, based on who they are, what the kind of the message they received and what’s the message content (i.e. method arguments - in this simplistic example there are none, actually).</p>
<p>To illustrate that this separation between a sender and a recipient does, in fact, exist, it is sufficient to say that we could even write an implementation of <code>Lift</code> interface that would just ignore the messages it got from the alarm (or fake that it did what it was asked for) and the alarm will not even notice.</p>
<div class="figure">
<img src="./images/SenderRecipientMessage.png" alt="Sender, interface, and recipient" /><p class="caption">Sender, interface, and recipient</p>
</div>
<p>Ok, I hope we got that part straight. Time for some new requirements. It has been decided that whenever any malfunction happens in the lift when it is executing the alarm emergency procedure, the lift object should report this by throwing an exception called <code>LiftUnoperationalException</code>. This affects both <code>Alarm</code> and implementations of <code>Lift</code>:</p>
<ol style="list-style-type: decimal">
<li>The <code>Lift</code> implementations need to know that when a malfunction happens, they should report it by throwing the said exception.</li>
<li>The <code>Alarm</code> must be ready to handle the exception thrown from lifts and act accordingly (e.g. still try to secure other lifts).</li>
</ol>
<p>Here is an exemplary code of <code>Alarm</code> handling the malfunction reports:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
{
  <span class="kw">foreach</span>(var lift <span class="kw">in</span> _lifts)
  {
    <span class="kw">try</span>
    {
      lift.<span class="fu">GoToBottomFloor</span>();
      lift.<span class="fu">OpenDoor</span>();
      lift.<span class="fu">DisablePower</span>();
    }
    <span class="kw">catch</span>(LiftUnoperationalException e)
    {
      report.<span class="fu">ThatCannotSecure</span>(lift);
    }
  }
}</code></pre>
<p>In other words, there is a <strong>protocol</strong> between <code>Alarm</code> and <code>Lift</code> that must be adhered to by both sides.</p>
<h2 id="summary-5"><a href="#summary-5">Summary</a></h2>
<p>Each of the objects in the web can receive messages and most of them send messages to other objects. Throughout the next chapters, I will refer to an object sending a message as sender and an object receiving a message as recipient.</p>
<h1 id="composing-a-web-of-objects"><a href="#composing-a-web-of-objects">Composing a web of objects</a></h1>
<h2 id="three-important-questions"><a href="#three-important-questions">Three important questions</a></h2>
<p>Ok, I told you that there is such a thing as a web of objects exists, that there are connections, protocols and such, but there is one thing I left out: how does a web of objects come into existence?</p>
<p>This is, of course, a fundamental question, because if we are not able to build a web, we do not have a web. The question itself is a little more tricky that you may think and it contains three other questions that we need to answer:</p>
<ol style="list-style-type: decimal">
<li>How does an object obtain a reference to another one in the web?</li>
<li>When are objects composed?</li>
<li>Where are objects composed?</li>
</ol>
<p>For now, you may have some trouble understanding why these questions are important, but the good news is that you won’t have to trust me too long, because these questions are the topic of this chapter.</p>
<p>Before we take a deep dive, let’s try to answer these questions for a really simple example code of a console application:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)
{
  <span class="dt">var</span> sender = <span class="kw">new</span> <span class="fu">Sender</span>(<span class="kw">new</span> <span class="fu">Recipient</span>());
}</code></pre>
<ol style="list-style-type: decimal">
<li>How does an object (<code>Sender</code>) obtain a reference to another one (<code>Recipient</code>)? The reference is passed through constructor.</li>
<li>When are objects composed? During application startup.</li>
<li>Where are objects composed? At application entry point (<code>Main()</code> method)</li>
</ol>
<p>Depending on circumstances, we have sets of best answers to these questions. But first, let us take the questions on one by one.</p>
<h2 id="how-does-sender-obtain-a-reference-to-recipient"><a href="#how-does-sender-obtain-a-reference-to-recipient">How does sender obtain a reference to recipient?</a></h2>
<p>There are few ways, each of them useful in certain circumstances:</p>
<h3 id="pass-as-constructor-parameter"><a href="#pass-as-constructor-parameter">Pass as constructor parameter</a></h3>
<p>Two objects can be composed by passing one into the constructor of another:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender = <span class="kw">new</span> <span class="fu">Sender</span>(recipient);</code></pre>
<p>A sender is composed with a recipient and saves a reference to the recipient in a private field for later, like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="fu">Sender</span>(Recipient recipient)
{
  <span class="kw">this</span>.<span class="fu">_recipient</span> = recipient;
}</code></pre>
<p>Composing using constructors has one significant advantage. The code that passes <code>Recipient</code> to <code>Sender</code> through constructor is most often in a totally different place than the code using <code>Sender</code>. Thus, the code using <code>Sender</code> is not aware that <code>Sender</code> stores a reference to <code>Recipient</code> inside it. This basically means that when <code>Sender</code> is used, e.g. like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender.<span class="fu">DoSomething</span>()</code></pre>
<p><code>Sender</code> may send message to <code>Recipient</code> internally, but the code invoking the <code>DoSomething()</code> method is completely unaware of that. Which is good, because “what you hide, you can change” - if we decide that the <code>Sender</code> needs not use the <code>Recipient</code> to do its duty, the code that uses <code>Sender</code> does not need to change at all - it still uses the <code>Sender</code> the same way:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender.<span class="fu">DoSomething</span>()</code></pre>
<p>All we have to change is the composition code:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//no need to pass a reference to Recipient anymore</span>
sender = <span class="kw">new</span> <span class="fu">Sender</span>();</code></pre>
<p>Passing into constructor is a great way to compose sender with a recipient permanently. In order to be able to do this, a <code>Recipient</code> must, of course, exist before a <code>Sender</code> does. Another less obvious requirement for this composition is that <code>Recipient</code> must be usable at least as long as <code>Sender</code> is usable. In other words, the following is nonsense:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender = <span class="kw">new</span> <span class="fu">Sender</span>(recipient);
recipient.<span class="fu">Dispose</span>(); <span class="co">//but sender is unaware of it </span>
                     <span class="co">//and may still use recipient in:</span>
sender.<span class="fu">DoSomething</span>();</code></pre>
<h3 id="pass-inside-a-message-i.e.as-a-method-parameter"><a href="#pass-inside-a-message-i.e.as-a-method-parameter">Pass inside a message (i.e. as a method parameter)</a></h3>
<p>Another common way of composing objects together is passing one object as a parameter of another object’s method call:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender.<span class="fu">DoSomethingWithHelpOf</span>(recipient);</code></pre>
<p>In such case, the objects are most often composed temporarily, just for the time of execution of this single method:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">DoSomethingWithHelpOf</span>(Recipient recipient)
{
  <span class="co">//... perform some logic</span>
  
  recipient.<span class="fu">HelpMe</span>();
  
  <span class="co">//... perform some logic</span>
}</code></pre>
<p>This is a great way to compose objects when we want to use the same sender with different recipients at different times (most often from different parts of the code):</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//in one place</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(recipient);

<span class="co">//in another place:</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(anotherRecipient);

<span class="co">//in yet another place:</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(yetAnotherRecipient);</code></pre>
<h3 id="return-recipient-from-a-method"><a href="#return-recipient-from-a-method">Return recipient from a method</a></h3>
<p>This method of composing objects uses another intermediary object - a factory (that creates new recipient instance on each call) or a cache (that usually yields the same object many times when asked with the same arguments). Most often, the sender is given a reference to this intermediary object as a constructor parameter (an approach we already discussed):</p>
<pre class="sourceCode cs"><code class="sourceCode cs">sender = <span class="kw">new</span> <span class="fu">Sender</span>(factory);</code></pre>
<p>and then the intermediary object is used to deliver other objects:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Sender
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="fu">DoSomething</span>() 
  {
    <span class="dt">var</span> recipient = _factory.<span class="fu">CreateRecipient</span>();
    recipient.<span class="fu">DoSomethingElse</span>();
  }
}</code></pre>
<p>This kind of composition is beneficial when a different recipient is needed each time <code>DoSomething()</code> is called (much like in case of previously discussed approach of passing recipient as a method parameter), but at the same time (contrary to passing recipient as a method parameter), the code using the <code>Sender</code> should not (or cannot) be responsible for supplying a recipient.</p>
<p>To be more clear, here is a comparison of two approaches: passing recipient inside a message:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//user of Sender passes a recipient:</span>
<span class="kw">public</span> <span class="fu">DoSomething</span>(Recipient recipient) 
{
  recipient.<span class="fu">DoSomethingElse</span>();
}</code></pre>
<p>and obtaining from factory:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//user of Sender does not know about Recipient</span>
<span class="kw">public</span> <span class="fu">DoSomething</span>() 
{
  <span class="dt">var</span> recipient = _factory.<span class="fu">CreateRecipient</span>();
  recipient.<span class="fu">DoSomethingElse</span>();
}</code></pre>
<h3 id="register-a-recipient-with-already-created-sender"><a href="#register-a-recipient-with-already-created-sender">“Register” a recipient with already created sender</a></h3>
<p>This means passing a recipient to an <strong>already created</strong> sender (contrary to passing as constructor parameter where recipient was passed <strong>during</strong> creation) as a parameter of a method that stores the reference for later use. This may be a “setter” method, although I do not like naming it according to convention “setWhatever()” - after Kent Beck (Implementation Patterns book) I find this convention too much implementaion-focused instead of purpose-focused. Thus, I pick different names based on what domain concept is modeled by the registration method or what is its purpose.</p>
<p>Note that this is similar to “pass inside a message” approach, only this time, the passed recipient is not used immediately and forgotten, but rather remembered for later use.</p>
<p>Anyway, a quick example. Suppose we have a temperature sensor that can report its current and historically mean value for the current date to whoever registers with it. If no one registers, it still does its job, because mean value is based on historical data and someone might register for it at any time, right? So, part of the definition of such a sensor could look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> TemperatureSensor
{
  <span class="kw">private</span> TemperatureObserver _observer 
    = <span class="kw">new</span> <span class="fu">NullObserver</span>(); <span class="co">//ignores values by default</span>
  <span class="kw">private</span> Temperature _meanValue = Temperature.<span class="fu">Zero</span>();
  <span class="co">//+ maybe more fields related to storing historical data</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Run</span>()
  {
    <span class="kw">while</span>(<span class="co">/* needs to run */</span>)
    {
      var currentValue = <span class="co">/* get current value somehow */</span>;
      _meanValue = <span class="co">/* update mean value somehow */</span>;

      _observer.<span class="fu">NotifyOn</span>(currentValue, _meanValue);
      
      <span class="fu">WaitUntilTheNextMeasurementTime</span>();
    } 
  }
}</code></pre>
<p>As you can see, by default, the sensor reports its values to nowhere (<code>NullObserver</code>), which is a safe default value (using a <code>null</code> instead would cause exceptions or force us to put an ugly null check inside the <code>Run()</code> method). Still, we want to be able to supply our own observer one day, when we start caring about the measured and calculated values. This means we need to have a method inside the <code>TemperatureSensor</code> class to overwrite this default “do-nothing” observer with one that we provide:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">FromNowOnReportTo</span>(TemperatureObserver observer)
{
  _observer = observer;
}</code></pre>
<p>This lets us overwrite the observer with a new one should we ever need to do it.</p>
<p>Time for a general remark. Allowing registering recipients after a sender is created is a way of saying: “the recipient is optional - if you provide one, fine, if not, I will do my work without it”. Please, do not use this kind of mechanism for required recipients - these should all be passed through constructor, making it harder to create invalid objects that are only partially ready to work. Placing a recipient in a constructor signature is effectively saying that “I will not work without it”.</p>
<p>Now, the observer API we just skimmed over gives us the possibility to have a single observer at any given time. When we register new observer, the reference to the old one is overwritten. This is not really useful in our context, is it? With real sensors, we often want them to report their measurements to multiple places (e.g. we want the measurements printed on screen, saved to database, used as part of more complex calculations). This can be achieved in two ways.</p>
<p>The first way would be to just hold a collection of observers in our sensor, and add to this collection whenever a new observer is registered:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">IList&lt;TemperatureObserver&gt; _observers 
  = <span class="kw">new</span> List&lt;TemperatureObserver&gt;();

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">FromNowOnReportTo</span>(TemperatureObserver observer)
{
  _observers.<span class="fu">Add</span>(observer);
}</code></pre>
<p>In such case, reporting would mean iterating over the observers list:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">...
<span class="kw">foreach</span>(var observer <span class="kw">in</span> _observers)
{
  observer.<span class="fu">NotifyOn</span>(currentValue, meanValue);
}
...</code></pre>
<p>Another, more flexible option, is not to introduce this collection in the sensor, but instead, create a special kind of “broadcasting observer” that would hold collection of other observers (welcome composability!) and broadcast the values to them every time it itself receives those values. It could be created and registered like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">var broadcastingObserver 
  = <span class="kw">new</span> <span class="fu">BroadcastingObserver</span>(
      <span class="kw">new</span> <span class="fu">DisplayingObserver</span>(),
      <span class="kw">new</span> <span class="fu">StoringObserver</span>(),
      <span class="kw">new</span> <span class="fu">CalculatingObserver</span>());

sensor.<span class="fu">FromNowOnReportTo</span>(broadcastingObserver);</code></pre>
<p>This would let us change the broadcasting implementation without touching either the sensor code or the other observers. For example, we might introduce <code>ParallelBroadcastObserver</code> that would notify each observer asynchronously instead of sequentially and put it to use by changing the composition code only:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">var broadcastingObserver 
  = <span class="kw">new</span> <span class="fu">ParallelBroadcastObserver</span>(
      <span class="kw">new</span> <span class="fu">DisplayingObserver</span>(),
      <span class="kw">new</span> <span class="fu">StoringObserver</span>(),
      <span class="kw">new</span> <span class="fu">CalculatingObserver</span>());

sensor.<span class="fu">FromNowOnReportTo</span>(broadcastingObserver);</code></pre>
<p>Anyway, as I said, use registering instances very wisely and only if you specifically need it. Also, if you do use it, evaluate how allowing changing observers at runtime is affected by multithreading scenarios. This is because maintaining a changeable field (or a collection) throughout the object lifetime means that multiple thread might access it and get in each other’s way.</p>
<h2 id="where-are-objects-composed"><a href="#where-are-objects-composed">Where are objects composed?</a></h2>
<p>Ok, we went over some ways of passing a recipient to a sender. The big question is: which code is going to pass the reference?</p>
<p>For almost all of the approaches described above there is no limitation - you pass the reference where you need to pass it.</p>
<p>There is one approach, however, that is more limited, and this approach is <strong>passing as constructor parameter</strong>.</p>
<p>Why is that? Well, remember we were talking about separating objects usage from construction, right? And invoking constructor imples creating an object, right? Which implies that we can assemble objects using constructors only in the places we separated creation of objects to.</p>
<p>Typically, there are two such types of places: <strong>composition root</strong> and <strong>factories</strong>. Let us take them one by one.</p>
<h3 id="composition-root"><a href="#composition-root">Composition Root</a></h3>
<p>A composition root is a location near application entry point where you compose the part of the system on which you invoke your <code>Run()</code>, <code>Execute()</code>, <code>Go()</code> or whatever.</p>
<p>For simplification, let’s take an example of a console application. Usually, when not using any framework, your application is symbolized as a class:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span>(<span class="dt">string</span>[] args)
{
  <span class="dt">var</span> myApplication = <span class="kw">new</span> <span class="fu">MyApplication</span>();
  myApplication.<span class="fu">RunWith</span>(args);
}</code></pre>
<p>The above is a simple composition root.</p>
<p>TODO</p>
<h3 id="factories"><a href="#factories">Factories</a></h3>
<p>Factories are objects responsible for creating other objects. They are a layer of abstraction over constructors. A lot of times I talk with people, they do not understand the benefits of using factories “since we already have the <code>new</code> operator”. But factories present a number of benefits:</p>
<p>TODO what a factory is? a small example?</p>
<h4 id="they-allow-creating-objects-polymorphically"><a href="#they-allow-creating-objects-polymorphically">They allow creating objects polymorphically</a></h4>
<p>Typically, a return type of a factory is an interface or, at worst, an abstract class. This means that whatever uses the factory, knows only that it receives an object of that type.</p>
<p>Let’s say we have a factory like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Version1ProtocolMessageFactory
{
  <span class="kw">public</span> Message <span class="fu">createFrom</span>(MessageData rawData)
  {
    <span class="kw">switch</span>(rawData.<span class="fu">MessageType</span>)
    {
      <span class="kw">case</span> Messages.<span class="fu">SessionInit</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionInit</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionEnd</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionEnd</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionPayload</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionPayload</span>(rawData);
      <span class="kw">default</span>:
        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">UnknownMessage</span>(rawData);
    }
  }
}</code></pre>
<p>Note that the factory can create many different types of messages depending on what is in the raw data, but for the user of the factory, this is irrelevant. All that is seen by the user is this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="dt">var</span> message = _messageFactory.<span class="fu">NewInstanceFrom</span>(rawData);
message.<span class="fu">ValidateUsing</span>(_primitiveValidations);
message.<span class="fu">ApplyTo</span>(_sessions);</code></pre>
<p>So, whatever is going on in the factory, it is hidden from the users of the factory.</p>
<p>TODO no need to change if rule changes</p>
<h4 id="they-are-themselves-polymorphic"><a href="#they-are-themselves-polymorphic">They are themselves polymorphic</a></h4>
<p>So far, I keep talking about composability over and over again so much that you’re probably already sick of the word. But hey, here comes another benefit of the factory - in contrast to constructors, they are composable.</p>
<p>We may have a class that uses a factory:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> MessageInbound
{
  <span class="kw">private</span> MessageFactory _factory;
  
  <span class="kw">public</span> <span class="fu">MessageInbound</span>(MessageFactory factory)
  {
    _factory = factory;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Process</span>(MessageData data)
  {
    Message message = _factory.<span class="fu">NewMessageFrom</span>(data);
    message.<span class="fu">ValidateUsing</span>(_primitiveValidations);
    message.<span class="fu">ApplyTo</span>(_system);
  }
}</code></pre>
<p>Object of this class needs to be composed with factory implementing the <code>MessageFactory</code> interface in a composition root like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">new</span> <span class="fu">MessageInbound</span>(<span class="kw">new</span> <span class="fu">BinaryMessageFactory</span>());</code></pre>
<p>Suppose that one day we need to reuse the logic of <code>MessageInbound</code> in another place, but make it create XML messages instead of binary messages. If we used a constructor to create messages, we would need to either copy-paste the <code>MessageInbound</code> class code and change the line where message is created, or we would need to make an <code>if</code> statement inside the <code>MessageInbound</code> to choose which message we are required to create.</p>
<p>This is not reuse - this is hacking.</p>
<p>Thankfully, thanks to the factory, we can use the <code>MessageInbound</code> just as it is, but compose it with a different factory. So, we will have to instances of <code>MessageInbound</code> class in our composition root:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">var binaryMessageInbound
  = <span class="kw">new</span> <span class="fu">MessageInbound</span>(
      <span class="kw">new</span> <span class="fu">BinaryMessageFactory</span>(), 
      BinListenAddress); 

var xmlMessageInbound
  = <span class="kw">new</span> <span class="fu">MessageInbound</span>(
      <span class="kw">new</span> <span class="fu">XmlMessageFactory</span>(), 
      XmlListenAddress);</code></pre>
<p>TODO make each a subchapter of L4</p>
<ol style="list-style-type: decimal">
<li>They allow creating objects polymorphically (hiding of created type):</li>
<li>They are themselves polymorphic (hiding of object creation rule)</li>
<li>They allow putting more complex creation logic in one place (reduce redundancy)</li>
<li>They allow decoupling from some of the dependencies of created objects (lower coupling)</li>
<li>They allow naming rulesets for object creation (better readability)</li>
</ol>
<h2 id="when-are-objects-composed"><a href="#when-are-objects-composed">When are objects composed?</a></h2>
<p>Most of our system is assembled up-front when the application starts and stays this way until the application finishes executing. But not all of it. Let’s call this part the static part of the web. We will talk about <strong>composition root</strong> pattern that guides definition of that part.</p>
<p>Apart from that, there’s the dynamic part. The first thing that leads to this dynamism is the lifetime of the objects that are connected. Some objects represent requests that arrive during the application runtime, are processed and then discarded. When there is no need to process such a request anymore, the objects representing it are discarded as well. Other objects represent items in the cache that live for some time and then expire etc. so it’s impossible to define these objects up-front. Soon, we will talk about the <strong>Factory</strong> pattern that will let us handle creation and composition of such short-lived objects.</p>
<p>Another thing affecting the dynamic part of the web is the temporary character of connections themselves. The objects may have a lifespan as long as the application itself, but be connected only the needs of a single interaction (e.g. when one object is passed to a method of another as an argument) or at some point during the application runtime. We will talk about doing these things by passing objects inside messages and by using the <strong>Observer</strong> pattern.</p>
<h2 id="where-are-objects-composed-1"><a href="#where-are-objects-composed-1">Where are objects composed?</a></h2>
<p>First, let’s take a look at different ways of acquiring an object by another object:</p>
<p>Now that we discussed how to pass a reference to recipient into a sender, let’s take a look at places it can be done:</p>
<p>TODO factory and composition root</p>
<h1 id="worse-and-better-composability"><a href="#worse-and-better-composability">Worse and better composability</a></h1>
<p>Some classes are harder to compose with other classes, others are easier. There are numerous factors influencing this:</p>
<h3 id="classes-vs-interfaces"><a href="#classes-vs-interfaces">Classes vs interfaces</a></h3>
<p>As we said, an object is composed with another object by obtaining a reference to something. Also, we said that we want the flexibility of plugging in objects of different classes at different times. This is, of course, done using polymorphism, as Johnny and Benjamin did when cleaning up the payroll system. So, what should be the base for polymorphism? Is a class sufficient, or do we rather want to use an interface? In other words, when we plug in an object as a message receipient:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="fu">Sender</span>(Recipient recipient)
{
  <span class="kw">this</span>.<span class="fu">_recipient</span> = recipient;
}</code></pre>
<p>Should the Recipient be a class or an interface?</p>
<p>If we assume that Recipient is a class, we can get the composability we want by deriving another class from it and overriding methods. However, using a class as a base for composability has the following weaknesses:</p>
<ol style="list-style-type: decimal">
<li>The superclass may have real dependencies. For example, if <code>Recipient</code> class depends on WCF stack, then everywhere we take our Sender to compose it with different recipients, we must also take our <code>Recipient</code> and its WCF dependency.</li>
<li>We force each recipient class we want to compose our sender with to invoke a constructor from superclass, which, depending on the complexity of the superclass, may be smaller or bigger trouble.</li>
<li>In languages like C#, when only single inheritance exists all the classes that want to be composed with our <code>Sender</code>, we waste the only inheritance slot, further constraining the inheriting classes.</li>
<li>We must take care to make all methods of <code>Recipient</code> superclass virtual to enable overriding by subclasses. otherwise, we won’t have full composability.</li>
</ol>
<p>As you see, there are some difficulties using classes as “slots for composability”, even if composition is possible this way. Thus, interfaces are far better, just because they are easier to use for this purpose.</p>
<p>It is decided then, If a sender wants to be composable with recipient, it has to accept a reference to recipient in form of interface reference. We can say that, by being light-weight and implementationless, <strong>interfaces can be treated as “slots” for plugging in different objects</strong>.</p>
<p>In fact, when we look at how interfaces are depicted on UML class diagrams, it seems that the “interface as slot for composition” notion is not unusual:</p>
<p>TODO insert a picture showing one notation of interfaces in UML.</p>
<p>It is just that we try to take the notion of composability to its fullest, as not only a first-class citizen, but as THE most important aspect of our design approach.</p>
<h3 id="eventscallbacks-vs-interfaces---few-words-on-roles"><a href="#eventscallbacks-vs-interfaces---few-words-on-roles">Events/callbacks vs interfaces - few words on roles</a></h3>
<p>Hey, didn’t I just say that composability is “THE most important aspect of our design approach”? Wow, that’s quite a statement, isn’t it? Unfortunately for me, it also lets you jump with the following argument: “what about events that e.g. C# supports? Or callbacks that are supported almost everywhere? Wouldn’t it make the classes even more context-independent, if we made them communicate by events or callbacks, not by some strange interfaces?”</p>
<p>Actually, it would, and we could, but it would also strip us from another very important aspect of our design approach that I did not mention explicitly until now. This aspect is: roles.</p>
<p>When we take an example method that sends some messages to some recipients:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">recipient1.<span class="fu">DoX</span>();
recipient1.<span class="fu">DoY</span>();
recipient2.<span class="fu">DoZ</span>();</code></pre>
<p>and we compare it with similar effect achieved using event/callback invocation:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">DoX.<span class="fu">Invoke</span>();
DoY.<span class="fu">Invoke</span>();
DoZ.<span class="fu">Invoke</span>();</code></pre>
<p>We can see that we are losing the notion of which message belongs to which recipient - each event is standalone from the point of view of the sender. This is unfortunate, because in our design approach, we want to highlight the roles each receiver plays in the communication, to make the communication itself readable and logical. Also, ironically, decoupling this way using events or callbacks can hinder composability, because the set of responsibilities that fits a single role is usually cohesive. Thus, even if we separated it into several events or callbacks, their composition would be changing together anyway, and an overhead would be put on us to remember which events should be changed together, and which ones separately.</p>
<p>This does not mean that events or callbacks are bad. It’s just that they are not a fit replacement for interfaces - in reality, their purpose is a little bit different. We use events or callbacks not to do somebody to do something, but to indicate what happened (that’s why we call them events, after all…). This fits the observer case we talked about quite well. So, instead of using observer objects, we may consider using events or callbacks instead (as in everything, there are some tradeoffs for each of the solutions). In other words, events and callbacks have their role in the composition, but fit a case so specific, that they cannot be used as a basis for the composition. The advantage of the interfaces is that they bind together messages, which should be implemented cohesively, and symbolize roles in the communication, which improves readability.</p>
<h3 id="small-interfaces"><a href="#small-interfaces">Small interfaces</a></h3>
<p>Ok, so we said that he interfaces are “the way to go” for reaching the strong composability we’re striving for. Is it enough just to “have interfaces”? No, actually, it’s not.</p>
<p>One of the other things we need to consider is the size of interfaces. Let’s state one thing that is obvious in regard to this:</p>
<p><strong>All other things equal, smaller interfaces are easier to implement that bigger interfaces.</strong></p>
<p>The obvious conclusion from this is that if we want to have really strong composability, our “slots”, i.e. interfaces, have to be as small as possible (but not smaller - see previous section on interfaces vs events/callbacks. Interfaces must bind together messages that should be handled cohesively). Of course, we cannot achieve this by just removing methods that are needed from the interfaces, e.g. when someone is using an interface implementation like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">recipient.<span class="fu">SomethingHappened</span>();
recipient.<span class="fu">SomethingElseHappened</span>();</code></pre>
<p>It is impossible to just remove either method from the interface, or the client will stop compiling.</p>
<p>So, what do we do then? We try to separate different interfaces per client. After all, a class can implement more than one interface, like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> ImplementingObject 
: InterfaceForClient1, 
  InterfaceForClient2,
  InterfaceForClient3
{ ... }</code></pre>
<p>This notion of using a separate interface per client and not one bigger interface for different clients is known as the Interface Segregation Principle.</p>
<h4 id="a-simple-example-separation-of-reading-from-writing"><a href="#a-simple-example-separation-of-reading-from-writing">A simple example: separation of reading from writing</a></h4>
<p>For example, we may have a class representing organizational structure in our application. On one hand, the application is notified on any changes that are made from administration interface. On the other hand, it supports client-side operations for ordinary users, e.g. listing all users. The interface for this organizational structure class may look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> 
OrganizationStructure
{
  <span class="co">//administrative part:</span>
  <span class="dt">void</span> <span class="fu">Make</span>(Change change);
  
  <span class="co">//client-side part:</span>
  <span class="dt">void</span> <span class="fu">ListAllEmployees</span>(
    EmployeeDestination destination);
}</code></pre>
<p>but, most certainly, the two sets of methods will be used by different code - one related to handling administrative requests, another related to handling ordinary user requests. Thus, we can use this knowledge to separate the interface into two:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span>
OrganizationalStructureAdminCommands
{
  <span class="dt">void</span> <span class="fu">Make</span>(Change change);
}

<span class="kw">public</span> <span class="kw">interface</span>
OrganizationalStructureClientCommands
{
  <span class="dt">void</span> <span class="fu">ListAllEmployees</span>(
    EmployeeDestination destination);
}</code></pre>
<p>And a real class can implement both of them:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> InMemoryOrganizationalStructure
: OrganizationalStructureAdminCommands,
  OrganizationalStructureClientCommands
{
  <span class="co">//...</span>
}</code></pre>
<p>Sure, there are more interfaces, but that doesn’t bother us much, because in return, each interface is easier to implement. In other words, it is easier to make new implementations we can compose users of those interfaces with. This means that composability is enhanced, which is what we want the most. After all, nobody said there will always be a single class implementing both interfaces. One day, we maye get a requirement that all writes to the organizational structure have to be traced. In such case, All we have to do is to create new class implementing <code>OrganizationalStructureAdminCommands</code> which will wrap the original method with a notification to a change observer (that can be either the trace that is required or anything else we like):</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> NotifyingAdminComands : OrganizationalStructureAdminCommands
{
  <span class="kw">public</span> <span class="fu">NotifyingCommands</span>(
    OrganizationalStructureAdminCommands wrapped,
    ChangeObserver observer)
  {
    _wrapped = wrapped;
    _observer = observer;
  }

  <span class="dt">void</span> <span class="fu">Make</span>(Change change)
  { 
    _wrapped.<span class="fu">Make</span>(change);
    _observer.<span class="fu">NotifyAbout</span>(change);
  }
}</code></pre>
<p>If we did not separate interfaces for admin and client access, in our <code>NotifyingAdminComands</code> class, we would have to implement the <code>ListAllEmployees</code> method and make it delegate to the original wrapped instance. Splitting the interface into two smaller ones spared us this trouble.</p>
<h4 id="interfaces-should-be-depend-on-abstractions-not-implementation-details"><a href="#interfaces-should-be-depend-on-abstractions-not-implementation-details">Interfaces should be depend on abstractions, not implementation details</a></h4>
<p>Some might think that interface is an abstraction by definition. I believe otherwise - while interfaces abstract away the concrete type of the class that is implementing the interface, it may still contain some other things not abstracted, especially implementation details. Let’s look at the following interface:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Basket
{
  <span class="dt">void</span> <span class="fu">WriteTo</span>(SqlConnection sqlConnection);
  <span class="dt">bool</span> <span class="fu">IsAllowedToEditBy</span>(SecurityPrincipal user);
}</code></pre>
<p>See the arguments of those methods? <code>SqlConnection</code> is a library object for interfacing directly with SQL Server database, so it is a very concrete dependency. <code>SecurityPrincipal</code> is one of the core classes of .NET’s authentication and authorization model for local users database and Active Directory, so again, a very concrete dependency. With dependencies like that, it will be very hard to write other implementations of this interface, because we will be forced to drag around concrete dependencies and mostly will not be able to work around that if we want something different. Thus, it is essential to rely on abstractions:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Basket
{
  <span class="dt">void</span> <span class="fu">WriteTo</span>(ProductOutput output);
  <span class="dt">bool</span> <span class="fu">IsAllowedToEditBy</span>(BasketOwner user);
}</code></pre>
<p>This is better. For example, as <code>ProductOutput</code> is a higher level abstraction (most probably an interface, as we discussed earlier), the implementations of the <code>Basket</code> interface can be developed independently from the specific output type and the <code>WriteTo()</code> method is more useful as it can be reused with different kinds of outputs.</p>
<h3 id="protocols"><a href="#protocols">Protocols</a></h3>
<p>So, we said that objects are connected (composed) together and communicate through interfaces, just as in IP network. There is another similarity though, that’s as important. It’s protocols (you can also encounter them by the name of contracts).</p>
<h4 id="protocols-exist"><a href="#protocols-exist">Protocols exist</a></h4>
<p>I do not want to introduce any scientific definition, so let’s just establish an understanding that protocols are sets of rules about how objects communicate with each other. Really? Are there any rules? Is it not enough the the objects can be composed together through interfaces? Well, not, it’s not enough and let me give you a quick example.</p>
<p>Let us imagine a class <code>Sender</code> that uses <code>Recipient</code> like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">if</span>(recipient.<span class="fu">ExtractStatusCodeFrom</span>(response) == -<span class="dv">1</span>)
{
  observer.<span class="fu">NotifyErrorOccured</span>();
}</code></pre>
<p>Stupid as it is, the example shows one important thing. Whoever the recipient is, it is expected to report error as -1. Otherwise, the <code>Sender</code> will not be able to react to the error situation appropriately. Similarly, the recipient must not report “no error” situation as -1, because if it does, this will be mistakenly recognized as error by <code>Sender</code>. So for example this implementation of <code>Recipient</code>, although implementing the required interface, is wrong from the point of view of <code>Sender</code>:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> WrongRecipient : Recipient
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">ExtractStatusFrom</span>(Response response)
  {
    <span class="kw">if</span>( <span class="co">/* success */</span> )
    {
      <span class="kw">return</span> -<span class="dv">1</span>; <span class="co">// but other than -1 should be used!</span>
    }
    <span class="kw">else</span>
    {
      <span class="kw">return</span> <span class="dv">1</span>; <span class="co">// -1 should be used!</span>
    }
  }
}</code></pre>
<p>So as you see, we cannot just write anything in a class implementing an interface, because of protocol that imposes certain contract on both the sender and recipient. This contract may not only be about return values, it can also be on types of exceptions thrown, or the order of method calls. For example, anybody using some kind of connection object would imagine the following way of using the connection:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">connection.<span class="fu">Open</span>();
connection.<span class="fu">Send</span>(data);
connection.<span class="fu">Close</span>();</code></pre>
<p>Again, if we were to implement a connection that behaves like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> WrongConnection : Connection
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Open</span>()
  {
    <span class="co">//...close connection</span>
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Close</span>()
  {
    <span class="co">//...open connection</span>
  }
}</code></pre>
<p>it would compile just fine, but fail badly when executed.</p>
<p>So, again, there are certain rules that restrict the way two objects can communicate. Both sender and recipient of a message must adhere to the rules, or the they will not be able to work together.</p>
<p>The good news is that WE are the ones who design these protocols, along with the interfaces, so we can design them to be harder or easier to adhere to by different implementations of an interface. Of course, we are wholeheartedly for the “easier” part. Thus, we want the communication between objects to be as stable as possible (see next section on the explanation of “as possible”).</p>
<h4 id="communication-patterns-stability"><a href="#communication-patterns-stability">Communication patterns stability</a></h4>
<p>Remember the change Johnny and Benjamin had to make in order to add another kind of employees to the application? In order to do that, they had to change existing interfaces and add new ones. This was a lot of work. We don’t want to do this much work every time we make a change. The reason they had to do so much changes was that the protocol between the objects they were dealing with was unstable. And they were unstable because they were:</p>
<ol style="list-style-type: decimal">
<li>complicated rather than simple</li>
<li>concrete rather than abstract</li>
<li>large rather than small</li>
</ol>
<p>Driven by why the stability of the protocols is bad, we can come up with some qualities that make protocols stable:</p>
<ol style="list-style-type: decimal">
<li>protocols should be simple</li>
<li>protocols should be abstract</li>
<li>protocols should be logical</li>
<li>protocols should be small</li>
</ol>
<p>And there are some heuristics that let us get closer to these qualities:</p>
<h4 id="short-interactions"><a href="#short-interactions">Short interactions</a></h4>
<p>TODO may be many small interfaces we interact with. Constructor bloat</p>
<h4 id="method-calls-crafted-from-the-perspective-of-senders"><a href="#method-calls-crafted-from-the-perspective-of-senders">Method calls crafted from the perspective of senders</a></h4>
<p>The protocols are simpler if they are designed from the perspective of the object that sends the signal, not the one that receives it. In other words, methods should be adjusted to exactly meet the needs of the senders.</p>
<p>As an example, let us look at a code for logging in:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">accessGuard.<span class="fu">SetLogin</span>(login);
accessGuard.<span class="fu">SetPassword</span>(password);
accessGuard.<span class="fu">Login</span>();</code></pre>
<p>In this little snippet, the sender must invoke three methods, even though there is no real need to divide the logic into three steps - they are all executed in the same place anyway. The maker of this class might have thought that this division makes the class more “general purpose”, but it seems this is a “premature optimization” that only makes it harder for the sender to work with the <code>accessGuard</code> object. Thus, the protocol that is simpler from the perspective of sender would be:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">accessGuard.<span class="fu">LoginWith</span>(login, password);</code></pre>
<p>Another lesson from the above example is: setters rarely reflect senders’ intention. Most often, they reflect the structure of the recipient. <code>myObject.SetX(x)</code> call suggests that <code>myObject</code> holds value X. But it is rarely the intention of objects that use <code>myObject</code> to store information in it (unless it is a data structure, e.g. a collection or a data persistence abstraction), rather, they want <code>myObject</code> to do something for them and the setter is just an intermediate step required by <code>myObject</code>. In such cases, setters should be either avoided or changed to something that reflects the intention better. For example, when dealing with observer pattern, we don’t want to say: <code>object.SetObserver(screen)</code>, but rather <code>object.RegisterObserver(screen)</code>.</p>
<p>Another thing is naming. The names of the methods (and interfaces for that matter) should be crafted from the perspective of the sender as well. In other words, the name of the method should not tell how thing is done (unless that matters from the perspective of the sender), but rather what is the intention of the sender that invokes the method. I love the example that Scott Bain gives in his Emergent Design book: if I told you “give me your driving license number”, you might’ve reacted differently based on whether the driving license is in your pocket, or your wallet, or your bag, or in your home and you have to call someone to give it to you. The point is: I, as a sender of this “give me your driving license number” message, do not care how you get it. I say <code>RetrieveDrivingLicenseNumber()</code>, not <code>OpenYourWalletAndReadTheNumber()</code>. This is important, because if the name represents the sender’s intention, the method will not have to be renamed when new classes are created that fulfill this intention in a different way.</p>
<h4 id="interactions-should-reflect-the-domain"><a href="#interactions-should-reflect-the-domain">Interactions should reflect the domain</a></h4>
<p>Sometimes at work, I am asked to conduct a design workshop. The example I often give to my colleagues is to design a system for order reservation. The thing that struck me the first few times I did this workshop was that nearly none of the attendees had an <code>Order</code> abstraction with <code>Reserve()</code> method on it. Most of the attendees assume that <code>Order</code> is a data structure and handle reservation by adding it to a “collection of reserved items”:</p>
<pre class="sourceCode cs"><code class="sourceCode cs">reservedOrders.<span class="fu">Add</span>(order)</code></pre>
<p>While this achieves the functionality they need to implement, it does not reflect the domain. Thus, it can be affected by changes other than domain changes. Thus, the interactions between objects become less stable.</p>
<p>On the other hand, let’s assume that we have a code for handling alarms. On each alarm, all gates are closed, sirens are turned on and message is sent to special forces with highest priority. Any error in this procedure leads to shutting down power in the building. If this workflow is coded like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">try</span>
{
  gates.<span class="fu">CloseAll</span>();
  sirens.<span class="fu">TurnOn</span>();
  specialForces.<span class="fu">NotifyWith</span>(Priority.<span class="fu">High</span>);
} 
<span class="kw">catch</span>(SecurityFailure failure)
{
  powerSystem.<span class="fu">TurnOffBecauseOf</span>(failure);
}</code></pre>
<p>Then the risk of this code changing for other reasons than the change of how domain works (e.g. we do not close the gates anymore but activate laser guns instead) is small. Thus, interactions that use abstractions and methods that directly express domain rules are more stable.</p>
<p>Object responsibilities change less often than their data and if they do, they affect the design in a more predictable way. If a design reflects the domain, a change in design that is a result of domain rules change is easier to predict. This contributes to maintainability and stability of the interactions and the design as a whole.</p>
<h4 id="objects-should-be-told-what-to-do-instead-of-asked-for-information"><a href="#objects-should-be-told-what-to-do-instead-of-asked-for-information">Objects should be told what to do, instead of asked for information</a></h4>
<p>This is probably one of the most important guidelines, known under the name of Tell Don’t Ask. When an object is asked to perform a task instead of asked questions, we have a change of switching the implementation of this task with another one.</p>
<p>So remember the payroll system that Johnny and Benjamin were working on? As long as their code for giving raise looked like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
{
 var newSalary 
  = employee.<span class="fu">GetSalary</span>() 
  + employee.<span class="fu">GetSalary</span>() 
  * <span class="fl">0.1</span>;
  employee.<span class="fu">SetSalary</span>(newSalary);
}</code></pre>
<p>They were unable to compose this code with another employees that had different raise rules applied to them, including voluntary employees that would not have raises, but may have bonuses.</p>
<p>Again, quoting Scott Bain, “what you hide, you can change”. Thus, telling an object what to do requires less knowledge than asking for data and information. Going back to the driver license example: I may ask another person for a driving license number to actually make sure they have the license and that it is valid (by checking the number somewhere). I may also ask another person to provide me with the directions to the place I want the first person to drive. But isn’t it easier to just tell “buy me some bread and butter”? Then, whoever I ask, has the freedom to either drive, or walk (if they know a good store nearby) or ask yet another person to do it instead. I don’t care as long as tomorrow morning, I find the bread and butter in my fridge.</p>
<p>This guideline should be trated very, very seriously and applied in almost an extreme way. There are few places where it does not apply and we’ll get back to them later.</p>
<h4 id="getters-should-be-removed-return-values-should-be-avoided"><a href="#getters-should-be-removed-return-values-should-be-avoided">Getters should be removed, return values should be avoided</a></h4>
<p>The above stated guideline of “Tell Don’t Ask” has a practical implication of getting rid of (almost) all the getters.</p>
<p>For me, this was very extreme at first, but in a short time I learned that this is actually how I am supposed to write object-oriented code. You see, I started learning programming using structural languages such as C, where a program was divided into procedures or functions and data structures. Then I moved on to object-oriented languages that allowed far better abstraction, but my style of coding didn’t really change much. I would still have procedures and functions, but now more abstract (divided into objects) and data structures, but now more abstract (i.e. objects with setters, getters and some other query methods).</p>
<p>But what alternatives do we have? Let’s say that we have a piece of software that handles user sessions (e.g. modeled using a <code>Session</code> class). We want to be able to display the sessions on the GUI, send the sessions through the network and persist them. How can we do this without getters? Should we put all the code for displaying, sending and storing inside the <code>Session</code> class? If we did that, we would couple a core domain concept (session) to a nasty set of third-party libraries (e.g. a particular GUI library), which would force us to tinker in core domain rules every time some GUI displaying concept changed. Also, if we did that, the <code>Session</code> would be hard to reuse, because every place we would want to reuse the class, we would need to take all these heavy libraries it depends on with us. So, our (not so good, as we will see) remedy may be to introduce getters for the information pieces stored inside a session:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Session
{
  <span class="dt">string</span> <span class="fu">GetOwner</span>();
  <span class="dt">string</span> <span class="fu">GetTarget</span>();
  DateTime <span class="fu">GetExpiryTime</span>();
}</code></pre>
<p>So yeah, in a way, we have achieved context independence, because we can now pull all the data e.g. in a GUI code and display the data and the <code>Session</code> does not know anything about it:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">// inside GUI code</span>
<span class="kw">foreach</span>(var session <span class="kw">in</span> sessions)
{
  <span class="dt">var</span> tableRow = TableRow.<span class="fu">Create</span>();
  tableRow[<span class="st">&quot;owner&quot;</span>] = session.<span class="fu">GetOwner</span>();
  tableRow[<span class="st">&quot;target&quot;</span>] = session.<span class="fu">GetTarget</span>();
  tableRow[<span class="st">&quot;expiryTime&quot;</span>] = session.<span class="fu">GetExpiryTime</span>();
  table.<span class="fu">Add</span>(tableRow);
}</code></pre>
<p>It seems we solved the problem, by pulling data to a place that has the context, i.e. knows what to do with this data. Are we happy? We may be unless we look at how the other parts look like - the sending one:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//part of sending logic</span>
<span class="kw">foreach</span>(var session <span class="kw">in</span> sessions)
{
  <span class="dt">var</span> message = Message.<span class="fu">Blank</span>();
  message.<span class="fu">Owner</span> = session.<span class="fu">GetOwner</span>();
  message.<span class="fu">Target</span> = session.<span class="fu">GetTarget</span>();
  message.<span class="fu">ExpiryTime</span> = session.<span class="fu">GetExpiryTime</span>();
  connection.<span class="fu">Send</span>(message);
}</code></pre>
<p>and the storing one:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="co">//part of storing logic</span>
<span class="kw">foreach</span>(var session <span class="kw">in</span> sessions)
{
  <span class="dt">var</span> record = Record.<span class="fu">Blank</span>();
  dataRecord.<span class="fu">Owner</span> = session.<span class="fu">GetOwner</span>();
  dataRecord.<span class="fu">Target</span> = session.<span class="fu">GetTarget</span>();
  dataRecord.<span class="fu">ExpiryTime</span> = session.<span class="fu">GetExpiryTime</span>();
  database.<span class="fu">Save</span>(record);
}</code></pre>
<p>See anything disturbing here? If no, then imagine what happens when we add another piece of information to the <code>Session</code>, say, priority. We now have three places to update and we have to remember to update all of them every time. This is called “redundancy” or “asking for trouble”. Also, composability of this class is pretty bad, because it will change a lot just because data in a session changes.</p>
<p>The reason for this is that we made the <code>Session</code> class effectively as a data structure. It does not implement any domain-related behaviors, just exposes data. There are two implications of this:</p>
<p>this forces all users of this class to define session-related behaviors on behalf of the <code>Session</code>, meaning these behaviors are scattered all over the place. If one is to make change to the session, they must find all related behaviors and correct them.</p>
<p>as a set of object behaviors is generally more stable than its internal data (e.g. a session might have more than one target one day, but we will always be starting and stopping sessions), this leads to brittle interfaces and protocols - certainly the opposite of what we are striving for.</p>
<p>As we see, the solution is pretty bad. But we seem to be out of solutions. Shouldn’t we just accept that there will be problems with this implementation and move on? Thankfully, no. So far, we have found the following options to be troublesome:</p>
<ol style="list-style-type: decimal">
<li>The <code>Session</code> class containing the display, store and send logic, i.e. all the context needed - too much coupling to heavy dependencies</li>
<li>The <code>Session</code> class to expose its data so that we may pull it where we have enough context to know how to use it - communication is too brittle and redundancy creeps in (by the way, this design will also be bad for multithreading, but that’s something for another time)</li>
</ol>
<p>Thankfully, we have a third alternative, which is better than the two we already mentioned. We can just <strong>pass</strong> the context <strong>into</strong> the <code>Session</code> class. “Isn’t this just another way to do what we outlined in point 1? If we pass the context in, isn’t <code>Session</code> still coupled to this context?”, you may ask. The answer is: no, because we can make <code>Session</code> class depend on interfaces only to make it context-independent.</p>
<p>Let’s see how this plays out in practice. First let’s remove those ugly getters from the <code>Session</code> and introduce new method called <code>Dump()</code> that will take the <code>Destination</code> interface as parameter:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">interface</span> Session
{
  <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination);
}</code></pre>
<p>Its implementation can pass all fields into this destination like so:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> TimedSession : Session
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    destination.<span class="fu">AcceptOwner</span>(<span class="kw">this</span>.<span class="fu">owner</span>);
    destination.<span class="fu">AcceptTarget</span>(<span class="kw">this</span>.<span class="fu">target</span>);
    destination.<span class="fu">AcceptExpiryTime</span>(<span class="kw">this</span>.<span class="fu">expiryTime</span>);
    destination.<span class="fu">Done</span>();
  }

  <span class="co">//...</span>
}</code></pre>
<p>And the looping through sessions now looks like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">foreach</span>(var session : sessions)
{
  <span class="dt">var</span> newDestination = destinationFactory.<span class="fu">Create</span>();
  session.<span class="fu">DumpInto</span>(newDestination);
}</code></pre>
<p>In this design, <code>Session</code> itself decides which parameters to pass - no one is asking for its data. This <code>Dump()</code> method is fairly general, so we can use it to implement all three mentioned behaviors (displaying, storing, sending), by creating adapters for each type of destination, e.g. for GUI, it might look like this:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> GuiDestination : Destination
{
  <span class="kw">private</span> TableRow _row;
  <span class="kw">private</span> Table _table;
  
  <span class="kw">public</span> <span class="fu">GuiDestination</span>(Table table, TableRow row)
  {
    _table = table;
    _row = row;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptOwner</span>(<span class="dt">string</span> owner)
  {
    _row[<span class="st">&quot;owner&quot;</span>] = owner;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptTarget</span>(<span class="dt">string</span> target)
  {
    _row[<span class="st">&quot;target&quot;</span>] = target;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptExpiryTime</span>(DateTime expiryTime)
  {
    _row[<span class="st">&quot;expiryTime&quot;</span>] = expiryTime;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Done</span>()
  {
    _table.<span class="fu">Add</span>(_row);
  }

}</code></pre>
<p>Note that with the current design, adding new property to the <code>Session</code> that would need to be displayed, stored or sent, means adding new method to the <code>Destination</code> interface. All implementing classes must implement this new method, or they stop compiling, so there is no way to mistakenly forget about one of them.</p>
<p>Also, unnoticeably, the protocol got more stable. Previously, when we had the getters in the <code>Session</code> class:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> Session
{
  <span class="dt">string</span> <span class="fu">GetOwner</span>();
  <span class="dt">string</span> <span class="fu">GetTarget</span>();
  DateTime <span class="fu">GetExpiryTime</span>();
}</code></pre>
<p>the getters <strong>had to</strong> return <strong>something</strong>. So what if we didn’t want to display, send and store expired timed sessions anymore? we would have to add another getter, called <code>IsExpired()</code> and checking it everywhere… you see where this is going. On the other hand, with the current design of the <code>Session</code> interface, we can e.g. introduce a feature where the expired sessions are not processed at all:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> TimedSession : Session
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    <span class="kw">if</span>(!<span class="fu">IsExpired</span>())
    {
      destination.<span class="fu">AcceptOwner</span>(<span class="kw">this</span>.<span class="fu">owner</span>);
      destination.<span class="fu">AcceptTarget</span>(<span class="kw">this</span>.<span class="fu">target</span>);
      destination.<span class="fu">AcceptExpiryTime</span>(<span class="kw">this</span>.<span class="fu">expiryTime</span>);
      destination.<span class="fu">Done</span>();
    }
  }

  <span class="co">//...</span>
}</code></pre>
<p>and there is no need to change any other code to get this working.</p>
<p>Another added bonus of this situation that we do not have to return anything from methods is that we are free to apply proxy and decorator patterns more freely. For example, we may have hidden sessions, that are not displayed at all, but retain the rest of the session functionality. We may implement it as a proxy, that forwards all messages received to the original, wrapped <code>Session</code> object, while discarding the Dump calls:</p>
<pre class="sourceCode cs"><code class="sourceCode cs"><span class="kw">public</span> <span class="kw">class</span> HiddenSession : Session
{
  <span class="kw">private</span> Session _innerSession;

  <span class="kw">public</span> <span class="fu">HiddenSession</span>(Session innerSession)
  {
    _innerSession = innerSession;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DoSomethig</span>()
  {
    <span class="co">// forward the message:</span>
    _innerSession.<span class="fu">DoSomething</span>();
  }

  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    <span class="co">// discard the message - do nothing</span>
  }

  <span class="co">//...</span>
}</code></pre>
<p>The most important thing is that when we are not forced to return anything, we are more free to do as we like. Again, “Tell, don’t ask”.</p>
<p>The notion of passing context where the data is instead of pulling the data right into the context is often referred to as “context independence”. Context independence is not only about passing context in methods - it applies to constructors the same way. Being context independent is one of the most important requirements for a class to be composable with other classes.</p>
<h3 id="single-responsibility"><a href="#single-responsibility">Single Responsibility</a></h3>
<p>I already said that we want our system to be a web of composable objects. Also, I said that we want to be able to unplug a cluster of objects at any place and plug in something different. TODO</p>
<p>TODO</p>
<h4 id="law-of-demeter"><a href="#law-of-demeter">Law of Demeter</a></h4>
<p>As we discovered, exposing return values makes the protocols more complex and should be avoided if possible. TODO do we need this at all?</p>
<p>Law of Demeter. Coupling to details of return values.</p>
<p>Size of protocols. Even interface with a single method can return a lot of values. Example: different reports produced.</p>
<h4 id="context-independence"><a href="#context-independence">Context independence</a></h4>
<p>TODO</p>
<h4 id="instead-of-pulling-the-data-where-context-is-pass-the-context-where-the-data-is"><a href="#instead-of-pulling-the-data-where-context-is-pass-the-context-where-the-data-is">Instead of pulling the data where context is, pass the context where the data is</a></h4>
<p>If you are like me, you probably learned programming starting from procedural languages.</p>
<p>this may sound like something non obvious</p>
<ol style="list-style-type: decimal">
<li>data - the information</li>
<li>context - what we want to do with information</li>
</ol>
<p>e.g. for employees:</p>
<ol style="list-style-type: decimal">
<li>data - employee name surname etc.</li>
<li>context - we want to print it on the screen</li>
</ol>
<p>TODO example: with employees loop getters refactoring</p>
<p>May be more coupling, but the coupling is very light - just an abstract interface, especially if we were following the rest guidelines. On the other hand, better information hiding and decoupling users from details.</p>
<h4 id="protocols-should-rely-on-abstractions"><a href="#protocols-should-rely-on-abstractions">Protocols should rely on abstractions</a></h4>
<p>e.g. Id abstraction can be either in or string or a combination of those. The protocol stays stable regardless of these changes</p>
<p>Plural is also an abstraction</p>
<hr />
<h4 id="interactions-are-not-an-implementation-detail"><a href="#interactions-are-not-an-implementation-detail">Interactions are not an implementation detail</a></h4>
<p>Todo interfaces checked by compiler, protocols not</p>
<h3 id="multiple-interfaces-multiple-roles"><a href="#multiple-interfaces-multiple-roles">multiple interfaces multiple roles</a></h3>
<p>Protocols must be published! They are not private internal details</p>
<h3 id="tell-dont-ask"><a href="#tell-dont-ask">Tell Don’t Ask</a></h3>
<h3 id="level-of-abstraction-of-protocols"><a href="#level-of-abstraction-of-protocols">Level of abstraction of protocols</a></h3>
<p>weaker = harder to implement another implementation</p>
<p>stad wynika ze lepiej uzywac interfejsow niz klas</p>
<p>TOOODOOO</p>
<ol style="list-style-type: decimal">
<li>Composition through constructor - a reference is passed by constructor</li>
<li>Composition through factory</li>
<li>Composition through setter</li>
<li>Composition through passed in a method parameter</li>
</ol>
<h2 id="why-did-i-leave-out-inline-creation-and-singletons-context-independence"><a href="#why-did-i-leave-out-inline-creation-and-singletons-context-independence">Why did I leave out inline creation and singletons? context independence!</a></h2>
<ol style="list-style-type: decimal">
<li>composability - learned from previous chapters</li>
<li>what does it mean to compose - obtain reference. Plug objects together - show UML version of composition first, then the version with “plugs”.</li>
<li>composability long term (through constructor or setter) or short term (through parameter)?</li>
<li>composability - strong or weak a) class vs interface, b)(continuum -public field, getter, method that does something)</li>
<li>In order to compose - Protocols vs interfaces</li>
<li>Abstract protocols are better</li>
<li>web of composable objects - like a real web - metaphor (when?)</li>
<li>Tell Don’t Ask (when?)</li>
<li>Why not events? Roles!!!</li>
<li>discover interfaces - from inside or outside?</li>
<li>need driven development</li>
</ol>
<p>TODO Copyright Notice ================</p>
<p>Although none of the things I wrote about in this book are my idea, I tried very hard not to infringe anyone’s copyright. That said, I am not a lawyer so there is a slight possibility that this happened.</p>
<p>If you feel your copyright were infringed by any part of this book, please let me know and we’ll work it out somehow.</p>
<h1 id="license"><a href="#license">License</a></h1>
<p>THE WORK (AS DEFINED BELOW) IS PROVIDED UNDER THE TERMS OF THIS CREATIVE COMMONS PUBLIC LICENSE (“CCPL” OR “LICENSE”). THE WORK IS PROTECTED BY COPYRIGHT AND/OR OTHER APPLICABLE LAW. ANY USE OF THE WORK OTHER THAN AS AUTHORIZED UNDER THIS LICENSE OR COPYRIGHT LAW IS PROHIBITED.</p>
<p>BY EXERCISING ANY RIGHTS TO THE WORK PROVIDED HERE, YOU ACCEPT AND AGREE TO BE BOUND BY THE TERMS OF THIS LICENSE. TO THE EXTENT THIS LICENSE MAY BE CONSIDERED TO BE A CONTRACT, THE LICENSOR GRANTS YOU THE RIGHTS CONTAINED HERE IN CONSIDERATION OF YOUR ACCEPTANCE OF SUCH TERMS AND CONDITIONS.</p>
<ol style="list-style-type: decimal">
<li><p>Definitions</p>
<p>“Adaptation” means a work based upon the Work, or upon the Work and other pre-existing works, such as a translation, adaptation, derivative work, arrangement of music or other alterations of a literary or artistic work, or phonogram or performance and includes cinematographic adaptations or any other form in which the Work may be recast, transformed, or adapted including in any form recognizably derived from the original, except that a work that constitutes a Collection will not be considered an Adaptation for the purpose of this License. For the avoidance of doubt, where the Work is a musical work, performance or phonogram, the synchronization of the Work in timed-relation with a moving image (“synching”) will be considered an Adaptation for the purpose of this License. “Collection” means a collection of literary or artistic works, such as encyclopedias and anthologies, or performances, phonograms or broadcasts, or other works or subject matter other than works listed in Section 1(f) below, which, by reason of the selection and arrangement of their contents, constitute intellectual creations, in which the Work is included in its entirety in unmodified form along with one or more other contributions, each constituting separate and independent works in themselves, which together are assembled into a collective whole. A work that constitutes a Collection will not be considered an Adaptation (as defined above) for the purposes of this License. “Distribute” means to make available to the public the original and copies of the Work or Adaptation, as appropriate, through sale or other transfer of ownership. “Licensor” means the individual, individuals, entity or entities that offer(s) the Work under the terms of this License. “Original Author” means, in the case of a literary or artistic work, the individual, individuals, entity or entities who created the Work or if no individual or entity can be identified, the publisher; and in addition (i) in the case of a performance the actors, singers, musicians, dancers, and other persons who act, sing, deliver, declaim, play in, interpret or otherwise perform literary or artistic works or expressions of folklore; (ii) in the case of a phonogram the producer being the person or legal entity who first fixes the sounds of a performance or other sounds; and, (iii) in the case of broadcasts, the organization that transmits the broadcast. “Work” means the literary and/or artistic work offered under the terms of this License including without limitation any production in the literary, scientific and artistic domain, whatever may be the mode or form of its expression including digital form, such as a book, pamphlet and other writing; a lecture, address, sermon or other work of the same nature; a dramatic or dramatico-musical work; a choreographic work or entertainment in dumb show; a musical composition with or without words; a cinematographic work to which are assimilated works expressed by a process analogous to cinematography; a work of drawing, painting, architecture, sculpture, engraving or lithography; a photographic work to which are assimilated works expressed by a process analogous to photography; a work of applied art; an illustration, map, plan, sketch or three-dimensional work relative to geography, topography, architecture or science; a performance; a broadcast; a phonogram; a compilation of data to the extent it is protected as a copyrightable work; or a work performed by a variety or circus performer to the extent it is not otherwise considered a literary or artistic work. “You” means an individual or entity exercising rights under this License who has not previously violated the terms of this License with respect to the Work, or who has received express permission from the Licensor to exercise rights under this License despite a previous violation. “Publicly Perform” means to perform public recitations of the Work and to communicate to the public those public recitations, by any means or process, including by wire or wireless means or public digital performances; to make available to the public Works in such a way that members of the public may access these Works from a place and at a place individually chosen by them; to perform the Work to the public by any means or process and the communication to the public of the performances of the Work, including by public digital performance; to broadcast and rebroadcast the Work by any means including signs, sounds or images. “Reproduce” means to make copies of the Work by any means including without limitation by sound or visual recordings and the right of fixation and reproducing fixations of the Work, including storage of a protected performance or phonogram in digital form or other electronic medium.</p></li>
<li><p>Fair Dealing Rights. Nothing in this License is intended to reduce, limit, or restrict any uses free from copyright or rights arising from limitations or exceptions that are provided for in connection with the copyright protection under copyright law or other applicable laws.</p></li>
<li><p>License Grant. Subject to the terms and conditions of this License, Licensor hereby grants You a worldwide, royalty-free, non-exclusive, perpetual (for the duration of the applicable copyright) license to exercise the rights in the Work as stated below:</p>
<p>to Reproduce the Work, to incorporate the Work into one or more Collections, and to Reproduce the Work as incorporated in the Collections; to create and Reproduce Adaptations provided that any such Adaptation, including any translation in any medium, takes reasonable steps to clearly label, demarcate or otherwise identify that changes were made to the original Work. For example, a translation could be marked “The original work was translated from English to Spanish,” or a modification could indicate “The original work has been modified.”; to Distribute and Publicly Perform the Work including as incorporated in Collections; and, to Distribute and Publicly Perform Adaptations.</p>
<p>For the avoidance of doubt: Non-waivable Compulsory License Schemes. In those jurisdictions in which the right to collect royalties through any statutory or compulsory licensing scheme cannot be waived, the Licensor reserves the exclusive right to collect such royalties for any exercise by You of the rights granted under this License; Waivable Compulsory License Schemes. In those jurisdictions in which the right to collect royalties through any statutory or compulsory licensing scheme can be waived, the Licensor waives the exclusive right to collect such royalties for any exercise by You of the rights granted under this License; and, Voluntary License Schemes. The Licensor waives the right to collect royalties, whether individually or, in the event that the Licensor is a member of a collecting society that administers voluntary licensing schemes, via that society, from any exercise by You of the rights granted under this License.</p></li>
</ol>
<p>The above rights may be exercised in all media and formats whether now known or hereafter devised. The above rights include the right to make such modifications as are technically necessary to exercise the rights in other media and formats. Subject to Section 8(f), all rights not expressly granted by Licensor are hereby reserved.</p>
<ol start="4" style="list-style-type: decimal">
<li><p>Restrictions. The license granted in Section 3 above is expressly made subject to and limited by the following restrictions:</p>
<p>You may Distribute or Publicly Perform the Work only under the terms of this License. You must include a copy of, or the Uniform Resource Identifier (URI) for, this License with every copy of the Work You Distribute or Publicly Perform. You may not offer or impose any terms on the Work that restrict the terms of this License or the ability of the recipient of the Work to exercise the rights granted to that recipient under the terms of the License. You may not sublicense the Work. You must keep intact all notices that refer to this License and to the disclaimer of warranties with every copy of the Work You Distribute or Publicly Perform. When You Distribute or Publicly Perform the Work, You may not impose any effective technological measures on the Work that restrict the ability of a recipient of the Work from You to exercise the rights granted to that recipient under the terms of the License. This Section 4(a) applies to the Work as incorporated in a Collection, but this does not require the Collection apart from the Work itself to be made subject to the terms of this License. If You create a Collection, upon notice from any Licensor You must, to the extent practicable, remove from the Collection any credit as required by Section 4(b), as requested. If You create an Adaptation, upon notice from any Licensor You must, to the extent practicable, remove from the Adaptation any credit as required by Section 4(b), as requested. If You Distribute, or Publicly Perform the Work or any Adaptations or Collections, You must, unless a request has been made pursuant to Section 4(a), keep intact all copyright notices for the Work and provide, reasonable to the medium or means You are utilizing: (i) the name of the Original Author (or pseudonym, if applicable) if supplied, and/or if the Original Author and/or Licensor designate another party or parties (e.g., a sponsor institute, publishing entity, journal) for attribution (“Attribution Parties”) in Licensor’s copyright notice, terms of service or by other reasonable means, the name of such party or parties; (ii) the title of the Work if supplied; (iii) to the extent reasonably practicable, the URI, if any, that Licensor specifies to be associated with the Work, unless such URI does not refer to the copyright notice or licensing information for the Work; and (iv) , consistent with Section 3(b), in the case of an Adaptation, a credit identifying the use of the Work in the Adaptation (e.g., “French translation of the Work by Original Author,” or “Screenplay based on original Work by Original Author”). The credit required by this Section 4 (b) may be implemented in any reasonable manner; provided, however, that in the case of a Adaptation or Collection, at a minimum such credit will appear, if a credit for all contributing authors of the Adaptation or Collection appears, then as part of these credits and in a manner at least as prominent as the credits for the other contributing authors. For the avoidance of doubt, You may only use the credit required by this Section for the purpose of attribution in the manner set out above and, by exercising Your rights under this License, You may not implicitly or explicitly assert or imply any connection with, sponsorship or endorsement by the Original Author, Licensor and/or Attribution Parties, as appropriate, of You or Your use of the Work, without the separate, express prior written permission of the Original Author, Licensor and/or Attribution Parties. Except as otherwise agreed in writing by the Licensor or as may be otherwise permitted by applicable law, if You Reproduce, Distribute or Publicly Perform the Work either by itself or as part of any Adaptations or Collections, You must not distort, mutilate, modify or take other derogatory action in relation to the Work which would be prejudicial to the Original Author’s honor or reputation. Licensor agrees that in those jurisdictions (e.g. Japan), in which any exercise of the right granted in Section 3(b) of this License (the right to make Adaptations) would be deemed to be a distortion, mutilation, modification or other derogatory action prejudicial to the Original Author’s honor and reputation, the Licensor will waive or not assert, as appropriate, this Section, to the fullest extent permitted by the applicable national law, to enable You to reasonably exercise Your right under Section 3(b) of this License (right to make Adaptations) but not otherwise.</p></li>
<li><p>Representations, Warranties and Disclaimer</p></li>
</ol>
<p>UNLESS OTHERWISE MUTUALLY AGREED TO BY THE PARTIES IN WRITING, LICENSOR OFFERS THE WORK AS-IS AND MAKES NO REPRESENTATIONS OR WARRANTIES OF ANY KIND CONCERNING THE WORK, EXPRESS, IMPLIED, STATUTORY OR OTHERWISE, INCLUDING, WITHOUT LIMITATION, WARRANTIES OF TITLE, MERCHANTIBILITY, FITNESS FOR A PARTICULAR PURPOSE, NONINFRINGEMENT, OR THE ABSENCE OF LATENT OR OTHER DEFECTS, ACCURACY, OR THE PRESENCE OF ABSENCE OF ERRORS, WHETHER OR NOT DISCOVERABLE. SOME JURISDICTIONS DO NOT ALLOW THE EXCLUSION OF IMPLIED WARRANTIES, SO SUCH EXCLUSION MAY NOT APPLY TO YOU.</p>
<ol start="6" style="list-style-type: decimal">
<li><p>Limitation on Liability. EXCEPT TO THE EXTENT REQUIRED BY APPLICABLE LAW, IN NO EVENT WILL LICENSOR BE LIABLE TO YOU ON ANY LEGAL THEORY FOR ANY SPECIAL, INCIDENTAL, CONSEQUENTIAL, PUNITIVE OR EXEMPLARY DAMAGES ARISING OUT OF THIS LICENSE OR THE USE OF THE WORK, EVEN IF LICENSOR HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.</p></li>
<li><p>Termination</p>
<p>This License and the rights granted hereunder will terminate automatically upon any breach by You of the terms of this License. Individuals or entities who have received Adaptations or Collections from You under this License, however, will not have their licenses terminated provided such individuals or entities remain in full compliance with those licenses. Sections 1, 2, 5, 6, 7, and 8 will survive any termination of this License. Subject to the above terms and conditions, the license granted here is perpetual (for the duration of the applicable copyright in the Work). Notwithstanding the above, Licensor reserves the right to release the Work under different license terms or to stop distributing the Work at any time; provided, however that any such election will not serve to withdraw this License (or any other license that has been, or is required to be, granted under the terms of this License), and this License will continue in full force and effect unless terminated as stated above.</p></li>
<li><p>Miscellaneous</p>
<p>Each time You Distribute or Publicly Perform the Work or a Collection, the Licensor offers to the recipient a license to the Work on the same terms and conditions as the license granted to You under this License. Each time You Distribute or Publicly Perform an Adaptation, Licensor offers to the recipient a license to the original Work on the same terms and conditions as the license granted to You under this License. If any provision of this License is invalid or unenforceable under applicable law, it shall not affect the validity or enforceability of the remainder of the terms of this License, and without further action by the parties to this agreement, such provision shall be reformed to the minimum extent necessary to make such provision valid and enforceable. No term or provision of this License shall be deemed waived and no breach consented to unless such waiver or consent shall be in writing and signed by the party to be charged with such waiver or consent. This License constitutes the entire agreement between the parties with respect to the Work licensed here. There are no understandings, agreements or representations with respect to the Work not specified here. Licensor shall not be bound by any additional provisions that may appear in any communication from You. This License may not be modified without the mutual written agreement of the Licensor and You. The rights granted under, and the subject matter referenced, in this License were drafted utilizing the terminology of the Berne Convention for the Protection of Literary and Artistic Works (as amended on September 28, 1979), the Rome Convention of 1961, the WIPO Copyright Treaty of 1996, the WIPO Performances and Phonograms Treaty of 1996 and the Universal Copyright Convention (as revised on July 24, 1971). These rights and subject matter take effect in the relevant jurisdiction in which the License terms are sought to be enforced according to the corresponding provisions of the implementation of those treaty provisions in the applicable national law. If the standard suite of rights granted under applicable copyright law includes additional rights not granted under this License, such additional rights are deemed to be included in the License; this License is not intended to restrict the license of any rights under applicable law.</p></li>
</ol>
</body>
</html>
