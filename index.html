<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /></head><body><div class="calibre" id="calibre_link-11">
  <h1 class="calibre1">Dedications</h1>

  <p class="calibre2"><i class="calibre3">Ad Deum qui laetificat iuventutem meam.</i></p>

  <p class="calibre2"><i class="calibre3">To my beloved wife Monika.</i></p>
</div>


<div class="calibre" id="calibre_link-28">
  <h1 class="calibre1">Part 1: Just&nbsp;the basics</h1>

  <p class="calibre2">This is a part where I introduce the basic TDD philosophy and practices (as well as some advanced ones) without going much into object orientation and how to do TDD for systems where multiple objects collaborate together (which is a topic of Part 2).</p>

  <p class="calibre2">So, for the most chapters of this part, I will be giving you examples where single object (plus some small ones like strings etc.) is exercised to slowly introduce some concepts in an easy to grasp manner.</p>

  <p class="calibre2">After reading part 1, you will be able to quite effectively develop classes that have no dependencies on other classes (and on operating system resources).</p>
</div>


<div class="calibre4" id="calibre_link-36">
  <h1 class="calibre1">Motivation - the first step to learning TDD</h1>

  <p class="calibre2">So, you want to learn TDD, huh? First off, let me ask a question ‘why?’.</p>

  <p class="calibre2">I want to tell you a story - few years ago, I had an apprentice, who wanted to learn TDD as well. We started working on a small project together for him to grasp the necessary skills through practice, with me sitting next to him, providing guidance. He showed up three, four times, then he resigned, having ‘more urgent things’ and ‘no time’. Since then, he did not progress in TDD at all. Did he really want to learn?</p>

  <p class="calibre2">See, sometimes people don’t really want to learn something or don’t want so much as to dedicate the necessary time and resources to this. Sometimes they just think they need to do it for whatever reasons - getting promotion at work, gaining a certificate, add something to CV or just ‘stay up to date’ with recent hypes, one of them being Test-Driven Development.</p>

  <p class="calibre2">Others want to learn TDD for reasons they themselves made up. Knowing that TDD is valued and praised by others, they draw conclusions that it has to be good. Why is that so? Err… maybe… “the code will be more tested”? Or… ekhem… “the network of tests will be tighter”? And why do Test-First? Well… hmm… “to ensure tests are written for everything”? While these statements might be partially true, they don’t even touch the essence of the “why” of TDD, and quickly turn into something like: “I don’t really need TDD, because I&nbsp;need tests that give me confidence on broader scope” or: “Why do I need unit tests when I already have integration tests, smoke tests, sanity tests, exploration tests…?”. Then TDD gets abandoned, before actually ever being achieved in the first place.</p>

  <p class="calibre2">You need to be highly motivated on this one. If you are not, hey, I heard the new series of Game Of Thrones is on TV, why don’t you check it out instead? Ok, I’m just teasing, however, as some say, TDD is “easy to learn, hard to master” (don’t actually know who said it first, I searched the web and found it in few places where none of the writers gave credit to anyone else for it, so I decided just to mention that I’m not the one that coined this description)&nbsp;, so without some guts to move on, it will be hard.</p>

  <h2 id="calibre_link-45" class="calibre5">How TDD feels like</h2>

  <p class="calibre2">Me and my brother liked to play video games in our childhood - one of the most memorable being Tekken 3 - a japanese tournament beat’em up for Sony Playstation. To finish the game with all warriors, unlock all hidden characters, mini-games etc. took about a day. Some could say the game had nothing to offer since then. Why then did we spend over a year on it?<br class="calibre6" /></p>

  <p class="calibre2"><img alt="Tekken3" src="images/000004.png" class="calibre7" /><br class="calibre6" /></p>

  <p class="calibre2">It is because each fighter in the game had a lot of combos, kicks and punches that could be mixed in a variety of ways. Some were only usable in some situations, others were something you could throw at your opponent almost anytime without a big risk of being exposed to counterattacks. You could side-step to evade enemy’s attacks and, most of all, you could kick another fighter up in the air where they could not block your attacks and you were able to land some nice attacks on them before they fell down. These in-the-air techniques were called “juggles”. There were magazines that published a list of new possible juggles each month and the hype stayed in the gaming community for well over a year.</p>

  <p class="calibre2">Yes, Tekken was easy to learn - you could put one hour into training the core moves of a character and then be able to “use them”, but what made you a great fighter was the experience and knowledge on which techniques were risky or not, which ones could be used in which situations, which ones, if used one after another, gave the opponent little chance to counterattack etc. No wonder that soon, many tournaments sprang, where players could clash for glory, fame and rewards. Even today, you can watch some of the matches on youtube.</p>

  <p class="calibre2">TDD is like Tekken. You have probably heard the mantra “red-green-refactor” or the general advice “write your test first, then the code”, maybe you even did some experiments on your own where you were trying to implement a bubble-sort algorithm or other simple stuff by starting with a test. But that is all like practicing Tekken by trying out each move on its own on dummy opponent, without the context of real-world issues that make the fight really challenging. And while I think such exercises are (somewhat) useful, you need to understand the bigger picture.</p>

  <p class="calibre2">Some people I talk with about TDD sum up what I say to them as: “That is really demotivating - there are so many things I have to watch out for that it makes me never want to start!”. Easy, don’t panic - remember the first time you tried to ride a bike - you must have been really far back then from knowing traffic regulations and following road signs, but that did not really keep you away, did it? I myself found TDD very exciting. Some guys my age already think they know all about coding, are bored with it and cannot wait until they move to management or requirements or business analysis, but hey! I have a new technique that makes my coding career challenging again! And it’s not something I can use only when I pay to Microsoft or Oracle or anybody else - it’s quite portable, making me a better developer overall!</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Student</h3>

    <p class="calibre8">You have started travelling the way of masters with conviction, determination and pride.</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-39">
  <h1 class="calibre1">The three most essential tools</h1>

  <p class="calibre2">Ever watched Karate Kid, either the old version or the new one? The thing they have in common is that when the kid starts learning Karate (or Kung-Fu) from his master, he is given a basic, repetitive task (like taking off a jacket, and putting it on again), not knowing yet where it would lead him. Or look at the first Rocky film (yeah, the one starring Sylvester Stallone), where Rocky was chasing a chicken in order to train agility.</p>

  <p class="calibre2">When I first tried to learn how to play guitar, I found two advices on the web: the first was to start by mastering a single, difficult song. The second was to play with a single string, learn how to make it sound in different ways and try to play some melodies by ear just with this one string. Do I have to tell you that the second advice worked better?</p>

  <p class="calibre2">Honestly, I could dive right into the core techniques of TDD, but this would be like putting you on a ring with a demanding opponent - you would most probably be discouraged before gaining the necessary skills. So, instead of explaining how to win a race, in this chapter we will take a look at what shiny cars we will be driving.</p>

  <p class="calibre2">In other words, I will give you a brief tour of the three most essential tools we will be using throughout this book.</p>

  <h2 id="calibre_link-46" class="calibre5">Our shiny tools</h2>

  <p class="calibre2">A disclaimer - in this chapter, I will oversimplify some things just to get you up and running without getting into the philosophy of TDD yet (think: physics lessons in primary school). Do not worry about it :-), we will fix that in the coming chapters!</p>

  <h3 class="sigilnotintoc">xUnit framework</h3>

  <p class="calibre2">The first and most essential tool we are going to use is an xUnit framework.</p>

  <p class="calibre2">Let us assume that our application looks like this:<br class="calibre6" /></p>

  <div class="calibre9"></div>
  <pre class="calibre10">public static void Main(string[] args) 
{
  try
  {
    int firstNumber = Int32.Parse(args[0]);
    int secondNumber = Int32.Parse(args[1]);

    var result = 
      new Multiplication(firstNumber, secondNumber).Perform();

    Console.WriteLine("Result is: " + result);
  }
  catch(Exception e)
  {
    Console.WriteLine("Addition failed because of: " + e);
  } 
}
</pre>

  <p class="calibre2">Now, let us assume we want to check whether is produces correct results. The most obvious way would be to invoke the application from command line with some exemplary arguments, check the output to the console and compare it with what we expect to see. Such session could look like this:</p>
  <pre class="calibre10">C:\MultiplicationApp\MultiplicationApp.exe 3 7
21
C:\MultiplicationApp\
</pre>

  <p class="calibre2">As you can see, the application produced a result of 21 for multiplication of 7 by 3. This is correct, so we assume the test is passed. But what if we produced an application that additionally does addition, subtraction, division, calculus etc.? How many times would we have to invoke the application to make sure every operation works correct?</p>

  <p class="calibre2">But wait, we are programmers, right? So we can write programs that can do this for us! In order to do this, we will create a second application that will also use the Multiplication class, but in a little different way:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  var multiplication = new Multiplication(3,7);
  
  var result = multiplication.Perform();
  
  if(result != 21)
  {
    throw new Exception("Failed! Expected: 21 but was: " + result);
  }
}
</pre>

  <p class="calibre2">Sounds easy, right? Let us take another step and extract the result check into something more reusable - after all, we will be adding division in a second, remember? So here goes:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  var multiplication = new Multiplication(3,7);
  
  var result = multiplication.Perform();
  
  AssertTwoIntegersAreEqual(expected: 21, actual: result);
}

public static void AssertTwoIntegersAreEqual(
  int expected, int actual)
{
  if(actual != expected)
  {
    throw new Exception(
      "Failed! Expected: " + expected + " but was: " + actual);
  }
}
</pre>

  <p class="calibre2">Note that I started the name of the method with “Assert” - we will get back to the naming soon, for now just assume that this is just a good name for the method. Let us take one last round and put the test into its own method:</p>
  <pre class="calibre10">public static void Main(string[] args) 
{
  Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers();
}

public void 
Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()
{
  //Assuming…
  var multiplication = new Multiplication(3,7);
  
  //when this happens:
  var result = multiplication.Perform();
  
  //then the result should be…
  AssertTwoIntegersAreEqual(expected: 21, actual: result);
}

public static void AssertTwoIntegersAreEqual(
  int expected, int actual)
{
  if(actual != expected)
  {
    throw new Exception(
      "Failed! Expected: " + expected + " but was: " + actual);
  }
}
</pre>

  <p class="calibre2">And we are finished. Now if we need another test, e.g. for division, we can just add a new method call to the <code class="calibre11">Main()</code> method and implement it. When implementing it, we can reuse the <code class="calibre11">AssertTwoIntegersAreEqual()</code> method, since the check for division would be analogous.</p>

  <p class="calibre2">As you can see, we can easily write automated checks like this, but this way has some disadvantages:</p>

  <ol class="calibre12">
    <li class="calibre13">Every time we add new test, we have to maintain the <code class="calibre11">Main()</code> method, adding a call to the new test. If you forget to add such a call, the test will never be run. At first it isn’t a big deal, but as soon as we have dozens of tests, it will get really hard to notice.</li>

    <li class="calibre13">Imagine your system consists of more than one application - you would have some problems trying to gather summary results for all of the applications that your system consists of.</li>

    <li class="calibre13">A need will very quickly arise to write a lot of other checks like the existing <code class="calibre11">AssertTwoIntegersAreEqual()</code> - this one compares two integers for equality, but what if you wanted to checka different condition, e.g. that one integer is greater than another? What if you wanted to check equality not for integers, but for characters, strings, floats etc.? What if you wanted to check some conditions on collections, e.g. that a collection is sorted or that all items in the collection are unique?</li>

    <li class="calibre13">Given that a test fails, it would be hard to navigate from the commandline output to the line in your IDE. Would it not be easier if you could click on the call stack to take you immediately to the code where the failure took place?</li>
  </ol>

  <p class="calibre2">For these and other reasons, automated testing tools were born. Those testing tools are generally referenced to as <strong class="calibre14">xUnit family</strong>, because many of them have names that end with the word “Unit”, e.g. CppUnit (for C++), JUnit (for Java), NUnit (for .NET) etc.</p>

  <p class="calibre2">To be honest, I cannot wait to show you how the test we wrote just a minute ago looks like when xUnit framework is used, however, before I do this, I would like to recap quickly what we have in our brute-force naive approach to writing automated tests:</p>

  <ol class="calibre12">
    <li class="calibre13">The <code class="calibre11">Main()</code> method serves as a <strong class="calibre14">Test List</strong></li>

    <li class="calibre13">The <code class="calibre11">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()</code> method is a <strong class="calibre14">Test Method</strong></li>

    <li class="calibre13">The <code class="calibre11">AssertTwoIntegersAreEqual()</code> method is <strong class="calibre14">an Assertion</strong></li>
  </ol>

  <p class="calibre2">Quite to our joy, those three elements are present in xUnit frameworks as well. To illustrate it, here is (finally!) the same test we wrote, but with an xUnit framework (this one is called XUnit.Net):</p>
  <pre class="calibre10">[Fact] public void 
Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()
{
  //Assuming…
  var multiplication = new Multiplication(3,7);
  
  //when this happens:
  var result = multiplication.Perform();
  
  //then the result should be…
  Assert.Equal(21, result);
}
</pre>

  <p class="calibre2">As you can see, it looks like two methods that we previously had are gone now and the test is the only thing that is left. Well, to tell you the truth, they are not gone - it is just that the framework handles these for us. Let us reiterate through the three elements of the previous version of the test that I promised would be there after the transition to xUnit framework:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Test List</strong> is now created automatically by the framework from all methods marked with a [Fact] attribute, so no need to maintain one or more central lists. Thus, the <code class="calibre11">Main()</code> method is gone.</li>

    <li class="calibre13">The <strong class="calibre14">Test Method is here and looks almost the same as the last time.</strong></li>

    <li class="calibre13">The <strong class="calibre14">Assertion</strong> took the form of a call to static <code class="calibre11">Assert.Equal()</code> method - the xUnit.NET framework is bundled with a wide range of pre-made assertions for your convenience. Of course, no one stops you from writing your own custom one if you do not find what you are looking for in a default set.</li>
  </ol>

  <p class="calibre2">Phew, I hope I made the transition quite painless for you. Now the last thing to add - as there is not <code class="calibre11">Main()</code> method anymore in the last example, you surely must wonder how we run those tests, right? Ok, the last big secret unveiled - we use an external application for this (we will refer to it using a term <strong class="calibre14">Test Runner</strong>) - we tell it which assemblies to run and it loads them, runs them, reports results etc. It can take various forms, e.g. it can be a console application, a GUI application or a plugin to our IDEs. Here is an example of a stand-alone runner for xUnit.NET framework:</p>

  <p class="calibre15"><img alt="XUnit.NET.Window" src="images/000005.png" class="calibre7" /></p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Sprinter</h3>

    <p class="calibre8">You sure know how to run your tests. Automatically!</p>
  </div>

  <h3 class="sigilnotintoc">Mocking framework</h3>

  <p class="calibre2">Mocking frameworks are libraries that automate runtime creation of objects (called “mocks”) that adhere to specified interface. Aside from the creation itself, the frameworks provide an API to configure our mocks on how they behave when certain methods are called on them and to let us inspect which calls they received.</p>

  <p class="calibre2">Mocking frameworks are not as old as xUnit frameworks and were not present in TDD since the very beginning. As you might be wondering why on earth do we need something like this, I will let you in on a secret: they were born with a goal of aiding a specific approach to object oriented design in mind. This kind of design is what TDD supports as you will soon experience.</p>

  <p class="calibre2">For now, however, let us try to keep things easy. I will defer explaining the actual rationale for mocking frameworks until later and instead give you a quick example where you can see them in action. Ready? Let us go!</p>

  <p class="calibre2">Let us pretend that we have the following code for adding new set of orders for products to a database and handling exceptions (by writing a message to a log) when it fails:</p>
  <pre class="calibre10">public class OrderProcessing
{
  //other code…

  public void Place(Order order)
  {
    try
    {
      this.orderDatabase.Insert(order);
    }
    catch(Exception e)
    {
      this.log.Write("Could not insert an order. Reason: " + e);
    }
  }

  //other code…
}
</pre>

  <p class="calibre2">Now, imagine we need to test it - how do we do it? I can already see you shaking your head and saying: “Let us just create this database, invoke this method and see if the record is added properly”. In such case, the first test would look like this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new MySqlOrderDatabase();
  orderDatabase.Connect();
  orderDatabase.Clean();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  var allOrders = orderDatabase.SelectAllOrders();
  Assert.Contains(order, allOrders);
}
</pre>

  <p class="calibre2">As you see, at the beginning of the test, we are opening a connection and cleaning all existing orders (more on that shortly!), then creating an order object, inserting it into a database and then querying the database to give us all of the held instances. At the end, we make an assertion that the order we tried to insert must be inside all orders in a database.</p>

  <p class="calibre2">Why do we clean up the database? Remember a database is a persistent storage, so if we did not clean it up and run this test again, the database may have already contained the item (maybe another test already added it?) and would probably not allow us to add the same item again. Thus, the test would fail. Ouch! It hurts so bad, because we wanted our tests to prove something works, but looks like it can fail even when the logic is coded correctly. What use is such a test if it cannot reliably provide the information we demand from it (whether the implemented logic is correct or not)? Thus, we clean up before each run to make sure the state of the persistent storage is the same every time we run this test.</p>

  <p class="calibre2">So, got what you want? Well, I did not. Personally, I would not go this way. There are several reasons:</p>

  <ol class="calibre12">
    <li class="calibre13">The test is going to be slow. It is not uncommon to have more than thousand tests in a suite and I do not want to wait half an hour for results every time I run them. Do you?</li>

    <li class="calibre13">Everyone running this test will have to set up a local database on their machine. What if their setup is slightly different than yours? What if the schema gets outdated - will everyone manage to notice it and update schema of their local databases accordingly? Will you re-run your database creation script only to ensure you have got the latest schema available to run your tests against?</li>

    <li class="calibre13">There may not be an implementation of the database engine for the operating system running on your development machine if your target is an exotic or mobile platform.</li>

    <li class="calibre13">Note that this test you wrote is only one out of two. You will have to write another one for the scenario where inserting an order ends with exception. How do you setup your database in a state where it throws an exception? It is possible, but requires significant effort (e.g. deleting a table and recreating it after the test for other tests that might need the table to run correctly), which may lead you to a conclusion that it is not worth to write such tests at all.</li>
  </ol>

  <p class="calibre2">Now, let us try something else. Let us assume that our database works OK (or will be tested by black-box tests) and the only thing we want to test is our implementation. In this situation, we can create fake object, which is an instance of another custom class that implements the same interface as MySqlOrderDatabase, but does not write to a database at all - it only stores the inserted records in a list:</p>
  <pre class="calibre10">public class FakeOrderDatabase : OrderDatabase
{
  public Order _receivedArgument;

  public void Insert(Order order)
  {
    _receivedArgument = order;
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
    return new List&lt;Order&gt;() { _receivedOrder; };
  }
}
</pre>

  <p class="calibre2">Now, we can substitute the real implementation of order database with the fake instance:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new FakeOrderDatabase();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  var allOrders = orderDatabase.SelectAllOrders();
  Assert.Contains(order, allOrders);
}
</pre>

  <p class="calibre2">Note that we do not clean the fake database object, since we create it as fresh each time the test is run. Also, the test is going to be much quicker now. But, that is not the end! We can easily write a test for an exception situation. How do we do it? Just make another fake object implemented like this:</p>
  <pre class="calibre10">public class ExplodingOrderDatabase : OrderDatabase
{
  public void Insert(Order order)
  {
    throw new Exception();
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
  }
}
</pre>

  <p class="calibre2">Ok, so far so good, but the bad is that now we have got two classes of fake objects to maintain (and chances are we will need even more). Any method or argument added will need to be propagated to all these objects. We can spare some coding by making our mocks a little more generic so their behavior can be configured using lambda expressions:</p>
  <pre class="calibre10">public class ConfigurableOrderDatabase : OrderDatabase
{
  public Action&lt;Order&gt; doWhenInsertCalled;
  public Func&lt;List&lt;Order&gt;&gt; doWhenSelectAllOrdersCalled;

  public void Insert(Order order)
  {
    doWhenInsertCalled(order);
  }

  public List&lt;Order&gt; SelectAllOrders()
  {
    return doWhenSelectAllOrdersCalled();
  }
}
</pre>

  <p class="calibre2">Now, we do not have to create additional classes for new scenarios, but our syntax gets awkward. See for yourself how we configure the fake order database to remember and yield the inserted order:</p>
  <pre class="calibre10">var db = new ConfigurableOrderDatabase();
Order gotOrder = null;
db.doWhenInsertCalled = o =&gt; {gotOrder = o;};
db.doWhenSelectAllOrdersCalled = () =&gt; new List&lt;Order&gt;() { gotOrder };
</pre>

  <p class="calibre2">And if we want it to throw an exception when anything is inserted:</p>
  <pre class="calibre10">var db = new ConfigurableOrderDatabase();
db.doWhenInsertCalled = o =&gt; {throw new Exception();};
  </pre>

  <p class="calibre2">Thankfully, some smart programmers created frameworks that provide further automation in such scenarios. One of them is called <strong class="calibre14">NSubstitute</strong> and provides an API in a form of extension methods (that is why it might seem a bit magical at first. Do not worry, you will get used to it).</p>

  <p class="calibre2">Using NSubstitute, out first test can be rewritten as such:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}
</pre>

  <p class="calibre2">Note that we do not need the <code class="calibre11">SelectAllOrders()</code> method. If no one except this test needs it, we can delete it and spare some more maintainability trouble. The last line of this test is actually a camouflaged assertion that checks whether Insert method was called once with order object as parameter.</p>

  <p class="calibre2">I will get back to mocks, since, as I said, there is a huge philosophy behind them and we have only scratched the surface here.</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Pretender</h3>

    <p class="calibre8">You have managed to use a mock instead of a real object in unit test!</p>
  </div>

  <h3 class="sigilnotintoc">Anonymous values generator</h3>

  <p class="calibre2">Look at the test in the previous section. Does it not trouble you that we fill the order object with so many values that are totally irrelevant to the test logic itself? They actually hinder readability of the test. Also, they make us believe that the tested object really cares what these values are, although it does not (the database does, but we already got rid of it from the test). Let us move it to a method with descriptive name:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = AnonymousOrder();

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}

public Order AnonymousOrder()
{
  return new Order(
    name: "Grzesiek", 
    surname: "Galezowski", 
    product: "Agile Acceptance Testing", 
    date: DateTime.Now,
    quantity: 1);
}
</pre>

  <p class="calibre2">Now that is better. Not only did we make the test shorter, we also provided a hint to the test reader that the actual values used to create an order do not matter from the perspective of tested order processing logic, hence the name <code class="calibre11">AnonymousOrder()</code>.</p>

  <p class="calibre2">By the way, would it not be nice if we did not have to provide the anonymous objects ourselves, but rely on another library to generate them for us? Susprise, surprise, there is one! It is called <strong class="calibre14">Autofixture</strong>. It is an example of an anonymous values generator (although its creator likes to say that it is an implementation of Test Data Builder pattern, but let us skip this discussion here). After refactoring our test to use AutoFixture, we arrive at the following:</p>
  <pre class="calibre10">[Fact] public void 
ShouldInsertNewOrderToDatabase()
{
  //GIVEN
  var orderDatabase = new Substitute.For&lt;OrderDatabase&gt;();
  var orderProcessing = new OrderProcessing(orderDatabase, new FileLog());
  var order = any.Create&lt;Order&gt;();

  //WHEN
  orderProcessing.Place(order);

  //THEN
  orderDatabase.Received(1).Insert(order);
}

private Fixture any = new Fixture();
</pre>

  <p class="calibre2">Nice, huh? AutoFixture has a lot of advanced features, but personally I am conservative and wrap it behind a static class called <code class="calibre11">Any</code>:</p>
  <pre class="calibre10">public static class Any
{
  private static any = new Fixture();
  
  public static T ValueOf&lt;T&gt;()
  {
    return any.Create&lt;T&gt;();
  }
}
</pre>

  <p class="calibre2">In the next chapters, you will see me using a lot of different methods from the <code class="calibre11">Any</code> type. The more you use this class, the more it grows with other methods for creating customized objects. For now, however, let us stop here.</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Anonymous</h3>

    <p class="calibre8">The values you use in your unit tests move like a shadow, unnoticed by anyone and until it is really necessary.</p>
  </div>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">In this chapter, I tried to show you the three essential tools which we will be using in this book and which, when mastered, will make your test-driven development smoother. If this chapter leaves you with insufficient justification for their use, do not worry - we will dive into the philosophy behind them in the coming chapters. For now, I just want you to get familiar with the tools themselves and their syntax. Go on, download these tools, launch them, try to write something simple with them. You do not need to understand their full purpose yet, just go out and play :-).</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Equipped</h3>

    <p class="calibre8">You are now able to understand most of the code examples throughout this book!</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-1">
  <h1 class="calibre1">It is not a test</h1>

  <p class="calibre2">Up to now, I was cheating on you. I told you that the little executable snippets of code are ‘tests’ and that they’re here to ‘check’ or ‘verify’ something. Now it is time to reveal the truth.</p>

  <h2 id="calibre_link-47" class="calibre5">When a test becomes something else</h2>

  <p class="calibre2">I studied in Łódź, a large city in the center of Poland. As probably all other students in all other countries, we have had lectures, exercises and exams. The exams were pretty hard, especially considered that my computer science group was on the faculty of electronic and electric engineering, so we had to grasp a lot of classes that did not have anything to do with programming, for instance electrotechnics, solid-state physics or electronic and electrical metrology.</p>

  <p class="calibre2">Knowing that the exams were difficult and that it was hard to learn everything during preparation, the lecturers would give us exemplary exams from previous years. The questions were different than during actual exams, but the structure and types of questions asked (practice vs. theory etc.) was similar. We would usually get these exemplary questions before we started learning really hard (which was usually at the end of semester). Guess what happened then? As you might suspect, we did not use the tests we received just to ‘verify’ or ‘check’ our knowledge after we finished learning. Those tests were actually the first thing we went to before even starting to learn. Why was that so? What use were the tests when we knew we would not know most of the answers?</p>

  <p class="calibre2">I guess my lecturers would disagree with me, but I find it quite amusing that what we were really doing back then was ‘Lean’. Lean is an approach where, among others, there is a rigorous emphasis on eliminating waste. Every feature or product that is produced while not being needed by anyone is considered waste. That is because if something is not needed, there is no reason to assume it will ever be needed. In such case the entire feature or product is a waste - it has no value. Even if it WILL be ever needed, it will require some rework anyway to fit the real customer needs. In this case, the initial amount of work that went into the parts of solution that had to be replaced by another parts anyway is a waste - it never brought any money (I am not talking about such things as customer demos, but finished, polished features or products).</p>

  <p class="calibre2">So, in order to eliminate waste, there is huge pressure nowadays to “pull features from demand” instead of “pushing them” into the product. In other words, every feature is there to satisfy concrete need. If not, the effort is considered wasted and the money drown.</p>

  <p class="calibre2">Going back to the exams, why the approach of first looking through the exemplary tests can be considered ‘lean’? That is because, when we treat passing an exam as our goal, then everything that does not put us closer to this goal is considered a waste. Let us suppose the exam is theory only - why then practice the exercises? It would probably pay off a lot more to study theoretical side of the topics. Such knowledge could be obtained from those exemplary tests. So, the tests were a kind of specification of what was needed to pass the exam, letting us pull the value (i.e. our knowledge) from demand (information obtained from a realistic tests) rather that pushing it from implementation (i.e. learning everything in a course book chapter after chapter).</p>

  <p class="calibre2">So the tests became something else. They proved very valuable before the ‘implementation’ (i.e. learning for the exam) because:</p>

  <ol class="calibre12">
    <li class="calibre13">they helped us focus on what was needed to reach our goal</li>

    <li class="calibre13">they brought our attention away from what was <strong class="calibre14">not</strong> needed to reach our goal</li>
  </ol>

  <p class="calibre2">That was the value of a test before learning. Note that the tests we would usually receive were not exactly what we would encounter at the time of exam, so we still had to guess. Still, the role of a <strong class="calibre14">test as specification of a need</strong> was already visible.</p>

  <h2 id="calibre_link-48" class="calibre5">Taking It To The Software Development Land</h2>

  <p class="calibre2">I chose this lengthy metaphor to show you that ‘test’ is really another way of specifying a requirement or a need and that it is not something that is counter-intuitive - it occurs in our everyday lives. This is also true in software development. Let us take the following ‘test’ and see what kind of needs it specifies:</p>
  <pre class="calibre10">var reporting = new ReportingFeature();
var anyPowerUser = Any.Of(Users.Admin, Users.Auditor);
Assert.True(reporting.CanBePerformedBy(anyPowerUser));
</pre>

  <p class="calibre2">(In this example, we used <code class="calibre11">Any.Of()</code> method that returns any enumeration value from the specified list. Here, we say “give me a value that is either <code class="calibre11">Users.Admin</code> or <code class="calibre11">Users.Auditor</code>“.)</p>

  <p class="calibre2">Let us look at those (only!) three lines of code, imagining that the production code that makes this ‘test’ pass does not exist yet. What can we learn from these three lines about what the code needs to supply? Count with me:</p>

  <ol class="calibre12">
    <li class="calibre13">We need a reporting feature</li>

    <li class="calibre13">We need to support a notion of users and privileges</li>

    <li class="calibre13">We need to support a domain concept of power user, who is either an administrator or an auditor</li>

    <li class="calibre13">Power users will need to be privileged to use the reporting feature (note that it does not specify which other users should or should not be able to use this feature - we would need a separate ‘test’ for that).</li>
  </ol>

  <p class="calibre2">Also, are already after the phase of designing an API that will fulfill the need. Don’t you think it is pretty much information about the application from just three lines of code?</p>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Lean &amp; Mean</h3>

    <p class="calibre8">You now see some connotations between Test-Driven Development and Lean movement. There are more if you are interested, so be sure to pick up a good read bout lean software development!</p>
  </div>

  <h2 id="calibre_link-49" class="calibre5">A Specification Instead of a Test Suite</h2>

  <p class="calibre2">I hope that you can see now that what we called ‘a test’ is really a kind of specification. The discovery is very recent, so there isn’t a clear terminology on it yet. Some like to call the process of using tests as specifications: Specification By Example, to say that the tests are really examples that help specify and clarify the behavior of developed part of functionality. The terminology is still not rock-solid, so you might encounter different naming for different things. For example, a ‘test’ is often referred to as ‘spec’, or an ‘example’, or a ‘behavior description’, or a ‘specification statement’ or a ‘fact about the developed system’ (the xUnit.NET framework marks each ‘test’ with a <code class="calibre11">[Fact]</code> attribute, suggesting that by writing it, we are stating a single fact about developed code. By the way, xUnit.NET also allows us to state ‘theories’ about our code, but let us leave it for now).</p>

  <p class="calibre2">The time has come to make a deal: I will establish some naming conventions for this book to be consistent, but leave you with the freedom to follow your own if you so desire. Let us agree that for the sake of this book:</p>

  <dl class="calibre2">
    <dt class="calibre16"><strong class="calibre14">Specification Statement</strong> (or simply <strong class="calibre14">Statement</strong>, starting with capital letter)</dt>

    <dd class="calibre17">will be used instead of ‘test’ or ‘test method’</dd>

    <dt class="calibre16"><strong class="calibre14">Specification</strong> (or simply <strong class="calibre14">Spec</strong>), also starting with capital letter</dt>

    <dd class="calibre17">will be used instead of ‘test suite’ or ‘test list’</dd>

    <dt class="calibre16"><strong class="calibre14">Unfulfilled Statement</strong></dt>

    <dd class="calibre17">will be used instead of ‘failing test’</dd>

    <dt class="calibre16"><strong class="calibre14">Fulfilled Statement</strong></dt>

    <dd class="calibre17">will be used instead of ‘passing test’</dd>
  </dl>

  <p class="calibre2">From time to time, I will refer back to the ‘traditional’ terminology, because it is better established and you’ve probably heard some terms already and may wonder how it should be understood in context of thinking of tests as specification.</p>

  <p class="calibre2">From your experience, you may know paper or word specifications, written in plain English or other spoken language. Our specification is different than these specifications in at least few ways:</p>

  <ol class="calibre12">
    <li class="calibre13">it is not written fully up-front (more on this in the next chapters).</li>

    <li class="calibre13">it is executable - you can run it to see whether the code adheres to the specification or not.</li>

    <li class="calibre13">it is written in source code rather than in spoken language - which is both good (less room for misunderstanding - source code is the most formal and structured way of writing specifications) and bad (great care must be taken to keep the specification readable).</li>
  </ol>

  <div class="achievement">
    <h3 class="sigilnotintoc pcalibre">Enlightened</h3>

    <p class="calibre8">You are starting to see Test-Driven Development in a new light - not as a testing technique, but as a mean to specify the behaviors of the code under development.</p>
  </div>
</div>


<div class="calibre4" id="calibre_link-42">
  <h1 class="calibre1">Statement-First programming</h1>

  <h2 id="calibre_link-50" class="calibre5">What is The Point of Writing Specification After The Fact?</h2>

  <p class="calibre2">In the last chapter, I said that in TDD a ‘test’ takes another role - one of a statement being a part of a specification. If we put things this way, then the whole controversial concept of “writing a test before the code” does not pose a problem at all. Quite the contrary - it only seems natural to specify what we are going to write before we attempt to write it. Does the other way round even make sense? A specification written after completing the implementation is nothing more than an attempt at documenting the existing solution. Sure, such attempts can provide some value when done as a kind of reverse-engineering (i.e. writing specification for something that was implemented long ago and we do not really know the exact business rules or policies, which we discover as we document the existing solution) - it has an excitement of discovery in it, but doing it just after we, ourselves, made all the decisions seems like a waste of time, not to mention that it is dead boring (Do not believe me? Try implementing a simple calculator app and the write specification for it just after it is implemented and working). Anyway, specifying how something should work after the fact can hardly be considered creative.</p>

  <p class="calibre2">Oh, and did I tell you that without a specification of any kind we do not really know whether we are done implementing our changes or not (because in order to know it, we need to compare the implemented functionality to ‘something’, even if this ‘something’ is only in the customer’s head).</p>

  <p class="calibre2">Another thing I mentioned in the previous chapter was that one of the differences between a textual specification and our Specification consisting of executable Statements is that, although the code follows the Specification, we do not write our Specification fully up-front. The usual sequence is to specify a bit first and then code a bit, then repeat one Statement at a time. When doing TDD, we are traversing repeatedly through few phases that make up a cycle. We like these cycles to be short, so that we can get a quick feedback. Being able to get this quick feedback is essential, because it allows us to move forward with confidence that what we already have works as we intended. Also, it allows us to use the knowledge we gained in the previous cycle to make the next cycle more efficient (if you do not believe me that quick feedback is good, ask yourself a question: “how many times a day do I compile the code I work on?”).</p>

  <p class="calibre2">Reading so much about cycles, it is probably no surprise to you that the traditional illustration of the TDD process is modeled visually as a circle-like flow:</p>

  <p class="calibre2"><img alt="Traditional_TDD_cycle" src="images/000002.png" class="calibre7" /></p>

  <p class="calibre2">Note that the above form uses the traditional terminology of TDD, so before I explain the steps, I will translate it to use our terms of Specification and Statements:</p>

  <p class="calibre2"><img alt="Modern_TDD_cycle" src="images/000003.png" class="calibre7" /></p>

  <p class="calibre2">The second version seems more like common sense than the first one - specifying how something should behave before putting that behavior in place is way more intuitive than testing something that does not exist.</p>

  <p class="calibre2">Anyway, these three steps demand some explanation. In the coming chapters, I will give you some examples of how this process works in practice and introduce an expanded version, but in the meantime, its sufficient to say that:</p>

  <dl class="calibre2">
    <dt class="calibre16">Write an unfulfilled Statement</dt>

    <dd class="calibre17">means that the Statement evaluates to false (it shows on the test list as unfulfilled - in most xUnit frameworks, it will be marked with red color)</dd>

    <dt class="calibre16">Fulfill it</dt>

    <dd class="calibre17">means that we write just enough code to fulfill the Statement (in most xUnit frameworks, the fulfilled Statement will be marked with green color). Later in the course of the book, you will see how small can be “just enough”</dd>

    <dt class="calibre16">Refactor</dt>

    <dd class="calibre17">is a step that I have silently discarded so far (and will do so for at least few next chapters. Do not worry, we will get back to it eventually). Basically, it boils down to using the safety net of executable specification we already have in place to safely enhance the quality of the covered code while all mistakes we make in the process are quickly discovered by the running Specification.</dd>
  </dl>

  <p class="calibre2">By the way, this process is sometimes referred to as “Red-Green-Refactor”. I am just mentioning it here for the record - I am not planning to use this term further in the book.</p>

  <h2 id="calibre_link-51" class="calibre5">The Benefit of Failure</h2>

  <p class="calibre2">Look again at the drawing with TDD process - can you spot a single word I underlined? Yes, it is <strong class="calibre14">unfulfilled</strong>. It means that when you write a Statement, you have to evaluate it (i.e. run it) and watch it fail its assertions before providing implementation that makes this Statement true. Why is that so important? Is it not just enough to write the Statement first? Why run it and watch it fail?</p>

  <p class="calibre2">There are multiple reasons and I will try to outline few of them briefly.</p>

  <h3 class="sigilnotintoc">You do not know whether the Statement can ever be false until you see it evaluate to false</h3>

  <p class="calibre2">Every accurate Statement (do I have to tell you that such Statements are what we are interested in?) fails when it isn’t fulfilled and passes when it is. That is one of the main reasons we write it - to receive this feedback. Also, after being fulfilled, the Statement becomes a part of the executable specification and starts failing as soon as the code stops fulfilling it (e.g. as a result of mistake made during code rework). When your run a Statement after it is implemented and it is evaluated as true, how do you know whether it really describes a need accurately? You did not ever watch it fail, so how do you know it ever will?</p>

  <p class="calibre2">The first time I encountered this argument (it was before I started thinking of unit tests as executable specification), it quickly raised my self-defense mechanism: “seriously?” - I thought - “I am a wise person, I know what I am writing. If I make my unit tests small enough, it is self-evident that I am describing the correct behavior. This is paranoid”. However, life quickly verified my claims and I was forced to withdraw my arguments. Let me describe, from my experience, three ways (there are more, I just forgot the rest :-D) one can really put in a Statement that is always evaluated as true, regardless of the code being correct or not (i.e. a Statement that cheats you into thinking it is fulfilled even when it is not):</p>

  <h4 class="sigilnotintoc1">1. Accidental omission of adding a Statement to Specification.</h4>

  <p class="calibre2">However funny this may sound, it happened to me few times. The example I am going to give is from C#, but almost every xUnit framework in almost every language has some kind of mechanism of marking methods as Statements, whether by attributes (C#, e.g. xUnit.Net’s <code class="calibre11">Fact</code> attribute) or annotations (Java) or with macros (C and C++) or by inheriting from common class, or just a naming convention.</p>

  <p class="calibre2">Let us take xUnit.Net as an example. As I stated previously, In xUnit.Net, to turn a method into a Statement, you mark it with <code class="calibre11">[Fact]</code> attribute the following way:</p>
  <pre class="calibre10">public class CalculatorSpecification
{
  [Fact]
  public void ShouldDisplayAdditionResultAsSumOfArguments() 
  {
    //... 
  }
}
</pre>

  <p class="calibre2">Now, imagine that you are writing this Statement post-factum as a unit test in an environment that has, let us say, more than thirty Statements - you have written the code, now you are just creating a test after test “to ensure” (as you see, this is not my favorite reason for writing unit tests) the code works. Code, test - pass, test - pass, test - pass. You almost always evaluate your code against the whole Specification, since it is usually easier than selectig what to evaluate each time, plus, you get more confidence this way that you did not break by mistake something that is already working. So, this is really: Code, Test - all pass, test - all pass, test - all pass… Hopefully, you use some kind of snippets mechanism for creating new Statements, but if not (and many do not actually do this), once in a while, you do something like this:</p>
  <pre class="calibre10">
public class CalculatorSpecification
{
  //... some Statements here

  //oops… forgot to copy-paste the attribute!
  public void ShouldDisplayZeroWhenResetIsPerformed()
  {
    //... 
  }
}
</pre>

  <p class="calibre2">And you do not even notice that this will not be evaluated with the rest of the Specification, because it already consists of so many Statements that it is almost irrational to search for your added Statement in the list and make sure it is there each time. Also, note that the fact that you omitted the addition, does not disturb your work flow: test - all pass, test - all pass, test - all pass… In other words, your process does not give you any feedback on your mistake. So, what you end up is a Statement that not only will never be false - <strong class="calibre14">it will never be evaluated</strong>.</p>

  <p class="calibre2">How does treating tests as Statements and evaluating them before making them true help here? <strong class="calibre14">Because then, a Statement that starts off being evaluated as true is what DOES disturb your work flow.</strong> In TDD, the work flow is: Statement - unfulfilled - fulfilled (ok, and refactor, but for the sake of THIS discussion, it does not matter so much), Statement - unfulfilled - fulfilled, Statement - unfulfilled - fulfilled… So every time you fail to see the “unfulfilled” stage, you get feedback from your process that something suspicious is happening. This lets you investigate and, if necessary, fix the situation at hand.</p>

  <h4 class="sigilnotintoc1">2. Misplacing mock setup</h4>

  <p class="calibre2">Ok, this may sound even funnier (well, honestly, most mistakes sound funny), but it also happened to me a couple of times, so it makes sense to mention it. The example I am going to show uses manual mocks, but this can happen with dynamic mocks as well, especially if you are in a hurry.</p>

  <p class="calibre2">Let us take a look at the following Statement saying that setting a value higher than allowed to a field of a frame should produce error result:</p>
  <pre class="calibre10">[Fact]
public void ShouldRecognizeTimeSlotAboveMaximumAllowedAsInvalid()
{
  //GIVEN
  var frame = new FrameMock(); //manual mock
  var validation = new Validation();
  var timeSlotAboveMaximumAllowed = TimeSlot.MaxAllowed + 1;

  //WHEN
  var result = validation.PerformForTimeSlotIn(frame);
  frame.GetTimeSlot_Returns 
    = timeSlotAboveMaximumAllowed;

  //THEN
  Assert.False(result.Passed);
  Assert.Equal(
    ValidationFailureReasons.AboveAcceptableLimit, 
    result.Reason);
}
</pre>

  <p class="calibre2">Note how the method <code class="calibre11">PerformForTimeSlotIn()</code>, which triggers the specified behavior is accidentally called BEFORE the mock is actually set up and the set up return value is never taken into account. By some strange coincidence, this error did not alter the expected end result so we did not even notice. It sometimes turns out like this, most often in case of various boundary values (nulls etc.).</p>

  <h4 class="sigilnotintoc1">3. Using static data inside production code</h4>

  <p class="calibre2">Once in a while, you have to jump in and add some new Statements to some class Specification and some logic to the class itself. Let us assume that the class and its existing specification was written by someone else. Imagine this code is a wrapper around your product XML configuration file. You decide to write your Statements AFTER applying the changes (“well”, you can say, “I am all protected by the Specification that is already in place, so I can make my change without risking regression, then just test my changes and it is all good…”).</p>

  <p class="calibre2">So, you start writing the new Statement. The Specification class already contains a field member like this:</p>
  <pre class="calibre10">public class XmlConfigurationSpecification
{
  XmlConfiguration config = new XmlConfiguration(xmlFixtureString);
  
  //...
  //...

</pre>

  <p class="calibre2">What it does is to set up an object used by every Statement. So, each Statement uses a <code class="calibre11">config</code> object initialized with the same <code class="calibre11">xmlConfiguration</code> string value. The string is already pretty huge and messy, since it was made to contain what is required by all existing Statements. You need to write tests for is a little corner case that does not need all this crap that is inside this string. So, you decide to start fresh and create a separate object of <code class="calibre11">XmlConfiguration</code> class with your own, minimal string. Your Statement begins like this:</p>
  <pre class="calibre10">string customFixture = CreateMyOwnFixtureForThisTestOnly();
var configuration = new XmlConfiguration(customFixture);
...
</pre>

  <p class="calibre2">And it passes - cool… not. Ok, what is wrong with this? Nothing big, unless you read the source code of XmlConfiguration class carefully. Inside, you can see, how the xml string is stored:</p>
  <pre class="calibre10">private static string xmlText; //note the static keyword!
</pre>

  <p class="calibre2">What the…? Well, well, here is what happened: the author of this class coded in a small little optimization. He thought: “In this app, the configuration is only modified by members of the support staff and to do it, they have to shut down the system, so, there is no need to read the XML file every time an XmlConfiguration object is created. I can save some CPU cycles and I/O operations by reading it only once when the first object is created. Another created object will just use the same XML!”. Good for him, not so good for you. Why? Because (unless your Statement is evaluated prior to being fulfilled), your custom xml string will never actually be used!</p>

  <h3 class="sigilnotintoc">“Test-After” ends up as “Test-Never”</h3>

  <p class="calibre2">I will ask this question again: ever had to write a requirement or design document for something that you already implemented? Was it fun? Was it valuable? Was it creative? No, I do not think so. The same is with our executable specification. After we write the code, we have little motivation to specify what is already written - some of the pieces of code “we can just see are correct”, other pieces “we already saw working” when we copied our code over to our deployment machine and ran few sanity checks… The design is ready… Specification? Maybe next time…</p>

  <p class="calibre2">Another reason might be time pressure. Let us be honest - we are all in a hurry, we are all under pressure and when this pressure is too high, it triggers heroic behaviors in us, especially when there is a risk of not making it with the sprint commitment. Such heroic behavior usually goes by the following rules: drop all the “baggage”, stop learning and experimenting, revert to all of the old “safe” behaviors and “save what we can!”. If Specification is written at the end, it is often sacrificed on the altar of making it with the commitment, since the code is already written, “and it will be tested anyway by real tests” (box tests, smoke tests, sanity tests etc.). It is quite the contrary when starting with a Statement, where the Statement evaluating to false is <strong class="calibre14">a reason</strong> to write any code. Thus, if we want to write code, Specification become irremovable part of your development. By the way, I bet in big corporations no one sane ever thinks they can abandon checking in the code to source control, at the same time treating Specification as “an optional addition”.</p>

  <h3 class="sigilnotintoc">Not starting from specification leads to waste of time on making objects testable</h3>

  <p class="calibre2">It so happens, that I like watching and reading Uncle Bob. One day, I was listening to <a href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years" target="_blank">his keynote at Ruby Midwest 2011, called Architecture The Lost Years</a>. At the end, Robert made some digressions, one of them being about TDD. He said that writing unit tests after the code is not TDD. It is a waste of time.</p>

  <p class="calibre2">My initial thought was that the comment was only about missing all the benefits that starting with false Statement brings you: the ability to see the Statement fail, the ability to do a clean-sheet analysis etc., however, now I am of opinion that there is more to it. It is something I got from Amir Kolsky and Scott Bain - in order to be able to write maintainable Specification for a piece of code, the code has to have a high level of a quality called <strong class="calibre14">testability</strong> (we will talk about testability later on, do not worry - for now let us assume that the easier it is to write a Statement for a behavior of a class, the higher testability it has). That does not tell us much about where is the waste I mentioned, does it? To see it, let us see how dealing with testability looks like in Statement-first workflow (let us assume that we are creating new code, not adding stuff to dirty, ugly legacy code):</p>

  <ol class="calibre12">
    <li class="calibre13">Write false Statement (this step ensures that code has high testability)</li>

    <li class="calibre13">Write code to make the Statement true</li>
  </ol>

  <p class="calibre2">Now, how does it usually look like when we write the code first (extra steps marked with <strong class="calibre14">strong text</strong>):</p>

  <ol class="calibre12">
    <li class="calibre13">Write some production code (probably spans few classes until we are satisfied)</li>

    <li class="calibre13"><strong class="calibre14">Start writing unit tests</strong></li>

    <li class="calibre13"><strong class="calibre14">Notice that unit testing the whole set of classes is cumbersome and unsustainable and contains high redundancy.</strong></li>

    <li class="calibre13"><strong class="calibre14">Restructure the code to be able to isolate objects and use mocks (this step ensures that code has high testability)</strong></li>

    <li class="calibre13">Write unit tests</li>
  </ol>

  <p class="calibre2">What is the equivalent of the marked steps in Statement-First approach? Nothing! Doing these things is a waste of time! Sadly, this is a waste I see done over and over again.</p>
</div>


<div class="calibre4" id="calibre_link-27">
  <h1 class="calibre1">Practicing what we already learned</h1>

  <blockquote class="calibre18">
    <p class="calibre2">And now, a taste of things to come!</p>

    <p class="calibre2">- Shang Tsung, Mortal Kombat The Movie</p>
  </blockquote>

  <p class="calibre2">The above quote took place just before a fighting scene in which a nameless warrior jumped at Sub-Zero only to be frozen and broken into multiple pieces upon hitting the wall. The scene was not spectacular in terms of fighting technique or length. Also, the nameless guy did not even try hard - the only thing he did was to jump only to be hit by a freezing ball, which, by the way, he actually saw coming. It looked a lot like the fight was set up only to showcase Sub-Zero’s freezing ability. Guess what? In this chapter, we are gonna do roughly the same thing - set up a fake, easy scenario just to showcase some of the basic TDD elements!</p>

  <p class="calibre2">The previous chapter was filled with a lot of theory and philosophy, don’t you think? I really hope you did not fall asleep while reading it. To tell you the truth, we need to grasp much more theory until we are really able to write real-world applications using TDD. To compensate for this somehow, I propose we make a side trip from the trail and try what we already learned on a quick and easy example. As we go through the example, you might wonder how on earth could you possibly write real applications the way we will write our simple program. Do not worry, I will not show you all the tricks yet, so treat it as a “taste of things to come”. In other words, the example will be as close to real world problems as the fight between Sub-Zero and nameless ninja was to real martial arts fight, but will show you some of the elements of TDD process.</p>

  <h2 id="calibre_link-52" class="calibre5">Let me tell you a story</h2>

  <p class="calibre2">Meet Johnny and Benjamin, two developers from Buthig Company. Johnny is quite fluent in programming and Test-Driven Development, while Benjamin is an intern under Johnny’s mentorship and is eager to learn TDD. They are on their way to their customer, Jane, who requested their presence as she wants them to do write a small program for her. Together with them, we will see how they interact with the customer and how Benjamin tries to understand the basics of TDD. Just as you, Benjamin is a novice so his questions may reflect yours. However, if you find anything explained in not enough details, do not worry - in the next chapters, we will be expanding on this material.</p>

  <h2 id="calibre_link-53" class="calibre5">Act 1: The Car</h2>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> How do you feel on your first assignment?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I am pretty excited! I hope I can learn some of the TDD stuff you promised to teach me.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Not only TDD, but we are also gonna use some of the practices associated with a process called Acceptance Test Driven Development, albeit in a simplified form.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Acceptance Test-Driven Development? What is that?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> While TDD is usually referred to as a development technique, ATDD is something more of a collaboration method. Both ATDD and TDD have a bit of analysis in them and work very well together as both use the same underlying principles, just on different levels. We will need only a small subset of what ATDD has to offer, so do not get over-excited.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure.</p>

  <h2 id="calibre_link-54" class="calibre5">Act 2: The Customer</h2>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hi, Jane, how are you?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Thanks, I am fine, how about you?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Same here, thanks. So, can you tell us a bit about the software you need us to write?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure. Recently, I bought a new smartphone as a replacement for my old one. The thing is, I am really used to the calculator application that was running on the previous phone and I cannot find it for my current device.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Cannot you just use another calculator app? There are plenty of them available to download from the web.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That is right. I checked them all and none has exactly the same behavior as the one I was using for my tax calculations. You know, the program was like right hand to me and it had some really nice shortcuts that made my life easier.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> So you want us to reproduce the application to run on your new device?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Yes.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Are you aware that apart from the fancy features that you were using we will have to allocate some effort to implement the basics that all the calculators have?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure, I am OK with that. I am so used to my calculator application so much that if I use something else for more than few months, I will have to pay psychotherapist instead of you guys. Apart from that, writing a calculator app seems like a simple task in my mind, so the cost isn’t going to be overwhelming, right?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I think I get it. Let us get it going then. We will be implementing the functionality incrementally, starting with the most essential ones. Which feature of the calculator would you consider the most essential?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That would be addition of numbers, I guess.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok, that will be our target for the first iteration. After the iteration, we will deliver this part of functionality for you to try out and give us some feedback. However, before we can even implement addition, we will have to implement displaying digits on the screen as you enter them. Is that correct?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> yes, I want the display stuff to work as well - it is the most basic feature, so…</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok then, this is a simple functionality, so let me suggest some user stories as I understand what you already said and you will correct me where I am wrong. Here we go:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">In order to</strong> know that the calculator is turned on, <strong class="calibre14">As a</strong> tax payer <strong class="calibre14">I want</strong> to see “0” on the screen as soon as I turn it on.</li>

    <li class="calibre13"><strong class="calibre14">In order to</strong> see what numbers I am currently operating on, <strong class="calibre14">As a</strong> tax payer, <strong class="calibre14">I want</strong> the calculator to display the values I enter</li>

    <li class="calibre13"><strong class="calibre14">In order to</strong> calculate sum of my different incomes, <strong class="calibre14">As a</strong> tax payer <strong class="calibre14">I want</strong> the calculator to enable addition of multiple numbers</li>
  </ol>

  <p class="calibre2">What do you think?</p>

  <p class="calibre2"><strong class="calibre14">Jane</strong>: The stories pretty much reflect what I want for the first iteration. I do not think I have any corrections to make.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now we will take each story and collect some examples of how it should work.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Johnny, don’t you think it is obvious enough to proceed with implementation straight away?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Trust me, Benjamin, if there is one word I fear most in communication, it is “obvious”. Miscommunication happens most often around things that people consider obvious, simply because other people do not.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Ok, I am in. What do I do?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us go through stories one by one and see if we can find some key examples of how the features work. The first story is…</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> know that the calculator is turned on, <strong class="calibre19">As a</strong> tax payer <strong class="calibre19">I want</strong> to see “0” on the screen as soon as I turn it on.</h3>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> I do not think there is much to talk about. If you display “0”, I will be happy. That is all.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us write down this example:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> That makes me wonder… what should happen when I press “0” again at this stage?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good catch, that is what these examples are for - they make our thinking concrete. As Ken Pugh says: “Often the complete understanding of a concept does not occur until someone tries to use the concept”. We would normally put it on a TODO list, because it is part of a different story, but we are actually done with this one, so let us move straight to the story about displaying entered digits. How about it, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Agree.</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> see what numbers I am currently operating on, <strong class="calibre19">As a</strong> tax payer, <strong class="calibre19">I want</strong> the calculator to display the values I enter</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us begin with the case raised by Benjamin. What should happen when I input “0” multiple times after I have only “0” on the display?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Just one “0” should be displayed</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Do you mean this?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">0,0,0</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Zero is a special case &ndash; it is displayed only once</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> That is right. Other than this, the digits should just show on the screen, like this:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> How about this:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7,1,2,3,4,5,6</td>

      <td class="calibre23">1234567123456?</td>

      <td class="calibre23">Entered digits are displayed?</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Actually, no. My old calculator app has a limit of six digits that I can enter, so it should be:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7,1,2,3,4,5,6</td>

      <td class="calibre23">123456</td>

      <td class="calibre23">Display limited to six digits</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> another good catch, Benjamin!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I think I am beginning to understand why you like working with examples!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good. Is there anything else, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> No, that is pretty much it. Let us take another story.</p>

  <h3 class="sigilnotintoc"><strong class="calibre19">In order to</strong> calculate sum of my different incomes, <strong class="calibre19">As a</strong> tax payer <strong class="calibre19">I want</strong> the calculator to enable addition of multiple numbers</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Is the following all we have to support?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3,+,4,=</td>

      <td class="calibre23">9</td>

      <td class="calibre23">Simple addition of numbers</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> This scenario is correct, however, there is also a case when I start with “+” without inputting any number before. This should be treated as adding to zero:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">+,1,=</td>

      <td class="calibre23">1</td>

      <td class="calibre23">Addition shortcut &ndash; treated as 0+1</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> How about when the output is a number longer than six digits limit? Is it OK that we truncate it like this?</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>

      <td class="calibre23">199999</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Sure, I do not mind. I do not add such big numbers anyway.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> There is still one question we missed. Let us say that I input a number, then press “+” and then another number without asking for result with “=”. What should I see?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Every time you press “+”, the calculator should consider entering current number finished and overwrite it as soon as you press any other digit:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3</td>

      <td class="calibre23">3</td>

      <td class="calibre23">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Oh, and just asking for result after the calculator is turned on should result in “0”.</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">=</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Result key in itself does nothing</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us sum up our discoveries:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">0,0,0</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Zero is a special case &ndash; it is displayed only once</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3,4,5,6,7</td>

      <td class="calibre23">123456</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3</td>

      <td class="calibre23">3</td>

      <td class="calibre23">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">=</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Result key in itself does nothing</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">+,1,=</td>

      <td class="calibre23">1</td>

      <td class="calibre23">Addition shortcut &ndash; treated as 0+1</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">2,+,3,+,4,=</td>

      <td class="calibre23">9</td>

      <td class="calibre23">Simple addition of numbers</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>

      <td class="calibre23">199999</td>

      <td class="calibre23">Our display is limited to six digits only</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> The limiting of digits displayed looks like a whole new feature, so I suggest we add it to the backlog and do it in another sprint. In this sprint, we will not handle such situation at all. How about that, Jane?</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> Fine with me. Looks like a lot of work. Nice that we discovered it up-front. For me, the limiting capability seemed so obvious that I did not even think it would be worth mentioning.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> See? That is why I do not like the word “obvious”. Jane, we will get back to you if any more questions arise. For now, II think we know enough to implement these three stories for you.</p>

  <p class="calibre2"><strong class="calibre14">Jane:</strong> good luck!</p>

  <h2 id="calibre_link-55" class="calibre5">Act 3: Test-Driven Development</h2>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, that was cool. Was that Acceptance Test-Driven Development?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> In a greatly simplified version, yes. The reason I took you with me was to show you the similarities between working with customer the way we did and working with the code using TDD process. They are both applying the same set of principles, just on different levels.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I am dying to see it with my own eyes. Shall we start?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure. If we followed the ATDD process, we would start writing what we call acceptance-level specification. In our case, however, a unit-level specification will be enough. Let us take the first example:</p>

  <h3 class="sigilnotintoc">Statement 1: Calculator should display 0 on creation</h3>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">N/A</td>

      <td class="calibre23">0</td>

      <td class="calibre23">Initial displayed value</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, try to write the first Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Boy, I do not know how to start.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> start by writing the statement in a plain English. What should the calculator do?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It should display “0” when I turn the application on.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> In our case, “turning on” is creating a calculator. Let us write it down as a method name:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{

}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Why is the name of the class <code class="calibre11">CalculatorSpecification</code> and the name of the method <code class="calibre11">ShouldDisplay0WhenCreated</code>?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> It is a naming convention. There are many others, but this is the one that I like. The rule is that when you take the name of the class without the <code class="calibre11">Specification</code> part followed by the name of the method, it should form a legit sentence. For instance, if I apply it to what we wrote, it would make a sentence: “Calculator should display 0 when created”.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ah, I see now. So it is a statement of behavior, isn’t it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> That is right. Now, the second trick I can sell to you is that if you do not know what code to start with, start with the expected result. In our case, we are expecting that the behavior will end up as displaying “0”, right? So let us just write it in form of an assertion.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You mean something like this?</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 Assert.Equal("0", displayedResult);
}

}</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Precisely.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> But that does not even compile. What use is it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> the code not compiling is the feedback that you needed to proceed. While previously you did not know where to start, now you have a clear goal - make this code compile. Firstly, whre do you get the displayed value?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> From the calculator display, of course!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Then write it down how you get the value form the display.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> like how?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> like this:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 var displayedResult = calculator.Display();

 Assert.Equal("0", displayedResult);
}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I see. Now the calculator is not created anywhere. I need to create it somewhere now or it will not compile and this is my next step. Is this how it works?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes, you are catching on quickly.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ok then, here goes:</p>
  <pre class="calibre10">public class CalculatorSpecification
{

[Fact] public void
ShouldDisplay0WhenCreated()
{
 var calculator = new Calculator();

 var displayedResult = calculator.Display();

 Assert.Equal("0", displayedResult);
}

}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Bravo!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Now the code still does not compile, because I do not have the <code class="calibre11">Calculator</code> class at all…</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> sounds like a good reason to create it.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> OK.</p>
  <pre class="calibre10">public class Calculator
{
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks like the <code class="calibre11">Display()</code> method is missing too. I will add it.</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "0";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hey hey, not so fast!</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> What?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> You already provided an implementation that will make our current Statement true. Remember its name? <code class="calibre11">ShouldDisplay0WhenCreated</code> - and that is exactly what the code you wrote does. Before we arrive at this point, let us make sure this Statement can ever be evaluates as false. So for now, let us change it to this:</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "Once upon a time in Africa…";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Look, now we can run the Specification and watch that Statement evaluate to false, because it expects “0”, but gets “Once upon a time in Africa…”.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Running… Ok, it is false. By the way, do you always use such silly values to make Statements false?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Hahaha, no, I just did it to emphasize the point. Normally, I would write <code class="calibre11">return "";</code> or something similarly simple. Now we can evaluate the Statement and see it evaluate to false. Now we are sure that we have not yet implemented what is required for the Statement to be true.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I think I get it. For now, the Statement shows that we do not have something we need and gives us a reason to add this “thing”. When we do so, this Statement will show that we do have what we need. So what do we do now?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Write the simplest thing that makes this Statement true.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> like this?</p>
  <pre class="calibre10">public class Calculator
{
  public string Display()
  {
    return "0";
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> But that is not a real implementation. What is the value behind putting in a hardcoded string? The final implementation is not going to be like this for sure!</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> You’re right. The final implementation is most probably going to be different. What we did, however, is still valuable because:</p>

  <ol class="calibre12">
    <li class="calibre13">You’re one step closer to implementing the final solution</li>

    <li class="calibre13">This feeling that this is not the final implementation points you towards writing more Statements. When there is enough Statements to make your implementation complete, it usually means that you have a complete Specification of class behaviors as well.</li>

    <li class="calibre13">If you treat making every Statement true as an achievement, this practice allows you to evolve your code without losing what you already achieved. If by accident you break any of the behaviors you’ve already implemented, the Specification is going to tell you because one of the existing Statements that were previously true will then evaluate to false. You can then either fix it or undo your changes using version control and start over from the point where all existing Statements were true.</li>
  </ol>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> looks like quite a few benefits. Still, I will have to get used to this kind of working.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> do not worry, it is central to TDD, so you will grasp it in no time. Now, before we proceed to the next Statement, let us look at what we already achieved. First, we wrote a Statement that turned out false. Then, we wrote just enough code to make the Statement true. Time for a step called Refactoring. In this step, we will take a look at the Statement and the code and remove duplication. Can you see what is duplicated between the Statement and the code?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> both of them contain the literal “0”. The Statement has it here:</p>
  <pre class="calibre10">Assert.Equal("0", displayedResult);</pre>

  <p class="calibre2">and the implementation here:</p>
  <pre class="calibre10">return "0";</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, let us eliminate this duplication by introducing a constant called <code class="calibre11">InitialValue</code>. The Statement will now look like this:</p>
  <pre class="calibre10">[Fact] public void
ShouldDisplayInitialValueWhenCreated()
{
 var calculator = new Calculator();

 var displayedResult = calculator.Display();

 Assert.Equal(Calculator.InitialValue, displayedResult);
}
</pre>

  <p class="calibre2">and the implementation:</p>
  <pre class="calibre10">public class Calculator
{
  public const string InitialValue = "0";
  public string Display()
  {
    return InitialValue;
  } 
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> The code looks better and having the constant in one place will make it more maintainable, but I think the Statement in its current form is weaker than before. We could change the <code class="calibre11">InitialValue</code> to anything and the Statement would still be true, since it does not force this constant to be “0”.</p>

  <p class="calibre2">That is right. We need to add it to our TODO list to handle this case. Can you write it down?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure. I will write it as “TODO: 0 should be used as an initial value.”</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Ok. We should handle it now, especially that it is part of the story we are currently implementing, but I will leave it for later just to show you the power of TODO list in TDD - whatever is on the list, we can forget and get back to when we have nothing better to do. Our next item from the list is this:</p>

  <h3 class="sigilnotintoc">Statement 2: Calculator should display entered digits</h3>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">key sequence</th>

      <th class="calibre22">Displayed output</th>

      <th class="calibre22">Notes</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">1,2,3</td>

      <td class="calibre23">123</td>

      <td class="calibre23">Entered digits are displayed</td>
    </tr>
  </table>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, can you come up with a Statement for this behavior?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> I will try. Here goes:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayEnteredDigits()
{
  var calculator = new Calculator();
  
  calculator.Enter(1);
  calculator.Enter(2);
  calculator.Enter(3);
  var displayedValue = calculator.Display();

  Assert.Equal("123", displayedValue);
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I am glad that you got the part about naming and writing a Statement. One thing we will have to work on here though.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> what is it?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> When we talked to Jane, we used examples with real values. These real values were extremely helpful in pinning down the corner cases and uncovering missing scenarios. They were easier to imagine as well, so they were a perfect suit for conversation. If we were automating these examples on acceptance level, we would use those real values as well. When we write unit-level Statements, however, we use a different technique to get this kind of specification more abstract. First of all, let me enumerate the weaknesses of the approach you just used:</p>

  <ol class="calibre12">
    <li class="calibre13">Making a method <code class="calibre11">Enter()</code> accept an integer value suggests that one can enter more than one digit at once, e.g. <code class="calibre11">calculator.Enter(123)</code>, which is not what we want. We could detect such cases and throw exceptions if the value is outside the 0-9 range, but there are better ways when we know we will only be supporting ten digits (0,1,2,3,4,5,6,7,8,9).</li>

    <li class="calibre13">The Statement does not clearly show the relationship between input and output. Of course, in this simple case it is pretty self-evident that the sum is a concatenation of entered digits, we do not want anyone who will be reading this Specification in the future to have to guess.</li>

    <li class="calibre13">The Statement suggests that what you wrote is sufficient for any value, which isn’t true, since the behavior for “0” is different (no matter how many times we enter “0”, the result is just “0”)</li>
  </ol>

  <p class="calibre2">Hence, I propose the following:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.Equal(
  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  ),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Johnny, I am lost! Can you explain what is going on here?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure, what do you want to know?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> For instance, what is this <code class="calibre11">DigitKeys</code> type doing here?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> It is supposed to be an enumeration (note that it does not exist yet, we just assume that we have it) to hold all the possible digits user can enter, which are 0-9. This is to ensure that user will not write <code class="calibre11">calculator.Enter(123)</code>. Instead of allowing to enter any number and then detecting errors, we are giving our users a choice from among only the valid values.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Now I get it. So how about the <code class="calibre11">Any.Besides()</code> and <code class="calibre11">Any.Of()</code>? What do they do?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> They are methods from a small utility library I am using when writing unit-level Specifications. <code class="calibre11">Any.Besides()</code> returns any value from enumeration besides the one supplied as an argument. Hence, the call <code class="calibre11">Any.Besides(DigitKeys.Zero)</code> means “any of the values contained in DigitKeys enumeration, but not DigitKeys.Zero”.</p>

  <p class="calibre2">The <code class="calibre11">Any.Of()</code> is simpler - it just returns any value in an enumeration. Note that when I create the values this way, I state explicitly that this behavior occurs when first digit is non-zero. This technique of using generated values instead of literals has its own principles, but let us leave it for later. I promise to give you a detailed lecture on it. Agree?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You better do, because for now, I feel a bit uneasy with generating the values - it seems like the Statement we are writing is getting less deterministic this way. The last question - what about those weird comments you put in the code? Given? When? Then?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Yes, this is a convention that I use, not only in writing, but in thinking as well. I like to think about every behavior in terms of three elements: assumptions (given), trigger (when) and expected result (then). Using the words, we can summarize the Statement we are writing in the following way: “<strong class="calibre14">Given</strong> a calculator, <strong class="calibre14">when</strong> I enter some digits first one being other than zero, <strong class="calibre14">then</strong> they should all be displayed in order they were entered”. This is also something that I will tell you more about later.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Sure, for now I need just enough detail to understand what is going on - we can talk about the principles, pros and cons later. By the way, the following sequence of casts looks a little bit ugly:</p>
  <pre class="calibre10">  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  )
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> We will get back to it and make it more “smarter” in a second after we make this statement true. For now, we need something obvious. Something we know works. Let us evaluate this Statement. What is the result?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Failed, expected “331”, but was “0”.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, now let us write some code to make this Statement true. First, let us introduce an enumeration of digits:</p>
  <pre class="calibre10">public enum DigitKeys
{
 Zero = 0,
 TODO1, //TODO
 TODO2, //TODO
 TODO3, //TODO
 TODO4, //TODO
}</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> What is with all those bogus values? Should we not just enter all the digits we support?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Nope, not yet. We still do not have a Statement which would say what digits are supported and thus make us add them, right?.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> You say you need a Statement for an element to be in an enum??</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> This is a specification we are writing, remember? It should say somewhere which digits we support, should it not?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It is difficult to agree with, especially that I am used to write unit tests, not Statements and in unit tests, I wanted to verify what I was unsure of.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> I will try to give you more arguments later. For now, just bear with me and note that adding such Statement will be almost effortless.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> OK.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now for the implementation. Just to remind you - up to now, it looked like this:</p>
  <pre class="calibre10">public class Calculator
{
  public const string InitialValue = "0";
  public string Display()
  {
    return InitialValue;
  } 
}
</pre>

  <p class="calibre2">This is not enough to support displaying multiple digits (as we saw, because the Statement saying they should be supported was evaluated to false). So let us evolve the code to handle this case:</p>
  <pre class="calibre10">public class Calculator
{
 private int _result = 0;
      
 public void Enter(DigitKeys digit)
 {
  _result *= 10;
  _result += (int)digit; 
 }

 public string Display()
 {
  return _result.ToString();
 }
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Now the Statement is true so we can go back to it and make it a little bit prettier. Let us take a second look at it:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.Equal(
  string.Format("{0}{1}{2}", 
   (int)nonZeroDigit, 
   (int)anyDigit1, 
   (int)anyDigit2
  ),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Remember you said that you do not like the part where <code class="calibre11">string.Format()</code> is used?</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Yeah, it seems a bit unreadable.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Let us extract this part into a utility method and make it more general - we will need a way of constructing expected displayed output in many of our future Statements. Here is my go at this helper method:</p>
  <pre class="calibre10">string StringConsistingOf(params DigitKeys[] digits)
{
 var result = string.Empty;
      
 foreach(var digit in digits) 
 {
  result += (int)digit;
 }
 return result;
}</pre>

  <p class="calibre2">Note that this is more general as it supports any number of parameters. And the Statement after this extraction looks like this:</p>
  <pre class="calibre10">public void [Fact]
ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes()
{
 //GIVEN
 var calculator = new Calculator();
 var nonZeroDigit = Any.Besides(DigitKeys.Zero);
 var anyDigit1 = Any.Of&lt;DigitKeys&gt;();
 var anyDigit2 = Any.Of&lt;DigitKeys&gt;();
          
 //WHEN
 calculator.Enter(nonZeroDigit);
 calculator.Enter(anyDigit1);
 calculator.Enter(anyDigit2);
          
 //THEN
 Assert.AreEqual(
  StringConsistingOf(nonZeroDigit, anyDigit1, anyDigit2),
  calculator.Display()
 );
}
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks better to me. The Statement is still evaluated as true, which means we got it right, did we not?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Not exactly. With such moves such as this one, I like to be extra careful. Let us comment out the body of the <code class="calibre11">Enter()</code> method and see if this Statement can still be made false by the implementation:</p>
  <pre class="calibre10">public void Enter(DigitKeys digit)
 {
  //_result *= 10;
  //_result += (int)digit; 
 }
</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Running… Ok, it is false now. Expected “243”, got “0”.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> good, now we are pretty sure that it works OK. Let us uncomment the lines we just commented out and move forward.</p>

  <h3 class="sigilnotintoc">Statement 3: Calculator should display only one zero digit if it is the only entered digit even if it is entered multiple times</h3>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Benjamin, this should be easy for you, so go ahead and try it. It is really a variation of previous Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Let me try… ok, here it is:</p>
  <pre class="calibre10">[Fact] public void 
ShouldDisplayOnlyOneZeroDigitWhenItIsTheOnlyEnteredDigitEvenIfItIsEnteredMultipleTimes()
{
 var zero = DigitKeys.Zero;
 var calculator = new Calculator();
      
 calculator.Enter(zero);
 calculator.Enter(zero);      
 calculator.Enter(zero);
      
 Assert.Equal(
  StringConsistingOf(DigitKeys.Zero), 
  calculator.Display()
 );
}</pre>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Good, you are learning fast! Let us evaluate this Statement.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> It seems that our current code already fulfills the Statement. Should I try to comment some code to make sure this Statement can fail just like you did in the previous Statement?</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> That would be wise thing to do. When a Statement is true without requiring you to change any production code, it is always suspicious. Just like you said, we have to modify production code for a second to force this Statement to be false, then undo this modification to make it true again. This isn’t as obvious as previously, so let me do it. I will mark all the added lines with <code class="calibre11">//+</code> comment so that you can see them easily:</p>
  <pre class="calibre10">public class Calculator
{
 int _result = 0;
 string fakeResult = "0"; //+
      
 public void Enter(DigitKeys digit)
 {
  _result *= 10;
  _result += (int)digit; 
  if(digit == DigitKeys.Zero) //+
  {  //+
    fakeResult += "0";  //+
  } //+
 }

 public string Display()
 {
  if(_result == 0)  //+
  {  //+
   return fakeResult;  //+
  }  //+
  return _result.ToString();
 }
}</pre>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, looks like a lot of code just to make the Statement false! Is it worth the hassle? We will undo this whole modification in a second anyway</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Depends on how confident you want to feel. I would say that it is usually worth it - at least you know that you got everything right. It might seem like a lot of work, but it actually took me about a minute to add this code and imagine you got it wrong and had to debug it on a production environment. _That_ would be a waste of time.</p>

  <p class="calibre2"><strong class="calibre14">Benjamin:</strong> Ok, I think I get it. Since we saw this Statement turn false, I will undo this modification to make it true again.</p>

  <p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure.</p>

  <div class="calibre24"></div><h2 id="calibre_link-56" class="calibre5">Epilogue</h2>

  <p class="calibre2">Time to leave Johnny and Benjamin, at least for now. I actually planned to make this chapter longer, and cover all the other operations, but I fear I would make this too long and get you bored. You should have a feel of how the TDD cycle looks like, especially that Johnny and Benjamin had a lot of conversations on many other topics in the meantime. I will be revisiting these topics later in the book. For now, so if you felt lost or unconvinced on any of the topics mentioned by Johnny, do not worry - I do not expect you to be proficient with any of the techniques shown in this chapter just yet. Time will come for that.</p>
</div>


<div class="calibre4" id="calibre_link-18">
  <h1 class="calibre1">Sorting Out The Bits</h1>

  <p class="calibre2">In the previous chapter, there has been a lively conversation between Johnny and Benjamin. Even in such a short session, Benjamin, as a TDD novice, had a lot of questions and a lot of things he needed sorted out. We will pick up all those questions and explain them one by one. Here they are:</p>

  <ul class="calibre25">
    <li class="calibre13">How to name a Statement?</li>

    <li class="calibre13">How to start writing a Statement?</li>

    <li class="calibre13">How is TDD about analysis and what does this “GIVEN-WHEN-THEN” mean?</li>

    <li class="calibre13">What exactly is the scope of a Statement? A class, a method, or something else?</li>

    <li class="calibre13">What is the role of TODO list in TDD?</li>

    <li class="calibre13">Why use anonymous generated values instead of literals as input of a specified behavior?</li>

    <li class="calibre13">Why and how to use the Any class?</li>

    <li class="calibre13">What code to extract from a Statement to shared utility method?</li>

    <li class="calibre13">Why such a strange approach to create enumerated constants?</li>
  </ul>

  <p class="calibre2">A lot of questions, isn’t it? It is unfortunate that TDD has this high entry barrier, at least for someone used to the traditional way of writing code. Anyway, that is what this tutorial is for - to answer such questions and lower this barrier. Thus, we will try to answer those questions one by one.</p>
</div>


<div class="calibre4" id="calibre_link-16">
  <h1 class="calibre1">How to start?</h1>

  <p class="calibre2">Whenever I sat down with a person that was about to write their first code in a Statement-first manner, the person would first stare at the screen, then at me, then would say: “what now?”. It is easy to say: “You know how to write code, you know how to write a unit test for it, just this time start with the latter rather than the first”, but for many people, this is something that blocks them completely. If you are one of them, do not worry - you are not alone. I decided to dedicate this chapter solely to techniques for kicking off a Statement when there is no code.</p>

  <h2 id="calibre_link-57" class="calibre5">Start with a good name</h2>

  <p class="calibre2">It may sound obvious, but some people are having serious trouble describing the behavior they expect from their code. If you can name such behavior, it is a great starting point.</p>

  <p class="calibre2">I know not everybody pays attention to naming their Statements, mainly because the Statements are considered as tests and second-level citizens - as long as they run and “prove the code does not contain defects”, they are considered sufficient. We will take a look at some examples of bad names and then I will introduce to you some rules of good naming.</p>

  <h3 class="sigilnotintoc">Consequences of bad naming</h3>

  <p class="calibre2">As I said, many people do not really care how their Statements are named. This is a symptom of treating the Specification as garbage or leftovers - such situation is dangerous, because as soon as this kind of thinking is established, it leads to bad, unmaintainable Specification that looks more like lumps of accidental code put together in a haste than a living documentation. Imagine that your Specification consists of names like this:</p>

  <ul class="calibre25">
    <li class="calibre13"><code class="calibre11">TrySendPacket()</code></li>

    <li class="calibre13"><code class="calibre11">TrySendPacket2()</code></li>

    <li class="calibre13"><code class="calibre11">testSendingManyPackets()</code></li>

    <li class="calibre13"><code class="calibre11">testWrongPacketOrder1()</code></li>

    <li class="calibre13"><code class="calibre11">testWrongPacketOrder2()</code></li>
  </ul>

  <p class="calibre2">and try for yourself how difficult it is to answer the following questions:</p>

  <ol class="calibre12">
    <li class="calibre13">How do you know what situation each Statement describes?</li>

    <li class="calibre13">How do you know whether the Statement describes a single situation, or few of them at the same time?</li>

    <li class="calibre13">How do you know whether the assertions inside those Statements are really the right ones assuming each Statement was written by someone else or a long time ago?</li>

    <li class="calibre13">How do you know whether the Statement should stay or be removed when you modify the functionality it specifies?</li>

    <li class="calibre13">If your changes in production code make a Statement evaluate to false, how do you know whether the Statement is no longer correct or the production code is wrong?</li>

    <li class="calibre13">How do you know whether you will not introduce a duplicate Statement for a behavior that is already specified by another Statement when adding to Specification originally created by another team member?</li>

    <li class="calibre13">How do you estimate, by looking at the runner tool report, whether the fix for failing Statement will be easy or not?</li>

    <li class="calibre13">How do you answer a new developer in your team when they ask you “what is this Statement for?”</li>

    <li class="calibre13">How can you keep track of the Statements already made about the specified class vs those that still need to be made?</li>
  </ol>

  <h3 class="sigilnotintoc">What does a good name contain?</h3>

  <p class="calibre2">For the name of the Statement to be of any use, it has to describe the expected behavior. At minimum, it should describe what happens under what circumstances. Let us take a look at one of the names Steve freeman and Nat Pryce came up in their great book Growing Object Oriented Software Guided By Tests:</p>
  <pre class="calibre10">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort()</pre>

  <p class="calibre2">Note few things about the name of the Statement:</p>

  <ol class="calibre12">
    <li class="calibre13">It describes a behavior of an instance of a specified class. Note that it does not contain method name that triggers the behavior, because what is specified is not a method, but the behavior itself. The name simply tells that what an instance does (“notifies listeners that server is unavailable”) under certain circumstances (“when cannot connect to its monitoring port”). It is important because such description is what you can derive from thinking about responsibilities of a class, so you do not need to know any of its method signature or the code that is inside of the class. Hence, this is something you can come up with before implementing - you just need to know why you created this class and build on this knowledge.</li>

    <li class="calibre13">
      <p class="calibre2">The name is relatively long. Really, really, <strong class="calibre14">really</strong> do not worry about it. As long as you are describing a single behavior, it is alright. I know usually people are hesitant to give long names to the Statements, because they try to apply the same rules to those names as to method names in production code (and in production code too long method name can be a sign of it having too many responsibilities). Let me make it clear - these two cases are different. In case of Statements, methods are not invoked by anyone besides the automatic runner applications, so they will not obfuscate any code that would need to call them with their long names. Sure, we could put all the information in the comment instead of Statement name and leave the name short, like this:</p>
      <pre class="calibre10">[Fact]
//Notifies listeners that server 
//is unavailable when cannot connect
//to its monitoring port
public void Statement_002()
{
 //...
}
</pre>

      <p class="calibre2">There are two downsides to this solution: one is that we now have to put extra information (<code class="calibre11">Statement_002</code>) which is required only by compiler, because every method needs to have a name - there is usually no value a human could derive from such a name. The second downside is that when the Statement is evaluated to false, the automated runner shows you the following line: <code class="calibre11">Statement_002: FAILED</code> - note that all the information included in the comment isn’t present in the failure report. It is really better to receive a report such as:</p>

      <p class="calibre2"><code class="calibre11">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort: FAILED</code></p>

      <p class="calibre2">because then a lot of information about the Statement that fails is available from the runner window.</p>
    </li>

    <li class="calibre13">Using a name that describes a (single) behavior allows you to track quickly why the Statement is false when it is. Suppose a Statement is true when you start refactoring, but at one point it starts being evaluated as false and the report in the runner looks like this: <code class="calibre11">TrySendingHttpRequest: FAILED</code> - it does not really tell you anything more than that an attempt is made to send a HTTP request, but, for instance, does not tell you whether your specified object is the sender (that should try to send this request under some circumstances) or the receiver (that should handle such request properly). To actually know what went wrong, you have to go Statement body and scan its source code. Now compare it to the following name: <code class="calibre11">ShouldRespondWithAnAckWheneverItReceivesAHttpRequest</code>. Now when it evaluates to false, you can tell what is broken - the object no longer responds with an ACK to HTTP request. Sometimes this is enough to identify which part of the code is in fault of this evaluation failure.</li>
  </ol>

  <h3 class="sigilnotintoc">My favourite convention</h3>

  <p class="calibre2">There are many conventions for naming Statements appropriately. My favorite is the one developed by Dan North, which makes each Statement name begin with the word <code class="calibre11">Should</code>. So for example, I would name a Statement:</p>

  <p class="calibre2"><code class="calibre11">ShouldReportAllErrorsSortedAlphabeticallyWhenItEncountersErrorsDuringSearch()</code></p>

  <p class="calibre2">The name of the Specification (i.e. class name) answers the question “who should do it?”, i.e. when I have a class named <code class="calibre11">SortingOperation</code> and want to say that it “should sort all items in ascending order when performed”, I say it like this:</p>
  <pre class="calibre10">public class SortingOperationSpecification
{
 [Fact] public void
 ShouldSortAllItemsInAscendingOrderWhenPerformed()
 {
 }
}
</pre>

  <p class="calibre2">The “should” word was introduced by Dan to weaken the statement following it and thus, to allow questioning what you are stating and ask yourself the question: “should it really?”. If this causes uncertainty, then it is high time to talk to a domain expert and make sure you understand well what you need to accomplish. If you are not a native English speaker, the “should” prefix will probably have a weaker influence on you - that is why I do not insist on you using it. I like it though.</p>

  <p class="calibre2">When inventing a name, It is important to put the main focus on what result or action is expected from an object. If you do not, you quickly find it troublesome. As an example, one of my colleagues was specifying a class <code class="calibre11">UserId</code> and wrote the following name for the Statement about comparison of two identifiers:</p>

  <p class="calibre2"><code class="calibre11">EqualOperationShouldPassForTwoInstancesWithTheSameUserName()</code>.</p>

  <p class="calibre2">Note that this is not from the perspective of a single object, but rather from the perspective of an operation that is executed on it, which means that we stopped thinking in terms of object responsibilities and started thinking in terms of operation correctness, which is farther away from our assumption that we are writing a Specification consisting o Statements. This name should be something more like:</p>

  <p class="calibre2"><code class="calibre11">ShouldReportThatItIsEqualToAnotherIdThatHasTheSameUserName()</code>.</p>

  <h2 id="calibre_link-58" class="calibre5">Start By Filling The GIVEN-WHEN-THEN Structure With The Obvious<br class="calibre26" /></h2>

  <p class="calibre2">This is a technique that is applicable when you come up with a GIVEN-WHEN-THEN structure for the Statement or a good name for it (GIVEN-WHEN-THEN structure can be easily derived from a good name and vice versa). Anyway, this technique is about taking the GIVEN, WHEN and THEN parts and translating them into code in almost literal, brute-force way, then add all the missing pieces that are required for the code to compile and run.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Let us take a simple example of comparing two users. We assume that a user should be equal to another when it has the same name as the other one:</p>
  <pre class="calibre27">GIVEN a user with any name
WHEN I compare it to another user with the same name
THEN it should appear equal to this other user
</pre>

  <p class="calibre2">Let us start with the translation</p>

  <p class="calibre2">The first line:</p>
  <pre class="calibre27">GIVEN a user with any name</pre>

  <p class="calibre2">can be translated literally to code like this:</p>
  <pre class="calibre10">var user = new User(anyName);</pre>

  <p class="calibre2">Then the second line:</p>
  <pre class="calibre27">WHEN I compare it to another user with the same name</pre>

  <p class="calibre2">can be written as:</p>
  <pre class="calibre10">user.Equals(anotherUserWithTheSameName);</pre>

  <p class="calibre2">Great! Now the last line:</p>
  <pre class="calibre27">THEN it should appear equal to this other user</pre>

  <p class="calibre2">and its translation into the code:</p>
  <pre class="calibre10">Assert.True(areUsersEqual);</pre>

  <p class="calibre2">Ok, so we have made the translation, now let us summarize this and see what is missing to make this code compile:</p>
  <pre class="calibre10">[Fact] public void 
ShouldAppearEqualToAnotherUserWithTheSameName()
{
  //GIVEN
  var user = new User(anyName);

  //WHEN
  user.Equals(anotherUserWithTheSameName);

  //THEN
  Assert.True(areUsersEqual);
}
</pre>

  <p class="calibre2">As we expected, this will not compile. Notably, our compiler might point us towards the following gaps:</p>

  <ol class="calibre12">
    <li class="calibre13">A declaration of <code class="calibre11">anyName</code> variable.</li>

    <li class="calibre13">A declaration of <code class="calibre11">anotherUserWithTheSameName</code> object.</li>

    <li class="calibre13">The variable <code class="calibre11">areUsersEqual</code> is both not declared and it does not hold the comparison result.</li>

    <li class="calibre13">If this is our first Statement, we might not even have the <code class="calibre11">User</code> class defined at all.</li>
  </ol>

  <p class="calibre2">The compiler created a kind of a small TODO list for us, which is nice. Note that, while we do not have full compiling code, filling the gaps boils down to making a few trivial declarations and assignments:</p>

  <ol class="calibre12">
    <li class="calibre13">
      <code class="calibre11">anyName</code> can be declared as

      <p class="calibre2"><code class="calibre11">var anyName = Any.String();</code></p>
    </li>

    <li class="calibre13">
      <code class="calibre11">anotherUserWithTheSameName</code> can be declared as

      <p class="calibre2"><code class="calibre11">var anotherUserWithTheSameName = new User(anyName);</code></p>
    </li>

    <li class="calibre13">
      <code class="calibre11">areUsersEqual</code> can be declared and assigned this way:

      <p class="calibre2"><code class="calibre11">var areUsersEqual = user.Equals(anotherUserWithTheSameName);</code></p>
    </li>

    <li class="calibre13">If <code class="calibre11">User</code> class does not exist, we can add it by simply stating:

      <p class="calibre2"><code class="calibre11">public class User {}</code></p>
    </li>
  </ol>

  <p class="calibre2">Putting it all together:</p>
  <pre class="calibre10">[Fact] public void 
ShouldAppearEqualToAnotherUserWithTheSameName()
{
  //GIVEN
  var anyName = Any.String();
  var user = new User(anyName);
  var anotherUserWithTheSameName = new User(anyName);

  //WHEN
  var areUsersEqual = user.Equals(anotherUserWithTheSameName);

  //THEN
  Assert.True(areUsersEqual);
}
</pre>

  <p class="calibre2">And that is it - the Statement is complete!</p>

  <h2 id="calibre_link-59" class="calibre5">Start From The End</h2>

  <p class="calibre2">This is a technique that I suggest to people that seem to have absolutely no idea how to start. I got it from Kent Beck’s book Test Driven Development by Example. It seems funny at start, but is quite powerful. The trick is to write the Statement ‘backwards’, i.e. starting with what the Statement asserts to be true (in terms of the GIVEN-WHEN-THEN structure, we would say that we start with our THEN).</p>

  <p class="calibre2">This works because, while we are many times quite sure of our goal (i.e. what the outcome of the behavior should be), but are unsure of how to get there.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Imagine we are writing a class for granting access to a reporting functionality based on roles. We do not have any idea what the API should look like and how to write our Statement, but we know one thing: in our domain the access can be either granted or denied. Let us take the successful case (just because it is the first one we can think of) and, starting backwards, start with the following assertion:</p>
  <pre class="calibre10">//THEN
Assert.True(accessGranted);</pre>

  <p class="calibre2">Ok, that part was easy, but did we make any progress with that? Of course we did - we now have a non-compiling code and the compilation error is because of the <code class="calibre11">accessGranted</code> variable. Now, in contrast to the previous approach (with translating our GIVEN-WHEN-THEN structure into a Statement), our goal is not to make this compile as soon as possible. The goal is to answer ourselves a question: how do I know whether the access is granted or not? The answer: it is the result of authorization of the allowed role. Ok, so let us just write it down, ignoring everything that stands in our way (I know that most of us have a habit to add a class or a variable as soon as we find out that we need it. If you are like that, then please turn off this habit while writing Statements - it will only throw you off the track and steal your focus from what is important. The key to doing TDD successfully is to learn to use something that does not exist yet like it existed):</p>
  <pre class="calibre10">//WHEN
var accessGranted 
 = authorization.IsAccessToReportingGrantedTo(
  roleAllowedToUseReporting);
</pre>

  <p class="calibre2">Note that we do not know what <code class="calibre11">roleAllowedToUseReporting</code> is, neither do we know what is <code class="calibre11">authorization</code>, but that did not stop us from writing this line. Also, the <code class="calibre11">IsAccessToReportingGrantedTo()</code> method is just taken from the top of our head. It is not defined anywhere, it just made sense to write it like this, because it is the most direct translation of what we had in mind.</p>

  <p class="calibre2">Anyway, this new line answers the question on where do we take the <code class="calibre11">accessGranted</code> from, but makes us ask further questions:</p>

  <ol class="calibre12">
    <li class="calibre13">Where does the <code class="calibre11">authorization</code> variable come from?</li>

    <li class="calibre13">Where does the <code class="calibre11">roleAllowedToUseReporting</code> variable come from?</li>
  </ol>

  <p class="calibre2">As for <code class="calibre11">authorization</code>, we do not have anything specific to say about it other than that it is an object of a class that we do not have yet. In order to proceed, let us pretend that we have such a class. How do we call it? The instance name is <code class="calibre11">authorization</code>, so it is quite straightforward to name the class <code class="calibre11">Authorization</code> and instantiate it in the simplest way we can think of:</p>
  <pre class="calibre10">//GIVEN
var authorization = new Authorization();
</pre>

  <p class="calibre2">Now for the <code class="calibre11">roleAllowedToUseReporting</code>. The first question that comes to mind when looking at this is: which roles are allowed to use reporting? Let us assume that in our domain, this is either an Administrator or an Auditor. Thus, we know what is going to be the value of this variable. As for the type, there are various ways we can model a role, but the most obvious one for a type that has few possible values is an enum. So:</p>
  <pre class="calibre10">//GIVEN
var roleAllowedToUseReporting = Any.Of(Roles.Admin, Roles.Auditor);
</pre>

  <p class="calibre2">And so, working our way backwards, we have arrived at the final solution (we still need to give this Statement a name, but, provided what we already know, this is an easy task):</p>
  <pre class="calibre10">[Fact] public void
ShouldAllowAccessToReportingWhenAskedForEitherAdministratorOrAuditor()
{
 //GIVEN
 var roleAllowedToUseReporting = Any.Of(Roles.Admin, Roles.Auditor);
 var authorization = new Authorization();

 //WHEN
 var accessGranted = authorization
  .IsAccessToReportingGrantedTo(roleAllowedToUseReporting);

 //THEN
 Assert.True(accessGranted);
}</pre>

  <h2 id="calibre_link-60" class="calibre5">Start By Invoking a Method When You Have One</h2>

  <p class="calibre2">Sometimes, we have to add a new class that implements an existing interface required by another class. The fact of implementing an interface imposes what methods should the new class support. If this point is already decided, we can start our Statement by first calling the method and then discovering what we need to supply.</p>

  <h3 class="sigilnotintoc">A Simple Example</h3>

  <p class="calibre2">Suppose we have an application holding a lot of data that, among other things, handles importing am existing database from another instance of the application. As importing a database can be a lengthy process, a message box is displayed each time when user chooses to perform the import and this message box displays the following message: “Johnny, please sit down and enjoy your coffee for a few minutes as we take time to import your database” (given user name is Johnny). The class that implements it looks like this:</p>
  <pre class="calibre10">public class FriendlyMessages
{
 public string 
 HoldOnASecondWhileWeImportYourDatabase(string userName)
 {
   return string.Format("{0}, "
     + "please sit down and enjoy your coffee "
     + "for a few minutes as we take time "
     + "to import your database",
     userName);
 }
}</pre>

  <p class="calibre2">Now, imagine that our management told us that they need to ship a trial version with some features disabled, including importing an existing database. Among all the things we need to do to make it happen, we also need to display a different string with message saying that this is a trial version and the feature is locked. We can do it by extracting an interface from the <code class="calibre11">FriendlyMessages</code> class and using it to put in an instance of another class implementing this interface when the application discovers that it is being run as a trial version. The extracted interface looks like this:</p>
  <pre class="calibre10">public interface Messages
{
  string HoldOnASecondWhileWeImportYourDatabase(string userName);
}</pre>

  <p class="calibre2">So our new implementation is forced to support the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> method. Thus, we when implementing the class, we start with the following:</p>
  <pre class="calibre10">public class TrialVersionMessages : Messages
{
 public string HoldOnASecondWhileWeImportYourDatabase(string userName)
 {
   throw new NotImplementedException();
 }
}</pre>

  <p class="calibre2">Now, we are ready to start writing a Statement. Assuming we do not know where to start, we just start with creating an object and invoking the method that needs to be implemented:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 
 //WHEN
 trialMessages.HoldOnASecondWhileWeImportYourDatabase();

 //THEN
 Assert.True(false); //to remember about it
}</pre>

  <p class="calibre2">As you can see, we added an assertion that always fails at the end because we do not have any assertions yet and the Statement would otherwise be already evaluated as true and we would rather have it remind ourselves that it is not finished. Other than this, the Statement does not compile anyway, because the method <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> takes a string argument and we passed none. This makes us ask the question what is this argument and what is its role in the behavior triggered by the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> method. Seems like it is a user name and we want it to be somewhere in the result of the method. Thus, we can add it to the Statement like this:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 var userName = Any.String();
 
 //WHEN
 trialMessages.
  HoldOnASecondWhileWeImportYourDatabase(userName);

 //THEN
 Assert.True(false); //to remember about it
}</pre>

  <p class="calibre2">Now, this compiles but is evaluated as false because of the guard assertion that we put at the end. Our goal is to substitute it with a real assertion for a real expected result. The return value of the <code class="calibre11">HoldOnASecondWhileWeImportYourDatabase</code> is a string message, so all we need to do is to come up with the message that we expect in case of trial version:</p>
  <pre class="calibre10">[Fact] 
public void TODO()
{
 //GIVEN
 var trialMessages = new TrialVersionMessages();
 var userName = Any.String();
 
 //WHEN
 var message = trialMessages.
  HoldOnASecondWhileWeImportYourDatabase(userName);

 //THEN
 var expectedMessage = 
  string.Format("{0}, better get some pocket money!", userName);

 Assert.Equal(expectedMessage, message);
}
</pre>

  <p class="calibre2">and all that is left is to find a good name for the Statement. This isn’t an issue since we already specified the desired behavior in the code, so we can just summarize it as something like <code class="calibre11">ShouldYieldAMessageSayingThatFeatureIsLockedWhenAskedForImportDatabaseMessage</code>.</p>

  <h2 id="calibre_link-61" class="calibre5">Summary</h2>

  <p class="calibre2">These few techniques can be useful when you are stuck and do not know how to start. Note that the examples given are simplistic and assume that there is one object that takes some kind of input parameter and returns a well defined result. This is not how most of the object-oriented world is built. In object oriented world, we have a lot of objects communicating with other objects, sending messages, invoking methods on each other and often having no return values. Do not worry, all of these techniques work in this concept and we’ll be revisiting them as soon as we learn how to do TDD in fully object-oriented world (that is, after we introduce a concept of mock objects). For now, I’m trying to keep it simple.</p>
</div>


<div class="calibre4" id="calibre_link-37">
  <h1 class="calibre1">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</h1>

  <h2 id="calibre_link-62" class="calibre5">Is there really a commonality between analysis and TDD?</h2>

  <p class="calibre2">From Wikipedia:</p>

  <blockquote cite="https://en.wikipedia.org/wiki/Analysis" class="calibre18">
    Analysis is the process of breaking a complex topic or substance into smaller parts to gain a better understanding of it.
  </blockquote>

  <p class="calibre2">Thus, in order for TDD to be about analysis, it has to fulfill two conditions:</p>

  <ol class="calibre12">
    <li class="calibre13">Be a process of breaking a complex topic into smaller parts</li>

    <li class="calibre13">Allow gaining a better understanding of such broken topics</li>
  </ol>

  <p class="calibre2">In the story about Johnny, Benjamin and Jane, I included a part where they analyze requirements using concrete examples. Johnny explained that this is a part of a technique called Acceptance Test-Driven Development. The process followed by the three characters fulfilled both mentioned conditions for a process to be analytical. But what about TDD itself?</p>

  <p class="calibre2">Actually, I used parts of ATDD process in the story to make the analysis part more obvious, but similar things happen at pure technical levels. For example, when starting development with a failing application-wide Statement (we will talk about levels of granularity of Statements later. For now the only thing you need to know is that the so called “unit tests level” is not the only level of granularity we write Statements on), we may encounter a situation where we need to call a web method and assert its result. This makes us think: what should this method be called? What are the scenarios supported? What do I need to get out of it? How should its user be notified about errors? Many times, this leads us to either a conversation (if there is another stakeholder that needs to be involved in the decision) or rethinking our assumptions. This is how we gain a better understanding of the topic we are analyzing, which makes TDD fulfill the first of the two requirements for it to be an analysis method.</p>

  <p class="calibre2">But what about the first requirement? What about breaking a complex logic into smaller parts?</p>

  <p class="calibre2">If you go back to our example, you will note that both when talking to a customer and when writing code, Johnny and Benjamin used a TODO list. This list was first filled with whatever scenarios they came up with, but later, they would add a smaller unit of work. This is one way complex topics are decomposed into smaller items that all land on the TODO list (the other way is mocking, but we will not get into that yet). Thanks to this, we can focus on one thing at a time, crossing off item after item from the list after it is done. If we learn something new or encounter new issue that needs our attention, we can add it to the TODO list and get back to it later, for now continuing our work on the current point of focus.</p>

  <p class="calibre2">An example TODO list from the middle of implementation may look like this (do not read trough it, I put it here only to give you a glimpse):</p>

  <ol class="calibre28">
    <li class="calibre13">
      <del class="calibre29">Create entry point to the module (top-level abstraction)</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement main workflow of the module</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement Message interface</del>
    </li>

    <li class="calibre13">
      <del class="calibre29">Implement MessageFactory interface</del>
    </li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13">
      <del class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</del>
    </li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Age field</li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
  </ol>

  <p class="calibre2">Note that some items are already crossed out as done, while other remain undone and waiting to be addressed.</p>

  <p class="calibre2">Ok, that is it for the discussion. Now that we are sure that TDD is about analysis, let us focus on the tools can use to aid and inform it. You already saw both of them in this book, now we are going to have a closer look.</p>

  <h2 id="calibre_link-63" class="calibre5">Gherkin</h2>

  <p class="calibre2">Hungry? Too bad, because the Gkerkin I am gonna talk about is not edible. It is a notation and a way of thinking about behaviors of the specified piece of code. It can be applied on different levels of granularity - any behavior, whether of a whole system or a single class, may be described using it.</p>

  <p class="calibre2">We actually talked about Gherkin before in this book, just did not name it. It is the GIVEN-WHEN-THEN structure that you can see everywhere, even in code samples as comments. This time, we are stamping a name on it and analyzing it further.</p>

  <p class="calibre2">In Gherkin, a behavior description consists of three parts:</p>

  <ol class="calibre12">
    <li class="calibre13">Given - a context</li>

    <li class="calibre13">When - a cause</li>

    <li class="calibre13">Then - a effect</li>
  </ol>

  <p class="calibre2">In other words, the emphasis is on causality in a given context.</p>

  <p class="calibre2">As I said, there are different levels you can apply this. Here is an example for such a behavior description from the perspective of its end user (this is called acceptance-level Statement):</p>
  <pre class="calibre10">Given a bag of tea costs $20
When I buy two of them
Then I pay 30$ due to promotion</pre>

  <p class="calibre2">And here is one for unit-level (note the line starting with “And” that adds to the context):</p>
  <pre class="calibre10">Given a list with 2 items
When I add another item
And check count of items
Then the count should be 3</pre>

  <p class="calibre2">While on acceptance level we put such behavior descriptions together with code as the same artifact (If this does not ring a bell, look at tools like SpecFlow or Cucumber or FIT to get some examples), on the unit level the description is usually not written down literally, but in form of code only. Still, this structure is useful when thinking about behaviors required from an object or objects, as we saw when we talked about starting from Statement rather than code. I like to put the structure explicitly in my Statements - I find that it makes them more readable. So most of my unit-level Statements follow this template:</p>
  <pre class="calibre10">[Fact]
public void Should__BEHAVIOR__()
{
  //GIVEN
  ...context…

  //WHEN
  ...trigger…

  //THEN
  ...assertions etc….
}
</pre>

  <p class="calibre2">Sometimes the WHEN and THEN sections are not so easily separable - then I join them, like in case of the following Statement specifying that an object throws an exception when asked to store null:</p>
  <pre class="calibre10">[Fact]
public void ShouldThrowExceptionWhenAskedToStoreNull()
{
  //GIVEN
  var safeList = new SafeList();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; safeList.Store(null)
  );
}
</pre>

  <p class="calibre2">By thinking in terms of these three parts of behavior, we may arrive at different circumstances (GIVEN) at which the behavior takes place, or additional ones that are needed. The same goes for triggers (WHEN) and effects (THEN). If anything like this comes to our mind, we add it to the TODO list.</p>

  <h2 id="calibre_link-64" class="calibre5">TODO list… again!</h2>

  <p class="calibre2">As we said previously, a TODO list is a repository for anything that comes to our mind when writing or thinking about a Statement, but is not a part o the current Statement we are writing. We do not want to forget it, neither do we want it to haunt us and distract us from our current task, so we write it down as soon as possible and continue with our current task.</p>

  <p class="calibre2">Suppose you are writing a piece of small logic that allows user access when he is an employee of a zoo, but denies access if he is a guest of the zoo. Then, after starting writing a Statement it gets to you that actually any employee can be a guest as well - for example, he might choose to visit the zoo with his family during his vacation. Still, the two previous rules hold, so not to allow this case to distract you, you quickly add an item to the TODO list (like “TODO: what if someone is an employee, but comes to the zoo as a guest?”) and finish the current Statement. When you are finished, you can always come back to the list and pick item to do next.</p>

  <p class="calibre2">There are two important questions related to TODO lists: “what exactly should we add as a TODO list item?” and “How to efficiently manage the TODO list?”. We will take care of these two questions now.</p>

  <h3 class="sigilnotintoc">What to put on the TODO list?</h3>

  <p class="calibre2">Everything that you need addressed but is not part of the current Statement. Those items may be related to implementing unimplemented methods, to add whole functionalities (such items are usually followed my more fine-grained sub tasks as soon as you start implementing the item), there might be reminders to take a better look at something (e.g. “investigate what is this component’s policy for logging errors”) or questions about the domain that need to get answered. If you get carried away too much in coding that you forget to eat, you can even add a reminder (“TODO: get something to eat!”). The list is yours!</p>

  <h3 class="sigilnotintoc">How to pick items from TODO list?</h3>

  <p class="calibre2">Which item to choose from the TODO list when you have several? I have no clear rule, although I tend to take into account the following factors:</p>

  <ol class="calibre12">
    <li class="calibre13">Risk - if what I learn by implementing or discussing a particular item from the list can have big impact on design or behavior of the system, I tend to pick such items first. An example of such item is that you start implementing validation of a request that arrives to your application and want to return different error depending on which part of the request is wrong. Then, during the development, you discover that more than one part of the request can be wrong at a time and you have to answer yourself a question: which error code should be returned in such case? Or maybe the return codes should be accumulated for all validations and then returned as a list?</li>

    <li class="calibre13">Difficulty - depending on my mental condition (how tired I am, how much noise is currently around my desk etc.), I tend to pick items with difficulty that best matches this condition. For example, after finishing an item that requires a lot of thinking and figuring out things, I tend to take on some small and easy items to feel wind blowing in my sails and to rest a little bit.</li>

    <li class="calibre13">Completeness - in simplest words, when I finish test-driving an “if” case, I usually pick up the “else” next. For example, after I finish implementing a Statement saying that something should return true for values less than 50, then the next item to pick up is the “greater or equal to 50” case. Usually, when I start test-driving a class, I take items related to this class until I run out of them, then go on to another one.</li>
  </ol>

  <h3 class="sigilnotintoc">Where to put a TODO list?</h3>

  <p class="calibre2">There are two ways of maintaining a TODO list. The first one is on a sheet of paper, which is nice, but requires you to take your hands off the keyboard, grab a pen or pencil and then get back to coding every time you think of something. Also, the only way a TODO item written on a sheet of paper can tell you which place in code it is related to, is (obviously) by its text.</p>

  <p class="calibre2">Another alternative is to use a TODO list functionality built-in into an IDE. Most IDEs, such as Visual Studio (and Resharper plugin has its own enhanced version), Xamarin Studio or eclipse-based IDEs have such functionality. The rules are simple - you put special comments in the code and a special view in your IDE aggregates them for you, allowing you to navigate to each. Such lists are great because:</p>

  <ol class="calibre12">
    <li class="calibre13">They do not force you to take your hands off keyboard to add an item to the list.</li>

    <li class="calibre13">You can put such item in a certain place in the code where is makes sense and then navigate back to it with a click of a mouse. This, apart from other advantages, lets you write shorter notes than if you had to do it on paper. For example, a TODO item saying “TODO: what if it throws an exception?” looks out of place on the paper, but when added as a comment to your code in the right place, it is mighty sufficient.</li>

    <li class="calibre13">Many TODO lists automatically add items for certain things. E.g. in C#, when you are yet to implement a method that was automatically generated by a tool, its body usually consists of a line that throws a <code class="calibre11">NotImplementedException</code> exception. Guess what - <code class="calibre11">NotImplementedException</code> occurences are added to the TODO list automatically, so we do not have to manually add items to the TODO list for implementing the methods where they occur.</li>
  </ol>

  <h3 class="sigilnotintoc">Expanded TDD process with a TODO list</h3>

  <p class="calibre2">In one of the previous chapters, I introduced you to the basic TDD process that contained three steps: write unfulfilled Statement, fulfill it and refactor the code. TODO list adds new steps to this process leading to the following list of steps:</p>

  <ol class="calibre12">
    <li class="calibre13">Examine TODO list and pick an item that makes most sense to implement next</li>

    <li class="calibre13">Write unfulfilled Statement</li>

    <li class="calibre13">Make it unfulfilled for the right reason</li>

    <li class="calibre13">Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>

    <li class="calibre13">Cross out the item from TODO list</li>

    <li class="calibre13">Repeat until no item is left on the TODO list</li>
  </ol>

  <p class="calibre2">Of course, we are free to add new items to the TODO list as we make progress with the existing ones and at the beginning of each cycle the list is re-evaluated to choose the most important item to implement next taking into account what was added during the previous cycle.</p>

  <h3 class="sigilnotintoc">Potential downsides</h3>

  <p class="calibre2">There are also some downsides. The biggest is that people often add TODO items for other means than to support TDD and they never go back to such items. Some people joke that a TODO left in the code means “Once, I wanted to…”. Anyway, such items may pollute your TDD-related TODO list with so much cruft that your own items are barely findable. To work around it, I tend to use a different tag than TODO (many IDEs let you define your own tags, or support multiple tag types out of the box. E.g. with Resharper, I like to use “bug” tag, because this is something no one would leave in the code) and filter by it. Another options is, of course, getting rid of the leftover TODO items - if no one addressed it for a year, then probably no one ever will.</p>

  <p class="calibre2">Another downside is that when you work with multiple workspaces/solutions, your IDE will gather TODO items only from current solution/workspace, so you will have few TODO lists - one per workspace or solution. Fortunately, this isn’t usually a big deal.</p>
</div>


<div class="calibre4" id="calibre_link-14">
  <h1 class="calibre1">Developing TDD style and Constrained Non-Determinism</h1>

  <p class="calibre2">In one of the first chapters, I introduced to you the idea of anonymous values generator idea, which I have wrapped in a static class called <code class="calibre11">Any</code>. Throughout the next chapters, you have seen me using it quite extensively in many of the Statements I wrote.</p>

  <p class="calibre2">The time has come to explain a little bit more carefully what principles lie under this technique and tool. I will also use this technique as a case study to show you how one develops a style of Test-Driven Development.</p>

  <h2 id="calibre_link-65" class="calibre5">A style?</h2>

  <p class="calibre2">Yep. Why am I wasting your time writing about style instead of giving you the hardcore technical details? The answer is simple. Before I started writing this tutorial, I read four or five books solely on TDD and maybe two others that contain chapters on TDD. All of this sums up to about two or three thousands of paper pages, plus numerous posts on many blogs. And you know what I noticed? No two authors use exactly the same sets of techniques for test-driving their code! I mean, sometimes, when you look techniques they are suggesting, the suggestions from two authorities contradict each other. As each authority has their followers, it is not uncommon to observe and take part in discussions about whether this or that technique is better than a competing one or which one leads to trouble in the long run.</p>

  <p class="calibre2">I did this, too. I also tried to understand how come people praise techniques I KNEW were wrong and led to disaster. Then, Finally, I got it. I understood that it is not a “technique A vs. technique B” debate. There are certain sets of techniques that work together and choosing one technique leaves us with issues we have to resolve by adopting other techniques. This is how a style is created.</p>

  <p class="calibre2">Developing a style starts with underlying set of principles. These principles lead us to adopt our first technique, which makes us adopt another one and, ultimately, a coherent style emerges. Using Constrained Non-Determinism as an example, I will try to show you how part of a style gets derived from a technique that is derived from a principle.</p>

  <h2 id="calibre_link-66" class="calibre5">Principle: Tests As Specification</h2>

  <p class="calibre2">As I already stressed, I strongly believe that unit tests constitute an executable specification. Thus, they should not only pass input values to an object and assert on the output, they should also convey to their reader the rules according to which objects and functions work. The following oversimplified example shows a Statement where it is not explicitly stated what is the relationship between input and output:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo("MY_HOST_NAME");
  
  //THEN
  Assert.Equal("backup_MY_HOST_NAME.zip");
}</pre>

  <p class="calibre2">Although the relationship can be guessed quite easily, remember it is just an example. Also, seeing code like that makes me ask questions like: is the “backup_” prefix always applied? What if I actually pass “backup_” instead of “MY_HOST_NAME”? Will the name be “backup_backup_.zip”, or “backup_.zip”? Also, is this object responsible for any validation of passed string?</p>

  <p class="calibre2">This makes me invent a first technique to provide my Statements with better support for the principle I believe in.</p>

  <h2 id="calibre_link-67" class="calibre5">First technique: Anonymous Input</h2>

  <p class="calibre2">I can wrap the actual value “MY_HOST_NAME” with a method and give it a name that better documents the constraints imposed on it by the specified functionality. In our case, we can pass whatever string we want (the object is not responsible for input validation), so we will name our method <code class="calibre11">AnyString()</code>:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var hostName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName);
  
  //THEN
  Assert.Equal("backup_MY_HOST_NAME.zip");
}

public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">By using <strong class="calibre14">anonymous input</strong>, we provide a better documentation of the input value. Here, I wrote <code class="calibre11">AnyString()</code>, but of course, there can be a situation where I use more constrained data, e.g. <code class="calibre11">AnyAlphaNumericString()</code> when I need a string that does not contain any characters other than letters and digits. Note that this technique <strong class="calibre14">is applicable only when the particular value of the variable is not important, but rather its “trait”</strong>. Taking authorization as an example, when a certain behavior occurs only when the input value is <code class="calibre11">Users.Admin</code>, there is <strong class="calibre14">no sense</strong> making it anonymous. On the other hand, for a behavior that occurs for all values other than <code class="calibre11">Users.Admin</code>, it makes sense to use a method like <code class="calibre11">AnyUserOtherThan(Users.Admin)</code> or even <code class="calibre11">AnyNonAdminUser()</code>.</p>

  <p class="calibre2">Now that the Statement itself is freed from the knowledge of the concrete value of <code class="calibre11">hostName</code> variable, the concrete value of “backup_MY_HOST_NAME.zip” looks kinda weird. There is no clear indication of the kind of relationship between input and output and whether there is any at all (one may reason whether the output is always the same string or maybe it depends on the string length). It is unclear which part is added by the production code and which part depends on the input we pass to the method. This leads us to another technique.</p>

  <h2 id="calibre_link-68" class="calibre5">Second Technique: Derived Values</h2>

  <p class="calibre2">To better document the relationship between input and output, we have to simply derive the expected value we assert on from the input value. Here is the same Statement with the assertion changed:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostName()
{
  //GIVEN
  var hostName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName);
  
  //THEN
  Assert.Equal(string.Format("backup_{0}.zip", hostName);
}
public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">This looks more like a part of specification, because we are documenting the format of the backup file name and show which part of the format is variable and which part is fixed. This is something you would probably find documented in a paper specification for the application you are writing - it would probably contain a sentence saying: “The format of a backup file should be <strong class="calibre14">backup_H.zip</strong>, where <strong class="calibre14">H</strong> is the current local host name”.</p>

  <p class="calibre2"><strong class="calibre14">Derived values</strong> are about defining expected output in terms of the input that was passed to provide a clear indication on what is the “transformation” of the input required of the specified production code.</p>

  <h2 id="calibre_link-69" class="calibre5">Third technique: Distinct Generated Values</h2>

  <p class="calibre2">Let us assume that some time after our initial version is shipped, we are asked to make the backup feature applied locally per user only for this user’s data. As the customer does not want to confuse files from different users, we are asked to add name of the user doing backup to the backup file name. Thus, the new format is “backup_H_U.zip”, where H is still the host name and U is the user name. Our Statement for the pattern must change as well to include this information. Of course, we are trying to use the anonymous input again as a proven technique and we end up with:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return "MY_HOST_NAME";
}</pre>

  <p class="calibre2">Now, we can clearly see that there is something wrong with this Statement. AnyString() is used twice and each time it returns the same value, which means that evaluating the Statement does not give us any guarantee, that both values are applied and that they are applied in the correct places. For example, the Statement will be evaluated to true when user name is used instead of host name in specified production code. This means that if we still want to use the anonymous input effectively, we have to make the two values distinct, e.g. like this:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString2();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return "MY_HOST_NAME";
}

public string AnyString2()
{
  return "MY_USER_NAME";
}</pre>

  <p class="calibre2">We solved the problem (for now) by introducing another helper method. However, this, as you can see, is not a very scalable solution. Thus, let us try to reduce the amount of helper methods for string generation to one and make it return a different value each time:</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserName()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}.zip", hostName, userName);
}

public string AnyString()
{
  return Guid.NewGuid.ToString();
}</pre>

  <p class="calibre2">This time, we are not returning an understandable string, but rather a guid, which gives us the fairly strong guarantee of generating distinct value each time. The string not being understandable (contrary to something like “MY_HOST_NAME”) may leave you worried that maybe we are losing something, but hey, didn’t we say <strong class="calibre14">Any</strong>String()?</p>

  <p class="calibre2"><strong class="calibre14">Distinct generated values</strong> means that each time we need a value of a particular type, we get something different (if possible) than the last time and each value is generated automatically using some kind of heuristics.</p>

  <h2 id="calibre_link-70" class="calibre5">Fourth technique: Constant Specification</h2>

  <p class="calibre2">Let us consider another modification that we are requested to make - this time, the backup file name needs to contain version number of our application as well. Remembering that we want to use Derived Values, we will not hardcode the version number into our Statement. Instead, we are going to use a constant that is already defined somewhere else in the application (this way we also avoid duplication of this version number across the application):</p>
  <pre class="calibre10">[Fact] public void 
ShouldCreateBackupFileNameContainingPassedHostNameAndUserNameAndVersion()
{
  //GIVEN
  var hostName = AnyString();
  var userName = AnyString();
  var fileNamePattern = new BackupFileNamePattern();
  
  //WHEN
  var name = fileNamePattern.ApplyTo(hostName, userName);
  
  //THEN
  Assert.Equal(string.Format(
    "backup_{0}_{1}_{2}.zip", 
    hostName, userName, Version.Number);
}

public string AnyString()
{
  return Guid.NewGuid.ToString();
}</pre>

  <p class="calibre2">Note that I didn’t use the literal constant value, but rather, the value inside the <code class="calibre11">Version.Number</code> constant. This allows us to use derived value, but leaves us a little worried about whether the value of the constant is correct - after all, we are using it for creation of our expected value, but it is a part of production code - i.e. is something that should be specified itself!</p>

  <p class="calibre2">To keep everyone happy, we write a single Statement just for the constant to specify what the value should be:</p>
  <pre class="calibre10">[Fact] public void 
ShouldContainNumberEqualTo1_0()
{
  Assert.Equal("1.0", Version.Number);
}</pre>

  <p class="calibre2">By doing so, we make the value in the production code just echo what is in our executable Specification, which we can fully trust.</p>

  <h2 id="calibre_link-71" class="calibre5">Summary of the example</h2>

  <p class="calibre2">In this example, I tried to show you how a style can evolve from the principles you value when doing TDD. I did so for two reasons:</p>

  <ol class="calibre12">
    <li class="calibre13">To introduce to you a set of techniques I personally use and recommend and to do it in a fluent and logical way.</li>

    <li class="calibre13">To help you better communicate with people that are using different styles. Instead of just throwing “you are doing it wrong” at them, try to understand their principles and how their techniques of choice support those principles.</li>
  </ol>

  <p class="calibre2">Now, let us take a quick summary of all the techniques introduced in example:</p>

  <dl class="calibre2">
    <dt class="calibre16">Anonymous Input</dt>

    <dd class="calibre17">moving the output out of the Statement code and hide it behind a method that to emphasize the constrain on the data used rather than what is its value</dd>

    <dt class="calibre16">Derived Values</dt>

    <dd class="calibre17">defining expected output in terms of the input in order to document the relationship between input and output</dd>

    <dt class="calibre16">Distinct Generated Values</dt>

    <dd class="calibre17">When using Anonymous Input, generate a distinct value each time (in case of types that have very few values, like boolean, try at least not to generate the same value twice in a row) in order to make the Statement more reliable.</dd>

    <dt class="calibre16">Constant Specification</dt>

    <dd class="calibre17">Write a separate Statement for a constant and use the constant instead of its literal value in all other Statements to create a Derived Value.</dd>
  </dl>

  <h2 id="calibre_link-72" class="calibre5">Constrained non-determinism</h2>

  <p class="calibre2">When we combine anonymous input together with distinct generated values, we get something that is called <strong class="calibre14">Constrained Non-Determinism</strong>. This is a term coined by Mark Seemann and basically means three things:</p>

  <ol class="calibre12">
    <li class="calibre13">Values are anonymous i.e. we do not know the actual value we are using</li>

    <li class="calibre13">The values are generated in as distinct as possible sequence (which means that, whenever possible, no two values generated one after another hold the same value)</li>

    <li class="calibre13">The non-determinism in generation of the values is constrained, which means that the algorithms for generating values are carefully picked in order to provide values that are not special in any way (e.g. when generating integers, we do not allow generating ‘0’ as it is usually a special-case-value)) and that are not “evil” (e.g. for integers, we generate small positive values first and go with bigger numbers only when we run out of those small ones).</li>
  </ol>

  <p class="calibre2">There are multiple ways to implement constrained non-determinism. Mark Seemann himself invented the AutoFixture library for C# that is freely available to download by anyone (the home is at https://github.com/AutoFixture/AutoFixture). Here is a shortest possible snippet to generate an anonymous integer using AutoFixture:</p>
  <pre class="calibre10">Fixture fixture = new Fixture();
var anonymousInteger = fixture.Create&lt;int&gt;();</pre>

  <p class="calibre2">I, after Amir Kolsky and Scott Bain, like to use Any class as seen in the previous chapters of this book. Any takes a slightly different approach than AutoFixture (although it uses AutoFixture internally). My implementation of Any class is available to download as well from https://github.com/grzesiek-galezowski/tdd-toolkit.</p>

  <h2 id="calibre_link-73" class="calibre5">Summary</h2>

  <p class="calibre2">That was a long ride, wasn’t it? I hope that this chapter, gave you some understanding of how different TDD styles came into existence and why I use some of the techniques I do (and how these techniques are not just a series of random choices). In the next chapters, I will try to introduce some more techniques to help you grow a bag of neat tricks - a coherent style.</p>
</div>


<div class="calibre4" id="calibre_link-2">
  <h1 class="calibre1">What is the scope of a unit-level Statement in TDD?</h1>

  <p class="calibre2">Ha, now I have to admit that I deferred for a long time an answer to a pretty fundamental question: what should be the scope of a single Statement? If I put the whole system together, can I write a Statement for its behavior? Or maybe the other way round - there should be a Statement for each method of each class, including the private ones? Well, first thing I want to explain is that there are multiple levels we can write write our Statements on. This varies depending on the TDD authority, but in this book, we will cover two of such levels - unit level and acceptance level. For now, let us stick to the unit level, which is what we have done so far anyway. The time will come for the rest.</p>

  <p class="calibre2">For unit level, let us consider the kind of Statements that you already saw in this book - where we take one object, invoke a method on it and assert on the result. This is actually a special case of unit-level Statement and we will cover more in the coming chapters. This is, however, a good moment to stop and consider the “scope” of a single unit-level Statement in TDD. Is it method scope? Class scope? Feature scope?</p>

  <p class="calibre2">Let us try to answer the question by examining some TDD unit-level Statements:</p>

  <h3 class="sigilnotintoc">Is it class scope?</h3>

  <p class="calibre2">Let us see the first example and try to answer this question:</p>
  <pre class="calibre10">[Fact] public void
ShouldThrowValidationExceptionWithFatalErrorLevelWhenValidatedStringIsEmpty()
{
  //GIVEN
  var emptyString = string.Empty;
  var validation = new Validation();

  //WHEN
  var exceptionThrown = Assert.Throws&lt;CustomException&gt;(
    () =&gt; validation.Perform(emptyString) 
  );
  
  //THEN
  Assert.True(exceptionThrown.IsFatalError);
}</pre>

  <p class="calibre2">This is an example of a well-written unit-level Statement. Ok, so let us see… how many real classes take part in this spec? Three: a string, an exception and the validation. So the class scope is not the most accurate description.</p>

  <h3 class="sigilnotintoc">Or a method scope?</h3>

  <p class="calibre2">So, maybe the scope covers a single method, meaning a Statement always exercises one method of a specified object?</p>

  <p class="calibre2">Let us consider the following example:</p>
  <pre class="calibre10">[Fact] public void 
ShouldBeFulfilledWhenEventOccursThreeTimes()
{
  //GIVEN
  var rule = new FullQueueRule();
  rule.Queued();
  rule.Queued();

  //WHEN
  rule.Queued();

  //THEN
  Assert.True(rule.IsFulfilled());
}
</pre>

  <p class="calibre2">Count with me: how many methods are called? Depending on how we count, it is two (<code class="calibre11">Queued()</code> and <code class="calibre11">IsFulfilled()</code>) or four (<code class="calibre11">Queued(), Queued(), Queued(), IsFulfilled()</code>). In any case, not one. So it is not method scope either.</p>

  <h3 class="sigilnotintoc">It is the scope of class behavior!</h3>

  <p class="calibre2">The proper answer is: behavior! Each TDD Statement specifies a single behavior. I like how <a href="http://sustainabletdd.com">Amir Kolsky and Scott Bain</a>&nbsp;phrase it, by saying that each unit-level Statement should “introduce a behavioral distinction not existing before”.</p>

  <p class="calibre2">It may look that “behavior” scope is actually broader than method or class levels, since such Statement can span multiple classes and multiple methods. This is only partially true. That is because e.g. Statements with method scope can span multiple behaviors (which, by the way, is a sign of poorly written Statement). Let us take a look at an example:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReportItCanHandleStringWithLengthOf3ButNotOf4AndNotNullString()
{
  //GIVEN
  var bufferSizeRule = new BufferSizeRule();
  //WHEN
  var resultForLength3 
    = bufferSizeRule.CanHandle(Any.StringOfLength(3));
  //THEN
  Assert.True(resultForLength3);

  //WHEN again?
  var resultForLength4 
    = bufferSizeRule.CanHandle(Any.StringOfLength(4))
  //THEN again?
  Assert.False(resultForLength4);

  //WHEN again??
  var resultForNull = bufferSizeRule.CanHandle(null);
  //THEN again??
  Assert.False(resultForNull);
}</pre>

  <p class="calibre2">Note that it specifies three (or two - depending on how you count) behaviors: acceptance of string of allowed size, refusal of handling string above the allowed size and a special case of null string. As I said - this is an antipattern and is sometimes called a “check-it-all test”. The issue with this kind of Statement is that it can be evaluated to false for at least two reasons - when the allowed string size changes and when null handling is done in another way. Also, xUnit tools by default stop execution on first error, so, assuming that the first assertion fails, we will not know the outcome of the next assertion unless we fix the previous one (does that mean we have to use a single <code class="calibre11">Assert</code> per Statement? We will take care of this question later. For now, let the answer be: “not necessarily”).</p>

  <p class="calibre2">On the other hand, Statements with behavior scope do not necessary have to be broader than those with class scope. Let us take the following example that proves it:</p>
  <pre class="calibre10">[Fact] public void
ShouldReportItIsStartedAndItDoesNotYetTransmitVoiceWhenItStarts()
{
  //GIVEN
  var call = new DigitalCall();
  call.Start();
 
  //WHEN
  var callStarted = call.IsStarted;
  
  //THEN
  Assert.True(callStarted);

  //WHEN-THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; call.Transmit(Any.InstanceOf&lt;Frame&gt;()));
}
</pre>

  <p class="calibre2">Again, there are two behaviors here: reporting the call status after start and not being able to transmit frames after start. That is why this test should be split into two.</p>

  <p class="calibre2">How to catch that you are writing a Statement about two or more behaviors rather than one? First, take a look at the test name - if it looks strange and contains some “And” or “Or” words, it may (but does not have to) be about more than one behavior. Another way is to write the description of a behavior in a Given-When-Then way. If you have more than one item in the “When” section or the structure is not Given-When-Then, but rather a “Given-When-Then-When-Then” - that is also a signal.</p>
</div>


<div class="calibre4" id="calibre_link-22">
  <div class="disclaimer">
    <h3 class="sigilnotintoc2">A Disclaimer</h3>

    <p class="calibre2">Before I begin, I have to admit that this chapter is mostly based on the material from a series of posts by Scot Bain and Amir Kolsky from the blog Sustainable Test Driven Development and their upcoming book by the same title. I like their idea of boundaries so much that I just follow the guidelines they outlined. This chapter is going to be a rephrase of these guidelines. I placed it here so that you have all the important topics covered in one place, but I encourage you to read the original blog posts on this subject on http://www.sustainabletdd.com (and the upcoming book).</p>
  </div>

  <h1 id="calibre_link-74" class="calibre1">Specifying Boundaries and Conditions</h1>

  <h2 id="calibre_link-75" class="calibre5">Sometimes, Anonymous Value Is Not Enough</h2>

  <p class="calibre2">When we specify a behavior, there are times when this behavior should be the same no matter what arguments we pass to the constructor or invoked methods. An example would be an addition of two numbers - whatever numbers we would supply, the answer would always be a sum of those numbers:</p>
  <pre class="calibre10">[Fact] public void
ShouldCalculateTheSumOfTwoNumbers()
{
  //GIVEN
  var a = Any.Integer();
  var b = Any.Integer();

  //WHEN
  var result = new Sum().Of(a, b);

  //WHEN
  Assert.Equal(a + b, result);
}</pre>

  <p class="calibre2">In this case, the integer numbers can really be “any” - the described relationship between input and output is independent of the actual values we use. As indicated in one of the previous chapters, this is the canonical case where Constrained Non-Determinism applies.</p>

  <p class="calibre2">Sometimes, however, objects exhibit different behaviors based on what is passed to their constructor and to their methods (OK, we also have static methods and singletons. Longer discussion on those will be included in one of the next chapters - for now we can safely ignore them). For example, in our application we may have a licensing policy where a feature is allowed to use only if the license is valid, and denied after it has expired. Another example would be that some shops are open from 10:00 to 18:00, so if we had a query in our application whether the shop is currently open, we would expect it to be answered differently based on what the current time is.</p>

  <p class="calibre2">In such cases, Scott and Amir offer us other guidelines for choosing input values.</p>

  <h2 id="calibre_link-76" class="calibre5">Exceptions To The Rule</h2>

  <p class="calibre2">There are times, when a Statement is true for every value except one (or more) explicitly specified. For example, in Poland, high school students are graded for exams between “mediocre” and “very good”. Every grade means the exam is passed except for “mediocre” grade which means the exam is failed. If we imagine we have to specify an object that decides whether the exam is passed based on rating, we would have to write two Statements: one for the mediocre rating and other for all the others.</p>

  <p class="calibre2">Here is the Statement for mediocre grade (let us imagine that all grades are members of an enum):</p>
  <pre class="calibre10">[Fact] public void
ShouldNotPassTheExamWhenGradeIsMediocre()
{
  //GIVEN
  var decision = new PassOrNotDecision();

  //WHEN
  var examPassed = decision.MakeBasedOn(Grades.Mediocre);

  //THEN
  Assert.False(examPassed);
}</pre>

  <p class="calibre2">Note that here, we used the literal value of <code class="calibre11">Grades.Mediocre</code>. This is because no other value gives the same behavior as this one, so generating the value would not make any sense.</p>

  <p class="calibre2">The second Statement is for all the other cases. Here, we are going to use another method of the <code class="calibre11">Any</code> class for generating ay enum member other than specified:</p>
  <pre class="calibre10">[Fact] public void
ShouldPassTheExamWhenGradeIsOtherThanMediocre()
{
  //GIVEN
  var decision = new PassOrNotDecision();

  //WHEN
  var examPassed 
    = decision.MakeBasedOn(Any.Besides(Grades.Mediocre));<br class="calibre6" />
  //THEN
  Assert.True(examPassed);
}</pre>

  <p class="calibre2">Here, <code class="calibre11">Any.Besides()</code> takes care of the enum value generation, producing a nice, readable code as a side effect.</p>

  <p class="calibre2">The example shown above assumes there is only one exception to the rule (the mediocre grade). However, this concept can be scaled up to more values, as long as it is a finished, discrete set. If there are multiple exceptional values that produce the same behavior, a single Statement is sufficient to cover them all (using <code class="calibre11">Any</code> class and making the following call for exception Statement: <code class="calibre11">Any.Of(value1, value2)</code> and the following for the rest: <code class="calibre11">Any.OtherThan(value1, value2)</code>). However, when there are multiple exceptions to the rule and each one triggers a different behavior, each one deserves its own Statement.</p>

  <h2 id="calibre_link-77" class="calibre5">Rules Valid Within Boundaries</h2>

  <p class="calibre2">Sometimes, a behavior varies around a numerical boundary. the simplest example would be a set of rules on how to calculate an absolute value of a number:</p>

  <ol class="calibre12">
    <li class="calibre13">for any X less than 0, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>

    <li class="calibre13">for any X greater or equal to 0, the result is X (e.g. absolute value of 3 is 3).</li>
  </ol>

  <p class="calibre2">As you can see, there is a boundary between the two behaviors and the right edge of the boundary is 0. Why do I say “right edge”? That is because the boundary always has two edges and there’s a length between them. If we assume we are talking about the mentioned absolute value calculation and that our numerical domain is that of integer numbers, we can as well use -1 as edge value and say that:</p>

  <ol class="calibre12">
    <li class="calibre13">for any X less or equal to -1, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>

    <li class="calibre13">for any X greater than -1, the result is X (e.g. absolute value of 3 is 3).</li>
  </ol>

  <p class="calibre2">So a boundary is not a single number - it always has a length - the length between last value of the previous behavior and the first value of the next behavior. In case of our example, the length between -1 (left edge - last negated number) and 0 (right edge - first non-negated) is 1.</p>

  <p class="calibre2">Now, imagine that we are not talking about integer values anymore, but about floating point values. Then the right edge value would still be 0. But what about left edge? It would not be possible for it to stay -1, because the rule applies to e.g. -0.9 as well. So what is the correct right edge value and the correct length of the boundary? Would the length be 0.1? Or 0.001? Or maybe 0.00000001? This is harder to answer and depends heavily on the context, but it is something that must be answered for each particular case - this way we know what kind of precision is expected of us. In our Specification, we have to document the boundary length somehow.</p>

  <p class="calibre2">So the next topic is: how to describe the boundary length with Statements? To illustrate this, I want to show you two Statements assuming we’re implementing the mentioned absolute value calculation for integers. The first Statement is for values smaller than 0 and we want to use the left edge value here ilke this:</p>
  <pre class="calibre10">[Fact] public void
ShouldNegateTheNumberWhenItIsLessThan0()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var lessThan0 = 0 - 1;

  //WHEN
  var result = function.PerformFor(lessThan0);

  //THEN
  Assert.Equal(-lessThan0, result);
}</pre>

  <p class="calibre2">And the next Statement for values at least 0 and we want to use the right edge value:</p>
  <pre class="calibre10">[Fact] public void
ShouldNotNegateTheNumberWhenItIsGreaterOrEqualTo0()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var moreOrEqualTo0 = 0;

  //WHEN
  var result = function.PerformFor(moreOrEqualTo0);

  //THEN
  Assert.Equal(moreOrEqualTo0, result);
}</pre>

  <p class="calibre2">There are two things to note about these examples. The first one is that we don’t use any kind of <code class="calibre11">Any</code> methods. We explicitly take the edges, because they’re the numbers that most strictly define the boundary. This way we document the boundary length.</p>

  <p class="calibre2">It is important to understand why we are not using methods like <code class="calibre11">Any.IntegerGreaterOrEqualTo(0)</code>, even though we do use <code class="calibre11">Any</code>&nbsp;in case when we have no boundary. This is because in the latter case, no value is better than the other in any particular way. In case of boundaries, however, the edge values are better in that they more strictly define the boundary and drive the right implementation.</p>

  <p class="calibre2">The second thing to note is the usage of literal constant 0 in the above example. In one of the previous chapter, I showed you a technique called <strong class="calibre14">Constant Specification</strong>, where we write an explicit Statement about the value of the named constant and use the named constant everywhere else instead of its literal. So why did i not use this technique?</p>

  <p class="calibre2">The only reason is that this might have looked a little bit silly with such extremely trivial example as calculating absolute value. In reality, I should have used the named constant in both Statements and it would show the boundary length even more clearly. Actually, let use perform this exercise now and see what happens.</p>

  <p class="calibre2">First, let us document the named constant:</p>
  <pre class="calibre10">[Fact] public void
ShouldIncludeSmallestValueNotToNegateSetToZero()
{
  Assert.Equal(0, Constants.SmallestValueNotToNegate);
}</pre>

  <p class="calibre2">Now we have got everything we need to rewrite the two Statements we wrote earlier. The first would look like this:</p>
  <pre class="calibre10">[Fact] public void
ShouldNegateTheNumberWhenItIsLessThanSmallestValueNotToNegate()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();
  var lastNumberToNegate 
    = Constants.SmallestValueNotToNegate - 1;

  //WHEN
  var result = function.PerformFor(lastNumberToNegate);

  //THEN
  Assert.Equal(-lastNumberToNegate, result);
}</pre>

  <p class="calibre2">And the second Statement for values at least 0:</p>
  <pre class="calibre10">[Fact] public void
ShouldNotNegateNumberWhenItIsGreaterOrEqualToSmallestValueNotToNegate()
{
  //GIVEN
  var function = new AbsoluteValueCalculation();

  //WHEN
  var result = function.PerformFor(
    Constants.SmallestValueNotToNegate
  );

  //THEN
  Assert.Equal(
    Constants.SmallestValueNotToNegate, result);
}</pre>

  <p class="calibre2">As you can see, the first Statement contains the following expression: <code class="calibre11">Constants.SmallestValueNotToNegate - 1</code>, where 1 is the exact length of the boundary. Like I said, the situation is so trivial that it may look silly and funny, however, in real life scenarios, this is a great technique to apply anytime, anywhere.</p>

  <p class="calibre2">Boundaries may look like they apply only to integer input, but they occur at many other places. There are boundaries associated with date/time (e.g. an action is performed again when time from last action is at least 30 seconds - the decision would need to be made whether we need precision in seconds or maybe in ticks), to strings (e.g. validation of user name where it must be at least 2 characters, or password that must contain at least 2 special characters) etc.</p>

  <h2 id="calibre_link-78" class="calibre5">Combination of Boundaries - Ranges</h2>

  <p class="calibre2">So, what about a behavior that is valid in a range? Let us assume that we live in a country where a citizen can get a driving license only after their 17th birthday, but before 65th (the government decided that people after 65 have worse sight and it’s safer not to give them new driving licenses). Let us also assume that we try to develop a class that answers the question whether we can apply for driving license and the return values of this query are as follows:</p>

  <ol class="calibre12">
    <li class="calibre13">Age &lt; 17 - returns enum value <code class="calibre11">QueryResults.TooYoung</code></li>

    <li class="calibre13">17 &lt;= age &gt;= 65 - returns enum value <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age &gt; 65 - returns enum value <code class="calibre11">QueryResults.TooOld</code></li>
  </ol>

  <p class="calibre2">Now, remember I told you that we specify the behaviors near boundaries? This, however, when applied to the situation I just described, would give us the following Statements:</p>

  <ol class="calibre12">
    <li class="calibre13">Age = 17, should yield result <code class="calibre11">QueryResults.TooYoung</code></li>

    <li class="calibre13">Age = 18, should yield result <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age = 65, should yield result <code class="calibre11">QueryResults.AllowedToApply</code></li>

    <li class="calibre13">Age = 66, should yield result <code class="calibre11">QueryResults.TooOld</code></li>
  </ol>

  <p class="calibre2">thus, we would describe the behavior where the query should return <code class="calibre11">AllowedToApply</code> value twice, which effectively means that we would copy-paste the Statement and change just one value. How do we deal with this? Thankfully, we have a solution available:</p>

  <p class="calibre2">Most xUnit frameworks provide some kind of data-driven test functionality, which we can use to write parameterized Statements. The functionality basically means that we can write the code of the Statement once, but make the xUnit framework invoke it twice with different sets of input values. Let’s see an example in XUnit.net:</p>
  <pre class="calibre10">[Theory]
[InlineData(17, QueryResults.TooYoung)]
[InlineData(18, QueryResults.AllowedToApply)]
[InlineData(65, QueryResults.AllowedToApply)]
[InlineData(66, QueryResults.TooOld)]
public void ShouldYieldResultForAge(int age, QueryResults expectedResult)
{
  //GIVEN
  var query = new DrivingLicenseQuery();

  //WHEN
  var result = query.ExecuteFor(age);

  //THEN
  Assert.Equal(expectedResult, result);
}</pre>

  <p class="calibre2">This way, there is only one Statement executed four times. The case of <code class="calibre11">AllowedToApply</code> is still evaluated twice for both edge cases (so there is more time spent on executing it, which for small cases is not an issue), but the code maintenance issue is gone - we don’t have to copy-paste the code to specify both edges of the behavior.</p>

  <p class="calibre2">Note that we’re quite lucky because the specified logic is strictly functional (i.e. returns different results based on different inputs). Thanks to this, we could parameterize input values together with expected results. This is not always the case. For example, let us imagine that we have a clock class where we can set alarm time. The class allows us to set hour between 0 and 24, but otherwise throws an exception.</p>

  <p class="calibre2">While some xUnit frameworks, like NUnit, allow us to handle both cases with one Statement by writing something like this:</p>
  <pre class="calibre10">//NOTE: this is an example in NUnit framework!
[TestCase(Hours.Min, Result=Hours.Min)]
[TestCase(Hours.Max, Result=Hours.Max)]
[TestCase(Hours.Min-1, ExpectedException = typeof(OutOfRangeException))]
[TestCase(Hours.Max+1, ExpectedException = typeof(OutOfRangeException))]
public int 
ShouldBeAbleToSetHourBetweenMinAndMaxButNotOutsideThatRange(
  int inputHour)
{
  //GIVEN
  var clock = new Clock();
  clock.SetAlarmHour(inputHour);

  //WHEN
  var setHour = clock.GetAlarmHour();

  //THEN
  return setHour;
}</pre>

  <p class="calibre2">Others, like XUnit.NET, don’t (not that it’s a defect of the framework, it’s just that the philosophy behind those two is a little bit different and that some features have hidden price attached to their usage which some frameworks are willing to pay, while others aren’t). Thus, we have to solve it by writing two parameterized Statements - one where a value is returned (for valid cases) and one where exception is thrown (for invalid cases). The first would look like this:</p>
  <pre class="calibre10">[Theory]
[InlineData(Hours.Min)]
[InlineData(Hours.Max)]
public void 
ShouldBeAbleToSetHourBetweenMinAndMax(int inputHour)
{
  //GIVEN
  var clock = new Clock();
  clock.SetAlarmHour(inputHour);

  //WHEN
  var setHour = clock.GetAlarmHour();

  //THEN
  Assert.Equal(inputHour, setHour);
}</pre>

  <p class="calibre2">and the second:</p>
  <pre class="calibre10">[Theory]
[InlineData(Hours.Min-1)]
[InlineData(Hours.Max+1)]
public void 
ShouldThrowOutOfRangeExceptionWhenTryingToSetAlarmHourOutsideValidRange(
  int inputHour)
{
  //GIVEN
  var clock = new Clock();

  //WHEN - THEN
  Assert.Throws&lt;OutOfRangeException&gt;( 
    ()=&gt; clock.SetAlarmHour(inputHour)
  );
}</pre>

  <h2 id="calibre_link-79" class="calibre5">Summary</h2>

  <p class="calibre2">In this chapter, we covered specifying numerical boundaries with a minimal amount of code, so that the Specification is more maintainable and runs fast. There is one more kind of situation left: when we have compound conditions (e.g. a password must be at least 10 characters and contain at least 2 special characters) - we’ll get back to those when we introduce mocks.</p>
</div>


<div class="calibre4" id="calibre_link-38">
  <div class="disclaimer">
    The first occurence of the term triangulation I know about is in Kent Beck’s book <a href="http://www.pearsonhighered.com/educator/product/Test-Driven-Development-By-Example/9780321146533.page">Test Driven Development: By Example</a>.
  </div>

  <h1 class="calibre1">Triangulation</h1>

  <p class="calibre2">As one of the last topics of the core TDD techniques that do not require us to delve into the object oriented world, I’d like to show you triangulation.</p>

  <p class="calibre2">Triangulation is often described as the most conservative of three approaches of test-driving implementation. These approaches are:</p>

  <ol class="calibre12">
    <li class="calibre13">Type the obvious implementation</li>

    <li class="calibre13">Fake it (‘til you make it)</li>

    <li class="calibre13">Triangulate</li>
  </ol>

  <p class="calibre2">All of these techniques are simple (triangulaion being a&nbsp;youtubelittle more complex), so I’ll show you all of them one by one, putting more emphasis on triangulation:</p>

  <h2 class="calibre5">Type The Obvious Implementation</h2>

  <p class="calibre2">The first of the three techniques is just writing an obvious implementation in response to a Statetement. If the implementation is simple, this approach makes a lot of sense. Let’s take a trivial example of adding two numbers:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var sum = new Sum();

  //WHEN
  var result = sum.Of(3,5);

  //THEN
  Assert.Equal(8, result);
}</pre>

  <p class="calibre2">You may remember I told you that usually we write the simplest production code that would make the Statement true. This rule would encourage us to just return 7 from the <code class="calibre11">Of</code> method, because it would be sufficient to make the Statement true. Instead, we can decide that the logic is so obvious, that we can just write it based on this one Statement:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a+b;
  }
}</pre>

  <p class="calibre2">and this is it.</p>

  <p class="calibre2">Note that I didn’t use Constrained Non-Determinism here, because its use enforces using “Just write obvious implementation” technique. In fact, most (if not all) Statements we wrote so far in previous chapters, uses this approach because of this fact. Let’s take a look at how the above Statement would look if we used Constrained Non-Determinism:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var a = Any.Integer();
  var b = Any.Integer();
  var sum = new Sum();

  //WHEN
  var result = sum.Of(a,b);

  //THEN
  Assert.Equal(a + b, result);
}</pre>

  <p class="calibre2">Here, we don’t have any choice. The most obvious implementation that would make this Statement true is the correct implementation. We are unable to return some constant value as we previously could (but we did not), because we just don’t know what the expected result is and it is strictly dependent on the input values which we don’t know as well.</p>

  <h2 class="calibre5">Fake It (‘Til You Make It)</h2>

  <p class="calibre2">This technique is kind of funny. I do not recall myself ever using it, but it is so interesting I want to show it to you anyway. It is so simple you will not regret these few minutes even if just for broadening your horizons.</p>

  <p class="calibre2">There are two core things that we need to pay attention when using these technique:</p>

  <ol class="calibre12">
    <li class="calibre13">Start with the simplest implementation possible (i.e. fake it), which usually is returning a literal constant. Then gradually transform the code of both Statement and implementation using variables</li>

    <li class="calibre13">When doing it, rely on your sense of duplication between Statement and (fake) implementation</li>
  </ol>

  <p class="calibre2">Let us apply Fake It to the same addition example as before (I promise, for triangulation, I will give you better one). The Statement looks the same as before:</p>
  <pre class="calibre10">[Fact] public void
ShouldAddTwoNumbersTogether()
{
  //GIVEN
  var sum = new Sum();

  //WHEN
  var result = sum.Of(3,5);

  //THEN
  Assert.Equal(8, result);
}</pre>

  <p class="calibre2">Only this time, we are going to use the simplest implementation possible. As I wrote, this simplest implementation is almost always to return a constant:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return 8;
  }
}</pre>

  <p class="calibre2">The Statement evaluates to true (green) now, though the implementation is obviously wrong. BUT, the TDD cycle is not over yet. Remember that as soon as the Statement is true, refactoring phase kicks in. This is something we were ignoring silently for now (and here we will only slightly lick it). We can use the refactoring phase to remove duplication between the Statement and the implementing code.</p>

  <p class="calibre2">First, let us note that the number 8 is duplicated between Statement and implementation - the implementation returns it and the Statement asserts on it. To reduce this duplication, let us break the 8 in the implementation into a sum:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return 3 + 5;
  }
}</pre>

  <p class="calibre2">Note the smart trick I did. I changed duplication between implementation and expected result to duplication between implementation and input values of the Statement. After all, 3 and 5 are the exact values I used in the Statement, right? This kind of duplication is different in that it can be removed using variables (this applies not only to input variables, but basically anything we have access to prior to triggering specified behavior - constructor parameters, fields etc. in contrast to result which we normally do not know until we invoke the behavior). The duplication of number 3 can be eliminated this way:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a + 5;
  }
}</pre>

  <p class="calibre2">and we have just the number 5 duplicated, because we used variable to transfer the value of 3 from Statement method to the <code class="calibre11">Of</code> implementation, so we have it in one place now. Let us do the same with 5:</p>
  <pre class="calibre10">public class Sum
{
  public int Of(int a, int b)
  {
    return a + b;
  }
}</pre>

  <p class="calibre2">And that’s it. I used a trivial example, since I don’t want to spend too much time on this, but you can find more advanced ones in Kent Beck’s book if you like.</p>

  <h2 class="calibre5">Triangulation</h2>

  <p class="calibre2">As I wrote, triangulation is the most conservative technique, because following it involves the tiniest possible steps to arrive at the right solution. The technique is called triangulation by analogy to <a href="http://encyclopedia2.thefreedictionary.com/radar+triangulation">radar triangulation</a> where outputs from at least two radars must be used to determine the position of a unit. Also, in radar triangulation, the position is measured indirectly, by combining the following data: range (not position!) between two radars, measurement done by each radar and the positions of the radars (which we know, because we are the ones who put the radars there). From this data, we can derive a triangle, so we can use trigonometry to calculate the position of the third point of the triangle, which is the desired position of the unit (two remaining points are the positions of radars). Such measurement is indirect in nature, because we do not measure the position directly, but calculate it from other helper measurements.</p>

  <p class="calibre2">These two characteristics: indirect measurement and using at least two sources of information are at the core of TDD triangulation. Basically, it says:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Indirect measurement</strong>: derive the design from few known examples of its desired external behavior by looking at what varies in these examples and making this variability into something more general</li>

    <li class="calibre13"><strong class="calibre14">Using at least two sources of information</strong>: start with the simplest possible implementation and make it more general <strong class="calibre14">only</strong> when you have two or more different examples (i.e. Statements that describe the desired functionality for specific inputs). Then new examples can be added and generalization can be done again. This process is repeated until we reach the desired implementation. Robert C. Martin developed a&nbsp;maxim on this, saying that “As the tests get more specific, the code gets more generic.</li>
  </ol>

  <p class="calibre2">Usually, when TDD is showcased on simple examples, triangulation is the primary technique used, so many novices mistakenly believe TDD is all about triangulation. This isn’t true, although triangulation is important.</p>

  <h4 class="sigilnotintoc1">Example</h4>

  <p class="calibre2">Suppose we want to write a logic that creates an aggregate sum of the list. Let’s assume that we have no idea how to design the internals of our custom list class so that it fulfills its responsibility. Thus, we start with the simplest example of calculating a sum of 0 elements:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturn0AsASumOfNoElements()
{
  //GIVEN
  var listWithAggregateOperations 
    = new ListWithAggregateOperations();

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(0, result);
}</pre>

  <p class="calibre2">Remember we want to write just enough code to make the Statement true. We can achieve it with just returning 0 from the <code class="calibre11">SumOfElements</code> method:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  public int SumOfElements()
  {
    return 0;
  }
}</pre>

  <p class="calibre2">This is not yet the implementation we are happy with, which makes us add another Statement - this time for a single element:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturnTheSameElementAsASumOfSingleElement()
{
  //GIVEN
  var singleElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(singleElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(singleElement, result);
}</pre>

  <p class="calibre2">The naive implementation can be as follows:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int _element = 0;

  public ListWithAggregateOperations()
  {    
  }

  public ListWithAggregateOperations(int element)
  {
    _element = element;
  }

  public int SumOfElements()
  {
    return _element;
  }
}</pre>

  <p class="calibre2">We have two examples, so let us check whether we can generalize now. We could try to get rid of the two constructors now, but let us wait just a little bit longer and see if this is the right path to go (after all, I told you that we need <strong class="calibre14">at least</strong> two examples).</p>

  <p class="calibre2">Let’s add third example then. What would be the next more complex one? Note that the choice of next example is not random. Triangulation is about considering the axes of variability. If you carefully read the last example, you probably noticed that we already skipped one axis of variability - the value of the element. We used <code class="calibre11">Any.Integer()</code> where we could use a literal value and add a second example with another value to make us turn it into variable. This time, however, I decided to <strong class="calibre14">type the obvious implementation</strong>. The second axis of variability is the number of elements. The third example will move us further along this axis - so it will use two elements instead of one or zero. This is how it looks like:</p>
  <pre class="calibre10">[Fact] public void 
ShouldReturnSumOfTwoElementsAsASumWhenTwoElementsAreSupplied()
{
  //GIVEN
  var firstElement = Any.Integer();
  var secondElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(firstElement, secondElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(firstElement + secondElement, result);
}</pre>

  <p class="calibre2">And the naive implementation will look like this:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int _element1 = 0;
  int _element2 = 0;

  public ListWithAggregateOperations()
  {
  }

  public ListWithAggregateOperations(int element)
  {
    _element1 = element;
  }

  //added
  public ListWithAggregateOperations(int element1, int element2)
  {
    _element1 = element1;
    _element2 = element2;
  }

  public int SumOfElements()
  {
    return _element1 + _element2; //changed
  }
}</pre>

  <p class="calibre2">After adding and implementing the third example, the variability of elements count becomes obvious. Now that we have three examples, we see even more clearly that we have redundant constructors and redundant fields for each element in the list and if we added a fourth example for three elements, we’d have to add another constructor, another field and another element of the sum computation. Time to generalize!</p>

  <p class="calibre2">How do we encapsulate the variability of the element count so that we can get rid of this redundancy? A collection! How do we generalize the addition of multiple elements? A&nbsp;foreach loop through the collection! Thankfully, C# supports <code class="calibre11">params</code> keyword, that let us use it to remove the redundant constructor like this:</p>
  <pre class="calibre10">public class ListWithAggregateOperations
{
  int[] _elements;  

  public ListWithAggregateOperations(params int[] elements)
  {
    _elements = elements;
  }

  public int SumOfElements()
  {
    //changed
    int sum = 0;
    foreach(var element in _elements)
    {
      sum += element;
    }
    return sum;

  }
}</pre>

  <p class="calibre2">While the first Statement (“no elements”) seems like a special case, the remaining two - for one and two elements - seem to be just two variations of the same behavior (“some elements”). Thus, it is a good idea to make a more general Statement that describes this logic to replace the two examples. After all, we don’t want more than one failure for the same reason. So as the next step, I will write a Statement to replace these examples (I leave them in though, until I get this one to evaluate to true).</p>
  <pre class="calibre10">[Fact]
public void 
ShouldReturnSumOfAllItsElementsWhenAskedForAggregateSum()
{
  //GIVEN
  var firstElement = Any.Integer();
  var secondElement = Any.Integer();
  var thirdElement = Any.Integer();
  var listWithAggregateOperations 
    = new ListWithAggregateOperations(
        firstElement, 
        secondElement, 
        thirdElement);

  //WHEN
  var result = listWithAggregateOperations.SumOfElements();

  //THEN
  Assert.Equal(
   firstElement + 
   secondElement + 
   thirdElement, result);
}
</pre>

  <p class="calibre2">This Statement uses three values rather than zero, one or two as in the examples we had. When I need to use collections with deterministic size (and I do prefer to do it everywhere where using collection with non-deterministic size would force me to use a <code class="calibre11">for</code> loop in my Statement), I pick 3, which is the number I got from Mark Seemann and the rationale is that 3 is the smallest number that has distinct head, tail and middle element. One or two elements seem like a special case, while three sounds generic enough.</p>

  <p class="calibre2">One more thing we can do is to ensure that we didn’t write a <strong class="calibre14">false positive</strong>, i.e. a Statement that is always true due to being badly written. In other words, we need to ensure that the Statement we just wrote will ever evaluate to false if the implementation is wrong. As we wrote it after the implementation is in place, we do not have this certainty.</p>

  <p class="calibre2">What we will do is to modify the implementation slightly to make it badly implemented and see how our Statement will react (we expect it to evaluate to false):</p>
  <pre class="calibre10">public class ListWithAggregateOperations
public int SumOfElements()
{
  //changed
  int sum = 0;
  foreach(var element in _elements)
  {
    sum += element;
  }
  return sum + 1; //modified with "+1"!
}
</pre>

  <p class="calibre2">When we do this, we can see our last Statement evaluate to false with a message like “expected 21, got 22”. We can now undo this one little change and go back to correct implementation.</p>

  <p class="calibre2">The examples (“zero elements”, “one element” and “two elements”) still evaluate to true, but it’s now safe to remove the last two, leaving only the Statement about a behavior we expect when we calculate sum of no elements and the Statement about N elements we just wrote.</p>

  <p class="calibre2">And voilà! We have arrived at the final, generic solution. Note that the steps we took were tiny - so you might get the impression that the effort was not worth it. Indeed, this example was only to show the mechanics of triangulation - in real life, if we encountered such simple situation we’d know straight away what the design would be and we’d start with the general Statement straight away and just type in the obvious implementation. Triangulation shows its power in more complex problems with multiple design axes and where taking tiny steps helps avoid “analysis paralysis”.</p>

  <h2 class="calibre5">Summary</h2>

  <p class="calibre2">As I stated before, triangulation is most useful when you have no idea how the internal design of a piece of functionality will look like (e.g. even if there are work-flows, they cannot be easily derived from your knowledge of the domain) and it’s not obvious along which axes your design must provide generality, but you are able to give some examples of the observable behavior of that functionality given certain inputs. These are usually situations where you need to slow down and take tiny steps that slowly bring you closer to the right design and functionality - and that’s what triangulation is for!</p>
</div>


<div class="calibre4" id="calibre_link-12">
  <h1 class="calibre1">Part 2: Test-Driven Development in Object Oriented World</h1>

  <p class="calibre2">Most of the examples I gave you during the previous part were about a single object that did not have dependencies on other objects (with an exception of some values - strings, integers, enums etc.). This is not how a real OO systems are built. In this part, we are finally going to look at scenarios where multiple objects collaborate together as a system.</p>

  <p class="calibre2">This brings about some issues that need to be discussed. One of them is the approach to object oriented design and how it influences the tools we use to test-drive our code. You probably heard something about a tool called mock objects (at least from one of the introductory chapters of this book) or, in more broaded sense, test doubles. If you open your web browser and type "mock objects break encapsulation", you will find a lot of different opinions - some saying that mocks are great, others blaming them for everything bad in the world, and a lot of opinions inbetween those. The discussions are still heated, even though mocks were introduced more than ten years ago. My goal in this chapter is to outline the real context and forces that lead to adoption of mocks and how to use them for your benefit, not failure.</p>

<p class="calibre2">Steve Freeman, one of the godfathers of using mock objects with TDD, <a href="https://groups.google.com/d/msg/growing-object-oriented-software/rwxCURI_3kM/2UcNAlF_Jh4J">wrote</a>: "mocks arise naturally from doing responsibility-driven OO. All these mock/not-mock arguments are completely missing the point. If you're not writing that kind of code, people, please don't give me a hard time". I am going to introduce mocks in a way that will not give Steve a hard time, I hope.</p>

  <p class="calibre2">In order to do this, I need to cover some topics of object oriented design. That is why not all chapters in this part are specifically about TDD, but some are about object oriented techniques, practices and qualities you need to know to use TDD effectively in object oriented world. First of them being objects composability.</p>

  <p class="calibre2">After reading part 2, you will understand how mocks fit into test-driving object oriented code, how to make Statements using mocks maintainable and how some of the practices I&nbsp;introduced in the chapters of part 1 apply to mocks. You will also be able to test-drive simple object oriented systems.</p>
</div>


<div class="calibre" id="calibre_link-40">
  <h4 class="sigilnotintoc1">THIS IS ALL I HAVE FOR NOW. WHAT FOLLOWS IS RAW, UNORDERED MATERIAL THAT’S NOT YET READY TO BE CONSUMED AS PART OF THIS TUTORIAL</h4>
</div>


<div class="calibre" id="calibre_link-30">
        <h1 class="calibre1">On Objects Composability</h1>
        <p class="calibre2">In this chapter, I will try to outline why objects' composability is a goal worth achieving and how it can be achieved. I am going to start with an example of unmaintainable code and will gradually fix its flaws in the next chapters. In this chapter, we are going to fix just one of the flaws, so the code we will end up will not be perfect by any means, still, it will be better by one quality.</p>

<h1 class="calibre1">TODO make it into a role-play!</h1>

<h1 class="calibre1">Another task for Johnny and Benjamin</h1>

<p class="calibre2">Remember Johnny and Benjamin? Looks like they managed their previous task and are up to something else. Let us listen to their conversation as they are working on another project...</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> So, what's this assignment about?</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> Actually, it's nothing exciting - we'll have to add two features to a legacy application that's not prepared for the changes.</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong>What is the code for?</p>
<p class="calibre2"><strong class="calibre14">Johnny:</strong>It is a class that implements company policies. As the company has just started using this automated system and it was started recently, there is only one policy implemented: yearly incentive plan. Many corporations have what they call incentive plans. These plans are used to promote good behaviors and exceeding expectations by employees of a company.</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> You mean, the project has just started and is already in a bad shape?</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> Yep. The guys writing it wanted to "keep it simple", whatever that means, and now it's pretty bad.</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> I see...</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> By the way, do you like riddles?</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Always!</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> So here's one: how do you call a development phase when you ensure high code quality?</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> ... ... seems I don't have a clue... So what is it called?</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> It's called "now".</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Oh!</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> By the way, the company's incentive plan is one of the most stupid ones I've ever seen. Wonder how this company has managed to stay on the market for three years.</p>

<p class="calibre2">Every employee in the company has a pay grade. An employee can be promoted to a higher pay grade, but the mechanics of how it works is something we are not going to deal with.</p>

<p class="calibre2">Normally, every year, everyone gets a raise by 10%. But to encourage behaviors that give an employee a higher pay grade, such employee cannot get raises indefinitely on a given pay grade. Each grade has its associated maximum pay. If this amount of money is reached, an employee does not get a raise anymore until they reach a higher pay grade.</p>

<p class="calibre2">Additionally, every employee on their 5th anniversary of working for the company, gets a special, one-time bonus which is twice their current payment.</p>
<p class="calibre2"></p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Looks like the source code repository just finished synchronizing. Let's take a bite at the code!</p>
<p class="calibre2"><strong class="calibre14">Johnny:</strong> Sure, here you go:</p>

<pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = new SqlRepository();
  
  public void ApplyYearlyIncentivePlan()
  {
    var employees = _repository.CurrentEmployees();

    foreach(var employee in employees)
    {
      var payGrade = employee.GetPayGrade();
      if(employee.GetSalary() &lt; payGrade.Maximum)
      {
        var newSalary 
          = employee.GetSalary() 
          + employee.GetSalary() 
          * 0.1;
        employee.SetSalary(newSalary);
      }
      
      if(employee.GetYearseOfService() == 5)
      {
        var oneTimeBonus = employee.GetSalary() * 2;
        employee.SetBonusForYear(2014, oneTimeBonus);
      }
      
      employee.Save();
    }
  }
  
  public void Dispose()
  {
    _repository.Dispose();
  }
}</pre>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Wow, there are a lot of literal constants and functional decomposition is barely done!</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> Yeah. We won't be fixing all of that today. Still, we will follow the scout rule and "leave the campground cleaner than we found it".</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> What's our assignment?</p>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> First of all, we need to provide our users a choice between an SQL database and a NoSQL one. To achieve our goal, we need to be somehow able to make the <code class="calibre11">CompanyPolicies</code> class database type-agnostic. For now, as you can see, the implementation is coupled to the specific <code class="calibre11">SqlRepository</code>, because it creates a specific instance itself:</p>

<pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = new SqlRepository();
</pre>

<p class="calibre2">Now, we need to evaluate the options we have to pick the best one. What options do you see, Benjamin?</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Well, we could certainly extract an interface from <code class="calibre11">SqlRepository</code> and introduce an if statement to the constructor like this:</p>

<pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly Repository _repository;

  public CompanyPolicies()
  {
    if(...)
    {
      _repository = new SqlRepository();
    }
    else
    {
      _repository = new NoSqlRepository();
    }
  }
</pre>

<p class="calibre2"><strong class="calibre14">Johnny:</strong> True, but this option has few deficiencies. First of all, remember we're following the scout rule and by using this option we introduce more complexity to the CommonPolicies class. Also, let's say tommorow someone writes a class for reporting - they will need to make the same decision on repositories. This means we would have to make the same decision in both of these classes, effectively duplicating code. What's our next option?</p>

<p class="calibre2"><strong class="calibre14">Benjamin:</strong> Another option would be to change the SqlRepository itself to be just a wrapper around the actual database access, like this:</p>

<pre class="calibre10">public class SqlRepository : IDisposable
{
  readonly Repository _repository;

  public CompanyPolicies()
  {
    if(...)
    {
      _repository = new RealSqlRepository();
    }
    else
    {
      _repository = new RealNoSqlRepository();
    }
  }

  IList&lt;Employee&gt; CurrentEmployees()
  {
    return _repository.CurrentEmployees();
  }
</pre>








<h1 class="calibre1">TOOOOOOOOOOOODOOOOOOOOOO</h1>

<p class="calibre2">There are a couple of ways of dealing with this problem, like:</p>

<h1 class="calibre1">TOOOOOOOOOODOOOOOOOOO convert the list to separate sections</h1>

<ol class="calibre12">
  <li class="calibre13">Creating a constructor with an if statement inside to choose the database - this is a bad idea because other classes in our system use the database as well so the if statement will need to be duplicated.</li>
  <li class="calibre13">Changing the <code class="calibre11">SqlRepository</code> class itself so that it hides the information on the database used behind its own API - this could work, but will lead to every method duplicating the choice between the databases. If we decide to make the choice just once, we don't really need this class, because most of the time it will delegate to its inner implementation.</li>
  <li class="calibre13">Extract interface and pass either of its two implementations through the constructor.</li>
</ol>

<p class="calibre2">The third options seems to be the most compelling, so let us put it to use. We can extract an interface from <code class="calibre11">SqlRepository</code>, called <code class="calibre11">EmployeeSource</code> (TODO why this name?) and pass an instance from outside of the class:</p>

<pre class="calibre10">public class CompanyPolicies : IDisposable
{
  readonly EmployeeSource _employeeSource;  

  public CompanyPolicies(EmployeeSource source)
  {
    _employeeSource = source;
  }
  
  //...code  
  
  public void Dispose()
  {
    _employeeSource.Dispose();
  }
}</pre>

<p class="calibre2">The <code class="calibre11">CompanyPolicies</code> is used in the code the following way:</p>

<pre class="calibre10">var policies = new CompanyPolicies(new SqlRepository());

//... somewhere else in the code

policies.ApplyYearlyIncentivePlan();

//... somewhere else in the code

policies.Dispose();
</pre>

<p class="calibre2">Note two things: 1) as the employee source instance is passed by 3rd party, <code class="calibre11">CompanyPolicies</code> instances cannot assume the instance is used only by itself. Thus, it cannot neither initialize nor dispose of the instance. These two responsibilities have to be moved outside the class as well:</p>

<pre class="calibre10">public class CompanyPolicies
{
  readonly EmployeeSource _employeeSource;  

  public CompanyPolicies(EmployeeSource source)
  {
    _employeeSource = source;
  }
  
  public void ApplyYearlyIncentivePlan()
  {
    var employees = _repository.CurrentEmployees();

    foreach(var employee in employees)
    {
      var payGrade = employee.GetPayGrade();
      if(employee.GetSalary() &lt; payGrade.Maximum)
      {
        var newSalary 
          = employee.GetSalary() 
          + employee.GetSalary() 
          * 0.1;
        employee.SetSalary(newSalary);
      }
      
      if(employee.GetYearseOfService() == 5)
      {
        var oneTimeBonus = employee.GetSalary() * 2;
        employee.SetBonusForYear(2014, oneTimeBonus);
      }

      employee.Save();
    }
  }
}</pre>

<p class="calibre2">Note that we got rid of IDisposable, which is always good for abstraction... Now the usage pattern looks the same, only that now the same third party that created employees object, disposes of it. This is good, because one object has complete control over the lifetime of the employees object:</p>

<pre class="calibre10">SqlRepository repository = new SqlRepository();
var policies = new CompanyPolicies(repository);

//... somewhere else in the code

policies.ApplyYearlyIncentivePlan();

//... somewhere else in the code

repository.Dispose();
</pre>

<p class="calibre2">What have we achieved? Well, we allowed ourselves to choose the implementation of employees' storage. We did this by making the system composable - i.e. we can achieve different behaviors of the system by changing the way objects are composed together into a system. For example, instead of creating a <code class="calibre11">policies</code> object like this:</p>

<pre class="calibre10">SqlRepository repository = new SqlRepository();
var policies = new CompanyPolicies(repository);</pre>

<p class="calibre2">we can create it like this:</p>

<pre class="calibre10">NoSqlRepository repository = new NoSqlRepository();
var policies = new CompanyPolicies(repository);</pre>

<p class="calibre2">Or even, if we later decide to make the repository configurable by a strategy (e.g. there may be different definitions of what it means to get "current" employees) and extract the connection logic even further and make error reporting more configurable, we can do it like this:</p>

<pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingToLogFile()
);
var policies = new CompanyPolicies(repository);</pre>

<p class="calibre2">Everything without touching the <code class="calibre11">CompanyPolicies</code> class. Now, let us take the <code class="calibre11">ErrorReportingToLogFile</code> class and assume, that it is passed where an interface is required. We can, again, exchange this to something else, e.g.:</p>

<pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingThroughNetwork());
);</pre>

<p class="calibre2">Or make it configurable itself, e.g. with different formats and flushing algorithms (for performance purposes):</p>

<pre class="calibre10">Repository repository = new RepositoryConfigurableByPolicies(
  new SqlDatabase(),
  new FilterToExcludeProbationEmployeesFromCurrent(),
  new ErrorReportingToLogFile(
    new XmlLogFormat(),
    new FlushingDelayedUntilCachedContentIsMoreThan(
      Kilobytes.Value(5)
    )
  )
);</pre>

<p class="calibre2">Again, these modifications are all possible without touching the <code class="calibre11">RepositoryConfigurableByPolicies</code> class!</p>

<h1 class="calibre1">Todo write about web of objects and how we can unplug parts of the web and plug in different parts to modify the system behavior without modifying the rest of the web</h1>

<h1 class="calibre1">Todo write about composition root!</h1>

</div>

<div class="calibre4" id="calibre_link-24">
  <p class="calibre2">dependency injection?</p>

  <p class="calibre2">What should be stable in your system?</p>

  <h2 class="calibre5">What code to extract from a Statement to shared utility method?<br class="calibre26" /></h2>

  <h2 id="calibre_link-80" class="calibre5">Why such a strange approach to create enumerated constants?</h2>

  <p class="calibre2">TODO</p>

  <h2 id="calibre_link-81" class="calibre5">Expanded TDD process</h2>

  <p class="calibre2">As a little introduction, I’ll show you an expanded version of TDD flow that we’ll be using:</p>

  <ol class="calibre12">
    <li class="calibre13">Examine TODO list and pick an item that makes most sense to implement next</li>

    <li class="calibre13">Write unfulfilled Statement</li>

    <li class="calibre13">Make it unfulfilled for the right reason</li>

    <li class="calibre13">Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>

    <li class="calibre13">Cross out the item from TODO list</li>

    <li class="calibre13">Repeat until no item is left on the TODO list</li>
  </ol>

  <p class="calibre2">Some of the steps don’t probably mean anything to yet. Don’t worry, we’ll be reiterating them several times, so don’t try to memorize them now.</p>

  <h2 id="calibre_link-82" class="calibre5">What exactly do we specify?<br class="calibre26" /></h2>

  <p class="calibre2">In this chapter, we’ll look a little bit on what it is that we actually write our specification against - what exactly do we want to describe about a class. We’re gonna jump into a quick example, because I’ve been keeping you away from practice too long now. Note that the example won’t exactly show how the real-world TDD looks like, but it will be enough to draw some conclusions and get a feel of Statement-First style of programming.</p>

  <h2 id="calibre_link-83" class="calibre5">quick example (list? calculator?)</h2>

  <p class="calibre2">TODO - todo list</p>
</div>


<div class="calibre" id="calibre_link-25">
  <p class="calibre2">&nbsp;1. combinatorial explosion</p>

  <p class="calibre2">2. too many classes specified at once</p>
</div>


<div class="calibre4" id="calibre_link-13">
  <p class="calibre2">Since you’re reading this blog, you probably have your own, more or less informed, view on TDD. Maybe you already read a book or two, maybe you’ve got two (or twelve) years of TDD practice on your back, but maybe you’ve heard about TDD and about it being “cool” only recently and are merely striving to learn more? If that’s the case you’ve probably got a lot of doubts on whether TDD is really beneficial or whether it will prove beneficial in the specific environment you happen to work in. You’re eager to get started, but you wonder whether the time and effort spent on learning TDD will prove itself to be well spent.</p>

  <p class="calibre2">During my adventure with TDD, I encountered many objections, either from myself (and they were dispelled by others) or from other engineers (these I tried to dispel myself). Today, I’d like to comment on some of those objections I met with when talking about TDD. In particular:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Not enough time</strong></li>

    <li class="calibre13"><strong class="calibre14">TDD will slow us down, because we’ll have to create a lot of additional code</strong></li>

    <li class="calibre13"><strong class="calibre14">TDD will slow us down, because we’ll have to maintain a lot of additional code</strong></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">We don’t have the necessary skills or experience</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">We don’t have the necessary tools</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">(This one is unit testing specific) There are already other kinds of tests, we don’t need unit tests?</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">It’s very hard to perform with legacy code</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">I already know how to write a testable code, TDD will not really improve my design</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">We’ve got enough quality and we’re doing fine without TDD</a></li>

    <li class="calibre13">My manager won’t let me do TDD</li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">There’s no “scientific proof” and enough research on whether TDD really provides a return of investment</a></li>
  </ol>

  <p class="calibre2">This post is around the first three points, marked with <strong class="calibre14">strong text</strong>. The later points will be discussed in part 2 of this post. Ok, let’s go!</p>

  <h3 class="sigilnotintoc">1. Not enough time</h3>

  <p class="calibre2">This is my favorite objection, just because dispelling it is so fun and easy. I usually approach this kind of objections with <a href="http://gojko.net/2012/05/31/how-to-solve-not-enough-time/">Gojko Adzic’s argument on how to solve Not Enough Time</a>. You see, “not enough time” is always a facade reason - it is there only to hide the true one. The only direct solution to “not enough time” is to “make more time”, which, by the way, is impossible. Luckily, we can restate it into something solvable like “something prevents me from allocating time for TDD”. The further actions depend on what is this “something”. Maybe it’s a boss that will punish their employees for not fulfilling the short term goals? Maybe it’s lack of appropriate knowledge or training? Anyway, these issues can be dealt with. “Not enough time” can’t.</p>

  <h3 class="sigilnotintoc">2. TDD will slow us down, because we’ll have to create a lot of additional code</h3>

  <p class="calibre2">This is actually a (partially) valid argument. TDD really does lead to creating more code, which costs time. However, this does not necessarily mean that the overall development process takes more time than not writing this additional code. This is because this “test code” is not being written just for the sake of “being written” :-). The act of writing and the code that is created as a result of this writing provide a great value to a single developer and an entire team.</p>

  <p class="calibre2">TDD aids developers in the process of analysis. What would otherwise be a mental effort to make everything up inside your head, turns into concrete failing or impossible-to-write code. This generates questions that are usually better asked sooner than later. Thanks to this, there’s no escape from facing uncertainty.</p>

  <p class="calibre2">The case is different (at least for me) when developing without TDD. In this approach, I discovered that I tend to write what I know first, leaving what I don’t know for later (in hope that maybe I’ll learn something new along the way that will answer my questions and lower uncertainty). While the process of learning is surely valuable, the uncertainty must be embraced instead of being avoided. Getting away from answering some key questions and leaving them for later generates a lot of rework, usually at the end of iteration, where it’s very dangerous.</p>

  <p class="calibre2">When I do TDD and I encounter a behavior that I don’t know how to specify, I go talk with stakeholders (“Hey, what should happen when someone creates a subscription for magazines already issued?”). Also, If someone asks me to clarify my question, I can show them the spec/test I’m trying to write for the behavior and say “look, this does not work” or “so the output should be what?”. This way, I can get many issues if not solved, then at least on the table much sooner than in case of non-TDD coding. It helps me eliminate rework, save some time and make the whole process more predictable.</p>

  <p class="calibre2">TDD also provides a big help when designing. It lets you do your design outside-in, beginning with the domain and its work-flows, not the reusable, versatile, framework-like, one-size-fits-all utility objects that end up having only 30% of its logic ever used. This way, TDD lets you <strong class="calibre14">avoid over-design</strong> (by the way, code reuse is a good thing, it’s just that preliminary generalization is as dangerous as preliminary optimization).</p>

  <p class="calibre2">On the other hand, by promoting a quality called <a href="http://www.netobjectives.com/files/books/esad/essential-skills-define-tests-up-front.pdf">“testability”</a>, it promotes loose coupling, high cohesion and small, focused, well encapsulated objects. I already did some posts on that, so I’m not gonna delve more into this topic here. Anyway, striving for high testability helps <strong class="calibre14">avoid under-design</strong>.</p>

  <p class="calibre2">Another way to think about the process of doing TDD is that you’re actually documenting your design, its assumptions, legal and illegal behaviors. Others will be able to read it and learn from it when they face the task of using your abstractions in a new context.</p>

  <h3 class="sigilnotintoc">3. TDD will slow us down, because we’ll have to maintain a lot of additional code</h3>

  <p class="calibre2">It’s true that, when done wrong, TDD produces a mass of code that is hard to maintain. Refactoring becomes a pain, each added functionality breaks dozens of existing specs/tests and the teams seriously consider abandoning the practice.</p>

  <p class="calibre2">This happens more often when the teams do not adopt TDD, but rather stick with unit tests and do it only for the sake of testing.</p>

  <p class="calibre2">The truth is that TDD, when done right, helps avoid such situations. Also, this help is actually one of its goals! To achieve this, however, you need two things.</p>

  <p class="calibre2">The first one is knowing TDD good practices that help you write only the specs/tests that you need, focus on behavior and discover interactions between different objects, limiting an impact of a change to a small number of specs/tests. I actually didn’t write about it yet on my blog, but there are some <a href="http://jmock.org/oopsla2004.pdf">other sources of information</a>. Anyway, this issue is easily solvable by a combination of training, mentoring, books and experience.</p>

  <p class="calibre2">the second thing is “listening to the tests”, covered both by <a href="http://www.youtube.com/watch?v=0zLDAl3zPks">Steve Freeman &amp; Nat Pryce</a> (they call it Synaesthesia) and <a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-first-post.html">Amir Kolsky &amp; Scott Bain</a> (they call it Test Reflexology). The big idea is that difficulties in writing and maintaining specs/tests are a very much desired feedback on quality of your design (also make sure to look at James Grenning’s post on <a href="http://www.renaissancesoftware.net/blog/archives/382">TDD as a design rot radar</a>).</p>

  <p class="calibre2">In other words, as long as the design is good and you know how to write tests/specs, this whole objection is not a problem. Of course, there is still a code to maintain, but I found it to be an easy task.</p>

  <p class="calibre2">Another thing to keep in mind is that by maintaining specs/tests, you’re actually maintaining a living documentation on several levels (because TDD is not solely limited to unit level). Just think how much effort it takes to keep an NDoc/JDoc/Doxygen documentation up to date - and you never actually know whether such documentation speaks the truth after a year of maintenance. Things get better with tests/specs, which can be compared with the code just by running them, so the maintenance is easier.</p>

  <h3 class="sigilnotintoc">Part 2 is already written! <a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html" class="calibre30">Read it!</a></h3>

  <p class="calibre2">Also, feel free to leave your comment. How do you deal with these objections when you encounter them? Do you have any patterns you can share?</p>
</div>


<div class="calibre4" id="calibre_link-17">
  <p class="calibre2">Welcome to part 2 of my post about TDD objections.</p>

  <p class="calibre2">By the way, I found an <a href="http://www.slideshare.net/sebrose/common-objections-to-tdd-and-their-refutations">interesting analysis on slideshare</a> on the same topic. It’s an interesting read, so be sure to take a look.</p>

  <h3 class="sigilnotintoc">Where did we leave the last time?</h3>

  <p class="calibre2">Ok, let’s take on the next set of objections from the list:</p>

  <ol class="calibre12">
    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">Not enough time</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">TDD will slow us down, because we’ll have to create a lot of additional code</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">TDD will slow us down, because we’ll have to maintain a lot of additional code</a></li>

    <li class="calibre13"><strong class="calibre14">We don’t have the necessary skills or experience</strong></li>

    <li class="calibre13"><strong class="calibre14">We don’t have the necessary tools</strong></li>

    <li class="calibre13"><strong class="calibre14">(This one is unit testing specific) There are already other kinds of tests, we don’t need unit tests?</strong></li>

    <li class="calibre13"><strong class="calibre14">It’s very hard to perform with legacy code</strong></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">I already know how to write a testable code, TDD will not really improve my design</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">We’ve got enough quality and we’re doing fine without TDD</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">My manager won’t let me do TDD</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html">There’s no “scientific proof” and enough research on whether TDD really provides a return of investment</a></li>
  </ol>

  <p class="calibre2">The ones I’m gonna talk about today are the one marked with <strong class="calibre14">strong text</strong>. Let’s go then!</p>

  <h3 class="sigilnotintoc">4. We don’t have the necessary skills or experience</h3>

  <p class="calibre2">This is a valid impediment. However, its a common one in any skill. You see, it’s an extremely rare situation that someone is proficient using a technique for the first time (think of the times when you learned how to use a keyboard and a mouse). Most techniques require some time and knowledge to master - the same is with TDD. Let’s say that TDD is like a flower, where the core is the “Red-Green-Refactor” cycle and there are a lot of petals - good practices and heuristics. These include: need-driven design, triangulation, mocking, listening to tests etc.</p>

  <p class="calibre2">Thankfully, lack of skills can be dealt with by providing training, mentoring, books, doing katas, randoris and by the teams drawing conclusions out of their own experience. In other words, this is a temporary obstacle. Of course, together with staff rotation in your team comes the need to renew part of the investment in skills, knowledge and experience.</p>

  <h3 class="sigilnotintoc">5. We don’t have the necessary tools</h3>

  <p class="calibre2">This too is a valid impediment. TDD is a kind of process that can be made a lot easier with tools. There are many areas where tools can improve the overall performance with TDD. These include:</p>

  <ol class="calibre12">
    <li class="calibre13">Code navigation</li>

    <li class="calibre13">Running unit tests</li>

    <li class="calibre13">Automated refactoring</li>

    <li class="calibre13">Code Analysis</li>

    <li class="calibre13">Quick fixes (like “generate method signature from its use)</li>

    <li class="calibre13">Continuous Testing</li>

    <li class="calibre13">Code generation</li>
  </ol>

  <p class="calibre2">…etc.</p>

  <p class="calibre2">If the issue is “money related” (e.g. there are tools on the market, but hey have to be bought), then the management should consider buying the best tools that are on the market and are available within the company budget. Thus, it’s always good to have management buy-in for TDD. Thankfully, most of these tools (excluding the ones related to continuous testing) give a performance boost regardless of whether someone is using TDD or not, so many teams have such tools anyway.</p>

  <p class="calibre2">If the issue is “technology related” (there are no tools on the market that work well with the technology your team is using), the good news is that TDD is usable even without these tools and still provides a lot of its benefits, since it is about analysis, design and specification. The tools only (well, “only” :-)) help in keeping focus and go faster through the whole cycle.</p>

  <h3 class="sigilnotintoc">6. (This one is unit testing specific) There are already other kinds of tests, we don’t need unit tests?</h3>

  <p class="calibre2">Although TDD is not solely limited to unit-level specs/tests, they form a crucial part of it. While some people believe that we can skip higher level specs in TDD, there’s no one I know who says you can skip unit level.</p>

  <p class="calibre2">Anyway, let’s get to the point. this objection is based on a premise that TDD is about testing and “unit tests” produced with it are merely another kinds of tests. When I hear people raising this argument, they talk a lot about coverage, defect discovery, strengthening the testing net etc. Such arguments, for the most part, miss the point, since they ignore the biggest benefits of TDD which do not lie in its testing aspect (which I already discussed).</p>

  <p class="calibre2">Dealing with such objections is really hard, because it requires others to accept a different point of view than the one they kept believing in so far. Sure, the <a href="http://www.growing-object-oriented-software.com/">books</a> and <a href="http://martinfowler.com/bliki/SpecificationByExample.html">authorities</a> are on your side, but hey, the guys that read books and listen to authorities don’t usually need convincing! So what to do in such case?</p>

  <p class="calibre2">Remember, this argument is usually raised in teams that don’t even do unit testing, let alone TDD. The following options are available:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Point the opponents to the blog posts and literature</strong> - be careful with this. If you do it wrong, the other side may take it as questioning their professionalism. Also, they may just question the authorities you believe in - this is rather easy in software engineering world - they can just say “that doesn’t convince me at all” and the game is over. You have to somehow show that you’re passionate about TDD and point at such sources as to something that made you passionate. In other words, if you want to lead someone out of their biases, tell them that you too were led out before them and tell them how. This leaves them in a position of “look, there’s a way to do things better” instead of “you’re all idiots and only I know the truth”. I’m hardly an expert on this matter, however, there are <a href="http://www.infoq.com/interviews/Linda-Rising-Fearless-Change">some “change patterns” that are worth checking out</a>.</li>

    <li class="calibre13"><strong class="calibre14">Talk about your experiences</strong> from your previous projects if you have any or bring someone else if you don’t. There are not many arguments as convincing as “I have experienced it myself”, especially to the guys that don’t have any experience in a certain field and are in a process of evaluating whether it makes sense to enter this field. Also, some people are more convinced by “soft” arguments (“we did it like this before and everybody in the team said that they feel in improvement in their coding style as never before”), while others are better convinced by “hard” arguments (“we did it like this before and we were able to get the best results of code complexity analysis in the whole project plus we were able to demonstrate a print out of documentation of 40 pages that just came out for free as we did TDD.”). Also, better than words are living proofs (“you can just ask those guys I worked with and they show you what our living documentation looks like” or “Just ask the guys that were there with me on how they feel about it”).</li>

    <li class="calibre13"><strong class="calibre14">Create an internal training</strong>. This has one big advantage and two small disadvantages. The advantage is that you have a lot of time (at least longer than on regular meetings) to lead people by hand through your argumentation, reasons, examples and so on. In other words, you’re given a chance to give more full explanation of the idea. The first disadvantage is that usually you get to prepare for such training in your free time (since management usually approves only spending time on giving the training, not on preparing it). The second disadvantage is that the people that you want to convince can simply ignore the invitation to the training and not attend at all or (if they’re forced to attend) they can spend the whole training doing their stuff on their laptops.</li>
  </ol>

  <h3 class="sigilnotintoc">7. It’s very hard to perform with legacy code</h3>

  <p class="calibre2">The version of this objection that I find valid is: “It’s harder to perform with legacy code”. Why? Because TDD requires the code to have a quality called “testability”. Legacy code doesn’t usually have it. Thus, the code has to be refactored, risking breaking something that already works (if you know how to do this, then the risk is significantly lower, but there’s still some risk). On the other hand, there is this temptation to just “insert a little if clause right in the middle of this mess and be done with”.</p>

  <p class="calibre2">Anyway, the strategy to deal with this objection is to somehow make is clear that it’s either “we don’t have the necessary skills” or “we don’t have the necessary tools” objection, just dressed differently. In the first case, take a look at the following books:</p>

  <ol class="calibre12">
    <li class="calibre13">Refactoring by Martin Fowler</li>

    <li class="calibre13">Dealing Effectively With Legacy Code by Michael Feathers</li>

    <li class="calibre13"><a href="http://mikadomethod.org/">Behead Your Legacy Beast. Refactor and Restructure Relentlessly With The Mikado Method</a> (free e-book) by Daniel Brolund and Ola Ellnestam</li>
  </ol>

  <p class="calibre2">and in the second case, talk to your boss and make sure that your team has the tools it needs.</p>

  <h3 class="sigilnotintoc"><a href="http://feelings-erased.blogspot.com/2013/01/test-driven-development-objections-part.html" class="calibre30">Part 3</a> is already published! Go ahead and read it!</h3>

  <p class="calibre2">In the meantime, I’ll be happy to hear your comments. I’m not an oracle and would gladly learn more about what objections do people receive and how they dispel them.</p>
</div>


<div class="calibre4" id="calibre_link-20">
  <p class="calibre2">Welcome to part 3 of my post about TDD objections. Today’s gonna be the last part of my comments on common objections to TDD. Again, I’m not an expert on these things - I’m merely writing down my thoughts and experiences, so any comment is appreciated! I’d love to know your objections or which ones you’re most often getting into, how you deal (or dealt) with them etc.</p>

  <h3 class="sigilnotintoc">Where did we leave the last time?</h3>

  <p class="calibre2">Ok, let’s take on the next set of objections from the list:</p>

  <ol class="calibre12">
    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">Not enough time</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">TDD will slow us down, because we’ll have to create a lot of additional code</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part.html">TDD will slow us down, because we’ll have to maintain a lot of additional code</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">We don’t have the necessary skills or experience</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">We don’t have the necessary tools</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">(This one is unit testing specific) There are already other kinds of tests, we don’t need unit tests?</a></li>

    <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/12/test-driven-development-objections-part_30.html">It’s very hard to perform with legacy code</a></li>

    <li class="calibre13"><strong class="calibre14">I already know how to write a testable code, TDD will not really improve my design</strong></li>

    <li class="calibre13"><strong class="calibre14">We’ve got enough quality and we’re doing fine without TDD</strong></li>

    <li class="calibre13"><strong class="calibre14">My manager won’t let me do TDD</strong></li>

    <li class="calibre13"><strong class="calibre14">There’s no “scientific proof” and enough research on whether TDD really provides a return of investment</strong></li>
  </ol>

  <p class="calibre2">The ones I’m gonna talk about today are the one marked with <strong class="calibre14">strong text</strong>. Let’s go then!</p>

  <h3 class="sigilnotintoc">8. I already know how to write a testable code, TDD will not really improve my design</h3>

  <p class="calibre2">Personally, I know several engineers who actually learned how to write testable code without TDD. They usually added unit tests after code and, over the time, learned to structure the code in such a way that it allows dependency injection, contains small number of private methods etc. If your mates are on this level, it’s really not that that bad! However, I observed few deficiencies of such approach when compared to TDD:</p>

  <ol class="calibre12">
    <li class="calibre13">It is actually harder to learn how to write testable code without TDD. Also, many hours are wasted on refactoring before one grasps how to do it. In TDD, testability is built-in. So why choose the hard way?</li>

    <li class="calibre13">Test-first is often referred to as an “analysis step”. You get the chance to take a step back and analyze what should the work-flow be, which behaviors have to be supported etc. Sure, one can use <a href="http://www.netobjectives.com/resources/programming-intention">programming by intention</a> to design classes and methods in an outside-in fashion, but when coding, you always see just the current method, or the current statement. In contrast, the unit spec/test forces you to consider whole class from object creation through invoking triggers up to getting a response. This perspective is more useful for analysis (and design) purpose and it is retained each time a new unit-level spec is written.</li>

    <li class="calibre13">The benefits of using TDD as a design-aiding tool are not only that you make testable classes that allow dependency injection. The benefits are also in making you focus on just what you actually need, without bothering you with what you don’t. In TDD, you state your expectations one at a time, striving for the simplest solution. This leaves less room for over-generic, “just-in-case”, framework-like overdesigned structures. Now, don’t get me wrong, generic designs are a great and even necessary where genericity is needed and well justified, however, I believe that overdesign is almost as bad as underdesign.</li>

    <li class="calibre13">There are <a href="http://feelings-erased.blogspot.com/2012/05/test-first-why-is-it-so-important-in.html">other things</a> I have already written about that tend to happen in test-after approach</li>
  </ol>

  <h3 class="sigilnotintoc">9. We’ve got enough quality and we’re doing fine without TDD</h3>

  <p class="calibre2">This was actually responded to by James Grenning <a href="http://www.renaissancesoftware.net/blog/archives/356">on his blog</a> and the response is so good that I have really nothing to add. Go read it.</p>

  <h3 class="sigilnotintoc">10. My manager won’t let me do TDD</h3>

  <p class="calibre2">Putting things this way is usually a mental shortcut that might mean different things depending on the context. The most literal interpretation (like receiving a direct order not to do TDD) is almost never the case.</p>

  <p class="calibre2">Sometimes, this is merely an excuse. Putting the blame or responsibility on the supervisor is one of the most popular ways of saying “I want someone to take the responsibility instead of me” and may be an example of <a href="http://scottberkun.com/2007/asshole-driven-development/">Cover Your Ass Engineering</a>.</p>

  <p class="calibre2">Let me share with you my experience on the topic: in my first project, I thought my boss won’t allow me to refactor. But I did - and in the end, no one questioned. In my second project, I thought my boss won’t allow me to use smart pointers. But I did - and I was thanked for this. In my third project, I thought my boss won’t allow me to use mock objects. But I did - and it was recognized. What’s the moral? It’s that often it is you who has the authority to make technical decisions. when you put responsibility on people who don’t have the authority, they will hold back - this is natural. So go ahead, make the decision and take the responsibility. If it ends with success, take the gratitude. If it fails, take the blame. That’s the best way to achieve something.</p>

  <p class="calibre2">Sometimes, such complaint may also mean lack of support. In such situations, you can try out two steps that I know help dealing with this:</p>

  <ol class="calibre12">
    <li class="calibre13">Build your position - either internally (within the company) or externally (within the wider community) or both. This can be done by participating in open source projects, creating a blog, taking part in conferences, organizing trainings etc. When you are recognized in the community as an expert, your authority rises and people will get persuaded by you more easily.</li>

    <li class="calibre13">Instead of hoping your boss will create a plan and make you a part of it, create your own plan and show your boss how he can be a part of it. Show your boss what you want to achieve and what you need from them in order to be able to achieve this.</li>
  </ol>

  <p class="calibre2">This whole section put in short is: “you’re the one in charge. Believe it!”.</p>

  <h3 class="sigilnotintoc">11. There’s not scientific proofs and enough research on whether TDD really brings any benefits</h3>

  <p class="calibre2">Oh really…</p>

  <p class="calibre2">Let’s put it this way - I could really try to convince somebody by listing the references, trying to analyze them, pick some arguments etc. and wait for the other person to say “Ok, I’m convinced” instead of something like “that doesn’t convince me, because my case is special and these things do not apply”. I could really try and do this.</p>

  <p class="calibre2">But I won’t. Why?</p>

  <p class="calibre2">I won’t, because I think this argument is usually raised in highly unfair ways. Ever wondered why anybody needs scientific proof for TDD while they didn’t need any for daily stand-ups or four-week sprints, or retrospectives or any other agile or non-agile practices they’ve already incorporated? Can they show you the scientific research that led them to adopt all these techniques and methodologies?. If so, THEN let’s talk about scientific proof for TDD (and it may be a very fruitful discussion). Otherwise, no.</p>

  <p class="calibre2">From my observation, the “need for scientific proof” arises when someone simply doesn’t want to adopt TDD and is using this argument as a mean to say “I don’t wanna do this, unless you prove me that I have no other choice”. There may be some reasons why this person doesn’t want to try out TDD and they may be VERY good (and worth discussing), but the “scientific proof” argument itself is usually a facade.</p>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">This article ends the series of my comments on common TDD objections. At least for now. I hope you had as much fun reading this as I had writing.</p>

  <p class="calibre2">See ya!</p>
</div>


<div class="calibre4" id="calibre_link-3">
  <p class="calibre2">Thanks go to Kuba Miara for inspiration.</p>

  <p class="calibre2">Last time I was debating my colleague on pros and cons of TDD, I made a mistake. I stressed too much that TDD is good, because it quickly shows you when the design is wrong and punishes you for not writing clean, properly encapsulated code. I did not talk so much about the support TDD provides, just about the punishment. By doing this, I got two counterarguments. Both of these are interesting and worth discussing. Today, I’d like to tackle the first one.</p>

  <h3 class="sigilnotintoc">Teaching by punishment is too harsh.</h3>

  <p class="calibre2">The argument was like this: “If TDD is so demanding, it will be hard for people to satisfy these demands. There are better and worse developers. Some people are having hard times writing good code, now they would need to know how to do it plus how to write good unit tests. Since the latter is a challenge on its own, they’re just gonna pay double.”. This is a vision of TDD as a “strict teacher”, that only makes demands and punishes you severely, when you’re unable to make it. This is also a vision of a “bad teacher” that ONLY makes demands and it’s the only kind of help it can provide.</p>

  <p class="calibre2">This, however, is not true. <strong class="calibre14">TDD is a good teacher</strong>. How do you recognize a good teacher? Such teacher would:</p>

  <ol class="calibre12">
    <li class="calibre13">tell you when you’re getting things wrong.</li>

    <li class="calibre13">support you in getting things right.</li>
  </ol>

  <p class="calibre2">In TDD, the first is achieved by using various heuristics when looking at unit tests. If you’re doing things wrong, your unit tests will tell you this (<a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-first-post.html">Amir and Scott have a nice summary</a> <a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-second-post.html">in two parts</a> of these heuristics). Now I’d like to concentrate more on the “supportive” stuff that I kind of missed during the original discussion - there are various ways TDD can <strong class="calibre14">support</strong> you in doing the right thing(TM). Among these things are:</p>

  <dl class="calibre2">
    <dt class="calibre16">Need Driven Design</dt>

    <dd class="calibre17">helps in discovering new classes, methods and collaboration models as well as gaining high encapsulation and outside-in insight into your code (crafting method signatures from the view of their concrete usage, not from the top of your head), at the same time providing you a way to be more “lean” and write only the code you really need. I will do a separate post on Need Driven Design soon.</dd>

    <dt class="calibre16">Test First</dt>

    <dd class="calibre17">helping in many thing, but this time I’d like to stress that it lets you create classes with high testability by default - since you’re writing the test before the code, you design the production code with testability in mind and it brings with itself stronger cohesion and encapsulation plus looser coupling.</dd>

    <dt class="calibre16">Given When Then Analysis</dt>

    <dd class="calibre17">helps you to think about the code in terms of behaviors, discover holes in requirements, prioritize the implementation and enables deliberate discovery of new behaviors the system must support.</dd>

    <dt class="calibre16">TODO list</dt>

    <dd class="calibre17">helping you in keeping track of the things left to specify, refactor and implement, so that you can know when you’re done. Additionally, TODO list helps you in keeping focus on single behavior at once (“hmm, here, I’m passing two strings, but what if the first one is null? I’ll just add it to TODO list and get to it after I specify current behavior”). Kent Beck’s Test Driven Development By Example provides some good examples on how to work with TODO lists.</dd>

    <dt class="calibre16">Triangulation</dt>

    <dd class="calibre17">useful when driving implementation of a piece of code we don’t have an idea how to implement. By specifying example after example of how we expect a single behavior to work from the outside and refactoring each time into something more general, we gradually gain understanding of the problem and drive towards the right implementation.</dd>
  </dl>

  <p class="calibre2">Each of these tools that come “bundled” with TDD has its own set of best practices that can make even a mediocre developer write good code quickly. There is only one requirement: motivation.</p>

  <p class="calibre2">Ok, that’s it for now, in the next post, I will try to discuss the second part of the argument. See ya!</p>
</div>


<div class="calibre4" id="calibre_link-15">
  <p class="calibre2">This post is going to be mostly about seeing TDD in a larger picture and is mostly inspired by some materials by Ken Pugh on Acceptance Test Driven Development (although it does not exactly echo Ken’s opinions).</p>

  <h3 class="sigilnotintoc">What is a requirement?</h3>

  <p class="calibre2">Imagine you’ve got technical requirements, one of which looks like this:</p>

  <div class="calibre31">
    All incoming e-mail messages that are directed to recipient called emergency@my.mail.com shall be broadcasted to all accounts in the my.mail.com domain
  </div>

  <p class="calibre2">Here, the technical requirement defines a special emergency e-mail address that may be used as a kind of emergency notification mechanism (like when an error occurs on your website). What’s usually expected from the development team is to take this requirement and implement, so that the requirement is fulfilled. In other words, this is a request to perform an amount of work.</p>

  <p class="calibre2">But <strong class="calibre14">how do you know that this amount of work needs to be performed</strong>? <strong class="calibre14">How do you know that you need to state such a requirement and send it to the development team</strong>?</p>

  <p class="calibre2">Let’s stop for a minute and consider these questions. Thinking about it, we can arrive at the following hypothetical situations:</p>

  <ol class="calibre12">
    <li class="calibre13">A customer (be it business representative or real end-user) is familiar with another system, where such notification mechanism worked and worked well. Going to our system, he expects it to have a similar functionality. However, in a situation when he expects an emergency to be communicated to all staff, nothing happens.</li>

    <li class="calibre13">A customer is familiar with our system and knows what it can and cannot do. He comes up with an idea that having such feature would greatly increase visibility of website errors, and recognizes that up to now, the system does not implement it.</li>

    <li class="calibre13">A customer not familiar with our system reads a user manual and discovers that this kind of functionality, which he knows he’ll need, is not described in there, so looks like it does not exist.</li>

    <li class="calibre13">A customer is about to buy our system and as one of the feature he wants the system to support, he mentions emergency notification solution, but the sales representative tells him that the system does not support this kind of functionality</li>
  </ol>

  <h3 class="sigilnotintoc">Test-first</h3>

  <p class="calibre2">We can imagine that one of the situations described above may have led to this new requirement being specified. But what are these situations? Let’s try to rephrase them a little, adding a small comment in braces after each one that should clear the situation a bit:</p>

  <ol class="calibre12">
    <li class="calibre13">A customer leads to a situation where he expects everybody to be notified of the emergency situation, but they’re not notified <span class="calibre32">(FAIL)</span>.</li>

    <li class="calibre13">A customer searches his memory expecting to find the fact that our system implements the feature, but cannot find the fact because it’s not true <span class="calibre32">(FAIL)</span>.</li>

    <li class="calibre13">A customer expects the user manual to contain information that such a feature exists, but the manual says that it doesn’t <span class="calibre32">(FAIL)</span>.</li>

    <li class="calibre13">A customer expects the sales representative to tell him that their system supports the desired feature, but the representative tells him otherwise <span class="calibre32">(FAIL)</span></li>
  </ol>

  <p class="calibre2">Yes, you’ve guessed it - these are tests! Well, maybe not JUnit/NUnit/Rspec/whateverUnit tests, but they’re tests anyway. What’s more, they’re tests that fail, which makes us “repair” this “failure” by providing a technical requirement and then implementing it.</p>

  <h3 class="sigilnotintoc">What got lost?</h3>

  <p class="calibre2">Also, note that the tests tell nothing about e-mail and the broadcast address - they tell us that our customer expects everybody to be notified of emergency situation. The e-mail part is what’s been added in the requirement. At the same time, another piece of information was dropped by translating test into technical requirement - the user’s intention.</p>

  <p class="calibre2">It’s because this requirement was <strong class="calibre14">HOW</strong> the user expectation should be satisfied.</p>

  <p class="calibre2">The sad part is that, although these tests contain some information that got “lost in translation” to technical requirements, usually such tests are never even stored, not mentioning automating them (which, in some cases, could be possible).</p>

  <p class="calibre2">There are two important lessons to learn from this story:</p>

  <ol class="calibre12">
    <li class="calibre13">It’s a pity that we don’t value the tests that come before requirements</li>

    <li class="calibre13">It’s a pity that we can’t see that <strong class="calibre14">tests come first</strong>. If we could, it would let us understand better why unit-level Test Driven Development makes perfect sense, because it’s the same process of specifying what we expect to have, seeing it not fulfilled and then providing it.</li>
  </ol>

  <p class="calibre2">Ok, that’s it for today. Have fun!</p>
</div>


<div class="calibre4" id="calibre_link-10">
  <p class="calibre2">Thanks to Mark Mishaev for inspiration.</p>

  <p class="calibre2">Sometimes, I hear that someone is trying to start off with unit testing or TDD and they ask me for some good advice on where to start - some general guidelines that would help them along the way. I thought I’d summarize my usual answer here for everyone to benefit from.</p>

  <p class="calibre2">So, if you’re starting off with unit testing or TDD, here’s my advice:</p>

  <ol class="calibre12">
    <li class="calibre13">Read at least these blogs to grasp some good practices:

      <ul class="calibre33">
        <li class="calibre13"><a href="http://sustainabletdd.com">Sustainable Test Driven Development by Amir Kolsky and Scott Bain</a></li>

        <li class="calibre13"><a href="http://feelings-erased.blogspot.com">My own blog</a></li>

        <li class="calibre13">There are some other good ones, just look around, I recommend blogs by Steeve Freeman, Roy Osherove, Dan North, Liz Keogh, Robert C. Martin, James W. Grenning, Kent Beck, Mark Seemann, James Newkirk…</li>
      </ul>
    </li>

    <li class="calibre13">Pick up some books on the subject. The topic of unit testing and TDD might seem straightforward (there are a lot of simplifications around, such as “unit test is just a small code that creates a class, invokes a method and performs assertions on its output” and “TDD means you write your test first, then write the code”), but it actually requires quite a bit of knowledge to get things right. Also, don’t limit yourself to a single book - read at least three or four - many TDD gurus have more or less different styles of doing TDD and writing unit tests and your own technique will get more and more flexible as you manage to understand more of them.</li>

    <li class="calibre13">Try writing your tests first. For a list of benefits, take a look at:

      <ol class="calibre34">
        <li class="calibre13"><a href="http://www.sustainabletdd.com/2012/03/importance-of-test-failure.html">The importance of test failure</a></li>

        <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/05/test-first-why-is-it-so-important-in.html">Test First - why is it so important?</a></li>
      </ol>
    </li>

    <li class="calibre13">For new code, try to follow <a href="http://www.jmock.org/oopsla2004.pdf">Need Driven Development</a></li>

    <li class="calibre13">To drive your code and design, try exposing yourself to “diagnostic pain”. This means putting some limitations onto yourself and when you’re tempted to break them, it means that the code or design is at fault and you should refactor. To give you a quick example, I do not use Setup and TearDown kinds of methods in unit tests (not mentioning Action Attributes from NUnit), which means all the objects used in the unit test are created in the body of the test method itself. I sometimes use helper methods when they improve readability and understandability of the test (but not to hide redundancy - that’s the catch). At first it might look awkward, but I have created a lot of unit tests without Setup and Teardown and I’m very happy with the result. So it’s not like I don’t know how to use a unit testing framework - I deliberately hold back from using many of its features</li>

    <li class="calibre13">Ideally, a maintainable unit test has to fulfill three conditions, as <a href="http://www.netobjectives.com/resources/webinars/sustainable-tdd">pointed by Scott Bain</a>:

      <ol class="calibre34">
        <li class="calibre13">It fails reliably when behavior specified by it is broken</li>

        <li class="calibre13">It fails only when behavior specified by it is broken (so breaking another behavior should not break this test)</li>

        <li class="calibre13">No other unit tests will fail when behavior described by this test is broken</li>
      </ol>This is the ideal - try to keep as close to it as possible.
    </li>

    <li class="calibre13">Try using a technique called <a href="http://blog.ploeh.dk/2009/03/05/ConstrainedNonDeterminism.aspx">Constrained Non-Determinism</a>. You can either use tools that help with this (like AutoFixture for C#) directly, or you can wrap it in your own class (if you’re reading my blog, you probably know that I like to wrap creating anonymous values in a class called Any). Alternatively, just roll out your own mini library or a set of functions.</li>

    <li class="calibre13">Use continuous testing tools, (examples for .NET include <a href="http://continuoustests.com/">Mighty Moose</a> (free) or <a href="www.ncrunch.net">NCrunch</a> (paid)) for running your unit tests. If no such solution exists for your programming language of choice, you can always write a script that performs continuous compilation and running unit tests and lets you know of the results. There are some tools like Watchr that can make writing such scripts easier (especially when integrated with your operating system’s default user notification mechanism).</li>

    <li class="calibre13">
      <a href="http://feelings-erased.blogspot.com/2012/09/what-is-scope-of-test-in-tdd.html">Always specify class behaviors</a> (not methods or classes) with unit tests &ndash; to help you with this, try using the following convention of naming your tests: ShouldXYZ() where XYZ is the description of the behavior the class should supply. The convention is taken from <a href="http://dannorth.net/introducing-bdd/">Dan North’s post</a> and helps to avoid:

      <ol class="calibre34">
        <li class="calibre13">Check-it-all unit tests &ndash; where one does a single setup and verifies multiple behaviors.</li>

        <li class="calibre13">Names that do not make sense. I saw one a unit test named: SendFrameMethodSendsFrame() which tells almost nothing about the behavior. The “Should” naming forces us to rethink the name and come up with something like: ShouldPassReceivedValidFrameThroughTheMessageQueue() which works better.</li>

        <li class="calibre13">Also, pick names that read well when converted from “ThisNamingConvention” (or “This_naming_convention” - whatever you choose to apply to your unit test methods) to “this naming convention” &ndash; it lets you use the unit test results report in Cruise Control or Jenkins as a living documentation of your code after you apply a little post-procesing to it.</li>

        <li class="calibre13">You can look at <a href="http://feelings-erased.blogspot.com/2012/07/if-you-treat-your-unit-tests-like.html">my blog post that discusses the repercussions of bad naming</a>.</li>
      </ol>
    </li>

    <li class="calibre13">When choosing a mocking framework for your project, put your money on ease of use and readability. For example, many mocking frameworks for C# use lambda expressions everywhere, but many programmers are still not used to thinking in terms of expressions and are a bit confused. When developers find using such framework awkward, they’re more likely to reject the idea of unit testing or TDD. Thus, as a main mocking framework, I like to choose NSubstitute.</li>

    <li class="calibre13">Always keep handy a “fallback mock framework” - there are some features that your main mocking framework of choice does not support or that are difficult to achieve using this framework. For example, NSubstitute does not yet support partial mocks. That’s why it’s good to have a secondary mock framework of choice that can make up for the main one’s weaknesses in some rare cases. For such a fallback mock framework, I like to use Moq, but that may as well be FakeItEasy or Rhino Mocks or something else - depending on what you need.</li>

    <li class="calibre13">Try to stay as close as possible to <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">SOLID principles</a> and adhere to the Law Of Demeter (which is a conclusion from those principles, specifically - from Open Closed principle) &ndash; all of this lets you write better, more focused and more maintainable unit tests. For a list of smells that show the problem is in the design rather than in tests, see:

      <ol class="calibre34">
        <li class="calibre13"><a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-first-post.html">Test Reflexology - part 1</a></li>

        <li class="calibre13"><a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-second-post.html">Test Reflexology part 2</a></li>

        <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/07/tdd-and-single-responsibility-principle.html">TDD and Single Responsibility Principle</a></li>

        <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/08/mocking-method-chains-part-1-when-not.html">Mocking method chains, part 1: when not to</a></li>

        <li class="calibre13"><a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills_25.html">A kata challenge to try your TDD skills on - failure and what we can learn from it</a></li>
      </ol>
    </li>

    <li class="calibre13">Watch out for unit tests execution times &ndash; unit tests that run for more than 2-3 seconds (to tell you the truth, many should even run in less than one second), almost always have a smell attached to them &ndash; either they touch external resources or are not unit tests. Staying away from external resources may be tricky. For one such example where this actually does get tricky and one may be tempted to break the isolation, see my <a href="http://feelings-erased.blogspot.com/2012/06/mock-operating-system-timers-example.html">example related to timers</a></li>

    <li class="calibre13">Avoid the “The code is so straightforward that there’s no need to test it” thinking. When the code is complex, the solution is refactoring, not unit-testing (of course, tests can be written, but they have to be used <a href="http://www.objectmentor.com/resources/articles/WorkingEffectivelyWithLegacyCode.pdf">as coverings</a>). Unit tests are about specification, not coverage, and short specifications are good.</li>

    <li class="calibre13">Perform a kata or two on your own. <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills.html">One such kata</a> and <a href="http://feelings-erased.blogspot.com/2012/10/validation-kata-better-implementation.html">its exemplary solution</a> are posted on this blog</li>

    <li class="calibre13">There may be a temptation to write more coarse-grained tests/specifications that are tied to the code (they’re sometimes called white-box tests). This is possible, however, I recommend not to do it if it’s not very well thought. I’ve been in projects where coarse-grained, so called “white-box tests” led to situations where correcting and debugging the tests took twice as long as changing the code. Again, it’s possible to write good coarse-grained tests, it just that it’s hard &ndash; it requires reading some books and doing few dry runs to grasp many best practices that are different than in case of unit tests. On short discussion of how things may go wrong, be sure to look at my post: <a href="http://feelings-erased.blogspot.com/2012/05/perfect-from-start.html">Perfect from the start</a>.</li>

    <li class="calibre13">Also, there may be a temptation to “test private methods”. This is a sign that things are going <a href="http://feelings-erased.blogspot.com/2012/06/how-to-test-private-methods.html">a little bit offroad</a>.</li>

    <li class="calibre13"><a href="http://www.sustainabletdd.com/2011/12/lies-damned-lies-and-code-coverage.html">Attaining X% code coverage should not be a goal</a>. High coverage is good when it’s a side effect.</li>
  </ol>

  <p class="calibre2">I could go on writing, but I think these are the most important, non-obvious things I learned throughout my adventure with TDD. As always, feel free to add your advice in the comments.</p>

  <p class="calibre2">See ya!</p>
</div>


<div class="calibre4" id="calibre_link-23">
  <p class="calibre2">Hi, today, I’d like to outline few differences between a technique called Programming By Intention and Test-Driven Development. I’m currently halfway through <a href="http://www.netobjectives.com/resources/books/essential-skills-agile-developers">Essential Skills For The Agile Developer</a> and the chapter on <a href="http://www.netobjectives.com/files/books/esad/essential-skills-programming-by-intention.pdf">Programming By Intention</a> made me revisit this fine technique and think it over again, especially in comparison to Test-Driven Development.</p>

  <h3 class="sigilnotintoc">What’s Programming By Intention?</h3>

  <p class="calibre2">On the book’s page you can get the chapter on Programming By Intention for free and read it, but for those of you that like summaries - it’s an outside-in approach to writing methods, that makes a distinction between so called “Sergeant” methods and “Private” methods. A “Sergeant” is a method that has the single responsibility of describing a high-level workflow and it delegates all the implementation details to “Private” methods. When beginning to write a piece of code, you start with a “Sergeant” and pretend that all the methods it needs to call already exist (although they usually don’t). A simplified example of a “sergeant” for logging-in logic would be something like this:</p>
  <pre class="calibre10">
public string LogIn(string userName, string password)
{
  string homePage = GetHomePageAddress();
  string loginPage = GetLoginPageAddress();
  string response = GetDefaultResponse();

  if(AreCredentialsValid(userName, password))
  {
    response = GetResponseWithSuccessfulLoginMessage();
    RedirectTo(homePage);
  }
  else
  {
    response = GetResponseWithLoginErrorsFor(userName);
    RedirectTo(loginPage);
  }
  return response;
}
</pre>

  <p class="calibre2">As you can see, in the above example, we’re passing what we can as method parameters instead of relying on fields. Also, there are almost no operators (even “new” and object access operator “.”) - they’re hidden inside the “private” methods to whom we delegate the work. These methods don’t exist yet - we’re just imagining how they should look to fit our needs. The next step is to generate skeleton bodies for “privates” (preferably using an IDE) and fill them in one by one (Of course, a “private” for this method might also be a “sergeant” with its own “privates”). A simple implementation example of a private method might look like this:</p>
  <pre class="calibre10">
private string GetResponseWithLoginErrorsFor(string userName)
{
  return userName + " could not login. Invalid credentials";
} 
</pre>

  <p class="calibre2">Programming By Intention produces code that is very readable - every work-flow step has its domain-specific name. Also, this technique is so powerful, because it separates specification perspective from implementation perspective and, by doing so, leads to a very high method cohesion. Thus, for example, it’s very simple to refactor our exemplary “sergeant” later into something like this:</p>
  <pre class="calibre10">
public Response LogIn(
  UserCredentials userCredentials,
  Page homePage, 
  Page loginPage)
{
  Response response = Response.Default();

  if(credentials.AreValid())
  {
    response.SetUpWithSuccessfulLoginMessage();
    homePage.RedirectTo();
  }
  else
  {
    response.SetUpWithLoginErrorsFor(userName);
    loginPage.RedirectTo();
  }
  return response;
}
</pre>

  <p class="calibre2">and achieve class-level cohesion, although the decision whether to pay that cost right now or defer it for later is left to us. Thanks to this, Programming By Intention can be at best almost no-cost (in case of small programs that don’t need any maintenance in the future), while at worst allowing us to defer the cost for later while introducing minimal technical debt (in case of more serious pieces of software that need cohesion on every level).</p>

  <h3 class="sigilnotintoc">How does it relate to Test-Driven Development?</h3>

  <p class="calibre2">I must confess that this is the second most powerful technique I know for writing good and easy to read code, the only more powerful being Test-Driven Development. Whenever I am in a situation where for some reasons I cannot use TDD, I use Programming by Intention.</p>

  <p class="calibre2">Now, let’s examine the similarities between the two techniques first:</p>

  <ol class="calibre12">
    <li class="calibre13">Both are outside-in approaches (I’m talking here about the outside-in style of TDD, as it can also be used bottom-up, as e.g. Kent Beck prefers to use it), crafting APIs and method names from the perspective of their use</li>

    <li class="calibre13">Both are variants of the divide-and-conquer strategy</li>

    <li class="calibre13">Both are about specifying intention through code</li>

    <li class="calibre13">Both tend to lead to highly cohesive designs, although TDD demands both class-level and method-level cohesion, while Programming By Intention tends to demand method-level cohesion only (although class-level is easily achievable from there, as in the example above).</li>
  </ol>

  <p class="calibre2">Now for the differences. The main one in my opinion is that Programming By Intention looks at writing code from a perspective of a method, while Test-Driven Development looks from the perspective of a behavior. This means several things:</p>

  <ol class="calibre12">
    <li class="calibre13">When implementing a single method (as in Programming By Intention), one does not see the whole context of its usage - only this one method. On the other hand, in TDD, when writing a unit-level spec, it usually begins with object instantiation and ends with observable result (either returning a result or call collaborating object’s method)</li>

    <li class="calibre13">The method perspective also means that, when writing it using Programming By Intention, one has to consider the method as a whole - e.g. all required execution paths (ifs and elses) must be considered throughout the whole implementation process, since they’re all usually added in one go. On the other hand, in TDD one only worries about the current path he’s specifying with a test. Other paths are either already tied to other tests that will remind us when we unintentionally break them (so we don’t have to think about them anymore), or on our TODO list (so we don’t have to worry about them yet).</li>
  </ol>

  <p class="calibre2">The second point is, IMHO, really important. Few days ago, I finally watched <a href="http://skillsmatter.com/podcast/agile-testing/make-impact-not-software">a presentation by Gojko Adzic and Dan North</a> from BDD Exchange. Talking about accelerating Agile, Gojko and Dan stressed very heavily the importance of making a “measurable impact”. I think that, when scaled down, this idea aligns well with TDD. The “measurability” of the “impact” we make with our executable specifications can be considered in two ways:</p>

  <ol class="calibre12">
    <li class="calibre13">For a single specification: watching the <span class="calibre32">RED</span> to <span class="calibre35">GREEN</span> transition is an act of measuring the impact - reaching the <span class="calibre35">GREEN</span> phase means that you now have something that was not present yet during the <span class="calibre32">RED</span> phase.</li>

    <li class="calibre13">For a suite of specifications: the comparison of already implemented specs vs the ones left on the TODO list are a way to measure “how much of the impact” was already made vs what’s left.</li>
  </ol>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">Personally, I find many similarities between Programming By Intention and TDD, with Programming By Intention being lower cost (at least in the short run) and easier to learn, while TDD being more powerful and advanced. I dare to say that TDD is Programming By Intention on steroids. Also, I believe that learning Programming By Intention helps in in grasping mock-based Test Driven Development. Hence, if you are struggling with outside-in TDD using mocks, it’s a good idea to train Programming By Intention first.</p>

  <p class="calibre2">That’s all for today, I hope you liked it and see you soon!</p>
</div>


<div class="calibre4" id="calibre_link-32">
  <p class="calibre2">This post is about how TDD informs analysis and stimulates learning. We’ll go through a simple example and investigate rationale and mechanics of decisions taken.</p>

  <h3 class="sigilnotintoc">The boards starts empty</h3>

  <p class="calibre2">Let’s imagine we’re writing a virtual Kanban-like board (this is also called a ‘scrum board’ AFAIK). If you don’t know what a scrum board is: the board is used for task tracking and is split into vertical columns that represent task progress (like NOT STARTED, IN PROGRESS, DONE). It’s also split into horizontal categories that represent bigger units of work (often user stories) that the tasks belong to. We usually add a task to the story and watch it pass through the vertical columns until we reach the DONE state.<a href="http://www.mountaingoatsoftware.com/scrum/task-boards">You can read more on scrum boards if you’re unfamiliar with the topic</a>, however, what I’ve written here is enough knowledge to push forward with our example.</p>

  <p class="calibre2">There is only one issue: how to start? We could do proper requirements analysis or commonality-variability analysis or something along the way, but this time, let’s just start by writing a spec (AKA unit test). What’s the simplest behavior we can come up with? Let’s see… it would be:</p>

  <div class="calibre36">
    <p class="calibre2">The board should start off as empty.</p>
  </div>

  <p class="calibre2">This is written in plain English (we’ll investigate another notation in a second), but that’s enough to get us started. Using the above statement, we can put together the first spec:</p>
  <pre class="calibre10">
[Test]
public void ShouldStartOffClean ()
{
  var board = new ScrumBoard ();
  Assert.IsTrue (board.IsEmpty);
}
</pre>

  <p class="calibre2">The first time I wrote this spec, it seemed (wrongly, but that’s coming in a minute :-)) silly to me. Why? Because:</p>

  <ol class="calibre12">
    <li class="calibre13">It didn’t let me discover any new collaboration and any new abstraction other than ScrumBoard, which I already knew I was going to need.</li>

    <li class="calibre13">It verifies a public flag is set on the same object that is specified. It looks like cheating - we consider X did something when it tells us so</li>

    <li class="calibre13">It’s only a flag, nothing more. No domain logic is needed to implement it</li>

    <li class="calibre13">I can’t imagine this flag used anywhere in the application. Even when I write a GUI that displays the board, it’s unlikely that it’s gonna need to check whether the board is empty. In Scrum board domain, empty board is not a special condition of any kind and does not trigger any special behaviors or conditions.</li>
  </ol>

  <p class="calibre2">So, did we just waste our time here?</p>

  <h3 class="sigilnotintoc">Negative learning</h3>

  <p class="calibre2">Let’s hold our horses for a minute before deleting this spec and try to write this spec in a <a href="http://dannorth.net/introducing-bdd/">Given-When-Then</a> form:</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">GIVEN</strong> nothing</p>

    <p class="calibre2"><strong class="calibre14">WHEN</strong> a new scrum board is created</p>

    <p class="calibre2"><strong class="calibre14">THEN</strong> it should be empty</p>
  </div>

  <p class="calibre2">The Given-When-Then form has this nice capability that you can discover many things by simply negating what you already have (by the way, this is not the only way to proceed, but this is the one I want to show you). We can be smart about it, but for now, I suggest we take the brute force approach - we’ll go through each part of the behavior description and try to negate everything we can. We expect to run into some VERY obvious conclusions as well as find some jewels.</p>

  <h4 class="sigilnotintoc1">Assumptions: Given nothing</h4>

  <p class="calibre2">Here, we can make only one negation in the following form:</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">GIVEN</strong> NOT nothing</p>
  </div>

  <p class="calibre2">What is “not nothing”? It’s “something” :-). What can we learn from it? Not much. In fact, most of the app logic we’re going to write will rely on assumption that “there is something”. Nothing valuable, let’s move on</p>

  <h4 class="sigilnotintoc1">Trigger: When a new scrum board is created</h4>

  <p class="calibre2">Let’s start with negating the second part (the order doesn’t matter, it’s just that this part is more obvious):</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">WHEN</strong> a new scrum board is NOT created</p>
  </div>

  <p class="calibre2">What does it mean that the scrum board is not created? It’s the central abstraction of our domain, so what’s the point in not creating it? This may lead to a question: Is a scrum board the right abstraction? Maybe it would be more valuable to look at it as “a process”, not “a place”? I such case, a better abstraction would be “sprint” (which is represented by the board on the GUI level), not board. Let’s assume we decided to leave the “board” abstraction (although this thought is so valuable, that I’d probably add it to my TODO list to be able to revise my decision as the development goes on).</p>

  <p class="calibre2">A nice thought from such a stupid negation, don’t you think? Ok, let’s dig further by negating the first part:</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">WHEN</strong> a NOT new scrum board is created</p>
  </div>

  <p class="calibre2">What does it mean “NOT a new board”? I means “an old board”. Wait a minute, that’s INTERESTING! Let’s ask further question: what does it mean to “create an old board”? It rings a bell - it’s about “loading an old board”. Wait a minute! This is a perfectly valid use case, because no user would like the board to disappear when they turn off the app! As this is not the core functionality, while not letting our self esteem and enthusiasm about this discovery eat us, we add it to the TODO list for later and proceed with the next negation.</p>

  <h4 class="sigilnotintoc1">Outcome: Then it should be empty</h4>

  <p class="calibre2">Again, there is only one negation we can perform:</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">THEN</strong> it should NOT be empty</p>
  </div>

  <p class="calibre2">We thought knowing that the board is empty doesn’t help the app at all. But what about us? Does it help us learn anything? Let’s check it out by asking further question: when is the board not empty? The answer: when there is at least one task added. Yes, we discovered the next use case - adding a task. This looks like the next core functionality element we need!</p>

  <p class="calibre2">Let’s document this discovery with a Given-When-Then form:</p>

  <div class="calibre36">
    <p class="calibre2"><strong class="calibre14">GIVEN</strong> an empty board</p>

    <p class="calibre2"><strong class="calibre14">WHEN</strong> a new task is added to it</p>

    <p class="calibre2"><strong class="calibre14">THEN</strong> it should not be empty</p>
  </div>

  <p class="calibre2">And an executable specification:</p>
  <pre class="calibre10">
[Test]
public void ShouldNotBeCleanWhenTaskIsAdded()
{
  var board = new ScrumBoard();
  var task = Any.InstanceOf&lt;Task&gt;();
  board.AddNew(task);
  Assert.IsFalse (board.IsEmpty);
}
</pre>

  <p class="calibre2">Now THAT’S a discovery! Let’s quickly recap what we’ve learned here: we’ve learned that there is an abstraction called “Task” that can be added to the board by invoking the “AddNew()” method (which needs to be implemented: another item for the TODO list!). We’ve also got another Given-When-Then behavior description that we can analyze the same way as the first one. Shhh… I’ll tell you a secret: until now we’ve been proceeding asking question “What if not?”. Another useful question to ask is “What else?”, and we can apply it to the WHEN part by asking “What else happens when we add a task?”. But that’s another story.</p>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">What I tried to show you is how TDD can be often used to inform analysis. I’ve also tried to show how potentially pointless specs can help us learn more on our domain or ask the right questions about the domain. I’m not trying to say that TDD is a substitute for other analysis methods, such as commonality-variability analysis, but it sure adds much to your current toolset.</p>

  <p class="calibre2">Ok, that’s it, time for a walk :-). Bye!</p>
</div>


<div class="calibre4" id="calibre_link-26">
  <p class="calibre2">Today, I’d like to write a bit about different techniques for test-driving development. There are actually two of them which I’d like to discuss: Need-Driven Development and Triangulation. Part one is about NDD, Triangulation shall be covered in part two.</p>

  <h3 class="sigilnotintoc">Need-Driven Development</h3>

  <h4 class="sigilnotintoc3">History</h4>

  <p class="calibre2">Need-Driven Development is a term that’s less commonly used nowadays. It was coined in a paper <a href="jmock.org/oopsla2004.pdf">Mock Roles Not Objects</a>, but has since been somewhat abandoned. The authors of the mentioned paper wrote <a href="http://www.growing-object-oriented-software.com/">a book</a> later on and the term Need-Driven Development is missing from it. Anyway, the approach itself has not changed and is by far one of the most popular.</p>

  <h4 class="sigilnotintoc1">Description</h4>

  <p class="calibre2">Imagine you’re building a plane and the requirement for it is to transport a guy named John from Poland to US. Imagine you start with computer simulation (in a fake context) of putting a guy in the air - he would fall, the simulation says. Ok, so we need to put him on something - we introduce floor. But the floor would fall as well. So we need something to hold it in the air - we introduce engine. But we need to keep the balance in the air somehow - we introduce wings. And so on, and so on. This is the philosophy of NDD - start with the main thing you need without having anything and then figure out what else you need to do this and the figure out what this “else” needs…</p>

  <p class="calibre2">NDD is an outside-in approach to development using unit tests and mock objects that stand for the context which does not yet exist. This way, we start with what our current concrete object needs and shape its context (which is filled in by mock objects) based on those needs. So in this approach, mocks are used as a tool for discovering interactions - we’re free to shape the mocked interface anyway we like so that they’re best suited to interact with the concrete object we’re dealing with now.</p>

  <p class="calibre2">As the fathers of NDD <a href="http://jmock.org/oopsla2004.pdf">put it</a>:</p>

  <blockquote class="calibre18">
    <p class="calibre2">We use Mock Objects to let us write the code under test as if it had everything it needs from its environment. This process shows us what an object’s environment should be so we can then provide it.</p>
  </blockquote>

  <h4 class="sigilnotintoc1">Example</h4>

  <p class="calibre2">Let’s take as an example the case from <a href="http://feelings-erased.blogspot.com/2013/01/single-method-perspective-vs-single.html">my previous post</a>, which specified a simplified logic for logging in:</p>

  <ol class="calibre12">
    <li class="calibre13">When supplied credentials are valid, the Log-in process shall setup response as positive and redirect me to the home page</li>

    <li class="calibre13">When supplied credentials are invalid, the log-in process shall setup the response as negative and redirect me to the login page.</li>
  </ol>
  <pre class="calibre10">
[Test]
public void 
ShouldSetResponseAsPositiveAndRedirectToHomePageWhenPerformedWithValidCredentials()
{
  //GIVEN
  var response = Substitute.For&lt;Response&gt;();
  var validCredentials = Substitute.For&lt;UserCredentials&gt;();
  var homePage = Substitute.For&lt;Page&gt;();
  var loginPage = Substitute.For&lt;Page&gt;();
  var loggingIn = new LoggingIn(homePage, loginPage);
  validCredentials.AreValid().Returns(true);

  //WHEN
  loggingIn.PerformUsing(validCredentials);

  //THEN
  response.Received().SetUpAsSuccessful();
  homePage.Received().RedirectTo();
}
</pre>

  <p class="calibre2">The specification shows us that from the perspective of LoggingIn class, it’s most comfortable to describe its behavior in the context of collaborators like Response, Page and Credentials that provide certain services in the form of methods. Thus, we have discovered three new abstractions (along with some methods they need to provide), that don’t need to have concrete implementations in order to run specifications for LoggingIn class - we fill these abstractions with mocks, so that specs compile and run. When we’re finished describing the LoggingIn object, we can proceed with describing real implementations for all the discovered abstractions the same way we did for LoggingIn class (by the way, the specifications for LoggingIn are always based on mocks to provide behavior isolation - we never change mocks to real objects in unit specs).</p>

  <h4 class="sigilnotintoc1">Principles</h4>

  <p class="calibre2">These are the main principles of Need-Driven Development:</p>

  <ol class="calibre12">
    <li class="calibre13">Start the development from the outermost layer (i.e. the inputs) and dig deeper and deeper, layer by layer, reaching the boundaries of the application</li>

    <li class="calibre13">Derive how interfaces should look like from what their clients need them to provide</li>

    <li class="calibre13">Derive not only interfaces (method signatures), but also protocols (e.g. which behaviors of discovered abstractions are expected by the class in terms of which we discovered them and how they should be handled)</li>

    <li class="calibre13">Think of the application as a web of collaborating objects sending messages to each other</li>

    <li class="calibre13">Mock only the types you own - mocks are primarily design tools, not isolation tools (although the latter is still somewhat significant)</li>

    <li class="calibre13">Avoid getters, try to follow “Tell, don’t ask” advice most of the time</li>

    <li class="calibre13">Each test creates a need for either:

      <ul class="calibre33">
        <li class="calibre13">new implementation in the tested object</li>

        <li class="calibre13">new collaborator to appear</li>

        <li class="calibre13">new way of communicating with existing collaborator to appear (e.g. calling different method on a collaborator or a collaborator returning different result from already existing method)</li>
      </ul>
    </li>

    <li class="calibre13">Distinguish between <a href="http://feelings-not-erased.blogspot.com/2013/01/value-objects-are-lesson-i-keep.html">Value Types</a> and “objects”. Value types are merely a more intelligent and domain-oriented data, while “objects” are service providers.</li>
  </ol>

  <h4 class="sigilnotintoc1">Related Concepts</h4>

  <h5 class="sigilnotintoc4">Lean</h5>

  <p class="calibre2">The need-driven development is closely related to Lean principles for pulling value from demand rather than pushing it from implementation. Thus, following the NDD leads to writing only the necessary code and avoiding adding features that aren’t needed. This is because the only code that gets written is the one directly needed by code that already exists. The need for the first production code to exist are the acceptance tests, and those come directly from the customer. This way, NDD fits well into a cohesive <a href="http://www.leanblog.org/2010/12/lean-value-streams/">value stream</a>, starting with the customer and ending on the code itself. Thus, NDD is well aligned with lean principles.</p>

  <h5 class="sigilnotintoc4">“Needs interfaces” and “capabilities interfaces”</h5>

  <p class="calibre2">Another related concept is that of “Needs vs capabilities in interfaces”, coming from the book <a href="http://www.netobjectives.com/resources/books/essential-skills-agile-developers">Essential Skills for the Agile Developer</a>. One important lesson from it is to always design interfaces (e.g. method signatures) according to client needs and what the client would use. After the second client is introduced that needs a different interface to the same services, the way to go is to provide it with its own Needs Interface and extracting the common logic in so called Capabilities Interface that both of these Need Interfaces use. At that time, these Need Interfaces most often become mere adapters or facades to the more general interface. The lesson from the authors of Essential Skills for the Agile Developers is compatible with the NDD philosophy, guiding us in our design and refactoring attempts.</p>

  <h5 class="sigilnotintoc4">Programming by Intention</h5>

  <p class="calibre2">If you remember my post about <a href="http://feelings-erased.blogspot.com/2013/01/single-method-perspective-vs-single.html">Programming By Intention and how it compares to TDD</a>, then you probably already noticed the similarities between Programming By Intention and NDD. As a matter of fact, when I mentioned TDD in that post, I had NDD in mind.</p>

  <h4 class="sigilnotintoc1">Applicability</h4>

  <p class="calibre2">The technique is most useful when we have well-defined acceptance criteria and usually comes into play after creating and executing a failing acceptance test that defines the next increment of functionality we need to provide. Also, it’s easier to apply when we know the high-level work-flows the application needs to support (usually the case of enterprise systems). Then we discover lower-level work-flows that result from the higher-level work-flows and, layer by layer, we reach the boundaries of the system.</p>
</div>


<div class="calibre4" id="calibre_link-5">
  <p class="calibre2">There’s a debate of using classes instead of interfaces for mocks. You get a class mock by taking a class that has at least some of its public methods virtual and make a subclass where you override those methods and inject your own behaviors. Proponents of this technique point out the following advantages over interface mocks:</p>

  <ol class="calibre12">
    <li class="calibre13">No interface bloat</li>

    <li class="calibre13">Easier navigation in IDEs (pointing to method usage and choosing an option like “go to definition” takes you to the method implementation rather than the interface signature)</li>

    <li class="calibre13">No need to maintain another set of method signatures in interfaces - less work when changing things.</li>
  </ol>

  <p class="calibre2">Personally, I myself use class mocks very rarely. For the following reasons:</p>

  <h3 class="sigilnotintoc">1. Trouble overriding the implementation.</h3>

  <p class="calibre2">When you intend to mock a class, you have to watch out how you implement it. There are parts of class implementation that cannot be overridden, and these parts, when done wrong, may affect your specs/Unit tests in an unexpected way. Let’s examine the following, bad from mocking perspective, example of a class:</p>
  <pre class="calibre10">
public class PersonDao
{
  public PersonDao()
  {
    if(!wrappedTable.Exists)
    {
      wrappedTable.Create();
    }
  }

  public virtual void Close()
  {
    connection.Close();
  }

  private Table wrappedTable 
   = new Table("Person", "CreatePersonTableDdl.sql");
  private Connection connection = Connection.Open();
}
</pre>

  <p class="calibre2">This is an example of a simple <a href="http://java.sun.com/blueprints/corej2eepatterns/Patterns/DataAccessObject.html">DAO</a> class.</p>

  <p class="calibre2">Let’s take a look at the constructor first - someone tried to be clever and wanted to make sure that whenever we create a data access object, the table wrapped by it exists. This is bad, because creating a mock of this class (which is almost always about creating a subclass at runtime - this is how most mocking libraries work) ends up invoking the class’s constructor. The effect? Each time we make a new mock, an attempt will be made to access the database and there’s nothing we can do about it (apart from setting up a database on every machine that runs your unit tests, but believe me, you don’t wanna do it).</p>

  <p class="calibre2">Now look at the bottom of this class definition - here we’ve got an inline initialization of two fields, one of which is initialized with an open connection, which also cannot be mocked - it will always be executed when creating instances of this class or any subclass (including a mock). The only way to deal with such static method invocation as seen here is to add some extra implementation to the Connection class that would allow us to somehow set a fake instance to be returned by this method. But let’s imagine that this is actually a third party class and we have no access to the source code. What can we do? again - nothing.</p>

  <p class="calibre2">There’s only one way to deal effectively with issues described above - we have to change the design to allow dependency injection, plus, such design has to be maintained as the code evolves. My practical experience says it’s unrealistic to expect every programmer that works with you to understand design guidelines that apply to mockable classes. Even if you train every developer in your team, sooner or later someone new will come and make changes against those guidelines. So, either turn into a policeman or give up.</p>

  <h3 class="sigilnotintoc">2. Maintaining virtuality</h3>

  <p class="calibre2">In order to be able to mock a method inside a class, the method has to be virtual. It’s best to keep all methods virtual in order to keep the mocks maintainable - when some of the methods are virtual and some of them not, it’s hard to actually figure out what actually gets called in given circumstances and hard to read specifications that use such mocks - each time you read a spec, you have to go to the class definition to check whether the method in question will be mocked or not. Again, all of this requires everyone to follow strict class design guidelines, which is troublesome to enforce.</p>

  <h3 class="sigilnotintoc">3. Constructor maintenance</h3>

  <p class="calibre2">Given such class:</p>
  <pre class="calibre10">
public class MockedObject
{
  public MockedObject(int arg)
  {
  }
}
</pre>

  <p class="calibre2">..Let’s execute this code using a popular Moq mocking framework:</p>
  <pre class="calibre10">
[Test]
public void ShouldAllowSubstitutingConcreteObjects_Moq()
{
  var x = new Mock&lt;MockedObject&gt;();
  var y = x.Object;
}
</pre>

  <p class="calibre2">..or this one using NSubstitute framework:</p>
  <pre class="calibre10">
[Test]
public void ShouldAllowSubstitutingConcreteObjects_NSubstitute()
{
  var x = Substitute.For&lt;MockedObject&gt;();
}
</pre>

  <p class="calibre2">Both Moq and NSubstitute rely on Castle.Proxy library to create proxy objects (i.e. runtime objects subclassing the class). So no wonder both of these snippets give you the same result:</p>
  <pre class="calibre10">
System.ArgumentException: Can not instantiate proxy of class: 
Playground.OutExample+MockedObject.
Could not find a parameterless constructor.
Parameter name: constructorArguments
  at Castle.DynamicProxy.ProxyGenerator.CreateClassProxyInstance…
</pre>

  <p class="calibre2">Why is that? In both cases we create a new mock without supplying any parameters to the constructor, which takes one parameter - even when creating a subclass, we still have to go through superclass’s constructor (because it’s the only constructor available). Now let me show you a corrected version of both of these snippets:</p>
  <pre class="calibre10">
[Test]
public void ShouldAllowSubstitutingConcreteObjects_Moq()
{
  var x = new Mock&lt;MockedObject&gt;(Any.Integer());
  var y = x.Object;
}

[Test]
public void ShouldAllowSubstitutingConcreteObjects_NSubstitute()
{
  var x = Substitute.For&lt;MockedObject&gt;(Any.Integer());
}
</pre>

  <p class="calibre2">It means every time the constructor changes, we have to update the constructor’s parameter list in each mock creation, which makes such mocks hard to maintain.</p>

  <p class="calibre2">All of these points make me accept gladly the interface bloat and mock interfaces rather than classes. I tend to use class mocks in some special cases only (like specifying abstract classes by mocking abstract methods and specifying how non-abstract methods of the same object use them).</p>

  <p class="calibre2">And that’s it. Maybe next time I’ll show you how to deal with some of the downfalls of class mocks mentioned here. In the meantime, take care and enjoy your weekend ;-)</p>
</div>


<div class="calibre4" id="calibre_link-0">
  <p class="calibre2">Hi, today, I’d like to mention the topic of mocking the operating system and getting rid of it (especially the non-deterministic parts) as we write our specifications AKA unit tests.</p>

  <h3 class="sigilnotintoc">The use cases</h3>

  <p class="calibre2">In general, there are two cases where we interact with the operating system:</p>

  <ol class="calibre12">
    <li class="calibre13">We tell our code to use the operating system’s resources (start a thread, write to a hard drive etc.)</li>

    <li class="calibre13">We tell the operating system to use our code (when a timer expires, when a thread execution finishes etc.)</li>
  </ol>

  <h3 class="sigilnotintoc">Timers</h3>

  <p class="calibre2">The topic of today’s post is a combination of both above cases. Timers work as a way to say “in X milliseconds (or any other time unit), invoke Y and in the meantime, let me do my job.”</p>

  <p class="calibre2"><a href="http://1.bp.blogspot.com/-RIn6HavVmco/T-I47IqIwmI/AAAAAAAAAIE/lRzchNu4IS4/s1600/TimerDiagram.png" imageanchor="1" class="calibre37"><img alt="" border="0" src="http://1.bp.blogspot.com/-RIn6HavVmco/T-I47IqIwmI/AAAAAAAAAIE/lRzchNu4IS4/s400/TimerDiagram.png" class="calibre38" /></a></p>

  <p class="calibre2">The scheduling phase is where our code uses the timer and the calling back phase is where the timer uses our code. But before I show you how to properly handle this kind of situation, let’s examine how things can go wrong.</p>

  <h3 class="sigilnotintoc">A Baaad Idea</h3>

  <p class="calibre2">Let’s assume that our specified class invokes an action periodically, each time passing in the current time. Also, let’s assume that we don’t care about the current time value (e.g. whether the passed time is really current) - in the real world we would, but this is just a toy example, so please bear with it. The most widely seen (but wrong - read on) way of writing a spec of a class that executes some code periodically usually consists of the following steps</p>

  <ol class="calibre12">
    <li class="calibre13">Make the object using the timer start this timer with a callback interval of <strong class="calibre14">X</strong> (so each <strong class="calibre14">X</strong> units of time, let’s say seconds, the timer will call back)</li>

    <li class="calibre13">Sleep for X*Y units of time (where <strong class="calibre14">Y</strong> is any positive integer) + some slight tolerance</li>

    <li class="calibre13">After the spec wakes up from the sleep, assert that callback was called <strong class="calibre14">Y</strong> times</li>
  </ol>

  <p class="calibre2">Let’s quickly examine how would an implementation of such reasoning look like:</p>
  <pre class="calibre10">
[Test]
public void ShouldPingPeriodically()
{
  int actualCallbackCount = 0;
  int interval = 4000;
  int expectedCallbackCount = 3;
  int tolerance = 1000;

  var timeNotification = 
    new CurrentTimeNotification( _ =&gt; actualCallbackCount++ );

  timeNotification.Schedule(interval);
  Thread.Sleep(interval * expectedCallbackCount + tolerance);
  timeNotification.Halt();

  Assert.AreEqual(expectedCallbackCount, actualCallbackCount);
}
</pre>

  <p class="calibre2">This approach has one disadvantage - the interval * expectedCallbackCount is not the total time that is spent in tested code - there’s one more thing we have to take into account, which is the duration of execution of the callback passed to CurrentTimeNotification constructor. Also, usually we don’t invoke this code directly from the timer, because callbacks executed by the timer often require a specific signature which our passed action does not provide (if you’re curious about the details, read TimerCallback delegate documentation on MSDN), so probably there is an additional code that’s executed by the timer and this code invokes the action that we pass in. Usually the 1-second tolerance is enough to cater for this (by the way, remember it’s really 1 second for all the calls, so each call must take under (1/expectedCallbackCount) seconds), but what if we run unit tests on a developer machine that’s performing another build at the same time and is short on resources? Can the execution of the additional code that we just mentioned take more than the assumed tolerance? Of course it can! So what do we do about it?</p>

  <h3 class="sigilnotintoc">A Better solution</h3>

  <p class="calibre2">The time has come to draw a line between the behaviors of our code and the operating system. In a specification of a class using a timer, we want to describe three behaviors in particular:</p>

  <ol class="calibre12">
    <li class="calibre13">It should create the timer passing desired method as callback</li>

    <li class="calibre13">It should schedule the timer for desired number of time units</li>

    <li class="calibre13">It should perform a desired behavior when the callback is invoked</li>
  </ol>

  <p class="calibre2">To achieve this goal, we have to get rid of the timer by creating a thinnest possible wrapping layer. This layer has to be super thin because it’s the code we’re NOT going to write specs against. So, here we go - a timer wrapper:</p>
  <pre class="calibre10">
public interface IPeriodicExecution
{
  TimerCallback Callback { get; }
  void Schedule(int milliseconds);
  void Halt();
}

public class PeriodicExecution : IPeriodicExecution
{
  private Timer timer;

  public TimerCallback Callback
  {
    get; private set;
  }

  public PeriodicExecution(TimerCallback callback)
  {
    timer = new Timer(callback);
    Callback = callback;
  }

  public void Schedule(int milliseconds)
  {
    timer.Change(0, milliseconds);
  }

  public void Halt()
  {
    timer.Change(0, Timeout.Infinite);
  }
}
</pre>

  <p class="calibre2">As you can see, the wrapper is really thin. The only unclear element is this Callback property. We’ll reveal what it is for in a moment. In the meantime, note that the timer callback is passed in a constructor. We can’t mock constructors, so from the list of the three behaviors outlined in the beginning of this section, we wouldn’t be able to specify the first one. In order to be able to do that, we need to introduce another thin layer - a factory!</p>
  <pre class="calibre10">
public interface IPeriodicExecutionFactory
{
  IPeriodicExecution Create(TimerCallback callback);
}

public class PeriodicExecutionFactory
{
   public 
   IPeriodicExecution Create(TimerCallback callback)
   {
     return new PeriodicExecution(callback);
   }
}
</pre>

  <p class="calibre2">By the way, this is not the main topic of this post, but note that because the IPeriodicExecution interface has this callback property I mentioned, we can actually test-drive this factory object in the following way:</p>
  <pre class="calibre10">
[Test]
public void ShouldCreatePeriodicExecutionWithSpecifiedCallback()
{
  var anyCallback = Substitute.For&lt;TimerCallback&gt;();
  var factory = new PeriodicExecutionFactory();
  var periodicExecution = factory.Create(anyCallback);

  Assert.AreSame(anyCallback, periodicExecution.Callback);
}
</pre>

  <p class="calibre2">Ok, now we’re ready to write the specs for the three behaviors from this section start. The first one: <strong class="calibre14">“Should create the timer passing desired method as callback”</strong>:</p>
  <pre class="calibre10">
[Test]
public void 
ShouldSetupPeriodicExecutionCallbackToNotifyAboutCurrentDateTime()
{
  //GIVEN
  var anyAction = Substitute.For&lt;Action&lt;DateTime&gt;&gt;();
  var factory = Substitute.For&lt;IPeriodicExecutionFactory&gt;();

  //WHEN
  var notification = new CurrentTimeNotification2(anyAction, factory);

  //THEN
  factory.Received().Create(notification.NotifyAboutCurrentTime);
}
</pre>

  <p class="calibre2">Now the second one: <strong class="calibre14">“Should schedule the timer for desired number of time units”</strong>:</p>
  <pre class="calibre10">
[Test]
public void 
ShouldSchedulePeriodicExecutionEverySpecifiedNumberOfMilliseconds()
{
  //GIVEN
  var anyAction = Substitute.For&lt;Action&lt;DateTime&gt;&gt;();
  var factory = Substitute.For&lt;IPeriodicExecutionFactory&gt;();
  var periodicExecution = Substitute.For&lt;IPeriodicExecution&gt;();
  var anyNumberOfMilliseconds = Any.PositiveInteger();

  factory.Create(Arg.Any&lt;TimerCallback&gt;()).Returns(periodicExecution);
  var notification = new CurrentTimeNotification2(anyAction, factory);

  //WHEN
  notification.Schedule(anyNumberOfMilliseconds);

  //THEN
  periodicExecution.Received().Schedule(anyNumberOfMilliseconds);
}
</pre>

  <p class="calibre2">And the third one: <strong class="calibre14">“Should perform a desired behavior when the callback is invoked”</strong>:</p>
  <pre class="calibre10">
[Test]
public void 
ShouldInvokeActionWithCurrentTimeWhenTimerExpires()
{
  //GIVEN
  bool gotCalled = false;
  var factory = Substitute.For&lt;IPeriodicExecutionFactory&gt;();
  var notification = 
    new CurrentTimeNotification2(_ =&gt; gotCalled = true, factory);

  //WHEN
  notification.NotifyAboutCurrentTime(Any.Object());

  //THEN
  Assert.IsTrue(gotCalled);
}
</pre>

  <p class="calibre2">And that’s it. Note that this set of three specifications better describe what the actual object does, not how it works when connected to the timer. This way, they’re more accurate as specifications of the class than the one using Thread.Sleep().</p>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">In this post, I tried to show how to approach timer-based designs. The same approach can be used for mocking pretty much every non-deterministic or time-based or threaded element in our implementation.</p>

  <p class="calibre2">Remember, try to keep your design separated from your implementation.</p>
</div>


<div class="calibre4" id="calibre_link-7">
  <p class="calibre2">As many have already stated, TDD encourages simple, elegant design. Today I’d like to show you a simple example on how you can smell <a href="http://www.objectmentor.com/resources/articles/srp.pdf">Single Responsibility Principle</a> violation from your specs (AKA unit tests).</p>

  <h3 class="sigilnotintoc">A session storage</h3>

  <p class="calibre2">Imagine we’re building a web server which allows different clients connect to it via HTTP requests. The server is so simple that it holds all its sessions for different clients in memory. One of the specs that led to implementing this in-memory session storage looks like this:</p>
  <pre class="calibre10">
[Test] public void
ShouldKillAllContainedSessionsWhenItIsKilled()
{
  var sessions = new Sessions();
  var session1 = Substitute.For&lt;Session&gt;();
  var session2 = Substitute.For&lt;Session&gt;();

  sessions.Add(session1);
  sessions.Add(session2);

  sessions.Kill();

  session1.Received().Kill();
  session2.Received().Kill();
}
</pre>

  <p class="calibre2">Now imagine that a company became interested in our web server and wants to turn it into a commercial product. The company strategy is as follows: users will be offered free version to try things out and when they pay, they will receive activation code.</p>

  <p class="calibre2">There is only one difference between the trial and full version - the trial version has a limit of only one active session at a given moment.</p>

  <p class="calibre2">This change of policy needs to be reflected in the session storage. So we add a logic that checks for the session limit and throws an exception as soon as the limit is exceeded. A specification of such behavior would look like this:</p>
  <pre class="calibre10">
[Test] public void
ShouldThrowExceptionWhenTryingToAddSessionsBeyondDefaultLimitOfOne()
{
  var sessions = new Sessions();
  var session1 = Any.InstanceOf&lt;Session&gt;();
  var session2 = Any.InstanceOf&lt;Session&gt;();

  sessions.Add(session1);
  
  Assert.Throws&lt;Exception&gt;(() =&gt; sessions.Add(session2));
}
</pre>

  <p class="calibre2">This, however, leaves us with another issue: what about the first spec mentioned in this post? If the limit of sessions is 1 by default, it will fail, since we’re adding two sessions there. So we’ll need to somehow extend the limit for the purpose of this spec.</p>

  <p class="calibre2">I assume that you’re smart enough not to use Setup and Teardown methods in your unit-level specs (I’ll have a post about why Setup and Teardown usually stink someday), so your “corrected” spec looks like this now:</p>
  <pre class="calibre10">
[Test] public void
ShouldKillAllContainedSessionsWhenItIsKilled()
{
  var sessions = new Sessions();
  var session1 = Substitute.For&lt;Session&gt;();
  var session2 = Substitute.For&lt;Session&gt;();
  sessions.Limit = 2;

  sessions.Add(session1);
  sessions.Add(session2);

  sessions.Kill();

  session1.Received().Kill();
  session2.Received().Kill();
}
</pre>

  <p class="calibre2">And so we added extending the session limit to 2. Now, doesn’t this bother you? Look at the name of the spec - does it tell anything about a session limit? No, it doesn’t. Let’s think about the behavior as well - did it become invalid after we introduced the session limit? No, it didn’t.</p>

  <p class="calibre2">So how did it happen that the session limit concept leaked to an unrelated specification? Is this a problem with the spec?</p>

  <p class="calibre2">No, it isn’t. It’s a problem with our production code design. In fact, this spec is just a symptom of what we did with the design:</p>

  <h3 class="sigilnotintoc">We violated Single Responsibility Principle</h3>

  <p class="calibre2">That’s right, folks, we really did it. Currently, the session storage is responsible not only for storing and accessing the sessions, it also knows EXACTLY what is the business-imposed limit and takes care of enforcing this limit. That’s two responsibilities, not one.</p>

  <p class="calibre2">Ok, so we screwed up. How do we fix it?</p>

  <p class="calibre2">The easiest way is to have the limit-related logic isolated in a separate class. Because we want this class to be a result of implementing specifications (remember, test-driven ;-)), we undo the addition of the limit-related code to session storage class (and existing unit tests) and start over. Here’s an example spec that will drive an implementation that respects Single Responsibility Principle. Implementing it will not impact other specs any way other than with a need to supply a dummy constructor parameter.</p>
  <pre class="calibre10">
[Test] public void
ShouldValidateNumberOfSessionsBeforeAddingANewOne()
{
  var sessionCountValidation 
    = Substitute.For&lt;SessionCountValidation&gt;()
  var sessions = new Sessions(sessionCountValidation);
  var sessionsCountBeforeAddingNewOne = sessions.Count;

  sessions.Add(Any.InstanceOf&lt;Session&gt;());

  sessionCountValidation.Received()
    .Perform(sessionsCountBeforeAddingNewOne);
}
</pre>

  <p class="calibre2">This way we crafted the signature of desired session count validation object. We can implement it (test-driven of course) as soon as this spec starts to pass.</p>

  <p class="calibre2">That’s it. This is a simple lesson, but very important one. Remember: always listen to your tests - the advice may be priceless.</p>

  <p class="calibre2">See ya!</p>
</div>


<div class="calibre4" id="calibre_link-43">
  <p class="calibre2">Although the idea of <a href="http://osherove.com/tdd-kata-1/">doing code kata to practice TDD</a> is quite popular, I couldn’t get on this train for a long time. The reason was that I was striving to find a kata that would help me practice or demonstrate a mock-based TDD, at the same time being simple and showing all the <a href="http://www.sustainabletdd.com/2012/01/test-categories.html">testing</a> <a href="http://www.sustainabletdd.com/2012/01/testing-best-practices-test-categories.html">categories</a>, as well as <a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-first-post.html">test</a> <a href="http://www.sustainabletdd.com/2011/10/test-reflexology-part-1-second-post.html">reflexology</a> in practice.</p>

  <p class="calibre2">This was until I ran into a situation that, with few simplifications, could be turned into a compelling kata to show off the power of mocks and Need-Driven Development.</p>

  <p class="calibre2">I’ve decided to present the kata in a series of posts. This one is going to be about the challenge only.</p>

  <h3 class="sigilnotintoc">The challenge</h3>

  <p class="calibre2">Imagine the following situations: you’re creating a message processing module for a system that receives data in a form of frames from the network. The frame parsing is done using a proprietary third party library and your module receives the frames as deserialized objects. As the class for the objects is stored in the third-party library, you cannot change it (e.g. add or remove methods or change any signature).</p>

  <p class="calibre2">There is only one type of frame, described below:</p>
  <pre class="calibre10">
public class Frame
{
  int Speed { get; set; }
  int Age { get; set; }
  string Sender { get; set; }
}
</pre>

  <p class="calibre2">Your task is to implement the message processing. So far, it only consists of validation and nothing more. Each field of each incoming frame is validated. The following examples describe the validation rules:</p>

  <table class="calibre39">
    <tr class="calibre21">
      <th class="calibre40">type of field</th>

      <th class="calibre40">Correctness criteria</th>

      <th class="calibre40">When satisfied</th>

      <th class="calibre40">When not satisfied</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre41">int</td>

      <td class="calibre41">greater than 0</td>

      <td class="calibre41">do nothing</td>

      <td class="calibre41">throw exception</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre42">string</td>

      <td class="calibre42">not null and not empty</td>

      <td class="calibre42">do nothing</td>

      <td class="calibre42">throw exception</td>
    </tr>
  </table>

  <p class="calibre2">Of course, you have to do this test-first.</p>

  <h3 class="sigilnotintoc">Two more posts to come - one for failure, one for success</h3>

  <p class="calibre2">I believe that failure and success are both great opportunities to learn something valuable. So in the next post, <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills_25.html">I’ll try to show you how to screw up</a> :-) and what we can learn from the failure by listening to the tests.</p>

  <p class="calibre2">In the meantime, you can try to solve the kata yourself (coming up with any solutions should be trivial) and share your observations.</p>

  <p class="calibre2">Good night, everyone!</p>
</div>


<div class="calibre4" id="calibre_link-6">
  <p class="calibre2">As promised, today I’d like to show you a way to come up with a suboptimal solution to the <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills.html">kata described earlier</a>.</p>

  <p class="calibre2">I’ll be using xUnit.NET as my unit test runner and NSubstitute as my mocking library of choice throughout this exercise. In general, I’ll be following good practices most of the time and indicate where I’ll be “accidentially” losing sight of them.</p>

  <h3 class="sigilnotintoc">Specification 1: Creating new instances</h3>

  <p class="calibre2">We’re starting outside-in, from the inputs. In my system, I’ll model the most “outside” part of the module as a MessageProcessing class. We should be able to create instances of this class, so the first specification will tell just this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstancesWithoutExceptions()
{
  Assert.DoesNotThrow(() =&gt; new MessageProcessing());
}
</pre>

  <p class="calibre2">This specification creates <strong class="calibre14">a need</strong> to have a MessageProcessing class:</p>
  <pre class="calibre10">
public class MessageProcessing
{
}
</pre>

  <p class="calibre2">Ok, so far so good. This, by the way, is a simple example of a <a href="http://www.sustainabletdd.com/2012/02/testing-best-practices-test-categories.html">Creational Specification</a>. Now let’s take on a more complex behavior.</p>

  <h3 class="sigilnotintoc">Specification 2: Submitting frame to validation</h3>

  <p class="calibre2">Ok, so now’s the time to use the Given-When-Then analysis. We already have the MessageProcessing class - also, we’ve got the Frame class. How do they interact with each other?</p>

  <p class="calibre2">After giving it a short thought, we can come up with this obvious behavior description:</p>
  <pre class="calibre27">
GIVEN any frame
WHEN message processing is performed for it
THEN it should submit the frame to validation
</pre>

  <p class="calibre2">Cool, let’s get to implementing it. The first thing we want to do is to just translate the behavior description above to the code and see which abstractions and methods are missing - then supply them.</p>

  <p class="calibre2">The first line:</p>
  <pre class="calibre27">
GIVEN any frame
</pre>

  <p class="calibre2">can be translated to code like this:</p>
  <pre class="calibre10">
var anyFrame = Any.InstanceOf&lt;Frame&gt;();
</pre>

  <p class="calibre2">Then the second line:</p>
  <pre class="calibre27">
WHEN message processing is performed for it
</pre>

  <p class="calibre2">can be written as:</p>
  <pre class="calibre10">
var messageProcessing = new MessageProcessing();
messageProcessing.PerformFor(frame);
</pre>

  <p class="calibre2">Great! Now the last line:</p>
  <pre class="calibre27">
THEN it should submit the frame to validation
</pre>

  <p class="calibre2">and its translation into the code (note the Received() extension method, which is an NSubstitute construct):</p>
  <pre class="calibre10">
validation.Received().PerformFor(anyFrame);
</pre>

  <p class="calibre2">Ok, so we’ve made the translation, now let’s summarize this and see what’s missing to make this code compile:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldSubmitFrameToValidationWhenPerformedForThatFrame()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();

  //WHEN
  var messageProcessing = new MessageProcessing();
  messageProcessing.PerformFor(frame);

  //THEN
  validation.Received().PerformFor(anyFrame);
}
</pre>

  <p class="calibre2">What’s missing? We have to somehow create the validation and pass it to MessageProcessing, since it’s the entity responsible for performing the validation. And so, the corrected version looks like this.</p>
  <pre class="calibre10">
[Fact] public void 
ShouldSubmitFrameToValidationWhenPerformedForThatFrame()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var validation = Substitute.For&lt;Validation&gt;();  

  //WHEN
  var messageProcessing = new MessageProcessing(validation);
  messageProcessing.PerformFor(frame);

  //THEN
  validation.Received().PerformFor(anyFrame);
}
</pre>

  <p class="calibre2">As you can see, we’ve discovered one new abstraction - a validation, and two new methods: one for message processing and one for validation (accidentially, both named PerformFor()). Thus, we have <strong class="calibre14">created a need</strong> for all this new stuff to exist. Additionally, <strong class="calibre14">we made a mistake</strong> when dividing responsibilities between classes, and we’ll see why later.</p>

  <p class="calibre2">By the way, this is what’s called a <a href="http://www.sustainabletdd.com/2012/02/testing-best-practices-test-categories.html">Work-Flow Specification</a>. Our workflow is very primitive, since it consists of forwarding a method call to another object. In real-world scenarios (and in the correct solution to this kata) workflows are more worthwile.</p>

  <p class="calibre2">After creating all the necessary types and methods, the implementation looks like this:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  public MessageProcessing(Validation validation)
  {
    throw new NotImplementedException();
  }

  public void PerformFor(Frame frame)
  {
    throw new NotImplementedException();
  }
}

//TODO implement
public interface Validation
{
  void PerformFor(Frame frame); 
}
</pre>

  <p class="calibre2">Also, we’ve got to correct the first specification to cater for new construction argument:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstancesWithoutExceptions()
{
  Assert.DoesNotThrow(
    () =&gt; new MessageProcessing(Any.InstanceOf&lt;Validation&gt;())
  );
}
</pre>

  <p class="calibre2">Note that I added a TODO next to the Validation interface - this is because I’ll need to go back later and actually implement it. While I don’t write much about a TODO list in this post, it’s actually one of TDDer’s best friends (maybe I’ll write a post about it someday).</p>

  <p class="calibre2">Let’s leave the validation for now. To make this specification I just wrote pass, I’ll need to change the MessageProcessing class:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  private readonly Validation _validation;

  public MessageProcessing(Validation validation)
  {
    _validation = validation;
  }

  public void PerformFor(Frame frame)
  {
    _validation.PerformFor(frame);
  }
}
</pre>

  <p class="calibre2">Now it’s all green, so let’s examine our TODO list. The only item on the list is the Validation interface implementation, so let’s go ahead and create…</p>

  <h3 class="sigilnotintoc">Specification 3: new instances of concrete validation.</h3>

  <p class="calibre2">So we need a concrete implementation of the Validation interface. Let’s call it BasicValidation, since the logic in there is gonna be really simple.</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstancesWithoutExceptions()
{
  Assert.DoesNotThrow(
    () =&gt; new SanityValidation()
  );
}
</pre>

  <p class="calibre2">and now we’ve created <strong class="calibre14">a need</strong> for a class named SanityValidation. The code for SanityValidation class looks like this now:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public void PerformFor(Frame frame)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">Some tools, like Resharper, put occurences of NotImplementedException on the TODO list, which is a great feature, because replacing it with concrete implementation actually IS something “to do”.</p>

  <h3 class="sigilnotintoc">Specification 4: Ignoring valid frames</h3>

  <p class="calibre2">Starting from this chapter, we’re going to feel the pain of my bad design decision more and more. In the grand finale, I’ll show you what mess we’ve got ourselves into. But first things first, let’s write the first specification of validation, which says:</p>
  <pre class="calibre27">
GIVEN a validation and a frame
AND the frame has all its fields valid
WHEN the frame is submitted to validation
THEN no exception should be thrown
</pre>

  <p class="calibre2">which, translated into code, looks like this:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldNotThrowAnyExceptionWhenPerformedForFrameWithAllFieldsValid()
{
  //GIVEN
  var frame = new Frame()
  { 
    Speed = SanityValidation.MinValidInteger,
    Age = SanityValidation.MinValidInteger,
    Sender = Any.NonNullNonEmptyString()
  };

  var validation = new SanityValidation();

  //WHEN - THEN
  Assert.DoesNotThrow(
    () =&gt; validation.PerformFor(frame)
  );
}
</pre>

  <p class="calibre2">(By the way, this is called a <a href="http://www.sustainabletdd.com/2012/01/test-categories.html">Functional Specification</a>.)</p>

  <p class="calibre2">Interesting… we had to know exactly what <strong class="calibre14">“all fields”</strong> mean. I wonder what will be the effect of adding new field to the frame in the future… We’ll see more of that with upcoming specs. For now, let’s just type in the implementation which is to remove throwing the NotImplementedException() from PerformFor() method. Oh, I almost forgot, we introduced a need to create a constant named MinValidInteger, so we have to add it to the SanityValidation class:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 12345; //TODO
  public void PerformFor(Frame frame)
  {
  }
}
</pre>

  <p class="calibre2">Note that we’re not assigning this new constant any particular value - 12345 is just a dummy number. Moreover, we’re putting a TODO next to the constant, since we’ll want to revisit it later and actually write a specification on what the value of the constant should be. But for now - done. Time for the next one.</p>

  <h3 class="sigilnotintoc">Specification 5: throwing exception on invalid Speed</h3>

  <p class="calibre2">Let’s describe the expected behavior:</p>
  <pre class="calibre27">
GIVEN a validation and a frame
AND the frame has all its fields valid except for the Speed
WHEN the frame is submitted to validation
THEN an exception should be thrown
</pre>

  <p class="calibre2">Note the <strong class="calibre14">“all fields”</strong> again… this is becoming very interesting. let’s see what comes up when we put the spec into code:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldThrowAnExceptionWhenPerformedForFrameWithInvalidSpeed()
{
  //GIVEN
  var frame = new Frame()
  { 
    Speed = SanityValidation.MinValidInteger - 1,
    Age = SanityValidation.MinValidInteger,
    Sender = Any.NonNullNonEmptyString()
  };

  var validation = new SanityValidation();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; validation.PerformFor(frame)
  );
}
</pre>

  <p class="calibre2">Another Functional Specification. Note that we’re repeating assignments to all of the frame fields. Also, we’re repeating the knowledge on what it means to be “valid” for each field except the speed. Keep calm, the grand finale is getting nearer and nearer. For now, let’s just pretend that nothing happened and add the necessary code to make this spec pass:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 12345; //TODO
  public void PerformFor(Frame frame)
  {
    if(frame.Speed &lt; MinValidInteger)
      throw new Exception();
  }
}
</pre>

  <h3 class="sigilnotintoc">Specification 6: throwing exceptions on invalid Age</h3>

  <p class="calibre2">To be honest, nothing really interesting happens here, since it’s almost the same as in the previous case. Let’s just write the spec:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldThrowAnExceptionWhenPerformedForFrameWithInvalidAge()
{
  //GIVEN
  var frame = new Frame()
  { 
    Speed = SanityValidation.MinValidInteger,
    Age = SanityValidation.MinValidInteger - 1,
    Sender = Any.NonNullNonEmptyString()
  };

  var validation = new SanityValidation();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; validation.PerformFor(frame)
  );
}
</pre>

  <p class="calibre2">and the code necessary to make it pass:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 12345; //TODO
  public void PerformFor(Frame frame)
  {
    if(frame.Speed &lt; MinValidInteger)
      throw new Exception();
    if(frame.Age &lt; MinValidInteger)
      throw new Exception();
  }
}
</pre>

  <p class="calibre2">By the way, is it only me, or is there a pattern recurring in both specs and production code? Oh, and the conclusions on bad design drawn during the previous specification are only reinforced here!</p>

  <h3 class="sigilnotintoc">Specification 7: Sender cannot be null</h3>

  <p class="calibre2">Also, this one is analogous to the two previous ones, only this time we’ll be checking for null instead of a numeric boundary:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldThrowAnExceptionWhenPerformedForFrameWithNullSender()
{
  //GIVEN
  var frame = new Frame()
  { 
    Speed = SanityValidation.MinValidInteger,
    Age = SanityValidation.MinValidInteger,
    Sender = null
  };

  var validation = new SanityValidation();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; validation.PerformFor(frame)
  );
}
</pre>

  <p class="calibre2">and here’s the code:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 12345; //TODO
  public void PerformFor(Frame frame)
  {
    if(frame.Speed &lt; MinValidInteger)
      throw new Exception();
    if(frame.Age &lt; MinValidInteger)
      throw new Exception();
    if(frame.Sender == null)
      throw new Exception();
  }
}
</pre>

  <p class="calibre2">…and the last validation:</p>

  <h3 class="sigilnotintoc">Specification 8: Sender cannot be empty</h3>

  <p class="calibre2">Almost exactly the same as the previous one. Comments are not needed. Here’s the spec:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldThrowAnExceptionWhenPerformedForFrameWithEmptySender()
{
  //GIVEN
  var frame = new Frame()
  { 
    Speed = SanityValidation.MinValidInteger,
    Age = SanityValidation.MinValidInteger,
    Sender = string.Empty
  };

  var validation = new SanityValidation();

  //WHEN - THEN
  Assert.Throws&lt;Exception&gt;(
    () =&gt; validation.PerformFor(frame)
  );
}
</pre>

  <p class="calibre2">and production code that fulfills it:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 12345; //TODO
  public void PerformFor(Frame frame)
  {
    if(frame.Speed &lt; MinValidInteger)
      throw new Exception();
    if(frame.Age &lt; MinValidInteger)
      throw new Exception();
    if(string.IsNullOrEmpty(frame.Sender))
      throw new Exception();
  }
}
</pre>

  <p class="calibre2">and that’s it for the validation logic - we’ve got all the behaviors nailed. The only thing left to do before I explain where (and why) I failed, is a specification for the constant that pollutes our TODO list:</p>

  <h3 class="sigilnotintoc">Specification 9: Minimum Valid Integer for validations should be 1</h3>

  <p class="calibre2">The spec is really simple:</p>
  <pre class="calibre10">
[Fact] public void 
ShouldUse1AsMinimumValidInteger()
{
  Assert.Equal(1, SanityValidation.MinValidInteger);
}
</pre>

  <p class="calibre2">This thing is called a <a href="http://www.sustainabletdd.com/2012/02/testing-best-practices-test-categories.html">Constant Specification</a>. To make it pass (because now it’s failing - remember that we put 12345 as the value for MinValidInteger), we’ll just have to change the value of the constant to 1:</p>
  <pre class="calibre10">
public class SanityValidation : Validation
{
  public const MinValidInteger = 1;

  public void PerformFor(Frame frame)
  {
    if(frame.Speed &lt; MinValidInteger)
      throw new Exception();
    if(frame.Age &lt; MinValidInteger)
      throw new Exception();
    if(string.IsNullOrEmpty(frame.Sender))
      throw new Exception();
  }
}
</pre>

  <p class="calibre2">Ok, all behaviors nailed down, all specifications written, now it’s time for a short retrospective.</p>

  <h3 class="sigilnotintoc">Where (and why) did I go wrong?</h3>

  <p class="calibre2">The first mistake I made was in <strong class="calibre14">Specification 2</strong>. I just passed the whole frame to validation. What’s wrong with that? By doing this, I failed to encapsulate the knowledge about the structure of the frame and eventually led to coupling all objects of the application to the Frame type. The frame is a third party class (you can’t control how it changes), plus it’s a data class (and <a href="http://www.codinghorror.com/blog/2006/05/code-smells.html">data classes are code smells</a>) - never couple your application to something as horrible as this!. Imagine the next version of the module would introduce compression and we’d handle this by introducing another class called Compression, then pass whole frame to it. Now every change to the Frame would impact both Validation and Compression object in the same way, introducing redundancy in dependencies and a maintainability pain - stronger with each new class that would need to operate on the frame. One of the goals of object oriented design is to keep data together with behaviors related to that data and that’s exactly what I failed to achieve.</p>

  <p class="calibre2">The other mistake was to further fail to encapsulate the frame structure when it got into the Validation object. If you look at <strong class="calibre14">specifications 4, 5, 6, 7 and 8</strong> - all of them contain both the knowledge on which fields to validate and what “valid” means for each field. This led to many repetitions in the specs (adding a new field to Frame class would require changes in five specs plus adding a new one - a real horror!) and exposed smells in the production code itself, which are: violation of the Single Responsibility Principle (again, Validation is responsible for deciding which fields to validate as well as what the validations mean, making it bear two responsibilities) and redundancy (note that Age and Speed are validated the same way - the specification in my previous post did not assign a validation rule to fields, but to types - and I failed to eliminate the duplication between validations of two fields that are of the same type). And this is only for three fields! To give you a feel of the maintenance horror I mentioned, let’s imagine how the truth table would look like if we had ten fields:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre43"></th>

      <th class="calibre43">Spec 1</th>

      <th class="calibre43">Spec 2</th>

      <th class="calibre43">Spec 3</th>

      <th class="calibre43">Spec 4</th>

      <th class="calibre43">Spec 5</th>

      <th class="calibre43">Spec 6</th>

      <th class="calibre43">Spec 7</th>

      <th class="calibre43">Spec 8</th>

      <th class="calibre43">Spec 9</th>

      <th class="calibre43">Spec 10</th>

      <th class="calibre43">Spec 11</th>
    </tr>

    <tr class="calibre44">
      <td class="calibre45">Field 1</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre45">Field 2</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre23">V</td>
    </tr>

    <tr class="calibre44">
      <td class="calibre45">Field 3</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre45">Field 4</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre44">
      <td class="calibre45">Field 5</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre45">Field 6</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre44">
      <td class="calibre45">Field 7</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre45">Field 8</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre44">
      <td class="calibre45">Field 9</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>

      <td class="calibre46">V</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre45">Field 10</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">V</td>

      <td class="calibre46">X</td>
    </tr>
  </table>

  <p class="calibre2">You get the issue, right? This code should be refactored, but I’m not going to do this, because I want to show you the correct solution next time. In the meantime, you can try to refactor yourself and see what you end up with. As always, comments are welcome.</p>

  <p class="calibre2">But until then… see ya!</p>
</div>


<div class="calibre4" id="calibre_link-8">
  <p class="calibre2">Hi, last time, I tried to show you how to <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills_25.html">screw up</a> the <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills.html">kata I published some time ago</a>. This time, I’ll try to examine the right (or “more right” :-)) way of doing it, using what the specifications told us the last time. The post turned out so long that I thought about splitting it, but hey, we’re living in a “Push To Kindle” age, so here it is - the full thing as a single document. Enjoy!</p>

  <p class="calibre2">I’ll start again from scratch, thus I’ll have to repeat some of the stuff from previous post to spare you the effort made on jumping back and forward between this post and the previous one. Don’t worry, even the steps that are going to be the same as previously, are written differently, since I was not copy-pasting anything but wrote everything again.</p>

  <p class="calibre2">This time, I’ll divide each TDD cycle into four stages:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Create a specification</strong> - we create a specification in a Given-When-Then form and translate it into code. At this point, it will probably not compile, often it won’t be complete (e.g. will be missing some variable declarations)</li>

    <li class="calibre13"><strong class="calibre14">Make it fail for proper reason</strong> - at this point, we make our specification compile by supplying all the necessary types, variables etc. Also, just failing is not enough for us - we want the spec to fail either on assertion or mock verification. In other words - the spec must be failing because the expected end result is not supplied by the production code</li>

    <li class="calibre13"><strong class="calibre14">Make it pass</strong> - at this point, we implement the behavior (of course, the simplest thing that will make the current spec pass and not break any other spec)</li>

    <li class="calibre13"><strong class="calibre14">Examine TODO list</strong> - when finished, we need to determine our next step. Since TDD is broken down into short cycles, each of them having its own goal, we have to constantly evaluate our list of goals - the TODO list, adding items, removing items and choosing next item to implement.</li>
  </ol>

  <p class="calibre2">For educational purposes, I’ll not be doing refactoring - a short explanation why is at the end of this post.</p>

  <h3 class="sigilnotintoc">Let’s begin!</h3>

  <p class="calibre2">First, we’ll need to start with something. Thus, we’ll add the following two items to the TODO list:</p>

  <ol class="calibre12">
    <li class="calibre13"><strong class="calibre14">Create entry point to the module (top-level abstraction)</strong></li>

    <li class="calibre13"><strong class="calibre14">Describe main work-flow of the module</strong></li>
  </ol>

  <p class="calibre2">By the way, new items on TODO list will always be in bold.</p>

  <p class="calibre2">Let’s take on the first item, since it’s a prerequisite for everything else.</p>

  <h3 class="sigilnotintoc">Specification 1: Creating new instances of MessageProcessing class</h3>

  <p class="calibre2">What we need first is our top-level abstraction. Since our task is to create a message processing module, I’ll name the top-level abstraction: MessageProcessing.</p>

  <div class="calibre47">
    By the way, I could name it MessageProcessor, but personally, I don’t like such names. In my opinion, names of classes and interfaces should represent domain concepts and our domain does not tell anything about processor, validator, etc, but processing and validation, so these are the names I’m gonna use.
  </div>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">We have to create a need for this class to exist, and we can do this by making the following <a href="http://www.sustainabletdd.com/2012/02/testing-best-practices-test-categories.html">creational specification</a>:</p>
  <pre class="calibre10">
Given nothing
When I create a new instance of MessageProcessing class
Then it should not result in any kind of exception
</pre>

  <p class="calibre2">Which, translated into code, looks like this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstances()
{
  //GIVEN

  //WHEN
  Action whenCreatingANewInstanceOfMessageProcessingClass
    = () =&gt; new MessageProcessing();
  
  //THEN
  Assert.DoesNotThrow(whenCreatingANewInstanceOfMessageProcessingClass);
}
</pre>

  <p class="calibre2">With this spec, we created a need to have a public MessageProcessing class with a parameterless constructor. Not much, but not bad either for so few lines of code.</p>

  <div class="calibre47">
    Note that in this spec, I created a named action variable and then passed it into the Assert.DoesNotThrow() method. This is not how it’s usually used - most of the time, the lambda is passed inline into the method. I did it differently to make the Given-When-Then structure of this spec explicit.
  </div>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">First, we have to make it compile. This can be achieved simply by creating a MessageProcessing class. Also, to make sure it can fail, we create a parameterless constructor with an exception inside:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  public MessageProcessing()
  {
    throw new Exception();
  }
}
</pre>

  <div class="calibre47">
    Creating this constructor is not necessary in such simple case (without it, the spec would already pass), but I do it here anyway just to show you that we can almost mechanically transition between the four stages explained at the beginning of this article.
  </div>

  <p class="calibre2">Now the spec fails for the correct reason - we expect the constructor not to throw, but it does.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">In order to make this spec pass, we just remove the parameterless constructor. It was there only to ensure us that the spec can fail for the proper reason and now there’s no need for it. And here’s the code:</p>
  <pre class="calibre10">
public class MessageProcessing
{
}
</pre>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">After creating our top-level abstraction, our TODO list looks like this:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13">Implement main work-flow of the module</li>
  </ol>

  <p class="calibre2">We have one item left on the TODO list - implement the main work-flow. Let’s get right to it!</p>

  <h3 class="sigilnotintoc">Specification 2: Performing validation on a frame</h3>

  <p class="calibre2">The second step is to sketch main work-flow of the module. As the only responsibility of the module we’re creating is to validate a frame, we decide this main work-flow to be receiving the fame and submitting it to validation.</p>

  <div class="calibre47">
    The actual validation logic (e.g. when a frame is valid, what to do if it isn’t etc.) is a separate responsibility, so we’ll try postponing its implementation by pushing this responsibility to a collaborator. This collaborator, for the purpose of this spec, will appear only as a fake object without real implementation.
  </div>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">Our very first spec, written using a Given-When-Then notation, will look like this</p>
  <pre class="calibre10">
Given any frame
When a message processing is performed for it
Then the frame should be validated according to supplied rules
</pre>

  <p class="calibre2">Now let’s try translating it literally into the code.</p>
  <pre class="calibre10">Given any frame</pre>

  <p class="calibre2">can be translated into:</p>
  <pre class="calibre10">
var anyFrame = Any.InstanceOf&lt;Frame&gt;();
</pre>
  <pre class="calibre10">When a message processing is performed for it</pre>

  <p class="calibre2">will look like this:</p>
  <pre class="calibre10">
var messageProcessing = new MessageProcessing();
messageProcessing.PerformFor(anyFrame);
</pre>

  <p class="calibre2">and the last line:</p>
  <pre class="calibre10">
Then the frame should be validated according to supplied rules
</pre>

  <p class="calibre2">may be translated like this:</p>
  <pre class="calibre10">
validationRules.Received().ApplyTo(frame);
</pre>

  <p class="calibre2">So the whole spec, again:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldValidateMessageCreatedFromFrameWithValidationRules()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();

  //WHEN
  var messageProcessing = new MessageProcessing();
  messageProcessing.PerformFor(anyFrame);

  //THEN
  validationRules.Received().ApplyTo(frame);
}
</pre>

  <p class="calibre2">Of course, it does not compile yet, since, for instance, we have not declared any variable called validationRules. It’s enough, however, to sketch the behavior and discuss the design.</p>

  <p class="calibre2">If you remember <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills_25.html">last time we did this exercise</a>, the specs told us that the approach with passing whole frame to validation led us to trouble. So let’s stop for a minute to examine how we can improve the design. The Frame class is poorly encapsulated and we cannot change it to improve the encapsulation. What we can do, however, is to hide this ugly class from the rest of the application by wrapping it with our own object as soon as it enters the area under our control. Then we will be able to add domain logic into that class in order to hide its structure from general purpose logic (like validation).</p>

  <p class="calibre2">Knowing all this, let’s rewrite the last line of spec to include our observations:</p>
  <pre class="calibre10">
//GIVEN
var anyFrame = Any.InstanceOf&lt;Frame&gt;();

//WHEN
var messageProcessing = new MessageProcessing();
messageProcessing.PerformFor(anyFrame);

//THEN
message.Received().ValidateWith(validationRules);
</pre>

  <p class="calibre2">What’s this message in the last line? It’s our own wrapper around the frame. We don’t have any variable by this name, nor do we have any variable named validationRules. At this point, it’s not important - we’re merely sketching out the idea and discovering what we need to implement this behavior. In the next stage, we’ll figure out where to get all these variables and types from.</p>

  <p class="calibre2">By the way, so far we have created a need to have a PerformFor() method inside MessageProcessing class, and two abstractions: message and validationRules</p>

  <div class="calibre47">
    Note that message and validation rules take different parts in this specification: the message plays <strong class="calibre14">active</strong> part, since we expect some methods to be called on it. On the other hand, the validationRules is just passed around and never communicated with - its role is <strong class="calibre14">passive</strong>. This information will prove valuable when we get to creating these variables in the specification - stay tuned!
  </div>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">Now, the time has come! to supply what’s missing and fill the void! Mwahahahaha!</p>

  <p class="calibre2">… sorry, I got a little carried away.</p>

  <p class="calibre2">Anyway, to make what we have written compile, we’ll have to fill the blanks. We always do it in the following order:</p>

  <ol class="calibre12">
    <li class="calibre13">First, we add all missing variable instantiations</li>

    <li class="calibre13">Then, we add all the missing interfaces and classes</li>

    <li class="calibre13">Finally, we add to those types and interfaces all missing methods</li>
  </ol>

  <p class="calibre2">1. Add all missing variable instantiations</p>

  <p class="calibre2">Let’s see… We’re missing instantiations of two variables. The first one is message. As I already wrote, message plays <strong class="calibre14">active</strong> role, so It’s gonna be a mock:</p>
  <pre class="calibre10">
var message = Substitute.For&lt;Message&gt;();
</pre>

  <p class="calibre2">Then, there’s validationRules. It plays a <strong class="calibre14">passive</strong> role, so It’s going to be just any instance of interface ValidationRules:</p>
  <pre class="calibre10">
var validationRules = Any.InstanceOf&lt;ValidationRules&gt;();
</pre>

  <div class="calibre47">
    By the way, there are different ways of implementing “any instance of X” - it can even return a mock. In such case, what’s the point for using this mechanism and not just create another mock? Well, remember that these specs will become our living documentation on a micro level, so it’s always better to state explicitly which classes’ behaviors we care about and which we don’t.
  </div>

  <p class="calibre2">Another thing we need to consider here is how the MessageProcessing is going to wrap our frame with the exact instance of Message class that we just created in our spec. We cannot pass the message to the MessageProcessing constructor (because we don’t know the frame yet at this point and we want to wrap each frame with its own message) nor can we pass it through the PerformFor method (because this is the entry point for third-party and if they could pass a wrapped frame to us, we wouldn’t need to know about the frame at all).</p>

  <p class="calibre2">So, again, how do we make MessageProcessing use our instance of message? The response is a factory! We have to create one, then pass it to MessageProcessing and make it return the message we created in our spec when it’s asked to wrap the frame we’re feeding to MessageProcessing (by the way, as you see, the factory plays an <strong class="calibre14">active</strong> role in our spec). Putting it all together, it looks like this:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldValidateTheFrameWrappedInMessageUsingValidationRules()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var message = Substitute.For&lt;Message&gt;();
  var validationRules = Any.InstanceOf&lt;ValidationRules&gt;();
  var factory = Substitute.For&lt;MessageFactory&gt;();

  factory.Wrap(anyFrame).Returns(message);

  //WHEN
  var messageProcessing 
    = new MessageProcessing(factory, validationRules);
  messageProcessing.PerformFor(anyFrame);

  //THEN
  message.Received().ValidateWith(validationRules);
}
</pre>

  <p class="calibre2">And it’s a complete spec, at least from syntactical point of view. The design it points to is also very good, which we’ll find out going further.</p>

  <p class="calibre2">2. Add all the missing interfaces and classes</p>

  <p class="calibre2">So, we added all missing variable instantiations, now we can provide the missing types (by the way, note that we discovered some new types when adding missing variable instantiations and now we can provide these as well - that’s why the steps are performed in this order).</p>

  <p class="calibre2">The following types are missing:</p>

  <ul class="calibre25">
    <li class="calibre13">Message interface</li>

    <li class="calibre13">ValidationRules interface</li>

    <li class="calibre13">MessageFactory interface</li>
  </ul>

  <p class="calibre2">Providing them is a piece of cake:</p>
  <pre class="calibre10">
public interface Message
{

}

public interface ValidationRules
{

}

public interface MessageFactory
{

}
</pre>

  <p class="calibre2">3. Add all methods that do not exist but are used in the specification</p>

  <p class="calibre2">Ok, done with second step, now the final one: satisfying the needs for methods. The spec shows us that the following methods are mising:</p>

  <ul class="calibre25">
    <li class="calibre13">Messagefactory: Message Wrap(Frame frame)</li>

    <li class="calibre13">MessageProcessing: void PerformFor(Frame frame)</li>

    <li class="calibre13">MessageProcessing (constructor): MessageProcessing(MessageFactory factory, ValidationRules validationRules)</li>

    <li class="calibre13">Message: void ValidateWith(ValidationRules rules)</li>
  </ul>

  <p class="calibre2">Let’s provide them:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  public MessageProcessing(
    MessafeFactory factory, 
    ValidationRules validationRules)
  {
    throw new NotImplementedException();
  }

  void PerformFor(Frame frame)
  {
    throw new NotImplementedException();
  }
}

public interface Message //TODO implement
{
  void ValidateWith(ValidationRules rules);
}

public interface ValidationRules //TODO implement
{

}

public interface MessageFactory //TODO implement
{
  Message Wrap(Frame frame);
}
</pre>

  <p class="calibre2">I put a TODO next to each interface that does not have an implementation - that’s because we’ll be adding them to our TODO list in a moment. For now, I just want to signalize it.</p>

  <p class="calibre2">Also, we changed the constructor, meaning we have to update the creational specification for the MessageProcessing class, because it does not have a parameterless constructor anymore. We can deal with it in two steps: first correct the specification like this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstances()
{
  //GIVEN

  //WHEN
  Action whenCreatingANewInstanceOfMessageProcessingClass
    = () =&gt; new MessageProcessing(
      Any.InstanceOf&lt;MessageFactory&gt;,
      Any.InstanceOf&lt;ValidationRules&gt;);
  
  //THEN
  Assert.DoesNotThrow(whenCreatingANewInstanceOfMessageProcessingClass);
}
</pre>

  <p class="calibre2">and then remove the NotImplementedException from the constructor of MessageProcessing class:</p>
  <pre class="calibre10">
  public MessageProcessing(
    MessafeFactory factory, 
    ValidationRules validationRules)
  {
    //removed throwing
  }
</pre>

  <p class="calibre2">We’re now finished with all the three steps of filling in the blanks: we added necessary variables instantiations, added definitions for missing types and provided all missing methods in those types. The spec now compiles and fails. Does this mean we’re done with this stage? No, not yet! If you see at where the failure is, it points towards the PerformFor method of message processing that throws a NotImplementedException - this is not failing for proper reason, since the proper reason to fail is that everything went as planned except the expected call to ValidateWith method was not made on the message object.</p>

  <p class="calibre2">After removing the exception like this:</p>
  <pre class="calibre10">
  void PerformFor(Frame frame)
  {
    //removed throwing exception
  }
</pre>

  <p class="calibre2">we get the result we were expecting: the specification expects a call to ValidateWith method at least once, but none was made.</p>

  <p class="calibre2">Before we provide an implementation that will satisfy this need, let’s see at what we currently have:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  public MessageProcessing(
    MessafeFactory factory, 
    ValidationRules validationRules)
  {
  }

  void PerformFor(Frame frame)
  {
  }
}

public interface Message //TODO implement
{
  void ValidateWith(ValidationRules rules);
}

public interface ValidationRules //TODO implement
{

}

public interface MessageFactory //TODO implement
{
  Message Wrap(Frame frame);
}
</pre>

  <h4 class="sigilnotintoc1">Making it pass</h4>

  <p class="calibre2">We’re going to fill in the implementation of MessageProcessing class. I like starting workflow implementations from the end, i.e. from the expectation. In the spec, we’re expecting a call to ValidateWith(validationRules) to be made against message object, so let’s write that into the method:</p>
  <pre class="calibre10">
void PerformFor(Frame frame)
{
  message.ValidateWith(validationRules);
}
</pre>

  <p class="calibre2">Now, where do we get message from? From the factory, so let’s add a previous line:</p>
  <pre class="calibre10">
void PerformFor(Frame frame)
{
  var message = factory.Wrap(frame);
  message.ValidateWith(validationRules);
}
</pre>

  <p class="calibre2">Where do we get the frame from? It’s passed into the method. Done. Where do we get the validationRules and factory from? They’re constructor arguments, so we’ll have to store them as fields when an instance of MessageProcessing is created:</p>
  <pre class="calibre10">
public MessageProcessing(
  MessafeFactory factory, 
  ValidationRules validationRules)
{
  this.validationRules = validationRules;
  this.factory = factory;
}
</pre>

  <p class="calibre2">Done! The whole implementation of the MessageProcessing class looks like this:</p>
  <pre class="calibre10">
public class MessageProcessing
{
  readonly MessageFactory factory;
  readonly ValidationRules validationRules;

  public MessageProcessing(
    MessafeFactory factory, 
    ValidationRules validationRules)
  {
    this.validationRules = validationRules;
    this.factory = factory;
  }

  void PerformFor(Frame frame)
  {
    var message = factory.Wrap(frame);
    message.ValidateWith(validationRules);
  }
}
</pre>

  <p class="calibre2">And the specification passes. Now we can proceed to the next stage:</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">Remember we left some TODOs in the code next to each interface? Let’s look at it again:</p>
  <pre class="calibre10">
public interface Message //TODO implement
{
  void ValidateWith(ValidationRules rules);
}

public interface ValidationRules //TODO implement
{

}

public interface MessageFactory //TODO implement
{
  Message Wrap(Frame frame);
}
</pre>

  <p class="calibre2">Now let’s add them to the TODO list and cross off the implemented main work-flow:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main workflow of the module</strike></li>

    <li class="calibre13"><strong class="calibre14">Implement Message interface</strong></li>

    <li class="calibre13"><strong class="calibre14">Implement MessageFactory interface</strong></li>

    <li class="calibre13"><strong class="calibre14">Implement ValidationRules interface</strong></li>
  </ol>

  <p class="calibre2">What shall we implement next? Obviouslt, there’s no point in implementing ValidationRules, since it doesn’t contain any methods yet, so we don’t even know what behaviors we need to provide. On the other hand, we’ve got MessageFactory and Message - each having a single method. It makes more sense to start with the MessageFactory, since its functionality is actually about creating messages, so probably, when we finish with specifying and implementing the factory, we’ll also have a class implementing the Message interface already.</p>

  <h3 class="sigilnotintoc">Specification 3: Creating new instances of MessageFactory class</h3>

  <p class="calibre2">Before we can use the factory to create new messages, we need to have a concrete class implementing the MessageFactory interface (I’ll name this class LocationMessageFactory). This is gonna be a simple creational specification. Let’s go!</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">The Given-When-Then form of the spec is:</p>
  <pre class="calibre10">
Given nothing
When I create a new instance of LocationMessageFactory class
Then it should not result in any kind of exception
And it should implement the MessageFactory interface
</pre>

  <p class="calibre2">As you see, this is almost the same as the specification 1. Except for the last line. Anyway, translating the spec into the code leads us to the following:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstances()
{
  //GIVEN

  //WHEN
  MessageFactory factory = null;

  Action whenCreatingANewInstanceOfLocationMessageFactoryClass
    = () =&gt; 
    {
      factory = new LocationMessageFactory();
    };
  
  //THEN
  Assert.DoesNotThrow(
    whenCreatingANewInstanceOfLocationMessageFactoryClass
  );
}
</pre>

  <p class="calibre2">Note that we did not declare the factory variable using var keyword, but as a base type. This is also a part of specification - it says that LocationMessageFactory is a subtype of MessageFactory.</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">This spec created a need to have a LocationMessageFactory class that implements MessageFactory interface and has a parameterless constructor. Let’s provide it then!</p>
  <pre class="calibre10">
public class LocationMessageFactory : MessageFactory
{
  public LocationMessageFactory()
  {
    throw new Exception();
  }

  public Message Wrap(Frame frame)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">Note two things: first, we put an exception into the constructor, so that the spec we created can fail on assertion (Assert.DoesNotThrow). The second thing to note - the interface signature forced us to provide an implementation for a method called Wrap - currently it throws NotImplementedException and is out of scope of the current specification. By the way, I treat all NotImplementedExceptions as TODO list items - we’ll take care of it when we examine our TODO list in a minute. For now, the spec fails for proper reason, so let’s get to the next stage.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">We make this spec pass by removing the constructor we introduced earlier. Remember that we don’t have to touch the Wrap method, since it’s out of scope of current specification. The code looks like this:</p>
  <pre class="calibre10">
public class LocationMessageFactory : Messagefactory
{
  public Message Wrap(Frame frame)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off the item related to implementing MessageFactory class. Now we have all the initial items crossed off, but another one popped out in the meantime - the NotImplementedException inside the Wrap method - it clearly points that we need to provide a behavior over there.</p>

  <p class="calibre2">Our current TODO list:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13">Implement Message interface</li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from Wrap method in LocationMessageFactory class</strong></li>
  </ol>

  <p class="calibre2">The newly added item on the TODO list is our next target.</p>

  <h3 class="sigilnotintoc">Specification 4: wrapping frames with messages</h3>

  <p class="calibre2">Let’s implement the Wrap method in LocationMessageFactory so that it actually creates something useful for us.</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">A Given-When-Then form of the spec looks like this:</p>
  <pre class="calibre10">
Given a factory
And any frame
When I ask the factory to wrap the frame
Then it should create a LocationMessage object from the frame
</pre>

  <p class="calibre2">Which translates into the following code:</p>
  <pre class="calibre10">
[Fact]
public void ShouldWrapFramesWithLocationMessageObjects()
{
  //GIVEN
  var factory = new LocationMessageFactory();
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();

  //WHEN
  var result = factory.Wrap(anyFrame);
  
  //THEN
  Assert.IsType&lt;LocationMessage&gt;(result);
}
</pre>

  <p class="calibre2">There’s one thing that might seem wierd about this spec - we specify nowhere that the message is wrapping the particular frame we pass to it - it can just create another one or just wrap nothing. Is it wrong? I think not - the creational specs are always awkward and you can almost never specify entirely from which objects another object is created. We will just have to trust the production code that it wraps the frame (by the way, there are some cases where object construction rules are so complex that we DO want to specify them in detail, but this is not such a case).</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">The spec creates a need for a new type - a LocationMessage. An instance of this type needs to be created by the factory in order to fulfill this spec. That’s why we won’t have to write a separate creational specification for creating LocationMessage objects - we’re specifying everything we need in the factory specification already.</p>

  <p class="calibre2">Anyway, the first thing to do is to satisfy the newly introduced need and create a LocationMessage. It needs to implement the Message interface, otherwise the code won’t compile. Here’s the implementation of the LocationMessage class:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  public LocationMessage(Frame frame)
  {
    //We'll need this anyway, so I'm adding it now.
  }

  void ValidateWith(ValidationRules rules)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">I added a constructor, although it wasn’t forced directly by the specification (such cases should be extremaly rare). Also, implementing the Message interface forced us to provide an implementation of the ValidateWith method. For now we don’t care about it, since it’s out of scope of the current specification, but we’ll be adding it to our TODO list shortly.</p>

  <p class="calibre2">Even though we needed the LocationMessage to make the compilation pass, we won’t be using it in the factory implementation just yet. The specification expects an object of type LocationMessage to pass, so in order to fail for proper reason, we’ll have to make the factory return something different. The quick choice for such cases is null:</p>
  <pre class="calibre10">
public class LocationMessageFactory : Messagefactory
{
  public Message Wrap(Frame frame)
  {
    return null;
  }
}
</pre>

  <p class="calibre2">Ok, the specification expects an instance of type LocationMessage, but gets a null instead - the spec fails on assertion, which is proper reason for it to fail and it means it’s time to move on to the next stage.</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">In order to do this, we’ll just have to return an instance of LocationMessage type and use the constructor we have created:</p>
  <pre class="calibre10">
public class LocationMessageFactory : Messagefactory
{
  public Message Wrap(Frame frame)
  {
    return new LocationMessage(frame);
  }
}
</pre>

  <p class="calibre2">Finished! Now to check the TODO list!</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off the item related to implementing Wrap method as well as implementing Message interface. Also, by implementing the Message interface with LocationMessage class, which, just to remind you, looks like this:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  public LocationMessage(Frame frame)
  {
    //We don't need to use the frame just yet
  }

  void ValidateWith(ValidationRules rules)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">we discovered that we need to supply implementation to the ValidateWith method, which currently throws a NotImplementedException. This item should be added to our list.</p>

  <p class="calibre2">So, to sum up, the list looks like this:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ValidateWith method in LocationMessage class</strong></li>
  </ol>

  <p class="calibre2">We already know that we have three fields in the class: Speed, Age and Sender, so we can add more details to the last item and split it into three:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main workflow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strong></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strong></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strong></li>
  </ol>

  <p class="calibre2">Again, there’s no sense in picking ValidationRules interface implementation, since it has no methods, so let’s take the three last items, one by one.</p>

  <h3 class="sigilnotintoc">Specification 5: Submit Speed field to validation</h3>

  <p class="calibre2">As I stated previously, the reason Message abstraction exists is to decouple validation rules from the frame structure. The choice of which validation rule to apply to which frame field should be made by implementations of the Message interface - i.e. LocationMessage. The first field that needs to be passed to a validation rule is Speed.</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">Again, let’s use a Given-When-Then notation, to write down the following:</p>
  <pre class="calibre10">
Given any frame
And a location message wrapping that frame
And validation rules
When I validate the message using the validation rules
Then validation rule for integer values should be applied to the Speed field
</pre>

  <p class="calibre2">Translated into code, it looks like this:</p>
  <pre class="calibre10">
[Fact]
public void ShouldPerformValidationForSpeedFieldWhenValidated()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var message = new LocationMessage(anyFrame);
  var validationRules = Substitute.For&lt;ValidationRules&gt;();
  
  //WHEN
  message.ValidateWith(validationRules);

  //THEN 
  validationRules.Received().ApplyTo(anyFrame.Speed);
}
</pre>

  <p class="calibre2">Note that this is actually the first time we’re referencing a field of the Frame class! What’s more, we expect it to be passed into the validation rules which don’t know that the passed value belongs to the frame. Thus, we have managed to successfully encapsulate the frame structure inside the LocationMessage class and decouple it from validation rules.</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">The specification created a need for one new method inside VlidationRules interface: ApplyTo with an int argument. To satisfy this need, let’s provide the necessary signature inside the ValidationRules interface:</p>
  <pre class="calibre10">
public interface ValidationRules
{
  void ApplyTo(int intValue);
}
</pre>

  <p class="calibre2">This is great news, because up to now, the ValidationRules interface was empty and we had no clue what to do with it. Now we do, but we’ll leave it for later as currently the implementation of ApplyTo method is out of scope.</p>

  <p class="calibre2">Another thing to do is to remove the NotImplementedException from the ValidateWith method inside the LocationMessage class. Done. Now it looks like this:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  public LocationMessage(Frame frame)
  {
    //We don't need to use the frame just yet
  }

  void ValidateWith(ValidationRules rules)
  {
    
  }
}
</pre>

  <p class="calibre2">The spec fails because a call to ApplyTo method with specific int value was expected on the validationRules, but was not performed, which means that the spec fails for proper reason.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">The implementation that makes our code fulfill the spec is really easy, so I’ll just type it in:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  private readonly Frame wrappedFrame;

  public LocationMessage(Frame frame)
  {
    wrappedFrame = frame; //added
  }

  void ValidateWith(ValidationRules rules)
  {
    rules.ApplyTo(frame.Speed); //added  
  }
}
</pre>

  <p class="calibre2">And that’s it.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off Speed field:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Age field</li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
  </ol>

  <p class="calibre2">Looking at the TODO list, it should be very easy to implement the Age field validation, as it’s an integer, just like Speed, which we just finished implementing. Let’s take it on then!</p>

  <h3 class="sigilnotintoc">Specification 6: Submit Age field to validation</h3>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">The spec is going to be almost the same as previously, so all we need to do is copy the previous one and make a change or two. Hey, we’re copy-pasting here! Let’s use this as an opportunity to perform an experiment - we’ll make an error by correcting only the name of the pasted specification, leaving the validated field name as Speed (not Age, which should be here instead) and watch whether we can get away with it:</p>
  <pre class="calibre10">
[Fact]
public void ShouldPerformValidationForAgeFieldWhenValidated()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var message = new LocationMessage(anyFrame);
  var validationRules = Substitute.For&lt;ValidationRules&gt;();
  
  //WHEN
  message.ValidateWith(validationRules);

  //THEN 
  //Oh, we forgot to change Speed to Age…
  validationRules.Received().ApplyTo(anyFrame.Speed);
}
</pre>

  <p class="calibre2">What happens? The spec passes right away - a warning sign!</p>

  <div class="calibre47">
    Test-first has this advantage when compared to test-after, that we always validate the specification by letting it fail at first for proper reason. When a specification passes right away after being written, then it’s a warning sign and we need to investigate what’s going on.
  </div>

  <p class="calibre2">It feels really good to be protected somehow from copy-pasting errors :-). Let’s quickly correct the spec:</p>
  <pre class="calibre10">
[Fact]
public void ShouldPerformValidationForAgeFieldWhenValidated()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var message = new LocationMessage(anyFrame);
  var validationRules = Substitute.For&lt;ValidationRules&gt;();
  
  //WHEN
  message.ValidateWith(validationRules);

  //THEN 
  //corrected:
  validationRules.Received().ApplyTo(anyFrame.Age);
}
</pre>

  <p class="calibre2">There, this should do it - the spec fails on mock verification which is what we were aiming at.</p>

  <div class="calibre47">
    Some of you may notice that I’m not using Setup and Teardown kind of methods. This is on purpose - not only do Setup and Teardown make the tutorial hard to follow by splitting specifications into several methods, they also have other problems. So for me, a better (and yes - more maintainable!) way is even to copy-paste existing specification and make some adjustments that to use Setup and Teardown. Maybe someday I’ll write a post on that. In the meantime you can look for some arguments from both sides of the fence in the internet, as such approach has its proponents and opponents.
  </div>

  <div class="calibre47">
    Another question that may be raised is: why don’t I write one specifications for all the fields, but a separate spec for each of them? Actually, there’s no big deal about that. The main reason is that in case I did one specification for all the fields, I would have to name it something like ShouldApplyValidationRulesToAllFields() - it would not tell me which rules apply to which field. I like to think of unit test tool report (which consists of unit test names) as a form of documentation and by separating the specifications for each field, I make this documentation more verbose.
  </div>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">The specification already fails for proper reason. We’re expecting validation rules to be applied to field named Age, but there’s no such logic inside the LocationMessage’s ValidateWith method’s implementation.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Just add one line of code and we’re all set:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  private readonly Frame wrappedFrame;

  public LocationMessage(Frame frame)
  {
    wrappedFrame = frame;    
  }

  void ValidateWith(ValidationRules rules)
  {
    rules.ApplyTo(frame.Speed);
    rules.ApplyTo(frame.Age); //added this line
  }
}
</pre>

  <p class="calibre2">Ok, it passes - now, wasn’t that easy?</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off another item from the TODO list - the one about Age field, leaving us with the following:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
  </ol>

  <p class="calibre2">Only two choices left. Since we already began with the ValidateWith method, let’s take on the last one from this series - the one related to Sender field.</p>

  <h3 class="sigilnotintoc">Specification 7: Submit Sender field to validation</h3>

  <p class="calibre2">This case is going to be pretty much the same as with both previous fields, only this time we’ll be handling a string instead of an integer.</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">In order to create a specification in a Given-When-Then notation, let’s write down the following:</p>
  <pre class="calibre10">
Given any frame
And a location message wrapping that frame
And a validation
When I validate the message using the validationRules
Then validation rule for string values should be applied to the Sender field
</pre>

  <p class="calibre2">The spec is going to look pretty much the same as two previous ones:</p>
  <pre class="calibre10">
[Fact]
public void ShouldPerformValidationForSenderFieldWhenValidated()
{
  //GIVEN
  var anyFrame = Any.InstanceOf&lt;Frame&gt;();
  var message = new LocationMessage(anyFrame);
  var validationRules = Substitute.For&lt;ValidationRules&gt;();
  
  //WHEN
  message.ValidateWith(validationRules);

  //THEN 
  validationRules.Received().ApplyTo(anyFrame.Sender);
}
</pre>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">As I said, the only difference is that this time, Sender is a string value. Yet we still use the ApplyTo name for a method expected to be called, although its declaration looks like this:</p>
  <pre class="calibre10">
public interface ValidationRules
{
  void ApplyTo(int intValue);
}
</pre>

  <p class="calibre2">Thus, the spec won’t compile. It means that we created a need for an overload of the ApplyTo method, taking a string argument:</p>
  <pre class="calibre10">
public interface ValidationRules
{
  void ApplyTo(int intValue);
  void ApplyTo(string stringValue); //added line
}
</pre>

  <p class="calibre2">That makes our spec compile and fail for proper reason - we were expecting ApplyTo method to be called, but it wasn’t.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">The implementation of this spec is going to be as easy as the previous one. Just watch:</p>
  <pre class="calibre10">
public class LocationMessage : Message
{
  private readonly Frame wrappedFrame;

  public LocationMessage(Frame frame)
  {
    wrappedFrame = frame;    
  }

  void ValidateWith(ValidationRules rules)
  {
    rules.ApplyTo(frame.Speed);
    rules.ApplyTo(frame.Age);
    rules.ApplyTo(frame.Sender); //added this line
  }
}
</pre>

  <p class="calibre2">Ok, that’s it.</p>

  <div class="calibre47">
    One may argue that using the same name for different validation methods does not provide enough readability, because when looking at the implementation of ValidateWith method, one can’t really tell that two different validation rules are being applied - it looks like it’s always one. This is a valid argument and one may consider giving the validation methods distinct names, such as ApplyToInt for integers and ApplyToString for strings. For this kata, I’ll leave the overloads, since it doesn’t really matter so much.
  </div>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">Another item to cross off from our TODO list, this time for implementing the Sender field:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main workflow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13">Implement ValidationRules interface</li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>
  </ol>

  <p class="calibre2">which leaves us with only one item: implementation of the ValidationRules interface.</p>

  <h3 class="sigilnotintoc">Specification 8: Creating new instances of SimpleValidationRules class</h3>

  <p class="calibre2">We decide that the implementation of the ValidationRules interface will be called SimpleValidationRules. We need to drive the existence of this class and the following Given-When-Then specification will help us with this task:</p>
  <pre class="calibre10">
Given nothing
When I create a new instance of SimpleValidationRules class
Then it should not result in any kind of exception
</pre>

  <p class="calibre2">Without further comments, let’s take it to the code:</p>
  <pre class="calibre10">
[Fact]
public void ShouldAllowCreatingNewInstances()
{
  //GIVEN

  //WHEN
  ValidationRules rules = null;

  Action whenCreatingANewInstanceOfSimpleValidationRulesClass
    = () =&gt; 
    {
      rules = new SimpleValidationRules();
    };
  
  //THEN
  Assert.DoesNotThrow(
    whenCreatingANewInstanceOfSimpleValidationRulesClass
  );
}
</pre>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">We created a need to have a SimpleValidationRules class implementing ValidationRules interface. To satisfy this need, we’ll have to create this class. Here we go:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public void SimpleValidationRules()
  {
    throw new NotImplementedException();
  }

  public void ApplyTo(int intValue)
  {
    throw new NotImplementedException();
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">As you see, the interface signature forced us to implement ApplyTo method in two flavors. We do not need to concern ourselves with that yet, but we’ll get back to it when evaluating TODO list.</p>

  <p class="calibre2">For now, the spec fails on assertion, i.e. for a proper reason. It means that we can proceed with the next stage. By the way, I put an exception in the constructor again just to make the spec fail - if I didn’t introduce the constructor at all, it would probably be green by now. Just to remind you, this is to make a point that we can follow a strict set of steps almost mechanically and that specification failing for proper reason is so valuable as a source of feedback, that we’re willing to put in a bit of extra code just to attain it.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Piece of cake - just remove the constructor:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public void ApplyTo(int intValue)
  {
    throw new NotImplementedException();
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">And done - the spec passes. No further comments needed.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">Fulfilling this specification led us to discovering a new class with two methods not yet implemented - we need to add them. Also, we can cross off implementing ValidationRules interface, since we just did it:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ApplyTo method in SimpleValidationRules class for integer values</strong></li>

    <li class="calibre13"><strong class="calibre14">Implement behavior required from ApplyTo method in SimpleValidationRules class for string values</strong></li>
  </ol>

  <p class="calibre2">But this is not end yet! Let’s remind ourselves what exactly hides below these two newly added items by looking back at the table from the exercise description:</p>

  <table class="calibre39">
    <tr class="calibre21">
      <th class="calibre40">type of field</th>

      <th class="calibre40">Correctness criteria</th>

      <th class="calibre40">When satisfied</th>

      <th class="calibre40">When not satisfied</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre41">int</td>

      <td class="calibre41">greater than 0</td>

      <td class="calibre41">do nothing</td>

      <td class="calibre41">throw exception</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre42">string</td>

      <td class="calibre42">not null and not empty</td>

      <td class="calibre42">do nothing</td>

      <td class="calibre42">throw exception</td>
    </tr>
  </table>

  <p class="calibre2">From the table, it looks like we have the following exact behaviors to specify and implement inside SimpleValidationRules class:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to integer less than or equal 0</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should not throw exception when applied to integer greater than 0</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to null string</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to empty string</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</strong></li>
  </ol>

  <p class="calibre2">When we look at the TODO items, there is one more thing that attracts our attention - it’s the ‘0’ in both items related to integer validation. In contrast to null and empty string, 0 is not a special kind of value here - it’s a number like any other. It may be 0 today, and 5 tomorrow. Leaving it in two specifications will lead us to maintaining two specs whenever this number changes. That’s why we’ll extract the requirement for this value to be 0 into a separate TODO list item. At the same time, we’ll rewrite the two items to be more general:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should treat 1 as minimum allowed integer</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to null string</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should throw exception when applied to empty string</strong></li>

    <li class="calibre13"><strong class="calibre14">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</strong></li>
  </ol>

  <p class="calibre2">The only thing to note here is that we changed 0 to 1 while adjusting the greater/less conditions (what was previously less than or equal 0, now is less than 1 etc.). We could keep the 0, but thinking in terms of “minimum allowed value” (which is 1) is easier for me than in terms of “maximum disallowed value” (which is 0). You may choose to do otherwise when you perform this kata on your own.</p>

  <p class="calibre2">Let’s take on the first unimplemented item.</p>

  <h3 class="sigilnotintoc">Specification 9: Throwing exceptions when applied to integers that are less than minimum allowed integer value</h3>

  <p class="calibre2">From now on, we’ll move forward without mocks, as we’ve reached the border of the system. Most of the specification we’ll be writing are called <a href="http://www.sustainabletdd.com/2012/01/test-categories.html">functional specifications</a> (as opposed to mock-based work-flow specifications and creational specifications that we were doing so far) and a little bit different practices apply to this kind of specs, as we’ll shortly see. Also, we’ll speed up a little with more obvious parts.</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">Our specification in the Given-When-Then form:</p>
  <pre class="calibre10">
Given simple validation rules
When I apply them to an integer value less than minimum allowed integer by at least 1
Then an exception should be thrown
</pre>

  <p class="calibre2">This is pretty straightforward. Translating the spec into the code leaves us with the following:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldThrowExceptionWhenValidatedIntegerIsBelowAllowedMinimum()
{
  //GIVEN
  var rules = new SimpleValidationRules();
  var integerBelowAllowedMinimum 
    = SimpleValidation.MinimumAllowedInteger - 1;

  //WHEN
  Action applyingRulesToIntegerBelowAllowedMinimum 
    = () =&gt; rules.ApplyTo(integerBelowAllowedMinimum);

  //THEN
  Assert.Throws&lt;Exception&gt;(applyingRulesToIntegerBelowAllowedMinimum);
}
</pre>

  <p class="calibre2">Why did we use SimpleValidation.MinimumAllowedInteger - 1? because it’s the thinnest possible boundary between two behaviors - throwing when value is invalid and not throwing when it’s valid. You can read more on this in <a href="http://www.sustainabletdd.com/2012/01/test-categories.html">a great post by Amir Kolsky and Scott Bain</a>.</p>

  <p class="calibre2">Now, let’s see what’s missing…</p>

  <h4 class="sigilnotintoc1">Making it fail for proper reason</h4>

  <p class="calibre2">As it stands now, the code does not compile. We’re missing the SimpleValidation.MinimumAllowedInteger constant (since the above spec is the first place in the code where it actually appears). Let’s introduce it then:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const int MinimumAllowedInteger = 12345; //TODO

  public void ApplyTo(int intValue)
  {
    throw new NotImplementedException();
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">By giving this constant a value of 12345 and placing a TODO next to it, we’re signalizing that it doesn’t really matter for now what the value of this constant is, but we’ll need to take care of it later (by the way, it’s already on our TODO list - remember?).</p>

  <p class="calibre2">This time the spec not only compiles, but it also passes, thanks to a NotImplementedException thrown from inside of ApplyTo method. I’m sorry, but you know the rules - we have to make it fail :-). In order to do so, we’ll remove throwing the mentioned NotImplementedException:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const int MinimumAllowedInteger = 12345; //TODO

  public void ApplyTo(int intValue)
  {
    //removed throwing exception from here
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">Great, now the spec fails for the correct reason - we were expecting a call to ApplyTo method to throw an exception, but nothing was thrown.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">The specification expects an exception to be thrown, so let’s throw it! Only this time, as opposed to the previous throw that was present in the ApplyTo method, we’re gonna throw an object of class Exception, not NotImplementedException:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const MinimumAllowedInteger = 12345; //TODO

  public void ApplyTo(int intValue)
  {
    throw new Exception(); //added line
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">And we’re done!</p>

  <div class="calibre47">
    “Are we really done here?” - one might argue. This logic does not validate anything - it just throws an exception! That’s true, however, we have to remember that we only do what’s necessary to make the existing specs pass. Every specification introduces a behavioral distinction and we have not yet introduced a specification that tells us when not to throw. We should add such specification to the TODO list - oh, actually, we already did that! We’ll try to fulfil it in a minute, just after we examine our TODO list.
  </div>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off throwing exception when validated integer is below allowed minimum from our TODO list:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</li>

    <li class="calibre13">SimpleValidationRules should treat 1 as minimum allowed integer</li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to null string</li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to empty string</li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</li>
  </ol>

  <p class="calibre2">Now let’s specify when the exception should not be thrown.</p>

  <h3 class="sigilnotintoc">Specification 10: not throwing exception when validated integer is at least minimum allowed integer</h3>

  <p class="calibre2">First, a Given-When-Then specification:</p>
  <pre class="calibre10">
Given simple validation rules
When I apply them to an integer value less than minimum allowed integer by at least 1
Then an exception should be thrown
</pre>

  <p class="calibre2">Second, its translation into the code:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldNotThrowAnyExceptionWhenValidatedIntegerIsAtLeastAllowedMinimum()
{
  //GIVEN
  var rules = new SimpleValidationRules();
  var integerAtLeastOfMinimumAllowedValue
    = SimpleValidation.MinimumAllowedInteger;

  //WHEN
  Action applyingRulesToIntegerAtLeastOfAllowedMinimum 
    = () =&gt; rules.ApplyTo(integerAtLeastOfMinimumAllowedValue);

  //THEN
  Assert.DoesNotThrow(applyingRulesToIntegerAtLeastOfAllowedMinimum);
}
</pre>

  <p class="calibre2">We picked SimpleValidation.MinimumAllowedInteger value for this specification because it’s a boundary value for specified behavior. Now to make it fail for proper reason…</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">Actually… it already fails for proper reason - the specification expects that no exception is thrown, but it’s thrown. All we need to do is to…</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Remember that this is a second specification that passes through the ApplyTo method with int argument. Thus, while implementnig this one, we have to take care not to make the previous one fail. The boundary between the two behaviors described by the specs is the SimpleValidation.MinimumAllowedInteger, so let’s turn this knowledge into an if statement:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const int MinimumAllowedInteger = 12345; //TODO

  public void ApplyTo(int intValue)
  {
    if(intValue &lt; MinimumAllowedInteger) //added
    {                                       //added
      throw new Exception();
    }                                       //added
  }

  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
}
</pre>

  <p class="calibre2">Now both specs pass, which means we can go on.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We can cross off another item on the TODO list - the one related to not throwing exceptions when validating integer that’s at least of allowed minimum integer value:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strike></li>

    <li class="calibre13">SimpleValidationRules should treat 1 as minimum allowed integer</li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to null string</li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to empty string</li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</li>
  </ol>

  <p class="calibre2">To finish off the integer validation functionality, let’s take on treating 1 as minimum allowed integer.</p>

  <h3 class="sigilnotintoc">Specification 11: 1 should be used as minimum valid integer</h3>

  <p class="calibre2">This time, to breathe a bit of fresh air, it’s gonna be a <a href="http://www.sustainabletdd.com/2012/02/testing-best-practices-test-categories.html">constant specification</a>. We’ll go faster with this one as it’s a really obvious to specify and implement. We don’t even have to come up with a Given-When-Then specification.</p>

  <p class="calibre2">Here’s the spec:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldTreat1AsMinimumAllowedInteger()
{
  Assert.Equal(1, SimpleValidationRules.MinimumAllowedInteger);
}
</pre>

  <p class="calibre2">This fails for proper reason straight away, because the spec expects 1, but it gets 12345, so let’s make a change to make it pass:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const MinimumAllowedInteger = 1;

  //... the two ApplyTo methods…
}
</pre>

  <p class="calibre2">Done! we can cross off another item from our TODO list:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should treat 1 as minimum allowed integer</strike></li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to null string</li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to empty string</li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</li>
  </ol>

  <p class="calibre2">Ok, the last functionality to implement is the one related to the string validation rules. Let’s go!</p>

  <h3 class="sigilnotintoc">Specification 12: throwing exceptions when validated string is null</h3>

  <p class="calibre2">This case is very similar to throwing exceptions during integer validations. If you’re bored reading this, you can just skim through this section briefly as there’s nothing new to learn here.</p>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">Our Given-When-Then specification looks like this:</p>
  <pre class="calibre10">
Given simple validation rules
When I apply them to a null string
Then an exception should be thrown
</pre>

  <p class="calibre2">which translates into:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldThrowExceptionWhenAppliedToNullString()
{
  //GIVEN
  var rules = new SimpleValidationRules();
  string nullString = null;

  //WHEN
  Action applyingRulesToNullString
    = () =&gt; rules.ApplyTo(nullString);

  //THEN
  Assert.Throws&lt;Exception&gt;(applyingRulesToNullString);
}
</pre>

  <p class="calibre2">No new methods or classes needed to compile this. Also, it already passes because currently the implementation of ApplyTo for strings already throws an exception:</p>
  <pre class="calibre10">
  public void ApplyTo(string stringValue)
  {
    throw new NotImplementedException();
  }
</pre>

  <p class="calibre2">Let’s make it fail for proper reason.</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">We can achieve this by removing throwing the exception from the ApplyTo method like this:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const int MinimumAllowedInteger = 1;

  public void ApplyTo(int intValue)
  {
    if(intValue &lt; MinimumAllowedInteger)
    {
      throw new Exception();
    }
  }

  public void ApplyTo(string stringValue)
  {
    //removed throwing NotImplementedException
  }
}
</pre>

  <p class="calibre2">The specification expects that exception is thrown, but none is, so the failure is for proper reason.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Putting an exception back (but not NotImplementedException, since we mark TODO items with these) will do it:</p>
  <pre class="calibre10">
public class SimpleValidationRules : ValidationRules
{
  public const int MinimumAllowedInteger = 1;

  public void ApplyTo(int intValue)
  {
    if(intValue &lt; MinimumAllowedInteger)
    {
      throw new Exception();
    }
  }

  public void ApplyTo(string stringValue)
  {
    throw new Exception();
  }
}
</pre>

  <p class="calibre2">The spec passes now, so we’re all happy - time to move on.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">Another item to get rid of from the TODO list - the one related to throwing exception when null string is validated:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should treat 1 as minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to null string</strike></li>

    <li class="calibre13">SimpleValidationRules should throw exception when applied to empty string</li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</li>
  </ol>

  <p class="calibre2">Great - only two more to go! We’re almost there! Let’s pick up the next item - throwing exception on empty string.</p>

  <h3 class="sigilnotintoc">Specification 13: throwing exceptions when validating empty string</h3>

  <p class="calibre2">The Given-When-Then specification is almost the same as the previous one:</p>
  <pre class="calibre10">
Given simple validation rules
When I apply them to an empty string
Then an exception should be thrown
</pre>

  <p class="calibre2">which translates into:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldThrowExceptionAppliedToEmptyString()
{
  //GIVEN
  var rules = new SimpleValidationRules();
  string nullString = null;

  //WHEN
  Action applyingRulesToNullString
    = () =&gt; rules.ApplyTo(nullString);

  //THEN
  Assert.Throws&lt;Exception&gt;(applyingRulesToNullString);
}
</pre>

  <p class="calibre2">This specification compiles and passes instantly. As you remember, we have to make it fail for proper reason. But wait, this time we cannot remove throwing the exception, because the previous specification will fail. What are we gonna do?</p>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">You won’t like this probably, but we’ll add temporary code to ApplyTo method just to make this one specification fail.</p>

  <p class="calibre2">Here’s this code:</p>
  <pre class="calibre10">
  public void ApplyTo(string stringValue)
  {
    if(stringValue != string.Empty) //added temporary code
    {                               //added temporary code
      throw new Exception();
    }                               //added temporary code
  }
</pre>

  <p class="calibre2">You may think I’m insane to put in so much code just to make a specification fail, but remember I’m trying to make a point during this kata ;-).</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Now that we know that the spec can fail for proper reason, we can revert the changes we just made and get back to the previous implementation that was actually good enough :-).</p>
  <pre class="calibre10">
  public void ApplyTo(string stringValue)
  {
    // this is good enough to pass the current spec
    // and the previous one.
    throw new Exception();
  }
</pre>

  <p class="calibre2">You may think this is really funny - we made some effort just to revert it back. What we gained from it is a new specification and a certainty that it can fail when it’s not fulfilled.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">Another item to cross off:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main work-flow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should treat 1 as minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to null string</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to empty string</strike></li>

    <li class="calibre13">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</li>
  </ol>

  <p class="calibre2">Now, it’s time for the last one and we’re finished!</p>

  <h3 class="sigilnotintoc">Specification 13: not throwing exception when validated string is neither null nor empty</h3>

  <h4 class="sigilnotintoc1">Create a specification</h4>

  <p class="calibre2">The last specification in a Given-When-Then form:</p>
  <pre class="calibre10">
Given simple validation rules
When I apply them to a string that's neither null nor empty
Then no exception should be thrown
</pre>

  <p class="calibre2">which translates into:</p>
  <pre class="calibre10">
[Fact]
public void 
ShouldNotThrowExceptionWhenAppliedToAStringThatIsNeitherNullNorEmpty()
{
  //GIVEN
  var rules = new SimpleValidationRules();
  string notNullNotEmptyString = Any.MeaningfulString();

  //WHEN
  Action applyingRulesToNotNullNotEmptyString
    = () =&gt; rules.ApplyTo(notNullNotEmptyString);

  //THEN
  Assert.DoesNotThrow(applyingRulesToNotNullNotEmptyString);
}
</pre>

  <h4 class="sigilnotintoc1">Make it fail for proper reason</h4>

  <p class="calibre2">It already compiles and fails for proper reason - the specification is expecting no exception, but one is thrown so nothing needs to be done at this stage.</p>

  <h4 class="sigilnotintoc1">Make it pass</h4>

  <p class="calibre2">Currently, the implementation of ApplyTo method looks like this:</p>
  <pre class="calibre10">
  public void ApplyTo(string stringValue)
  {
    throw new Exception();
  }
</pre>

  <p class="calibre2">I.e. it always throws. What we want is to make it not throw when passed string is neither null nor empty. Actually, implementing it is quite easy:</p>
  <pre class="calibre10">
  public void ApplyTo(string stringValue)
  {
    if(!string.IsNullOrEmpty(stringValue)) //added
    {                                      //added
      throw new Exception();
    }                                      //added
  }
</pre>

  <p class="calibre2">This makes our final specification pass.</p>

  <h4 class="sigilnotintoc1">Examine TODO list</h4>

  <p class="calibre2">We cross off the final item from TODO list:</p>

  <ol class="calibre12">
    <li class="calibre13"><strike class="calibre29">Create entry point to the module (top-level abstraction)</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement main workflow of the module</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement Message interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement MessageFactory interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement ValidationRules interface</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from Wrap method in LocationMessageFactory class</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Speed field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Age field</strike></li>

    <li class="calibre13"><strike class="calibre29">Implement behavior required from ValidateWith method in LocationMessage class for Sender field</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to integer less than minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to integer greater or equal to minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should treat 1 as minimum allowed integer</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to null string</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should throw exception when applied to empty string</strike></li>

    <li class="calibre13"><strike class="calibre29">SimpleValidationRules should not throw exception when applied to string that’s neither null nor empty</strike></li>
  </ol>

  <p class="calibre2">and we’re all set! <strong class="calibre14">Congratulations - you managed to get with me through this lengthy tutorial :-)</strong></p>

  <p class="calibre2">Now, there are few things we need to discuss before we finish</p>

  <h3 class="sigilnotintoc">1. What’s “better” in this implementation than in the previous, “worse” one?</h3>

  <p class="calibre2">Compared to the <a href="http://feelings-erased.blogspot.com/2012/09/a-kata-challenge-to-try-your-tdd-skills_25.html">previous approach</a>, we wrote 13 specifications as opposed to 8 last time. This means that we wrote 5 more specs! What’s the return of investment?</p>

  <p class="calibre2">Let’s compare the two solutions against some exemplary changes:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre22">Exemplary change</th>

      <th class="calibre22">Previous solution</th>

      <th class="calibre22">New solution</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">Field <strong class="calibre14">int Longitude</strong> is added to the frame</td>

      <td class="calibre23">Maintain 4 existing specs, write 1 new</td>

      <td class="calibre23">Write 1 new spec</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">New validation rule is added for Speed field that it has to be less than 100</td>

      <td class="calibre23">Maintain 4 existing specs, write 1 new</td>

      <td class="calibre23">Write 3 new specs</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre23">The existing validation rule for integers changes so that now they have to be less than 0 instead of more than 0</td>

      <td class="calibre23">Maintain 4 existing specs</td>

      <td class="calibre23">Maintain 2 existing specs</td>
    </tr>
  </table>

  <p class="calibre2">The difference grows as more fields and more validation rules are added and the advantage of the approach described in this post becomes more obvious. If you don’t believe me, try it out and see for yourself.</p>

  <h3 class="sigilnotintoc">2. What about refactoring?</h3>

  <p class="calibre2">That’s right - the TDD cycle is red-green-refactor, but I didn’t even mention the last one during the kata. This was done on purpose - let me explain myself :-). With the previous, screwed up approach to this kata, I stated that what I wrote should be refactored, but I’d start from scratch next time anyway. So this time I started from scratch and made it so that no refactoring is necessary. This is because most of the TDD tutorials I saw that involve refactoring are hard to follow. So I traded off showing full TDD cycle for the example being easy to follow and understand. In normal circumstances (not educational ones), I’d probably go with the approach shown earlier and refactor to this approach when the specifications would tell me that the design contains smells.</p>

  <p class="calibre2">Another reason is that the kata shows a single slice of functionality, and no incremental scope pulling is taking place.</p>

  <p class="calibre2">Maybe someday I’ll write a post on refactoring so that we get from previous attempt to this one. For now, I’m skipping it.</p>

  <h3 class="sigilnotintoc">3. Can’t we abstract the invalid values for strings? Isn’t the current solution a code smell?</h3>

  <p class="calibre2">By the way, if you look at some parts of the solution, namely the string validation, you can spot that it can be further abstracted. Instead of hardcoding two cases where a string is invalid (null and empty string), we could turn it into a list of invalid values and implement a general mechanism inside SimpleValidationRules that compares a validated string with such list. This would make the specs even more maintainable, but I consider it an overdesign. Not every mechanism is worth abstracting away and nothing points that more than two values will be forbidden. Of course, if this assumption doesn’t hold in the future, the specs will tell me that. For now, I prefer keeping this part simple.</p>

  <h3 class="sigilnotintoc">Summary</h3>

  <p class="calibre2">I hope this post is of any use for anyone - I made a lot of effort to put it together. Of course, it lacks some aspects of TDD (e.g. acceptance specifications or refactoring), but should give a general feel of how we can derive design and responsibilities using executable specifications and test-first approach.</p>

  <p class="calibre2">By the way, the post is so long that I probably made at least few mistakes when writing it. If you see any of those, please let me know. Also, I welcome any feedback - feel free to leave a comment!</p>

  <p class="calibre2">That’s all for now - see ya!</p>
</div>


<div class="calibre4" id="calibre_link-41">
  <p class="calibre2">Thanks go to Grzegorz Sławecki for inspiration.</p>

  <h3 class="sigilnotintoc">Exemplary problem</h3>

  <p class="calibre2">Imagine we’re in a different reality, where tests are written after the code. we have written the following code (by the way, it’s not perfect as an example of using WCF, but it’s out of scope of this post):</p>
  <pre class="calibre10">
public class SendingFromBuffer
{
  Buffer _buffer;

  public SendingThroughBuffer(Buffer buffer)
  {
    _buffer = buffer;
  }
    
  public void Perform()
  {
    var destination = CreateDestination ();
    while (_buffer.HasPackets()) 
    {
      destination.Send (_buffer.GetPacket ());
    }
  }
    
  public Destination CreateDestination()
  {
    var binding = new BasicHttpBinding();
    var endpoint = new EndpointAddress(
      "http://localhost/MyService/Something");
    var channelFactory = new ChannelFactory&lt;Destination&gt;(
      binding, endpoint);
    return channelFactory.CreateChannel();
  }
}
</pre>

  <p class="calibre2">And now we would like to write a unit test for it. In particular - for the sending logic.</p>

  <p class="calibre2">Actually, we could do it easily if not for the result of CreateDestination() method. It’s a WCF channel, so sending anything through it without actually connecting to the server yields an exception. To execute the code as is, we would need set up a server and use the operating system networking capabilities and (remember!) we want to be isolated from the operating system as much as we can during unit test. Also setting up a WCF server impacts unit test performance, making it slower.</p>

  <p class="calibre2">As the code wasn’t written test-first, it’s already untestable, so we’ll have to refactor it (wow, and imagine it was created just about an hour ago!) to isolate ourselves from the WCF channel. Thankfully, we have the channel creation encapsulated in its own method, so it’s very easy to extract it to a separate class and use dependency injection to inject either a real object or a mock into the SendingFromBuffer class.</p>

  <p class="calibre2">After the refactoring, the code looks like this:</p>
  <pre class="calibre10">
public class SendingFromBuffer
{
  Buffer _buffer;
  DestinationFactory _destinationFactory;

  public SendingThroughBuffer(
    Buffer buffer, DestinationFactory factory)
  {
    _buffer = buffer;
    _destinationFactory = factory;
  }
    
  public void Perform()
  {
    var destination = _destinationFactory.Create();
    while (_buffer.HasPackets()) 
    {
      destination.Send(_buffer.GetPacket ());
    }
  }
}

public interface DestinationFactory
{
  Destination Create();
}
  
public class WcfDestinationFactory : DestinationFactory
{
  public Destination Create()
  {
    var binding = new BasicHttpBinding();
    var endpoint = new EndpointAddress(
      "http://localhost/MyService/Something");
    var channelFactory = new ChannelFactory&lt;Destination&gt;(
      binding, endpoint);
    return channelFactory.CreateChannel();
  }
}
</pre>

  <p class="calibre2">Note that we have introduced a factory object with one method that has just a few lines. this yields the two following questions:</p>

  <ol class="calibre12">
    <li class="calibre13">Aren’t we introducing an unnecessary abstraction that bloats the design?</li>

    <li class="calibre13">Aren’t we hurting readability with this additional object?</li>
  </ol>

  <p class="calibre2">Let’s take those questions on one by one.</p>

  <h3 class="sigilnotintoc">1. Aren’t we introducing an unnecessary abstraction that bloats the design?</h3>

  <p class="calibre2">Ok, think with me - is this factory really necessary? I mean, it’s just a few lines of code! Why the heck would we want to delegate that to a separate class?</p>

  <p class="calibre2">Well, we do and I’ll tell you why. It’s because the reason for creating classes is not to move lines of code. You see, the goal of introducing all this object oriented stuff into programming languages in the first place was to enable us to do the following:</p>

  <ol class="calibre12">
    <li class="calibre13">encapsulate something</li>

    <li class="calibre13">loosen coupling</li>

    <li class="calibre13">attain better cohesion</li>

    <li class="calibre13">get rid of redundancy</li>

    <li class="calibre13">make the class easier for testing (ok, this one came later, but it’s equally important)</li>

    <li class="calibre13">enhance readability</li>

    <li class="calibre13">provide a better chance for reuse</li>
  </ol>

  <p class="calibre2">Do you see “lines of code” anywhere on this list? No? Good, because me neither :-). Well, maybe the readability part, but we’ll deal with that later. Sadly, this is a common myth that many junior programmers repeat endlessly - that the amount of lines of code is a criteria for something to be sealed inside a class or a method. The truth is, one can even introduce a class that doesn’t have ANY executable code (many Null Objects are implemented this way).</p>

  <p class="calibre2">I mean, if we really don’t care about the things outlined above, we can just as well write everything in procedural style - who needs all these objects, classes, interfaces and stuff? No one, because they’re a design tool, not an implementation tool. And as “lines of code” is not a design quality, it has nothing to do with design.</p>

  <p class="calibre2">So, let’s evaluate the decision to introduce a factory in the context of real design qualities described above, not those made up, like “lines of code”:</p>

  <h4 class="sigilnotintoc1">Encapsulation</h4>

  <p class="calibre2">Introduction of a factory encapsulates the knowledge on what library are we actually using for communication. By doing this, we can get rid of another “tiny bit of code”, that impacts this class significantly:</p>
  <pre class="calibre10">using System.ServiceModel;</pre>

  <p class="calibre2">you see, not having this line inside our class file frees us from dragging a heavy dependency around every time we want to reuse the class. This is a great benefit, since getting rid of such heavy dependencies enhances reuse.</p>

  <h4 class="sigilnotintoc1">Coupling</h4>

  <p class="calibre2">By decoupling the class from WCF, we open it for extensions - we can put in another factory that creates different implementation using another remote procedure call mechanism. We gain reuse and extensibility in return.</p>

  <h4 class="sigilnotintoc1">Cohesion</h4>

  <p class="calibre2">By getting the knowledge about creating communication channel away from the SendingFromBuffer class, we make it less prone to change, because any change in the way communication occurs does not impact this code. Cohesive classes make finding defects and issues very easy. E.g. When the app fails with WCF connection, we’ve got a very limited area to search for problems. We don’t have to wonder at all whether a code fulfilling another responsibility in the same class is affected by the WCF channel creation somehow or not.</p>

  <p class="calibre2">Why do I think I have the right to say that the WCF part is a “separate responsibility”? Because there’s a strict boundary between this code and the rest of the class. Just look at the table below:</p>

  <table class="calibre20">
    <tr class="calibre21">
      <th class="calibre48">Question</th>

      <th class="calibre48">Wcf part</th>

      <th class="calibre48">The rest of the class</th>
    </tr>

    <tr class="calibre21">
      <td class="calibre41">Need to unit test?</td>

      <td class="calibre41">No *</td>

      <td class="calibre41">Yes</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre41">Part of application domain logic?</td>

      <td class="calibre41">No</td>

      <td class="calibre41">Yes</td>
    </tr>

    <tr class="calibre21">
      <td class="calibre41">Can be changed to allow easier unit testing?</td>

      <td class="calibre41">No</td>

      <td class="calibre41">Yes</td>
    </tr>
  </table>

  <p class="calibre2">* - well, I’d probably write a unit test to specify what parameters should be set on the channel after creation and that the created instance is not null, but I wouldn’t try to send anything through it.</p>

  <p class="calibre2">So as you see, these two aspects of the class are different and hence should be separated.</p>

  <h4 class="sigilnotintoc1">Redundancy</h4>

  <p class="calibre2">Let’s assume that this isn’t the only place where we’re opening up a connection and sending a message through it. In such case, without the factory, we’d have to introduce a method for creating the channel in every class that needs it. Every time the logic for creating a channel changes, we have to make corrections in all of these methods. This is asking for trouble.</p>

  <h4 class="sigilnotintoc1">Testability</h4>

  <p class="calibre2">Using dependency injection and a factory opens the class for unit testing - which we wouldn’t be able to do otherwise. Of course, we could make the creation method virtual and override it in a subclass with a stub implementation, but is really more straightforward or less effort than the factory solution? By the way, TDD IS about design and analysis, so when a test tells you that you need an additional abstraction, then you do. That’s what you write the tests for - to discover them.</p>

  <h4 class="sigilnotintoc1">Readability</h4>

  <p class="calibre2">we’ll take care of it in a second.</p>

  <h4 class="sigilnotintoc1">Reuse</h4>

  <p class="calibre2">This is a result of all the other points. A class that is easy to reuse encapsulates its responsibility well, dooes not have accidential coupling, is very cohesive, does not include redundant aspects, is documented with set of simple and well-written unit tests that describe all its behaviors and is readable.</p>

  <p class="calibre2">Ok, that pretty much represents my thinking on the issue, the only thing left is question number 2:</p>

  <h3 class="sigilnotintoc">2. Aren’t we hurting readability with this additional object?</h3>

  <p class="calibre2">How do you define readability? Many people mistakenly think that readability is about looking at the code and being able to tell everything that happens from it - such code would make everything it does explicit. If so, then it would be best not to partition the code in any way, but just use a single function or a method that does all the stuff. Thinking this eay leads us to the conclusion that each time we’re introducing a method or a variable, we hurt readability, because things become less explicit. e.g. this:</p>
  <pre class="calibre10">
int a = pow(2,2);
</pre>

  <p class="calibre2">is less explicit than:</p>
  <pre class="calibre10">
var a = 2*2;
</pre>

  <p class="calibre2">And yet, we’d rather use the first form rather than the second, because it’s more intention-revealing (although the second does a better job in telling what actually happens).</p>

  <p class="calibre2">So as you might have already guessed - for me, the main trait of readability is not explicitness. It’s <strong class="calibre14">revealing intentions</strong>.</p>

  <p class="calibre2">Let’s take a look at the two following pieces of code:</p>
  <pre class="calibre10">
public void Process(Frame frame)
{
  validation.PerformFor(frame);
  compression.PerformOn(frame);
  encryption.PerformOn(frame);
}
</pre>

  <p class="calibre2">…and:</p>
  <pre class="calibre10">
public void Process(Frame frame)
{
  if(frame.Destination == null)
  {
    throw new Exception();
  }
  
  for(int i = 0 ; i i &lt; frame.NumberOfWords ; ++i)
  {
    var word = frame.Words[i];
    frame.Words[i] = word.Trim();
  }
  
  for(int i = 0 ; i i &lt; frame.NumberOfWords ; ++i)
  {
    var word = frame.Words[i];
    frame.Words[i] = word.Reverse();
  }
}
</pre>

  <p class="calibre2">Which one is more explicit? The second one, of course. Which is more readable? I’d argue that the first one - not only does it make clear what steps are performed, it also makes a point about their order. This is crucial, because encrypting a compressed content would give you a different result than compressing an encrypted content. If we’re sending the frame to any other system, it can probably interpret only one of these two options. That’s why the order is probably something that is enforced by requirements and it’s great that it’s reflected in the code.</p>

  <p class="calibre2">By the way, one could argue, that we could just do this:</p>
  <pre class="calibre10">
public void Process(Frame frame)
{
  validate(frame);
  compress(frame);
  encrypt(frame);
}
</pre>

  <p class="calibre2">That’s true, although, when reading this code, I’d most probably jump into each of these methods to see what they do - after all, it’s the same class and I’m trying to grasp it. This forces me to get my head around more details than I need to, because everytime I’m reading this class, there is always “that other code”, that’s doing some fancy things and may modify some fields that may be used somewhere else. For example, how do I know that compression does not set a flag somewhere to trigger different encryption in the encrypt() method depending on the compression ratio?</p>

  <p class="calibre2">My brain tends to work differently when I see other responsibilities pushed into separate objects. Then, I focus only on the behavior of the class I’m reading, since the objects I’m delegating to cannot affect anything more than what I pass to them. I can quickly grasp the behaviors my class expects from its collaborators and instantly tell whether the responsibility of the class is fulfilled well or not. For example, I don’t care what validation is - the only thing I know is that I need to call it and it will just “handle stuff”.</p>

  <p class="calibre2">As a side note - there are some people that hate design patterns and say that they hurt readability. While I agree that “pattern religion” is bad, I have actually seen many, many, many situations, when using design patterns enhanced readability, because they would just “fit in” into the solution. E.g. when I want to add tracing of every method call made against an object, a decorator is an obvious choice. Then, looking at the decorator, one can instantly see that the intention of the code is to provide tracing over a method call - it doesn’t have to be digged for.</p>

  <p class="calibre2">Ok, that’s everything I have for today. Feel free to comment with your thoughts!</p>
</div>


<div class="calibre4" id="calibre_link-31">
  <p class="calibre49">Many thanks to Łukasz Bigos for discussion and inspiration.</p>

  <p class="calibre2">Recently I had a discussion with few of my colleagues on readability of Test-driven (or more precisely - loosely coupled) code. The thing that surprised me the most was the argument that loosely coupled code is unreadable. The surprise comes from my deep conviction that TDD help achieve extremely readable code.</p>

  <p class="calibre2">In my mind, TDD leads to well factored, small classes with single responsibilities, but in some others’ minds, it’s just “obfuscating the picture” and they “don’t know what’s happening in this code because everything is hidden and split across many classes and methods”.</p>

  <p class="calibre2">So I thought about it some more, talked a little more and finally I reached a conclusion on why there’s a disagreement between us.</p>

  <h3 class="sigilnotintoc">Two ways of understanding readability</h3>

  <p class="calibre2">It appears that, depending on our habits, “readable” means something different to us. There are two kinds of readability I learned to differentiate: <strong class="calibre14">implementation readability</strong> and <strong class="calibre14">design readability</strong>. Let’s try to look at what each one is about and who &amp; why finds this particular kind of readability relevant.</p>

  <h3 class="sigilnotintoc">1. Implementation readability</h3>

  <p class="calibre2">Let’s imagine we’re developing client-server application for project management. The part we’ll be dealing with is the server-side processing of a request to add new issue to existing project. By looking at the example code, we’ll see how and why <strong class="calibre14">implementation readability</strong> plays out in practice. Without further ado, ladies and gentlemen, the code:</p>
  <pre class="calibre10">
public void AddNewIssueToProject(Request request, Response response)
{
  try
  {
    if(!request.ContainsKey("senderIp") 
       || string.IsNullOrWhiteSpace(request["senderIp"] as string))
    {
      response.Write("Wrong sender IP");
      return;
    }

    if(!request.ContainsKey("projectId") 
       ||  string.IsNullOrWhiteSpace(request["projectId"] as string))
    {
      response.Write("Invalid project ID");
      return;
    }

    if(!request.ContainsKey("issueData") || 
      request["issueData"] as Dictionary&lt;string, string&gt; == null)
    {
      response.Write("issue data not passed");
      return;
    }

    var issueData 
      = request["issueData"] as Dictionary&lt;string, string&gt;;

    if(!issueData.ContainsKey("Title") || 
        string.IsNullOrWhiteSpace(issueData["Title"]))
    {
      response.Write("No title for issue supplied. " +
        "Issue title must be at least one readable character");
      return;
    }

    if(!issueData.ContainsKey("Content") || 
        string.IsNullOrWhiteSpace(issueData["Content"]))
    {
      response.Write("No content for issue supplied. " +
        "By our policy, every issue must be described with details");
      return;
    }

    if(!issueData.ContainsKey("Severity") 
       || string.IsNullOrWhiteSpace(issueData["Severity"]))
    {
      response.Write("No severity supplied, " + 
        "although the form forces this." +
        " Are you trying to send us raw HTTP request?");
      return;
    }

    var projectId = request["projectId"] as string;
    var issueTitle = issueData["Title"];
    var issueContent = issueData["Content"];
    var severity = issueData["Severity"];

    var queryString = string.Format(
      "INSERT INTO ProjectIssues VALUES ({0}, '{1}', '{2}', '{3}')",
      projectId, issueTitle, issueContent, severity);

    var query = new Query(queryString);
    using(var connection = DatabaseConnection.Open("dbName=Abcdef"))
    {
      query.ExecuteThrough(connection);
    }

    response.Write("Everything's OK!");
  }
  catch(Exception e)
  {
    response.Write("Unexpected error, see log for details");
    _log.Error(e);
  }
}
</pre>

  <p class="calibre2">While this snippet may seem like a classic spaghetti code to those of you who are more design-infected, there is actually a significant benefit behind it. The benefit is that without looking anywhere else, we can deduce the state of the method variables in every line and what precisely will happen in the system when we run this code. Because the method is made up mostly of primitive or library constructs, we’re able to “debug” it with our eyes only, without jumping here and there to gather the parts of the functionality necessary to “understand” the code.</p>

  <p class="calibre2">Wait, did I just write “understand”? What kind of “understanding” are we talking about here? Well let’s take the following line as example:</p>
  <pre class="calibre10">
    var projectId = request["projectId"] as string;
</pre>

  <p class="calibre2">When reading this code, by the time we arrive at this line we already know that some values are put inside the dictionary and that they’re non-null and not some other value like empty string. What are “dictionary”, “null” and “empty string”? They’re <strong class="calibre14">implementation details</strong>! Are they connected to the domain of request processing? No. Do they help describe the high-level work-flow? No. Do they help us understand the requirements? Not much. Can we read from the code what steps does this method consists of or where each step begins and where it ends? No, we can extract it somehow by comparing the code to our domain knowledge or experience (e.g. most of us know that each request coming to the server has to be validated), but again, this is something extracted from the code, not something that’s already there.</p>

  <p class="calibre2">So, the conclusion is that this style of writing is better at describing <strong class="calibre14">how</strong> the code works, while doing a poor job of describing <strong class="calibre14">what the code is for</strong>.</p>

  <h3 class="sigilnotintoc">Benefits of implementation readability</h3>

  <p class="calibre2">So, who benefits from having a high implementation readability? Well, there are times when we’re given some assignments in a code we don’t know. Let’s say that our boss told us to fix a bug in an application that should write string “abcd” to Windows registry, but it writes “abc”. Now, we don’t care about the big picture - all we care for is that we know what the single external behavior is and what it should be instead (we don’t even care why), so we search for this one line in the code that is responsible for the behavior to replace it with something else. While searching, everything that is not the sought construct (including design and domain knowledge), is in our way. From this point of view, the ideal situation would be to have the whole application in a single source file so that we can use our text editor to search it for the word “Registry”, then examine each occurrence and make the fix. In other words, we’re acting as a little smarter “search and replace” mechanisms. The single-responsibility classes just get in our way and make us “pointlessly” navigate through a web of objects we neither want nor need to understand (some would say that we’re on level 1 or 2 of <a href="http://en.wikipedia.org/wiki/Dreyfus_model_of_skill_acquisition">Dreyfus model of skill acquisition</a>).</p>

  <p class="calibre2">While cases such as this one happen, we must realize that they’re not the cases we’re trying to optimize for. In any but the simplest cases, making a novice go into a piece of code to make changes without understanding of domain or design will lead to degradation of the code and probably few bugs (when someone is not aware of the big picture, they might fix a bug in a way that introduces another bug somewhere else, because of another scenario they didn’t have any idea of). So the case we want to optimize for is someone going into the code with a need to understand the domain and the design first before making a change. It’s best if they can derive at least part of this knowledge from the code itself and easily map parts of domain knowledge to places in the code. And this is how we arrive at…</p>

  <h3 class="sigilnotintoc">2. Design readability</h3>

  <p class="calibre2">Part of good object-oriented design is implementation hiding, i.e. we want to hide how a particular piece of functionality is implemented so that we can change it later. Also, when we’re equipped with domain and design knowledge, we want this knowledge stand out, not to be obfuscated by implementation details. To give you a quick example of what I mean: when talking about web server session storage, we say that “a user is assigned a persistent session”, not that “a database holds a serialized hashtable indexed by user ID”. Thus, we want to see the first clearly visible in the code, not the latter. Otherwise, readability is hurt.</p>

  <p class="calibre2">Let’s now take a little piece of refactored request handling code that we began with and see whether we can see any improvements:</p>
  <pre class="calibre10">
class AddingNewIssueToProject : Scenario
{
    UserInteraction _user;
    AddIssueToProjectRequest _addIssueToProjectRequest;
    PersistentStorage _issueStorage;

    public AddingNewIssueToProject (
      AddIssueToProjectRequest requestForAddingIssueToProject, 
      UserInteraction userInteraction,
      PersistentStorage issueStorage)
    {
      this._requestForAddingIssueToProject 
        = requestForAddingIssueToProject;
      this._user = userInteraction;
      this._issueStorage = issueStorage;
    }

    public void GoThrough()
    {
      try
      {
        _requestForAddingIssueToProject.Validate();
        Issue issue = _requestForAddingIssueToProject.ExtractIssue();
        issue.StoreInside(_issueStorage);
        issue.ReportSuccessfulAdditionTo(_user);
      }
      catch(ScenarioFailedException scenarioFailed)
      {
        _user.NotifyThat(scenarioFailed);
      }
   }
}
</pre>

  <p class="calibre2">As you can see, there’s almost no “implementation” here. No strings, no nulls, no dictionaries, lists, data structures, no addition, subtraction, multiplication etc. So how can it be readable as it tells very little of the external application behavior? Count with me:</p>

  <ol class="calibre12">
    <li class="calibre13">The class name is AddingNewIssueToProject, which says that this class is all about this single scenario (in other words, when something is wrong with different scenario, this is not the place to look for root cause). Moreover, it implements a Scenario interface, which gives us a clue that each scenario in the application is modeled as object and we can most probably find all scenarios supported by the application by searching for classes implementing Scenario interface.</li>

    <li class="calibre13">It depends on three interfaces: UserInteraction, AddIssueToProjectRequest and PersistentStorage, which suggest that the scope of the scenario is: communication with user, working with the user-entered data and saving data to persistent storage.</li>

    <li class="calibre13">The GoThrough() method contains the sequence of steps. We can clearly see which steps the scenario consists of and what is their order, e.g. looking at this method, we are sure that we’re not trying to save invalid Issue object, since storing issue is after validating correctness.</li>

    <li class="calibre13">Looking at the invocation of ExtractIssue() method, we can see that the new issue that’s being saved is made of data entered by user.</li>

    <li class="calibre13">The object _issueStorage is of type PersistentStorage, suggesting that, after the issue is saved, we’ll be able to retrieve it later, most probably even after the server restart.</li>

    <li class="calibre13">Each of the steps of the scenario is allowed to fail (by throwing ScenarioFailedException) and the user is immediately notified of the failure.</li>

    <li class="calibre13">If the adding issue scenario ever needs to perform any additional step in the future, this is the place where we’d start adding this change.</li>
  </ol>

  <p class="calibre2">Not bad for just few lines of code that contain practically no implementation details, huh?</p>

  <h3 class="sigilnotintoc">Which one to prefer?</h3>

  <p class="calibre2">Personally, I strongly prefer design readability, i.e. I want to draw as much domain knowledge and design constraints knowledge from the code (not to be mistaken with overdesign) as possible. One reason for this is that design readability makes it much easier to introduce changes that are aligned with the “spirit” of the code that’s already in place and such changes are usually much more safe than hacking around. Another reason is that implementation readability is impossible to maintain over the long haul. Let’s take the following snippet from our example:</p>
  <pre class="calibre10">
if(!issueData.ContainsKey("Severity") 
   || string.IsNullOrWhiteSpace(issueData["Severity"]))
{
  response.Write("No severity supplied, " + 
    "although the form forces this." +
    " Are you trying to send us raw HTTP request?");
  return;
}
</pre>

  <p class="calibre2">This is a part of code responsible for adding new issue, but we can imagine it making its way to scenario for editing existing issue as well. When this happens, we have two choices:</p>

  <ol class="calibre12">
    <li class="calibre13">Copy-paste the code into the second method, creating duplication and redundancy (and leading to situations where one change needs to be made in more than one place, which, according to <a href="http://www.netobjectives.com/blogs/shalloway%E2%80%99s-law-and-shalloway%E2%80%99s-principle">Shalloway’s Law</a> is asking for trouble)</li>

    <li class="calibre13">Extracting the code at least to a separate method that already defeats implementation readability partially, because each time you need to understand what piece of code does, you need to understand an additional method. All you can do is to give this method an intent-revealing name. Anyway, introducing new methods just to remove redundancy leaves us with with code where sections of implementation details are mixed with sections of domain work-flows stated in terms of calling domain-specific methods on domain-specific objects. From such code, we can easily deduce neither full work-flows, nor all implementation details. Such code is better known under the name of Spaghetti Code :-),</li>
  </ol>

  <p class="calibre2">An object oriented system is not a set of streams of primitive instructions. It is a web of collaborating objects. The more complex the system, the more this metaphor becomes visible. That’s why, instead of trying to put all implementation in one place to make it “debuggable”, it’s better to create a cohesive and readable description of that collaboration. A description that reveals domain rules, domain workflows and design constraints.</p>

  <p class="calibre2">Of course, the choice is yours. Until you decide to do TDD, that is. That’s because TDD strongly encourages clean design and separation of domain and design from implementation details. If good design guidelines are not followed, tests get longer and longer, slower and slower, more and more test logic is repeated throughout the tests etc. If that’s where you are now, better revise your approach to design!</p>

  <h3 class="sigilnotintoc">What do you think?</h3>

  <p class="calibre2">I’m dying to know what your opinions and observations on these topics are. Do you find the distinction between implementation and design readability useful? Which one you prefer? Please let me know in the comments!</p>
</div>


<div class="calibre4" id="calibre_link-9">
  <p class="calibre2">In <a href="http://feelings-erased.blogspot.com/2012/06/why-do-i-consider-interfaces-superior.html">one of my previous posts</a> I promised, that I’d share with you some hints on reducing the cost of maintaining class mocks. Remember that I’m not recommending class mocks, just showing you what to do when you have little choice. That said, I’ll try to highlight a way to deal with constructor maintenance.</p>

  <p class="calibre2">My plan is as follows: first, I’ll introduce the general pattern and describe its canonical use in unit testing. Then I’ll show you how adding one teeny tiny method drives us to the solution to our mock constructor issue.</p>

  <h3 class="sigilnotintoc">The builder to the rescue!</h3>

  <p class="calibre2">Before we jump into creating mocks, let’s note that there are many unit tests where we create the specified object (e.g. in class X specifications, we create new object of class X in every spec/unit test, at least that’s what I do, since I strongly believe that Setup/Teardown are last resort mechanisms).</p>

  <p class="calibre2">Now, just to let you get a feeling of what I’m talking about, let’s look at simple example:</p>
  <pre class="calibre10">
[Test]
public void ShouldCopyFromSourceToDestination()
{
  //GIVEN
  var source = new Mock&lt;ISource&gt;();
  var destination = new Mock&lt;IDestination&gt;();
  var anyLog = Any.InstanceOf&lt;ILog&gt;();
  var anyFile = Any.InstanceOf&lt;IFile&gt;();  
  var copyOperation = new CopyOperation(source, destination, anyLog);
  source.Setup(m =&gt; m.Get()).Returns(anyFile);

  //WHEN
  copyOperation.PerformOn(anyFile);
  
  //THEN
  destination.Verify(m =&gt; m.Write(anyFile));
}
</pre>

  <p class="calibre2">Let’s see - what does this logging object do here? It’s not really part of the behavior - it only makes the intent less visible! Also, when we add another parameter to the constructor, we’ll have to update all specs that create a CopyOperation object.</p>

  <p class="calibre2">There are cases when having many constructor parameters is a sign that it’s high time to introduce a Facade in the design. But sometimes not. In such cases we can use a builder pattern that takes only the parameters that are important. No need for logger when we specify logging-agnostic behaviors. For example:</p>
  <pre class="calibre10">
[Test]
public void ShouldCopyFromSourceToDestination()
{
  //GIVEN
  var source = new Mock&lt;ISource&gt;();
  var destination = new Mock&lt;IDestination&gt;();
  var anyFile = Any.InstanceOf&lt;IFile&gt;();  
  var copyOperation = new CopyOperationBuilder()
    .Source(source)
    .Destination(destination)
    .Build();
  
  source.Setup(m =&gt; m.Get()).Returns(anyFile);

  //WHEN
  copyOperation.PerformOn(anyFile);
  
  //THEN
  destination.Verify(m =&gt; m.Write(anyFile));
}
</pre>

  <p class="calibre2">The implementation of such builder is dead simple:</p>
  <pre class="calibre10">
public class CopyOperationBuilder()
{
  private ISource _source 
    = new Mock&lt;ISource&gt;().Object;
  private IDestination _destination 
    = new Mock&lt;IDestination&gt;().Object;
  private ILog _log 
    = new Mock&lt;ILog&gt;().Object;

  public CopyOperationBuilder Source(
    ISource source)
  {
    _source = source;
    return this;
  }

  public CopyOperationBuilder Destination(
    IDestination destination)
  {
    _destination = destination;
    return this;
  }

  public CopyOperationBuilder Log(ILog log)
  {
    _log = log;
    return this;
  }

  public CopyOperation Build()
  {
    return new CopyOperation(
      _source, 
      _destination, 
      _log);
  }
}
</pre>

  <p class="calibre2">Easy, isn’t it? Not only did we make the specification more meaningful, we also made the spec less prone to changes in constructor - when new parameter is added that doesn’t affect the spec, the builder is the only place we need to update.</p>

  <p class="calibre2">OK, now that I introduced the pattern and its usual usage in unit testing, let’s see how we can benefit from it in case of mocking.</p>

  <h3 class="sigilnotintoc">Mock builder</h3>

  <p class="calibre2">Now, time for a trick. We can just add another method in the builder, that will build a mock for us:</p>
  <pre class="calibre10">
public class CopyOperationBuilder
{
  //all the methods described above…

  public Mock&lt;CopyOperation&gt; BuildMock()
  {
    return new Mock&lt;CopyOperation&gt;(
      _source, 
      _destination, 
      _log) { CallBase = true };
  }
}
</pre>

  <p class="calibre2">And that’s it. Simple and sweet trick that may become handy in those very rare cases where we need to create class mocks.</p>

  <p class="calibre2">Good night everyone!</p>
</div>


<div class="calibre4" id="calibre_link-29">
  <p class="calibre2">Today I’d like to start discussing mocking of sequences of method call chains. This discussion will be split in two parts, part two coming soon.</p>

  <h3 class="sigilnotintoc">The basics of call chains</h3>

  <p class="calibre2">When I say “call chain”, I mean something like this:</p>
  <pre class="calibre10">
a.X().Y().Z().V();
</pre>

  <p class="calibre2">So basically we’re just invoking methods on a result of another method. This is a construct that probably everyone programming in an object oriented language have come across, so I’ll only note that I don’t mean “call chain” merely as a synonym of invoking method on returned object (because it would be plain silly to make up a name for something that obvious), but rather the style of invoking methods “in a chain” as seen in the example above.</p>

  <h3 class="sigilnotintoc">Call chains may be a design smell</h3>

  <p class="calibre2">Now, one thing I want to make clear is that there’s a point in mocking method chains only in specific situations. This is because call chains can be either a design smell or a sophisticated API design technique. Today, I’m gonna talk a little bit about the first case, leaving the latter for part two.</p>

  <p class="calibre2">Let’s take a look at the following example of call chain being just a design smell (we’re gonna discuss why in a minute):</p>
  <pre class="calibre10">
bool wasWrittenInAmericanEnglish = message
  .GetWrappedFrame()
  .GetHeader()
  .GetLocale() == "en-US";
</pre>

  <p class="calibre2">So, what’s really wrong with this? I can guess that you’ve probably seen code like this many times before. The issue with the example above is that we’re now coupled to all of the types of objects between the message object and the locale string. Also, we’re coupled to the information that message language can be obtained by locale, as well as to the name of the en-US locale and so on.</p>

  <p class="calibre2">Moreover, we’re coupled to if and when will subsequent calls return valid objects. Let’s say that there are some messages that do not contain a header and we can’t obtain a locale information. We decide that we want to use application’s default locale in such case - this decision will have to be properly handled by this code. If this isn’t the only place where we need to follow this default locale policy, we’ve already introduced redundancy (oh, and did I say that we’ve violated encapsulation by failing to protect the information on how the locale is obtained?). Another example might be adding support for messages without locale specified in the header.</p>

  <p class="calibre2">Here’s how ugly may this kind of code turn when only these two constrains are loosened:</p>
  <pre class="calibre10">
const string EnUs = "en-US";
bool wasWrittenInAmericanEnglish 
  = EnUs == getCurrentAppLocale();

var wrappedFrame = message.GetWrappedFrame();

if(wrappedFrame.HasHeader())
{
  var header = message.GetHeader();
  var locale = header.GetLocale();
  if(locale != null)
  {
    wasWrittenInAmericanEnglish = locale == EnUs;
  }
}
</pre>

  <p class="calibre2">See how the code was impacted by broken encapsulation? By the way, this is also a violation of <a href="http://www.ccs.neu.edu/research/demeter/demeter-method/LawOfDemeter/paper-boy/demeter.pdf">Law of Demeter</a>.</p>

  <p class="calibre2">As a side note, the issue does not have anything to do with the calls being chained. It may as well look like this without it changing the problem at all:</p>
  <pre class="calibre10">
var frame = message.GetWrappedFrame();
var header = frame.GetHeader();
var locale = header.GetLocale();
var wasWrittenInAmericanEnglish = locale == "en-US";
</pre>

  <p class="calibre2">So the chain in such smelly situations is rather a workaround than an API design technique. The workaround is for typing too much and dealing with too many variables that are only used to obtain other variables.</p>

  <h3 class="sigilnotintoc">The diagnosis and the cure</h3>

  <p class="calibre2">We mainly run into this kind of code in four situations:</p>

  <ol class="calibre12">
    <li class="calibre13">We introduce it during bottom-up coding (because we have access to all the data wee need, just need to “reach it through the dots”)</li>

    <li class="calibre13">We introduce it when not using TDD, because there is nothing to tell us loud enough that it’s wrong</li>

    <li class="calibre13">We introduce it by abusing mocking frameworks (whose authors usually add support for mocking of method chains, but not with such situations in mind)</li>

    <li class="calibre13">We encounter it in legacy code</li>
  </ol>

  <p class="calibre2">In any case, you don’t want to mock the methods chain. I mean, <strong class="calibre14">really really</strong>, you don’t want to mock it. Or specify it.</p>

  <p class="calibre2">What you DO want to do is to refactor it into something like this:</p>
  <pre class="calibre10">
bool wasWrittenInAmericanEnglish 
  = message.WasWrittenIn(Languages.AmericanEnglish);
</pre>

  <p class="calibre2">Here, the code is decoupled from all the information about the encapsulated calls - it doesn’t know the structure of message object or the locale format used, or even that the check is made by comparing locale values of any sort. We’re safe and sound.</p>

  <p class="calibre2">Also, it’s very straightforward to mock, even with manual mocks. That’s one of the reasons some of the TDD gurus suggest to use manual mocks (at least when getting started) - they provide more of the diagnostic pain that points where the design is going wrong.</p>

  <p class="calibre2">And how to avoid running into such smelly chains when writing new code? My favorite technique is to use <a href="http://xunitpatterns.com/need-driven%20development.html">Need Driven Development</a>, at the same time forgetting about the call chain mocking feature of some of the mocking frameworks.</p>

  <p class="calibre2">Ok, that’s it for today, in the next installment, we’ll take a look at some proper usage of call chains and three classes of such chains: ordered chains, unordered chains and chains with grammar. Stay tuned!</p>
</div>


<div class="calibre4" id="calibre_link-33">
  <p class="calibre2">Hi, today, I’m going to continue discussion I already started on mocking and specifying call chains. <a href="http://feelings-erased.blogspot.com/2012/08/mocking-method-chains-part-1-when-not.html">Last time</a>, I discussed when call chains are a symptom of bad design and bad coding that violates few object oriented design principles. This time, I’m gonna take on situations when call chains are a good idea or even a sophisticated design technique.</p>

  <p class="calibre2">Basically, the three groups we can distinguish (by the criteria of how they’re mocked), are:</p>

  <ol class="calibre12">
    <li class="calibre13">Unordered chains</li>

    <li class="calibre13">Ordered chains</li>

    <li class="calibre13">Chains with grammar</li>
  </ol>

  <p class="calibre2">The post concludes of a brief discussion of the terminology and how it relates to the term ‘Fluent Interface’ and ‘Internal Domain Specific Language’, since it seems that these terms are often confused with call chaining.</p>

  <p class="calibre2">But for now, let’s focus on the three categories:</p>

  <h3 class="sigilnotintoc" id="calibre_link-84">1. Unordered chains</h3>

  <p class="calibre2">Let’s imagine that our system sends frames through a network interface and the frame has to be built according to a specified format. To allow building such frames easily, we introduce a builder pattern implementation to hide the format and allow us to specify each field freely. The builder can be used like this:</p>
  <pre class="calibre10">
var frame = new FrameWithParameters()
  .Speed(10)
  .Age(1)
  .DestinationIp(“192.168.0.2”)
  .Build();
</pre>

  <p class="calibre2">This is a situation where we don’t care what is the order of calls chained. Quite the contrary - when using the builder, we’re relieved of having to remember all the parameters, how many of them are, which ones go to constructor and which ones are set with setters. Also, we let the builder supply default parameters for the values we don’t specify. So we can build another frame like this:</p>
  <pre class="calibre10">
var frame = new FrameWithParameters()
 .DestinationIp(“192.168.0.4”)
 .Age(2) 
 .Build();
</pre>

  <p class="calibre2">As you can see neither the order of the calls nor the use of all the available calls is necessary.</p>

  <p class="calibre2">Just as in the example from <a href="http://feelings-erased.blogspot.com/2012/08/mocking-method-chains-part-1-when-not.html">part 1</a>, this kind of API is invented as a shortcut to group multiple invocations under one object and make this grouping obvious. The difference is that here, the invocations are NOT made in order to browse through object’s dependencies, but to reduce the “noise” that would result from specifying the object name before each method call.</p>

  <h4 class="sigilnotintoc1" id="calibre_link-85">Mocking unordered chains.</h4>

  <p class="calibre2">Before I show you how unordered chains can be mocked/specified, we need to take a look how such objects are usually implemented. We’ll use the builder example, but modify it so that the FrameWithParameters is an interface rather than a concrete class:</p>
  <pre class="calibre10">
public interface FrameWithParameters 
{ 
  FrameWithParameters Speed(int value); 
  FrameWithParameters Age(int value); 
  FrameWithParameters DestinationIp(string value); 
  Frame Build(); 
}
</pre>

  <p class="calibre2">And the implementation would look like this:</p>
  <pre class="calibre10">
public class ProtocolXFrameWithParameters 
  : FrameWithParameters
{ 
  int speed = 1; 
  int age = 0; 
  string destinationIp = “127.0.0.1”;

  FrameWithParameters Speed(int value) 
  { 
    this.speed = value; 
    return this; 
  }

  FrameWithParameters Age(int value) 
  { 
    this.age = value; 
    return this; 
  }

  FrameWithParameters DestinationIp(string value) 
  { 
    this.destinationIp = value; 
    return this; 
  }
  
  Frame Build() 
  { 
    var frame = new XProtocolFrame(destinationIp); 
    frame.Age = this.age; 
    frame.Speed = this.speed; 
    return frame; 
  } 
}
</pre>

  <p class="calibre2">So as you can see, all the methods responsible for configuration return the same object that they were called on. When mocking such interfaces, we have to preserve this behavior - then we’ll be able to verify all calls on the same mock.</p>

  <p class="calibre2">Thankfully, many mocking frameworks allow us to make a single setup for all methods returning a given type. An example for Moq framework:</p>
  <pre class="calibre10">
var builderMock = new Mock&lt;FrameWithParameters&gt;();
builderMock.SetReturnsDefault&lt;FrameWithParameters&gt;(builderMock.Object);
</pre>

  <p class="calibre2">And FakeItEasy framework:</p>
  <pre class="calibre10">
var fakeBuilder = A.Fake&lt;FrameWithParameters&gt;(); 
A.CallTo(fakeBuilder)
  .WithReturnType&lt;FrameWithParameters&gt;()
  .Returns(fakeBuilder);
</pre>

  <p class="calibre2">As far as I know, NSubstitute does not offer such feature, but you’re welcome to prove me wrong in the comments section. For all mocking frameworks that do not support this feature (and for manual mocks), you have to setup return value for each method separately. Feel free to do this in a helper method, because extracting such code from the direct specification code will not hinder readability. Example of such helper method for NSubstitute:</p>
  <pre class="calibre10">
static void UnorderedCallChainingIsSupportedBy
  (FrameWithParameters builder) 
{ 
  builder.Speed(Arg.Any&lt;int&gt;()).Returns(builder); 
  builder.Age(Arg.Any&lt;int&gt;()).Returns(builder); 
  builder.DestinationIp(Arg.Any&lt;string&gt;()).Returns(builder); 
}
</pre>

  <p class="calibre2">Ok, that’s pretty much it. Now for ordered chains.</p>

  <h3 class="sigilnotintoc" id="calibre_link-86">2. Ordered chains</h3>

  <p class="calibre2">These is a case when making the calls in a different order gives different semantic results. Let’s take a look at a simplified example of stream parser. The stream consists of fields, each having a name and a fixed length. The role of the parser is to chop off subsequent fields from the stream and place them in a dictionary.</p>
  <pre class="calibre10">
stream
  .CHAR(“Author”, 20) 
  .INT(“Format”, 12) 
  .DATE(“Created”, 8) 
  .BIN(“Content”, 300);
</pre>

  <p class="calibre2">Note that from the API design point of view, nothing prevents us from switching the order of invocations, but if we did that, the stream would be split in a different way, so the final effect of stream processing would be different - the fields would have different values.</p>

  <p class="calibre2">Mocking this kind of invocations is sometimes easier, sometimes harder than unordered chains - it all depends on which framework you use. So, for example, verifying the stream parser call chain described above in Moq looks like this:</p>
  <pre class="calibre10">
var streamMock = new Mock&lt;IParser&gt;() 
{ 
  DefaultValue = DefaultValue.Mock 
};

// perform some actions that result in call chain

streamMock.Verify(m =&gt; m
  .CHAR(“Author”, 20) 
  .INT(“Format”, 12) 
  .DATE(“Created”, 8) 
  .BIN(“Content”, 300));
</pre>

  <p class="calibre2">FakeItEasy does not allow using recursive mocks in verification, but you can use the same technique as with unordered chains, but include ordered assertions (google ‘fakeiteasy ordered assertions’).</p>

  <p class="calibre2">NSubstitute only allows stubbing recursive calls (at least with Mono), so one can use a small trick to work around this limitation:</p>
  <pre class="calibre10">
var streamMock = Substitute.For&lt;StreamParsing&gt;(); 
var callSequence = Substitute.For&lt;StreamParsing&gt;();

streamMock
  .CHAR(“Author”, 20) 
  .INT(“Format”, 12) 
  .DATE(“Created”, 8) 
  .Returns(callSequence);

someLogic.PerformOn(streamMock);

callSequence.Received().BIN(“Content”, 300);
</pre>

  <p class="calibre2">So as you see, we can stub the whole sequence except the last step. This sequence returns another mock that we use to verify the just this last step. A little bit awkward, but does the job.</p>

  <p class="calibre2">To sum up, ordered chains need some non-standard tricks depending on what mocking framework you use. Usually, however, one can find a way to get the desired result.</p>

  <h3 class="sigilnotintoc" id="calibre_link-87">3. Chains with grammar</h3>

  <p class="calibre2">Conceptually, this is the most interesting chaining technique. It is used to build API that tries to mimic sentences (and as you know, in a sentence, not every word is legal in every place. There are rules that define what can be used where in a sentence and these rules are called “grammar”). Let’s take a look at the following example:</p>
  <pre class="calibre10">
api.Method("SetMaximumUserCount")
  .Requires(Constraint.AtLeastOneOf) 
  .Role("PowerUser") 
  .Role("Administrator");
</pre>

  <p class="calibre2">Note that the above chain makes sense: invocation of a method called “SetMaximumUserCount” requires having at least one of the two roles specified: either a power user or an administrator. However, the following chain makes abosolutely no sense:</p>
  <pre class="calibre10">
api.Role(“PowerUser”) 
  .Method(“RoleSetMaximumUserCount”) 
  .Requires(Constraint.AtLeastOneOf)
  .Role(“Administrator”);
</pre>

  <p class="calibre2">The situation is different than in ordered chains, where any chain made sense, but different chains resulted in different behaviors. Here, we have “legal sentences” (legal chains) that produce sensible result and “illegal sentences” (illegal chains) that do not make any sense at all. What we want to do is to prevent users of our API from creating incorrect chains, i.e. enforce some kind of “grammar”, preferably at compile time than at runtime.</p>

  <p class="calibre2">The easiest way to do this is to distribute the methods into several types, so that a single call in the chain returns a result that contains only the methods legal in its context. For the example above, it could look like this:</p>
  <pre class="calibre10">
public interface WebApi 
{ 
  WebMethodConfiguration Method(string name); 
}

public interface WebMethodConfiguration 
{ 
  RequirementConfiguration Requires(Constraint c); 
}

public interface RequirementConfiguration 
{ 
  RequirementConfiguration Role(string name); 
}
</pre>

  <p class="calibre2">This way, the object returned by previous call creates a context for the next call. E.g. calling Requires() twice in a chain is impossible - such code would not compile.</p>

  <h4 class="sigilnotintoc1" id="calibre_link-88">Mocking chains with grammar</h4>

  <p class="calibre2">Note that in the example above, the order of calls is mostly enforced by the “grammar”, but the last two calls are an exception - we want to be able to specify as many roles as we wish and the order of these role specifications is irrelevant. The conclusion is that parts of the chains in grammar can be ordered as enforced by the “grammar”, parts can be ordered as enforced by the semantics of produced code, and parts can be unordered.</p>

  <p class="calibre2">From mocking perspective, this is just scaling the solutions described in the first two sections to span several interfaces. Sometimes, you may even want to specify unordered calls as ordered if it makes your live easier - the penalty is having inaccurate documentation, since anyone looking at the unit test may think that the order is actually required where it’s not.</p>

  <h3 class="sigilnotintoc" id="calibre_link-89">Chains and Fluent Interfaces</h3>

  <p class="calibre2">The last thing I’d like to clarify is why I avoid the term Fluent Interface throughout this post. The main reason is that this term is a bit misunderstood among the novice programmers and it doesn’t matter so much from the perspective of mocking. They often make the simplification that the “fluency” in fluent interfaces is about the chaining itself. As I said, this is a misunderstanding. Method chaining is just one of the techniques to achieve fluent interfaces. Other techniques include: function sequence, function nesting, lambdas, closures, operator overloading, annotations/attributes, abstract syntax tree manipulation etc.</p>

  <p class="calibre2">In general, there are three terms that need to be sorted out:</p>

  <ol class="calibre12">
    <li class="calibre13">Fluent Interface - an API created with “flow” and readability in mind, rather than commands and queries</li>

    <li class="calibre13">Embedded Domain Specific Language (Internal Domain Specific Language) - a type of API implemented in a general purpose programming language that reads like a mini-language of its own. This mini-language is targeted at a particular domain of problems (see rake syntax for example), i.e. mimics a language used by a domain expert as much as possible</li>

    <li class="calibre13">Method Chaining (Call Chaining) - described earlier</li>
  </ol>

  <p class="calibre2">So, an API does not have to be all three at the same time. Embedded domain specific languages are (almost?) always created as fluent interfaces, because they have to be readable to the domain expert and the goal of fluent interfaces is readability. Fluent interfaces often use method chaining, but this is not always true. Also, fluent interfaces may use more than one technique at the same time for achieving “fluency”, call chaining being just one of them.</p>

  <p class="calibre2">There is a lot of places on the internet where you can deepen your knowledge on this topic. If there is a demand, however, I can expand on what I wrote here, but for now, I’ll hold back.</p>

  <h3 class="sigilnotintoc" id="calibre_link-90">Wrapping it up</h3>

  <p class="calibre2">Wow, this series was a great challenge both in terms of scope and teaching skills. If you think there are some improvements to be made or see some errors, please let me know in the comments, so that I can clarify or correct the material.</p>

  <p class="calibre2">See ya!</p>
</div>


<div class="calibre4" id="calibre_link-44">
  <p class="calibre2">Hi, Today I’d like to write a little about specifying null objects and a simple Booby Trap pattern that can be used for this purpose.</p>

  <h3 class="sigilnotintoc">A case for a null object?</h3>

  <p class="calibre2">First, I’ll try to introduce the example we’re going to work on, at the same time introducing the null object pattern briefly for those that don’t know it (are there such programmers?)</p>

  <p class="calibre2">Let’s imagine that you’re selling an email gateway that stands between your customer’s network and the rest of the world. Its job is to do some kind of processing of incoming and outgoing email and then pass it forward in the processed form to the customer’s network. In order to lower the traffic inside this network, the incoming email is compressed and to improve security, the outgoing mail is encrypted.</p>

  <p class="calibre2">Now imagine that for various regulatory reasons, some customers need to encrypt the e-mail using one algorithm, while others use another algorithm. Also, there are customers that use more than one algorithm interchangeably depending on a day of month. So for different customers, you’re maintaining separate encryption algorithms and allow swapping them at runtime. The conceptual class diagram may look like this:</p>

  <p class="calibre2"><a href="http://1.bp.blogspot.com/-fKgz0KQXBTs/T9Br_fz1eGI/AAAAAAAAAHM/df74NNT-nPo/s1600/NullObject_1.png" imageanchor="1" class="calibre37"><img alt="" border="0" src="http://1.bp.blogspot.com/-fKgz0KQXBTs/T9Br_fz1eGI/AAAAAAAAAHM/df74NNT-nPo/s400/NullObject_1.png" class="calibre50" /></a></p>

  <p class="calibre2">One day, another customer appears and says “we don’t want the encryption, since we already have a solution that handles this issue. All we want is the compression”. You’re then left with two choices: either to treat “no encryption” as a special case and put an if-else (i.e. a variation of behavior) into the processing logic, or follow the Gang of Four’s principle of encapsulating what varies and put the variation into the factory, treating “no encryption” as a kind of encryption. The factory then would be able to create an encryption object that… does not encrypt at all. We chose the second option, of course. So let’s quickly add it to our diagram:</p>

  <p class="calibre2"><a href="http://2.bp.blogspot.com/-6f0uQgAX6rE/T9BthW7GDjI/AAAAAAAAAHY/Z2hBEIwCpCs/s1600/NullObject_2.png" imageanchor="1" class="calibre37"><img alt="" border="0" src="http://2.bp.blogspot.com/-6f0uQgAX6rE/T9BthW7GDjI/AAAAAAAAAHY/Z2hBEIwCpCs/s400/NullObject_2.png" class="calibre51" /></a></p>

  <p class="calibre2">This kind of object - an object that encapsulates “doing nothing” when filling a specified role - is called a <strong class="calibre14">null object</strong>.</p>

  <h3 class="sigilnotintoc">Specifying null object - does that make any sense?</h3>

  <p class="calibre2">What’s the point of specifying “nothing”? Isn’t it a nonsense similar to specifying that the code will not accidentally format the hard drive?</p>

  <p class="calibre2">I may be alone in this opinion, but I think that in this case it does make sense. The main difference is that usually in case of null objects, our “nothing” is pretty well defined.</p>

  <p class="calibre2">Let’s go back to our example and the null encryption object. What’s its definition of nothing? It’s “it should not encrypt the message”. But can it, e.g. Write something into the system log? Sure it can! So the “nothing” is really related to the message only. Hence, in the most strict case, we want to specify that the message shouldn’t be touched at all (the more loose case will be covered by a separate post somewhere in the future).</p>

  <h3 class="sigilnotintoc">Booby traps - how to specify that something should not be touched?</h3>

  <p class="calibre2">Let’s consider a null object that should REALLY do nothing with the message (a null object that triggers some behavior on passed object is more a complex topic - maybe I’ll write a follow up to this post discussing this particular case). What can we do to specify this requirement?</p>

  <p class="calibre2">We can use a testing pattern that I call a Booby Trap (although, as you’ll see in a minute, the pattern can so be trivially implemented that one may argue whether it deserves its own name). In the real world, there are many kinds of booby traps - ranging from fun ones that make a noise when stepped on, to the military ones that may make a massive damage. What we’ll use this time is an equivalent of the latter.</p>

  <p class="calibre2"><a href="http://4.bp.blogspot.com/-9N3y2Zk0IsU/T9BwyZqo7GI/AAAAAAAAAHw/-qcvyvQ_v9s/s1600/BoobyTrap.jpg" imageanchor="1" class="calibre37"><img alt="" border="0" src="http://4.bp.blogspot.com/-9N3y2Zk0IsU/T9BwyZqo7GI/AAAAAAAAAHw/-qcvyvQ_v9s/s320/BoobyTrap.jpg" class="calibre52" /></a></p>

  <p class="calibre2">The easiest way to implement a full booby trap is to use a mocking framework that has a feature called <a href="http://stackoverflow.com/questions/3526195/rhinomock-mocks-vs-strictmocks-vs-dynamicmocks">Strict Mocks</a>. Strict mock is a variant of mock object that can only receive calls that we mark as “expected”. Any other call made on a strict mock blows things up with an exception and the test fails. So, the easiest way to implement a full booby trap is to just use a strict mock without ANY calls marked as “expected”. Of course, as mock objects rely mostly on inheritance, you’d have to pass an interface mock or mark all methods as virtual in your mocked class, but that’s a relatively small price to pay.</p>

  <p class="calibre2">Having such a strict mocks, you can use it like this (example with Moq framework):</p>
  <pre class="calibre10">
[Test]
public void ShouldNotPerformAnyKindOfOperationsOnMessage()
{
  //GIVEN
  var nullEncryption = new NullEncryption();
  var messageBoobyTrap = new Mock&lt;Message&gt;(MockBehavior.Strict);

  //WHEN
  nullEncryption.Perform(messageBoobyTrap.Object);

  //THEN
  messageBoobyTrap.VerifyAll();
}
</pre>

  <p class="calibre2">There is, however, some bad news - the Strict Mock pattern is considered a relic of the past (the new and better way of mocking is to use so called Loose Mocks, that by default ignore unexpected calls instead of blowing things up) and many newer mocking frameworks don’t implement them (e.g. NSubstitute or FakeItEasy do not). In some cases we can still get the same benefit when the framework allows us to access the information on how many calls were made on a mock. The following example uses NSubstitute to do just that:</p>
  <pre class="calibre10">
[Test]
public void ShouldNotPerformAnyKindOfOperationsOnMessage()
{
  //GIVEN
  var nullEncryption = new NullEncryption();
  var messageBoobyTrap = Substitute.For&lt;Message&gt;();

  //WHEN
  nullEncryption.Perform(messageBoobyTrap);

  //THEN
  CollectionAssert.IsEmpty(messageBoobyTrap.ReceivedCalls());
}
</pre>

  <p class="calibre2">It gets a little bit harder in maintenance with manual mocks, since your mock has to derive from the actual class and mechanically override each method as throwing exception - then you have to remember to add such override for each new method that is added later to the actual class. While this is relatively easy in case your mock implements an interface directly (because the compiler error will tell you that your mock does not implement added method and you can just go and add your implementation - you never forget), in case of mocks deriving from actual/abstract classes it can be a maintenance pain.</p>

  <p class="calibre2">That’s it for today, have a good day!</p>
</div>


<div class="calibre4" id="calibre_link-21">
  <p class="calibre2">(Thanks go to Oleksandr Kravchenko for inspiration.)</p>

  <p class="calibre2">This question gets asked over and over again. Actually, this is the question I’ve been asking myself for quite a long time.</p>

  <p class="calibre2">Until I realized it’s the wrong question to ask. So let’s rephrase the question a little, rewind and start over:</p>

  <h3 class="sigilnotintoc">What to do when you feel you need to test private methods?</h3>

  <p class="calibre2">Now, that’s better :-)</p>

  <p class="calibre2">Basically there are few ways to tackle this issue, depending on circumstances. I’ll try to point them out starting from simplest.</p>

  <h3 class="sigilnotintoc">1. Don’t do it.</h3>

  <p class="calibre2">As <a href="http://lizkeogh.com/2012/05/30/showcasing-the-language-of-bdd/">Liz Keogh pointed out (using BDD language, but it applies to TDD as well)</a>, unit tests in TDD or BDD are <strong class="calibre14">examples</strong> of how to use objects of the class and how is this class valuable to other classes. As such, unit test (or unit-level specifications if you will) should go through the public interface only (with an exception, that I’m going to introduce later).</p>

  <p class="calibre2">Let’s consider a code example:</p>
  <pre class="calibre10">
public class DishWasher
{
  private DishWashing dishWashing;
  private int capacity;

  public DishWasher(int capacity, DishWashing dishWashing)
  {
    this.dishWashing = dishWashing;
    this.capacity = capacity;
  }
  
  public void Wash(Dishes dishes)
  {
    if(IsEnoughPlaceForAll(dishes)
    {
      dishWashing.PerformOn(dishes);
    }
  }

  private bool IsEnoughPlaceFor(Dishes dishes)
  {
    return dishes.CountIsLessThan(this.capacity);
  }
}
</pre>

  <p class="calibre2">Here, the private method is used solely to enhance readability. There’s no need to specify it separately. We can easily write two specifications:</p>

  <div class="calibre53">
    <ol class="calibre12">
      <li class="calibre13"><strong class="calibre14">Given</strong> I have a new set of dishes <strong class="calibre14">And</strong> the count of dishes is less than washer capacity, <strong class="calibre14">When</strong> I try to wash the dishes in the washer, <strong class="calibre14">Then</strong> it should perform the washing process.</li>

      <li class="calibre13"><strong class="calibre14">Given</strong> I have a new set of dishes <strong class="calibre14">And</strong> the count of dishes is equal to or greater than washer capacity, <strong class="calibre14">When</strong> I try to wash the dishes in the washer, <strong class="calibre14">Then</strong> it should not start the washing process.</li>
    </ol>
  </div>

  <p class="calibre2">And that’s all - no need to excercise the private mehod, because from the specification point of view, it does not exist - the “washer capacity” thing is abstract enough to leave it in the spec.</p>

  <p class="calibre2">However, let’s look at what I did with the actual washing - I made it a separate class and passed its instance to the washer. That’s interesting - why isn’t washing just a private method of the DishWasher class?</p>

  <h3 class="sigilnotintoc">2. Move a responsibility by Introducing a collaborator (TDD) or moving method (Refactoring)</h3>

  <p class="calibre2"><strong class="calibre14">First, let’s look at it from TDD (and Test-First) point of view.</strong></p>

  <p class="calibre2">Usually, when doing TDD, we always think “outside the object”, because the “inside” is always a result of failing spec/test and comes AFTER the spec. So, following the TDD process, we’d have no code and start with a specification in mind (let’s remind it here):</p>

  <p class="calibre54"><strong class="calibre14">Given</strong> I have a new set of dishes <strong class="calibre14">And</strong> the count of dishes is less than washer capacity, <strong class="calibre14">When</strong> I try to wash the dishes in the washer, <strong class="calibre14">Then</strong> it should perform the washing process.</p>

  <p class="calibre2">Looking at this spec, we quickly run into conclusion that the behavior description of the dish washer ends with starting the washing process. We didn’t go any further than that. How can we use this information? We can notice that there are actually two responsibilities involved.</p>

  <p class="calibre2">The first one is maintaining the right functionality of controlling the device (here, we’re dealing with making sure the washing does not start when too many dishes are put inside, but it will probably include other scenarios soon, like “do not start washing when washing is in progress” or “Only start washing when the washer is turned on”, or “Stop washing when washer is turned off” etc.)</p>

  <p class="calibre2">The other responsibility is the washing process, which is not started at the same time the washer turned on, so it is something more separate and has a logic of its own (e.g. how many phases are there, when to apply the detergent, how long does it take, how’s the temperature of the water going to change along the washing process etc.).</p>

  <p class="calibre2">As we discover, we did’t specify the second part at all, so looks like for us, the responsibility of the washer ends with starting the washing process. Following Robert C. Martin’s Single Responsibility Principle, it’s good to move this washing process into a separate class. So, In TDD, you don’t think about privacy or not - you think about _the_spec_ and it often tells you when you need to introduce a new collaborator by stressing different responsibilities. Private methods are introduced during the refactoring phase when you need to make some things a little more readable or eliminate redundancy.</p>

  <p class="calibre2"><strong class="calibre14">Ok, now let’s look from the refactoring perspective.</strong></p>

  <p class="calibre2">Imagine that you’re dealing with a legacy code. All you have is the DishWasher class with the dish washing process coded inside as a private method. What you surely need to do is make sure that washing works OK by writing some unit tests that no one wrote ever before. In this case, it’s usually useful to ask yourself a question: “Why do I think that I need to test the private method?”. The answer is usually something like “because it has some complex logic, but well defined logic of it’s own and I need to make sure that it works”. Let’s try to rephrase what you were trying to say by this (by the way, notice that a lot of this post up to now is about understanding your own reasoning :-) ). You actually said that “the washing is a separate responsibility and I have to make sure that it’s fulfilled correctly”. Well, if it’s a separate responsibility, why is it in the DishWasher class? Quickly move the method into a new class and make it public! There - it’s ready for testing! Wasn’t THAT easy? :-)</p>

  <p class="calibre2">Now, these two patterns (not testing and moving responsibilities) cover about 90% of cases. There is, however, a third case when you really want to test/specify private methods. Let’s take a look at it now.</p>

  <h3 class="sigilnotintoc">3. Use inheritance</h3>

  <p class="calibre2">(First, a disclaimer - I find this case very rare and usualy never run into it, so it was hard for me to find a good example. Please don’t shout “hey, I can solve it by delegation instead of inheritance” - just bear with me :-)).</p>

  <p class="calibre2">I’ll start with the code, not the spec, since it’s easier to understant the problem this way.</p>

  <p class="calibre2">Let’s say that you’ve got two models of dish washers. Each of them has a different policy for starting washing - the first one washes all dishes at once, and the seond one (a bigger one) implements a swapping functionality - it let’s you put in twice as many dishes, then splits them into two chunks and performs washing for the dirst chunk, then the second chunk. Other than that, the washing process is the same. Let’s say that we decided to make subclasses for different washers, overriding the “start washing” functionality. So, our DishWasher is now abstract and its Wash() method is implemented like this:</p>
  <pre class="calibre10">
  public void Wash(Dishes dishes)
  {
    if(IsEnoughPlaceForAll(dishes)
    {
      PerformWashing(dishes, dishWashing); 
    }
  }

  protected abstract void PerformWashing(dishes, dishWashing);
</pre>

  <p class="calibre2">Now, the “small” dish washer implements the method the following way:</p>
  <pre class="calibre10">
protected void PerformWashing(Dishes dishes, DishWashing dishWashing)
{
  dishWashing.PerformOn(dishes);
}
</pre>

  <p class="calibre2">…and the “bigger”, two-chunk washer does it like this:</p>
  <pre class="calibre10">
protected void PerformWashing(Dishes dishes, DishWashing dishWashing)
{
  var chunks = dishes.DivideIntoChunks(2);
  dishWashing.PerformOn(chunks[0]);
  dishWashing.PerformOn(chunks[1]);
}
</pre>

  <p class="calibre2">We’ve got two classes now, each of them inheriting the Wash() method from DishWasher class and implementing a different variant of starting the washing process. Do specify the whole Wash() method in both of these derived classes?</p>

  <p class="calibre2">No. It’s the responsibility of DishWasher and should be specified for it. But it’s abstract. What do we do?</p>

  <p class="calibre2">First of all, we’re gonna use a partial mock inheriting from DishWasher to specify DishWasher’s behavior. The only thing we want to specify/test is that the abstract PerformWashing() method actually gets called in certain circumstances, because this is where the DishWasher’s responsibility ends. We can achieve this easily either with a mocking framework or with a simple manual mock:</p>
  <pre class="calibre10">
public class DishWasherMock : DishWasher
{
  public bool callCount = 0;
  public DishWashing passedWashing = null;
  public Dishes passedDishes = null;
  
  protected void PerformWashing(Dishes dishes, DishWashing dishWashing)
  {  
    callCount++;
    passedWashing = dishWashing;
    passedDishes = dishes;
  }
} 
</pre>

  <p class="calibre2">In the spec, we only care about whether this method was called once with correct arguments and that’s it.</p>

  <p class="calibre2">Now the more interesting part - what to do with the protected methods in the subclasses? We’re gonna specify them as well! Let’s see, who is allowed to access protected methods? Derived classes! Ha! Why not make our little test suite class derived from specific dish washer to allow it to access its protected members? Let’s see how it works for the “small” dish washer:</p>
  <pre class="calibre10">
public class SmallDishWasherSpecification : SmallDishWasher
{
  [Test]
  public void ShouldJustStartWashing()
  {
    var dishWashingMock = new DishWashingMock();
    var anyDishes = Any.InstanceOf&lt;Dishes&gt;();
    this.PerformWashing(anyDishes, dishWashingMock);
  
    Assert.AreEqual(1, dishWashingMock.callCount);
    Assert.AreEqual(anyDishes, dishWashingMock.passedDishes);
  }
}
</pre>

  <p class="calibre2">Note that ShouldJustStartWashing() is an instance method, so it has access to all public and protected instance methods of SmallDishWasher class.</p>

  <p class="calibre2">“Bigger” washer follows the same patterns, so I’ll leave it to you as an excercise. By the way, this technique works quite fine with classes that have protected constructors as well (although I’d never make such a class, but I know some folks do, e.g. in singletons or abstract classes).</p>

  <p class="calibre2">But what if something is private? Just make it protected - maybe shed a small tear, but in the long run, it’s no big deal.</p>

  <h3 class="sigilnotintoc">The last 1%</h3>

  <p class="calibre2">This covers 99% of cases where you “need to” test the private method. The last 1% are some corner cases that are hard for me to even imagine. You can then use some of the “last resort techniques”, like friends (C++), InternalsVisibleTo (C#), instrumentation/profiling API, reflection etc. but I really advise you to strongly consider the three options mentioned above before going that far.</p>

  <p class="calibre2">Ok, that’s it. Have a good weekend!</p>
</div>


<div class="calibre4" id="calibre_link-35">
  <p class="calibre2">Hi, today we’re gonna talk a little bit about test driving decorators. In particular I’m going to take on a case where we are wrapping all methods of decorated object with the same logic (a good example is synchronization or tracing).</p>

  <h3 class="sigilnotintoc">Synchronized decorator - a simple example</h3>

  <p class="calibre2">The example I’m gonna give is very simplistic, however, there’s no need to complicate it, since all more complex objects follow the same pattern.</p>

  <p class="calibre2">Let’s imagine that we’re creating a stack. We support the following operations:</p>

  <ol class="calibre12">
    <li class="calibre13">put element on top of a stack (“push element”)</li>

    <li class="calibre13">get last put element from stack without removing it</li>

    <li class="calibre13">get last put element from stack and remove it (“pop element”)</li>

    <li class="calibre13">clear the stack</li>

    <li class="calibre13">copy all elements of the stack on top of another stack</li>
  </ol>

  <p class="calibre2">Now, let’s imagine we have already test-driven an implementation that follows this interface:</p>
  <pre class="calibre10">
public interface Stack&lt;T&gt;
{
  void Push(T element);
  T GetTopElement();
  T PopElement();
  void Clear();
  void CopyElementsOnTopOf(Stack&lt;T&gt; anotherStack);
}
</pre>

  <p class="calibre2">Everything’s fine until a new project is started that handles multiple simultaneous requests made to the stack object. So, we need to add synchronization to the stack.</p>

  <p class="calibre2">If you’ve read other posts on this blog, you know that we like cohesion and Single Responsibility Principle very much and tend not to break it. That’s why baking in concurrency inside the stack class (which already has a responsibility of managing storage and access to the elements) is not an option. After considering all pros and cons, we decide to make a synchronized wrapper that would implement Stack interface and route each method call to the original stack with synchronization added. Also, to make things more efficient (by the way, it doesn’t always make things more efficient, but let’s assume that it does in our case), we decide to use reader-writer lock (i.e. when writer lock is obtained, no one else can use the object. When reader lock is obtained, no one can obtain the writer lock, but other readers can use the object simultaneously).</p>

  <p class="calibre2">How do we do it?</p>

  <h3 class="sigilnotintoc">First, classify the operations</h3>

  <p class="calibre2">Looking at the method names, it’s pretty evident which are “write” operations and should be guarded by writer lock and which are “read” operations and should be guarded by reader lock.</p>

  <p class="calibre2">The “write” operations are:</p>

  <ol class="calibre12">
    <li class="calibre13">put element on top of a stack (“push element”)</li>

    <li class="calibre13">get last put element from stack and remove it (“pop element”)</li>

    <li class="calibre13">clear the stack</li>
  </ol>

  <p class="calibre2">And the “read” operations are:</p>

  <ol class="calibre12">
    <li class="calibre13">get last put element from stack without removing it</li>

    <li class="calibre13">copy all elements of the stack on top of another stack</li>
  </ol>

  <p class="calibre2">Ok, done. What’s the next step?</p>

  <h3 class="sigilnotintoc">Remember - no redundancy.</h3>

  <p class="calibre2">What we’d like to be able to do is to write the result of this analysis in the form of executable specifications AKA unit tests. So, for example, such specification would say: “putting an element on top of a stack should perform the same operation of wrapped object, with write access acquired”. The same would go for all other “write” operations. So, not to be redundant, we’d like to encapsulate the “write access acquired” into its own method (and maybe in its own object, but let’s leave that alone for now).</p>

  <p class="calibre2">Also, from what we know about synchronization, the workflow for performing operations in context of a lock is like this (example for writing):</p>

  <ol class="calibre12">
    <li class="calibre13">acquire write lock</li>

    <li class="calibre13">perform operation</li>

    <li class="calibre13">release write lock</li>
  </ol>

  <p class="calibre2">What we’d like to do is to leave the middle step varying while encapsulating the first and last step (i.e. a context of the operation) into one method. There are at least three ways to do it in C# (pass the middle step as parameter to lambda expression or implement IDisposable and use <strong class="calibre14">using</strong> construct or use some funny hacking that will be a topic of a separate post ;-)), of which we’ll choose the lambda solution (since it’s applicable in other languages as well, so I expect to draw the most value for you - my readers - from it).</p>

  <p class="calibre2">Applying the same reasoning to the “read” methods, we can come up with the following interface of the synchronization decorator:</p>
  <pre class="calibre10">
public class SynchronizedStack&lt;T&gt; : Stack&lt;T&gt;
{
  public void Push(T element);
  public T GetTopElement();
  public T PopElement();
  public void Clear();
  public void CopyElementsOnTopOf(Stack&lt;T&gt; anotherStack);
  
  //New operations not in Stack&lt;T&gt; interface:
  public SynchronizedStack(Stack&lt;T&gt; stack);
  public virtual void InWriteContext(Action action);
  public virtual void InReadContext(Action action);

  //This is the read-write lock we were talking about.
  public readonly ReaderWriterLockSlim SyncObject 
    = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion);

}
</pre>

  <p class="calibre2">Now, for each method, we should write two specs. In the following example, please note how we’re going to deal with verifying that a method was called in a lambda expression that’s passed to another method (this is a situation where matchers built inside mock object frameworks won’t suffice, at least not in C#). The example is for PopElement():</p>
  <pre class="calibre10">
[Test]
public void ShouldPopElementInWriterContextIfWriterContextImplemented()
{
  // GIVEN
  var anyPoppedElement = Any.Integer();
  var wrappedStack = new Mock&lt;Stack&lt;int&gt;&gt;();
  var synchronizedStack 
    = new Mock&lt;SynchronizedStack&lt;int&gt;&gt;(wrappedStack.Object);
  wrappedStack.Setup(m =&gt; m.PopElement()).Returns(anyPoppedElement);

  //Any action passed to write context will just be executed
  synchronizedStack
    .Setup(m =&gt; m.InWriteContext(It.IsAny&lt;Action&gt;()))
    .Callback&lt;Action&gt;(a =&gt; a.Invoke());

  // WHEN
  var element = synchronizedStack.Object.PopElement();

  // THEN
  Assert.AreEqual(anyPoppedElement, element);
}

[Test]
public void 
ShouldNotPopElementInWriterContextIfWriterContextNotImplemented()
{
  // GIVEN
  var wrappedStack = new Mock&lt;Stack&lt;int&gt;&gt;();
  var synchronizedStack 
    = new Mock&lt;SynchronizedStack&lt;int&gt;&gt;(wrappedStack.Object);

  // Any action passed to write context will 
  // not be executed - empty implementation:
  synchronizedStack
    .Setup(m =&gt; m.InWriteContext(It.IsAny&lt;Action&gt;()))
    .Callback(() =&gt; {});

  // WHEN
  synchronizedStack.Object.PopElement();

  // THEN
  wrappedStack.Verify(m =&gt; m.PopElement(), Times.Never());
}
</pre>

  <p class="calibre2">The whole trick is about providing a different implementation for InWriteContext() each time: in the first spec, the implementation is just a pass-through and invokes everything it gets. In the second spec, the implementation ignores anything it gets. So, if in first spec the PopElement() of wrapped object gets called and in the second one it doesn’t, it must go through the InWriteContext(). Also note that in the first spec I don’t use Verify() - that’s ok since I’ve got the return value PopElement()‘s result to assert against and check the call this way.</p>

  <p class="calibre2">Ok, what more do we need? We have certainly omitted a spec for the SyncObject field (I decided to use a field instead of property, but you may choose otherwise), where it should be specified that it should be a non-null object and that it should support recursion (that’s my design choice, yours may be different). Also, we need to somehow specify the InWriteContext() and InReadContext(). Each of them needs two specs:</p>

  <ol class="calibre12">
    <li class="calibre13">The proper lock should be acquired before the call and release it after the call finishes successfully</li>

    <li class="calibre13">If any exception is thrown by the action executed in context, the lock should be released anyway</li>
  </ol>

  <p class="calibre2">Let’s go with an example for InWriteContext()</p>
  <pre class="calibre10">
[Test]
public void 
ShouldObtainWriterLockDuringTheCallAndReleaseItAfterTheCall()
{
  // GIVEN
  var wrappedStack = new Mock&lt;Stack&lt;int&gt;&gt;();
  var synchronizedStack 
    = new SynchronizedStack&lt;int&gt;(wrappedStack.Object);
  var gotCalled = false;

  // WHEN
  synchronizedStack.InWriteContext(() =&gt; 
  {
    gotCalled = true;
    Assert.IsTrue(synchronizedStack.SyncObject.IsWriteLockHeld);
    Assert.IsFalse(synchronizedStack.SyncObject.IsReadLockHeld);
  });

  // THEN
  Assert.IsTrue(gotCalled);
  Assert.IsFalse(synchronizedStack.SyncObject.IsWriteLockHeld);
  Assert.IsFalse(synchronizedStack.SyncObject.IsReadLockHeld);
}

[Test]
public void 
ShouldReleaseWriteLockWhenAWrappedCallExecutionEndsWithException()
{
  // GIVEN
  var wrappedStack = new Mock&lt;Stack&lt;int&gt;&gt;();
  var synchronizedStack 
    = new SynchronizedStack&lt;int&gt;(wrappedStack.Object);

  // WHEN
  Assert.Throws&lt;Exception&gt;( () =&gt;
    synchronizedStack.InWriteContext(() =&gt; {throw new Exception();})
  );

  // THEN  
  Assert.IsFalse(synchronizedStack.SyncObject.IsWriteLockHeld);
  Assert.IsFalse(synchronizedStack.SyncObject.IsReadLockHeld);
}
</pre>

  <h3 class="sigilnotintoc">Is it worth the hassle?</h3>

  <p class="calibre2">“Well”, you might say, “it’s two specs for each InXContext() plus two per each wrapped method. Isn’t it too much for a wrapper that’s implemented almost mechanically?”. And you might be right. This is a case where I’d weigh pros against cons - you might decide not to test-drive this code, since the only value added by such tests is of the “living documentation” sort. I usually do it, but if you decide it’s stupid, I won’t blame you (much :-)). Another reason why I decided it’s a good blog post is that it provides one way of specifying that something goes through lambda, which are a real horror for mock frameworks to match (you can’t just say: match every method with argument being a lambda like THIS, at least not always). You could decide to go another way: take the specs we’ve written for InWriterContext() as a template, and use it for every method, just ignoring the existence of lambda and InXContext() methods and focus on the synchronization in each spec, but that would be <strong class="calibre14">potentially</strong> harder to maintain.</p>

  <p class="calibre2">In one of my future posts, I’ll show you how to achieve one spec per wrapped method instead of two by using some C# magic, but for now, that’s it.</p>

  <p class="calibre2">Good night, everyone!</p>
</div>


<div class="calibre4" id="calibre_link-19">
  <p class="calibre2">This post is mostly C#-specific, although Java guys can make some use of the ideas presented here.</p>

  <h3 class="sigilnotintoc">Simplest attributes</h3>

  <p class="calibre2">Sometimes, especially when dealing with third-party frameworks such as WCF, you scratch your head for how far can you really go with unit tests to specify that “method X should be a remote operation?”. As we all know, firing up a WCF server just to make a call inside unit test is unacceptable. What do we have left?</p>

  <p class="calibre2">Let’s see, remote operations are marked with OperationContract attribute:</p>
  <pre class="calibre10">
[ServiceContract(Namespace="X.Y.Z")]
public interface RemoteEntity
{
  [OperationContract]
  void DoSomething();
}
</pre>

  <p class="calibre2">So, this is what really defines a remote operation: an attribute. So why not test-drive it? You may think this is insane, until you realize that attributes are just classes that are instantiated and configured at runtime. So, if you test-drive assigning values to C# properties, why not attributes?</p>

  <p class="calibre2">Ok, I assume that you calmed down after the last paragraph and don’t consider this idea crazy (because it’s not). So, the question changes to “how do we specify that method X has attribute Y?”. It appears that <a href="http://osdir.com/ml/nunit-discuss/2010-03/msg00193.html">nUnit has the capability to do this</a>, but it’s quite limited.</p>

  <p class="calibre2">I’ve decided to design my own helper, also as an exercise in coding. Using reflection, I came up with the following API for asserting the attribute:</p>
  <pre class="calibre10">
[Test]
public void ShouldContainRemoteOperationForDoingSomething()
{
 Assert.IsTrue(
 Method.Of&lt;RemoteEntity&gt;(entity =&gt; entity.DoSomething())
   .HasAttribute&lt;OperationContractAttribute&gt;()
 );
}
</pre>

  <p class="calibre2">And here’s the implementation:</p>
  <pre class="calibre10">
public class Method
{
  public static Method Of&lt;T&gt;(Expression&lt;Action&lt;T&gt;&gt; expression)
  {
    return new Method((expression.Body as MethodCallExpression).Method);
  }

  public bool HasAttribute&lt;T&gt;()
  {
    return Attribute.IsDefined(methodInfo, typeof(T));
  }

  private Method(MethodInfo method)
  {
    methodInfo = method;
  }

  private MethodInfo methodInfo;
}
</pre>

  <p class="calibre2">Note that the method Of() takes a lambda expression consisting solely of a call to the method we want to check. Also note that this lambda expression is actually never called! We need it only to extract the metadata for the method that the expression is referring to. Also note that the expression must consist of a single call - otherwise we won’t be able to cast it to MethodCallExpression.</p>

  <p class="calibre2">Ok, so what if our DoSomething() method takes a parameter? We have to provide it, but the value doesn’t really matter, since (remember!) the call is never made and method metadata is extracted from the expression by signature, not by call parameters. So, assuming DoSomething() takes an integer, we can write:</p>
  <pre class="calibre10">
[Test]
public void ShouldContainRemoteOperationForDoingSomething()
{
 Assert.IsTrue(
  Method.Of&lt;RemoteEntity&gt;(entity =&gt; entity.DoSomething(Any.Integer()))
   .HasAttribute&lt;OperationContractAttribute&gt;()
 );
}
</pre>

  <p class="calibre2">Easy, right? Ok, but what if we have an attribute that takes a constructor parameter and some properties?</p>

  <h3 class="sigilnotintoc">Attributes with properties and constructor parameters</h3>

  <p class="calibre2">Consider this:</p>
  <pre class="calibre10">
public class Book
{
  [StringLength(256, ErrorMessage = "Max 256 characters!")]
  public string GetDescription();
}
</pre>

  <p class="calibre2">Here, we have to use more elaborate techniques, but we’ll try to keep the syntax clean:</p>
  <pre class="calibre10">
[Test]
public void ShouldContainLengthValidationFor256Characters()
{
  Assert.IsTrue(
    Method.Of&lt;Book&gt;(book =&gt; book.GetDescription())
      .HasAttribute(new StringLengthAttribute(256) 
        { ErrorMessage = "Max 256 characters!" })
  );
}
</pre>

  <p class="calibre2">All we have to do is to create an overload for HasAttribute(), taking one parameter instead of none. Note that, compared to the previous examples, in this one, we add the actual instance of the attribute object we are comparing against. This leads to one complication - while the comparison of types was relatively easy to achieve through the Attribute.isDefined() method, comparing objects requires equality to be properly implemented for those objects.</p>

  <p class="calibre2">For now, int the following implementation, we’ll leave the equality issue for later and close it inside a method named AreEqual(), then I’ll show you two ways to go forward with the equality check.</p>
  <pre class="calibre10">
public bool HasAttribute&lt;T&gt;(T expectedAttribute) where T : class
{
  var attrs = Attribute.GetCustomAttributes(methodInfo, typeof(T));
  var any = attrs.Any(
    currentAttribute =&gt; AreEqual(expectedAttribute, currentAttribute)
  );
  return any;
}
</pre>

  <p class="calibre2">Now for the two methods of filling in this AreEqual() gap. The first option is quite straightforward:</p>
  <pre class="calibre10">
private static bool AreEqual&lt;T_Attribute&gt;
(
  T_Attribute attr1, Attribute attr2
) where T_Attribute : class
{
  return attr1.Equals(attr2);
}
</pre>

  <p class="calibre2">The implementation above requires the attribute classes to have properly defined equality, which may turn out not to be true in some third party libraries you may be forced to use in your project.</p>

  <p class="calibre2">Another option is to use Ploeh’s Semantic Comparison library, which is a part of <a href="http://autofixture.codeplex.com/">Autofixture</a>. It contains a Likeness class that we can use to write the following:</p>
  <pre class="calibre10">
private static bool AreEqual&lt;T_Attribute&gt;
(
  T_Attribute attr1, Attribute attr2
) where T_Attribute : class
{
  return attr2 is T_Attribute 
    &amp;&amp; new Likeness&lt;T_Attribute, T_Attribute&gt;
       (attr2 as T_Attribute).Equals(attr1);
}
</pre>

  <p class="calibre2">Likeness works by searching both objects and comparing their public fields and properties (By the way, it’s interesting in that it can compare unrelated types, but that’s beyond the scope of this post).</p>

  <p class="calibre2">Why is it reasonable to compare two attributes by their “likeness”? It’s because attributes are mostly used as containers for the information. So, any information you put into the attribute by setting its properties and passing parameters to a constructor, you sooner or later want to get back from it and that’s usually achieved by properties.</p>

  <h3 class="sigilnotintoc">What about class attributes?</h3>

  <p class="calibre2">So, what about classes and their attributes? Luckily, nUnit has a decent support for these - just look it up in the documentation! Also, if you dig deep enough into the mentioned topic on nunit discussion list, you’ll reach a way to achieve the same end result as this article shows by using extension methods to plug into nUnit’s objects used for fluent assertions. It’s a good idea to use what I’ve shown you as a building block for that if you decide to perform this exercise.</p>
</div>


<div class="calibre4" id="calibre_link-34">
  <p class="calibre2">…write a blog post.</p>

  <p class="calibre2">There - I did it. I told you I would!</p>

  <p class="calibre2">This time, I’m going to share some of my reasons why I tend not to use Setup and Teardown mechanism at all.</p>

  <p class="calibre2">First, a disclaimer - my point here is NOT that Setup and Teardown lead to inevitable catastrophe. My point here is that Setup and Teardown are so misunderstood and so easy to abuse, that I’d rather not use them at all. There are some other reasons why I actually prefer not having Setups and Teardowns even when they are used properly, but I’ll save this for another post. This time, I’d like to focus only on the ways this mechanism is most often abused.</p>

  <h3 class="sigilnotintoc">What’s Setup and Teardown?</h3>

  <p class="calibre2">As everyone knows, a Setup method is a special kind of method that is executed by unit testing tools before each unit test in the suite. Such methods are commonly used to set the stage before a unit test begins. Analogously, “Teardown” method is a method that is always run after unit test execution and is usually used to perform cleanup after the test finishes. So, given this code (example uses NUnit):</p>
  <pre class="calibre10">
[Setup]
public void Setup()
{
  Console.WriteLine("SETUP");
}

[Teardown]
public void Setup()
{
  Console.WriteLine("TEARDOWN");
}

[Test]
public void Test2()
{
  Console.WriteLine("TEST");
}

[Test]
public void Test1()
{
  Console.WriteLine("TEST");
}
</pre>

  <p class="calibre2">… when it is run by a unit testing tool, it produces the following output:</p>
  <pre class="calibre10">
SETUP
TEST
TEARDOWN
SETUP
TEST
TEARDOWN
</pre>

  <p class="calibre2">While having the common logic for “setting the stage” and “cleaning up” in test suite looks like adhering to DRY, avoiding duplication etc., there are, however, certain dangers when using this kind of mechanism, some of which I’d like to list below.</p>

  <h3 class="sigilnotintoc">Issues with Setup and Teardown</h3>

  <p class="calibre2">Because we’re talking mostly about C#, we’re mainly going to examine Setup, because Teardown is seldom used for unit tests in such languages. By the way, the examples provided are to explain what kind of abuse I have in mind. I tried to keep them simple - this way they’re more understandable, but do not show how bad can it get with real code and real project - you’ll have to believe :-). Let’s go!</p>

  <h3 class="sigilnotintoc">Joint Fixtures</h3>

  <p class="calibre2">Imagine that someone has a set of unit tests evolving around the same setup (let’s call it “A”):</p>
  <pre class="calibre10">
[Setup]
public void SetUp()
{
  emptyList = new List&lt;int&gt;(); //A
}

[Test] //A
public void ShouldHaveElementCountOf0AfterBeingCreated() 
{
 Assert.AreEqual(0, emptyList.Count());
}

[Test] //A
public void ShouldBeEmptyAfterBeingCreated()
{
  Assert.True(emptyList.IsEmpty());
}
</pre>

  <p class="calibre2">One day, another set of unit tests must be added for the same class that requires the setup to be handled a little bit differently (let’s call it “B”). What this person might do is to just add the necessary setup besides the first one.</p>
  <pre class="calibre10">
[Setup]
public void SetUp()
{
  emptyList = new List&lt;int&gt;(); //A
  listWithElement = new List&lt;int&gt;() { anyNumber }; //B
}

[Test] //A
public void ShouldHaveElementCountOf0AfterBeingCreated() 
{
 Assert.AreEqual(0, emptyList.Count());
}

[Test] //A
public void ShouldBeEmptyAfterBeingCreated()
{
  Assert.True(emptyList.IsEmpty());
}

[Test] //B
public void ShouldNotContainElementRemovedFromIt()
{
  listWithElement.Remove(anyNumber);
  Assert.False(listWithElement.Contains(anyNumber));
}

[Test] //B
public void ShouldIncrementElementCountEachTimeTheSameElementIsAdded()
{
  var previousCount = listWithElement.Count();
  listWithElement.Add(anyNumber);
  Assert.AreEqual(previousCount + 1, listWithElement.Count());
}
</pre>

  <p class="calibre2">The downside is that another person striving to understand one unit test will have to read both through the related setup and the unrelated one. And in real life scenarios such orthogonal setups tend to be longer that in this toy example.</p>

  <p class="calibre2">Of course, this may be fixed by separating this class into two - each having its own setup. There are, however, two issues with this: one is that this is almost never done by novices, and the second is that it usually complicates navigation through the unit tests.</p>

  <h3 class="sigilnotintoc">Locally Corrected Fixtures</h3>

  <p class="calibre2">Another temptation a novice may face is when one day they need an object that’s slightly different than the one already set up in the Setup. The temptation is to, instead of create new object configured separately, undo some of the changes made by the Setup just for this single test. Let’s see a simplified example of a situation where one needs a radio set up slightly differently each time:</p>
  <pre class="calibre10">
[Setup]
public void Setup()
{
  radio = new HandRadio();
  radio.SetFrequency(100);
  radio.TurnOn();
  radio.SetToSecureModeTo(true);
}

[Test]
public void ShouldDecryptReceivedContentWhenInSecureMode()
{
  var decryptedContent = radio.Receive(encryptedContent);
  Assert.AreEqual("I love my wife", decryptedContent);
}

[Test]
public void ShouldThrowExceptionWhenTryingToSendWhileItIsNotTurnedOn()
{
  radio.TurnOff(); //undo turning on!!

  Assert.Throws&lt;Exception&gt;(() =&gt;
    radio.Send(Any.String())
  );
}

[Test]
public void ShouldTransferDataLiterallyWhenReceivingInNonSecureMode()
{
  radio.SetSecureModeTo(false); //undo secure mode setting!!

  var inputSignal = Any.String();
  var receivedSignal = radio.Receive(inputSignal);

  Assert.AreEqual(inputSignal, receivedSignal);
}
</pre>

  <h3 class="sigilnotintoc">Overloaded fixtures</h3>

  <p class="calibre2">Let’s stick with the hand radio example from previous section. Consider the following unit test:</p>
  <pre class="calibre10">
[Test]
public void ShouldAllowGettingFrequencyThatWasSet()
{
  radio.SetFrequency(220);
  Assert.AreEqual(220, radio.GetFrequency());
}
</pre>

  <p class="calibre2">Ok, looks good - we specify that we should be able to read the frequency that we set on the radio, but… note that the radio is turned on in the Setup, so this is actually getting a frequency from a radio that’s turned on. What about if it’s turned off? Does it work the same? In the real world, some radios are analog and they allow manual regulation of frequency with a knob. On the other hand, some radios are digital - you can set their parameters only after you turn them on and they become active. Which case is it this time? We don’t know.</p>

  <p class="calibre2">Ok, I actually lied a little. In fact, if someone was doing TDD, we can assume that if the scenario was different when a radio is off, another unit test would exist to document that. But in order to determine that, we have to: 1) look through all the unit tests written for this class, and 2) really, really believe that the author(s) developed all the features test-first. An alternative is to look at code coverage or at the code itself. However, all these ways of dealing with the issue require some examination that we have to perform. In such case, the Setup gets in the way of understanding a minimum activities required for a functionality to work as described.</p>

  <h3 class="sigilnotintoc">Scope hiding</h3>

  <p class="calibre2">It’s quite common to see unit tests grow too big in scope as the design gets worse and worse and it’s harder and harder to separate different bits and pieces for unit testing. Many people think that Setup and Teardown are THE feature to deal with this. I’m sorry, they are not. If you have issues with your design, the right way to go is to SOLVE them, not to HIDE them. Unfortunately, this kind of Setup abuse tends to grow into multi-level inherited Setups (do class names like “TestBase” ring a bell?), where no one really knows anymore what’s going on.</p>

  <h3 class="sigilnotintoc">Evading already used values</h3>

  <p class="calibre2">Consider the following example of a user registration process that may take place in various situations (e.g. creating sessions, presidential election etc.):</p>
  <pre class="calibre10">
[Setup]
public void Setup()
{
  registration = new UserRegistration();
  registration.PerformFor("user1");
  registration.PerformFor("user2");
}

[Test]
public void ShouldBeActiveForRegisteredUsers()
{
  Assert.True(registration.IsActiveFor("user1"));
}

[Test]
public void ShouldBeInactiveForUnregisteredUsers()
{
  //cannot be "user1" or "user2" or it fails!
  Assert.False(registration.IsActiveFor("unregisteredUser"));
}
</pre>

  <p class="calibre2">Why “unregisteredUser” was chosen as a value for unregistered user? That’s because someone writing a unit test wanted to evade the values used in Setup. While that’s not as bad when reading those unit tests, it’s a pain when writing new ones - in order to avoid conflict, you have to always look back at what users are already registered and either use the same values or deliberately pick different ones. Thus, writing every new test begins with trying to understand what the Setup already does and trying to get around that. What’s worse, when putting another value in the Setup, we have to go through all existing unit tests to make sure that we pick a value different that already used in any of them. This hurts maintainability.</p>

  <h3 class="sigilnotintoc">Why do I tell teams to avoid Setup and Teardown</h3>

  <p class="calibre2">As <a href="http://osherove.com/blog/2012/10/14/the-three-values-of-a-good-isolation-framework.html#disqus_thread">Roy Osherove once told me</a>:</p>

  <p class="calibre2"><q>I don’t use my frameworks to teach me design.</q></p>

  <p class="calibre2">and while it was in a different context, I can paraphrase it into saying that avoiding using a feature instead of learning how not to misuse it is not something that will teach you good design and TDD.</p>

  <p class="calibre2">Why then do I insist that people new to unit testing hold back from using features such as Setup and Teardown? How is it helpful?</p>

  <p class="calibre2">In my opinion, holding back from using Setup and Teardown exposes us to a diagnostic pain - when we feel the pain and we cannot work around it, we have to learn to avoid it. It’s never sufficient to say “don’t use Setup and Teardown” or put in any other rule (e.g. “no getters”) without following up on experience from applying this rule. When the team gets into difficulties, there has to be someone to explain what’s the root cause. Only then do such rules make sense. If not for this, the team would just find another workaround, e.g. with helper methods (which are better than Setup and Teardown in that you always get to choose every time which ones to use and which not, but can also be abused). Thus, when I say “no Setup/Teardown” to a team, I always wait for a reaction like “you’re nuts!” - through such experiences, I’m preparing them to acknowledge that TDD is something different that they initially thought (which is usually something like “execute a lot of production code” and “get a high coverage”).</p>

  <p class="calibre2">How about experienced developers? Do they need to adhere to the same rule? Well, let me share my experience. I told myself once - if I ever run into a situation where it makes perfect sense to use Setup and Teardown, I will not hold myself back. Guess what - since then, I used it only once (because one technique of dependency injection required it) and I was regretting it later. Other than this, I never really felt the need to use this feature, since I was doing even better without it. There are some other advantages (like keeping each unit test a “one part story”) that make me never want to go back. Where I work, we’ve got over a thousand of unit tests and no Setup and Teardown at all.</p>

  <p class="calibre2">There are actually more smells and difficulties associated with Setup and Teardown (like impeding certain refactorings) and I could also write something more about Setup and Teardown vs helper methods, but everything has to have an end, doesn’t it? Till the next time!</p>
</div>


<div class="calibre4" id="calibre_link-4">
  <ol class="calibre12">
    <li class="calibre13">Need driven development and the principle of least astonishment (perspective of use)</li>

    <li class="calibre13">Techniques and tools (notepad)</li>

    <li class="calibre13">Basics of xUnit frameworks</li>

    <li class="calibre13">behavior means returning value, changing system and throwing an exception</li>

    <li class="calibre13">Complex Conditions (multiple boolean results: OR and AND</li>

    <li class="calibre13">Sometimes, a behavior depends on multiple conditions being true or false……………….. TODO: 1. use NUNIt TestCase, 2. divide and conquer the problem. youtuTODO: constant refactoringvalues.</li>
  </ol>
</div>


</body></html>